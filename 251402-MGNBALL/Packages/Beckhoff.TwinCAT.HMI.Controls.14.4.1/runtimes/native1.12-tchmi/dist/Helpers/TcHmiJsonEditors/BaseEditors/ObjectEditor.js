import{Editor}from"./Editor.js";import{ChoiceEditor}from"./ChoiceEditor.js";import{ButtonBasedEditor}from"./ButtonBasedEditor.js";import*as SchemaParser from"../SchemaParser.js";import{ObjectEditorPrompt}from"../Popups/ObjectEditorPrompt.js";export class ObjectEditor extends ButtonBasedEditor{__value={};constructor(element,editorInfo,factory){super(element,editorInfo,factory),this.__processEditorInfo()}destroy(){super.destroy(),this.__popup?.destroy(!0)}static validate(editorInfo,value){return 0===ObjectEditor.checkForErrors(editorInfo,value,!0).length}static checkForErrors(editorInfo,value,returnEarly=!1){if("object"!=typeof value||null===value||Array.isArray(value))return[{error:Editor.Error.NOT_AN_OBJECT,parameters:[value]}];if(null!==Object.getPrototypeOf(value)&&Object.getPrototypeOf(value)!==Object.getPrototypeOf({}))return[{error:Editor.Error.OBJECT_HAS_INVALID_PROTOTYPE,parameters:[value]}];const resolvedInfo=ObjectEditor.resolveDependencies(editorInfo,new Set(Object.keys(value)));if("invalid"===resolvedInfo.type)return[{error:Editor.Error.OBJECT_HAS_INVALID_DEPENDENCY,parameters:[value]}];editorInfo=resolvedInfo;const errors=[];for(const[name,info]of editorInfo.properties)if(("optional"!==info.type||info.temporarilyRequired)&&void 0===value[name]&&(errors.push({error:Editor.Error.OBJECT_IS_MISSING_PROPERTY,parameters:[value,name]}),returnEarly))return errors;const isValidName=name=>!!editorInfo.additionalProperties.allowed||(!!editorInfo.properties.has(name)||!(!editorInfo.patternProperties||!Array.from(editorInfo.patternProperties.keys()).some(regex=>regex.test(name))));let propertiesCount=0;for(const propertyName in value){if(!isValidName(propertyName)&&(errors.push({error:Editor.Error.OBJECT_CONTAINS_INVALID_PROPERTY_NAME,parameters:[value,propertyName]}),returnEarly))return errors;const propertyEditorInfo=ObjectEditor.getEditorInfoForProperty(editorInfo,propertyName),underlyingErrors=Editor.checkForErrors(propertyEditorInfo,value[propertyName],returnEarly);if(underlyingErrors.length>0&&(errors.push({error:Editor.Error.OBJECT_CONTAINS_INVALID_VALUE,parameters:[value,propertyName],underlying:underlyingErrors}),returnEarly))return errors;void 0!==value[propertyName]&&propertiesCount++}return void 0!==editorInfo.minProperties&&propertiesCount<editorInfo.minProperties&&(errors.push({error:Editor.Error.OBJECT_HAS_TOO_FEW_PROPERTIES,parameters:[value,editorInfo.minProperties,propertiesCount]}),returnEarly)||void 0!==editorInfo.maxProperties&&propertiesCount>editorInfo.maxProperties&&errors.push({error:Editor.Error.OBJECT_HAS_TOO_MANY_PROPERTIES,parameters:[value,editorInfo.maxProperties,propertiesCount]}),errors}__processEditorInfo(){this.__popup?.setEditorInfo(this.__editorInfo),this.__textSpan.textContent=this.__editorInfo.name,this.__container.classList.toggle("invalid",!this.getState().isValid)}static resolveDependencies(editorInfo,knownProperties){if(!editorInfo.dependencies)return editorInfo;const matchingDependencies=[];for(const[name,dependency]of editorInfo.dependencies)knownProperties.has(name)&&matchingDependencies.push(dependency);if(0===matchingDependencies.length)return editorInfo;const result=SchemaParser.mergeEditorInfos(editorInfo,...matchingDependencies.map(dependency=>this.resolveDependencies(dependency,knownProperties)));return"object"!==result.type?{type:"invalid",schema:result.schema,name:"Invalid"}:result}static getEditorInfoForProperty(editorInfo,property){let info=editorInfo.properties.get(property);if(!info&&editorInfo.patternProperties){const matchingInfos=[];for(const[pattern,info]of editorInfo.patternProperties)pattern.test(property)&&matchingInfos.push(info);matchingInfos.length>0&&(info=SchemaParser.mergeEditorInfos(...matchingInfos))}return!info&&editorInfo.additionalProperties.allowed&&(info=editorInfo.additionalProperties.editorInfo??ChoiceEditor.createAnyEditorInfo()),info??={type:"invalid",schema:{},name:"Invalid"},info}setValue(value){this.__value=value??{},this.__popup?.setValue(value);const state=this.getState();this.__container.classList.toggle("invalid",!state.isValid),this.__onChangeManager.trigger(this,state)}getRawValue(){return this.__value}async openPopup(){this.__popup||(this.__popup=new ObjectEditorPrompt(this.__editorInfo,this.__factory),this.__popup.setBackgroundAction({close:!0,action:"cancel"}),this.__popup.setIsReadOnly(this.__isReadOnly),this.__popup.setSettings(this.__settings),this.__popup.setLocalizations({buttonTextOk:this.__localizations?.objectEditorPrompt?.buttonTextOk??this.__localizations?.editorPrompt?.buttonTextOk,buttonTooltipOk:this.__localizations?.objectEditorPrompt?.buttonTooltipOk??this.__localizations?.editorPrompt?.buttonTooltipOk,buttonTextCancel:this.__localizations?.objectEditorPrompt?.buttonTextCancel??this.__localizations?.editorPrompt?.buttonTextCancel,buttonTooltipCancel:this.__localizations?.objectEditorPrompt?.buttonTooltipCancel??this.__localizations?.editorPrompt?.buttonTooltipCancel,editorLocalizations:this.__localizations}));try{this.__popup.setValue(this.__value);const result=await this.__popup.prompt();if(result.isOk){this.__value=result.value;const state=this.getState();this.__container.classList.toggle("invalid",!state.isValid),this.__onChangeManager.trigger(this,state),state.isValid&&this.__onConfirmManager.trigger(this,state)}}catch(ex){}}setLocalizations(texts){super.setLocalizations(texts),this.__popup?.setLocalizations({buttonTextOk:this.__localizations?.objectEditorPrompt?.buttonTextOk??this.__localizations?.editorPrompt?.buttonTextOk,buttonTooltipOk:this.__localizations?.objectEditorPrompt?.buttonTooltipOk??this.__localizations?.editorPrompt?.buttonTooltipOk,buttonTextCancel:this.__localizations?.objectEditorPrompt?.buttonTextCancel??this.__localizations?.editorPrompt?.buttonTextCancel,buttonTooltipCancel:this.__localizations?.objectEditorPrompt?.buttonTooltipCancel??this.__localizations?.editorPrompt?.buttonTooltipCancel,editorLocalizations:this.__localizations})}}TcHmi.Controls.Helpers??={},TcHmi.Controls.Helpers.ObjectEditor=ObjectEditor;
import{Editor}from"./BaseEditors/Editor.js";import{ObjectEditor}from"./BaseEditors/ObjectEditor.js";import{ChoiceEditor}from"./BaseEditors/ChoiceEditor.js";const __restrictions=new Map([["number",["maximum","minimum","exclusiveMaximum","exclusiveMinimum","multipleOf"]],["string",["maxLength","minLength","pattern","format"]],["object",["properties","patternProperties","dependencies","maxProperties","minProperties","required","additionalProperties"]],["array",["additionalItems","items","maxItems","minItems","uniqueItems"]]]),__cloneEditorInfoOptions={cloneMaps:{deepCloneKeys:!0,deepCloneValues:!0},cloneSets:{deepCloneValues:!0},cloneDates:!0,resolveRecursiveReferences:!0},__compareEditorInfoOptions={compareMaps:{deepCompareKeys:!0,deepCompareValues:!0},compareSets:{deepCompareValues:!0},compareDates:!0},__parsedSchemas=new WeakMap,__mergedEditorInfos=new WeakMap;export function parse(schema,nameGenerator){return __parse(resolveReferences(schema),nameGenerator)}function __parse(schema,nameGenerator){const editorInfo=__mergeEditorInfos(...function(schema){if(!schema.allOf?.length)return[schema];const schemas=[...schema.allOf];Object.keys(schema).length>1&&schemas.unshift(schema);return schemas}(schema).map(schema=>{const editorInfo=__parsedSchemas.get(schema);if(editorInfo)return editorInfo;const types=__findPossibleEditorTypes(schema),condensedTypes=[],convertedTypes=[],condense=type=>{let condensedType;return["boolean","number","string","time","enum","null"].includes(type.editorType)&&(condensedType=condensedTypes.find(condensed=>condensed.editorType===type.editorType&&condensed.id===type.schema.id&&condensed.title===type.schema.title)),condensedType?condensedType.condensedFrom.push(type):(condensedType={editorType:type.editorType,convertibles:[],condensedFrom:[type]},type.schema.id&&(condensedType.id=type.schema.id),type.schema.title&&(condensedType.title=type.schema.title),condensedTypes.push(condensedType)),condensedType};for(const type of types)type.convert?convertedTypes.push(type):condense(type);for(const type of convertedTypes){const existingTypes=condensedTypes.filter(condensed=>condensed.condensedFrom.some(condensedFrom=>condensedFrom.rawType===type.convert));if(existingTypes.length>0)for(const existingType of existingTypes)existingType.convertibles.push(type);else{const condensedType=condense(type);condensedType.convertibles.push(...convertedTypes.filter(converted=>converted!==type&&condensedType.condensedFrom.some(condensedFrom=>condensedFrom.rawType===converted.convert)))}}const editorInfoRef={type:"invalid",schema,name:""};return __parsedSchemas.set(schema,editorInfoRef),__createEditorInfo(condensedTypes,editorInfoRef,nameGenerator)}));return editorInfo.schema=schema,editorInfo}export function resolveAllOf(schema){const resolvedSchemas=new Set;return function resolve(schema){if(resolvedSchemas.has(schema))return schema;if(resolvedSchemas.add(schema),null!==schema&&"object"==typeof schema){if(schema.allOf&&Array.isArray(schema.allOf))return schema.allOf.reduce((combined,current)=>{for(const key of Object.keys(current)){if(void 0!==combined[key]&&!tchmi_equal(combined[key],current[key]))throw new Error(`This method cannot resolve conflicting JSON schema properties. Property "${key}" is present in both schemas with conflicting values ${JSON.stringify(combined[key])} and ${JSON.stringify(current[key])}`);combined[key]=current[key]}return combined});if(Array.isArray(schema))for(const[index,subSchema]of schema.entries())null!==subSchema&&"object"==typeof subSchema&&(schema[index]=resolve(subSchema));else for(const[key,subSchema]of Object.entries(schema))null!==subSchema&&"object"==typeof subSchema&&(schema[key]=resolve(subSchema))}return schema}(tchmi_clone_object(schema,__cloneEditorInfoOptions))}export function resolveReferences(schema){schema=tchmi_clone_object(schema);const knownRefs=new Map,resolve=schema=>{if(null!==schema&&"object"==typeof schema){if("string"==typeof schema.$ref){let subSchema=knownRefs.get(schema.$ref);if(!subSchema){if(subSchema=tchmi_clone_object(TcHmi.Type.getSchema(schema.$ref)??void 0),!subSchema)throw new Error(TcHmi.Log.buildMessage({code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.Controls.Helpers.SchemaParser",reason:`Unknown schema reference ${schema.$ref}.`}));knownRefs.set(schema.$ref,subSchema),knownRefs.set(schema.$ref,resolve(subSchema))}return subSchema}if(Array.isArray(schema))for(let i=0,ii=schema.length;i<ii;i++)null!==schema[i]&&"object"==typeof schema[i]&&(schema[i]=resolve(schema[i]));else for(const key of Object.keys(schema))null!==schema[key]&&"object"==typeof schema[key]&&(schema[key]=resolve(schema[key]))}return schema};return resolve(schema)}function __findPossibleEditorTypes(schema,strayRestrictions=new Map){let rawTypes=new Set;if(schema.type)"string"==typeof schema.type?rawTypes.add(schema.type):Array.isArray(schema.type)&&(rawTypes=new Set(schema.type));else if(schema.enum)for(const entry of schema.enum){const type=typeof entry;let rawType;switch(type){case"bigint":rawType="number";break;case"symbol":case"function":rawType="object";break;case"undefined":rawType="null";break;case"object":rawType=entry?"object":"null";break;default:rawType=type}rawTypes.add(rawType)}const subSchemas=[];schema.anyOf&&subSchemas.push(...schema.anyOf),schema.oneOf&&subSchemas.push(...schema.oneOf);const newStrayRestrictions=new Map;for(const[typename,keywords]of __restrictions)if(!rawTypes.has(typename))for(const keyword of keywords)if(keyword in schema){let restrictionMap=newStrayRestrictions.get(typename);restrictionMap||(restrictionMap=new Map,newStrayRestrictions.set(typename,restrictionMap)),restrictionMap.set(keyword,schema[keyword])}0===rawTypes.size&&0===subSchemas.length&&newStrayRestrictions.size>0&&(rawTypes=new Set(newStrayRestrictions.keys()),newStrayRestrictions.clear());for(const[typename,strayRestriction]of strayRestrictions)if(rawTypes.has(typename)){for(const[keyword,value]of strayRestriction)keyword in schema||(schema[keyword]=value);strayRestrictions.delete(typename)}for(const[typename,strayRestriction]of newStrayRestrictions){const existingStrayRestriction=strayRestrictions.get(typename);if(existingStrayRestriction)for(const[restriction,value]of strayRestriction)existingStrayRestriction.set(restriction,value);else strayRestrictions.set(typename,strayRestriction)}const types=[];for(const rawType of rawTypes){let editorType;if(schema.enum)editorType="enum";else if("date-time"===schema.format||"timespan"===schema.format)editorType="time";else switch(rawType){case"boolean":editorType="boolean";break;case"integer":case"number":editorType="number";break;case"string":editorType="string";break;case"object":editorType="object";break;case"array":editorType=Array.isArray(schema.items)?"tuple":"array";break;case"null":editorType="null";break;default:editorType="invalid"}types.push({editorType,rawType,schema})}if(schema.convert)for(const type of types)type.rawType!==schema.convert&&(type.convert=schema.convert);for(const subSchema of subSchemas){const subTypes=__findPossibleEditorTypes(subSchema,strayRestrictions);types.push(...subTypes)}return types}function __generateName(type,nameGenerator){if(nameGenerator){if("string"==typeof nameGenerator)return nameGenerator;const name=nameGenerator(type.editorType,type.title,type.id,type.condensedFrom.map(type=>type.schema));if(name)return name}return generateName({title:type.title,id:type.id,type:type.editorType})}export function generateName(schema){if(schema.title)return schema.title;if(schema.id){const result=/tchmi:([a-zA-Z]+)#\/definitions\/(.+)$/.exec(schema.id);if(result)return result[2]}return"string"==typeof schema.type?schema.type.charAt(0).toUpperCase()+schema.type.slice(1):""}function __createEditorInfo(types,ref,nameGenerator){let info;if(1===types.length)switch(ref.name=__generateName(types[0],nameGenerator),types[0].editorType){case"boolean":info=function(_type,ref){const info=ref;return info.type="boolean",info}(types[0],ref);break;case"number":info=function(type,ref){const restrictions=type.condensedFrom.map(type=>{const restriction={isInteger:"integer"===type.rawType};return void 0!==type.schema.multipleOf&&(restriction.multipleOf=type.schema.multipleOf),void 0!==type.schema.maximum&&(restriction.maximum={value:type.schema.maximum,exclusive:type.schema.exclusiveMaximum??!1}),void 0!==type.schema.minimum&&(restriction.minimum={value:type.schema.minimum,exclusive:type.schema.exclusiveMinimum??!1}),restriction}),info=ref;info.type="number",info.restrictions=restrictions,info.specialValues=new Set;for(const convertible of type.convertibles)if(convertible.schema.enum)for(const item of convertible.schema.enum)info.specialValues.add(item);return info}(types[0],ref);break;case"string":info=function(type,ref){const restrictions=type.condensedFrom.map(type=>{const restriction={};return void 0!==type.schema.minLength&&(restriction.minLength=type.schema.minLength),void 0!==type.schema.maxLength&&(restriction.maxLength=type.schema.maxLength),type.schema.pattern&&(restriction.patterns=[new RegExp(type.schema.pattern)]),type.schema.format&&(restriction.format=type.schema.format),restriction}),info=ref;return info.type="string",info.restrictions=restrictions.filter(restriction=>Object.keys(restriction).length>0),info}(types[0],ref);break;case"time":info=function(type,ref){const formats=new Set(type.condensedFrom.map(type=>type.schema.format).filter(format=>"date-time"===format||"timespan"===format)),info=ref;return info.type="time",info.formats=formats,info}(types[0],ref);break;case"enum":info=function(type,ref){const info=ref;info.type="enum",info.members=new Map;for(const condensedFrom of type.condensedFrom)if(condensedFrom.schema.enum){for(const member of condensedFrom.schema.enum)info.members.set(member,void 0);if(condensedFrom.schema.options)for(const option of condensedFrom.schema.options)info.members.has(option.value)&&info.members.set(option.value,option.label)}return info}(types[0],ref);break;case"object":info=function(type,ref,nameGenerator){const info=ref;info.type="object",info.properties=new Map,info.additionalProperties={allowed:!0};const editorSchema=type.condensedFrom[0].schema;if(editorSchema.patternProperties){info.patternProperties=new Map;for(const[key,property]of Object.entries(editorSchema.patternProperties))info.patternProperties.set(new RegExp(key),__parse(property,"function"==typeof nameGenerator?nameGenerator:void 0))}const buildDefaultValue=!info.defaultValue;if(editorSchema.properties)for(const[key,property]of Object.entries(editorSchema.properties)){let editorInfo=__parse(property,"function"==typeof nameGenerator?nameGenerator:void 0);if(info.patternProperties&&Array.from(info.patternProperties.keys()).some(regex=>regex.test(key))){const matchingInfos=[];for(const[regex,patternInfo]of info.patternProperties)regex.test(key)&&matchingInfos.push(patternInfo);editorInfo=mergeEditorInfos(editorInfo,...matchingInfos)}const propertyMeta=editorSchema.propertiesMeta?.find(meta=>meta.name===key);editorSchema.required?.includes(key)||"optional"===editorInfo.type||(editorInfo={type:"optional",schema:editorInfo.schema,name:editorInfo.name,editorInfo,temporarilyRequired:!1},void 0!==propertyMeta?.defaultValueInternal&&null!==propertyMeta.defaultValueInternal&&Editor.validate(editorInfo,propertyMeta.defaultValueInternal)&&(editorInfo.valueIfDisabled=propertyMeta.defaultValueInternal)),void 0!==propertyMeta?.defaultValue&&null!==propertyMeta.defaultValue&&Editor.validate(editorInfo,propertyMeta.defaultValue)&&(editorInfo.defaultValue=propertyMeta.defaultValue,buildDefaultValue&&(info.defaultValue??={},info.defaultValue[key]=propertyMeta.defaultValue)),info.properties.set(key,editorInfo)}void 0!==editorSchema.additionalProperties&&(info.additionalProperties.allowed=!1!==editorSchema.additionalProperties,info.additionalProperties.allowed&&(info.additionalProperties.editorInfo=__parse("object"==typeof editorSchema.additionalProperties?editorSchema.additionalProperties:{},"function"==typeof nameGenerator?nameGenerator:void 0)));if(editorSchema.required){info.defaultValue??={};for(const requiredProperty of editorSchema.required){let propertyInfo=info.properties.get(requiredProperty);propertyInfo||(propertyInfo=ObjectEditor.getEditorInfoForProperty(info,requiredProperty),info.properties.set(requiredProperty,propertyInfo)),buildDefaultValue&&(info.defaultValue[requiredProperty]=propertyInfo.defaultValue)}}void 0!==editorSchema.maxProperties&&(info.maxProperties=editorSchema.maxProperties);void 0!==editorSchema.minProperties&&(info.minProperties=editorSchema.minProperties);if(void 0!==editorSchema.dependencies){info.dependencies=new Map;for(const key in editorSchema.dependencies){const dependency=editorSchema.dependencies[key];if(Array.isArray(dependency)){const dependencyInfo={type:"object",schema:{},name:info.name,properties:new Map,additionalProperties:{allowed:!0}};for(const requiredProperty of dependency){const editorInfo=ObjectEditor.getEditorInfoForProperty(info,requiredProperty);"optional"===editorInfo.type?dependencyInfo.properties.set(requiredProperty,editorInfo.editorInfo):info.properties.get(requiredProperty)!==editorInfo&&dependencyInfo.properties.set(requiredProperty,editorInfo)}info.dependencies.set(key,dependencyInfo)}else{const dependencyInfo=__parse(dependency,"function"==typeof nameGenerator?nameGenerator:void 0);"object"===dependencyInfo.type&&info.dependencies.set(key,dependencyInfo)}}}return info}(types[0],ref,nameGenerator);break;case"array":info=function(type,ref,nameGenerator){const editorSchema=type.condensedFrom[0].schema,info=ref;info.type="array",info.items=editorSchema.items&&!Array.isArray(editorSchema.items)?__parse(editorSchema.items,"function"==typeof nameGenerator?nameGenerator:void 0):ChoiceEditor.createAnyEditorInfo(),info.uniqueItems=editorSchema.uniqueItems??!1,void 0!==editorSchema.minItems&&(info.minItems=editorSchema.minItems,info.defaultValue??=Array(info.minItems).fill(info.items.defaultValue));void 0!==editorSchema.maxItems&&(info.maxItems=editorSchema.maxItems);return info}(types[0],ref,nameGenerator);break;case"tuple":info=function(type,ref,nameGenerator){const editorSchema=type.condensedFrom[0].schema,info=ref;info.type="tuple",info.items=[],info.additionalItems={allowed:!0},info.uniqueItems=editorSchema.uniqueItems??!1;let buildDefaultValue=!1;void 0!==editorSchema.minItems&&(info.minItems=editorSchema.minItems,buildDefaultValue=!info.defaultValue,info.defaultValue??=[]);void 0!==editorSchema.maxItems&&(info.maxItems=editorSchema.maxItems);if(Array.isArray(editorSchema.items)){const minItems=info.minItems??0;for(let i=0,ii=editorSchema.items.length;i<ii;i++){let editorInfo=__parse(editorSchema.items[i],"function"==typeof nameGenerator?nameGenerator:void 0);i>=minItems?editorInfo={type:"optional",schema:editorInfo.schema,name:editorInfo.name,editorInfo,temporarilyRequired:!1}:buildDefaultValue&&info.defaultValue?.push(editorInfo.defaultValue),info.items.push(editorInfo)}}void 0!==editorSchema.additionalItems&&(info.additionalItems.allowed=!1!==editorSchema.additionalItems,info.additionalItems.allowed&&(info.additionalItems.editorInfo=__parse("object"==typeof editorSchema.additionalItems?editorSchema.additionalItems:{},"function"==typeof nameGenerator?nameGenerator:void 0)));return info}(types[0],ref,nameGenerator);break;case"null":info=function(_type,ref){const info=ref;return info.type="null",info}(types[0],ref);break;default:info=__createAnyEditorInfo(types[0],ref,nameGenerator)}else info=types.length>1?function(types,ref,nameGenerator){const info=ref;info.type="choice",info.name=__generateName({editorType:"choice",id:info.schema.id,title:info.schema.title,condensedFrom:[{editorType:"choice",rawType:"null",schema:info.schema}],convertibles:[]},nameGenerator),info.choices=[];for(const type of types){const choice=__createEditorInfo([type],{type:"invalid",schema:info.schema,name:""},"function"==typeof nameGenerator?nameGenerator:void 0);if("choice"!==choice.type)info.choices.push(choice);else for(const subChoice of choice.choices??ChoiceEditor.getAnyChoices())info.choices.push(subChoice)}return info}(types,ref,nameGenerator):__createAnyEditorInfo({editorType:"choice",id:ref.schema.id,title:ref.schema.title??"Any",condensedFrom:[],convertibles:[]},ref,nameGenerator);return void 0!==ref.schema.default&&Editor.validate(info,ref.schema.default)&&(ref.defaultValue=ref.schema.default),info}function __createAnyEditorInfo(type,ref,nameGenerator){const schema=ref.schema,info=ChoiceEditor.createAnyEditorInfo(ref);return info.schema=schema,info.name=__generateName(type,nameGenerator),info}export function mergeEditorInfos(...toMerge){return __mergeEditorInfos(...toMerge.map(editorInfo=>tchmi_clone_object(editorInfo,__cloneEditorInfoOptions)))}function __mergeEditorInfos(...toMerge){let result;const name=toMerge[0]?.name,enumIndex=toMerge.findIndex(info=>"enum"===info.type);if(-1!==enumIndex)result=toMerge.splice(enumIndex,1)[0];else{const nonAnyIndex=toMerge.findIndex(info=>"choice"!==info.type||void 0!==info.choices);result=-1!==nonAnyIndex?toMerge.splice(nonAnyIndex,1)[0]:toMerge.shift()}if(!result)return{type:"invalid",schema:{},name:name??"Invalid"};if(0===(toMerge=toMerge.filter(info=>"choice"!==info.type||void 0!==info.choices)).length)return result;const mergedWithCollection=__mergedEditorInfos.get(result);if(mergedWithCollection){if(mergedWithCollection.some(mergedWith=>mergedWith.length===toMerge.length&&mergedWith.every((info,index)=>info===toMerge[index])))return result;mergedWithCollection.push(toMerge)}else __mergedEditorInfos.set(result,[toMerge]);switch(result.schema={allOf:[result.schema].concat(...toMerge.map(info=>info.schema))},name&&(result.name=name),result.type){case"boolean":return function(target,toMerge){if(!toMerge.every(info=>"boolean"===info.type||"optional"===info.type&&"boolean"===info.editorInfo.type||"choice"===info.type&&(!info.choices||info.choices.some(choice=>"boolean"===choice.type))))return{type:"invalid",schema:target.schema,name:target.name};return target}(result,toMerge);case"number":return function(target,toMerge){toMerge=toMerge.map(info=>{if("optional"===info.type)return info.editorInfo;if("choice"===info.type){const numberChoices=(info.choices??ChoiceEditor.getAnyChoices()).filter(choice=>"number"===choice.type);return 0===numberChoices.length?info:1===numberChoices.length?numberChoices[0]:numberChoices.reduce((result,current)=>{for(const specialValue of current.specialValues)result.specialValues.add(specialValue);return result.restrictions.push(...current.restrictions),result})}return info});for(const info of toMerge){if("number"!==info.type)return{type:"invalid",schema:target.schema,name:target.name};if(target.specialValues=new Set([...target.specialValues].filter(value=>info.specialValues.has(value))),info.restrictions.length>0)if(0===target.restrictions.length)target.restrictions=tchmi_clone_object(info.restrictions,__cloneEditorInfoOptions);else{const restrictions=[];for(const targetRestriction of target.restrictions)for(const mergeRestriction of info.restrictions){const restriction={isInteger:targetRestriction.isInteger||mergeRestriction.isInteger};let isValid=!0;void 0!==targetRestriction.multipleOf&&void 0!==mergeRestriction.multipleOf?restriction.multipleOf=targetRestriction.multipleOf===mergeRestriction.multipleOf?targetRestriction.multipleOf:targetRestriction.multipleOf*mergeRestriction.multipleOf:void 0!==targetRestriction.multipleOf?restriction.multipleOf=targetRestriction.multipleOf:void 0!==mergeRestriction.multipleOf&&(restriction.multipleOf=mergeRestriction.multipleOf),targetRestriction.maximum&&mergeRestriction.maximum?targetRestriction.maximum.value<mergeRestriction.maximum.value?restriction.maximum=targetRestriction.maximum:mergeRestriction.maximum.value<targetRestriction.maximum.value?restriction.maximum=mergeRestriction.maximum:restriction.maximum={value:targetRestriction.maximum.value,exclusive:targetRestriction.maximum.exclusive||mergeRestriction.maximum.exclusive}:targetRestriction.maximum?restriction.maximum=targetRestriction.maximum:mergeRestriction.maximum&&(restriction.maximum=mergeRestriction.maximum),targetRestriction.minimum&&mergeRestriction.minimum?targetRestriction.minimum.value>mergeRestriction.minimum.value?restriction.minimum=targetRestriction.minimum:mergeRestriction.minimum.value>targetRestriction.minimum.value?restriction.minimum=mergeRestriction.minimum:restriction.minimum={value:targetRestriction.minimum.value,exclusive:targetRestriction.minimum.exclusive||mergeRestriction.minimum.exclusive}:targetRestriction.minimum?restriction.minimum=targetRestriction.minimum:mergeRestriction.minimum&&(restriction.minimum=mergeRestriction.minimum),restriction.maximum&&restriction.minimum&&(restriction.maximum.value<restriction.minimum.value||restriction.maximum.value===restriction.minimum.value&&(restriction.maximum.exclusive||restriction.minimum.exclusive))&&(isValid=!1),isValid&&!restrictions.some(r=>tchmi_equal(r,restriction,__compareEditorInfoOptions))&&restrictions.push(restriction)}if(!(restrictions.length>0))return{type:"invalid",schema:target.schema,name:target.name};target.restrictions=restrictions}}return target}(result,toMerge);case"string":return function(target,toMerge){toMerge=toMerge.map(info=>{if("optional"===info.type)return info.editorInfo;if("choice"===info.type){const stringChoices=(info.choices??ChoiceEditor.getAnyChoices()).filter(choice=>"string"===choice.type);return 0===stringChoices.length?info:1===stringChoices.length?stringChoices[0]:stringChoices.reduce((result,current)=>(result.restrictions.push(...current.restrictions),result))}return info});for(const info of toMerge){if("string"!==info.type)return{type:"invalid",schema:target.schema,name:target.name};if(info.restrictions.length>0)if(0===target.restrictions.length)target.restrictions=tchmi_clone_object(info.restrictions,__cloneEditorInfoOptions);else{const restrictions=[];for(const targetRestriction of target.restrictions)for(const mergeRestriction of info.restrictions){const restriction={};let isValid=!0;targetRestriction.patterns&&mergeRestriction.patterns?restriction.patterns=targetRestriction.patterns.concat(mergeRestriction.patterns):targetRestriction.patterns?restriction.patterns=tchmi_clone_object(targetRestriction.patterns,__cloneEditorInfoOptions):mergeRestriction.patterns&&(restriction.patterns=tchmi_clone_object(mergeRestriction.patterns,__cloneEditorInfoOptions)),targetRestriction.format&&mergeRestriction.format?targetRestriction.format===mergeRestriction.format?restriction.format=targetRestriction.format:isValid=!1:targetRestriction.format?restriction.format=targetRestriction.format:mergeRestriction.format&&(restriction.format=mergeRestriction.format),void 0!==targetRestriction.maxLength&&void 0!==mergeRestriction.maxLength?restriction.maxLength=Math.min(targetRestriction.maxLength,mergeRestriction.maxLength):void 0!==targetRestriction.maxLength?restriction.maxLength=targetRestriction.maxLength:void 0!==mergeRestriction.maxLength&&(restriction.maxLength=mergeRestriction.maxLength),void 0!==targetRestriction.minLength&&void 0!==mergeRestriction.minLength?restriction.minLength=Math.max(targetRestriction.minLength,mergeRestriction.minLength):void 0!==targetRestriction.minLength?restriction.minLength=targetRestriction.minLength:void 0!==mergeRestriction.minLength&&(restriction.minLength=mergeRestriction.minLength),void 0!==restriction.maxLength&&void 0!==restriction.minLength&&restriction.maxLength<restriction.minLength&&(isValid=!1),isValid&&!restrictions.some(r=>tchmi_equal(r,restriction,__compareEditorInfoOptions))&&restrictions.push(restriction)}if(!(restrictions.length>0))return{type:"invalid",schema:target.schema,name:target.name};target.restrictions=restrictions}}return target}(result,toMerge);case"time":return function(target,toMerge){toMerge=toMerge.map(info=>{if("optional"===info.type)return info.editorInfo;if("choice"===info.type){const timeChoices=(info.choices??ChoiceEditor.getAnyChoices()).filter(choice=>"time"===choice.type);return 0===timeChoices.length?info:1===timeChoices.length?timeChoices[0]:timeChoices.reduce((result,current)=>{for(const format of current.formats)result.formats.add(format);return result})}return info});for(const info of toMerge){if("time"!==info.type)return{type:"invalid",schema:target.schema,name:target.name};if(target.formats=new Set([...target.formats].filter(value=>info.formats.has(value))),0===target.formats.size)return{type:"invalid",schema:target.schema,name:target.name}}return target}(result,toMerge);case"enum":return function(target,toMerge){toMerge=toMerge.map(info=>"optional"!==info.type?info:info.editorInfo);for(const info of toMerge){if("enum"===info.type)for(const member of target.members.keys())info.members.has(member)?target.members.set(member,info.members.get(member)):target.members.delete(member);else for(const member of target.members.keys())Editor.validate(info,member)||target.members.delete(member);if(0===target.members.size)return{type:"invalid",schema:target.schema,name:target.name}}return target}(result,toMerge);case"object":return function(target,toMerge){const reduced=new Set,reduceObjectEditors=(result,current)=>{if(reduced.has(result))return result;if(reduced.add(result),result.additionalProperties.allowed=result.additionalProperties.allowed||current.additionalProperties.allowed,current.additionalProperties.editorInfo&&(result.additionalProperties.editorInfo?("choice"!==result.additionalProperties.editorInfo.type&&(result.additionalProperties.editorInfo={type:"choice",schema:{},name:"Choice",choices:[result.additionalProperties.editorInfo]}),"choice"===current.additionalProperties.editorInfo.type?current.additionalProperties.editorInfo.choices?result.additionalProperties.editorInfo.choices?.push(...current.additionalProperties.editorInfo.choices):delete result.additionalProperties.editorInfo.choices:result.additionalProperties.editorInfo.choices?.push(current.additionalProperties.editorInfo)):result.additionalProperties.editorInfo=current.additionalProperties.editorInfo),current.patternProperties){result.patternProperties||(result.patternProperties=new Map);for(const[regex,propertyInfo]of current.patternProperties){let resultKey=null,resultValue=propertyInfo;for(const[resultRegex,resultPropertyInfo]of result.patternProperties)if(regex.source===resultRegex.source){resultKey=resultRegex,resultValue="choice"!==resultPropertyInfo.type?{type:"choice",schema:{},name:"Choice",choices:[resultPropertyInfo]}:resultPropertyInfo,"choice"===propertyInfo.type?propertyInfo.choices?resultValue.choices?.push(...propertyInfo.choices):delete resultValue.choices:resultValue.choices?.push(propertyInfo);break}null===resultKey&&(resultKey=regex),result.patternProperties.set(resultKey,resultValue)}}const propertiesToMakeOptional=new Set(result.properties.keys());for(const[name,propertyInfo]of current.properties){let resultValue=result.properties.get(name);resultValue?(propertiesToMakeOptional.delete(name),"choice"!==resultValue.type&&(resultValue={type:"choice",schema:{},name:"Choice",choices:[resultValue]}),"choice"===propertyInfo.type?propertyInfo.choices?resultValue.choices?.push(...propertyInfo.choices):delete resultValue.choices:resultValue.choices?.push(propertyInfo)):(resultValue=propertyInfo,"optional"!==resultValue.type&&(resultValue={type:"optional",schema:{},name:resultValue.name,editorInfo:resultValue,temporarilyRequired:!1})),result.properties.set(name,resultValue)}for(const name of propertiesToMakeOptional){let resultValue=result.properties.get(name);resultValue&&("optional"!==resultValue.type&&(resultValue={type:"optional",schema:{},name:resultValue.name,editorInfo:resultValue,temporarilyRequired:!1},result.properties.set(name,resultValue)))}if(result.dependencies)if(current.dependencies){const dependenciesToDelete=new Set(result.dependencies.keys());for(const[name,dependency]of current.dependencies){let resultValue=result.dependencies.get(name);resultValue&&(dependenciesToDelete.delete(name),resultValue=reduceObjectEditors(resultValue,dependency),result.dependencies.set(name,resultValue))}for(const name of dependenciesToDelete)result.dependencies.delete(name)}else delete result.dependencies;return void 0!==result.minProperties&&(void 0===current.minProperties?delete result.minProperties:result.minProperties=Math.min(current.minProperties,result.minProperties)),void 0!==result.maxProperties&&(void 0===current.maxProperties?delete result.maxProperties:result.maxProperties=Math.max(current.maxProperties,result.maxProperties)),result};toMerge=toMerge.map(info=>{if("optional"===info.type)return info.editorInfo;if("choice"===info.type){const objectChoices=(info.choices??ChoiceEditor.getAnyChoices()).filter(choice=>"object"===choice.type);return 0===objectChoices.length?info:1===objectChoices.length?objectChoices[0]:objectChoices.reduce(reduceObjectEditors)}return info});for(const info of toMerge){if("object"!==info.type)return{type:"invalid",schema:target.schema,name:target.name};if(!info.additionalProperties.allowed)for(const name of target.properties.keys())if(!(info.properties.has(name)||info.patternProperties&&Array.from(info.patternProperties.keys()).some(regex=>regex.test(name))))return{type:"invalid",schema:target.schema,name:target.name};if(info.patternProperties){target.patternProperties||(target.patternProperties=new Map);for(const[regex,mergePropertyInfo]of info.patternProperties){let foundTarget=!1;for(const[targetRegex,targetPropertyInfo]of target.patternProperties)if(targetRegex.source===regex.source){foundTarget=!0,target.patternProperties.set(targetRegex,__mergeEditorInfos(targetPropertyInfo,mergePropertyInfo));break}foundTarget||target.patternProperties.set(regex,mergePropertyInfo);for(const[targetName,targetPropertyInfo]of target.properties)regex.test(targetName)&&target.properties.set(targetName,__mergeEditorInfos(targetPropertyInfo,mergePropertyInfo))}}if(info.additionalProperties.editorInfo)for(const[name,targetPropertyInfo]of target.properties)info.properties.has(name)||info.patternProperties&&Array.from(info.patternProperties.keys()).some(regex=>regex.test(name))||target.properties.set(name,__mergeEditorInfos(targetPropertyInfo,info.additionalProperties.editorInfo));for(const[name,mergePropertyInfo]of info.properties){const targetPropertyInfo=ObjectEditor.getEditorInfoForProperty(target,name);if("invalid"===targetPropertyInfo.type)return{type:"invalid",schema:target.schema,name:target.name};target.properties.set(name,__mergeEditorInfos(targetPropertyInfo,mergePropertyInfo))}if(target.additionalProperties.allowed=target.additionalProperties.allowed&&info.additionalProperties.allowed,target.additionalProperties.allowed?target.additionalProperties.editorInfo&&info.additionalProperties.editorInfo?target.additionalProperties.editorInfo=__mergeEditorInfos(target.additionalProperties.editorInfo,info.additionalProperties.editorInfo):info.additionalProperties.editorInfo&&(target.additionalProperties.editorInfo=info.additionalProperties.editorInfo):target.additionalProperties.editorInfo&&delete target.additionalProperties.editorInfo,void 0!==info.maxProperties&&(void 0!==target.maxProperties?target.maxProperties=Math.min(target.maxProperties,info.maxProperties):target.maxProperties=info.maxProperties),void 0!==info.minProperties&&(void 0!==target.minProperties?target.minProperties=Math.max(target.minProperties,info.minProperties):target.minProperties=info.minProperties),info.dependencies)if(target.dependencies)for(const[name,mergeDependency]of info.dependencies){const targetDependency=target.dependencies.get(name);if(targetDependency){const dependency=__mergeEditorInfos(targetDependency,mergeDependency);if("object"!==dependency.type)return{type:"invalid",schema:target.schema,name:target.name};target.dependencies.set(name,dependency)}else target.dependencies.set(name,mergeDependency)}else target.dependencies=info.dependencies}if(void 0!==target.minProperties&&void 0!==target.maxProperties&&target.minProperties>target.maxProperties)return{type:"invalid",schema:target.schema,name:target.name};return target}(result,toMerge);case"array":return function(target,toMerge){toMerge=toMerge.map(info=>{if("optional"===info.type)return info.editorInfo;if("choice"===info.type){const arrayChoices=(info.choices??ChoiceEditor.getAnyChoices()).filter(choice=>"array"===choice.type);return 0===arrayChoices.length?info:1===arrayChoices.length?arrayChoices[0]:arrayChoices.reduce((result,current)=>("choice"!==result.items.type&&(result.items={type:"choice",schema:{},name:"Choice",choices:[result.items]}),"choice"===current.items.type?current.items.choices?result.items.choices?.push(...current.items.choices):delete result.items.choices:result.items.choices?.push(current.items),void 0!==result.minItems&&(void 0===current.minItems?delete result.minItems:result.minItems=Math.min(current.minItems,result.minItems)),void 0!==result.maxItems&&(void 0===current.maxItems?delete result.maxItems:result.maxItems=Math.max(current.maxItems,result.maxItems)),result.uniqueItems=result.uniqueItems&&current.uniqueItems,result))}return info});const itemInfos=[target.items];for(const info of toMerge){if("array"!==info.type)return{type:"invalid",schema:target.schema,name:target.name};void 0!==info.minItems&&(void 0===target.minItems||target.minItems<info.minItems)&&(target.minItems=info.minItems),void 0!==info.maxItems&&(void 0===target.maxItems||target.maxItems>info.maxItems)&&(target.maxItems=info.maxItems),target.uniqueItems=target.uniqueItems||info.uniqueItems,itemInfos.push(info.items)}if(void 0!==target.minItems&&void 0!==target.maxItems&&target.minItems>target.maxItems)return{type:"invalid",schema:target.schema,name:target.name};if(target.items=__mergeEditorInfos(...itemInfos),"invalid"===target.items.type)return{type:"invalid",schema:target.schema,name:target.name};return target}(result,toMerge);case"tuple":return function(target,toMerge){toMerge=toMerge.map(info=>{if("optional"===info.type)return info.editorInfo;if("choice"===info.type){const tupleChoices=(info.choices??ChoiceEditor.getAnyChoices()).filter(choice=>"tuple"===choice.type);return 0===tupleChoices.length?info:1===tupleChoices.length?tupleChoices[0]:tupleChoices.reduce((result,current)=>{result.additionalItems.allowed=result.additionalItems.allowed||current.additionalItems.allowed,result.additionalItems.editorInfo&&(current.additionalItems.editorInfo?("choice"!==result.additionalItems.editorInfo.type&&(result.additionalItems.editorInfo={type:"choice",schema:{},name:"Choice",choices:[result.additionalItems.editorInfo]}),"choice"===current.additionalItems.editorInfo.type?current.additionalItems.editorInfo.choices?result.additionalItems.editorInfo.choices?.push(...current.additionalItems.editorInfo.choices):delete result.additionalItems.editorInfo.choices:result.additionalItems.editorInfo.choices?.push(current.additionalItems.editorInfo)):delete result.additionalItems.editorInfo);const itemsToMakeOptional=new Set(result.items.keys());for(const[index,itemInfo]of current.items.entries()){let resultValue=result.items[index];resultValue?(itemsToMakeOptional.delete(index),"choice"!==resultValue.type&&(resultValue={type:"choice",schema:{},name:"Choice",choices:[resultValue]}),"choice"===itemInfo.type?itemInfo.choices?resultValue.choices?.push(...itemInfo.choices):delete resultValue.choices:resultValue.choices?.push(itemInfo)):(resultValue=itemInfo,"optional"!==resultValue.type&&(resultValue={type:"optional",schema:{},name:resultValue.name,editorInfo:resultValue,temporarilyRequired:!1})),result.items[index]=resultValue}for(const index of itemsToMakeOptional){let resultValue=result.items[index];resultValue&&("optional"!==resultValue.type&&(resultValue={type:"optional",schema:{},name:resultValue.name,editorInfo:resultValue,temporarilyRequired:!1},result.items[index]=resultValue))}return void 0!==result.minItems&&(void 0===current.minItems?delete result.minItems:result.minItems=Math.min(current.minItems,result.minItems)),void 0!==result.maxItems&&(void 0===current.maxItems?delete result.maxItems:result.maxItems=Math.max(current.maxItems,result.maxItems)),result.uniqueItems=result.uniqueItems&&current.uniqueItems,result})}return info});for(const info of toMerge){if("tuple"!==info.type)return{type:"invalid",schema:target.schema,name:target.name};let index=0;for(const length=target.items.length;index<length;index++){if(index<info.items.length)target.items[index]=__mergeEditorInfos(target.items[index],info.items[index]);else{if(!info.additionalItems.allowed)return{type:"invalid",schema:target.schema,name:target.name};info.additionalItems.editorInfo&&(target.items[index]=__mergeEditorInfos(target.items[index],info.additionalItems.editorInfo))}if("invalid"===target.items[index].type)return{type:"invalid",schema:target.schema,name:target.name}}for(const length=info.items.length;index<length;index++){if(!target.additionalItems.allowed)return{type:"invalid",schema:target.schema,name:target.name};if(target.additionalItems.editorInfo){if(target.items[index]=__mergeEditorInfos(target.additionalItems.editorInfo,info.items[index]),"invalid"===target.items[index].type)return{type:"invalid",schema:target.schema,name:target.name}}else target.items[index]=info.items[index]}target.additionalItems.allowed=target.additionalItems.allowed&&info.additionalItems.allowed,target.additionalItems.allowed?target.additionalItems.editorInfo&&info.additionalItems.editorInfo?target.additionalItems.editorInfo=__mergeEditorInfos(target.additionalItems.editorInfo,info.additionalItems.editorInfo):info.additionalItems.editorInfo&&(target.additionalItems.editorInfo=info.additionalItems.editorInfo):target.additionalItems.editorInfo&&delete target.additionalItems.editorInfo,void 0!==info.minItems&&(void 0===target.minItems||target.minItems<info.minItems)&&(target.minItems=info.minItems),void 0!==info.maxItems&&(void 0===target.maxItems||target.maxItems>info.maxItems)&&(target.maxItems=info.maxItems),target.uniqueItems=target.uniqueItems||info.uniqueItems}if(void 0!==target.minItems&&void 0!==target.maxItems&&target.minItems>target.maxItems)return{type:"invalid",schema:target.schema,name:target.name};return target}(result,toMerge);case"choice":return function(target,toMerge){function boolToNum(value){return value?1:0}function findValidMerge(choice,candidates){const mergeOrder=Array.from(candidates).sort((a,b)=>{const aVal=(boolToNum(a.name===choice.name)<<1)+boolToNum(a.type===choice.type);return(boolToNum(b.name===choice.name)<<1)+boolToNum(b.type===choice.type)-aVal});for(const mergeChoice of mergeOrder){const mergeResult=__mergeEditorInfos(choice,mergeChoice);if("invalid"!==mergeResult.type&&"choice"!==mergeResult.type)return{validCandidate:mergeChoice,mergedInfo:mergeResult}}return null}toMerge=toMerge.map(info=>"optional"!==info.type?info:info.editorInfo);for(const info of toMerge){const mergeChoices=new Set("choice"===info.type?info.choices??ChoiceEditor.getAnyChoices():[info]),missingChoices=new Set(mergeChoices),originalChoices=new Set(target.choices?.map(choice=>tchmi_clone_object(choice,__cloneEditorInfoOptions)));target.choices||(target.choices=ChoiceEditor.getAnyChoices());for(let i=0;i<target.choices.length;i++){const mergeResult=findValidMerge(target.choices[i],mergeChoices);mergeResult?(target.choices[i]=mergeResult.mergedInfo,missingChoices.delete(mergeResult.validCandidate)):(target.choices.splice(i,1),i--)}for(const choice of missingChoices){const mergeResult=findValidMerge(choice,originalChoices);mergeResult&&target.choices.push(mergeResult.mergedInfo)}}return target}(result,toMerge);case"optional":return function(target,toMerge){let temporarilyRequired=!1;const unwrappedInfos=toMerge.map(info=>"optional"===info.type?(info.temporarilyRequired&&(temporarilyRequired=!0),info.editorInfo):(temporarilyRequired=!0,info)),merged=__mergeEditorInfos(target.editorInfo,...unwrappedInfos);return target.editorInfo="optional"!==merged.type?merged:merged.editorInfo,target.temporarilyRequired=temporarilyRequired,target}(result,toMerge);case"null":return function(target,toMerge){if(toMerge=toMerge.map(info=>"optional"!==info.type?info:info.editorInfo),!toMerge.every(info=>"null"===info.type))return{type:"invalid",schema:target.schema,name:target.name};return target}(result,toMerge);case"invalid":return result}}export function editorInfoEquivalent(a,b){for(const key of Object.keys(a))if("schema"!==key&&!tchmi_equal(a[key],b[key],__compareEditorInfoOptions))return!1;return!0}const _parse=parse,_resolveAllOf=resolveAllOf,_resolveReferences=resolveReferences,_generateName=generateName,_mergeEditorInfos=mergeEditorInfos,_editorInfoEquivalent=editorInfoEquivalent;TcHmi.Controls.Helpers??={},TcHmi.Controls.Helpers.SchemaParser={parse:_parse,resolveAllOf:_resolveAllOf,resolveReferences:_resolveReferences,generateName:_generateName,mergeEditorInfos:_mergeEditorInfos,editorInfoEquivalent:_editorInfoEquivalent};
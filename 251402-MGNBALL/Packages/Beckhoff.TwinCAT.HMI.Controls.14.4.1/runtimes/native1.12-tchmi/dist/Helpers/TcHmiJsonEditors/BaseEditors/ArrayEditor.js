import{ButtonBasedEditor}from"./ButtonBasedEditor.js";import{Editor}from"./Editor.js";import{ArrayEditorPrompt}from"../Popups/ArrayEditorPrompt.js";export class ArrayEditor extends ButtonBasedEditor{__value=[];constructor(element,editorInfo,factory){super(element,editorInfo,factory),this.__processEditorInfo()}destroy(){super.destroy(),this.__popup?.destroy(!0)}static validate(editorInfo,value){return 0===ArrayEditor.checkForErrors(editorInfo,value,!0).length}static checkForErrors(editorInfo,value,returnEarly=!1){if(!Array.isArray(value))return[{error:Editor.Error.NOT_AN_ARRAY,parameters:[value]}];if(null!==Object.getPrototypeOf(value)&&Object.getPrototypeOf(value)!==Object.getPrototypeOf([]))return[{error:Editor.Error.ARRAY_HAS_INVALID_PROTOTYPE,parameters:[value]}];const errors=[];if(void 0!==editorInfo.minItems&&value.length<editorInfo.minItems&&(errors.push({error:Editor.Error.ARRAY_HAS_TOO_FEW_ITEMS,parameters:[value,editorInfo.minItems,value.length]}),returnEarly))return errors;if(void 0!==editorInfo.maxItems&&value.length>editorInfo.maxItems&&(errors.push({error:Editor.Error.ARRAY_HAS_TOO_MANY_ITEMS,parameters:[value,editorInfo.maxItems,value.length]}),returnEarly))return errors;for(const[index,item]of value.entries()){const underlyingErrors=Editor.checkForErrors(editorInfo.items,item,returnEarly);if(underlyingErrors.length>0&&(errors.push({error:Editor.Error.ARRAY_CONTAINS_INVALID_VALUE,parameters:[value,index],underlying:underlyingErrors}),returnEarly))return errors}if(editorInfo.uniqueItems)for(let i=0,ii=value.length-1;i<ii;i++){const duplicateIndices=[i];for(let j=i+1,jj=value.length;j<jj;j++)if(tchmi_equal(value[i],value[j],{compareDates:!0})&&(duplicateIndices.push(j),returnEarly))return[{error:Editor.Error.ARRAY_CONTAINS_DUPLICATE_ITEMS,parameters:[value,duplicateIndices]}];duplicateIndices.length>1&&errors.push({error:Editor.Error.ARRAY_CONTAINS_DUPLICATE_ITEMS,parameters:[value,duplicateIndices]})}return errors}__processEditorInfo(){this.__popup?.setEditorInfo(this.__editorInfo),this.__textSpan.textContent=this.__editorInfo.name,this.__container.classList.toggle("invalid",!this.getState().isValid)}setValue(value){this.__value=value??[],this.__popup?.setValue(value);const state=this.getState();this.__container.classList.toggle("invalid",!state.isValid),this.__onChangeManager.trigger(this,state)}getRawValue(){return this.__value}async openPopup(){this.__popup||(this.__popup=new ArrayEditorPrompt(this.__editorInfo,this.__factory),this.__popup.setBackgroundAction({close:!0,action:"cancel"}),this.__popup.setIsReadOnly(this.__isReadOnly),this.__popup.setSettings(this.__settings),this.__popup.setLocalizations({buttonTextOk:this.__localizations?.arrayEditorPrompt?.buttonTextOk??this.__localizations?.editorPrompt?.buttonTextOk,buttonTooltipOk:this.__localizations?.arrayEditorPrompt?.buttonTooltipOk??this.__localizations?.editorPrompt?.buttonTooltipOk,buttonTextCancel:this.__localizations?.arrayEditorPrompt?.buttonTextCancel??this.__localizations?.editorPrompt?.buttonTextCancel,buttonTooltipCancel:this.__localizations?.arrayEditorPrompt?.buttonTooltipCancel??this.__localizations?.editorPrompt?.buttonTooltipCancel,editorLocalizations:this.__localizations}));try{this.__popup.setValue(this.__value);const result=await this.__popup.prompt();if(result.isOk){this.__value=result.value;const state=this.getState();this.__container.classList.toggle("invalid",!state.isValid),this.__onChangeManager.trigger(this,state),state.isValid&&this.__onConfirmManager.trigger(this,state)}}catch(ex){}}setLocalizations(texts){super.setLocalizations(texts),this.__popup?.setLocalizations({buttonTextOk:this.__localizations?.arrayEditorPrompt?.buttonTextOk??this.__localizations?.editorPrompt?.buttonTextOk,buttonTooltipOk:this.__localizations?.arrayEditorPrompt?.buttonTooltipOk??this.__localizations?.editorPrompt?.buttonTooltipOk,buttonTextCancel:this.__localizations?.arrayEditorPrompt?.buttonTextCancel??this.__localizations?.editorPrompt?.buttonTextCancel,buttonTooltipCancel:this.__localizations?.arrayEditorPrompt?.buttonTooltipCancel??this.__localizations?.editorPrompt?.buttonTooltipCancel,editorLocalizations:this.__localizations})}}TcHmi.Controls.Helpers??={},TcHmi.Controls.Helpers.ArrayEditor=ArrayEditor;
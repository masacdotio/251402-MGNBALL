import{HistorizedSymbolEditor}from"./CustomEditors/HistorizedSymbolEditor.js";import{HistorizedSymbolEditorPane}from"./CustomEditors/EditorPanes/HistorizedSymbolEditorPane.js";import*as SchemaParser from"./SchemaParser.js";import{BooleanEditor}from"./BaseEditors/BooleanEditor.js";import{NumberEditor}from"./BaseEditors/NumberEditor.js";import{StringEditor}from"./BaseEditors/StringEditor.js";import{TimeEditor}from"./BaseEditors/TimeEditor.js";import{EnumEditor}from"./BaseEditors/EnumEditor.js";import{ObjectEditor}from"./BaseEditors/ObjectEditor.js";import{ObjectEditorPane}from"./BaseEditors/EditorPanes/ObjectEditorPane.js";import{TupleEditor}from"./BaseEditors/TupleEditor.js";import{TupleEditorPane}from"./BaseEditors/EditorPanes/TupleEditorPane.js";import{ArrayEditor}from"./BaseEditors/ArrayEditor.js";import{ArrayEditorPane}from"./BaseEditors/EditorPanes/ArrayEditorPane.js";import{OptionalEditor}from"./BaseEditors/OptionalEditor.js";import{ChoiceEditor}from"./BaseEditors/ChoiceEditor.js";import{NullEditor}from"./BaseEditors/NullEditor.js";import{InvalidEditor}from"./BaseEditors/InvalidEditor.js";export class EditorFactory{static#tchmiFQN="TcHmi.Controls.Helpers."+this.name;__customEditors=[];__options;constructor(options){this.__options={...options,factorySettings:{preferPanes:"No",...options?.factorySettings}},this.registerEditor("historizedSymbol",{singleLine:HistorizedSymbolEditor,pane:HistorizedSymbolEditorPane})}fromSymbol(symbol,element){return new Promise((resolve,reject)=>{const onSchemaResolved=data=>{data.error===TcHmi.Errors.NONE&&data.schema?resolve(this.fromSchema(data.schema,element)):reject(new TcHmi.Exception(data.details??{code:data.error!==TcHmi.Errors.NONE?data.error:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,reason:`Could not resolve schema of symbol "${symbol instanceof TcHmi.Symbol?symbol.getExpression().toString():symbol.toString()}"`,domain:EditorFactory.#tchmiFQN}))};symbol instanceof TcHmi.Symbol?symbol.resolveSchema(onSchemaResolved):TcHmi.Symbol.resolveSchema(symbol.toString(),onSchemaResolved)})}fromType(type,element){const schema=TcHmi.Type.getSchema(type);if(!schema)throw new TcHmi.Exception(TcHmi.Errors.E_UNKNOWN_TYPE,`Could not resolve schema of type "${type}"`,EditorFactory.#tchmiFQN);return this.fromSchema(schema,element)}fromSchema(schema,element){return this.__options.nameGenerator?this.fromEditorInfo(SchemaParser.parse(schema,this.__options.nameGenerator),element):this.fromEditorInfo(SchemaParser.parse(schema),element)}fromEditorInfo(info,element,parent=null){let editor=null;const customEditor=this.__customEditors.find(entry=>entry.predicate(info.schema,info))?.editor;if(customEditor)try{editor=customEditor.pane&&("Always"===this.__options.factorySettings.preferPanes||"FirstLevel"===this.__options.factorySettings.preferPanes&&!parent)?new customEditor.pane(element,info,this):new customEditor.singleLine(element,info,this)}catch(error){TcHmi.Log.errorEx(`[Source=ControlHelpers, Module=${EditorFactory.#tchmiFQN}${this.__options.parentControl?`, Id=${this.__options.parentControl.getId()}`:""}] Failed to create custom editor for EditorInfo "${info.name}" of type "${info.type}". Falling back to basic editor.`,error)}if(!editor)switch(info.type){case"boolean":editor=new BooleanEditor(element,info,this);break;case"number":editor=new NumberEditor(element,info,this);break;case"string":editor=new StringEditor(element,info,this);break;case"time":editor=new TimeEditor(element,info,this);break;case"enum":editor=new EnumEditor(element,info,this);break;case"object":editor="Always"===this.__options.factorySettings.preferPanes||"FirstLevel"===this.__options.factorySettings.preferPanes&&!parent?new ObjectEditorPane(element,info,this):new ObjectEditor(element,info,this);break;case"array":editor="Always"===this.__options.factorySettings.preferPanes||"FirstLevel"===this.__options.factorySettings.preferPanes&&!parent?new ArrayEditorPane(element,info,this):new ArrayEditor(element,info,this);break;case"tuple":editor="Always"===this.__options.factorySettings.preferPanes||"FirstLevel"===this.__options.factorySettings.preferPanes&&!parent?new TupleEditorPane(element,info,this):new TupleEditor(element,info,this);break;case"optional":editor=new OptionalEditor(element,info,this);break;case"choice":editor=new ChoiceEditor(element,info,this);break;case"null":editor=new NullEditor(element,info,this);break;case"invalid":editor=new InvalidEditor(element,info,this)}return this.__options.texts?editor.setLocalizations(this.__options.texts):editor.setLocalizations({}),this.__options.editorSettings&&editor.setSettings(this.__options.editorSettings),void 0!==info.defaultValue&&editor.setValue(info.defaultValue),editor}registerEditor(predicateOrMetaType,editor){let predicate;switch(typeof predicateOrMetaType){case"function":predicate=predicateOrMetaType;break;case"string":predicate=(schema,_info)=>schema.frameworkMetaType===predicateOrMetaType;break;case"object":predicate=(schema,_info)=>void 0!==schema.frameworkMetaType&&predicateOrMetaType.includes(schema.frameworkMetaType)}return this.__customEditors.unshift({predicate,editor:"function"==typeof editor?{singleLine:editor}:editor}),this}get parentControl(){return this.__options.parentControl??null}set parentControl(control){this.__options.parentControl=control}get texts(){return this.__options.texts??null}set texts(texts){texts?this.__options.texts=texts:delete this.__options.texts}get editorSettings(){return this.__options.editorSettings??null}set editorSettings(settings){settings?this.__options.editorSettings=settings:delete this.__options.editorSettings}get factorySettings(){return this.__options.factorySettings}set factorySettings(settings){this.__options.factorySettings={preferPanes:"No",...settings}}get nameGenerator(){return this.__options.nameGenerator??null}set nameGenerator(nameGenerator){nameGenerator?this.__options.nameGenerator=nameGenerator:delete this.__options.nameGenerator}}TcHmi.Controls.Helpers??={},TcHmi.Controls.Helpers.EditorFactory=EditorFactory;
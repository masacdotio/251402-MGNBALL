var __runInitializers=this&&this.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0},__esDecorate=this&&this.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(void 0!==f&&"function"!=typeof f)throw new TypeError("Function expected");return f}for(var _,kind=contextIn.kind,key="getter"===kind?"get":"setter"===kind?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]="access"===p?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])("accessor"===kind?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if("accessor"===kind){if(void 0===result)continue;if(null===result||"object"!=typeof result)throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&("field"===kind?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0};import{Display}from"./Display.js";import{DirectoryBrowser}from"./DirectoryBrowser.js";let TreeBrowsingDisplay=(()=>{var _a,_b,_c,_d,_e,_f,_g;let ___onPointerDown_decorators,___onPointerUp_decorators,___onClick_decorators,___onPointerMove_decorators,___onScroll_decorators,___onContextMenu_decorators,___onToggle_decorators,_classSuper=Display,_instanceExtraInitializers=[];return class extends _classSuper{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;___onPointerDown_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___onPointerUp_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___onClick_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],___onPointerMove_decorators=[(_d=TcHmi).CallbackMethod.bind(_d)],___onScroll_decorators=[(_e=TcHmi).CallbackMethod.bind(_e)],___onContextMenu_decorators=[(_f=TcHmi).CallbackMethod.bind(_f)],___onToggle_decorators=[(_g=TcHmi).CallbackMethod.bind(_g)],__esDecorate(this,null,___onPointerDown_decorators,{kind:"method",name:"__onPointerDown",static:!1,private:!1,access:{has:obj=>"__onPointerDown"in obj,get:obj=>obj.__onPointerDown},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onPointerUp_decorators,{kind:"method",name:"__onPointerUp",static:!1,private:!1,access:{has:obj=>"__onPointerUp"in obj,get:obj=>obj.__onPointerUp},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onClick_decorators,{kind:"method",name:"__onClick",static:!1,private:!1,access:{has:obj=>"__onClick"in obj,get:obj=>obj.__onClick},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onPointerMove_decorators,{kind:"method",name:"__onPointerMove",static:!1,private:!1,access:{has:obj=>"__onPointerMove"in obj,get:obj=>obj.__onPointerMove},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onScroll_decorators,{kind:"method",name:"__onScroll",static:!1,private:!1,access:{has:obj=>"__onScroll"in obj,get:obj=>obj.__onScroll},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onContextMenu_decorators,{kind:"method",name:"__onContextMenu",static:!1,private:!1,access:{has:obj=>"__onContextMenu"in obj,get:obj=>obj.__onContextMenu},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onToggle_decorators,{kind:"method",name:"__onToggle",static:!1,private:!1,access:{has:obj=>"__onToggle"in obj,get:obj=>obj.__onToggle},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}__treeItems=(__runInitializers(this,_instanceExtraInitializers),new Map);__expandedItems=new Set;__lastPointerDown={type:"",timestamp:0,doubleClickOnNextUp:!1,ignoreNextUp:!1,target:null,timeoutID:0,coords:{x:0,y:0}};__pointerMultiselect=!1;__search=null;__sort=null;__defaultSort={sorting:[{name:"type",order:"Descending"},{name:"name",order:"Ascending"}],caseSensitive:!1};__eventDestroyers=[];constructor(element,parentControl){super(element,parentControl),element.classList.add("TcHmi_Controls_Helpers_DirectoryBrowser-tree-browsing-display")}__onPointerDown(event){clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.ignoreNextUp=!1,this.__lastPointerDown.coords.x=event.clientX,this.__lastPointerDown.coords.y=event.clientY;const eventInfo=this.__preprocessPointerEvent(event);if("Row"!==eventInfo.type)return this.__lastPointerDown.target=event.target,void(this.__lastPointerDown.doubleClickOnNextUp=!1);const now=Date.now();this.__lastPointerDown.type===event.pointerType&&this.__lastPointerDown.target===eventInfo.row&&now-this.__lastPointerDown.timestamp<=500&&(this.__lastPointerDown.doubleClickOnNextUp=!0),this.__lastPointerDown.type=event.pointerType,this.__lastPointerDown.timestamp=now,this.__lastPointerDown.target=eventInfo.row,this.__lastPointerDown.timeoutID=setTimeout(()=>{this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.doubleClickOnNextUp=!1,this.__lastPointerDown.ignoreNextUp=!0,this.__pointerMultiselect=!0,this.__select(eventInfo)},500)}__onPointerUp(event){if(clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.ignoreNextUp)return void(this.__lastPointerDown.ignoreNextUp=!1);if(this.__lastPointerDown.type!==event.pointerType)return;const eventInfo=this.__preprocessPointerEvent(event);switch(eventInfo.type){case"Clear":this.__lastPointerDown.target===event.target&&(this.__select(null),this.__pointerMultiselect=!1);case"Ignore":return this.__lastPointerDown.target=null,void(this.__lastPointerDown.doubleClickOnNextUp=!1)}this.__lastPointerDown.target===eventInfo.row&&(this.__lastPointerDown.doubleClickOnNextUp?(this.__navigate(eventInfo),this.__lastPointerDown.doubleClickOnNextUp=!1,this.__lastPointerDown.timestamp=0):this.__select(eventInfo))}__onClick(event){event.target instanceof HTMLElement&&event.target.classList.contains("group-lines")&&event.preventDefault()}__onPointerMove(event){if(0===this.__lastPointerDown.timeoutID)return;const deltaX=this.__lastPointerDown.coords.x-event.clientX,deltaY=this.__lastPointerDown.coords.y-event.clientY;deltaX*deltaX+deltaY*deltaY>225&&(clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0)}__onScroll(){clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0}__onContextMenu(event){this.__pointerMultiselect&&event.preventDefault()}__onToggle(event){if(!(event.target instanceof HTMLDetailsElement))return;const summary=event.target.querySelector("summary");if(!summary)return;const item=this.__treeItems.get(summary);item?.type===DirectoryBrowser.ItemType.Folder&&(event.target.open?this.__expandedItems.add(DirectoryBrowser.getPath(item).join("::")):this.__expandedItems.delete(DirectoryBrowser.getPath(item).join("::")))}__preprocessPointerEvent(event){if(!this.__directory)return{type:"Ignore"};if(!(event.target instanceof HTMLElement))return{type:"Ignore"};if("mouse"===event.pointerType&&0!==event.button)return{type:"Ignore"};if(!this.__parentControl.getIsEnabled()||!TcHmi.Access.checkAccess(this.__parentControl,"operate"))return{type:"Ignore"};if("SUMMARY"===event.target.tagName.toUpperCase()||event.target.classList.contains("expander"))return{type:"Ignore"};const row=event.target.closest("summary, div");if(!row)return{type:"Clear"};const item=this.__treeItems.get(row);return item?{type:"Row",row,item,multiselect:event.ctrlKey||this.__pointerMultiselect}:{type:"Clear"}}async __select(event){this.__directory&&(event?event.multiselect&&this.__directory.selectedItems.includes(event.item)?(await this.__directory.deselectItem(event.item),0===this.__directory.selectedItemNames.size&&(this.__pointerMultiselect=!1)):this.__directory.selectItem(event.item,event.multiselect):this.__directory.clearSelection())}__navigate(event){this.__directory&&this.__directory.setPathAndValidate(DirectoryBrowser.getPath(event.item))}suspend(clear=!1){if(!this.__suspended){super.suspend(clear);for(const destroyer of this.__eventDestroyers)destroyer();this.__eventDestroyers=[],clear&&(this.__element.innerHTML="",this.__treeItems.clear(),this.__expandedItems.clear())}}resume(){this.__suspended&&(super.resume(),this.__eventDestroyers.push(TcHmi.EventProvider.registerDomEvent(document,"pointerdown",this.__onPointerDown),TcHmi.EventProvider.registerDomEvent(document,"pointermove",this.__onPointerMove),TcHmi.EventProvider.registerDomEvent(document,"scroll",this.__onScroll),TcHmi.EventProvider.registerDomEvent(this.__element,"pointerup",this.__onPointerUp),TcHmi.EventProvider.registerDomEvent(this.__element,"click",this.__onClick,{passive:!1}),TcHmi.EventProvider.registerDomEvent(this.__element,"contextmenu",this.__onContextMenu,{passive:!1}),TcHmi.EventProvider.registerDomEvent(this.__element,"toggle",this.__onToggle,{capture:!0})),this.__processDirectory())}search(term,caseSensitive=!1){this.__search=term?{term:caseSensitive?term:term.toLowerCase(),caseSensitive}:null,this.__performSearch()}__performSearch(){if(this.__search){for(const[element,item]of this.__treeItems)element.classList.toggle("match",this.__search.caseSensitive?item.name.includes(this.__search.term):item.name.toLowerCase().includes(this.__search.term));this.__element.classList.add("filter")}else{this.__element.classList.remove("filter");for(const element of this.__element.querySelectorAll(".match"))element.classList.remove("match")}}sort(sorting,caseSensitive=!1){this.__sort=sorting?{sorting,caseSensitive}:null,this.__render()}expandAll(){for(const details of this.__element.querySelectorAll("details"))details.open=!0}collapseAll(){for(const details of this.__element.querySelectorAll("details"))details.open=!1}__processDirectory(){this.__render(),this.__directory&&this.__directoryEventDestroyers.push(this.__directory.onDirectoryUpdate.add(()=>this.__render()),this.__directory.onSelectionChange.add(selectedItems=>{for(const[element,item]of this.__treeItems)element.classList.toggle("selected",selectedItems.includes(item))}),this.__directory.onPathChange.add(currentItem=>{for(const[element,item]of this.__treeItems)element.classList.toggle("current",item===currentItem)}))}__render(){this.__element.innerHTML="",this.__treeItems.clear(),this.__directory&&this.__element.appendChild(this.__buildTree(this.__directory.root)),this.__performSearch()}__buildTree(directory,path=[]){const fragment=document.createDocumentFragment(),directoryItems=Array.from(directory.children.values()).sort(DirectoryBrowser.compare.bind(this,this.__sort??this.__defaultSort));for(const item of directoryItems){let row;if(item.type===DirectoryBrowser.ItemType.Folder){const details=fragment.appendChild(document.createElement("details"));row=details.appendChild(document.createElement("summary")),0!==item.children.size&&details.appendChild(this.__buildTree(item,[...path,item.name])),this.__expandedItems.has(DirectoryBrowser.getPath(item).join("::"))&&(details.open=!0)}else row=fragment.appendChild(document.createElement("div"));const groupLines=row.appendChild(document.createElement("span"));groupLines.className="group-lines";for(const _ of path)groupLines.appendChild(document.createElement("span"));row.appendChild(document.createElement("span")).className="expander";row.appendChild(document.createElement("label")).textContent=item.name,item===this.__directory?.currentItem&&row.classList.add("current"),this.__directory?.selectedItems.includes(item)&&row.classList.add("selected"),this.__treeItems.set(row,item)}return fragment}}})();export{TreeBrowsingDisplay};TcHmi.Controls.Helpers??={},TcHmi.Controls.Helpers.TreeBrowsingDisplay=TreeBrowsingDisplay;
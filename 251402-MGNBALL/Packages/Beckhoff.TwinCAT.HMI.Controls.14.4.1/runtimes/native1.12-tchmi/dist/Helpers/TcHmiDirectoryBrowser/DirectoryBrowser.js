var __runInitializers=this&&this.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0},__esDecorate=this&&this.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(void 0!==f&&"function"!=typeof f)throw new TypeError("Function expected");return f}for(var _,kind=contextIn.kind,key="getter"===kind?"get":"setter"===kind?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]="access"===p?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])("accessor"===kind?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if("accessor"===kind){if(void 0===result)continue;if(null===result||"object"!=typeof result)throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&("field"===kind?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0};import{Directory}from"./Directory.js";import{Callback}from"Beckhoff.TwinCAT.HMI.Framework/index.esm.js";let DirectoryBrowser=(()=>{var _a,_b,_c,_d,_e,_f;let ___onBeforePathChange_decorators,___onBeforeSelectionChange_decorators,___onSelectionChange_decorators,___onSelectedItemUpdate_decorators,___onPathChange_decorators,___onCurrentItemChange_decorators,_instanceExtraInitializers=[];return class DirectoryBrowser{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___onBeforePathChange_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___onBeforeSelectionChange_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___onSelectionChange_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],___onSelectedItemUpdate_decorators=[(_d=TcHmi).CallbackMethod.bind(_d)],___onPathChange_decorators=[(_e=TcHmi).CallbackMethod.bind(_e)],___onCurrentItemChange_decorators=[(_f=TcHmi).CallbackMethod.bind(_f)],__esDecorate(this,null,___onBeforePathChange_decorators,{kind:"method",name:"__onBeforePathChange",static:!1,private:!1,access:{has:obj=>"__onBeforePathChange"in obj,get:obj=>obj.__onBeforePathChange},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onBeforeSelectionChange_decorators,{kind:"method",name:"__onBeforeSelectionChange",static:!1,private:!1,access:{has:obj=>"__onBeforeSelectionChange"in obj,get:obj=>obj.__onBeforeSelectionChange},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onSelectionChange_decorators,{kind:"method",name:"__onSelectionChange",static:!1,private:!1,access:{has:obj=>"__onSelectionChange"in obj,get:obj=>obj.__onSelectionChange},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onSelectedItemUpdate_decorators,{kind:"method",name:"__onSelectedItemUpdate",static:!1,private:!1,access:{has:obj=>"__onSelectedItemUpdate"in obj,get:obj=>obj.__onSelectedItemUpdate},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onPathChange_decorators,{kind:"method",name:"__onPathChange",static:!1,private:!1,access:{has:obj=>"__onPathChange"in obj,get:obj=>obj.__onPathChange},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onCurrentItemChange_decorators,{kind:"method",name:"__onCurrentItemChange",static:!1,private:!1,access:{has:obj=>"__onCurrentItemChange"in obj,get:obj=>obj.__onCurrentItemChange},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}__displays=__runInitializers(this,_instanceExtraInitializers);__directory=null;__suspended=!0;__autoSuspended=!1;__directoryUpdatesSuspension={suspended:!1,cachedUpdate:void 0};__fakeFile=null;__pathToSet=null;__itemsToSelect=[];__navigationToFilesAllowedCache=!0;__multiSelectAllowedCache=!1;__onBeforePathChangeManager=new Callback.AsyncCollection;onBeforePathChange=this.__onBeforePathChangeManager.getManipulators();__onBeforeSelectionChangeManager=new Callback.AsyncCollection;onBeforeSelectionChange=this.__onBeforeSelectionChangeManager.getManipulators();__onSelectionChangeManager=new Callback.Collection;onSelectionChange=this.__onSelectionChangeManager.getManipulators();__onSelectedItemUpdateManager=new Callback.Collection;onSelectedItemUpdate=this.__onSelectedItemUpdateManager.getManipulators();__onPathChangeManager=new Callback.Collection;onPathChange=this.__onPathChangeManager.getManipulators();__onCurrentItemUpdateManager=new Callback.Collection;onCurrentItemUpdate=this.__onCurrentItemUpdateManager.getManipulators();__parentControl;__destroyOnParentDestroy=[];hasData;__resolveHasData;constructor(displaysOrParentControl,parentControl){this.__displays=new Set(displaysOrParentControl&&window.Symbol.iterator in displaysOrParentControl?displaysOrParentControl:null),this.__parentControl=displaysOrParentControl instanceof TcHmi.Controls.System.TcHmiControl?displaysOrParentControl:parentControl,this.__parentControl&&this.__destroyOnParentDestroy.push(TcHmi.EventProvider.register(this.__parentControl.getId()+".onDetached",()=>{this.__suspended||(this.suspend(),this.__autoSuspended=!0)}),TcHmi.EventProvider.register(this.__parentControl.getId()+".onAttached",()=>{this.__autoSuspended&&(this.resume(),this.__autoSuspended=!1)}),TcHmi.EventProvider.register(this.__parentControl.getId()+".onDestroyed",()=>{this.suspend();for(let destroyer of this.__destroyOnParentDestroy)destroyer();this.__destroyOnParentDestroy=[]})),this.hasData=new Promise(resolve=>{this.__resolveHasData=resolve})}addDisplay(display){this.__displays.add(display),display.setDirectory(this.__directory)}removeDisplay(display){this.__displays.delete(display)&&display.suspend(!0)}suspend(clear=!1){if(this.__suspended)return;const path=this.getPath(),selectedItems=this.getSelectedItems();for(const display of this.__displays)display.suspend(clear);if(this.__directory=null,this.__suspended=!0,path&&this.setPath(path),selectedItems){for(const itemToSelect of this.__itemsToSelect)itemToSelect.callback?.(!1);this.__itemsToSelect=selectedItems.map(item=>({pathOrName:DirectoryBrowser.getPath(item)}))}this.hasData=new Promise(resolve=>{this.__resolveHasData=resolve})}resume(){if(this.__suspended){this.__suspended=!1;for(const display of this.__displays)display.resume()}}suspendDirectoryUpdates(){this.__directoryUpdatesSuspension.suspended||(this.__directoryUpdatesSuspension.suspended=!0)}resumeDirectoryUpdates(){this.__directoryUpdatesSuspension.suspended&&(this.__directoryUpdatesSuspension.suspended=!1,void 0!==this.__directoryUpdatesSuspension.cachedUpdate&&(this.__updateDirectory(this.__directoryUpdatesSuspension.cachedUpdate),this.__directoryUpdatesSuspension.cachedUpdate=void 0))}getCurrentItem(){return this.__directory?this.__directory.currentItem:null}getCurrentFolder(){return this.__directory?this.__directory.currentFolder:null}getPath(){return this.__directory?tchmi_clone_object(this.__directory.path):null}getFolderPath(){return this.__directory?this.__directory.currentItem.type===DirectoryBrowser.ItemType.Folder?tchmi_clone_object(this.__directory.path):this.__directory.path.slice(0,-1):null}getSelectedItems(){return this.__directory?this.__directory.selectedItems:null}setPath(value){return this.__pathToSet&&(this.__pathToSet=null),this.__directory?this.__directory.setPathAndValidate(tchmi_clone_object(value)):new Promise(resolve=>{this.__pathToSet={path:tchmi_clone_object(value),callback:resolve}})}selectItem(pathOrName,expandSelection){if(!expandSelection){for(const itemToSelect of this.__itemsToSelect)itemToSelect.callback?.(!1);this.__itemsToSelect=[]}if(!this.__directory)return new Promise(resolve=>{this.__itemsToSelect.push({pathOrName,callback:resolve})});if("string"==typeof pathOrName)return this.__directory.selectItem(pathOrName,expandSelection);{const item=DirectoryBrowser.getItem(this.__directory.root,pathOrName);return!(!item||item.type===DirectoryBrowser.ItemType.Root)&&this.__directory.selectItem(item,expandSelection)}}deselectItem(pathOrName){if(this.__directory){if("string"==typeof pathOrName)return this.__directory.deselectItem(pathOrName);{const item=DirectoryBrowser.getItem(this.__directory.root,pathOrName);return!(!item||item.type===DirectoryBrowser.ItemType.Root)&&this.__directory.deselectItem(item)}}const index=this.__itemsToSelect.findIndex(itemToSelect=>{if(itemToSelect.pathOrName===pathOrName)return!0;if("string"==typeof itemToSelect.pathOrName&&"object"==typeof pathOrName){const path=[...pathOrName],name=path.pop();if(tchmi_equal(this.__pathToSet?.path??[],path)&&itemToSelect.pathOrName===name)return!0}else if("object"==typeof itemToSelect.pathOrName&&"string"==typeof pathOrName){const path=[...itemToSelect.pathOrName],name=path.pop();if(tchmi_equal(this.__pathToSet?.path??[],path)&&pathOrName===name)return!0}return!1});return-1!==index?(this.__itemsToSelect[index].callback?.(!1),this.__itemsToSelect.splice(index,1),Promise.resolve(!0)):Promise.resolve(!1)}clearSelection(){if(this.__directory)return this.__directory.clearSelection();for(const item of this.__itemsToSelect)item.callback?.(!1);return this.__itemsToSelect=[],Promise.resolve(!0)}fakeFile(path,payload,metadata){this.__fakeFile&&tchmi_equal(this.__fakeFile.path,path)&&tchmi_equal(this.__fakeFile.payload,payload)&&tchmi_equal(this.__fakeFile.metadata,metadata)||(this.__fakeFile={path,payload,metadata,remove:()=>this.__directory?.root??null},this.__updateDirectory(this.__directory?.root??null))}clearFakedFile(){if(!this.__fakeFile)return;const unfaked=this.__fakeFile.remove();this.__fakeFile=null,this.__updateDirectory(unfaked)}hasFakedFile(){return null!==this.__fakeFile}setNavigationToFilesAllowed(value){this.__directory&&(this.__directory.navigationToFilesAllowed=value),this.__navigationToFilesAllowedCache=value}getNavigationToFilesAllowed(){return this.__directory?.navigationToFilesAllowed??this.__navigationToFilesAllowedCache}setMultiSelectAllowed(value){this.__directory&&(this.__directory.multiSelectAllowed=value),this.__multiSelectAllowedCache=value}getMultiSelectAllowed(){return this.__directory?.multiSelectAllowed??this.__multiSelectAllowedCache}async __onBeforePathChange(newCurrentItem,path,cancelable){if(!this.__directory)return!1;return!(await this.__onBeforePathChangeManager.trigger(newCurrentItem,tchmi_clone_object(path),cancelable)).some(result=>"fulfilled"===result.status&&!result.value)}async __onBeforeSelectionChange(newSelectedItems,cancelable){if(!this.__directory)return!1;return!(await this.__onBeforeSelectionChangeManager.trigger(newSelectedItems,cancelable)).some(result=>"fulfilled"===result.status&&!result.value)}__onSelectionChange(newSelectedItems){this.__directory&&this.__onSelectionChangeManager.trigger(newSelectedItems)}__onSelectedItemUpdate(selectedItem){this.__directory&&this.__onSelectedItemUpdateManager.trigger(selectedItem)}__onPathChange(currentItem,path){this.__directory&&this.__onPathChangeManager.trigger(currentItem,tchmi_clone_object(path))}__onCurrentItemChange(currentItem){this.__directory&&this.__onCurrentItemUpdateManager.trigger(currentItem)}setDirectory(rootFolder,getChildren,isFile,getMetadata){const directory=null===rootFolder?null:this.buildDirectoryTree(rootFolder,getChildren,isFile,getMetadata);return this.__updateDirectory(directory)}async __updateDirectory(directory){if(this.__directoryUpdatesSuspension.suspended)this.__directoryUpdatesSuspension.cachedUpdate=directory;else{if(this.__fakeFile&&this.__fakeFile.path.length>0){let removeFunction=null;directory||(directory={type:DirectoryBrowser.ItemType.Root,payload:void 0,children:new Map},removeFunction=()=>null);let current=directory,abort=!1;for(const name of this.__fakeFile.path.slice(0,-1)){let next=current.children.get(name);if(next||(next={type:DirectoryBrowser.ItemType.Folder,name,payload:void 0,parent:current,children:new Map},current.children.set(name,next),removeFunction||(removeFunction=()=>(next.parent.children.delete(name),directory))),next.type===DirectoryBrowser.ItemType.File){abort=!0;break}current=next}const filename=this.__fakeFile.path[this.__fakeFile.path.length-1];abort||current.children.has(filename)||(current.children.set(filename,{type:DirectoryBrowser.ItemType.File,name:filename,parent:current,payload:this.__fakeFile.payload,metadata:this.__fakeFile.metadata}),removeFunction||(removeFunction=()=>(current.children.delete(filename),directory)),this.__fakeFile.remove=removeFunction)}if(directory)if(this.__directory)await this.__directory.setRootAndValidate(directory),this.__resolveHasData();else{this.__directory=new Directory(directory),this.__directory.navigationToFilesAllowed=this.__navigationToFilesAllowedCache,this.__directory.multiSelectAllowed=this.__multiSelectAllowedCache;for(const display of this.__displays)display.setDirectory(this.__directory);this.__directory.onBeforePathChange.add(this.__onBeforePathChange),this.__directory.onBeforeSelectionChange.add(this.__onBeforeSelectionChange),this.__directory.onSelectionChange.add(this.__onSelectionChange),this.__directory.onSelectedItemUpdate.add(this.__onSelectedItemUpdate),this.__directory.onPathChange.add(this.__onPathChange),this.__directory.onCurrentItemUpdate.add(this.__onCurrentItemChange);const promises=[];if(this.__pathToSet){const promise=this.__directory.setPathAndValidate(this.__pathToSet.path);this.__pathToSet.callback(promise),this.__pathToSet=null,promises.push(promise)}for(const itemToSelect of this.__itemsToSelect)if("string"==typeof itemToSelect.pathOrName){const response=this.__directory.selectItem(itemToSelect.pathOrName,!0);itemToSelect.callback?.(response),promises.push(response)}else{const item=DirectoryBrowser.getItem(directory,itemToSelect.pathOrName),response=!(!item||item.type===DirectoryBrowser.ItemType.Root)&&this.__directory.selectItem(item,!0);itemToSelect.callback?.(response),!1!==response&&promises.push(response)}this.__itemsToSelect=[],Promise.allSettled(promises).then(()=>this.__resolveHasData())}else if(this.__directory){await this.__onBeforePathChangeManager.trigger(null,null,!1),await this.__onBeforeSelectionChangeManager.trigger(null,!1),this.__directory&&(this.__directory.onBeforePathChange.remove(this.__onBeforePathChange),this.__directory.onBeforeSelectionChange.remove(this.__onBeforeSelectionChange),this.__directory.onSelectionChange.remove(this.__onSelectionChange),this.__directory.onSelectedItemUpdate.remove(this.__onSelectedItemUpdate),this.__directory.onPathChange.remove(this.__onPathChange),this.__directory.onCurrentItemUpdate.remove(this.__onCurrentItemChange),this.__directory=null),this.__onSelectionChangeManager.trigger(null),this.__onPathChangeManager.trigger(null,null);for(const display of this.__displays)display.setDirectory(null);this.hasData=new Promise(resolve=>{this.__resolveHasData=resolve})}}}buildDirectoryTree(rootFolder,getChildren,isFile,getMetadata){const buildTree=root=>{for(const[name,childPayload]of getChildren(root.payload))if(isFile(childPayload)){const child={type:DirectoryBrowser.ItemType.File,name,payload:childPayload,parent:root};getMetadata&&(child.metadata=getMetadata(childPayload)),root.children.set(name,child)}else{const child={type:DirectoryBrowser.ItemType.Folder,name,payload:childPayload,parent:root,children:new Map};getMetadata&&(child.metadata=getMetadata(childPayload)),buildTree(child),root.children.set(name,child)}},root={type:DirectoryBrowser.ItemType.Root,payload:rootFolder,children:new Map};return buildTree(root),root}static Directory=Directory}})();export{DirectoryBrowser};!function(DirectoryBrowser){let ItemType;!function(ItemType){ItemType[ItemType.File=0]="File",ItemType[ItemType.Folder=1]="Folder",ItemType[ItemType.Root=2]="Root"}(ItemType=DirectoryBrowser.ItemType||(DirectoryBrowser.ItemType={})),DirectoryBrowser.compare=function(sort,a,b){for(const criterion of sort.sorting){const order="Descending"===criterion.order?-1:1;if(!criterion.name){if(a.type!==b.type)return(a.type===ItemType.File?1:-1)*order;const aName=sort.caseSensitive?a.name:a.name.toLowerCase(),bName=sort.caseSensitive?b.name:b.name.toLowerCase();if(aName!==bName)return(aName<bName?-1:1)*order;continue}const path=new TcHmi.ObjectPath(criterion.name);let aValue=path.readFrom(a),bValue=path.readFrom(b);if(null==aValue){if(null==bValue)continue;return-1*order}if(null==bValue){if(null==aValue)continue;return 1*order}aValue instanceof Date&&bValue instanceof Date&&(aValue=aValue.getTime(),bValue=bValue.getTime());const aType=typeof aValue,bType=typeof bValue;if(aType!==bType)switch(aType){case"boolean":switch(bType){case"number":case"bigint":aValue=aValue?1:0;break;case"string":aValue=aValue.toString();break;default:continue}break;case"number":case"bigint":switch(bType){case"boolean":bValue=bValue?1:0;break;case"number":case"bigint":break;case"string":aValue=aValue.toString();break;default:continue}break;case"string":switch(bType){case"boolean":case"number":case"bigint":bValue=bValue.toString();break;default:continue}break;default:continue}if(sort.caseSensitive||"string"!=typeof aValue||"string"!=typeof bValue||(aValue=aValue.toLowerCase(),bValue=bValue.toLowerCase()),aValue!==bValue)return(aValue<bValue?-1:1)*order}return 0},DirectoryBrowser.getPath=function(item){const path=[];for(;item.type!==ItemType.Root;)path.unshift(item.name),item=item.parent;return path},DirectoryBrowser.getItem=function(root,path){let current=root;for(const token of path){if(current.type===ItemType.File)return null;const next=current.children.get(token);if(!next)return null;current=next}return current}}(DirectoryBrowser||(DirectoryBrowser={})),TcHmi.Controls.Helpers??={},TcHmi.Controls.Helpers.DirectoryBrowser=DirectoryBrowser;
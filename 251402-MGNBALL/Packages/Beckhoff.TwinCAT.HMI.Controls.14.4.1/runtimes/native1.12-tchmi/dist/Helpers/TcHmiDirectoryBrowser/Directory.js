import{DirectoryBrowser}from"./DirectoryBrowser.js";import{Callback}from"Beckhoff.TwinCAT.HMI.Framework/index.esm.js";export class Directory{__root;__path=[];__currentItem;__selectedItems=[];__navigationToFilesAllowed=!0;__multiSelectAllowed=!1;__onBeforePathChangeManager=new Callback.AsyncCollection;onBeforePathChange=this.__onBeforePathChangeManager.getManipulators();__onBeforeSelectionChangeManager=new Callback.AsyncCollection;onBeforeSelectionChange=this.__onBeforeSelectionChangeManager.getManipulators();__onSelectionChangeManager=new Callback.Collection;onSelectionChange=this.__onSelectionChangeManager.getManipulators();__onSelectedItemUpdateManager=new Callback.Collection;onSelectedItemUpdate=this.__onSelectedItemUpdateManager.getManipulators();__onPathChangeManager=new Callback.Collection;onPathChange=this.__onPathChangeManager.getManipulators();__onCurrentItemUpdateManager=new Callback.Collection;onCurrentItemUpdate=this.__onCurrentItemUpdateManager.getManipulators();__onDirectoryUpdateManager=new Callback.Collection;onDirectoryUpdate=this.__onDirectoryUpdateManager.getManipulators();constructor(__root){this.__root=__root,this.__currentItem=__root}get root(){return this.__root}async setRootAndValidate(value){const validationResult=this.__validatePath(value,this.__path),selectedItems=[];if(validationResult.isValid)for(const selectedItem of this.__selectedItems){const path=DirectoryBrowser.getPath(selectedItem);let newSelectedItem=value;for(const name of path){if(!newSelectedItem||newSelectedItem.type===DirectoryBrowser.ItemType.File)break;newSelectedItem=newSelectedItem.children.get(name)}newSelectedItem&&newSelectedItem.type!==DirectoryBrowser.ItemType.Root&&selectedItems.push({old:selectedItem,new:newSelectedItem})}else await this.__onBeforePathChangeManager.trigger(validationResult.currentItem,tchmi_clone_object(validationResult.newPath),!1);if(selectedItems.length!==this.__selectedItems.length){const oldSelectedItems=selectedItems.map(entry=>entry.old);await this.__onBeforeSelectionChangeManager.trigger(oldSelectedItems,!1),this.__selectedItems=selectedItems.map(entry=>entry.new),this.__onSelectionChangeManager.trigger(this.__selectedItems)}const oldCurrentItem=this.currentItem;this.__root=value,this.__currentItem=validationResult.currentItem;for(const item of selectedItems)this.__itemsEquivalent(item.old,item.new)||this.__onSelectedItemUpdateManager.trigger(item.new);return validationResult.isValid?(this.__itemsEquivalent(oldCurrentItem,this.currentItem)||this.__onCurrentItemUpdateManager.trigger(this.__currentItem),this.__onDirectoryUpdateManager.trigger(this.__root),!0):(this.__path=validationResult.newPath,this.__onPathChangeManager.trigger(this.__currentItem,this.__path),this.__onDirectoryUpdateManager.trigger(this.__root),!1)}get path(){return this.__path}get decoratedPath(){const path=[];let current=this.__currentItem;for(;current.type!==DirectoryBrowser.ItemType.Root;)path.unshift(current),current=current.parent;return path.unshift(current),path}async setPathAndValidate(value,cancelable=!0){if(tchmi_equal(value,this.__path))return!0;const validationResult=this.__validatePath(this.__root,value);if(!validationResult.isValid)return!1;const results=await this.__onBeforePathChangeManager.trigger(validationResult.currentItem,tchmi_clone_object(value),cancelable);if(cancelable&&results.some(result=>"fulfilled"===result.status&&!result.value))return!1;const clearSelectionResult=await this.clearSelection(cancelable);return!(cancelable&&!clearSelectionResult)&&(this.__path=value,this.__currentItem=validationResult.currentItem,this.__onPathChangeManager.trigger(this.__currentItem,tchmi_clone_object(this.__path)),!0)}async pushPath(name,cancelable=!0){if(this.__currentItem.type===DirectoryBrowser.ItemType.File)return!1;const newCurrentItem=this.__currentItem.children.get(name);if(!newCurrentItem||newCurrentItem.type===DirectoryBrowser.ItemType.File&&!this.__navigationToFilesAllowed)return!1;const results=await this.__onBeforePathChangeManager.trigger(newCurrentItem,this.__path.concat(name),cancelable);if(cancelable&&results.some(result=>"fulfilled"===result.status&&!result.value))return!1;const clearSelectionResult=await this.clearSelection(cancelable);return!(cancelable&&!clearSelectionResult)&&(this.__path.push(name),this.__currentItem=newCurrentItem,this.__onPathChangeManager.trigger(this.__currentItem,tchmi_clone_object(this.__path)),!0)}async popPath(cancelable=!0){if(this.__currentItem.type===DirectoryBrowser.ItemType.Root)return null;const results=await this.__onBeforePathChangeManager.trigger(this.__currentItem.parent,this.__path.slice(0,-1),cancelable);if(cancelable&&results.some(result=>"fulfilled"===result.status&&!result.value))return null;const clearSelectionResult=await this.clearSelection(cancelable);if(cancelable&&!clearSelectionResult)return!1;const popped=this.__path.pop();return this.__currentItem=this.__currentItem.parent,this.__onPathChangeManager.trigger(this.__currentItem,tchmi_clone_object(this.__path)),popped??null}get currentItem(){return this.__currentItem}get currentFolder(){return this.__currentItem.type===DirectoryBrowser.ItemType.File?this.__currentItem.parent:this.__currentItem}get selectedItemNames(){return new Set(this.__selectedItems.filter(item=>item.parent===this.__currentItem).map(item=>item.name))}get selectedItems(){return[...this.__selectedItems]}async selectItem(itemOrName,expandSelection,cancelable=!0){const selectedItem="object"==typeof itemOrName?itemOrName:this.__currentItem.type!==DirectoryBrowser.ItemType.File?this.__currentItem.children.get(itemOrName):void 0;if(!selectedItem)return!1;if(this.selectedItems.includes(selectedItem)&&(expandSelection||1===this.__selectedItems.length))return!0;const selectedItems=(expandSelection=expandSelection&&this.__multiSelectAllowed)?this.selectedItems:[];selectedItems.push(selectedItem);const results=await this.__onBeforeSelectionChangeManager.trigger(selectedItems,cancelable);return(!cancelable||!results.some(result=>"fulfilled"===result.status&&!result.value))&&(this.__selectedItems=selectedItems,this.__onSelectionChangeManager.trigger(selectedItems),!0)}async deselectItem(itemOrName,cancelable=!0){const selectedItem="object"==typeof itemOrName?itemOrName:this.__currentItem.type!==DirectoryBrowser.ItemType.File?this.__currentItem.children.get(itemOrName):void 0;if(!selectedItem||!this.__selectedItems.includes(selectedItem))return!0;const selectedItems=this.__selectedItems.filter(item=>item!==selectedItem),results=await this.__onBeforeSelectionChangeManager.trigger(selectedItems,cancelable);return(!cancelable||!results.some(result=>"fulfilled"===result.status&&!result.value))&&(this.__selectedItems=selectedItems,this.__onSelectionChangeManager.trigger(selectedItems),!0)}async clearSelection(cancelable=!0){if(0===this.__selectedItems.length)return!0;const results=await this.__onBeforeSelectionChangeManager.trigger([],cancelable);return(!cancelable||!results.some(result=>"fulfilled"===result.status&&!result.value))&&(this.__selectedItems=[],this.__onSelectionChangeManager.trigger([]),!0)}set navigationToFilesAllowed(value){this.__navigationToFilesAllowed=value,this.__navigationToFilesAllowed||this.currentItem.type!==DirectoryBrowser.ItemType.File||this.popPath(!1)}get navigationToFilesAllowed(){return this.__navigationToFilesAllowed}set multiSelectAllowed(value){this.__multiSelectAllowed=value,!this.__multiSelectAllowed&&this.selectedItemNames.size>1&&this.clearSelection()}get multiSelectAllowed(){return this.__navigationToFilesAllowed}__validatePath(root,path){let current=root,valid=!0,index=0;for(;index<path.length;index++){if(current.type===DirectoryBrowser.ItemType.File){valid=!1;break}const name=path[index],next=current.children.get(name);if(!next||next.type===DirectoryBrowser.ItemType.File&&!this.__navigationToFilesAllowed){valid=!1;break}current=next}if(!valid){return{isValid:!1,newPath:path.slice(0,index),currentItem:current}}return{isValid:!0,currentItem:current}}__itemsEquivalent(a,b){if(a.type!==b.type)return!1;if(a.type!==DirectoryBrowser.ItemType.Root&&b.type!==DirectoryBrowser.ItemType.Root&&a.name!==b.name)return!1;if(a.type!==DirectoryBrowser.ItemType.File&&b.type!==DirectoryBrowser.ItemType.File){if(a.children.size!==b.children.size)return!1;const aIterator=a.children.entries(),bIterator=b.children.entries();let aStep=aIterator.next(),bStep=bIterator.next();for(;!aStep.done&&!bStep.done;){if(aStep.value[0]!==bStep.value[0])return!1;if(!this.__itemsEquivalent(aStep.value[1],bStep.value[1]))return!1;aStep=aIterator.next(),bStep=bIterator.next()}}else if(a.payload===b.payload||!tchmi_equal(a.payload,b.payload))return!1;return!(a.metadata===b.metadata||!tchmi_equal(a.metadata,b.metadata))}}
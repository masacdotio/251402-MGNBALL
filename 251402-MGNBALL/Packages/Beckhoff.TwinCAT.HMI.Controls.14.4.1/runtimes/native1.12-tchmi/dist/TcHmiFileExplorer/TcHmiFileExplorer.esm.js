var __runInitializers=this&&this.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0},__esDecorate=this&&this.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(void 0!==f&&"function"!=typeof f)throw new TypeError("Function expected");return f}for(var _,kind=contextIn.kind,key="getter"===kind?"get":"setter"===kind?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]="access"===p?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])("accessor"===kind?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if("accessor"===kind){if(void 0===result)continue;if(null===result||"object"!=typeof result)throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&("field"===kind?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0};import{TcHmiControl}from"Beckhoff.TwinCAT.HMI.Framework/index.esm.js";import{DirectoryBrowser}from"../Helpers/TcHmiDirectoryBrowser/DirectoryBrowser.js";import{ListBrowsingDisplay}from"../Helpers/TcHmiDirectoryBrowser/ListBrowsingDisplay.js";import{PathDisplay}from"../Helpers/TcHmiDirectoryBrowser/PathDisplay.js";import{Path}from"./Path.js";import{SortConfigurator}from"./SortConfigurator.js";import{FileConflictPrompt}from"./FileConflictPrompt.js";import{InputPrompt}from"../Helpers/TcHmiPopups/InputPrompt.js";import{TextAndButtonsPrompt}from"../Helpers/TcHmiPopups/TextAndButtonsPrompt.js";export var UploadStatus;!function(UploadStatus){UploadStatus[UploadStatus.Pending=0]="Pending",UploadStatus[UploadStatus.InProgress=1]="InProgress",UploadStatus[UploadStatus.Error=2]="Error"}(UploadStatus||(UploadStatus={}));export var SymbolAccess;!function(SymbolAccess){SymbolAccess[SymbolAccess.None=0]="None",SymbolAccess[SymbolAccess.Read=1]="Read",SymbolAccess[SymbolAccess.Write=2]="Write",SymbolAccess[SymbolAccess.ReadWrite=3]="ReadWrite"}(SymbolAccess||(SymbolAccess={}));let TcHmiFileExplorer=(()=>{var _a;let ___onPathChanged_decorators,___onSelectionChanged_decorators,___onCreateFolderPressed_decorators,___onDownloadPressed_decorators,___onUploadPressed_decorators,___onRenamePressed_decorators,___onCopyPressed_decorators,___onCutPressed_decorators,___onPastePressed_decorators,___onDeletePressed_decorators,___onSearchChanged_decorators,___onClearSearchClick_decorators,___onResolverForSortingWatchCallback_decorators,_classSuper=TcHmiControl.Control,_instanceExtraInitializers=[];return class TcHmiFileExplorer extends _classSuper{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;___onPathChanged_decorators=[TcHmi.EventHandler()],___onSelectionChanged_decorators=[TcHmi.EventHandler()],___onCreateFolderPressed_decorators=[TcHmi.EventHandler()],___onDownloadPressed_decorators=[TcHmi.EventHandler()],___onUploadPressed_decorators=[TcHmi.EventHandler()],___onRenamePressed_decorators=[TcHmi.EventHandler()],___onCopyPressed_decorators=[TcHmi.EventHandler()],___onCutPressed_decorators=[TcHmi.EventHandler()],___onPastePressed_decorators=[TcHmi.EventHandler()],___onDeletePressed_decorators=[TcHmi.EventHandler()],___onSearchChanged_decorators=[TcHmi.EventHandler()],___onClearSearchClick_decorators=[TcHmi.EventHandler({checkIsEnabled:!0,checkAccess:"operate"})],___onResolverForSortingWatchCallback_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],__esDecorate(this,null,___onPathChanged_decorators,{kind:"method",name:"__onPathChanged",static:!1,private:!1,access:{has:obj=>"__onPathChanged"in obj,get:obj=>obj.__onPathChanged},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onSelectionChanged_decorators,{kind:"method",name:"__onSelectionChanged",static:!1,private:!1,access:{has:obj=>"__onSelectionChanged"in obj,get:obj=>obj.__onSelectionChanged},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onCreateFolderPressed_decorators,{kind:"method",name:"__onCreateFolderPressed",static:!1,private:!1,access:{has:obj=>"__onCreateFolderPressed"in obj,get:obj=>obj.__onCreateFolderPressed},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onDownloadPressed_decorators,{kind:"method",name:"__onDownloadPressed",static:!1,private:!1,access:{has:obj=>"__onDownloadPressed"in obj,get:obj=>obj.__onDownloadPressed},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onUploadPressed_decorators,{kind:"method",name:"__onUploadPressed",static:!1,private:!1,access:{has:obj=>"__onUploadPressed"in obj,get:obj=>obj.__onUploadPressed},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onRenamePressed_decorators,{kind:"method",name:"__onRenamePressed",static:!1,private:!1,access:{has:obj=>"__onRenamePressed"in obj,get:obj=>obj.__onRenamePressed},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onCopyPressed_decorators,{kind:"method",name:"__onCopyPressed",static:!1,private:!1,access:{has:obj=>"__onCopyPressed"in obj,get:obj=>obj.__onCopyPressed},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onCutPressed_decorators,{kind:"method",name:"__onCutPressed",static:!1,private:!1,access:{has:obj=>"__onCutPressed"in obj,get:obj=>obj.__onCutPressed},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onPastePressed_decorators,{kind:"method",name:"__onPastePressed",static:!1,private:!1,access:{has:obj=>"__onPastePressed"in obj,get:obj=>obj.__onPastePressed},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onDeletePressed_decorators,{kind:"method",name:"__onDeletePressed",static:!1,private:!1,access:{has:obj=>"__onDeletePressed"in obj,get:obj=>obj.__onDeletePressed},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onSearchChanged_decorators,{kind:"method",name:"__onSearchChanged",static:!1,private:!1,access:{has:obj=>"__onSearchChanged"in obj,get:obj=>obj.__onSearchChanged},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onClearSearchClick_decorators,{kind:"method",name:"__onClearSearchClick",static:!1,private:!1,access:{has:obj=>"__onClearSearchClick"in obj,get:obj=>obj.__onClearSearchClick},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onResolverForSortingWatchCallback_decorators,{kind:"method",name:"__onResolverForSortingWatchCallback",static:!1,private:!1,access:{has:obj=>"__onResolverForSortingWatchCallback"in obj,get:obj=>obj.__onResolverForSortingWatchCallback},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}static#tchmiFQN="TcHmi.Controls.Beckhoff."+this.name;constructor(element,pcElement,attrs){super(element,pcElement,attrs)}__elementTemplateRoot=__runInitializers(this,_instanceExtraInitializers);__elementDirectoryTree;__elementPathBox;__elementBrowsingBox;__elementMenuBar;__buttons;__elementSorting;__inputSearch;__elementClearSearch;__localizationReader=void 0;__directoryBrowser;__listBrowsingDisplay;__directory={fileFlags:["Directory"],children:new Map};__clipboard=null;__subscriptionId=null;__symbolAccessSubscriptionId=null;__symbolAccess={Upload:SymbolAccess.None,Rename:SymbolAccess.None,Copy:SymbolAccess.None,Delete:SymbolAccess.None,"TcHmiSrv.Config":SymbolAccess.None};__fileUploader=null;__filesBeingUploaded=new Map;__namePrompt=null;__confirmationPrompt=null;__errorPrompt=null;__errorPromptPromise=Promise.resolve();__root;__path;__serverInterval;__showNavigationPane=!1;__navigationPanePosition="Left";__menuBarPosition;__menuBarHeight;__storage;__sortConfigurator;__previnit(){super.__previnit();const elementTemplateRoot=this.__element[0].querySelector(".TcHmi_Controls_Beckhoff_TcHmiFileExplorer-template"),elementDirectoryTree=elementTemplateRoot?.querySelector(".TcHmi_Controls_Beckhoff_TcHmiFileExplorer-directory-tree"),elementPathBox=elementTemplateRoot?.querySelector(".TcHmi_Controls_Beckhoff_TcHmiFileExplorer-path-box"),elementBrowsingBox=elementTemplateRoot?.querySelector(".TcHmi_Controls_Beckhoff_TcHmiFileExplorer-browsing-box"),elementMenuBar=elementTemplateRoot?.querySelector(".TcHmi_Controls_Beckhoff_TcHmiFileExplorer-menu-bar"),elementSorting=elementTemplateRoot?.querySelector(".TcHmi_Controls_Beckhoff_TcHmiFileExplorer-menu-bar .sorting"),elementClearSearch=elementTemplateRoot?.querySelector(".TcHmi_Controls_Beckhoff_TcHmiFileExplorer-menu-bar .clear-search");if(!(elementTemplateRoot&&elementDirectoryTree&&elementPathBox&&elementBrowsingBox&&elementMenuBar&&elementSorting&&elementClearSearch))throw new Error("Invalid Template.html");this.__elementTemplateRoot=elementTemplateRoot,this.__elementDirectoryTree=elementDirectoryTree,this.__elementPathBox=elementPathBox,this.__elementBrowsingBox=elementBrowsingBox,this.__elementMenuBar=elementMenuBar,this.__elementSorting=elementSorting,this.__elementClearSearch=elementClearSearch;const buttonCreateFolder=TcHmi.Controls.get(this.__id+"_ButtonCreateFolder"),buttonDownload=TcHmi.Controls.get(this.__id+"_ButtonDownload"),buttonUpload=TcHmi.Controls.get(this.__id+"_ButtonUpload"),buttonRename=TcHmi.Controls.get(this.__id+"_ButtonRename"),buttonCopy=TcHmi.Controls.get(this.__id+"_ButtonCopy"),buttonCut=TcHmi.Controls.get(this.__id+"_ButtonCut"),buttonPaste=TcHmi.Controls.get(this.__id+"_ButtonPaste"),buttonDelete=TcHmi.Controls.get(this.__id+"_ButtonDelete"),inputSearch=TcHmi.Controls.get(this.__id+"_InputSearch");if(!(buttonCreateFolder&&buttonDownload&&buttonUpload&&buttonRename&&buttonCopy&&buttonCut&&buttonPaste&&buttonDelete&&inputSearch))throw new Error("Controls in Template.html were not instantiated");TcHmi.Environment.getBrowserCapabilities().supportsDownload||TcHmi.Binding.createEx2(this.__expandLocalizationSymbol("Button_Tooltip_Download_NotSupported"),"Tooltip",buttonDownload),this.__buttons={createFolder:buttonCreateFolder,download:buttonDownload,upload:buttonUpload,rename:buttonRename,copy:buttonCopy,cut:buttonCut,paste:buttonPaste,delete:buttonDelete},this.__inputSearch=inputSearch;const createMapping={controlRight:"operate",virtualControlRight:"create"};this.__buttons.createFolder.setVirtualControlRightMappings([createMapping]),this.__buttons.download.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"download"}]),this.__buttons.upload.setVirtualControlRightMappings([createMapping]),this.__buttons.rename.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"rename"}]),this.__buttons.copy.setVirtualControlRightMappings([createMapping]),this.__buttons.cut.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"cut"}]),this.__buttons.paste.setVirtualControlRightMappings([createMapping]),this.__buttons.delete.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"delete"}]);const treeBrowsingDisplay=new ListBrowsingDisplay(this.__elementDirectoryTree,this),pathDisplay=new PathDisplay(this.__elementPathBox,this);this.__listBrowsingDisplay=new ListBrowsingDisplay(this.__elementBrowsingBox,this),this.__directoryBrowser=new DirectoryBrowser([treeBrowsingDisplay,pathDisplay,this.__listBrowsingDisplay],this),this.__directoryBrowser.setMultiSelectAllowed(!0),this.__directoryBrowser.setNavigationToFilesAllowed(!1),this.__directoryBrowser.onPathChange.add(this.__onPathChanged),this.__directoryBrowser.onSelectionChange.add(this.__onSelectionChanged),this.__sortConfigurator=new SortConfigurator(this.__elementSorting,[{name:"name",localizationKey:"Sort_Name_Name"},{name:"type",localizationKey:"Sort_Name_Type"},{name:"fileSize",localizationKey:"Sort_Name_FileSize"},{name:"modificationTime",localizationKey:"Sort_Name_ModificationTime"}],this),this.__sortConfigurator.onValueChange.add((value,isUserConfigured)=>{isUserConfigured?this.__storage?.set("sorting",value):this.__storage?.delete("sorting"),this.__processSorting()}),this.__destroyOnDestroy.push(this.__localization.watch(data=>{data.error===TcHmi.Errors.NONE&&data.reader&&(this.__localizationReader=data.reader,this.__localizeListBrowsingDisplay())}))}__init(){super.__init(),this.__storage=new TcHmi.LocalStorage(this,{sorting:this.getSorting()})}__attach(){super.__attach(),this.__directoryBrowser.resume(),this.__destroyOnDetach.push(TcHmi.EventProvider.register(this.__buttons.createFolder.getId()+".onPressed",this.__onCreateFolderPressed),TcHmi.EventProvider.register(this.__buttons.download.getId()+".onPressed",this.__onDownloadPressed),TcHmi.EventProvider.register(this.__buttons.upload.getId()+".onPressed",this.__onUploadPressed),TcHmi.EventProvider.register(this.__buttons.rename.getId()+".onPressed",this.__onRenamePressed),TcHmi.EventProvider.register(this.__buttons.copy.getId()+".onPressed",this.__onCopyPressed),TcHmi.EventProvider.register(this.__buttons.cut.getId()+".onPressed",this.__onCutPressed),TcHmi.EventProvider.register(this.__buttons.paste.getId()+".onPressed",this.__onPastePressed),TcHmi.EventProvider.register(this.__buttons.delete.getId()+".onPressed",this.__onDeletePressed),TcHmi.EventProvider.register(this.__inputSearch.getId()+".onTextChanged",this.__onSearchChanged),TcHmi.EventProvider.registerDomEvent(this.__elementClearSearch,"click",this.__onClearSearchClick)),this.__updateSubscription(),this.__updateSymbolAccessSubscription();const sorting=this.__storage?.get("sorting");sorting&&!tchmi_equal(sorting,this.__sortConfigurator?.getUserValue())&&(this.__sortConfigurator?.setUserValue(sorting),TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"Sorting"}),this.__processSorting())}__detach(){super.__detach(),this.__updateSubscription(!0),this.__updateSymbolAccessSubscription(!0)}destroy(){this.__keepAlive||super.destroy()}__onPathChanged(currentItem,path){this.setPath(path?path.join("/"):null),this.__inputSearch.setText(null)}__onSelectionChanged(selectedItems){this.__updateButtonsEnabled(),TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"SelectedItems"}),TcHmi.EventProvider.raise(this.__id+".onSelectionChanged")}__onCreateFolderPressed(){this.__root&&this.__path&&this.__createFolder(this.__root.combine(this.__path))}__onDownloadPressed(){const items=this.__directoryBrowser.getSelectedItems();items&&this.__root&&this.__path&&this.__downloadFiles(this.__root.combine(this.__path),items)}__onUploadPressed(){this.__upload()}__onRenamePressed(){const items=this.__directoryBrowser.getSelectedItems();items&&1===items.length&&this.__root&&this.__path&&this.__rename(this.__root.combine(this.__path),items[0].name)}__onCopyPressed(){const items=this.__directoryBrowser.getSelectedItems();if(items&&this.__root&&this.__path){if(items.some(item=>this.__filesBeingUploaded.has(this.__root.combine(this.__path).combine(item.name).toString())))return;const path=this.__root.combine(this.__path);this.__clipboard={action:"copy",items:items.map(item=>path.combine(item.name))},this.__updateButtonsEnabled(),this.__updateButtonAccess(),this.__buttons.paste.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"create"}])}}__onCutPressed(){const items=this.__directoryBrowser.getSelectedItems();if(items&&this.__root&&this.__path){if(items.some(item=>this.__filesBeingUploaded.has(this.__root.combine(this.__path).combine(item.name).toString())))return;const path=this.__root.combine(this.__path);this.__clipboard={action:"cut",items:items.map(item=>path.combine(item.name))},this.__updateButtonsEnabled(),this.__updateButtonAccess(),this.__buttons.paste.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"cut"}])}}__onPastePressed(){if(this.__root&&this.__path){const existingNames=this.__directoryBrowser.getCurrentFolder()?.children.keys();this.__paste(this.__root.combine(this.__path),new Set(existingNames))}}__onDeletePressed(){const items=this.__directoryBrowser.getSelectedItems();items&&this.__root&&this.__path&&this.__delete(this.__root.combine(this.__path),items)}__onSearchChanged(){this.__listBrowsingDisplay.search(this.__inputSearch.getText()??null),this.__elementClearSearch.classList.toggle("has-text",!!this.__inputSearch.getText())}__onClearSearchClick(event){0===event.button&&(this.__inputSearch.setText(null),this.__inputSearch.focus())}__expandLocalizationSymbol(key){return`%l%Control::${TcHmiFileExplorer.#tchmiFQN}::${key}%/l%`}__updateButtonsEnabled(){if(!this.__root||!this.__path)return;const currentFolder=this.__directoryBrowser.getCurrentFolder(),currentFolderEditable=null!==currentFolder&&!currentFolder.payload.fileFlags.includes("ReadOnly")&&!currentFolder.payload.fileFlags.includes("UserAccessReadOnly"),selectedItems=this.__directoryBrowser.getSelectedItems()??[],fullPath=this.__root.combine(this.__path),virtualDirectoriesSelected=selectedItems.some(item=>item.payload.fileFlags.includes("VirtualDirectory")),directoriesSelected=selectedItems.some(item=>item.payload.fileFlags.includes("VirtualDirectory")||item.payload.fileFlags.includes("Directory")),readOnlySelected=selectedItems.some(item=>item.payload.fileFlags.includes("ReadOnly")||item.payload.fileFlags.includes("UserAccessReadOnly")),uploadsSelected=selectedItems.some(item=>this.__filesBeingUploaded.has(fullPath.combine(item.name).toString()));this.__buttons.createFolder.setIsEnabled(currentFolderEditable),this.__buttons.download.setIsEnabled(selectedItems.length>0&&!directoriesSelected&&!uploadsSelected&&TcHmi.Environment.getBrowserCapabilities().supportsDownload),this.__buttons.upload.setIsEnabled(currentFolderEditable),this.__buttons.rename.setIsEnabled(currentFolderEditable&&1===selectedItems.length&&!virtualDirectoriesSelected&&!readOnlySelected&&!uploadsSelected),this.__buttons.copy.setIsEnabled(selectedItems.length>0&&!uploadsSelected),this.__buttons.cut.setIsEnabled(currentFolderEditable&&selectedItems.length>0&&!uploadsSelected),this.__buttons.paste.setIsEnabled(currentFolderEditable&&null!==this.__clipboard),this.__buttons.delete.setIsEnabled(currentFolderEditable&&selectedItems.length>0&&!virtualDirectoriesSelected&&!readOnlySelected)}__updateButtonAccess(){const canUpload=this.__symbolAccess.Upload>=TcHmiFileExplorer.SymbolAccess.Write,canReadConfig=this.__symbolAccess["TcHmiSrv.Config"]===TcHmiFileExplorer.SymbolAccess.Read||this.__symbolAccess["TcHmiSrv.Config"]===TcHmiFileExplorer.SymbolAccess.ReadWrite,canRename=this.__symbolAccess.Rename>=TcHmiFileExplorer.SymbolAccess.Write,canCopy=this.__symbolAccess.Copy>=TcHmiFileExplorer.SymbolAccess.Write,canDelete=this.__symbolAccess.Delete>=TcHmiFileExplorer.SymbolAccess.Write;TcHmi.Access.setControlRightOverride(this.__buttons.createFolder,"operate",canUpload?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canUpload?"Button_Tooltip_CreateFolder":"Button_Tooltip_CreateFolder_MissingSymbolAccess"),"Tooltip",this.__buttons.createFolder),TcHmi.Access.setControlRightOverride(this.__buttons.upload,"operate",canUpload&&canReadConfig?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canUpload&&canReadConfig?"Button_Tooltip_Upload":"Button_Tooltip_Upload_MissingSymbolAccess"),"Tooltip",this.__buttons.upload),TcHmi.Access.setControlRightOverride(this.__buttons.rename,"operate",canRename?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canRename?"Button_Tooltip_Rename":"Button_Tooltip_Rename_MissingSymbolAccess"),"Tooltip",this.__buttons.rename),TcHmi.Access.setControlRightOverride(this.__buttons.copy,"operate",canCopy?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canCopy?"Button_Tooltip_Copy":"Button_Tooltip_Copy_MissingSymbolAccess"),"Tooltip",this.__buttons.copy),TcHmi.Access.setControlRightOverride(this.__buttons.cut,"operate",canRename?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canRename?"Button_Tooltip_Cut":"Button_Tooltip_Cut_MissingSymbolAccess"),"Tooltip",this.__buttons.cut),TcHmi.Access.setControlRightOverride(this.__buttons.paste,"operate",null===this.__clipboard||("copy"===this.__clipboard.action?canCopy:canRename)?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(null===this.__clipboard||("copy"===this.__clipboard.action?canCopy:canRename)?"Button_Tooltip_Paste":"Button_Tooltip_Paste_MissingSymbolAccess"),"Tooltip",this.__buttons.paste),TcHmi.Access.setControlRightOverride(this.__buttons.delete,"operate",canDelete?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canDelete?"Button_Tooltip_Delete":"Button_Tooltip_Delete_MissingSymbolAccess"),"Tooltip",this.__buttons.delete)}__createNamePrompt(){const prompt=new InputPrompt(this);return prompt.setBackgroundAction({close:!0,action:"cancel"}),prompt.setValidationPatterns([{pattern:/[<>:"/\\|?*]/,expectedTestResult:!1},{pattern:/^(?:CON|PRN|AUX|NUL|COM\d|LPT\d)(?:\.[^.]*)?$/,expectedTestResult:!1}]),prompt.setLocalizations({labelText:this.__expandLocalizationSymbol("Popup_Label_Name"),buttonTextOk:this.__expandLocalizationSymbol("Popup_Button_Text_OK"),buttonTooltipOk:this.__expandLocalizationSymbol("Popup_Button_Tooltip_OK"),buttonTextCancel:this.__expandLocalizationSymbol("Popup_Button_Text_Cancel"),buttonTooltipCancel:this.__expandLocalizationSymbol("Popup_Button_Tooltip_Cancel")}),prompt}async __createFolder(path){this.__namePrompt||(this.__namePrompt=this.__createNamePrompt()),this.__namePrompt.setLocalizations({headerText:this.__expandLocalizationSymbol("Popup_Header_NewFolder")});const forbidden=new Set(this.__directoryBrowser.getCurrentFolder()?.children.keys());forbidden.add("").add("..").add("::").add("/");const answer=await this.__namePrompt.prompt(forbidden,this.__localizationReader?.get("New_Folder"));answer.isOk&&TcHmi.Server.writeSymbolEx("Upload",{fileName:path.combine(answer.value).toString(),isDirectory:!0},null,data=>{if(data.error===TcHmi.Errors.NONE&&data.results)for(const result of data.results)result.error!==TcHmi.Errors.NONE&&TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"Upload"},TcHmi.Log.buildMessage(result.details));else TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"Upload"},TcHmi.Log.buildMessage(data.details))})}__downloadFiles(path,items){if(0===items.length)return;const aElement=document.createElement("a");aElement.style.display="none",this.__element[0].appendChild(aElement);for(const file of items){if(file.type!==DirectoryBrowser.ItemType.File)continue;const filePath=path.combine(file.name).toString();this.__filesBeingUploaded.has(filePath)||(aElement.download=file.name,aElement.href=filePath,aElement.click())}aElement.remove()}async __upload(){if(this.__root&&this.__path){const files=await TcHmi.FileUploader.openFileDialog({multiple:!0});if(files){const existingNames=this.__directoryBrowser.getCurrentFolder()?.children.keys();this.__uploadFiles(this.__root.combine(this.__path),files,new Set(existingNames))}}}async __uploadFiles(path,files,existingNames){const currentFolder=this.__directoryBrowser.getCurrentFolder();if(!currentFolder)return;const filesToQueue=new Map,conflictingNames=new Set;for(const file of files)existingNames.has(file.name)&&conflictingNames.add(file.name),filesToQueue.set(file.name,{file,path:path.combine(file.name).toString()});if(0!==conflictingNames.size){const result=await this.__resolveFileNameConflicts(conflictingNames,existingNames);if(!result.isOk)return;for(const name of conflictingNames){const resolvedName=result.value.get(name);if(resolvedName){if(resolvedName!==name){const fileToQueue=filesToQueue.get(name);fileToQueue&&(fileToQueue.path=path.combine(resolvedName).toString())}}else filesToQueue.delete(name)}}this.__fileUploader||(this.__fileUploader=new TcHmi.FileUploader);let targetFolder={};for(const[name,child]of currentFolder.children)targetFolder[name]={fileFlags:child.payload.fileFlags,fileSize:child.payload.fileSize,link:child.payload.link,modificationTime:child.payload.modificationTime};const errors=[];for(const[name,fileToQueue]of filesToQueue){const fileBeingUploaded={fileFlags:[],fileSize:NaN,uploadStatus:TcHmiFileExplorer.UploadStatus.Pending,uploadedSize:0};this.__filesBeingUploaded.set(fileToQueue.path,fileBeingUploaded),targetFolder[name]=fileBeingUploaded;let fileElement=null;this.__fileUploader.queue(fileToQueue.path,fileToQueue.file,{progressCallback:result=>{if(result.error!==TcHmi.Errors.NONE){let rootCauses=[result.details],iterate=!0;for(;iterate;)iterate=!1,rootCauses=rootCauses.flatMap(details=>details.errors?.length?(iterate=!0,details.errors):details);const messages=rootCauses.map(details=>`${name}: ${details.message??"ERROR"}, ${details.reason??"Unknown error"}`);errors.push(...messages),this.__showErrorPopup(this.__expandLocalizationSymbol("Popup_Header_FileUploadError"),{symbolExpression:this.__expandLocalizationSymbol("Popup_Text_FileUploadError"),formatValues:[errors.join("\n")]}),fileBeingUploaded.uploadStatus=TcHmiFileExplorer.UploadStatus.Error,this.__filesBeingUploaded.delete(fileToQueue.path)}else switch(result.status){case TcHmi.FileUploader.FileStatus.Pending:fileBeingUploaded.uploadStatus=TcHmiFileExplorer.UploadStatus.Pending,fileBeingUploaded.fileSize=result.totalBytes/1e3,fileElement||(fileElement=this.__elementBrowsingBox.querySelector(`li.file[data-name="${CSS.escape(name)}"]`)),fileElement?.style.setProperty("--tchmi-file-upload-progress","0");break;case TcHmi.FileUploader.FileStatus.Uploading:fileBeingUploaded.uploadStatus=TcHmiFileExplorer.UploadStatus.InProgress,fileBeingUploaded.fileSize=result.totalBytes/1e3,fileBeingUploaded.uploadedSize=result.uploadedBytes/1e3,fileElement||(fileElement=this.__elementBrowsingBox.querySelector(`li.file[data-name="${CSS.escape(name)}"]`)),fileElement?.style.setProperty("--tchmi-file-upload-progress",result.uploadedBytes/result.totalBytes*100+"%");break;case TcHmi.FileUploader.FileStatus.Finished:delete fileBeingUploaded.uploadStatus,delete fileBeingUploaded.uploadedSize,this.__filesBeingUploaded.delete(fileToQueue.path),fileElement||(fileElement=this.__elementBrowsingBox.querySelector(`li.file[data-name="${CSS.escape(name)}"]`)),fileElement?.style.setProperty("--tchmi-file-upload-progress","100%");break;case TcHmi.FileUploader.FileStatus.Canceled:this.__filesBeingUploaded.delete(fileToQueue.path),result.uploadedBytes>0&&this.__delete(path,[{name,type:DirectoryBrowser.ItemType.File,payload:targetFolder[name],parent:currentFolder}],!0),delete targetFolder[name]}this.__updateDirectory(targetFolder,path)}}).catch(ex=>{ex instanceof TcHmi.Exception&&ex.log({Source:"Control",Module:this.__type,Origin:TcHmiFileExplorer.#tchmiFQN,Id:this.__id},"Failed to upload file.")})}this.__updateDirectory(targetFolder,path)}__showErrorPopup(headerText,contentText){return this.__errorPrompt||(this.__errorPrompt=new TextAndButtonsPrompt({ok:{value:void 0,attributes:{"data-tchmi-width":60,"data-tchmi-height":30,"data-tchmi-text":this.__expandLocalizationSymbol("Popup_Button_Text_OK")}}},this),this.__errorPrompt.setBackgroundAction({close:!0,action:"ok"})),this.__errorPrompt.setLocalizations({headerText,contentText}),this.__errorPrompt.isShowing()||(this.__errorPromptPromise=this.__errorPrompt.prompt()),this.__errorPromptPromise}async __resolveFileNameConflicts(conflictingNames,existingNames){const currentFolder=this.__directoryBrowser.getCurrentFolder();if(!currentFolder)return{isOk:!1};const conflictMap=new Map,canDelete=TcHmi.Access.checkAccess(this,"delete")??!1;for(const name of conflictingNames){const fileFlags=currentFolder.children.get(name)?.payload.fileFlags??[];conflictMap.set(name,canDelete&&!fileFlags.includes("ReadOnly")&&!fileFlags.includes("UserAccessReadOnly"))}const popup=new FileConflictPrompt(conflictMap,existingNames,this);popup.setLocalizations({headerText:this.__expandLocalizationSymbol("Popup_Header_FileConflict"),labelText:this.__expandLocalizationSymbol("Popup_Label_FileConflict"),labelDoForAll:this.__expandLocalizationSymbol("Popup_FileConflict_Label_DoForAll"),radioTextSkip:this.__expandLocalizationSymbol("Popup_FileConflict_Radio_Text_Skip"),radioTextReplace:this.__expandLocalizationSymbol("Popup_FileConflict_Radio_Text_Replace"),radioTextKeepBoth:this.__expandLocalizationSymbol("Popup_FileConflict_Radio_Text_KeepBoth"),buttonTextOk:this.__expandLocalizationSymbol("Popup_Button_Text_OK"),buttonTextCancel:this.__expandLocalizationSymbol("Popup_Button_Text_Cancel"),buttonTooltipCancel:this.__expandLocalizationSymbol("Popup_Button_Tooltip_Cancel")});const result=await popup.prompt();return popup.destroy(!0),result}async __rename(path,name){if(this.__filesBeingUploaded.has(path.combine(name).toString()))return;this.__namePrompt||(this.__namePrompt=this.__createNamePrompt()),this.__namePrompt.setLocalizations({headerText:this.__expandLocalizationSymbol("Popup_Header_Rename")});const forbidden=new Set(this.__directoryBrowser.getCurrentFolder()?.children.keys());forbidden.add("").add("..").add("::").add("/");const answer=await this.__namePrompt.prompt(forbidden,name);if(answer.isOk){const vPath=new Path("VIRTUALDIRECTORIES::").combine(path);TcHmi.Server.writeSymbolEx("Rename",{old:vPath.combine(name).toString(),new:vPath.combine(answer.value).toString()},null,data=>{if(data.error===TcHmi.Errors.NONE&&data.results)for(const result of data.results)result.error!==TcHmi.Errors.NONE&&TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"Rename"},TcHmi.Log.buildMessage(result.details));else TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"Rename"},TcHmi.Log.buildMessage(data.details))})}}async __paste(targetPath,existingNames){if(!this.__clipboard)return;const pathChanges=[],conflictingNames=new Map;for(const path of this.__clipboard.items){const name=path.getName(),pathChange={old:path,new:targetPath.combine(name)};pathChanges.push(pathChange),existingNames.has(name)&&conflictingNames.set(name,pathChange),existingNames.add(name)}if(conflictingNames.size>0){const result=await this.__resolveFileNameConflicts(conflictingNames.keys(),existingNames);if(!result.isOk)return;for(const[name,pathChange]of conflictingNames){const resolvedName=result.value.get(name);if(resolvedName)pathChange.new=targetPath.combine(resolvedName);else{const index=pathChanges.indexOf(pathChange);void 0!==index&&index>-1&&pathChanges.splice(index,1)}}}if(0===pathChanges.length)return;const vPath=new Path("VIRTUALDIRECTORIES::"),symbolName="copy"===this.__clipboard.action?"Copy":"Rename",request={requestType:"ReadWrite",commands:pathChanges.map(pathChange=>({symbol:symbolName,commandOptions:["SendErrorMessage","SendWriteValue"],writeValue:{old:vPath.combine(pathChange.old).toString(),new:vPath.combine(pathChange.new).toString()}}))};let serverErrored=!1;TcHmi.Server.requestEx(request,null,data=>{if(data.error!==TcHmi.Errors.NONE||!data.results)return TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:symbolName},TcHmi.Log.buildMessage(data.details)),void(serverErrored=!0);for(const result of data.results)result.error!==TcHmi.Errors.NONE&&(TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:symbolName},TcHmi.Log.buildMessage(result.details)),serverErrored=!0)}),serverErrored||"cut"!==this.__clipboard.action||(this.__clipboard.action="copy",this.__clipboard.items=pathChanges.map(pathChange=>pathChange.new),this.__updateButtonAccess(),this.__buttons.paste.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"create"}]))}async __delete(path,items,skipConfirmation){const undeletableItems=items.filter(item=>item.payload.fileFlags.includes("VirtualDirectory")||item.payload.fileFlags.includes("ReadOnly")||item.payload.fileFlags.includes("UserAccessReadOnly"));if(0!==undeletableItems.length&&(items=items.filter(item=>!undeletableItems.includes(item)),await this.__showErrorPopup(this.__expandLocalizationSymbol("Popup_Header_DeleteError"),{symbolExpression:this.__expandLocalizationSymbol("Popup_Text_DeleteError"),formatValues:[undeletableItems.map(item=>item.name).join("\n")]})),0===items.length)return;this.__confirmationPrompt||(this.__confirmationPrompt=new TextAndButtonsPrompt({yes:{value:!0,attributes:{"data-tchmi-width":60,"data-tchmi-height":30,"data-tchmi-text":this.__expandLocalizationSymbol("Popup_Button_Text_Yes")}},no:{value:!1,attributes:{"data-tchmi-width":60,"data-tchmi-height":30,"data-tchmi-text":this.__expandLocalizationSymbol("Popup_Button_Text_No")}}},this),this.__confirmationPrompt.setBackgroundAction({close:!0,action:"no"}),this.__confirmationPrompt.setLocalizations({headerText:this.__expandLocalizationSymbol("Popup_Header_ConfirmDelete"),contentText:this.__expandLocalizationSymbol("Popup_Text_ConfirmDelete")}));if(skipConfirmation||await this.__confirmationPrompt.prompt()){const uploadsToCancel=items.filter(item=>this.__filesBeingUploaded.has(path.combine(item.name).toString()));if(0!==uploadsToCancel.length&&this.__fileUploader){items=items.filter(item=>!uploadsToCancel.includes(item));for(const upload of uploadsToCancel)this.__fileUploader.cancel(path.combine(upload.name).toString())}if(0===items.length)return;const request={requestType:"ReadWrite",commands:items.map(item=>({symbol:"Delete",commandOptions:["SendErrorMessage","SendWriteValue"],writeValue:{fileName:path.combine(item.name).toString()}}))};TcHmi.Server.requestEx(request,null,data=>{if(data.error===TcHmi.Errors.NONE&&data.results)for(const result of data.results)result.error!==TcHmi.Errors.NONE&&TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"Delete"},TcHmi.Log.buildMessage(result.details));else TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"Delete"},TcHmi.Log.buildMessage(data.details))})}}__localizeListBrowsingDisplay(){if(!this.__localizationReader)return;const labelFileSize=this.__localizationReader.get("Metadata_Label_FileSize"),labelModificationTime=this.__localizationReader.get("Metadata_Label_ModificationTime"),labelVirtualDirectory=this.__localizationReader.get("Metadata_Label_VirtualDirectory"),labelReadOnly=this.__localizationReader.get("Metadata_Label_ReadOnly"),labelUploadPending=this.__localizationReader.get("Metadata_Label_UploadPending"),labelUploadInProgress=this.__localizationReader.get("Metadata_Label_UploadInProgress"),labelUploadError=this.__localizationReader.get("Metadata_Label_UploadError");function formatSize(size){const units=["kB","MB","GB"];let index=0;for(;size>1e3&&index<units.length-1;)size/=1e3,index++;return size.toFixed(3)+" "+units[index]}this.__listBrowsingDisplay.showMetadata(item=>{const metadata=[];if(void 0!==item.payload.fileSize)if(void 0!==item.payload.uploadStatus)switch(item.payload.uploadStatus){case TcHmiFileExplorer.UploadStatus.Pending:metadata.push(labelUploadPending);break;case TcHmiFileExplorer.UploadStatus.InProgress:metadata.push(`${labelUploadInProgress}: ${formatSize(item.payload.uploadedSize??0)} / ${formatSize(item.payload.fileSize)}`);break;case TcHmiFileExplorer.UploadStatus.Error:metadata.push(labelUploadError)}else metadata.push(`${labelFileSize}: ${formatSize(item.payload.fileSize)}`);return item.payload.modificationTime&&metadata.push(`${labelModificationTime}: ${TcHmi.Localization.formatDate(new Date(item.payload.modificationTime))}`),item.payload.fileFlags.includes("VirtualDirectory")&&metadata.push(labelVirtualDirectory),(item.payload.fileFlags.includes("ReadOnly")||item.payload.fileFlags.includes("UserAccessReadOnly"))&&metadata.push(labelReadOnly),metadata.join("   |   ")})}setRoot(valueNew){let convertedValue=TcHmi.ValueConverter.toString(valueNew);null===convertedValue&&(convertedValue=this.getAttributeDefaultValueInternal("Root")),tchmi_equal(convertedValue,this.__root?.original)||(this.__root=new Path(convertedValue,!0),TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"Root"}),this.__processRoot())}getRoot(){return this.__root?.original}__processRoot(){this.__processPath()}setPath(valueNew){let convertedValue=TcHmi.ValueConverter.toString(valueNew);null===convertedValue&&(convertedValue=this.getAttributeDefaultValueInternal("Path")),tchmi_equal(convertedValue,this.__path?.original)||(this.__path=new Path(convertedValue),TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"Path"}),this.__processPath())}getPath(){return this.__path?.original}async __processPath(){if(!this.__root||!this.__path)return;TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"FullPath"}),TcHmi.EventProvider.raise(this.__id+".onPathChanged"),await this.__updateSubscription();await this.__directoryBrowser.setPath(this.__path.toArray())||TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Attribute:"Path"},TcHmi.Log.buildMessage({code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:`The path "${this.__path.original}" cannot be found under the root "${this.__root.original}". Please check if both path and root are correct.`,domain:this.__type}))}getFullPath(){return this.__root&&this.__path?this.__root.combine(this.__path).toString():""}getSelectedItems(){return(this.__directoryBrowser.getSelectedItems()??[]).map(item=>item.name)}setSorting(valueNew){let convertedValue=TcHmi.ValueConverter.toObject(valueNew)??this.getAttributeDefaultValueInternal("Sorting"),resolverInfo=this.__objectResolvers.get("sorting");resolverInfo?.watchDestroyer?.(),resolverInfo?.resolver.destroy();let resolver=new TcHmi.Symbol.ObjectResolver(convertedValue,{parentControl:this,type:this.getAttributeDescription("Sorting")?.type});this.__objectResolvers.set("sorting",{resolver,watchCallback:this.__onResolverForSortingWatchCallback,watchDestroyer:resolver.watch(this.__onResolverForSortingWatchCallback)})}__onResolverForSortingWatchCallback(data){this.__isAttached||this.__suspendObjectResolver("sorting"),data.error===TcHmi.Errors.NONE?tchmi_equal(data.value,this.getSorting())||(this.__sortConfigurator?.setAttributeValue(data.value??this.getAttributeDefaultValueInternal("Sorting")),TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"Sorting"}),this.__processSorting()):TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Attribute:"Sorting"},TcHmi.Log.buildMessage(data.details),`Resolving symbols from object failed with error: ${TcHmi.Log.buildMessage(data.details)}`)}getSorting(){return void 0!==this.__sortConfigurator?.getAttributeValue()?this.__sortConfigurator.getUserValue():void 0}__processSorting(){const sorting=this.__sortConfigurator?.getUserValue()??[];this.__listBrowsingDisplay.sort(sorting.length>0?sorting.map(criterion=>"name"===criterion.name||"type"===criterion.name?criterion:{name:"metadata::"+criterion.name,order:criterion.order}):null)}setServerInterval(valueNew){let convertedValue=TcHmi.ValueConverter.toNumber(valueNew);null===convertedValue&&(convertedValue=this.getAttributeDefaultValueInternal("ServerInterval")),tchmi_equal(convertedValue,this.__serverInterval)||(this.__serverInterval=convertedValue,TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"ServerInterval"}),this.__processServerInterval())}getServerInterval(){return this.__serverInterval}__processServerInterval(){this.__updateSubscription(),this.__updateSymbolAccessSubscription()}setMenuBarPosition(valueNew){let convertedValue=TcHmi.ValueConverter.toString(valueNew);(null===convertedValue||"Top"!==convertedValue&&"Bottom"!==convertedValue)&&(convertedValue=this.getAttributeDefaultValueInternal("MenuBarPosition")),tchmi_equal(convertedValue,this.__menuBarPosition)||(this.__menuBarPosition=convertedValue,TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"MenuBarPosition"}),this.__processLayout())}getMenuBarPosition(){return this.__menuBarPosition}setMenuBarHeight(valueNew){let convertedValue=TcHmi.ValueConverter.toNumber(valueNew);null===convertedValue&&(convertedValue=this.getAttributeDefaultValueInternal("MenuBarHeight")),tchmi_equal(convertedValue,this.__menuBarHeight)||(this.__menuBarHeight=convertedValue,TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"MenuBarHeight"}),this.__processLayout())}getMenuBarHeight(){return this.__menuBarHeight}getMenuBarHeightUnit(){return"px"}__processLayout(){if(!this.__menuBarPosition||void 0===this.__menuBarHeight||void 0===this.__showNavigationPane||!this.__navigationPanePosition)return;this.__elementDirectoryTree.style.display=this.__showNavigationPane?"":"none";const gridTemplateExplorer=(this.__showNavigationPane?"Right"!==this.__navigationPanePosition?"'tree browsing'":"'browsing tree'":"'browsing browsing'")+"minmax(0, 1fr)",gridTemplate=("Bottom"!==this.__menuBarPosition?`'menu menu' auto\n${gridTemplateExplorer}`:`${gridTemplateExplorer}\n'menu menu' auto`)+" / auto 1fr";this.__elementTemplateRoot.style.gridTemplate=gridTemplate,this.__elementMenuBar.style.setProperty("--height",this.__menuBarHeight+"px")}__updateSubscription(unsubscribeOnly=!1){return TCHMI_DESIGNER?Promise.resolve():new Promise(resolve=>{if(null!==this.__subscriptionId&&(TcHmi.Server.unsubscribeEx(this.__subscriptionId,null),this.__subscriptionId=null),!unsubscribeOnly&&this.__isAttached){if(this.__root&&this.__path){const handler=this.__getListFilesHandler(this.__path);this.__subscriptionId=TcHmi.Server.subscribeEx([{symbol:"ListFiles",writeValue:"/"+this.__root.combine(this.__path).toString(),commandOptions:["SendWriteValue","SendErrorMessage"]}],this.__serverInterval??TcHmi.Config.get().tcHmiServer.websocketIntervalTime,null,data=>{handler(data),resolve()})}}else resolve()})}__getListFilesHandler(path){return data=>{if(data.error!==TcHmi.Errors.NONE)return void TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"ListFiles"},TcHmi.Log.buildMessage(data.details));if(!data.response)return void TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"ListFiles"},TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_MISSING],reason:"Missing response from server.",domain:this.__type}));if(data.response.error)return void TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"ListFiles"},TcHmi.Log.buildMessage(data.response.error));if(!data.response.commands||!data.response.commands[0])return void TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"ListFiles"},TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:`Missing commands in response from server with id: '${data.response.id}'.`,domain:this.__type}));if(data.response.commands[0].error)return void TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"ListFiles"},TcHmi.Log.buildMessage(data.response.commands[0].error));const readValue=data.response.commands[0].readValue;readValue?this.__updateDirectory(readValue,path):TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"ListFiles"},TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_READVALUE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_READVALUE_MISSING],reason:`Missing readValue in response from server with id: '${data.response.id}'.`,domain:this.__type}))}}__updateDirectory(fileList,path){let current=this.__directory;for(const pathItem of path.toArray()){current.children||(current.children=new Map);let next=current.children.get(pathItem);next||(next={fileFlags:["Directory"]},current.children.set(pathItem,next)),current=next}if(current.children)for(const name of current.children.keys())name in fileList||current.children.delete(name);else current.children=new Map;const fullPath=this.__root?.combine(path);for(const[name,file]of Object.entries(fileList)){const child=current.children.get(name);if(child){const fileBeingUploaded=this.__filesBeingUploaded.get(fullPath?.combine(name)?.toString()??"");if(fileBeingUploaded){fileBeingUploaded.fileFlags=file.fileFlags,fileBeingUploaded.link=file.link,fileBeingUploaded.modificationTime=file.modificationTime;continue}child.fileFlags=file.fileFlags,child.fileSize=file.fileSize,child.link=file.link,child.modificationTime=file.modificationTime,child.uploadStatus=file.uploadStatus,child.uploadedSize=file.uploadedSize}else current.children.set(name,file)}for(const[pathString,fileBeingUploaded]of this.__filesBeingUploaded){const uploadPath=new Path(pathString),name=uploadPath.pop();if(!uploadPath.equals(fullPath??"")||!name)continue;const child=current.children.get(name);child?(child.fileFlags=fileBeingUploaded.fileFlags,child.fileSize=fileBeingUploaded.fileSize,child.link=fileBeingUploaded.link,child.modificationTime=fileBeingUploaded.modificationTime,child.uploadStatus=fileBeingUploaded.uploadStatus,child.uploadedSize=fileBeingUploaded.uploadedSize):current.children.set(name,fileBeingUploaded)}const updateButtons=null===this.__directoryBrowser.getCurrentItem();this.__directoryBrowser.setDirectory(this.__directory,folder=>folder.children??new Map,candidate=>!candidate.fileFlags.includes("Directory")&&!candidate.fileFlags.includes("VirtualDirectory"),item=>({fileFlags:item.fileFlags,fileSize:item.fileSize,link:item.link,modificationTime:item.modificationTime?new Date(item.modificationTime):void 0,uploadStatus:void 0!==item.uploadStatus?TcHmiFileExplorer.UploadStatus[item.uploadStatus]:void 0,uploadedSize:item.uploadedSize})),updateButtons&&this.__updateButtonsEnabled()}__updateSymbolAccessSubscription(unsubscribeOnly=!1){if(TCHMI_DESIGNER)return;if(null!==this.__symbolAccessSubscriptionId&&(TcHmi.Server.unsubscribeEx(this.__symbolAccessSubscriptionId,null),this.__symbolAccessSubscriptionId=null),unsubscribeOnly||!this.__isAttached)return;const commands=Object.keys(this.__symbolAccess).map(symbolName=>({symbol:"GetSymbolAccess",writeValue:symbolName,commandOptions:["SendWriteValue","SendErrorMessage"]}));this.__symbolAccessSubscriptionId=TcHmi.Server.subscribeEx(commands,this.__serverInterval??TcHmi.Config.get().tcHmiServer.websocketIntervalTime,null,data=>{if(data.error===TcHmi.Errors.NONE)if(data.response)if(data.response.error)TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"GetSymbolAccess"},TcHmi.Log.buildMessage(data.response.error));else if(data.response.commands){for(const command of data.response.commands)command.error?TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"GetSymbolAccess"},TcHmi.Log.buildMessage(command.error)):void 0!==command.readValue?command.writeValue?this.__symbolAccess[command.writeValue]=command.readValue:TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"GetSymbolAccess"},TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_WRITEVALUE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_WRITEVALUE_MISSING],reason:`Missing writeValue in response from server with id: '${data.response.id}'.`,domain:this.__type})):TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"GetSymbolAccess"},TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_READVALUE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_READVALUE_MISSING],reason:`Missing readValue in response from server with id: '${data.response.id}'.`,domain:this.__type}));this.__updateButtonAccess()}else TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"GetSymbolAccess"},TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:`Missing commands in response from server with id: '${data.response.id}'.`,domain:this.__type}));else TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"GetSymbolAccess"},TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_MISSING],reason:"Missing response from server.",domain:this.__type}));else TcHmi.Log.Controls.error(this,TcHmiFileExplorer.#tchmiFQN,{Symbol:"GetSymbolAccess"},TcHmi.Log.buildMessage(data.details))})}static UploadStatus=UploadStatus;static SymbolAccess=SymbolAccess}})();TcHmi.Controls.registerEx("TcHmiFileExplorer","TcHmi.Controls.Beckhoff",TcHmiFileExplorer,{injectInGlobalObject:!0});export{TcHmiFileExplorer as Control};
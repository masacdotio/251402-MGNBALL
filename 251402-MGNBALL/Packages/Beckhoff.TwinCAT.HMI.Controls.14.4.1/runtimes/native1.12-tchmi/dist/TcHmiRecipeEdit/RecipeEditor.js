var __runInitializers=this&&this.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0},__esDecorate=this&&this.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(void 0!==f&&"function"!=typeof f)throw new TypeError("Function expected");return f}for(var _,kind=contextIn.kind,key="getter"===kind?"get":"setter"===kind?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]="access"===p?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])("accessor"===kind?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if("accessor"===kind){if(void 0===result)continue;if(null===result||"object"!=typeof result)throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&("field"===kind?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0};import{RecipeReferenceEditor}from"./RecipeReferenceEditor.js";import{RecipeTypeParser}from"./RecipeTypeParser.js";import{Callback}from"Beckhoff.TwinCAT.HMI.Framework/index.esm.js";import{EditorFactory}from"../Helpers/TcHmiJsonEditors/EditorFactory.js";import*as SchemaParser from"../Helpers/TcHmiJsonEditors/SchemaParser.js";import{Editor}from"../Helpers/TcHmiJsonEditors/BaseEditors/Editor.js";let RecipeEditor=(()=>{var _a;let ___onEditorChanged_decorators,_instanceExtraInitializers=[];return class RecipeEditor{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___onEditorChanged_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],__esDecorate(this,null,___onEditorChanged_decorators,{kind:"method",name:"__onEditorChanged",static:!1,private:!1,access:{has:obj=>"__onEditorChanged"in obj,get:obj=>obj.__onEditorChanged},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}__element=__runInitializers(this,_instanceExtraInitializers);__parentControl;static#tchmiFQN="TcHmi.Controls.Beckhoff.TcHmiRecipeEditComponents."+this.name;__tableBody;__recipeManagementDomain=null;__recipe=null;__recipeName=null;__recipeTypeName=null;__editorFactory;__editors=new Map;__tableHeaders;__localizations=void 0;__localizationSymbols=new Map;__onChangeManager=new Callback.Collection;onChange=this.__onChangeManager.getManipulators();constructor(__element,__parentControl){this.__element=__element,this.__parentControl=__parentControl,this.__editorFactory=new EditorFactory({parentControl:this.__parentControl,texts:this.__localizations?.editorLocalizations});const table=document.createElement("table"),thead=document.createElement("thead");table.appendChild(thead);const tr=document.createElement("tr");thead.appendChild(tr),this.__tableHeaders={name:tr.appendChild(document.createElement("th")),value:tr.appendChild(document.createElement("th")),min:tr.appendChild(document.createElement("th")),max:tr.appendChild(document.createElement("th")),unit:tr.appendChild(document.createElement("th")),comment:tr.appendChild(document.createElement("th"))},this.__tableBody=document.createElement("tbody"),table.appendChild(this.__tableBody),__element.appendChild(table)}destroy(){this.clear();for(const entry of this.__localizationSymbols.values())entry.destroyWatch(),entry.symbol.destroy();this.__localizationSymbols.clear()}async populate(recipeType,recipe){let parsedRecipeType;try{parsedRecipeType=await new RecipeTypeParser(this.__recipeManagementDomain,this.__parentControl).parse(recipeType.name,recipeType.recipeType)}catch(e){return void TcHmi.Log.Controls.error(this.__parentControl,RecipeEditor.#tchmiFQN,`Could not populate recipe editor. ${e instanceof Error?e.message:"Unknown error"}`)}this.__recipe=recipe.recipe??null,this.__recipeName=recipe.name,this.__recipeTypeName=recipeType.name,this.__render(parsedRecipeType,recipe.recipe),this.__onChangeManager.trigger(this)}clear(){this.__recipe=null,this.__recipeName=null,this.__recipeTypeName=null,this.__clearTableBodyAndEditors(),this.__onChangeManager.trigger(this)}__clearTableBodyAndEditors(){for(const editor of this.__editors.values())editor.destroy();for(this.__editors.clear();this.__tableBody.firstElementChild;)this.__tableBody.firstElementChild.remove()}__render(recipeType,recipe){this.__clearTableBodyAndEditors();const fragment=document.createDocumentFragment();for(const member of recipeType.ungroupedMembers)fragment.appendChild(this.__createMemberRow(member,recipe?.values[member.name]));for(const[groupName,group]of recipeType.memberGroups){const tr=document.createElement("tr"),groupCell=document.createElement("td");groupCell.colSpan=6,groupCell.textContent=groupName,tr.appendChild(groupCell),fragment.appendChild(tr);for(const member of group)fragment.appendChild(this.__createMemberRow(member,recipe?.values[member.name]))}this.__tableBody.appendChild(fragment)}__createMemberRow(member,value){const tr=document.createElement("tr"),nameCell=document.createElement("td");if(TcHmi.Symbol.isSymbolExpression(member.name)?this.__watchLocalization(member.name,{symbolExpression:member.name,formatValues:[]},text=>{nameCell.textContent=text}):nameCell.textContent=member.name,tr.appendChild(nameCell),"symbol"in member){const valueCell=document.createElement("td");valueCell.classList.add("value-cell");let editorInfo=SchemaParser.parse(member.symbolType);member.schema&&Object.keys(member.schema).length>0&&(editorInfo=SchemaParser.mergeEditorInfos(editorInfo,SchemaParser.parse(member.schema)));const editor=this.__editorFactory.fromEditorInfo(editorInfo,valueCell);this.__editors.set(member.name,editor),editor.setIsEnabled(member.enabled),void 0!==value?editor.setValue(value):void 0!==member.defaultValue&&editor.setValue(member.defaultValue),editor.onChange.add(this.__onEditorChanged),tr.appendChild(valueCell);const minCell=document.createElement("td");void 0!==member.schema?.minimum&&(minCell.textContent=member.schema.minimum.toString()),tr.appendChild(minCell);const maxCell=document.createElement("td");void 0!==member.schema?.maximum&&(maxCell.textContent=member.schema.maximum.toString()),tr.appendChild(maxCell);const unitCell=document.createElement("td");member.unit&&(unitCell.textContent=member.unit),tr.appendChild(unitCell);const commentCell=document.createElement("td");member.comment&&(commentCell.textContent=member.comment),tr.appendChild(commentCell)}else{const valueCell=document.createElement("td");valueCell.classList.add("value-cell");const editor=new RecipeReferenceEditor(valueCell,member.recipeType,this.__parentControl);editor.setLocalizations(this.__localizations?.recipeReferenceEditorLocalizations??{}),this.__editors.set(member.name,editor),editor.setIsEnabled(member.enabled),void 0!==value&&editor.setValue(value),editor.onChange.add(this.__onEditorChanged),tr.appendChild(valueCell);const spanCell=document.createElement("td");spanCell.colSpan=3,tr.appendChild(spanCell);const commentCell=document.createElement("td");member.comment&&(commentCell.textContent=member.comment),tr.appendChild(commentCell)}return tr}__onEditorChanged(){this.__onChangeManager.trigger(this)}setRecipeValues(recipe){if(this.__recipeTypeName===recipe.recipeTypeName)for(const[name,editor]of this.__editors)name in recipe.values&&editor.setValue(recipe.values[name])}getState(){if(null===this.__recipeTypeName)return{isValid:!1};if(null===this.__recipeName)return{isValid:!1};const values={};for(const[name,editor]of this.__editors){const state=editor.getState();if(!state.isValid)return{isValid:!1};values[name]=state.value}const value={recipeTypeName:this.__recipeTypeName,values};return{isValid:!0,value,recipeName:this.__recipeName,recipeTypeName:this.__recipeTypeName,hasChanges:!tchmi_equal(this.__recipe,value)}}getRecipeName(){return this.__recipeName}recipeExists(){return null!==this.__recipe}confirmSave(){const state=this.getState();state.isValid&&(this.__recipe=state.value),this.__onChangeManager.trigger(this)}setRecipeManagementDomain(domain){this.__recipeManagementDomain!==domain&&(this.__recipeManagementDomain=domain)}getRecipeManagementDomain(){return this.__recipeManagementDomain}setLocalizations(texts){if(this.__localizations||(this.__localizations=texts),texts.tableHeaderName&&(this.__watchLocalization("tableHeaderName","string"==typeof texts.tableHeaderName?{symbolExpression:texts.tableHeaderName,formatValues:[]}:texts.tableHeaderName,text=>this.__tableHeaders.name.textContent=text),this.__localizations.tableHeaderName=texts.tableHeaderName),texts.tableHeaderValue&&(this.__watchLocalization("tableHeaderValue","string"==typeof texts.tableHeaderValue?{symbolExpression:texts.tableHeaderValue,formatValues:[]}:texts.tableHeaderValue,text=>this.__tableHeaders.value.textContent=text),this.__localizations.tableHeaderValue=texts.tableHeaderValue),texts.tableHeaderMin&&(this.__watchLocalization("tableHeaderMin","string"==typeof texts.tableHeaderMin?{symbolExpression:texts.tableHeaderMin,formatValues:[]}:texts.tableHeaderMin,text=>this.__tableHeaders.min.textContent=text),this.__localizations.tableHeaderMin=texts.tableHeaderMin),texts.tableHeaderMax&&(this.__watchLocalization("tableHeaderMax","string"==typeof texts.tableHeaderMax?{symbolExpression:texts.tableHeaderMax,formatValues:[]}:texts.tableHeaderMax,text=>this.__tableHeaders.max.textContent=text),this.__localizations.tableHeaderMax=texts.tableHeaderMax),texts.tableHeaderUnit&&(this.__watchLocalization("tableHeaderUnit","string"==typeof texts.tableHeaderUnit?{symbolExpression:texts.tableHeaderUnit,formatValues:[]}:texts.tableHeaderUnit,text=>this.__tableHeaders.unit.textContent=text),this.__localizations.tableHeaderUnit=texts.tableHeaderUnit),texts.tableHeaderComment&&(this.__watchLocalization("tableHeaderComment","string"==typeof texts.tableHeaderComment?{symbolExpression:texts.tableHeaderComment,formatValues:[]}:texts.tableHeaderComment,text=>this.__tableHeaders.comment.textContent=text),this.__localizations.tableHeaderComment=texts.tableHeaderComment),texts.editorLocalizations){if(this.__localizations.editorLocalizations)for(const[name,subEditorLocalizations]of Object.entries(texts.editorLocalizations))if(this.__localizations.editorLocalizations[name])for(const[textName,text]of Object.entries(subEditorLocalizations))this.__localizations.editorLocalizations[name][textName]=text;else this.__localizations.editorLocalizations[name]=subEditorLocalizations;else this.__localizations.editorLocalizations=texts.editorLocalizations;for(const editor of this.__editors.values())editor instanceof Editor&&editor.setLocalizations(texts.editorLocalizations)}if(texts.recipeReferenceEditorLocalizations){if(this.__localizations.recipeReferenceEditorLocalizations)for(const[name,text]of Object.entries(texts.recipeReferenceEditorLocalizations))this.__localizations.recipeReferenceEditorLocalizations[name]=text;else this.__localizations.recipeReferenceEditorLocalizations=texts.recipeReferenceEditorLocalizations;for(const editor of this.__editors.values())editor instanceof RecipeReferenceEditor&&editor.setLocalizations(texts.recipeReferenceEditorLocalizations)}}__watchLocalization(name,localization,onChange){const existing=this.__localizationSymbols.get(name);existing?.destroyWatch(),existing?.symbol.destroy();const symbol=new TcHmi.Symbol(localization.symbolExpression),destroyWatch=symbol.watch(data=>{if(data.error!==TcHmi.Errors.NONE)return void TcHmi.Log.Controls.error(this.__parentControl,RecipeEditor.#tchmiFQN,{SymbolExpression:localization.symbolExpression},TcHmi.Log.buildMessage(data.details));let text=data.value??"";localization.formatValues.length>0&&(text=tchmi_format_string(text,...localization.formatValues)),onChange(text)});this.__localizationSymbols.set(name,{symbol,destroyWatch})}}})();export{RecipeEditor};
import{SymbolExpressionFromText}from"../../../System/SymbolExpressionFromText.js";export function resolveIdScopedMarkup(hostId,ucUrl,markup){let tempDiv=document.createElement("div");tempDiv.innerHTML=markup;let rawUserControlPartial=tempDiv.firstElementChild;if(!rawUserControlPartial)return{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.Controls.System.TcHmiUserControlHost"}};if("TcHmi.Controls.System.TcHmiUserControl"!==rawUserControlPartial.getAttribute("data-tchmi-type"))return{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.Controls.System.TcHmiUserControlHost",reason:"Wrong type (not TcHmi.Controls.System.TcHmiUserControl)."}};if(!rawUserControlPartial.id)return{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.Controls.System.TcHmiUserControlHost",reason:'Root element of file="'+ucUrl+'" is missing required attribute="id".'}};let rawUserControlPartialChildControls=rawUserControlPartial.querySelectorAll("div[data-tchmi-type]"),ucIdArr=[];ucIdArr.push(rawUserControlPartial.id);for(let i=0,ii=rawUserControlPartialChildControls.length;i<ii;i++){let id=rawUserControlPartialChildControls[i].id;ucIdArr.includes(id)||ucIdArr.push(id)}ucIdArr.sort((a,b)=>a&&a.includes&&a.includes(b)?1:b&&b.includes&&b.includes(a)?-1:0);const symbolExpressionParser=new SymbolExpressionFromText(markup),exprsPP=symbolExpressionParser.resolveExpressionsBySymbolType(TcHmi.SymbolType.PartialParam);for(const expr of exprsPP){const content=expr.getContent();content&&(markup=markup.replace(new RegExp(tchmi_escape_regex(expr.toString()),"g"),`%pp%${hostId}::${content}%/pp%`))}const exprsCTRL=symbolExpressionParser.resolveExpressionsBySymbolType(TcHmi.SymbolType.Control);for(const expr of exprsCTRL){const exprName=expr.getName(),content=expr.getContent();exprName&&ucIdArr.includes(exprName)&&content&&(markup=markup.replace(new RegExp(tchmi_escape_regex(expr.toString()),"g"),`%ctrl%${hostId}.${content}%/ctrl%`))}let regexpStringArr=[],replaces={};for(const ucId of ucIdArr)replaces['"'+ucId+'"']='"'+hostId+"."+ucId+'"',replaces[String.raw`\"`+ucId+String.raw`\"`]=String.raw`\"`+hostId+"."+ucId+String.raw`\"`,replaces['"'+ucId+"."]='"'+hostId+"."+ucId+".",replaces["'"+ucId+"'"]="'"+hostId+"."+ucId+"'",replaces["'"+ucId+"."]="'"+hostId+"."+ucId+".",regexpStringArr.push('"'+tchmi_escape_regex(ucId)+'"',tchmi_escape_regex(String.raw`\"`)+tchmi_escape_regex(ucId)+tchmi_escape_regex(String.raw`\"`),'"'+tchmi_escape_regex(ucId)+"\\.","'"+tchmi_escape_regex(ucId)+"'","'"+tchmi_escape_regex(ucId)+"\\.");let regexp=new RegExp(regexpStringArr.join("|"),"g");return markup=markup.replace(regexp,(substring,...args)=>substring in replaces?replaces[substring]:substring),{error:TcHmi.Errors.NONE,markup}}
import*as SystemCallback from"./Callback.js";import{Symbol as SystemSymbol}from"./Symbol.js";import{templateParamSymbolManager}from"./TemplateParamSymbolManager.js";import*as ValueConverter from"../API/ValueConverter.js";import{SymbolExpression}from"../API/SymbolExpression.js";import{Log}from"../API/Log.js";export class SymbolTypeTemplateParam extends TcHmi.Destroyable{constructor(symbol){super(),this.__symbol=symbol,this.__symbolExpressionString=this.__symbol.getExpression().toString(),this.__symbolDiagGUID=this.__symbol.getDiagGUID()}__symbol;__symbolExpressionString;__symbolDiagGUID;__printExpression(expression){let message=this.__symbolExpressionString;return expression?(this.__symbolExpressionString!==expression.toString()&&(message+=` (Resolved to: '${expression.toString()}')`),message):message}destroy(){this.isDestroyed()||(this.__releaseDestroyPrivilege(),this.isDestroyable()&&(this.__symbol=null))}read(expression,options,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}});const name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypeTemplateParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});let path=expression.getPath(),pathTokens=expression.getPathTokens(),entry=templateParamSymbolManager.get(name);if(entry&&entry.type){if(!(entry.value instanceof SymbolExpression)){if(pathTokens&&pathTokens.length>0)return void this.__symbol.__helper.readSubValue(expression,entry.value,pathTokens,name,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){let value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}})});{let value=tchmi_clone_object(entry.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression()})}}{let entrySymbolExpression=entry.value,entrySymbolTag=entrySymbolExpression.getTag(),entrySymbolName=entrySymbolExpression.getName(),entrySymbolPath=entrySymbolExpression.getPath(),entrySymbolExpressionNewString="%"+entrySymbolTag+"%";null!=entrySymbolName&&(entrySymbolExpressionNewString+=entrySymbolName),null!=entrySymbolPath&&(entrySymbolExpressionNewString+=entrySymbolPath),path&&pathTokens&&pathTokens.length>0&&(entrySymbolExpressionNewString+=path);let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;entrySymbolExpressionNewString+=(start?"|Start="+start:"")+(end?"|End="+end:""),entrySymbolExpressionNewString+="%/"+entrySymbolTag+"%";let entrySymbolNew=new SystemSymbol({expression:entrySymbolExpressionNewString,ctx:this.__symbol.getContext()});entrySymbolNew.read(data=>{this.__symbol?(data.error===TcHmi.Errors.NONE?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.value),expressionResolved:expression,expression:this.__symbol.getExpression()}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression}),entrySymbolNew?.destroy(),entrySymbolNew=null):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}})})}}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:this.__printExpression(expression)+": Unknown template parameter "+name,domain:"TcHmi.System.SymbolTypeTemplateParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}write(expression,value,options,dirtyPaths,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}});null===dirtyPaths&&(dirtyPaths=void 0);const name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypeTemplateParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});const path=expression.getPath(),pathTokens=expression.getPathTokens(),entry=templateParamSymbolManager.get(name);if(entry&&entry.type)if(entry.value instanceof SymbolExpression){let entrySymbolExpression=entry.value,entrySymbolTag=entrySymbolExpression.getTag(),entrySymbolName=entrySymbolExpression.getName(),entrySymbolPath=entrySymbolExpression.getPath(),entrySymbolExpressionNewString="%"+entrySymbolTag+"%";null!=entrySymbolName&&(entrySymbolExpressionNewString+=entrySymbolName),null!=entrySymbolPath&&(entrySymbolExpressionNewString+=entrySymbolPath),path&&pathTokens&&pathTokens.length>0&&(entrySymbolExpressionNewString+=path);let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;entrySymbolExpressionNewString+=(start?"|Start="+start:"")+(end?"|End="+end:""),entrySymbolExpressionNewString+="%/"+entrySymbolTag+"%";let entrySymbolNew=new SystemSymbol({expression:entrySymbolExpressionNewString,ctx:this.__symbol.getContext()});entrySymbolNew.writeEx(value,dirtyPaths,data=>{this.__symbol?(data.error===TcHmi.Errors.NONE?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.value),expressionResolved:expression,expression:this.__symbol.getExpression()}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression}),entrySymbolNew?.destroy(),entrySymbolNew=null):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}})})}else this.__symbol.__helper.resolveSchema(expression,dataResolveSchema=>{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}});if(dataResolveSchema&&dataResolveSchema.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:this.__printExpression(expression)+": Failed to resolve schema definition.",domain:"TcHmi.System.SymbolTypeTemplateParam",errors:dataResolveSchema.details?[dataResolveSchema.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression});let schema=this.__symbol.__helper.getSchema(),newValue=tchmi_clone_object(value),currentValue=tchmi_clone_object(entry.value),currentCloneValue=tchmi_clone_object(currentValue);if(path&&pathTokens&&pathTokens.length>0){let currentSubValue,currentSubValueErrorDetails,dirtyPathsNew=[];if(dirtyPaths&&dirtyPaths.length>0)for(let i=0,ii=dirtyPaths.length;i<ii;i++)dirtyPathsNew.push(path+dirtyPaths[i]);else dirtyPathsNew.push(path);if(this.__symbol.__helper.readSubValue(expression,currentCloneValue,pathTokens,name,data=>{this.__symbol?data.error===TcHmi.Errors.NONE?currentSubValue=tchmi_clone_object(data.value):currentSubValueErrorDetails={code:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR],reason:this.__printExpression(expression)+": Error while reading sub value.",domain:"TcHmi.System.SymbolTypeTemplateParam",errors:[data.details?data.details:{code:data.error,message:TcHmi.Errors[data.error]}]}:TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}})}),currentSubValueErrorDetails)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,details:currentSubValueErrorDetails,expression:this.__symbol.getExpression(),expressionResolved:expression});let prepValue=ValueConverter.toSchemaType(newValue,schema);if(null===prepValue&&null!==newValue){let reason,value=newValue;return reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+value+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".",void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.SymbolTypeTemplateParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}const write=(currentCloneValue,currentSubValue,newValue,pathTokens,name)=>{if(this.__symbol)return tchmi_equal(currentSubValue,newValue)?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(newValue),expression:this.__symbol.getExpression(),expressionResolved:expression},{equal:!0}):void this.__symbol.__helper.writeSubValue(expression,currentCloneValue,newValue,pathTokens,name,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){if(entry.value=currentCloneValue,SystemCallback.callSafeCallbacks1Param(entry.callbacks,this.__symbol,dirtyPathsNew&&dirtyPathsNew.length>0?{error:TcHmi.Errors.NONE,value:tchmi_clone_object(entry.value),dirtyPaths:dirtyPathsNew}:{error:TcHmi.Errors.NONE,value:tchmi_clone_object(entry.value)}),Array.isArray(newValue)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(tchmi_clone_object(newValue),start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:res.error,details:res.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(res.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(newValue),expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,details:{code:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR],reason:this.__printExpression(expression)+": Error while writing sub value.",domain:"TcHmi.System.SymbolTypeTemplateParam",errors:[data.details?data.details:{code:data.error,message:TcHmi.Errors[data.error]}]},expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}})});TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}})};if(Array.isArray(prepValue)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){if(Array.isArray(currentSubValue)){let newValue=tchmi_clone_object(currentSubValue),res=this.__symbol.__helper.writeArraySlice(newValue,prepValue,start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,res):void write(currentCloneValue,currentSubValue,newValue,pathTokens,name)}return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+": Failed to write value. Current value is not an array.",domain:"TcHmi.System.SymbolTypeTemplateParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}return void write(currentCloneValue,currentSubValue,prepValue,pathTokens,name)}return void write(currentCloneValue,currentSubValue,prepValue,pathTokens,name)}{let prepValue=ValueConverter.toSchemaType(newValue,schema);if(null===prepValue&&null!==newValue){let reason,value=newValue;return reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+value+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".",void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.SymbolTypeTemplateParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}const write=(currentValue,newValue)=>{if(this.__symbol)if(tchmi_equal(currentValue,newValue))TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(newValue),expressionResolved:expression,expression:this.__symbol.getExpression()},{equal:!0});else{if(entry.value=newValue,SystemCallback.callSafeCallbacks1Param(entry.callbacks,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(entry.value)}),Array.isArray(entry.value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(tchmi_clone_object(entry.value),start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:res.error,details:res.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(res.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(entry.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}})};if(Array.isArray(prepValue)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){if(Array.isArray(currentCloneValue)){let newValue=tchmi_clone_object(currentCloneValue),res=this.__symbol.__helper.writeArraySlice(newValue,prepValue,start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,res):void write(currentCloneValue,newValue)}return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+": Failed to write value. Current value is not an array.",domain:"TcHmi.System.SymbolTypeTemplateParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}return void write(currentCloneValue,prepValue)}return void write(currentCloneValue,prepValue)}});else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:this.__printExpression(expression)+": Unknown template parameter "+name,domain:"TcHmi.System.SymbolTypeTemplateParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}watch(expression,options,callback,reason){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}}),()=>{};let destroySubWatch,entrySymbolNew,diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid());let destroy=()=>{Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch destroy called.");let name=expression.getName();if(name){let entry=templateParamSymbolManager.get(name);entry&&entry.value instanceof SymbolExpression&&(templateParamSymbolManager.keepAlive(name)||templateParamSymbolManager.remove(name))}destroySubWatch&&(destroySubWatch(),destroySubWatch=null),entrySymbolNew&&(entrySymbolNew.destroy(),entrySymbolNew=null)};const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;let path=expression.getPath(),pathTokens=expression.getPathTokens(),entry=templateParamSymbolManager.get(name);if(!entry||!entry.type)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:this.__printExpression(expression)+": Unknown template parameter "+name,domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;if(entry.value instanceof SymbolExpression){entry.callbacks.push(callback);let entrySymbolExpression=entry.value,entrySymbolTag=entrySymbolExpression.getTag(),entrySymbolName=entrySymbolExpression.getName(),entrySymbolPath=entrySymbolExpression.getPath(),entrySymbolExpressionNewString="%"+entrySymbolTag+"%";null!=entrySymbolName&&(entrySymbolExpressionNewString+=entrySymbolName),null!=entrySymbolPath&&(entrySymbolExpressionNewString+=entrySymbolPath),path&&pathTokens&&pathTokens.length>0&&(entrySymbolExpressionNewString+=path);let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;entrySymbolExpressionNewString+=(start?"|Start="+start:"")+(end?"|End="+end:""),entrySymbolExpressionNewString+="%/"+entrySymbolTag+"%",entrySymbolNew=new SystemSymbol({expression:entrySymbolExpressionNewString,ctx:this.__symbol.getContext()}),destroySubWatch=entrySymbolNew.watch(data=>{this.__symbol?(destroySubWatch||(destroySubWatch=data.destroy),data.error===TcHmi.Errors.NONE?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.value),expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{destroy(),entrySymbolNew?.destroy()}}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:{code:data.error,message:TcHmi.Errors[data.error],reason:this.__printExpression(expression)+": Failed to watch subsymbol "+entrySymbolNew?.getExpression.toString(),domain:"TcHmi.System.Symbol",errors:data.details?[data.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{destroy(),entrySymbolNew?.destroy()}})):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}})})}else this.read(expression,null,data=>{this.__symbol?data.error===TcHmi.Errors.NONE?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.value),expressionResolved:expression,expression:this.__symbol.getExpression(),destroy}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeTemplateParam"}})});return destroy}}
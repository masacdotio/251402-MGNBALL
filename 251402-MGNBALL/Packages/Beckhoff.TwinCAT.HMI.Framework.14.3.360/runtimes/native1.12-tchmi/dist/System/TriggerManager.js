import{Symbol as SystemSymbol}from"./Symbol.js";import{Function}from"../API/Function.js";import{isFunctionExpression as IFunctionIsFunctionExpression}from"../API/_TypeGuards.IFunction.js";import{isFunctionExpression as TriggerIsFunctionExpression}from"../API/Trigger.js";import{FunctionExpression}from"./FunctionExpression.js";import{SymbolExpression}from"../API/SymbolExpression.js";import{config,Data}from"./System.js";import{templateParamSymbolManager}from"./TemplateParamSymbolManager.js";import{controlManager}from"./ControlManager.js";import*as ValueConverter from"../API/ValueConverter.js";import{getSchema}from"../API/Type.js";import{Log}from"../API/Log.js";import{gIsolatedEval_TcHmi_System_TriggerManager_ConditionExpressionsResult,gIsolatedEval_TcHmi_System_TriggerManager_JavaScriptAction}from"./EvalIsolation.js";export class TriggerManager{constructor(){}__resolveValue(ctx,value,targetSchema){if(value)switch(value.objectType){case"StaticValue":let prepValue=value.value;if(targetSchema){let convertedValue=ValueConverter.toSchemaType(prepValue,targetSchema);null!=convertedValue&&(prepValue=convertedValue)}ctx.success(prepValue);break;case"Symbol":if(!value.symbolExpression)return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'Property: "symbolExpression" within an object of type: "IFunction.Value" with object type: "Symbol" must not be empty, "null" or "undefined".',domain:"TcHmi.System.TriggerManager"});let s=null;try{s=new TcHmi.Symbol({expression:value.symbolExpression,ctx})}catch(e){return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'An uncaught exception occurred while reading symbol: "'+value.symbolExpression+'".',exception:e,domain:"TcHmi.System.TriggerManager"})}if(null==s)return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'Failed to create instance of "TcHmi.Symbol" while reading symbol "'+value.symbolExpression+'".',domain:"TcHmi.System.TriggerManager"});if(targetSchema&&"TcHmi.Symbol"===targetSchema.frameworkInstanceOf)ctx.success(s);else try{s.readEx(data=>{if(data.error===TcHmi.Errors.NONE){let prepValue=data.value;if(targetSchema){let convertedValue=ValueConverter.toSchemaType(prepValue,targetSchema);null!=convertedValue&&(prepValue=convertedValue)}ctx.success(prepValue)}else ctx.error(data.error,data.details);s?.destroy(),s=null})}catch(e){return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'An uncaught exception occurred while reading symbol "'+value.symbolExpression+'".',exception:e,domain:"TcHmi.System.TriggerManager"})}break;case"FunctionExpression":if(IFunctionIsFunctionExpression(value)){let func=new FunctionExpression(value.functionExpression);try{let bContextLock=!1;func.execute({...ctx,success:result=>{if(bContextLock)return;bContextLock=!0;let prepValue=result;if(targetSchema){let convertedValue=ValueConverter.toSchemaType(prepValue,targetSchema);null!=convertedValue&&(prepValue=convertedValue)}ctx.success(prepValue),func.destroy()},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details),func.destroy())}})}catch(e){ctx.error(TcHmi.Errors.E_TRIGGER_FUNCTION_EXPRESSION_EXCEPTION,{code:TcHmi.Errors.E_TRIGGER_FUNCTION_EXPRESSION_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_TRIGGER_FUNCTION_EXPRESSION_EXCEPTION],reason:'An uncaught exception occurred while executing FunctionExpression: "'+value.functionExpression+'".',exception:e,domain:"TcHmi.System.TriggerManager"})}}else ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.TriggerManager"});break;default:ctx.error(TcHmi.Errors.E_NOT_SUPPORTED,{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],domain:"TcHmi.System.TriggerManager"})}else ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'An object of type: "IFunction.Value" must not be "null" or "undefined".',domain:"TcHmi.System.TriggerManager"})}__resolveValueAsArray(ctx,values){let res=[];if(!values||0===values.length)return void ctx.success(res);let l=values.length,c=0,proc=()=>{let value=values[c],bContextLock=!1;this.__resolveValue({...ctx,success:result=>{bContextLock||(bContextLock=!0,res.push(result),c===l-1?ctx.success(res):(c++,proc()))},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details))}},value.value,value.targetSchema)};proc()}__resolveConditionExpressionsResult(ctx,expressions){let hasError=!1,results=[],pendingExpressionCompares=2*expressions.length,resolveExpressionCompareResult=(resultObject,compareName)=>{let bContextLock=!1;this.__resolveValue({...ctx,success:result=>{bContextLock||(bContextLock=!0,hasError||(resultObject.result[compareName]=result,pendingExpressionCompares--,0===pendingExpressionCompares&&(()=>{let sEval="";sEval+="(";for(let i=0,ii=results.length;i<ii;i++)null!==results[i].expression.logic&&"OR"!==results[i].expression.logic||(sEval+="("),"=="===results[i].expression.compareOperator||"==="===results[i].expression.compareOperator?(sEval+="tchmi_equal(",sEval+="results["+i+"].result.compare1",sEval+=",",sEval+="results["+i+"].result.compare2",sEval+=",false)"):"!="===results[i].expression.compareOperator||"!=="===results[i].expression.compareOperator?(sEval+="!tchmi_equal(",sEval+="results["+i+"].result.compare1",sEval+=",",sEval+="results["+i+"].result.compare2",sEval+=",false)"):(sEval+="(",sEval+="results["+i+"].result.compare1",sEval+=results[i].expression.compareOperator,sEval+="results["+i+"].result.compare2",sEval+=")"),void 0!==results[i+1]?"AND"===results[i+1].expression.logic?sEval+=" && ":"OR"===results[i+1].expression.logic&&(sEval+=") || "):sEval+=")";sEval+=")";let res=!1;try{res=gIsolatedEval_TcHmi_System_TriggerManager_ConditionExpressionsResult(sEval,results)}catch(e){ctx.error(TcHmi.Errors.E_EXCEPTION,{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:"An uncaught exception occurred in the processing of "+sEval,exception:e,domain:"TcHmi.System.TriggerManager"})}ctx.success(res)})()))},error:(error,details)=>{bContextLock||(bContextLock=!0,hasError=!0,ctx.error(error,details))}},resultObject.expression[compareName])};for(let i=0,ii=expressions.length;i<ii&&!hasError;i++){let resultObject={expression:expressions[i],result:{compare1:void 0,compare2:void 0}};results[i]=resultObject,resolveExpressionCompareResult(resultObject,"compare1"),resolveExpressionCompareResult(resultObject,"compare2")}}__taControlApiFunction(ctx,action,diagGUID){Log.debugEx("[Source=Framework, Module=TcHmi.System.TriggerManager, LogicalScopeDiagGUID="+diagGUID+"] __taControlApiFunction called with:",{ctx,action});let f=action;const control=f.control,fn=f.fn;if(null==control)throw new Error('Property: "control" is missing in object of type: TcHmi.Trigger.ControlApiFunction');if(null==fn)throw new Error('Property: "fn" is missing in object of type: TcHmi.Trigger.ControlApiFunction');let tco=null,isSymbolExpression=TcHmi.Symbol.isSymbolExpression(f.control),isSymbolExpressionEscaped=TcHmi.Symbol.isSymbolExpressionEscaped(f.control);if(isSymbolExpression&&!isSymbolExpressionEscaped){let se=new SymbolExpression(f.control);tco=TcHmi.Controls.get(se.getName())}else tco=TcHmi.Controls.get(f.control);if(null==tco)throw new Error("Can not find instance of control width id: '"+control+"'.");let descr=controlManager.getDescription(tco.getType());if(!descr)throw new Error("Can not find description for control type: '"+tco.getType()+"'.");const funcObj=tco[fn];if("function"!=typeof funcObj)throw new Error('Can not find function with name: "'+fn+'" in instance of control with id: '+control);let fnDescr=null;if(descr.inheritedFunctions)for(let i=0,ii=descr.inheritedFunctions.length;i<ii;i++){let descrFunction=descr.inheritedFunctions[i];if(descrFunction.name===fn){fnDescr=descrFunction;break}}if(!fnDescr)throw new Error("Can't find description of function: \""+fn+'" in description of control type: '+tco.getType());let params=[];if(f.fnParams&&f.fnParams.length>0)for(let i=0,ii=f.fnParams.length;i<ii;i++){let paramDescrIndex=i;fnDescr&&!0===fnDescr.injectContextObject&&paramDescrIndex++;let typeSchema=null;fnDescr.params&&fnDescr.params[paramDescrIndex]&&fnDescr.params[paramDescrIndex].type&&(typeSchema=getSchema(fnDescr.params[paramDescrIndex].type)),params.push(typeSchema?{value:f.fnParams[i],targetSchema:typeSchema}:{value:f.fnParams[i]})}let bContextLock=!1;this.__resolveValueAsArray({...ctx,success:result=>{if(bContextLock)return;bContextLock=!0;let res,process=!0,wait=!1,params=[];if(fnDescr&&!0===fnDescr.injectContextObject)if("Asynchronous"===fnDescr.waitMode){wait=!0;let bContextLock2=!1;params.push({success:result=>{bContextLock2||(bContextLock2=!0,process&&ctx.success(result))},error:(error,details)=>{bContextLock2||(bContextLock2=!0,process&&ctx.error(error,details))}})}else params.push({args:ctx.args});result&&params.push(...result);try{res=funcObj.call(tco,...params)}catch(e){process=!1,ctx.error(TcHmi.Errors.E_EXCEPTION,{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:"An uncaught exception occurred in the control function of "+tco?.getId()+"."+action.fn,exception:e,domain:"TcHmi.System.TriggerManager"})}!wait&&process&&ctx.success(res)},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details))}},params)}__taWriteToSymbol(ctx,action,diagGUID){if(Log.debugEx("[Source=Framework, Module=TcHmi.System.TriggerManager, LogicalScopeDiagGUID="+diagGUID+"] __taWriteToSymbol called with:",{ctx,action}),!action.symbolExpression)return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'Property: "symbolExpression" within an object of type "TcHmi.Trigger.WriteToSymbol" must not be empty, "null" or "undefined".',domain:"TcHmi.System.TriggerManager"});let s=new SystemSymbol({expression:action.symbolExpression,ctx});s.resolveSchema(data=>{let bContextLock=!1;this.__resolveValue({...ctx,success:result=>{bContextLock||(bContextLock=!0,s?.write(result,data=>{data.error===TcHmi.Errors.NONE?ctx.success():ctx.error(data.error,data.details),s?.destroy(),s=null}))},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details))}},action.value,data.schema)})}__taFunction(ctx,action,diagGUID){if(Log.debugEx("[Source=Framework, Module=TcHmi.System.TriggerManager, LogicalScopeDiagGUID="+diagGUID+"] __taFunction called with:",{ctx,action}),null==action)return;let def={objectType:"Function",active:action.active,fn:action.fn,fnParams:action.fnParams};new Function(def).executeEx2({...ctx,success:result=>{ctx.success(result)},error:(error,details)=>{ctx.error(error,details)}})}__taActionTemplate(ctx,action,diagGUID){if(Log.debugEx("[Source=Framework, Module=TcHmi.System.TriggerManager, LogicalScopeDiagGUID="+diagGUID+"] __taActionTemplate called with:",{ctx,action}),null!=action){let tn=action.templateName;if(null==tn||""===tn||"string"!=typeof tn)return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'Property: "templateName" in object of type "TcHmi.Trigger.ActionTemplate" is invalid. Value must be a valid string with a length of at least one character.',domain:"TcHmi.System.TriggerManager"});if(null==config)return void ctx.error(TcHmi.Errors.E_INVALID,{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:'TcHmi.System.config is not a valid object of type: "IConfig".',domain:"TcHmi.System.TriggerManager"});let at=null;if(tn.startsWith("Package:")){let tnToken=tn.split(";");if(tnToken&&tnToken.length>1){let pkgSource=tnToken[0],pkgTn=tnToken[1],tnSourceToken=pkgSource.split(":");if(tnSourceToken&&tnSourceToken.length>1){let pkgId=tnSourceToken[1];if(pkgId){let pkg=Data.packages.get(pkgId);if(pkg&&pkg.manifest&&pkg.manifest.actionTemplates&&pkg.manifest.actionTemplates.length>0)for(let i=0,ii=pkg.manifest.actionTemplates.length;i<ii&&(at=pkg.manifest.actionTemplates[i],at.name!==pkgTn);i++)at=null}}}}else for(let i=0,ii=config.actionTemplates.length;i<ii&&(at=config.actionTemplates[i],at.name!==tn);i++)at=null;if(null===at)return void ctx.error(TcHmi.Errors.E_INVALID,{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:'Can not find action template with name: "'+tn+'" in configuration. Please check tchmiconfig.json',domain:"TcHmi.System.TriggerManager"});const iGuid=tchmi_create_guid();let hasError=!1,params=at.parameters;const cleanUpParams=()=>{if(params&&params.length)for(let i=0,ii=params.length;i<ii;i++){let p=params[i];if(!p.name)continue;let name=iGuid+"."+p.name;templateParamSymbolManager.keepAlive(name)||templateParamSymbolManager.remove(name)}};let fnParams=action.fnParams;for(let i=0,ii=params.length;i<ii;i++){let p=params[i];if(!p.name)continue;let name=iGuid+"."+p.name,fnParam=fnParams[i];if(TcHmi.IFunction.isSymbol(fnParam)){let expression;try{expression=new SymbolExpression(fnParam.symbolExpression)}catch(e){ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'Property: "symbolExpression" in object of type "TcHmi.Trigger.ActionTemplate" with templateName: "'+action.templateName+'" is no valid symbol expression. Processing will be aborted.',exception:e,domain:"TcHmi.System.TriggerManager"}),hasError=!0;break}templateParamSymbolManager.add(name,p.type,expression)}else{if(!TcHmi.IFunction.isStaticValue(fnParam)){if(fnParam){ctx.error(TcHmi.Errors.ERROR,{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:'Unknown objectType: "'+fnParam.objectType+'" in parameter in property: "fnParam" in object of type "TcHmi.Trigger.ActionTemplate" with templateName: "'+action.templateName+'". Supported objectTypes are "Symbol" and "StaticValue". Processing will be aborted.',domain:"TcHmi.System.TriggerManager"}),hasError=!0;break}ctx.error(TcHmi.Errors.ERROR,{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:'Missing property: "fnParam" in object of type "TcHmi.Trigger.ActionTemplate" with templateName: "'+action.templateName+'". Processing will be aborted.',domain:"TcHmi.System.TriggerManager"}),hasError=!0;break}templateParamSymbolManager.add(name,p.type,fnParam.value)}}if(hasError)ctx.error(TcHmi.Errors.ERROR,{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.TriggerManager"}),cleanUpParams();else{let aCloneString=JSON.stringify(at.actions);for(let i=0,ii=params.length;i<ii;i++){let p=params[i];p.name&&(aCloneString=aCloneString.replace(new RegExp(tchmi_escape_regex("%tp%"+p.name),"g"),"%tp%"+iGuid+"."+p.name))}let aClone=ValueConverter.toObject(aCloneString);if(null===aClone)ctx.error(TcHmi.Errors.ERROR,{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Failed to reparse json for scoped action in action template.",domain:"TcHmi.System.TriggerManager"});else try{let bContextLock=!1;this.processActionList({...ctx,success:_result=>{bContextLock||(bContextLock=!0,ctx.success(),cleanUpParams())},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details),cleanUpParams())}},aClone,diagGUID)}catch(e){ctx.error(TcHmi.Errors.E_EXCEPTION,{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:"An uncaught exception occurred in the processing of the "+action.templateName,exception:e,domain:"TcHmi.System.TriggerManager"})}}}}__taFunctionExpression(ctx,action,diagGUID){if(Log.debugEx("[Source=Framework, Module=TcHmi.System.TriggerManager, LogicalScopeDiagGUID="+diagGUID+"] __taFunctionExpression called with action:",{ctx,action}),!TriggerIsFunctionExpression(action))return;if(!action.functionExpression)return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:"functionExpression was empty",domain:"TcHmi.System.TriggerManager"});let func=new FunctionExpression(action.functionExpression),bContextLock=!1;func.execute({...ctx,success:result=>{bContextLock||(bContextLock=!0,ctx.success(result),func.destroy())},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details),func.destroy())}})}__taJavaScript(ctx,action,diagGUID){if(Log.debugEx("[Source=Framework, Module=TcHmi.System.TriggerManager, LogicalScopeDiagGUID="+diagGUID+"] __taJavaScript called with:",{ctx,action}),!TcHmi.Trigger.isJavaScript(action))return;let sEval="";if(Array.isArray(action.sourceLines)){for(const sourceLine of action.sourceLines)sEval+=tchmi_decode_control_characters(sourceLine,{preserveBackslash:!0})+"\n";try{let bContextLock=!1;gIsolatedEval_TcHmi_System_TriggerManager_JavaScriptAction({...ctx,success:()=>{bContextLock||(bContextLock=!0,"Asynchronous"===action.waitMode&&ctx.success())},error:(error,details)=>{bContextLock||(bContextLock=!0,"Asynchronous"===action.waitMode&&ctx.error(error,details))}},sEval),"Asynchronous"!==action.waitMode&&ctx.success()}catch(e){"Asynchronous"!==action.waitMode&&ctx.error(TcHmi.Errors.E_TRIGGER_JAVASCRIPT_EVAL_EXCEPTION,{code:TcHmi.Errors.E_TRIGGER_JAVASCRIPT_EVAL_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_TRIGGER_JAVASCRIPT_EVAL_EXCEPTION],reason:"An uncaught exception occurred in the processing of a JavaScript action",exception:e,domain:"TcHmi.System.TriggerManager"})}}else ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'Invalid property: "sourceLines" in obect of type "TcHmi.Trigger.JavaScript". Expected an array of strings.',domain:"TcHmi.System.TriggerManager"})}__taCondition(ctx,condition,diagGUID){if(Log.debugEx("[Source=Framework, Module=TcHmi.System.TriggerManager, LogicalScopeDiagGUID="+diagGUID+"] __taCondition called with:",{ctx,condition}),!condition)return void ctx.error(TcHmi.Errors.E_TRIGGER_CONDITION_INVALID,{code:TcHmi.Errors.E_TRIGGER_CONDITION_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_TRIGGER_CONDITION_INVALID],reason:'Object of type "TcHmi.Trigger.Condition" must not be null or undefined.',domain:"TcHmi.System.TriggerManager"});let parts=condition.parts;if(!parts)return void ctx.error(TcHmi.Errors.E_TRIGGER_CONDITION_INVALID,{code:TcHmi.Errors.E_TRIGGER_CONDITION_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_TRIGGER_CONDITION_INVALID],reason:'Object of type "TcHmi.Trigger.Condition" requires at least a property with name "part" which is an array with one object which contains a property named "if" with a value of type "TcHmi.Trigger.Expression".',domain:"TcHmi.System.TriggerManager"});if(0===parts.length)return void ctx.success();let processedIf=!1,i=0,proc=ctx=>{let expressions,followingActions,part=parts[i];if(part){if(i++,"if"in part&&void 0!==part.if)expressions=part.if,followingActions=part.then,processedIf=!0;else if("elseif"in part&&void 0!==part.elseif){if(expressions=part.elseif,followingActions=part.then,!processedIf)return void ctx.error(TcHmi.Errors.E_TRIGGER_CONDITION_INVALID,{code:TcHmi.Errors.E_TRIGGER_CONDITION_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_TRIGGER_CONDITION_INVALID],reason:'Part "elseif" must not be defined before part "if".',domain:"TcHmi.System.TriggerManager"})}else if("else"in part&&void 0!==part.else&&(followingActions=part.else,!processedIf))return void ctx.error(TcHmi.Errors.E_TRIGGER_CONDITION_INVALID,{code:TcHmi.Errors.E_TRIGGER_CONDITION_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_TRIGGER_CONDITION_INVALID],reason:'Part "else" must not be defined before part "if".',domain:"TcHmi.System.TriggerManager"});try{let bContextLock=!1;expressions&&followingActions?this.__resolveConditionExpressionsResult({...ctx,success:result=>{bContextLock||(bContextLock=!0,!0===result?this.processActionList({...ctx,success:_result=>{ctx.success()},error:(_error,_details)=>{ctx.success()}},followingActions,diagGUID):proc({...ctx,success:_result=>{ctx.success()},error:(error,details)=>{ctx.error(error,details)}}))},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details))}},expressions):expressions&&!followingActions?this.__resolveConditionExpressionsResult({...ctx,success:result=>{bContextLock||(bContextLock=!0,!0===result?ctx.success():proc({...ctx,success:_result=>{ctx.success()},error:(error,details)=>{ctx.error(error,details)}}))},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details))}},expressions):!expressions&&followingActions?this.processActionList({...ctx,success:_result=>{ctx.success()},error:(_error,_details)=>{ctx.success()}},followingActions,diagGUID):ctx.error(TcHmi.Errors.E_TRIGGER_CONDITION_INVALID,{code:TcHmi.Errors.E_TRIGGER_CONDITION_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_TRIGGER_CONDITION_INVALID],reason:"Condition definition is invalid because it contains no expressions and no following actions.",domain:"TcHmi.System.TriggerManager"})}catch(e){ctx.error(TcHmi.Errors.E_TRIGGER_RESOLVE_CONDITION_EXPRESSION_EXCEPTION,{code:TcHmi.Errors.E_TRIGGER_RESOLVE_CONDITION_EXPRESSION_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_TRIGGER_RESOLVE_CONDITION_EXPRESSION_EXCEPTION],reason:"An uncaught exception occurred in the processing of a condition",exception:e,domain:"TcHmi.System.TriggerManager"})}}else ctx.success()};proc({...ctx,success:_result=>{ctx.success()},error:(error,details)=>{ctx.error(error,details)}})}__taSwitchCase(ctx,switchCase,diagGUID){if(Log.debugEx("[Source=Framework, Module=TcHmi.System.TriggerManager, LogicalScopeDiagGUID="+diagGUID+"] __taSwitchCase called with:",{ctx,switchCase}),null==switchCase)return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'Object of type "TcHmi.Trigger.SwitchCase" must not be null or undefined.',domain:"TcHmi.System.TriggerManager"});let comp=switchCase.compare;if(null==comp)return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'Object of type "TcHmi.Trigger.SwitchCase" requires a property: "compare" which must not be null or undefined.',domain:"TcHmi.System.TriggerManager"});let cases=switchCase.cases;if(null==cases)return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'Object of type "TcHmi.Trigger.SwitchCase" requires a property: "cases" which must not be null or undefined.',domain:"TcHmi.System.TriggerManager"});let cpv,dc=null;void 0!==switchCase.caseDefault&&null!==switchCase.caseDefault&&(dc=switchCase.caseDefault);let proc=()=>{let resultByCase=new WeakMap,pending=cases.length,finalize=()=>{if(pending>0)return;let error=null,tc=null;for(let i=0,ii=cases.length;i<ii;i++){let c=cases[i],res=resultByCase.get(c);if(!res){error={code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.TriggerManager"};break}if(res.error!==TcHmi.Errors.NONE){error=res.details?res.details:{code:res.error,message:TcHmi.Errors[res.error],domain:"TcHmi.System.TriggerManager"};break}if(tchmi_equal(res.value,cpv,!1)&&(tc=c),null!==tc)break}error?ctx.error(error.code,error):null!==tc?this.processActionList({...ctx,success:()=>{ctx.success(TcHmi.Errors.NONE)},error:()=>{ctx.success(TcHmi.Errors.NONE)}},tc.actions,diagGUID):null!==dc&&this.processActionList({...ctx,success:()=>{ctx.success(TcHmi.Errors.NONE)},error:()=>{ctx.success(TcHmi.Errors.NONE)}},dc.actions,diagGUID)};for(let i=0,ii=cases.length;i<ii;i++){const c=cases[i];if(null==c){resultByCase.set(c,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:'Property: "cases" in object of type: "TcHmi.Trigger.SwitchCase" must not contain entries which are null or undefined.',domain:"TcHmi.System.TriggerManager"}}),pending--,finalize();continue}const cv=c.caseValue;if(null!=cv)switch(cv.objectType){case"StaticValue":resultByCase.set(c,{error:TcHmi.Errors.NONE,value:cv.value}),pending--,finalize();break;case"Symbol":let symbol;try{symbol=new SystemSymbol({expression:cv.symbolExpression,ctx})}catch(e){}symbol?symbol.read(data=>{data.error===TcHmi.Errors.NONE?resultByCase.set(c,{error:TcHmi.Errors.NONE,value:data.value}):resultByCase.set(c,{error:data.error,details:data.details}),pending--,finalize(),symbol?.destroy()}):(resultByCase.set(c,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:'SymbolExpression "'+cv.symbolExpression+'" is not valid.',domain:"TcHmi.System.TriggerManager"}}),pending--,finalize());break;default:resultByCase.set(c,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:'Object type: "'+cv.objectType+'" is not supported in switch case. Please use objects of type: "StaticValue" or symbols.',domain:"TcHmi.System.TriggerManager"}}),pending--,finalize()}else resultByCase.set(c,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.TriggerManager"}}),pending--,finalize()}},bContextLock=!1;this.__resolveValue({...ctx,success:result=>{bContextLock||(bContextLock=!0,cpv=result,proc())},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details))}},comp)}__processAction(ctx,action,diagGUID){if(!1===action.active)return void ctx.success();let bContextLock=!1,ctx2={...ctx,success:_result=>{if(bContextLock)return;bContextLock=!0;let bContextLock2=!1;this.processActionList({...ctx,success:result=>{bContextLock2||(bContextLock2=!0,ctx.success(result))},error:(error,details)=>{bContextLock2||(bContextLock2=!0,ctx.error(error,details))}},action.success,diagGUID)},error:(error,details)=>{if(bContextLock)return;bContextLock=!0,details?details.exception?Log.errorEx(`[Source=Framework, Module=TcHmi.System.TriggerManager${ctx.event?`, Event=${ctx.event.name}`:""}, ObjectType=${action.objectType}] ${Log.buildMessage(details)}\nException:`,details.exception):Log.errorEx(`[Source=Framework, Module=TcHmi.System.TriggerManager${ctx.event?`, Event=${ctx.event.name}`:""}, ObjectType=${action.objectType}] ${Log.buildMessage(details)}`):Log.error(`[Source=Framework, Module=TcHmi.System.TriggerManager${ctx.event?`, Event=${ctx.event.name}`:""}, ObjectType=${action.objectType}] ${Log.buildMessage({code:error,message:TcHmi.Errors[error]})}`);let bContextLock2=!1;this.processActionList({...ctx,success:result=>{bContextLock2||(bContextLock2=!0,ctx.success(result))},error:(error,details)=>{bContextLock2||(bContextLock2=!0,ctx.error(error,details))}},action.error,diagGUID)}};try{switch(action.objectType){case"Condition":this.__taCondition(ctx2,action,diagGUID);break;case"SwitchCase":this.__taSwitchCase(ctx2,action,diagGUID);break;case"ControlApiFunction":this.__taControlApiFunction(ctx2,action,diagGUID);break;case"WriteToSymbol":this.__taWriteToSymbol(ctx2,action,diagGUID);break;case"Function":this.__taFunction(ctx2,action,diagGUID);break;case"JavaScript":this.__taJavaScript(ctx2,action,diagGUID);break;case"ActionTemplate":this.__taActionTemplate(ctx2,action,diagGUID);break;case"FunctionExpression":this.__taFunctionExpression(ctx2,action,diagGUID);break;case"Comment":ctx.success();break;default:ctx.error(TcHmi.Errors.E_NOT_SUPPORTED,{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],reason:'Object type: "'+action.objectType+'" is not supported.',domain:"TcHmi.System.TriggerManager"})}}catch(e){Log.errorEx(`[Source=Framework, Module=TcHmi.System.TriggerManager${ctx.event?`, Event=${ctx.event.name}`:""}, ObjectType=${action.objectType}] Threw an exception:`,e),ctx.error(TcHmi.Errors.E_TRIGGER_ACTION_EXCEPTION,{code:TcHmi.Errors.E_TRIGGER_ACTION_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_TRIGGER_ACTION_EXCEPTION],reason:"An uncaught exception occurred in a __processAction call",exception:e,domain:"TcHmi.System.TriggerManager"})}}processActionList(ctx,actions,diagGUID){if(!actions)return void ctx.success();let l=actions.length;if(0===l)return void ctx.success();let c=0,proc=()=>{let action=actions[c],next=()=>{c===l-1?ctx.success():(c++,proc())},bContextLock=!1;this.__processAction({...ctx,success:()=>{bContextLock||(bContextLock=!0,(void 0===action.asyncWait||action.asyncWait)&&next())},error:(_error,details)=>{bContextLock||(bContextLock=!0,(void 0===action.asyncWait||action.asyncWait)&&next())}},action,diagGUID),void 0===action.asyncWait||action.asyncWait||next()};proc()}__createTriggerEventHandler(trigger){return(event,...data)=>{let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=TcHmi.System.TriggerManager, LogicalScopeDiagGUID="+diagGUID+"] __onTriggerEvent called with:",{event,data});const nativeEventObj=data?.[0];!0===trigger.preventDefault&&"function"==typeof nativeEventObj?.preventDefault&&(Log.debug("[Source=Framework, Module=TcHmi.System.TriggerManager, LogicalScopeDiagGUID="+diagGUID+'] __onTriggerEvent calling data.preventDefault() because "trigger.preventDefault === true".'),nativeEventObj.preventDefault()),this.processActionList({success:()=>{},error:(_error,_details)=>{},trigger,event,args:data,owner:trigger.ctx?.owner},trigger.actions,diagGUID)}}register(triggerArr){if(TCHMI_DESIGNER)return()=>{};if(!triggerArr)return()=>{};let destroyTriggerEvents=[];for(const trigger of triggerArr)"string"==typeof trigger.event&&Array.isArray(trigger.actions)&&destroyTriggerEvents.push(TcHmi.EventProvider.register(trigger.event,this.__createTriggerEventHandler(trigger),trigger.preventDefault?{passive:!1,capture:!1}:void 0,{ctx:trigger.ctx}));return()=>{destroyTriggerEvents.forEach(destroy=>{destroy()}),destroyTriggerEvents=[]}}}export const triggerManager=new TriggerManager;
import{frameworkLocalization}from"./Locale.js";import{config,Init}from"./System.js";import*as Server from"../API/Server.js";import*as Domains from"../API/Server.Domains.js";import*as ServerEvents from"../API/Server.Events.js";import*as TopMostLayer from"../API/TopMostLayer.js";import{EventProvider}from"../API/EventProvider.js";import{Log}from"../API/Log.js";let TcSpeechManager=(()=>{var _a,_b,_c,_d,_e,_f;let ___handlingNewIce_decorators,___handlingNewTrack_decorators,___handlingNegotiationneeded_decorators,___handlingIceError_decorators,___registerClientConfig_decorators,___writeValueDebugOutput_decorators,_instanceExtraInitializers=[];return class{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___handlingNewIce_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___handlingNewTrack_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___handlingNegotiationneeded_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],___handlingIceError_decorators=[(_d=TcHmi).CallbackMethod.bind(_d)],___registerClientConfig_decorators=[(_e=TcHmi).CallbackMethod.bind(_e)],___writeValueDebugOutput_decorators=[(_f=TcHmi).CallbackMethod.bind(_f)],__esDecorate(this,null,___handlingNewIce_decorators,{kind:"method",name:"__handlingNewIce",static:!1,private:!1,access:{has:obj=>"__handlingNewIce"in obj,get:obj=>obj.__handlingNewIce},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___handlingNewTrack_decorators,{kind:"method",name:"__handlingNewTrack",static:!1,private:!1,access:{has:obj=>"__handlingNewTrack"in obj,get:obj=>obj.__handlingNewTrack},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___handlingNegotiationneeded_decorators,{kind:"method",name:"__handlingNegotiationneeded",static:!1,private:!1,access:{has:obj=>"__handlingNegotiationneeded"in obj,get:obj=>obj.__handlingNegotiationneeded},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___handlingIceError_decorators,{kind:"method",name:"__handlingIceError",static:!1,private:!1,access:{has:obj=>"__handlingIceError"in obj,get:obj=>obj.__handlingIceError},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___registerClientConfig_decorators,{kind:"method",name:"__registerClientConfig",static:!1,private:!1,access:{has:obj=>"__registerClientConfig"in obj,get:obj=>obj.__registerClientConfig},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___writeValueDebugOutput_decorators,{kind:"method",name:"__writeValueDebugOutput",static:!1,private:!1,access:{has:obj=>"__writeValueDebugOutput"in obj,get:obj=>obj.__writeValueDebugOutput},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){this.init()}init(){this.__currentConfig={enableMicrophone:!1,enableSpeaker:!1,defaultVolume:1,confidenceThreshold:.2,domain:"TcHmiSpeech"},this.__peerData={options:{},callback:null,clientState:0,audioElement:document.createElement("audio"),localSocketId:0,localSdp:"",localIceCandidates:[],remoteSocketId:0,remoteSdp:"",remoteVersion:"",remoteIceCandidate:[],remotePendingIceCandidate:[]},TCHMI_DESIGNER||(EventProvider.register("System.EventProvider.onRegisterCallback",(e,data)=>{let name=data.name;name.endsWith(">")&&name.startsWith("SpeechOnCommand<")&&this.__addUsedSpeechTrigger(name)}),EventProvider.register("System.EventProvider.onDestroyedCallback",(e,data)=>{let name=data.name;name.endsWith(">")&&name.startsWith("SpeechOnCommand<")&&this.__removeUsedSpeechTrigger(name)}),Init.initializedBaseConfig.then(()=>{this.__currentConfig.enableMicrophone=config.tcSpeech?.enableMicrophone??!1,this.__currentConfig.enableSpeaker=config.tcSpeech?.enableSpeaker??!1,this.__currentConfig.defaultVolume=config.tcSpeech?.defaultVolume??1,this.__currentConfig.confidenceThreshold=config.tcSpeech?.confidenceThreshold??.2,this.__currentConfig.domain=config.tcSpeech?.domain??"TcHmiSpeech"}),Init.initialized.then(()=>{(this.__currentConfig.enableSpeaker||this.__currentConfig.enableMicrophone)&&0===this.__peerData.clientState&&this.openConnection()}))}__currentConfig=__runInitializers(this,_instanceExtraInitializers);__restartServerEventListening(){Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Restarting all event listeners in the speech extension for our socket id "+this.__peerData.localSocketId+". (connection state is: "+this.__peerConnection.connectionState+", signaling state is: "+this.__peerConnection.signalingState+")"),this.__commandDestroyFnc?.(),this.__commandDestroyFnc=ServerEvents.registerConsumer([{path:"domain",comparator:"==",value:this.__currentConfig.domain},{logic:"AND"},{path:"name",comparator:"==",value:"COMMAND_RECEIVED"},{logic:"AND"},{path:"payload::RemoteSocketId",comparator:"==",value:this.__peerData.localSocketId}],{subscription:data=>{if(data.error)return;const evt=data.event;if(ServerEvents.isPayload(evt)&&evt.payload)switch(evt.payload.Command.Type){case"LogOnClientCommand":if(TCHMI_CONSOLE_LOG_LEVEL>=evt.payload.Command.Severity||TCHMI_PERSISTENT_LOG_LEVEL>=evt.payload.Command.Severity)switch(evt.payload.Command.Severity){case 1:Log.errorEx("[Source=TwinCAT Speech Core]",...evt.payload.Command.MessageParts);break;case 2:Log.warnEx("[Source=TwinCAT Speech Core]",...evt.payload.Command.MessageParts);break;case 3:Log.infoEx("[Source=TwinCAT Speech Core]",...evt.payload.Command.MessageParts);break;case 4:Log.debugEx("[Source=TwinCAT Speech Core]",...evt.payload.Command.MessageParts)}break;case"DetectedCommand":if(evt.payload.Command.Confidence&&!isNaN(this.__currentConfig.confidenceThreshold)&&evt.payload.Command.Confidence<this.__currentConfig.confidenceThreshold)return void Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Detected event %o skipped because its confidence %o is below configured threshold %o",evt.payload.Command.DetectedCommand,evt.payload.Command.Confidence.toFixed(2),this.__currentConfig.confidenceThreshold.toFixed(2));let EventProviderParam={Command:evt.payload.Command.DetectedCommand,Confidence:evt.payload.Command.Confidence,Parameter:evt.payload.Command.Parameter};EventProvider.raise("SpeechOnCommand<"+evt.payload.Command.DetectedCommand+">",EventProviderParam),Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Raised event %o with param %o","SpeechOnCommand<"+evt.payload.Command.DetectedCommand+">",EventProviderParam);break;case"SpeechSynthesisStatus":Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Received event for ISpeechSynthesisStatus\n",evt.payload.Command);let command=evt.payload.Command,callbackSet=this.__getStatusCallbackQueue.get(evt.payload.Command.Guid);callbackSet?.forEach(callback=>{TcHmi.Callback.callSafe(callback,null,{error:TcHmi.Errors.NONE,guid:command.Guid,state:command.State})});break;case"Answer":let serverAnswer=evt.payload.Command;Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Read server answer from server event and saving as remoteSdp (connection state is %o, signaling state is %o):",this.__peerConnection.connectionState,this.__peerConnection.signalingState,serverAnswer),this.__peerData.remoteSdp=serverAnswer.SDP;let speechServerData={type:"answer",sdp:this.__peerData.remoteSdp};this.__peerConnection.setRemoteDescription(speechServerData).then(()=>{Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Set setRemoteDescription without problems. (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState),this.__peerData.remotePendingIceCandidate.length&&(this.__peerData.remotePendingIceCandidate.forEach(icecandidate=>{Log.debugEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Adding one remote pending ice candidate. (connection state is %o, signaling state is %o):",this.__peerConnection.connectionState,this.__peerConnection.signalingState,icecandidate),this.__peerConnection.addIceCandidate(icecandidate).then(()=>{Log.debugEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Added pending ice candidate. (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState)}).catch(data=>{Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Adding ice candidate failed",data)})}),Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Requested adding "+this.__peerData.remotePendingIceCandidate.length+" pending ice candidates. (connection state is %o, signaling state is %o). Clearing pending candidates.",this.__peerConnection.connectionState,this.__peerConnection.signalingState),this.__peerData.remotePendingIceCandidate=[])}).catch(data=>{Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Setting remote description failed",data)});break;case"IceCandidates":evt.payload.Command.Candidates.length&&(Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Read "+evt.payload.Command.Candidates.length+" server remote ice from server events."),"have-local-offer"===this.__peerConnection.signalingState?(this.__peerData.remotePendingIceCandidate=this.__peerData.remotePendingIceCandidate.concat(evt.payload.Command.Candidates),Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Saved "+evt.payload.Command.Candidates.length+" ice candidates in a pending cache. (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState)):(evt.payload.Command.Candidates.forEach(icecandidate=>{Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Adding one remote ice candidate. (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState,icecandidate),this.__peerConnection.addIceCandidate(icecandidate).then(()=>{Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Added remote ice candidate. (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState)}).catch(data=>{Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Adding ice candidate failed",data)})}),Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Added all "+evt.payload.Command.Candidates.length+" remote ice candidates. (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState)));break;default:Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Command ",evt.payload.Command,"from remote id "+evt.payload.RemoteSocketId,"is not supported. Ignoring")}}})}__rebuildPeerConnectionObject(){this.__peerConnection?.close();this.__peerConnection=new RTCPeerConnection({iceCandidatePoolSize:5}),this.__peerConnection.addEventListener("icecandidate",this.__handlingNewIce),this.__peerConnection.addEventListener("icecandidateerror",this.__handlingIceError),this.__peerConnection.addEventListener("track",this.__handlingNewTrack),this.__peerConnection.addEventListener("negotiationneeded",this.__handlingNegotiationneeded),this.__peerConnection.addEventListener("signalingstatechange",data=>{Log.debugEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] # >"+data.type+" (connection state is %o, signaling state is %o)",data.target.connectionState,data.target.signalingState)}),this.__peerConnection.addEventListener("connectionstatechange",data=>{switch(this.__peerConnection.connectionState){case"disconnected":case"failed":this.__peerData.clientState=10}Log.debugEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] # >"+data.type+" (connection state is %o, signaling state is %o)",data.target.connectionState,data.target.signalingState)})}__peerData;__peerConnection;__commandDestroyFnc;__globalEventsRegistered=!1;__domainWatchRegistered=0;__handlingNewIce(data){data.candidate?(this.__peerData.localIceCandidates.push(data.candidate),Log.debugEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Got new local ice candidate to transport to the other side (connection state is %o, signaling state is %o). Will save the candidate for now.",this.__peerConnection.connectionState,this.__peerConnection.signalingState)):this.__peerData.remoteSocketId?(Log.debugEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Found no more ice candidates to transport to the other side. Sending now."),this.__sendIceCandidates()):Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Found "+this.__peerData.localIceCandidates.length+" ice candidates to transport to the other side. But remoteSocketId is not known right now. Waiting.")}__sendIceCandidates(){Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Sending ice candidates",this.__peerData.localIceCandidates),Server.writeSymbolEx(this.__currentConfig.domain+".Event.Raise",{SpeechApiVersion:1,SocketId:this.__peerData.localSocketId,RemoteSocketId:this.__peerData.remoteSocketId,Command:{Type:"IceCandidates",Candidates:this.__peerData.localIceCandidates}},null,this.__writeValueDebugOutput)}__handlingNewTrack(data){if(!this.__currentConfig.enableSpeaker)return void Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Got remote track, but ignoring because our speaker is disabled.");let track=data.track;if(Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Got "+data.streams.length+" (track id: "+track.id+", kind: "+track.kind+", label: "+track.label+", muted: "+track.muted+", readyState: "+track.readyState+") streams from the remote side (connection state is %o, signaling state is %o) Adding first one to our audio element.",this.__peerConnection.connectionState,this.__peerConnection.signalingState),data.track.addEventListener("mute",evt=>{Log.debugEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] "+evt.type+" on remote track fired.")}),data.track.addEventListener("unmute",evt=>{Log.debugEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] "+evt.type+" on remote track fired.")}),this.__peerData.audioElement.readyState===HTMLMediaElement.HAVE_NOTHING&&(this.__peerData.audioElement.pause(),this.__peerData.audioElement=document.createElement("audio"),this.__peerData.options.sinkConstraints?.deviceId&&"setSinkId"in this.__peerData.audioElement&&"function"==typeof this.__peerData.audioElement.setSinkId&&this.__peerData.audioElement.setSinkId(this.__peerData.options.sinkConstraints.deviceId).then(()=>{Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Successfully set deviceId to audio element.")}).catch(e=>{Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Failed setting deviceId to audio element:\n",e)})),this.__peerData.audioElement.srcObject=data.streams[0],this.setVolume(this.__currentConfig.defaultVolume),this.__peerData.audioElement.play().catch(data=>{let tryPlay=()=>{this.__peerData.audioElement.paused&&(this.__peerData.audioElement.play().catch(data=>{Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Activating audio playback for TwinCAT Speech failed even after user interaction",data)}),TopMostLayer.removeEx(container))},container=document.createElement("div");container.style.padding="20px",container.style.margin="20px",container.style.background="white",container.onclick=tryPlay;let confirmButton=document.createElement("button");confirmButton.textContent=frameworkLocalization.getText("OK")??"OK",container.append((frameworkLocalization.getText("Speech_playing_audio_needs_confirmation")??"TwinCAT Speech: Playing audio needs confirmation.")+" ",confirmButton),TopMostLayer.addEx(container,{centerHorizontal:!0,centerVertical:!0,removeCb:tryPlay})}),navigator.mediaSession&&window.MediaMetadata)try{navigator.mediaSession.metadata=new MediaMetadata({album:document.title,title:"TwinCAT Speech Output",artist:"TwinCAT Speech "+this.__peerData.remoteVersion}),navigator.mediaSession.setActionHandler?.("play",()=>{}),navigator.mediaSession.setActionHandler?.("pause",()=>{}),navigator.mediaSession.setActionHandler?.("stop",()=>{this.closeConnection()})}catch(ex){}this.__peerData.clientState=8}__handlingNegotiationneeded(_data){this.__peerData.localIceCandidates=[],Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Got negotiationneeded event. (connection state is %o, signaling state is %o). Recreate Offer.",this.__peerConnection.connectionState,this.__peerConnection.signalingState),1!==this.__peerData.clientState&&(this.__peerData.clientState=5,this.__clientSignalingStateMachine())}__handlingIceError(data){Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Got an ice error",data)}openConnection(options={},callback){if(TCHMI_DESIGNER){const errorDetail={code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],domain:"TcHmi.System.TcSpeechManager",reason:"Speech connectivity is not supported in Designer view."};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}this.closeConnection(),"string"==typeof options.domain&&(this.__currentConfig.domain=options.domain),"boolean"==typeof options.enableSpeaker&&(this.__currentConfig.enableSpeaker=options.enableSpeaker),"boolean"==typeof options.enableMicrophone&&(this.__currentConfig.enableMicrophone=options.enableMicrophone),"number"==typeof options.defaultVolume&&(this.__currentConfig.defaultVolume=options.defaultVolume),"number"==typeof options.confidenceThreshold&&(this.__currentConfig.confidenceThreshold=options.confidenceThreshold),this.__currentConfig.enableSpeaker||this.__currentConfig.enableMicrophone?(this.__peerData.callback=callback,this.__peerData.localSdp="",this.__peerData.remoteSdp="",this.__peerData.remoteSocketId=0,this.__peerData.localIceCandidates=[],this.__peerData.options=options,this.__peerData.clientState=2,this.__peerData.options.sinkConstraints?.deviceId&&("setSinkId"in this.__peerData.audioElement&&"function"==typeof this.__peerData.audioElement.setSinkId?this.__peerData.audioElement.setSinkId(this.__peerData.options.sinkConstraints.deviceId).then(()=>{Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Successfully set deviceId to audio element.")}).catch(e=>{Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Failed setting deviceId to audio element:\n",e)}):Log.warn("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Setting deviceId to audio element not possible in this browser.")),this.__clientSignalingStateMachine()):TcHmi.Callback.callSafe(callback,null,{error:TcHmi.Errors.NONE})}closeConnection(options={},callback){if(TCHMI_DESIGNER){const errorDetail={code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],domain:"TcHmi.System.TcSpeechManager",reason:"Speech connectivity is not supported in Designer view."};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}if(options?.remoteSocketId&&this.__peerData.remoteSocketId!==options.remoteSocketId){const errorDetail={code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.TcSpeechManager",reason:"No connection with requested socket ID open."};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}!this.__peerConnection||"closed"!==this.__peerConnection.connectionState&&"disconnected"!==this.__peerConnection.connectionState||Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Closing connection."),this.__peerData.clientState=9,this.__rebuildPeerConnectionObject(),TcHmi.Callback.callSafe(callback,null,{error:TcHmi.Errors.NONE})}__clientSignalingStateMachine(){switch(this.__peerData.clientState){case 2:this.__peerData.clientState=3;case 3:if(200===this.__domainWatchRegistered)return this.__peerData.clientState=4,void this.__clientSignalingStateMachine();if(102===this.__domainWatchRegistered)return void(this.__peerData.clientState=1);this.__domainWatchRegistered=102,this.__peerData.clientState=1,Domains.watch(this.__currentConfig.domain,data=>{data&&data.error===TcHmi.Errors.NONE&&"Initialized"===data.value?.state?(Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Register own instance and starting RTCPeerConnection."),Server.writeSymbolEx(this.__currentConfig.domain+".Clients.Register",{SpeechApiVersion:1,RemoteSocketId:0,SocketId:0,RegisterDate:(new Date).toISOString(),Version:TcHmi.version.full,AudioSink:this.__currentConfig.enableSpeaker,AudioSource:this.__currentConfig.enableMicrophone,CanOffer:!0,CanAnswer:!1,PotentialLocales:TcHmi.Locale.getRegisteredLocales(),State:"available"},null,Server.handleResponse({error:data=>{this.__peerData.clientState=10,data.error?Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Registering client failed: "+Log.buildMessage(data.details),"\n",data.response):data.results?.some(data=>data.error!==TcHmi.Errors.NONE)?Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Registering client failed:\n",data.results):Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Registering client failed:\n",data.response);const errorDetail={code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.TcSpeechManager",reason:"Registering client failed. Aborting."};TcHmi.Callback.callSafe(this.__peerData.callback,null,{error:errorDetail.code,details:errorDetail})},success:data=>{if(this.__domainWatchRegistered=200,!data.response||!data.response.commands[0].readValue){this.__peerData.clientState=10,Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Registering client failed. Aborting.");const errorDetail={code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.TcSpeechManager",reason:"Registering client failed. Aborting."};return void TcHmi.Callback.callSafe(this.__peerData.callback,null,{error:errorDetail.code,details:errorDetail})}let oldId=this.__peerData.localSocketId;this.__peerData.localSocketId=data.response.commands[0].readValue.SocketId,Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Got our Socket Id: "+this.__peerData.localSocketId),this.__globalEventsRegistered||(this.__globalEventsRegistered=!0,EventProvider.register("onLocaleChanged",this.__registerClientConfig),EventProvider.register("onServerReady",evt=>{this.__restartServerEventListening()})),oldId!==this.__peerData.localSocketId&&this.__restartServerEventListening(),9!==this.__peerData.clientState&&10!==this.__peerData.clientState&&(this.__peerData.clientState=4,this.__clientSignalingStateMachine())}})),this.__rebuildPeerConnectionObject()):(this.closeConnection(),this.__commandDestroyFnc?.(),this.__commandDestroyFnc=void 0,Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Domain: %o is not available. Please make sure the server extension is loaded and the domain name is correct.",this.__currentConfig?.domain,Log.buildMessage(data.value?.error)))});break;case 4:if(this.__currentConfig.enableMicrophone){if(!navigator.mediaDevices){let reason;reason=window.isSecureContext?"Could not access media devices.":"Could not access media devices. You probably need to access this page via secure HTTPS or localhost.",Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] "+reason),this.__peerData.clientState=10;const errorDetail={code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],domain:"TcHmi.System.TcSpeechManager",reason};return void TcHmi.Callback.callSafe(this.__peerData.callback,null,{error:errorDetail.code,details:errorDetail})}this.__peerData.clientState=1;const constraints={audio:this.__peerData.options.sourceConstraints??!0,video:!1};navigator.mediaDevices.getUserMedia(constraints).then(localStream=>{let alltracks=localStream.getTracks();Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Got "+alltracks.length+" audio tracks from the microphone (id: "+localStream.id+") (connection state is %o, signaling state is %o). Adding all tracks to peerConnection now.",this.__peerConnection.connectionState,this.__peerConnection.signalingState);for(const track of alltracks)this.__peerConnection.addTrack(track,localStream),Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Added microphone track to peerConnection with the id: "+track.id+", kind: "+track.kind+", label: "+track.label+", muted: "+track.muted+", readyState: "+track.readyState);Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Saving all tracks to peerConnection successful. (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState),this.__peerData.clientState=5,this.__clientSignalingStateMachine()}).catch(reason=>{switch(this.__peerData.clientState=10,reason.name){case"NotFoundError":Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Capturing audio failed: No microphone was found.");break;case"SecurityError":case"PermissionDeniedError":case"NotAllowedError":Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Capturing audio failed: Denied access to microphone.");break;default:Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Capturing audio failed (",reason.name,"):",reason.message)}}),Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Requested microphone from the browser. (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState)}else{let myStream=new AudioContext({}).createMediaStreamDestination().stream;for(const track of myStream.getTracks())this.__peerConnection.addTrack(track,myStream),Log.debugEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] No microphone requested. Thus added silence/empty track to peerConnection with the id: "+track.id+", kind: "+track.kind+", label: "+track.label+", muted: "+track.muted+", readyState: "+track.readyState);this.__peerData.clientState=5,this.__clientSignalingStateMachine()}break;case 5:Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Requesting WebRTC offer from the browser (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState),this.__peerData.clientState=1,this.__peerConnection.createOffer().then(offer=>(Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Browser created offer. (connection state is %o, signaling state is %o) and saving as local description.",this.__peerConnection.connectionState,this.__peerConnection.signalingState),this.__peerData.localSdp=offer.sdp,this.__peerData.remoteSdp="","stable"!==this.__peerConnection.signalingState&&Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] We created an Offer, but peerConnection.signalingState is not in state stable."),this.__peerConnection.setLocalDescription(offer))).then(()=>{Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Set local description successful. (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState),this.__peerData.clientState=6,this.__clientSignalingStateMachine()}).catch(data=>{Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Creating offer failed",data),this.__peerData.clientState=10,this.__peerData.localSdp="",this.__peerData.remoteSdp=""});break;case 6:Server.readSymbolEx(this.__currentConfig.domain+".Clients.List",null,Server.handleResponse({error:this.__writeValueDebugOutput,success:data=>{let readValue=data.response.commands[0].readValue;if(!readValue.length)return Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] No registered Speech Clients found! Huh. At least we should have find ourself."),void(this.__peerData.clientState=10);if(Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Registered Speech Clients found. Searching a matching server. (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState),this.__peerData.options?.remoteSocketId){const firstMatch=readValue.find(data=>data.CanAnswer&&data.SocketId===this.__peerData.options.remoteSocketId);if(!firstMatch){this.__peerData.clientState=10,Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] No speech service with the requested id available on this server.");const errorDetail={code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],domain:"TcHmi.System.TcSpeechManager",reason:"No speech service with the requested id available on this server."};return void TcHmi.Callback.callSafe(this.__peerData.callback,null,{error:errorDetail.code,details:errorDetail})}this.__peerData.remoteSocketId=firstMatch.SocketId,this.__peerData.remoteVersion=firstMatch.Version}else{const firstMatch=readValue.find(data=>data.CanAnswer);if(!firstMatch){this.__peerData.clientState=10,Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] No speech service available on this server.");const errorDetail={code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],domain:"TcHmi.System.TcSpeechManager",reason:"No speech service available on this server."};return void TcHmi.Callback.callSafe(this.__peerData.callback,null,{error:errorDetail.code,details:errorDetail})}this.__peerData.remoteSocketId=firstMatch.SocketId,this.__peerData.remoteVersion=firstMatch.Version}Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Found a matching server with id "+this.__peerData.remoteSocketId+". (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState),this.__peerData.localIceCandidates.length&&(Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Found cached local ice candidates. Sending now, as we have now the remoteSocketId."),this.__sendIceCandidates()),Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Sending active Commands, as we have now the remoteSocketId."),this.__registerClientConfig(),this.__peerData.clientState=7,this.__clientSignalingStateMachine()}}));break;case 7:Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Sending offer to remoteSocketId "+this.__peerData.remoteSocketId+" of server. (connection state is %o, signaling state is %o)",this.__peerConnection.connectionState,this.__peerConnection.signalingState),Server.writeSymbolEx(this.__currentConfig.domain+".Event.Raise",{SpeechApiVersion:1,SocketId:this.__peerData.localSocketId,RemoteSocketId:this.__peerData.remoteSocketId,Command:{Type:"Offer",SDP:this.__peerData.localSdp}},null,this.__writeValueDebugOutput)}}__eventProviderRegistrations=[];__eventProviderRegistrationTimeOut=0;setVolume(newValue){TCHMI_DESIGNER||isNaN(newValue)||(newValue<0?newValue=0:newValue>1&&(newValue=1),this.__peerData.audioElement.volume=newValue)}__addUsedSpeechTrigger(eventname){if(TCHMI_DESIGNER)return;const commandName=eventname.substring(16,eventname.length-1);this.__eventProviderRegistrations.includes(commandName)||(this.__eventProviderRegistrations.push(commandName),this.__eventProviderRegistrationTimeOut&&window.clearTimeout(this.__eventProviderRegistrationTimeOut),this.__eventProviderRegistrationTimeOut=window.setTimeout(this.__registerClientConfig,50))}__removeUsedSpeechTrigger(eventname){if(TCHMI_DESIGNER)return;const commandName=eventname.substring(16,eventname.length-1),idx=this.__eventProviderRegistrations.indexOf(commandName);-1===idx||EventProvider.has(eventname)||(this.__eventProviderRegistrations.splice(idx,1),this.__eventProviderRegistrationTimeOut&&window.clearTimeout(this.__eventProviderRegistrationTimeOut),this.__eventProviderRegistrationTimeOut=window.setTimeout(this.__registerClientConfig,50))}__registerClientConfig(){window.clearTimeout(this.__eventProviderRegistrationTimeOut),this.__eventProviderRegistrationTimeOut=0,this.__peerData.remoteSocketId&&Server.writeSymbolEx(this.__currentConfig.domain+".ClientConfigs.Register",{SpeechApiVersion:1,SocketId:this.__peerData.localSocketId,RemoteSocketId:this.__peerData.remoteSocketId,CurrentCommands:this.__eventProviderRegistrations,CurrentLocales:[TcHmi.Locale.get()??"en"]},null,Server.handleResponse({completed:this.__writeValueDebugOutput}))}speechSynthesisStart(text,options,callback){if(TCHMI_DESIGNER){const errorDetail={code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],domain:"TcHmi.System.TcSpeechManager",reason:"Speech connectivity is not supported in Designer view."};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}if(!text){const errorDetail={code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.TcSpeechManager",reason:"Text to Synthesis has to be provided."};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}if(!this.__currentConfig.enableSpeaker){const errorDetail={code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.TcSpeechManager",reason:"The config did not allowed a speaker, so we can not synthesis text."};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}if(!this.__peerData.remoteSocketId){const errorDetail={code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],domain:"TcHmi.System.TcSpeechManager",reason:"Connection to Speech has to be up before we can synthesis text."};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}const guid=tchmi_create_guid();let prio=options?.priority??TcHmi.TcSpeech.AudioEntityPriority.Normal;if(null===Server.writeSymbolEx(this.__currentConfig.domain+".Event.Raise",{SpeechApiVersion:1,SocketId:this.__peerData.localSocketId,RemoteSocketId:this.__peerData.remoteSocketId,Command:{Type:"SpeechSynthesisStart",Text:text,Priority:prio,Guid:guid}},null,Server.handleResponse({completed:data=>{Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Requested start of SpeechSynthesis with id "+guid),TcHmi.Callback.callSafe(callback,null,{error:data.error,details:data.details,guid,state:"Queued"})}}))){const errorDetail={code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Request could not be sent.",domain:"TcHmi.System.TcSpeechManager"};TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}}__getStatusCallbackQueue=new Map;speechSynthesisGetStatus(guid,callback){if(TCHMI_DESIGNER){const errorDetail={code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],domain:"TcHmi.System.TcSpeechManager",reason:"Speech connectivity is not supported in Designer view."};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}if(!guid){const errorDetail={code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.TcSpeechManager",reason:"Guid to get synthesis status has to be provided."};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}if(null===Server.writeSymbolEx(this.__currentConfig.domain+".Event.Raise",{SpeechApiVersion:1,SocketId:this.__peerData.localSocketId,RemoteSocketId:this.__peerData.remoteSocketId,Command:{Type:"SpeechSynthesisGetStatus",Guid:guid}},null,Server.handleResponse({error:data=>{TcHmi.Callback.callSafe(callback,null,{error:data.error,details:data.details,guid})},success:data=>{let guidSet=this.__getStatusCallbackQueue.get(guid);guidSet||(guidSet=new Set,this.__getStatusCallbackQueue.set(guid,guidSet)),guidSet.add(callback)}}))){const errorDetail={code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Request could not be sent.",domain:"TcHmi.System.TcSpeechManager"};TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}}
/**
         * Stops a given speech synthesis call.
         * @param guid guid for the request. Can be fetched from the callback of speechSynthesisStart
         * @param callback The callback will get the state of the speech synthesis
         * @preserve (Part of the public API)
         */speechSynthesisStop(guid,callback){if(TCHMI_DESIGNER){const errorDetail={code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],domain:"TcHmi.System.TcSpeechManager",reason:"Speech connectivity is not supported in Designer view."};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}if(!guid){const errorDetail={code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.TcSpeechManager",reason:"Guid to stop synthesis has to be provided."};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}if(null===Server.writeSymbolEx(this.__currentConfig.domain+".Event.Raise",{SpeechApiVersion:1,SocketId:this.__peerData.localSocketId,RemoteSocketId:this.__peerData.remoteSocketId,Command:{Type:"SpeechSynthesisStop",Guid:guid}},null,Server.handleResponse({completed:data=>{TcHmi.Callback.callSafe(callback,null,{error:data.error,details:data.details,guid})}}))){const errorDetail={code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Request could not be sent.",domain:"TcHmi.System.TcSpeechManager"};return void TcHmi.Callback.callSafe(callback,null,{error:errorDetail.code,details:errorDetail})}}__writeValueDebugOutput(data){data.error||!data.response?Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Writing to server symbol failed: "+Log.buildMessage(data.details),"\n",data.response):data.results?.some(data=>data.error!==TcHmi.Errors.NONE)?Log.errorEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Writing to server symbol failed:\n",data.results):data.response.commands[0].symbol===this.__currentConfig.domain+".Event.Raise"&&data.response.commands[0].writeValue?.Command?.Type?Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Raised Command ",data.response.commands[0].writeValue?.Command?.Type,"to remote socket id "+data.response.commands[0].writeValue?.RemoteSocketId,"with payload",data.response.commands[0].writeValue):Log.infoEx("[Source=Framework, Module=TcHmi.System.TcSpeechManager] Written to server symbol: "+data.response.commands[0].symbol,"writevalue: ",data.response.commands[0].writeValue)}}})();export{TcSpeechManager};export const tcSpeechManager=new TcSpeechManager;
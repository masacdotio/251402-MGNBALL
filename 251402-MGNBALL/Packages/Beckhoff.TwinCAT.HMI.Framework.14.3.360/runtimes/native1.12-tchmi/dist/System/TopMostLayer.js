import{ConflictResolution}from"../API/TopMostLayer.js";import{getViewportElementDimension}from"../API/View.js";import{viewManager}from"./ViewManager.js";let TopMostLayer=(()=>{var _a,_b,_c,_d;let ___mousedownHandler_decorators,___mouseupHandler_decorators,___checkDetachedControls_decorators,___updateAllChildPosition_decorators,_instanceExtraInitializers=[];return class{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___mousedownHandler_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___mouseupHandler_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___checkDetachedControls_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],___updateAllChildPosition_decorators=[(_d=TcHmi).CallbackMethod.bind(_d)],__esDecorate(this,null,___mousedownHandler_decorators,{kind:"method",name:"__mousedownHandler",static:!1,private:!1,access:{has:obj=>"__mousedownHandler"in obj,get:obj=>obj.__mousedownHandler},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___mouseupHandler_decorators,{kind:"method",name:"__mouseupHandler",static:!1,private:!1,access:{has:obj=>"__mouseupHandler"in obj,get:obj=>obj.__mouseupHandler},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___checkDetachedControls_decorators,{kind:"method",name:"__checkDetachedControls",static:!1,private:!1,access:{has:obj=>"__checkDetachedControls"in obj,get:obj=>obj.__checkDetachedControls},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___updateAllChildPosition_decorators,{kind:"method",name:"__updateAllChildPosition",static:!1,private:!1,access:{has:obj=>"__updateAllChildPosition"in obj,get:obj=>obj.__updateAllChildPosition},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){this.__masterDiv=document.createElement("div"),this.__masterDiv.id="tchmi-system-topmostlayer-master",this.__masterDiv.addEventListener("mousedown",this.__mousedownHandler,!1),this.__mutationObserver=new MutationObserver(this.__updateAllChildPosition),this.__resizeObserver=new ResizeObserver(this.__updateAllChildPosition)}__masterDiv=__runInitializers(this,_instanceExtraInitializers);__optionsList=new Map;__containerDivs=[];__mutationObserver;__resizeObserver;__detachEventDestroy=null;__viewpartsEventDestroy=null;__mousedownHandler(event){const targetElem=event.target;if(!targetElem?.classList.contains("tchmi-system-topmostlayer-container"))return;this.__masterDiv.addEventListener("mouseup",this.__mouseupHandler,{capture:!1,once:!0})}__mouseupHandler(event){const targetElem=event.target;if(!targetElem?.classList.contains("tchmi-system-topmostlayer-container"))return;const reversedCurrentItems=Array.from(this.__masterDiv.children).reverse();for(const container of reversedCurrentItems){let nativeElem=container.lastElementChild;if(nativeElem){const internalOption=this.__optionsList.get(nativeElem);if(void 0===internalOption?.modal||!1!==internalOption?.modal){internalOption&&!1!==internalOption.closeOnBackground&&this.remove(internalOption.origin,internalOption.originalElement,!0);break}}}}__checkDetachedControls(_event,control){for(const internalOptions of this.__optionsList.values())internalOptions.origin===control&&this.remove(control,internalOptions.originalElement,!0)}__updateAllChildPosition(evtOrMutations){const removedNodesOptions=[];if(evtOrMutations&&Array.isArray(evtOrMutations)&&!(evtOrMutations[0]instanceof ResizeObserverEntry)){let updateNeeded=!1,styleOfChangedNodes=new Map;for(const mutation of evtOrMutations){if(mutation instanceof ResizeObserverEntry)break;let node=mutation.target;if(node instanceof HTMLElement)if("attributes"===mutation.type)"style"===mutation.attributeName?styleOfChangedNodes.has(node)||styleOfChangedNodes.set(node,mutation.oldValue):updateNeeded=!0;else if("childList"===mutation.type){updateNeeded=!0;for(const removedNode of mutation.removedNodes){if(this.__masterDiv.contains(removedNode))continue;const internalOption=this.__optionsList.get(removedNode);if(internalOption&&removedNodesOptions.push(internalOption),removedNode.removeEventListener("load",this.__updateAllChildPosition),removedNode instanceof Element){removedNode.hasAttribute("data-tchmi-type")&&(removedNode.classList.remove("tchmi-in-topmostlayer"),removedNode.removeAttribute("tchmi-topmostlayer-hostcontrolid"));const subcontrolElements=removedNode.querySelectorAll("div[data-tchmi-type]");for(const element of subcontrolElements)element.classList.remove("tchmi-in-topmostlayer")}}for(const addedNode of mutation.addedNodes)if(this.__masterDiv.contains(addedNode)&&addedNode instanceof Element){const internalOption=this.__optionsList.get(addedNode);internalOption?.origin instanceof TcHmi.Controls.System.baseTcHmiControl&&addedNode.setAttribute("tchmi-topmostlayer-hostcontrolid",internalOption.origin.getId()),addedNode.hasAttribute("data-tchmi-type")&&addedNode.classList.add("tchmi-in-topmostlayer");const subcontrolElements=addedNode.querySelectorAll("div[data-tchmi-type]");for(const element of subcontrolElements){element.classList.add("tchmi-in-topmostlayer");const control=TcHmi.Controls.get(element.id);control&&!control.getParent()&&(control.__processIsEnabled(),control.__processAccessConfig())}}}}if(!updateNeeded)for(const[changedNode,initialStyle]of styleOfChangedNodes)if(initialStyle!==changedNode.getAttribute("style")){updateNeeded=!0;break}if(!updateNeeded&&!removedNodesOptions.length)return}let resizeCallbackList=[];for(const containerElem of this.__masterDiv.children){if(!(containerElem instanceof HTMLElement))continue;const nativeElem=containerElem?.firstElementChild;if(!containerElem||!nativeElem)continue;const internalOption=this.__optionsList.get(nativeElem);if(!internalOption)continue;const centeringRequested=internalOption.centerVertical||internalOption.centerHorizontal;if(centeringRequested||internalOption.resizeCb){const{width:centerPartWidth,height:centerPartHeight}=getViewportElementDimension()??{width:window.innerWidth,height:window.innerHeight};let resizedByTML=!1;if(centeringRequested&&nativeElem){const boundingRect=nativeElem.getBoundingClientRect();if(!0===internalOption.centerVertical){const newTop=Math.round((centerPartHeight-boundingRect.height)/2);nativeElem.style.top!==newTop+"px"&&(nativeElem.style.top=newTop+"px",resizedByTML=!0)}if(!0===internalOption.centerHorizontal){const newLeft=Math.round((centerPartWidth-boundingRect.width)/2);nativeElem.style.left!==newLeft+"px"&&(nativeElem.style.left=newLeft+"px",resizedByTML=!0)}}(!1===centeringRequested||resizedByTML)&&internalOption.resizeCb&&resizeCallbackList.push({callback:internalOption.resizeCb,thisArg:internalOption.origin,args:{error:TcHmi.Errors.NONE,element:internalOption.originalElement,parentPixelSize:{width:centerPartWidth,height:centerPartHeight}}})}}for(const resizeCallback of resizeCallbackList)TcHmi.Callback.callSafeEx(resizeCallback.callback,resizeCallback.thisArg,resizeCallback.args);for(const internalOption of removedNodesOptions)this.remove(internalOption.origin,internalOption.originalElement,!0)}__dimLastContainer(){let lastDimChild;for(const containerElem of this.__containerDivs){if(!(containerElem.firstElementChild instanceof HTMLElement))continue;containerElem.classList.remove("tchmi-topmostlayer-non-modal");let internalOption=this.__optionsList.get(containerElem.firstElementChild);internalOption&&(!1!==internalOption.dimBackground&&(lastDimChild=containerElem),containerElem.classList.remove("tchmi-topmostlayer-background-dim"),!1===internalOption.modal&&containerElem.classList.add("tchmi-topmostlayer-non-modal"))}lastDimChild&&lastDimChild.classList.add("tchmi-topmostlayer-background-dim")}__buildJustAboveList(options,seenNodes){const list=[],nextLevel=[];for(const node of options.elementsAbove){if(seenNodes.has(node))continue;seenNodes.add(node);const aboveOptions=this.__optionsList.get(node);aboveOptions&&(list.push(aboveOptions.container),nextLevel.push(this.__buildJustAboveList(aboveOptions,seenNodes)))}return list.concat(nextLevel.flat())}add(origin,element,options){if(!element)return!1;const nativeElem=element instanceof HTMLElement?element:element[0];if(!(nativeElem instanceof HTMLElement))return!1;const optionsOld=this.__optionsList.get(nativeElem);if(optionsOld&&!options?.allowMultipleCall)return!1;let containerElem;if(!(options={...optionsOld,...options}).justAbove&&origin instanceof TcHmi.Controls.System.baseTcHmiControl&&(options.justAbove={reference:origin.getElement()[0]}),optionsOld){if(containerElem=nativeElem.parentElement,!containerElem?.classList.contains("tchmi-system-topmostlayer-container"))throw new Error("Element is known in topmostlayer but wrong configured. Aborting.")}else nativeElem.classList.add("tchmi-in-topmostlayer"),origin instanceof TcHmi.Controls.System.baseTcHmiControl&&nativeElem.setAttribute("tchmi-topmostlayer-hostcontrolid",origin.getId()),containerElem=document.createElement("div"),containerElem.classList.add("tchmi-system-topmostlayer-container"),containerElem.appendChild(nativeElem),this.__mutationObserver.observe(containerElem,{childList:!0,subtree:!0});this.__containerDivs.includes(containerElem)&&this.__containerDivs.splice(this.__containerDivs.indexOf(containerElem),1);let elementsAbove,justAboveContainer=null,reference=null,wantsToBeBottomMost=!1;if(options.justAbove)if(justAboveContainer=options.justAbove.reference.closest(".tchmi-system-topmostlayer-container"),justAboveContainer)this.__containerDivs.splice(this.__containerDivs.indexOf(justAboveContainer)+1,0,containerElem),reference=justAboveContainer.querySelector(".tchmi-in-topmostlayer");else if(wantsToBeBottomMost=!0,options.justAbove.conflictResolution===ConflictResolution.Down)this.__containerDivs.unshift(containerElem);else{let index=0;for(const option of this.__optionsList.values())option.wantsToBeBottomMost&&index++;this.__containerDivs.splice(index,0,containerElem)}else this.__containerDivs.push(containerElem);if(optionsOld)elementsAbove=optionsOld.elementsAbove;else{elementsAbove=new Set;for(const[otherElement,otherOptions]of this.__optionsList)otherOptions.justAbove&&(otherOptions.justAboveReference?otherOptions.justAboveReference===nativeElem&&elementsAbove.add(otherElement):nativeElem.contains(otherOptions.justAbove.reference)&&(otherOptions.justAboveReference=nativeElem,elementsAbove.add(otherElement)))}const internalOption={...options,origin,container:containerElem,styleBackup:{left:nativeElem.style.left,top:nativeElem.style.top,position:nativeElem.style.position},elementsAbove,wantsToBeBottomMost,originalElement:element};internalOption.justAboveReference&&internalOption.justAboveReference!==reference&&(this.__optionsList.get(internalOption.justAboveReference)?.elementsAbove?.delete(nativeElem),delete internalOption.justAboveReference),reference&&(internalOption.justAboveReference=reference,this.__optionsList.get(reference)?.elementsAbove?.add(nativeElem));const justAboveList=this.__buildJustAboveList(internalOption,new Set([nativeElem]));for(const element of justAboveList){const index=this.__containerDivs.indexOf(element);-1!==index&&this.__containerDivs.splice(index,1)}let index=this.__containerDivs.indexOf(containerElem)+1;this.__containerDivs.splice(index,0,...justAboveList);const findActiveElement={activeElementIsBelowThisLayer:!0,checkLayerForActiveElement:!1};for(const[index,div]of this.__containerDivs.entries())div.style.zIndex=index.toString(),div===containerElem&&(findActiveElement.checkLayerForActiveElement=!0),findActiveElement.checkLayerForActiveElement&&div.contains(document.activeElement)&&(findActiveElement.activeElementIsBelowThisLayer=!1);if(internalOption.modal&&findActiveElement.activeElementIsBelowThisLayer&&document.activeElement instanceof HTMLElement&&document.activeElement.blur(),containerElem.parentElement!==this.__masterDiv&&this.__masterDiv.appendChild(containerElem),internalOption.centerVertical||internalOption.centerHorizontal){nativeElem.style.position="absolute",this.__mutationObserver.observe(nativeElem,{attributes:!0,attributeOldValue:!0,childList:!0,subtree:!0});const childrenWithLoadEvent=nativeElem.querySelectorAll("iframe,img,picture,embed,input[type=image]");for(const child of childrenWithLoadEvent)child.addEventListener("load",this.__updateAllChildPosition)}if(this.__optionsList.set(nativeElem,internalOption),this.__dimLastContainer(),!this.__masterDiv.parentElement){const passiveEventOptions={passive:!0,capture:!0};this.__resizeObserver.observe(this.__masterDiv),window.addEventListener("scroll",this.__updateAllChildPosition,passiveEventOptions),this.__detachEventDestroy=TcHmi.EventProvider.register("System.onControlDetached",this.__checkDetachedControls),this.__viewpartsEventDestroy=TcHmi.EventProvider.register("System.onViewpartsChanged",this.__updateAllChildPosition),viewManager.addViewportElement(this.__masterDiv,{name:"topmostlayer",area:"main"})}const subcontrolElements=this.__masterDiv.querySelectorAll("div[data-tchmi-type]");for(const element of subcontrolElements){element.classList.add("tchmi-in-topmostlayer");let control=TcHmi.Controls.get(element.id);control&&!control.getParent()&&(control.__processIsEnabled(),control.__processAccessConfig())}return this.__updateAllChildPosition(),!0}remove(_origin,element,cancel){if(!element)return element;const nativeElem=element instanceof HTMLElement?element:element[0];if(!nativeElem)return element;let internalOption=this.__optionsList.get(nativeElem);if(!internalOption)return element;nativeElem.classList.remove("tchmi-in-topmostlayer"),nativeElem.removeAttribute("tchmi-topmostlayer-hostcontrolid");let subcontrolElements=nativeElem.querySelectorAll("div[data-tchmi-type]");for(const element of subcontrolElements)element.classList.remove("tchmi-in-topmostlayer");this.__containerDivs.includes(internalOption.container)&&this.__containerDivs.splice(this.__containerDivs.indexOf(internalOption.container),1),internalOption.justAboveReference&&this.__optionsList.get(internalOption.justAboveReference)?.elementsAbove?.delete(nativeElem);for(const elementAbove of internalOption.elementsAbove)delete this.__optionsList.get(elementAbove)?.justAboveReference;const justAboveList=this.__buildJustAboveList(internalOption,new Set([nativeElem]));for(const element of justAboveList){const index=this.__containerDivs.indexOf(element);-1!==index&&this.__containerDivs.splice(index,1)}this.__containerDivs.splice(0,0,...justAboveList);for(const[index,div]of this.__containerDivs.entries())div.style.zIndex=index.toString();if(internalOption.container?.remove(),nativeElem.remove(),!this.__masterDiv.firstElementChild){viewManager.removeViewportElement(this.__masterDiv);const passiveEventOptions={passive:!0,capture:!1};window.removeEventListener("scroll",this.__updateAllChildPosition,passiveEventOptions);const nocaptureOnce={capture:!1,once:!0};this.__masterDiv.removeEventListener("mouseup",this.__mouseupHandler,nocaptureOnce),this.__detachEventDestroy&&(this.__detachEventDestroy(),this.__detachEventDestroy=null),this.__viewpartsEventDestroy?.(),this.__viewpartsEventDestroy=null,this.__mutationObserver.disconnect(),this.__resizeObserver.unobserve(this.__masterDiv)}const cbParam={error:TcHmi.Errors.NONE,element,canceled:cancel};if((internalOption.centerVertical||internalOption.centerHorizontal)&&internalOption.styleBackup){nativeElem.style.position=internalOption.styleBackup.position,internalOption.centerHorizontal&&(nativeElem.style.left=internalOption.styleBackup.left),internalOption.centerVertical&&(nativeElem.style.top=internalOption.styleBackup.top);const childrenWithLoadEvent=nativeElem.querySelectorAll("iframe,img,picture,embed,input[type=image]");for(const child of childrenWithLoadEvent)child.removeEventListener("load",this.__updateAllChildPosition)}return this.__optionsList.delete(nativeElem),internalOption.removeCb&&TcHmi.Callback.callSafeEx(internalOption.removeCb,internalOption.origin,cbParam),this.__dimLastContainer(),element}}})();export{TopMostLayer};export const topMostLayer=new TopMostLayer;
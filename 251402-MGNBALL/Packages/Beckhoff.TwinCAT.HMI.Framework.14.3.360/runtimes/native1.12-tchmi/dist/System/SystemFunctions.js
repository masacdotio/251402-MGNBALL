import{Exception}from"../API/Exception.js";import{controlManager}from"./ControlManager.js";import{config,Data}from"./System.js";import{ControlAttributeType,ControlAttributeValueType}from"./_Types.js";export function resolveControlHierarchy(ctrl,pctrl=null){let childrenHierarchyArr=[];const cc=ctrl.getChildren();for(const child of cc)childrenHierarchyArr.push(resolveControlHierarchy(child,ctrl));return{ctrl,children_hierarchy:childrenHierarchyArr,pctrl}}export function resolveAttributesFromControlElement(elem){const res={error:TcHmi.Errors.NONE,value:{}},targetUserControlId=elem.getAttribute("data-tchmi-target-user-control"),controlType=elem.getAttribute("data-tchmi-type"),cj=targetUserControlId?Data.Caches.partialCompositeConfigCache.get(tchmi_path(targetUserControlId.replace(".usercontrol",".usercontrol.json"))):void 0;for(const elemChild of elem.children)if(elemChild.hasAttribute("data-tchmi-target-attribute")&&"application/json"===elemChild.getAttribute("type")){const attrName=elemChild.getAttribute("data-tchmi-target-attribute");let value=null;const innerHTML=elemChild.innerHTML.trim();if(innerHTML)try{value=JSON.parse(innerHTML.replace(/\\\\n/g,"\\\\\\n").replace(/\\\\r/g,"\\\\\\r").replace(/\\\\t/g,"\\\\\\t").replace(/\\n/g,"\\\\n").replace(/\\r/g,"\\\\r").replace(/\\t/g,"\\\\t"))}catch(ex){const e=ex;res.error=TcHmi.Errors.ERROR;let error={code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:`Parsing json of attribute: "${attrName}" failed with exception`,domain:"TcHmi.System",exception:e};res.details?(res.details.errors||(res.details.errors=[]),res.details.errors.push(error)):res.details={code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System",errors:[error]}}let meta={name:attrName,value,valueType:ControlAttributeValueType.Complex,type:ControlAttributeType.General,descr:controlManager.getDescriptionAttributeByName(controlType,attrName)??null};if(null!==meta.descr&&(meta.type=ControlAttributeType.Control),cj&&cj.parameters)for(const paramDescription of cj.parameters)paramDescription.name.toLowerCase()===meta.name.toLowerCase()&&(meta.descr=paramDescription,null!==meta.descr&&(meta.type=ControlAttributeType.UserControlParameter));res.value[meta.name]=meta}for(const elementAttribute of elem.attributes){let meta={name:elementAttribute.name,value:elementAttribute.value,type:ControlAttributeType.Invalid,valueType:ControlAttributeValueType.Simple,descr:controlManager.getDescriptionAttributeByName(controlType,elementAttribute.name)??null};if(null!==meta.descr&&(meta.type=ControlAttributeType.Control),cj?.parameters)for(const cjParamDescr of cj.parameters)if(cjParamDescr.name===meta.name&&(meta.descr=cjParamDescr,null!==meta.descr)){meta.type=ControlAttributeType.UserControlParameter;break}res.value[meta.name]=meta}return res}export function resolveQualifiedName(name,namespace){return null!=namespace&&""!==namespace?namespace+"."+name:name}export function parseIdFromHtml(markup){let state=2,idStartIdx=0,idEndIdx=0;for(let charIdx=0;charIdx<markup.length;charIdx++){switch(markup[charIdx]){case"i":1===state&&(state=3);break;case"d":3===state?state=4:6===state||7===state||(state=2);break;case"=":4===state&&(state=5);break;case"'":5===state?(state=6,idStartIdx=charIdx+1):6===state&&(idEndIdx=charIdx);break;case'"':5===state?(state=7,idStartIdx=charIdx+1):7===state&&(idEndIdx=charIdx);break;case"<":case">":state=1;break;case" ":case"\t":case"\r":case"\n":4===state||5===state||(state=1);break;default:3===state?state=0:6===state||7===state||(state=2)}if(idEndIdx)break}if(idEndIdx)return markup.slice(idStartIdx,idEndIdx)}export function tchmi_utf8str_base64decode(input){try{return decodeURIComponent(Array.prototype.map.call(window.atob(input),function(c){return"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)}).join(""))}catch(e){return null}}export function tchmi_utf8str_base64encode(input){try{return window.btoa(encodeURIComponent(input).replace(/%([0-9A-F]{2})/g,function(match,p1){return String.fromCharCode(parseInt("0x"+p1,16))}))}catch(e){return null}}export function compareISO8601ServerCommandDateTimeStrings(a,b){if(a.length===b.length)return a<b?-1:a>b?1:0;{let aDate=new Date(a),bDate=new Date(b);if(isNaN(aDate.getTime()))throw new Error("Wrong format for argument: 'a'.");if(isNaN(bDate.getTime()))throw new Error("Wrong format for argument: 'b'.");if(aDate<bDate)return-1;if(aDate>bDate)return 1;{let aSubSeconds=null,aIndex1=a.indexOf("."),aIndex2=a.indexOf("Z");if(aIndex1>-1&&aIndex2>-1&&(aSubSeconds=a.substring(aIndex1+1,aIndex2)),aSubSeconds&&aSubSeconds.length<6)for(let i=0,ii=6-aSubSeconds.length;i<ii;i++)aSubSeconds+="0";let bSubSeconds=null,bIndex1=b.indexOf("."),bIndex2=b.indexOf("Z");if(bIndex1>-1&&bIndex2>-1&&(bSubSeconds=b.substring(bIndex1+1,bIndex2)),bSubSeconds&&bSubSeconds.length<6)for(let i=0,ii=6-bSubSeconds.length;i<ii;i++)bSubSeconds+="0";return null!==aSubSeconds&&null!==bSubSeconds&&aSubSeconds<bSubSeconds?-1:null!==aSubSeconds&&null!==bSubSeconds&&aSubSeconds>bSubSeconds?1:0}}}const regexISO8601ServerCommandDurationParts=/^P(?=.{2,})(\d+Y|\d+[.,]\d+Y$)?(\d+M|\d+[.,]\d+M$)?(\d+W|\d+[.,]\d+W$)?(\d+D|\d+[.,]\d+D$)?(?:T(\d+H|\d+[.,]\d+H$)?(\d+M|\d+[.,]\d+M$)?(\d+S|\d+[.,]\d+S$)?)?$/;export function compareISO8601ServerCommandDurationStrings(a,b){const resA=regexISO8601ServerCommandDurationParts.exec(a),resB=regexISO8601ServerCommandDurationParts.exec(b);if(null===resA)throw new Error("Wrong format for argument: 'a'.");if(null===resB)throw new Error("Wrong format for argument: 'b'.");const partsA=resA.slice(1),partsB=resB.slice(1),partsAMapped=partsA.map(value=>value?parseFloat(value.slice(0,-1)):0),partsBMapped=partsB.map(value=>value?parseFloat(value.slice(0,-1)):0);for(const[index,value]of partsAMapped.entries()){if(value<partsBMapped[index])return-1;if(value>partsBMapped[index])return 1}return 0}export function isParameterTypeInvalid(parameter,parameterName,options,domain,callback){const buildErrorDetails=(reason,errors)=>{const errorDetails={code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason};return domain&&(errorDetails.domain=domain),errors&&(errorDetails.errors=errors),errorDetails},callCallback=(reason,errors)=>{const errorDetails=buildErrorDetails(reason,errors);return TcHmi.Callback.callSafeEx(callback,null,{error:errorDetails.code,details:errorDetails}),errorDetails},checkOne=variable=>{const checkType=expectedType=>"date"===expectedType?!(variable instanceof Date)&&"Parameter "+parameterName+" is not a Date object, but must be a Date object.":typeof variable!==expectedType?"Parameter "+parameterName+" has type "+typeof variable+", but must have type "+expectedType:"string"===expectedType&&"number"==typeof options.minStringLength&&variable.length<options.minStringLength?"String parameter "+parameterName+" has length of "+variable.length+", but must have at least "+options.minStringLength:!("number"!==expectedType&&"bigint"!==expectedType||"number"!=typeof options.minValue&&"bigint"!=typeof options.minValue)&&variable<options.minValue&&"Numeric parameter "+parameterName+" has value of "+variable+", but must be at least "+options.minValue;if(options.type&&Array.isArray(options.type)){let isValid=!1,errors=[];for(let type of options.type){let res=checkType(type);if(!res){isValid=!0;break}errors.push(buildErrorDetails(res))}return!isValid&&callCallback("Parameter "+parameterName+" has type "+typeof variable+", but must have type which is at least one of "+options.type.join(","),errors)}{let res=checkType(options.type);return!1===res?res:callCallback(res)}};if(void 0!==parameter||"undefinedOk"!==options.required&&"fullOptional"!==options.required){if(null!==parameter||"nullOk"!==options.required&&"fullOptional"!==options.required){if(null==parameter)return callCallback("Parameter "+parameterName+" must not be "+parameter);if(!0===options.expectArray){if(Array.isArray(parameter)){if("number"==typeof options.minArrayLength&&parameter.length<options.minArrayLength)return callCallback("Array parameter "+parameterName+" has "+parameter.length+" items, but must have at least "+options.minArrayLength);if(options.type){for(let item of parameter){const itemIsInvalid=checkOne(item);if(itemIsInvalid)return itemIsInvalid}return!1}return!1}return callCallback("Parameter "+parameterName+" must be an array")}return!1===options.expectArray&&Array.isArray(parameter)?callCallback("Parameter "+parameterName+" must not be an array"):checkOne(parameter)}return!1}return!1}export function resolveServerSymbolNameParts(symbolName){let baseName,basePathTokens,firstBracketPos=symbolName.indexOf("["),firstColonPos=symbolName.indexOf("::"),splitPos=-1;if(splitPos=-1===firstBracketPos?firstColonPos:-1===firstColonPos||firstBracketPos<firstColonPos?firstBracketPos:firstColonPos,-1!==splitPos){baseName=symbolName.substring(0,splitPos);const basePath=symbolName.substring(splitPos);basePathTokens=TcHmi.ObjectPath.toPathTokens(basePath)}else baseName=symbolName,basePathTokens=null;return{name:baseName,pathTokens:basePathTokens}}export function autoLogoffToMilliseconds(autoLogoff){const parts=/^(-)?P(?:(-?[0-9,.]*)Y)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)W)?(?:(-?[0-9,.]*)D)?(?:T(?:(-?[0-9,.]*)H)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)S)?)?$/.exec(autoLogoff);if(null===parts)return null;const years=parseInt(parts[2],10)||0,months=parseInt(parts[3],10)||0,weeks=parseInt(parts[4],10)||0,days=parseInt(parts[5],10)||0,hours=parseInt(parts[6],10)||0,minutes=parseInt(parts[7],10)||0;return 1e3*((parseFloat(parts[8])||0)+60*(minutes+60*(hours+24*(days+30*months+7*weeks)+365*years)))}export function resolveReplaceExpressions(text,replacement){for(let key in replacement)text=text.replace(new RegExp("{"+key+"}","g"),replacement[key]).replace(new RegExp("%7B"+key+"%7D","g"),replacement[key]);return text}export function resolveMarkupReplaceExpressions(url,markup,replaceExpressions){return markup=resolveUserControlMarkupReplaceExpressions(url,resolveContentMarkupReplaceExpressions(url,resolveViewMarkupReplaceExpressions(url,markup)),replaceExpressions)}export function resolveUserControlMarkupReplaceExpressions(url,markup,replaceExpressions){if(Data.isPackageUserControl.get(url)){let module=Data.Modules.userControls.map.get(url);module&&module.package&&(markup=resolveReplaceExpressions(markup,{PkgId:module.package.name,PkgBasePath:module.package.basePath,...replaceExpressions}))}else TCHMI_DESIGNER&&tchmi_path(url)===TCHMI_TARGET_PARTIAL||!Data.isConfigUserControl.get(url)||(markup=resolveReplaceExpressions(markup,{PkgBasePath:".",...replaceExpressions}));return markup}export function resolveContentMarkupReplaceExpressions(url,markup){if(Data.isPackageContent.get(url)){let module=Data.Modules.contents.map.get(url);module&&module.package&&(markup=resolveReplaceExpressions(markup,{PkgId:module.package.name,PkgBasePath:module.package.basePath}))}else TCHMI_DESIGNER&&tchmi_path(url)===TCHMI_TARGET_PARTIAL||!Data.isConfigContent.get(url)||(markup=resolveReplaceExpressions(markup,{PkgBasePath:"."}));return markup}export function resolveViewMarkupReplaceExpressions(url,markup){if(Data.isPackageView.get(url)){let module=Data.Modules.views.map.get(url);module&&module.package&&(markup=resolveReplaceExpressions(markup,{PkgId:module.package.name,PkgBasePath:module.package.basePath}))}else TCHMI_DESIGNER&&tchmi_path(url)===TCHMI_TARGET_PARTIAL||!Data.isConfigView.get(url)||(markup=resolveReplaceExpressions(markup,{PkgBasePath:"."}));return markup}export function promiseTimeout(promise,option){let timeoutId=0;return Promise.race([new Promise((_r,reject)=>setTimeout(()=>{timeoutId=0,reject(new Exception(option?.rejectDetails??{code:TcHmi.Errors.E_TIMEOUT,message:TcHmi.Errors[TcHmi.Errors.E_TIMEOUT],reason:option?.rejectMessage??"Promise did not settle before timeout was reached."}))},option?.timeout??config.tcHmiServer.websocketSystemTimeout)),promise]).finally(()=>{timeoutId&&clearTimeout(timeoutId)})}export function prepareTcHmiConfig(config){config.projectVersion??="1.0.0.0",config.splash??={versionSource:"Framework"},config.basePath??="",config.scaleMode??="None",config.startupView??="",config.activeTheme??="Base",config.themes??={},config.tcHmiServer??={websocketIntervalTime:500,websocketSystemTimeout:6e4,websocketTimeout:2e4,disableOptionalSystemSubscriptions:!1},config.tcHmiServer.websocketIntervalTime||=500,config.tcHmiServer.websocketSystemTimeout||=6e4,config.tcHmiServer.websocketTimeout||=2e4,config.tcHmiServer.disableOptionalSystemSubscriptions??=!1,config.symbols??={internal:{},themedResources:{},timer:{},package:{}},config.symbols.internal??={},config.symbols.themedResources??={},config.symbols.timer??={},config.symbols.package??={},config.trigger??=[],config.packages??=[],config.views??=[],config.controls??=[],config.userFunctions??=[],config.userControls??=[],config.content??=[],config.actionTemplates??=[],config.intervals??={},config.languages??={},config.keyboardLayouts??=[],config.creatorSettings??={},config.creatorSettings.viewport??={defaultHeight:768,defaultWidth:1024},config.binding??={},config.binding.symbolError??="Ignore",config.binding.symbolWriteError??="ReadBack"}export function preparePackageManifest(manifest){manifest.symbols??={internal:{},timer:{},package:{}},manifest.symbols.internal??={},manifest.symbols.timer??={},manifest.symbols.package??={},manifest.actionTemplates??=[],manifest.intervals??={}}
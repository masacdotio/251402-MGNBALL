import{Log}from"../API/Log.js";export class TimerSymbolManager{constructor(){}__items=new Map;__timerPatternMetaDataByDurationPattern=new Map;__timerPatternMetaDataByName=new Map;__createTimerTickHandler(md){return()=>{md.pattern.length>md.currentIndex+1?md.currentIndex++:md.currentIndex=0,md.items.forEach(item=>{if(!item.active)return;for(let patternItem of item.pattern)if(isSymbolPatternItem(patternItem)&&patternItem.symbolPending)return;let currentPatternItem=item.pattern?.[md.currentIndex]??null,value=isSymbolPatternItem(currentPatternItem)?void 0!==currentPatternItem.symbolValue?currentPatternItem.symbolValue:null:isValuePatternItem(currentPatternItem)?currentPatternItem.value:null;item.callbacks.forEach(callback=>{tchmi_equal(callback.lastReportedValue,value)||(callback.lastReportedValue=value,TcHmi.Callback.callSafeEx(callback.callback,this,{error:TcHmi.Errors.NONE,destroy:callback.destroy,value:tchmi_clone_object(value)}))})}),md.timeoutId=setTimeout(this.__createTimerTickHandler(md),md.pattern[md.currentIndex])}}__createRunSymbolWatchHandler(_name,item){return data=>{if(data.error!==TcHmi.Errors.NONE){let value=void 0!==item.stopValue?item.stopValue:null;return item.active=!1,item.callbacks.forEach(callback=>{tchmi_equal(callback.lastReportedValue,value)||(callback.lastReportedValue=value,TcHmi.Callback.callSafeEx(callback.callback,this,{error:TcHmi.Errors.NONE,destroy:callback.destroy,value:tchmi_clone_object(value)}))}),void Log.error(`[Source=Framework, Module=TcHmi.System.TimerSymbolManager, Name=${_name}] RunSymbol error. ${data.details?" Details: "+Log.buildMessage(data.details):""}`)}if(!0===data.value)item.active=!0;else if(!1===data.value){let value=void 0!==item.stopValue?item.stopValue:null;item.active=!1,item.callbacks.forEach(callback=>{tchmi_equal(callback.lastReportedValue,value)||(callback.lastReportedValue=value,TcHmi.Callback.callSafeEx(callback.callback,this,{error:TcHmi.Errors.NONE,destroy:callback.destroy,value:tchmi_clone_object(value)}))})}}}__createPatternSymbolWatchHandler(_name,patternItem){return data=>{if(data.error!==TcHmi.Errors.NONE)return patternItem.symbolValue=null,void(patternItem.symbolPending=!1);patternItem.symbolValue=data.value,patternItem.symbolPending=!1}}add(name,item,callbacks){item.pattern||(item.pattern=[]);let runSymbol,runSymbolWatchDestroy,itemEx={...item,callbacks:callbacks??[],active:!0,destroy:()=>{if(runSymbolWatchDestroy?.(),runSymbol?.destroy(),patternSymbolDestroyer)for(let patternSymbolDestroy of patternSymbolDestroyer)patternSymbolDestroy()}};this.__items.set(name,itemEx),itemEx.runSymbol&&TcHmi.Symbol.isSymbolExpression(itemEx.runSymbol)&&(itemEx.active=!1,runSymbol=new TcHmi.Symbol(itemEx.runSymbol),runSymbolWatchDestroy=runSymbol.watch(this.__createRunSymbolWatchHandler(name,itemEx)));let patternSymbolDestroyer=[],pattern=[];itemEx.pattern.forEach(patternItem=>{if(pattern.push(patternItem.duration),isSymbolPatternItem(patternItem)&&TcHmi.Symbol.isSymbolExpression(patternItem.symbol)){patternItem.symbolPending=!0;let patternSymbol=new TcHmi.Symbol(patternItem.symbol),patternSymbolWatchDestroy=patternSymbol.watch(this.__createPatternSymbolWatchHandler(name,patternItem));patternSymbolDestroyer.push(()=>{patternSymbolWatchDestroy?.(),patternSymbol?.destroy()})}});let patternKey=pattern.join(";"),md=this.__timerPatternMetaDataByDurationPattern.get(patternKey);if(md)md.items.set(name,itemEx);else{let items=new Map;items.set(name,itemEx),md={items,pattern,currentIndex:0,timeoutId:0},this.__timerPatternMetaDataByDurationPattern.set(patternKey,md)}this.__timerPatternMetaDataByName.set(name,md);const currentPatternItem=itemEx.pattern?.[md.currentIndex]??null;let value;value=TCHMI_DESIGNER?void 0!==itemEx.stopValue?itemEx.stopValue:null:itemEx.active?isSymbolPatternItem(currentPatternItem)?void 0!==currentPatternItem.symbolValue?currentPatternItem.symbolValue:null:isValuePatternItem(currentPatternItem)?currentPatternItem.value:null:void 0!==itemEx.stopValue?itemEx.stopValue:null,itemEx.callbacks.forEach(callback=>{tchmi_equal(callback.lastReportedValue,value)||(callback.lastReportedValue=value,TcHmi.Callback.callSafeEx(callback.callback,this,{error:TcHmi.Errors.NONE,destroy:callback.destroy,value:tchmi_clone_object(value)}))})}remove(name){let md=this.__timerPatternMetaDataByName.get(name);if(md){let item=md.items.get(name);if(item&&(item.callbacks.forEach(callback=>{null!==callback.lastReportedValue&&(callback.lastReportedValue=null,TcHmi.Callback.callSafeEx(callback.callback,this,{error:TcHmi.Errors.NONE,destroy:callback.destroy,value:null}))}),item.destroy(),md.items.delete(name)),0===md.items.size){clearTimeout(md.timeoutId),md.timeoutId=0,this.__timerPatternMetaDataByName.delete(name);let patternKey=md.pattern.join(";");this.__timerPatternMetaDataByDurationPattern.delete(patternKey)}}this.__items.delete(name)}update(name,item){let currentItem=this.__items.get(name);if(!currentItem)return void this.add(name,item);let callbacks=currentItem.callbacks;this.remove(name),this.add(name,item,callbacks)}get(name){return this.__items.get(name)}read(name,callback){let item=this.__items.get(name);if(!item)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Timer symbol with name="+name+" does not exist.",domain:"TcHmi.System.TimerSymbolManager"}});let md=this.__timerPatternMetaDataByName.get(name);if(!md)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Timer symbol meta data for name="+name+" does not exist.",domain:"TcHmi.System.TimerSymbolManager"}});const currentPatternItem=item.pattern?.[md.currentIndex]??null;let value;value=TCHMI_DESIGNER?void 0!==item.stopValue?item.stopValue:null:item.active?isSymbolPatternItem(currentPatternItem)?void 0!==currentPatternItem.symbolValue?currentPatternItem.symbolValue:null:isValuePatternItem(currentPatternItem)?currentPatternItem.value:null:void 0!==item.stopValue?item.stopValue:null,TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(value)})}watch(name,callback){let entry=this.__items.get(name);if(!entry)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Timer symbol with name="+name+" does not exist.",domain:"TcHmi.System.TimerSymbolManager"}}),function(){};let md=this.__timerPatternMetaDataByName.get(name);if(!md)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Timer symbol meta data for name="+name+" does not exist.",domain:"TcHmi.System.TimerSymbolManager"}}),function(){};let item=md.items.get(name);if(!item)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Timer symbol item for name="+name+" does not exist.",domain:"TcHmi.System.TimerSymbolManager"}}),function(){};let destroy=function(){if(!entry)return;let index=entry.callbacks.indexOf(co);-1!==index&&(entry.callbacks.splice(index,1),co.callback=null),entry=void 0},co={callback,destroy};entry.callbacks.push(co);const currentPatternItem=item.pattern?.[md.currentIndex]??null;let value;return value=TCHMI_DESIGNER?void 0!==item.stopValue?item.stopValue:null:item.active?isSymbolPatternItem(currentPatternItem)?void 0!==currentPatternItem.symbolValue?currentPatternItem.symbolValue:null:isValuePatternItem(currentPatternItem)?currentPatternItem.value:null:void 0!==item.stopValue?item.stopValue:null,tchmi_equal(co.lastReportedValue,value)||(co.lastReportedValue=value,TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,destroy,value:tchmi_clone_object(value)})),destroy}getType(name,callback){let entry=this.__items.get(name);entry?TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,type:entry.type}):TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Timer symbol with name="+name+" does not exist.",domain:"TcHmi.System.InternalSymbolManager"}})}run(){TCHMI_DESIGNER||this.__timerPatternMetaDataByDurationPattern.forEach((md,pattern)=>{md.timeoutId||(md.timeoutId=setTimeout(this.__createTimerTickHandler(md),md.pattern[0]))})}stop(){this.__timerPatternMetaDataByDurationPattern.forEach((md,pattern)=>{md.timeoutId&&(clearTimeout(md.timeoutId),md.timeoutId=0),0!==md.currentIndex&&(md.currentIndex=0,md.items.forEach(item=>{let currentPatternItem=item.pattern?.[md.currentIndex]??null,value=item.active?isSymbolPatternItem(currentPatternItem)?void 0!==currentPatternItem.symbolValue?currentPatternItem.symbolValue:null:isValuePatternItem(currentPatternItem)?currentPatternItem.value:null:void 0!==item.stopValue?item.stopValue:null;item.callbacks.forEach(callback=>{tchmi_equal(callback.lastReportedValue,value)||(callback.lastReportedValue=value,TcHmi.Callback.callSafeEx(callback.callback,this,{error:TcHmi.Errors.NONE,destroy:callback.destroy,value:tchmi_clone_object(value)}))})}))})}}export function isValuePatternItem(value){return!!value&&void 0!==value.value}export function isSymbolPatternItem(value){return!!value&&void 0!==value.symbol}export const timerSymbolManager=new TimerSymbolManager;
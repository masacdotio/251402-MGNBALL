import{internalSymbolManager}from"./InternalSymbolManager.js";import*as ValueConverter from"../API/ValueConverter.js";import{Log}from"../API/Log.js";export class SymbolTypeInternal extends TcHmi.Destroyable{constructor(symbol){super(),this.__symbol=symbol,this.__symbolExpressionString=this.__symbol.getExpression().toString(),this.__symbolDiagGUID=this.__symbol.getDiagGUID()}__symbol;__symbolExpressionString;__symbolDiagGUID;__printExpression(expression){let message=this.__symbolExpressionString;return expression?(this.__symbolExpressionString!==expression.toString()&&(message+=` (Resolved to: '${expression.toString()}')`),message):message}destroy(){this.isDestroyed()||(this.__releaseDestroyPrivilege(),this.isDestroyable()&&(this.__symbol=null))}read(expression,options,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}});const name=expression.getName();name?internalSymbolManager.read(name,data=>{if(this.__symbol){if(data.error===TcHmi.Errors.NONE){let pathTokens=expression.getPathTokens();if(pathTokens&&pathTokens.length>0)return void this.__symbol.__helper.readSubValue(expression,data.value,pathTokens,name,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){let value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})});{let value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expression:this.__symbol.getExpression(),expressionResolved:expression})}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression})}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypeInternal"},expression:this.__symbol.getExpression(),expressionResolved:expression})}write(expression,value,options,dirtyPaths,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}});null===dirtyPaths&&(dirtyPaths=void 0);const name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypeInternal"},expression:this.__symbol.getExpression(),expressionResolved:expression});const path=expression.getPath(),pathTokens=expression.getPathTokens();this.__symbol.__helper.resolveSchema(expression,dataResolveSchema=>{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}});if(dataResolveSchema&&dataResolveSchema.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:this.__printExpression(expression)+": Failed to resolve schema definition",domain:"TcHmi.System.SymbolTypeInternal",errors:dataResolveSchema.details?[dataResolveSchema.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression});let schema=this.__symbol.__helper.getSchema(),newValue=tchmi_clone_object(value),dirtyPathsNew=[];if(!(path&&pathTokens&&pathTokens.length>0)){let prepValue=ValueConverter.toSchemaType(newValue,schema);if(null===prepValue&&null!==newValue){let reason,value=newValue;return reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor.name+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+String(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".",void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.SymbolTypeInternal"},expression:this.__symbol.getExpression(),expressionResolved:expression})}if(Array.isArray(prepValue)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;void 0!==start||void 0!==end?internalSymbolManager.read(name,dataRead=>{if(this.__symbol)if(dataRead.error===TcHmi.Errors.NONE){let currentValue=dataRead.value,currentCloneValue=tchmi_clone_object(currentValue);if(!Array.isArray(currentCloneValue))return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+": Failed to write value. Current value is not an array.",domain:"TcHmi.System.SymbolTypeInternal"},expression:this.__symbol.getExpression(),expressionResolved:expression});{let newValue=tchmi_clone_object(currentCloneValue),res=this.__symbol.__helper.writeArraySlice(newValue,prepValue,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);internalSymbolManager.write(name,newValue,void 0,data=>{this.__symbol?data.error!==TcHmi.Errors.NONE?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):internalSymbolManager.read(name,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){if(Array.isArray(data.value)){let res=this.__symbol.__helper.readArraySlice(data.value,start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:res.error,details:res.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(res.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})})}}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:dataRead.error,details:dataRead.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})}):internalSymbolManager.write(name,prepValue,void 0,data=>{this.__symbol?data.error!==TcHmi.Errors.NONE?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):internalSymbolManager.read(name,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){if(Array.isArray(data.value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(data.value,start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:res.error,details:res.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(res.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})})}else internalSymbolManager.write(name,prepValue,void 0,data=>{this.__symbol?data.error!==TcHmi.Errors.NONE?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):internalSymbolManager.read(name,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){if(Array.isArray(data.value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(data.value,start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:res.error,details:res.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(res.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})});return}if(dirtyPaths&&dirtyPaths.length>0)for(let i=0,ii=dirtyPaths.length;i<ii;i++)dirtyPathsNew.push(path+dirtyPaths[i]);else dirtyPathsNew.push(path);internalSymbolManager.read(name,dataRead=>{if(this.__symbol)if(dataRead.error===TcHmi.Errors.NONE){let currentSubValue,currentSubValueErrorDetails,currentValue=dataRead.value,currentCloneValue=tchmi_clone_object(currentValue);if(this.__symbol.__helper.readSubValue(expression,currentCloneValue,pathTokens,name,data=>{this.__symbol?data.error===TcHmi.Errors.NONE?currentSubValue=tchmi_clone_object(data.value):currentSubValueErrorDetails={code:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR],reason:this.__printExpression(expression)+": Error while reading sub value.",domain:"TcHmi.System.SymbolTypeInternal",errors:[data.details?data.details:{code:data.error,message:TcHmi.Errors[data.error]}]}:TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})}),currentSubValueErrorDetails)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,details:currentSubValueErrorDetails,expression:this.__symbol.getExpression(),expressionResolved:expression});let prepValue=ValueConverter.toSchemaType(newValue,schema);if(null===prepValue&&null!==newValue){let reason,value=newValue;return reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor.name+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+value+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".",void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.SymbolTypeInternal"},expression:this.__symbol.getExpression(),expressionResolved:expression})}if(Array.isArray(prepValue)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){if(!Array.isArray(currentSubValue))return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+": Failed to write value. Current value is not an array.",domain:"TcHmi.System.SymbolTypeInternal"},expression:this.__symbol.getExpression(),expressionResolved:expression});{let temp=tchmi_clone_object(currentSubValue),res=this.__symbol.__helper.writeArraySlice(temp,prepValue,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);prepValue=temp}}}if(tchmi_equal(currentSubValue,prepValue))return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(prepValue),expressionResolved:expression,expression:this.__symbol.getExpression()},{equal:!0});this.__symbol.__helper.writeSubValue(expression,currentCloneValue,prepValue,pathTokens,name,data=>{this.__symbol?data.error===TcHmi.Errors.NONE?internalSymbolManager.write(name,currentCloneValue,void 0,dataWrite=>{this.__symbol?data.error!==TcHmi.Errors.NONE?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:dataWrite.error,details:dataWrite.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):internalSymbolManager.read(name,data=>{this.__symbol?data.error===TcHmi.Errors.NONE?this.__symbol.__helper.readSubValue(expression,tchmi_clone_object(data.value),pathTokens,name,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){if(Array.isArray(data.value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(data.value,start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:res.error,details:res.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(res.value),expression:this.__symbol.getExpression(),expressionResolved:expression})}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,details:{code:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR],reason:this.__printExpression(expression)+": Error while writing sub value.",domain:"TcHmi.System.SymbolTypeInternal",errors:[data.details?data.details:{code:data.error,message:TcHmi.Errors[data.error]}]},expression:this.__symbol.getExpression(),expressionResolved:expression}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:dataRead.error,details:dataRead.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})})})}watch(expression,options,callback,reason){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}}),()=>{};let destroySubWatch,diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid());let destroy=()=>{Log.debug("[Source=Framework, Module=TcHmi.System.Symbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch destroy called."),destroySubWatch&&(destroySubWatch(),destroySubWatch=null)};const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypeInternal"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;let last;return destroySubWatch=internalSymbolManager.watch(name,data=>{if(this.__symbol){if(destroySubWatch||(destroySubWatch=data.destroy),data.error===TcHmi.Errors.NONE){let pathTokens=expression.getPathTokens();if(pathTokens&&pathTokens.length>0){let doWork=!1,dirtyPaths=data.dirtyPaths,dirtyPathsNew=[];if(dirtyPaths){let pathSanitized=this.__symbol.__helper.resolveSanitizedPath(pathTokens);for(let i=0,ii=dirtyPaths.length;i<ii;i++){let dirtyPath=dirtyPaths[i];dirtyPath.startsWith(pathSanitized)?(doWork=!0,dirtyPath!==pathSanitized&&dirtyPathsNew.push(dirtyPath.replace(pathSanitized,""))):pathSanitized.startsWith(dirtyPath)&&(doWork=!0)}}else doWork=!0;return void(doWork&&this.__symbol.__helper.readSubValue(expression,data.value,pathTokens,name,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){let res,value=data.value;if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);if(value=res.value,void 0!==last&&tchmi_equal(last,value))return;last=tchmi_clone_object(value)}}res=dirtyPathsNew&&dirtyPathsNew.length>0?{error:TcHmi.Errors.NONE,value:tchmi_clone_object(value),expressionResolved:expression,expression:this.__symbol.getExpression(),dirtyPaths:dirtyPathsNew,destroy}:{error:TcHmi.Errors.NONE,value:tchmi_clone_object(value),expressionResolved:expression,expression:this.__symbol.getExpression(),destroy},Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}else{const res={error:data.error,details:data.details,destroy,expression:this.__symbol.getExpression(),expressionResolved:expression};Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})}))}{let res,value=data.value;if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);if(value=res.value,void 0!==last&&tchmi_equal(last,value))return;last=tchmi_clone_object(value)}}return res={error:TcHmi.Errors.NONE,value:tchmi_clone_object(value),expressionResolved:expression,expression:this.__symbol.getExpression(),destroy},Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}}{let res={error:data.error,details:{code:data.error,message:TcHmi.Errors[data.error],reason:this.__printExpression(expression)+": Failed to watch",domain:"TcHmi.System.Symbol",errors:data.details?[data.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}}TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeInternal"}})}),destroy}}
import{SyncCmdToFramework,registerCommand}from"./SyncCmdToFramework.js";import{localizationManager}from"../LocalizationManager.js";import{viewManager}from"../ViewManager.js";import{themeManager}from"../ThemeManager.js";import{serverManager}from"../ServerManager.js";import{Data,destroyGlobalTrigger,setConfig,config as liveConfig,setDestroyGlobalTrigger}from"../System.js";import{triggerManager}from"../TriggerManager.js";import{timerSymbolManager}from"../TimerSymbolManager.js";import{controlManager}from"../ControlManager.js";import{internalSymbolManager}from"../InternalSymbolManager.js";import{intervalManager}from"../IntervalManager.js";import{preparePackageManifest,prepareTcHmiConfig,resolveReplaceExpressions}from"../SystemFunctions.js";import{keyboardManager}from"../KeyboardManager.js";import{packageSymbolManager}from"../PackageSymbolManager.js";let rootControlManager;TCHMI_ENGINEERING||TcHmi.Log.errorEx(`Internal error: The file "${import.meta.url}" is restricted to use within the designer or live view.`),TCHMI_DESIGNER&&import("./DesignerModeMasterRootControlMngr.js").then(module=>{rootControlManager=module.rootControlManager}).catch(ex=>{TcHmi.Log.error("Failed to load rootControlManager in Framework SyncCmdToFrameworkTcHmiConfigChanged: "+ex)});export class SyncCmdToFrameworkTcHmiConfigChanged extends SyncCmdToFramework{constructor(cmd){super(cmd)}__doReloadTcHmiConfig(url){let configOld=liveConfig,xhr=new XMLHttpRequest;xhr.open("GET","Properties/tchmiconfig.json?preventcache="+Math.random()),xhr.addEventListener("load",_event=>{if(200===xhr.status){const config=TcHmi.ValueConverter.toObject(xhr.responseText);if(null===config)return;prepareTcHmiConfig(config),this.__doRefreshTcHmiConfig(config,configOld)}else TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+" Command will be ignored. Details: HTTP error "+xhr.status+" "+xhr.statusText)}),xhr.addEventListener("error",_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+" Command will be ignored. HTTP error "+xhr.status+" "+xhr.statusText)}),xhr.send()}__doRefreshTcHmiConfig(config,configOld){setConfig(config),liveConfig.basePath=configOld.basePath,liveConfig.tcHmiServer?liveConfig.tcHmiServer.websocketIntervalTime||(liveConfig.tcHmiServer.websocketIntervalTime=configOld.tcHmiServer.websocketIntervalTime):liveConfig.tcHmiServer=configOld.tcHmiServer,this.__refreshBaseConfig(config,configOld),this.__refreshViewPartials(config.views,configOld.views),this.__refreshContentPartials(config.content,configOld.content),this.__refreshUserControlPartials(config.userControls,configOld.userControls),this.__refreshSymbols(config.symbols,configOld.symbols),this.__refreshLanguage(config.languages,configOld.languages),this.__refreshLanguageFallback(config.languageFallback,configOld.languageFallback),this.__refreshSystemKeyboard(config.systemKeyboard,configOld.systemKeyboard),this.__refreshIntervals(config.intervals,configOld.intervals),this.__refreshConfigPackageInfo(config.packages,configOld.packages),tchmi_equal(config,configOld)||TcHmi.EventProvider.raise("onConfigChanged",{configNew:config,configOld})}__doReloadManifest(url,packageName){if(!packageName)return;let manifest=null,xhr=new XMLHttpRequest;xhr.open("GET",url+"?preventcache="+Math.random()),xhr.addEventListener("load",_event=>{if(200===xhr.status){let packageInfo=Data.packages.get(packageName);if(packageInfo&&(manifest=TcHmi.ValueConverter.toObject(resolveReplaceExpressions(xhr.responseText,{PkgId:packageInfo.name,PkgBasePath:packageInfo.basePath}))),!manifest)return;if(!packageInfo)return;preparePackageManifest(manifest),this.__doRefreshManifest(manifest,packageName,packageInfo)}else TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+" Command will be ignored. Details: HTTP error "+xhr.status+" "+xhr.statusText)}),xhr.addEventListener("error",_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+" Command will be ignored. HTTP error "+xhr.status+" "+xhr.statusText)}),xhr.send()}__doRefreshManifest(manifest,packageName,packageInfo){let manifestOld=packageInfo.manifest;packageInfo.manifest=manifest,this.__refreshSymbols(manifest.symbols,manifestOld.symbols,packageName,packageInfo),this.__refreshIntervals(manifest.intervals,manifestOld.intervals,packageName,packageInfo)}__refreshBaseConfig(config,configOld){config.scaleMode!==configOld.scaleMode&&viewManager.setScaleMode(config.scaleMode),TCHMI_DESIGNER?config.creatorSettings&&config.creatorSettings.viewport&&(config.creatorSettings.viewport.defaultHeight!==configOld.creatorSettings.viewport.defaultHeight||config.creatorSettings.viewport.defaultWidth!==configOld.creatorSettings.viewport.defaultWidth)&&rootControlManager?.setCreatorViewPortPosition(viewManager.getView()):config.startupView!==configOld.startupView&&viewManager.loadView(config.startupView),config.activeTheme!==configOld.activeTheme?themeManager.setTheme(config.activeTheme,!0):tchmi_equal(config.themes,configOld.themes)&&tchmi_equal(config.dependencyFiles?.filter(value=>"Stylesheet"===value.type),configOld.dependencyFiles?.filter(value=>"Stylesheet"===value.type))||themeManager.processActiveTheme(),tchmi_equal(config.trigger,configOld.trigger)||(destroyGlobalTrigger&&(destroyGlobalTrigger(),setDestroyGlobalTrigger(null)),setDestroyGlobalTrigger(triggerManager.register(tchmi_clone_object(config.trigger)))),TCHMI_ENGINEERING&&TCHMI_LIVEVIEW&&!tchmi_equal(config.tcHmiServer,configOld.tcHmiServer)&&serverManager.refreshSubscriptions()}__refreshViewPartials(views,viewsOld){if(null==views||null==viewsOld)return;let viewsRemoved=[];for(let i=0,ii=viewsOld.length;i<ii;i++){let po=viewsOld[i],bExists=!1;for(let j=0,jj=views.length;j<jj;j++){if(views[j].url===po.url){bExists=!0;break}}bExists||viewsRemoved.push(po)}let viewsCreated=[];for(let i=0,ii=views.length;i<ii;i++){let p=views[i],bExists=!1;for(let j=0,jj=viewsOld.length;j<jj;j++){let po=viewsOld[j];if(p.url===po.url){bExists=!0;break}}bExists||viewsCreated.push(p)}for(let i=0,ii=viewsRemoved.length;i<ii;i++){let v=viewsRemoved[i];if(void 0===v.url||null===v.url)continue;let cleanUrl=tchmi_path(v.url);Data.Caches.partialMarkupCache.delete(cleanUrl),TcHmi.EventProvider.raise("System.onViewRemoved",{url:cleanUrl})}for(let i=0,ii=viewsCreated.length;i<ii;i++){let v=viewsCreated[i];this.__loadViewPartial(v,this.__loadViewPartialCallback)}}__loadViewPartialCallback(v,vm){if(null==vm)return;let cacheEntry,cleanUrl=tchmi_path(v.url);if(void 0!==v.url&&null!==v.url&&v.preload&&(cacheEntry={markup:vm},Data.Caches.partialMarkupCache.set(cleanUrl,cacheEntry)),v.preload&&void 0!==v.url&&null!==v.url&&!TCHMI_DESIGNER){let tempDiv=document.createElement("div");if(tempDiv.innerHTML=vm,tempDiv.firstElementChild){const tco=controlManager.compile(tempDiv.firstElementChild).control;void 0!==tco&&(cacheEntry&&(cacheEntry.partialId=tco.getId()),tco.__setKeepAlive(!0),tco.getElement().attr("data-tchmi-partial-url",v.url))}}TcHmi.EventProvider.raise("System.onViewCreated",{url:cleanUrl})}__loadViewPartial(v,callback){let vm=null;if(v.preload&&!TCHMI_DESIGNER){let xhr=new XMLHttpRequest;xhr.open("GET",tchmi_encode_uri_components(v.url)+"?preventcache="+Math.random()),xhr.addEventListener("load",_event=>{200===xhr.status?vm=xhr.responseText:TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+v.url+" Details: HTTP error "+xhr.status+" "+xhr.statusText),TcHmi.Callback.callSafeEx(callback,null,v,vm)}),xhr.addEventListener("error",_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+v.url+" Details: HTTP error "+xhr.status+" "+xhr.statusText),TcHmi.Callback.callSafeEx(callback,null,v,vm)}),xhr.send()}}__refreshContentPartials(content,contentOld){if(null==content||null==contentOld)return;let contentRemoved=[];for(let i=0,ii=contentOld.length;i<ii;i++){let po=contentOld[i],bExists=!1;for(let j=0,jj=content.length;j<jj;j++){if(content[j].url===po.url){bExists=!0;break}}bExists||contentRemoved.push(po)}let contentCreated=[];for(const p of content){Data.isLoadSyncContent.set(p.url,p.loadSync??!1);let bExists=!1;for(let j=0,jj=contentOld.length;j<jj;j++){let po=contentOld[j];if(p.url===po.url){bExists=!0;break}}bExists||contentCreated.push(p)}for(let i=0,ii=contentRemoved.length;i<ii;i++){let c=contentRemoved[i];if(void 0===c.url||null===c.url)continue;let cleanUrl=tchmi_path(c.url);Data.Caches.partialMarkupCache.delete(cleanUrl),TcHmi.EventProvider.raise("System.onContentRemoved",{url:cleanUrl})}for(let i=0,ii=contentCreated.length;i<ii;i++){let v=contentCreated[i];this.__loadViewPartial(v,this.__loadViewPartialCallback)}}__loadUserControlPartial(uc,callback){let ucm=null,ucc=null,uccUrl=uc.url.replace(".usercontrol",".usercontrol.json"),xhrDescr=new XMLHttpRequest;xhrDescr.open("GET",tchmi_encode_uri_components(uc.url)+"?preventcache="+Math.random()),xhrDescr.addEventListener("load",_event=>{if(200===xhrDescr.status){ucm=xhrDescr.responseText;let xhr=new XMLHttpRequest;xhr.open("GET",tchmi_encode_uri_components(uccUrl)+"?preventcache="+Math.random()),xhr.addEventListener("load",_event=>{200===xhr.status?ucc=TcHmi.ValueConverter.toObject(xhr.responseText):TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+uccUrl+" Details: HTTP error "+xhr.status+" "+xhr.statusText),TcHmi.Callback.callSafeEx(callback,null,uc,ucm,ucc)}),xhr.addEventListener("error",_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+uccUrl+" Details: HTTP error "+xhr.status+" "+xhr.statusText),TcHmi.Callback.callSafeEx(callback,null,uc,ucm,ucc)}),xhr.send()}else TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+uc.url+" Details: HTTP error "+xhrDescr.status+" "+xhrDescr.statusText),TcHmi.Callback.callSafeEx(callback,null,uc,ucm,ucc)}),xhrDescr.addEventListener("error",_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+uc.url+", status="+xhrDescr.status),TcHmi.Callback.callSafeEx(callback,null,uc,ucm,ucc)}),xhrDescr.send()}__loadUserControlPartialCallback(uc,ucm,ucc){if(null==ucm)return;let cacheEntry,cleanUcUrl=tchmi_path(uc.url),cleanUcConfigUrl=tchmi_path(uc.url.replace(".usercontrol",".usercontrol.json"));void 0!==uc.url&&null!==uc.url&&(cacheEntry={markup:ucm},Data.Caches.partialMarkupCache.set(cleanUcUrl,cacheEntry)),null!=ucc&&void 0!==uc.url&&null!==uc.url&&Data.Caches.partialCompositeConfigCache.set(cleanUcConfigUrl,ucc),TcHmi.EventProvider.raise("System.onUserControlCreated",{url:cleanUcUrl}),TcHmi.EventProvider.raise("System.onUserControlConfigCreated",{url:cleanUcConfigUrl})}__refreshUserControlPartials(userControls,userControlsOld){if(null==userControls||null==userControlsOld)return;let userControlsRemoved=[];for(let i=0,ii=userControlsOld.length;i<ii;i++){let po=userControlsOld[i],bExists=!1;for(let j=0,jj=userControls.length;j<jj;j++){userControls[j].url===po.url&&(bExists=!0)}bExists||userControlsRemoved.push(po)}let userControlsCreated=[];for(let i=0,ii=userControls.length;i<ii;i++){let p=userControls[i],bExists=!1;for(let j=0,jj=userControlsOld.length;j<jj;j++){let po=userControlsOld[j];p.url===po.url&&(bExists=!0)}bExists||userControlsCreated.push(p)}for(let i=0,ii=userControlsRemoved.length;i<ii;i++){let uc=userControlsRemoved[i];if(void 0===uc.url||null===uc.url)continue;let cleanUcUrl=tchmi_path(uc.url),cleanUcConfigUrl=tchmi_path(uc.url.replace(".usercontrol",".usercontrol.json"));Data.Caches.partialMarkupCache.delete(cleanUcUrl),Data.Caches.partialCompositeConfigCache.delete(cleanUcConfigUrl),TcHmi.EventProvider.raise("System.onUserControlRemoved",{url:cleanUcUrl}),TcHmi.EventProvider.raise("System.onUserControlConfigRemoved",{url:cleanUcConfigUrl})}for(const uc of userControlsCreated)this.__loadUserControlPartial(uc,this.__loadUserControlPartialCallback)}__refreshSymbols(symbols,symbolsOld,packageName,packageInfo){this.__refreshSymbolsInternal(symbols.internal,symbolsOld.internal,packageName,packageInfo),this.__refreshSymbolsTimer(symbols.timer,symbolsOld.timer,packageName,packageInfo),this.__refreshSymbolsPackage(symbols.package,symbolsOld.package,packageName,packageInfo),packageName||tchmi_equal(symbols.themedResources,symbols.themedResources)||themeManager.processThemedResources()}__refreshSymbolsInternal(symbols,symbolsOld,packageName,packageInfo){let i=0,ii=0,key=null,keyOld=null,bRemove=!1,remove=[],bCreate=!1,create=[],update=[];if(null!=symbolsOld&&null!=symbols)for(keyOld in symbolsOld)if(symbolsOld.hasOwnProperty(keyOld)){for(key in bRemove=!0,symbols)if(symbols.hasOwnProperty(key)){if(keyOld===key){bRemove=!1;break}key=null}bRemove&&remove.push(keyOld),bRemove=!1,keyOld=null}for(i=0,ii=remove.length;i<ii;i++)packageName?internalSymbolManager.remove(`Package:${packageName};${remove[i]}`):(internalSymbolManager.remove(remove[i]),internalSymbolManager.remove(`Package:{PkgId};${remove[i]}`));if(null!=symbolsOld&&null!=symbols)for(key in symbols)if(symbols.hasOwnProperty(key)){for(keyOld in bCreate=!0,symbolsOld)if(symbolsOld.hasOwnProperty(keyOld)&&key===keyOld){bCreate=!1,tchmi_equal(symbols[key].value,symbolsOld[keyOld].value)&&symbols[key].persist===symbolsOld[keyOld].persist&&symbols[key].type===symbolsOld[keyOld].type&&symbols[key].readonly===symbolsOld[keyOld].readonly||update.push({key,item:symbols[key]});break}bCreate&&create.push({key,item:symbols[key]})}for(const entry of create){const item=tchmi_clone_object(entry.item);packageName?internalSymbolManager.add(`Package:${packageName};${entry.key}`,item):(internalSymbolManager.add(entry.key,item),internalSymbolManager.add(`Package:{PkgId};${entry.key}`,item))}for(const entry of update){const item=tchmi_clone_object(entry.item);packageName?internalSymbolManager.update(`Package:${packageName};${entry.key}`,item):(internalSymbolManager.update(entry.key,item),internalSymbolManager.update(`Package:{PkgId};${entry.key}`,item))}}__refreshSymbolsTimer(symbols,symbolsOld,packageName,packageInfo){let i=0,ii=0,key=null,keyOld=null,bRemove=!1,remove=[],bCreate=!1,create=[],update=[];if(!tchmi_equal(symbols,symbolsOld)){if(timerSymbolManager.stop(),null!=symbolsOld&&null!=symbols)for(keyOld in symbolsOld)if(symbolsOld.hasOwnProperty(keyOld)){for(key in bRemove=!0,symbols)if(symbols.hasOwnProperty(key)){if(keyOld===key){bRemove=!1;break}key=null}bRemove&&remove.push(keyOld),bRemove=!1,keyOld=null}for(i=0,ii=remove.length;i<ii;i++)packageName?timerSymbolManager.remove(`Package:${packageName};${remove[i]}`):(timerSymbolManager.remove(remove[i]),timerSymbolManager.remove(`Package:{PkgId};${remove[i]}`));if(null!=symbolsOld&&null!=symbols)for(key in symbols)if(symbols.hasOwnProperty(key)){for(keyOld in bCreate=!0,symbolsOld)if(symbolsOld.hasOwnProperty(keyOld)&&key===keyOld){bCreate=!1,tchmi_equal(symbols[key],symbolsOld[keyOld])||update.push({key,item:symbols[key]});break}bCreate&&create.push({key,item:symbols[key]})}for(const entry of create){const item=tchmi_clone_object(entry.item);packageName?timerSymbolManager.add(`Package:${packageName};${entry.key}`,item):(timerSymbolManager.add(entry.key,entry.item),timerSymbolManager.add(`Package:{PkgId};${entry.key}`,item))}for(const entry of update){const item=tchmi_clone_object(entry.item);packageName?timerSymbolManager.update(`Package:${packageName};${entry.key}`,item):(timerSymbolManager.update(entry.key,item),timerSymbolManager.update(`Package:{PkgId};${entry.key}`,item))}timerSymbolManager.run()}}__refreshSymbolsPackage(symbols,symbolsOld,packageName,packageInfo){let i=0,ii=0,key=null,keyOld=null,bRemove=!1,remove=[],bCreate=!1,create=[],update=[];if(null!=symbolsOld&&null!=symbols)for(keyOld in symbolsOld)if(symbolsOld.hasOwnProperty(keyOld)){for(key in bRemove=!0,symbols)if(symbols.hasOwnProperty(key)){if(keyOld===key){bRemove=!1;break}key=null}bRemove&&remove.push(keyOld),bRemove=!1,keyOld=null}for(i=0,ii=remove.length;i<ii;i++)packageName?(packageSymbolManager.remove(remove[i]),packageSymbolManager.remove(`Package:${packageName};${remove[i]}`)):(packageSymbolManager.remove(remove[i]),packageSymbolManager.remove(`Package:{PkgId};${remove[i]}`),internalSymbolManager.remove(`Package_Symbol_Engineering_Mapping_Symbol_Simulation:{PkgId};${remove[i]}`));if(null!=symbolsOld&&null!=symbols)for(key in symbols)if(symbols.hasOwnProperty(key)){for(keyOld in bCreate=!0,symbolsOld)if(symbolsOld.hasOwnProperty(keyOld)&&key===keyOld){bCreate=!1,tchmi_equal(symbols[key].type,symbolsOld[keyOld].type)||update.push({key,item:symbols[key]});break}bCreate&&create.push({key,item:symbols[key]})}for(const entry of create)if(packageName){if(packageInfo&&packageInfo.config&&packageInfo.config.symbols&&packageInfo.config.symbols.package){let mapping=packageInfo.config.symbols.package[entry.key];packageSymbolManager.add(`Package:${packageName};${entry.key}`,mapping)}}else{const mapping={type:entry.item.type,symbol:`%i%Package_Symbol_Engineering_Mapping_Symbol_Simulation:{PkgId};${entry.key}%/i%`};internalSymbolManager.add(`Package_Symbol_Engineering_Mapping_Symbol_Simulation:{PkgId};${entry.key}`,{type:entry.item.type}),packageSymbolManager.add(entry.key,mapping),packageSymbolManager.add(`Package:{PkgId};${entry.key}`,mapping)}for(const entry of update)if(packageName){if(packageInfo&&packageInfo.config&&packageInfo.config.symbols&&packageInfo.config.symbols.package){let mapping=packageInfo.config.symbols.package[entry.key];packageSymbolManager.update(`Package:${packageName};${entry.key}`,mapping)}}else{const mapping={type:entry.item.type,symbol:`%i%Package_Symbol_Engineering_Mapping_Symbol_Simulation:{PkgId};${entry.key}%/i%`};packageSymbolManager.update(entry.key,mapping),packageSymbolManager.update(`Package:{PkgId};${entry.key}`,mapping)}}__refreshLanguageFallback(languageFallback,languageFallbackOld){languageFallback!==languageFallbackOld&&(localizationManager.setFallbackLocale(languageFallback),localizationManager.resetFallbackLocale())}__refreshLanguage(languages,languagesOld){if(!tchmi_equal(languages,languagesOld)){for(const[key,languageEntry]of Object.entries(languagesOld))if(Array.isArray(languageEntry)){const sanitizedLanguageArray=[];for(const subEntry of languageEntry)sanitizedLanguageArray.push(tchmi_path(subEntry));localizationManager.unregisterLocalizationFile("TcHmi.System.Localization.Application",key,sanitizedLanguageArray),localizationManager.unregisterLocalizationFile("TcHmi.System.Localization.Package<{PkgId}>",key,sanitizedLanguageArray)}else languageEntry&&(localizationManager.unregisterLocalizationFile("TcHmi.System.Localization.Application",key,tchmi_path(languageEntry)),localizationManager.unregisterLocalizationFile("TcHmi.System.Localization.Package<{PkgId}>",key,tchmi_path(languageEntry)));for(const[key,languageEntry]of Object.entries(languages))if(Array.isArray(languageEntry)){const sanitizedLanguageArray=[];for(const subEntry of languageEntry)sanitizedLanguageArray.push(tchmi_path(subEntry));localizationManager.registerLocalizationFile("TcHmi.System.Localization.Application",key,sanitizedLanguageArray),localizationManager.registerLocalizationFile("TcHmi.System.Localization.Package<{PkgId}>",key,sanitizedLanguageArray)}else languageEntry&&(localizationManager.registerLocalizationFile("TcHmi.System.Localization.Application",key,tchmi_path(languageEntry)),localizationManager.registerLocalizationFile("TcHmi.System.Localization.Package<{PkgId}>",key,tchmi_path(languageEntry)))}}__refreshSystemKeyboard(keyboardDefinition,keyboardDefinitionOld){tchmi_equal(keyboardDefinition,keyboardDefinitionOld)||keyboardManager.refreshConfig()}__refreshIntervals(intervals,intervalsOld,packageName,packageInfo){let i=0,ii=0,key=null,keyOld=null,bRemove=!1,remove=[],bCreate=!1,create=[],update=[];if(null!=intervalsOld&&null!=intervals)for(keyOld in intervalsOld)if(intervalsOld.hasOwnProperty(keyOld)){for(key in bRemove=!0,intervals)if(intervals.hasOwnProperty(key)){if(keyOld===key){bRemove=!1;break}key=null}bRemove&&remove.push(keyOld),bRemove=!1,keyOld=null}for(i=0,ii=remove.length;i<ii;i++)intervalManager.remove(remove[i]);if(null!=intervalsOld&&null!=intervals)for(key in intervals)if(intervals.hasOwnProperty(key)){for(keyOld in bCreate=!0,intervalsOld)if(intervalsOld.hasOwnProperty(keyOld)&&key===keyOld){bCreate=!1,tchmi_equal(intervals[key],intervalsOld[keyOld])||update.push({key,item:intervals[key]});break}bCreate&&create.push({key,item:intervals[key]})}for(const entry of create)intervalManager.add(entry.key,tchmi_clone_object(entry.item));for(const entry of update)intervalManager.update(entry.key,tchmi_clone_object(entry.item))}__refreshConfigPackageInfo(packages,packagesOld){for(let packageInfo of packages)for(let packageInfoOld of packagesOld)if(packageInfo.name===packageInfoOld.name&&!tchmi_equal(packageInfo,packageInfoOld)&&!tchmi_equal(packageInfo.symbols,packageInfoOld.symbols))if(packageInfo.symbols&&packageInfoOld.symbols){if(!tchmi_equal(packageInfo.symbols.package,packageInfoOld.symbols.package))if(packageInfo.symbols.package&&!packageInfoOld.symbols.package)for(let name in packageInfo.symbols.package)packageSymbolManager.update(`Package:${packageInfo.name};${name}`,packageInfo.symbols.package[name]);else if(!packageInfo.symbols.package&&packageInfoOld.symbols.package)for(let name in packageInfoOld.symbols.package)packageSymbolManager.remove(`Package:${packageInfo.name};${name}`);else{for(let name in packageInfo.symbols.package)packageSymbolManager.update(`Package:${packageInfo.name};${name}`,packageInfo.symbols.package[name]);if(packageInfoOld.symbols.package){const removed=Object.keys(packageInfoOld.symbols.package).filter(nameOld=>!packageInfo.symbols?.package?.hasOwnProperty(nameOld));for(const name of removed)packageSymbolManager.remove(`Package:${packageInfo.name};${name}`)}}if(!tchmi_equal(packageInfo.symbols.timer,packageInfoOld.symbols.timer))if(packageInfo.symbols.timer&&!packageInfoOld.symbols.timer)for(let name in packageInfo.symbols.timer){let override=packageInfo.symbols.timer[name],existingEntry=timerSymbolManager.get(`Package:${packageInfo.name};${name}`);if(existingEntry){let newEntry=tchmi_clone_object(existingEntry);override.pattern&&(newEntry.pattern=override.pattern),override.runSymbol&&(newEntry.runSymbol=override.runSymbol),override.stopValue&&(newEntry.stopValue=override.stopValue),timerSymbolManager.update(`Package:${packageInfo.name};${name}`,newEntry)}}else if(!packageInfo.symbols.timer&&packageInfoOld.symbols.timer)for(let name in packageInfoOld.symbols.timer){if(timerSymbolManager.get(`Package:${packageInfoOld.name};${name}`)){let pkg=Data.packages.get(packageInfoOld.name);if(!pkg)continue;let manifest=pkg.manifest;if(!manifest)continue;if(!manifest.symbols)continue;if(!manifest.symbols.timer)continue;let manifestEntry=manifest.symbols.timer[name];timerSymbolManager.update(`Package:${packageInfo.name};${name}`,manifestEntry)}}else{for(let name in packageInfo.symbols.timer){let override=packageInfo.symbols.timer[name],existingEntry=timerSymbolManager.get(`Package:${packageInfo.name};${name}`);if(existingEntry){let newEntry=tchmi_clone_object(existingEntry);override.pattern&&(newEntry.pattern=override.pattern),override.runSymbol&&(newEntry.runSymbol=override.runSymbol),override.stopValue&&(newEntry.stopValue=override.stopValue),timerSymbolManager.update(`Package:${packageInfo.name};${name}`,newEntry)}}if(packageInfoOld.symbols.timer){const removed=Object.keys(packageInfoOld.symbols.timer).filter(nameOld=>!packageInfo.symbols?.timer?.hasOwnProperty(nameOld));for(const name of removed){if(timerSymbolManager.get(`Package:${packageInfoOld.name};${name}`)){let pkg=Data.packages.get(packageInfoOld.name);if(!pkg)continue;let manifest=pkg.manifest;if(!manifest)continue;if(!manifest.symbols)continue;if(!manifest.symbols.timer)continue;let manifestEntry=manifest.symbols.timer[name];timerSymbolManager.update(`Package:${packageInfo.name};${name}`,manifestEntry)}}}}if(!tchmi_equal(packageInfo.symbols.internal,packageInfoOld.symbols.internal))if(packageInfo.symbols.internal&&!packageInfoOld.symbols.internal)for(let name in packageInfo.symbols.internal){let override=packageInfo.symbols.internal[name],existingEntry=internalSymbolManager.get(`Package:${packageInfo.name};${name}`);existingEntry&&internalSymbolManager.update(`Package:${packageInfo.name};${name}`,{type:existingEntry.type,...override})}else if(!packageInfo.symbols.internal&&packageInfoOld.symbols.internal)for(let name in packageInfoOld.symbols.internal){if(internalSymbolManager.get(`Package:${packageInfoOld.name};${name}`)){let pkg=Data.packages.get(packageInfoOld.name);if(!pkg)continue;let manifest=pkg.manifest;if(!manifest)continue;if(!manifest.symbols)continue;if(!manifest.symbols.internal)continue;let manifestEntry=manifest.symbols.internal[name];internalSymbolManager.update(`Package:${packageInfo.name};${name}`,manifestEntry)}}else{for(let name in packageInfo.symbols.internal){let override=packageInfo.symbols.internal[name],existingEntry=internalSymbolManager.get(`Package:${packageInfo.name};${name}`);existingEntry&&internalSymbolManager.update(`Package:${packageInfo.name};${name}`,{type:existingEntry.type,...override})}if(packageInfoOld.symbols.timer){const removed=Object.keys(packageInfoOld.symbols.timer).filter(nameOld=>!packageInfo.symbols?.timer?.hasOwnProperty(nameOld));for(const name of removed){if(internalSymbolManager.get(`Package:${packageInfoOld.name};${name}`)){let pkg=Data.packages.get(packageInfoOld.name);if(!pkg)continue;let manifest=pkg.manifest;if(!manifest)continue;if(!manifest.symbols)continue;if(!manifest.symbols.internal)continue;let manifestEntry=manifest.symbols.internal[name];internalSymbolManager.update(`Package:${packageInfo.name};${name}`,manifestEntry)}}}}}else if(packageInfo.symbols&&!packageInfoOld.symbols){for(let name in packageInfo.symbols.package)packageSymbolManager.update(`Package:${packageInfo.name};${name}`,packageInfo.symbols.package[name]);for(let name in packageInfo.symbols.timer){let override=packageInfo.symbols.timer[name],existingEntry=timerSymbolManager.get(`Package:${packageInfo.name};${name}`);if(existingEntry){let newEntry=tchmi_clone_object(existingEntry);override.pattern&&(newEntry.pattern=override.pattern),override.runSymbol&&(newEntry.runSymbol=override.runSymbol),override.stopValue&&(newEntry.stopValue=override.stopValue),timerSymbolManager.update(`Package:${packageInfo.name};${name}`,newEntry)}}for(let name in packageInfo.symbols.internal){let override=packageInfo.symbols.internal[name],existingEntry=internalSymbolManager.get(`Package:${packageInfo.name};${name}`);existingEntry&&internalSymbolManager.update(`Package:${packageInfo.name};${name}`,{type:existingEntry.type,...override})}}else if(!packageInfo.symbols&&packageInfoOld.symbols){for(let name in packageInfoOld.symbols.timer){if(timerSymbolManager.get(`Package:${packageInfoOld.name};${name}`)){let pkg=Data.packages.get(packageInfoOld.name);if(!pkg)continue;let manifest=pkg.manifest;if(!manifest)continue;if(!manifest.symbols)continue;if(!manifest.symbols.package)continue;let manifestEntry=manifest.symbols.package[name];packageSymbolManager.update(`Package:${packageInfo.name};${name}`,manifestEntry)}}for(let name in packageInfoOld.symbols.timer){if(timerSymbolManager.get(`Package:${packageInfoOld.name};${name}`)){let pkg=Data.packages.get(packageInfoOld.name);if(!pkg)continue;let manifest=pkg.manifest;if(!manifest)continue;if(!manifest.symbols)continue;if(!manifest.symbols.timer)continue;let manifestEntry=manifest.symbols.timer[name];timerSymbolManager.update(`Package:${packageInfo.name};${name}`,manifestEntry)}}for(let name in packageInfoOld.symbols.internal){if(internalSymbolManager.get(`Package:${packageInfoOld.name};${name}`)){let pkg=Data.packages.get(packageInfoOld.name);if(!pkg)continue;let manifest=pkg.manifest;if(!manifest)continue;if(!manifest.symbols)continue;if(!manifest.symbols.internal)continue;let manifestEntry=manifest.symbols.internal[name];internalSymbolManager.update(`Package:${packageInfo.name};${name}`,manifestEntry)}}}}__doReloadUserControlConfig(url){let xhr=new XMLHttpRequest;xhr.open("GET",tchmi_encode_uri_components(url)+"?preventcache="+Math.random()),xhr.addEventListener("load",_event=>{if(200===xhr.status){let data=TcHmi.ValueConverter.toObject(xhr.responseText);data?this.__doRefreshUserControlConfig(url,data):TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while parsing file loaded from "+url)}else TcHmi.EventProvider.raise("System.onUserControlConfigRemoved",{url})}),xhr.addEventListener("error",_event=>{TcHmi.EventProvider.raise("System.onUserControlConfigRemoved",{url})}),xhr.send()}__doRefreshUserControlConfig(url,data){Data.Caches.partialCompositeConfigCache.set(url,data),TcHmi.EventProvider.raise("System.onUserControlConfigChanged",{url})}__doReloadLocalizationFile(url,packageName){let xhr=new XMLHttpRequest;xhr.open("GET",tchmi_encode_uri_components(url)+"?preventcache="+Math.random()),xhr.addEventListener("load",_event=>{if(200===xhr.status){let data=TcHmi.ValueConverter.toObject(xhr.responseText);data?this.__doRefreshLocalizationFile(url,data,packageName):TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while parsing file loaded from "+url)}else TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+" Details: HTTP error "+xhr.status+" "+xhr.statusText)}),xhr.addEventListener("error",_event=>{TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.SyncCmdToFrameworkTcHmiConfigChanged] Error while loading "+url+". Details: "+xhr.statusText)}),xhr.send()}__doRefreshLocalizationFile(url,data,packageName){let locale=data.locale;if(null==locale)return;localizationManager.clearFileFetchCache();let currentLocaleData=localizationManager.getLocaleData("TcHmi.System.Localization.Application"),currentLocaleFallbackData=localizationManager.getLocaleFallbackData("TcHmi.System.Localization.Application");currentLocaleData&&currentLocaleData.locale===locale&&(localizationManager.setLocaleData("TcHmi.System.Localization.Application",data,url),currentLocaleData=localizationManager.getLocaleData("TcHmi.System.Localization.Application"),localizationManager.processLocalizationData("TcHmi.System.Localization.Application",currentLocaleData,currentLocaleFallbackData)),currentLocaleFallbackData&&currentLocaleFallbackData.locale===locale&&(localizationManager.setLocaleFallbackData("TcHmi.System.Localization.Application",data,url),currentLocaleFallbackData=localizationManager.getLocaleFallbackData("TcHmi.System.Localization.Application"),localizationManager.processLocalizationData("TcHmi.System.Localization.Application",currentLocaleData,currentLocaleFallbackData)),localizationManager.processPendingEntryWatches(),localizationManager.processLocalizationWatches("TcHmi.System.Localization.Application")}__doRefreshThemeFile(url){themeManager.__clearProjectThemeUrl(url),themeManager.processActiveTheme()}run(){let cmd=this.__cmd,preparedConfigPath=tchmi_path(cmd.configPath);switch(cmd.type){case"TcHmiConfig":this.__doReloadTcHmiConfig(preparedConfigPath);break;case"Manifest":this.__doReloadManifest(preparedConfigPath,cmd.package);break;case"UserControlConfig":this.__doReloadUserControlConfig(preparedConfigPath);break;case"Localization":this.__doReloadLocalizationFile(preparedConfigPath,cmd.package);break;case"ThemeConfig":this.__doRefreshThemeFile(preparedConfigPath)}}}SyncCmdToFrameworkTcHmiConfigChanged.supportedCommand="TcHmiConfigChanged",registerCommand(SyncCmdToFrameworkTcHmiConfigChanged);
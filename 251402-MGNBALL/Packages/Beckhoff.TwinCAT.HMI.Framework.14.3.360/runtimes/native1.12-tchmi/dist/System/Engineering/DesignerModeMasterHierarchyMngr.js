import{controlManager}from"../ControlManager.js";import{resolveControlHierarchy}from"../SystemFunctions.js";import{viewManager}from"../ViewManager.js";import{metaDataManager}from"./DesignerModeControlMetaDataMngr.js";import{rootControlManager}from"./DesignerModeMasterRootControlMngr.js";TCHMI_DESIGNER||TcHmi.Log.errorEx(`Internal error: The file "${import.meta.url}" is restricted to use within the designer.`);let DesignerModeMasterHierarchyManager=(()=>{var _a,_b;let ___onDragEnter_decorators,___onDragLeave_decorators,_instanceExtraInitializers=[];return class{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___onDragEnter_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___onDragLeave_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],__esDecorate(this,null,___onDragEnter_decorators,{kind:"method",name:"__onDragEnter",static:!1,private:!1,access:{has:obj=>"__onDragEnter"in obj,get:obj=>obj.__onDragEnter},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onDragLeave_decorators,{kind:"method",name:"__onDragLeave",static:!1,private:!1,access:{has:obj=>"__onDragLeave"in obj,get:obj=>obj.__onDragLeave},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){$(document.body).on("dragover.DesignerModeMasterHierarchyManager.body",event=>{event.preventDefault()}).on("dragenter.DesignerModeMasterHierarchyManager.body",this.__onDragEnter).on("dragleave.DesignerModeMasterHierarchyManager.body",this.__onDragLeave)}__dragtargetContainerHighlighting=(__runInitializers(this,_instanceExtraInitializers),{});isDesignerModeControl(id){let tpco,res=!1,hierarchyRecursion=function(h){if(h.ctrl.getId()!==id){if(h.ctrl.getIsContainerControl())for(let i=0,ii=h.children_hierarchy.length;i<ii;i++){let childHierarchy=h.children_hierarchy[i];if(hierarchyRecursion(childHierarchy),res)return}}else res=!0},partial=document.querySelector(`div[data-tchmi-creator-partial-key="${TCHMI_TARGET_PARTIAL}"]`);if(partial&&(tpco=TcHmi.Controls.get(partial.id)),tpco){let designerIgnore=!1,tco=TcHmi.Controls.get(id);if(tco){let element=tco.getElement();element&&element.length>0&&(designerIgnore=element[0].hasAttribute("data-tchmi-designer-ignore"))}if(designerIgnore)res=!1;else{let hierarchy=resolveControlHierarchy(tpco,null);hierarchyRecursion(hierarchy)}}return res}registerContainerControl(ctrlMeta){ctrlMeta.jControlPosition.on("dragover.DesignerModeMasterHierarchyManager."+ctrlMeta.id,event=>{event.preventDefault()}),ctrlMeta.jControlPosition.on("dragenter.DesignerModeMasterHierarchyManager."+ctrlMeta.id,this.__onDragEnter),ctrlMeta.jControlPosition.on("dragleave.DesignerModeMasterHierarchyManager."+ctrlMeta.id,this.__onDragLeave)}registerContainerElement(jElem){jElem.on("dragenter.DesignerModeMasterHierarchyManager",this.__onDragEnter).on("dragleave.DesignerModeMasterHierarchyManager",this.__onDragLeave)}__onDragEnter(event){event.preventDefault(),void 0!==event.pageX&&void 0!==event.pageY&&this.addHighlightDropTarget({left:event.pageX,top:event.pageY},event.target)}__onDragLeave(event){const targetKey=(event.target.hasAttribute("data-tchmi-creator-target-control")?event.target.getAttribute("data-tchmi-creator-target-control"):"body")+"_r"+(event.target.hasAttribute("data-tchmi-creator-grid-rowindex")?event.target.getAttribute("data-tchmi-creator-grid-rowindex"):null)+"_c"+(event.target.hasAttribute("data-tchmi-creator-grid-cellindex")?event.target.getAttribute("data-tchmi-creator-grid-cellindex"):null);this.__dragtargetContainerHighlighting[targetKey]&&(this.__dragtargetContainerHighlighting[targetKey].classList.remove("tchmi-creator-possibledroptarget"),delete this.__dragtargetContainerHighlighting[targetKey])}addHighlightDropTarget(position,targetElem){const dropConfig=this.getContainerFromPoint(position);if(this.removeHighlightDropTarget(),!dropConfig||!dropConfig.jHighlighter)return;const targetKey=(targetElem.hasAttribute("data-tchmi-creator-target-control")?targetElem.getAttribute("data-tchmi-creator-target-control"):"body")+"_r"+dropConfig.rowIndex+"_c"+dropConfig.columnIndex;dropConfig.jHighlighter[0].classList.add("tchmi-creator-possibledroptarget"),this.__dragtargetContainerHighlighting[targetKey]=dropConfig.jHighlighter[0]}removeHighlightDropTarget(){for(let key in this.__dragtargetContainerHighlighting)this.__dragtargetContainerHighlighting[key].classList.remove("tchmi-creator-possibledroptarget"),delete this.__dragtargetContainerHighlighting[key]}getContainerFromPoint(position){const currentView=viewManager.getView();if(null===currentView)return null;const jClickTarget=$(document.elementFromPoint(position.left-window.scrollX,position.top-window.scrollY));let jHighlighter,tco;if(0===jClickTarget.length||jClickTarget[0]===document.body){tco=currentView;const ctrlMeta=metaDataManager.getControlMetaData(tco.getId());ctrlMeta&&(jHighlighter=ctrlMeta.jControlPosition)}else{const resolvePossibleDropTargets=function(h){const ctrl=h.ctrl,ctrlType=ctrl.getType();if(("TcHmi.Controls.System.TcHmiView"===ctrlType||"TcHmi.Controls.System.TcHmiContent"===ctrlType||"TcHmi.Controls.System.TcHmiUserControl"===ctrlType)&&ctrl.getId()!==currentView.getId())return[];let res=[];if(ctrl.getIsContainerControl()&&!(ctrl.getElement()?.[0]?.hasAttribute("data-tchmi-designer-ignore")??1)){res.push(ctrl);for(let i=0,ii=h.children_hierarchy.length;i<ii;i++){const pdts=resolvePossibleDropTargets(h.children_hierarchy[i]);res=res.concat(pdts)}}return res},hierarchy=resolveControlHierarchy(currentView,null),pdts=resolvePossibleDropTargets(hierarchy);let tmpInteractioncont=jClickTarget;do{const targetId=tmpInteractioncont.attr("data-tchmi-creator-target-control");if(void 0!==targetId){let bDropTargetFound=!1;for(let i=0,ii=pdts.length;i<ii;i++){const pdt=pdts[i];if(pdt.getId()===targetId){tco=pdt,jHighlighter=tmpInteractioncont,bDropTargetFound=!0;break}}if(bDropTargetFound)break}tmpInteractioncont=tmpInteractioncont.parent()}while(tmpInteractioncont.length>0);tmpInteractioncont=null,null==tco&&(tco=currentView)}let x=position.left,y=position.top,rowIndex=null,cellIndex=null;if(jHighlighter&&controlManager.getDescriptionTypes(tco.getType()).includes("TcHmi.Controls.System.TcHmiGrid")){if(jClickTarget[0].classList.contains("tchmi-creator-gridcell"))jHighlighter=jClickTarget;else{const jClickTargetParent=jClickTarget.parent();jClickTargetParent.length&&jClickTargetParent[0].classList.contains("tchmi-creator-hierarchy-gridcellposition")&&(jHighlighter=jClickTargetParent)}let parsedRowIndex=parseInt(jHighlighter.attr("data-tchmi-creator-grid-rowindex")??"0",10),parsedCellIndex=parseInt(jHighlighter.attr("data-tchmi-creator-grid-cellindex")??"0",10);if(!isNaN(parsedCellIndex)&&!isNaN(parsedRowIndex)){rowIndex=parsedRowIndex,cellIndex=parsedCellIndex;const cellPos=jHighlighter.position();x-=cellPos.left,y-=cellPos.top}}let tmpElem2=tco.getElement();if(tmpElem2.length>0)do{const pos=tmpElem2.position();x-=pos.left,y-=pos.top,tmpElem2=tmpElem2.offsetParent(),x-=parseFloat(tmpElem2.css("border-left-width")),y-=parseFloat(tmpElem2.css("border-top-width"))}while(tmpElem2.length>0&&tmpElem2[0]!==document.body&&tmpElem2[0]!==document.documentElement);const creatorZoomFactor=rootControlManager.getCreatorZoomFactor()??1;return{tco,jHighlighter,mousePosXinTarget:Math.round(x/creatorZoomFactor),mousePosYinTarget:Math.round(y/creatorZoomFactor),rowIndex,columnIndex:cellIndex}}}})();export{DesignerModeMasterHierarchyManager};export const hierarchyManager=new DesignerModeMasterHierarchyManager;
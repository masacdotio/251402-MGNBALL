import{controlManager}from"./ControlManager.js";import{Symbol as SystemSymbol}from"./Symbol.js";import{Log}from"../API/Log.js";export class SymbolTypeContext extends TcHmi.Destroyable{constructor(symbol){super(),this.__symbol=symbol,this.__symbolExpressionString=this.__symbol.getExpression().toString(),this.__symbolDiagGUID=this.__symbol.getDiagGUID()}__symbol;__symbolExpressionString;__symbolDiagGUID;__printExpression(expression){let message=this.__symbolExpressionString;return expression?(this.__symbolExpressionString!==expression.toString()&&(message+=` (Resolved to: '${expression.toString()}')`),message):message}destroy(){this.isDestroyed()||(this.__releaseDestroyPrivilege(),this.isDestroyable()&&(this.__symbol=null))}read(expression,options,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeContext"}});let ctx=this.__symbol.getContext();if(!ctx)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Context is not defined.",domain:"TcHmi.System.SymbolTypeContext"},expression:this.__symbol.getExpression(),expressionResolved:expression});let pathTokens=expression.getPathTokens();return pathTokens&&pathTokens.length>0?void this.__symbol.__helper.readSubValue(expression,ctx,pathTokens,null,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){let value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeContext"}})}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression),domain:"TcHmi.System.SymbolTypeContext"},expression:this.__symbol.getExpression(),expressionResolved:expression})}write(expression,value,options,dirtyPaths,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeContext"}});let path,containingObject=this.__symbol.getContext();if(!containingObject||"object"!=typeof containingObject){const errorResult={error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Context is not defined.",domain:"TcHmi.System.SymbolTypeContext"},expression:this.__symbol.getExpression(),expressionResolved:expression};return void TcHmi.Callback.callSafeEx(callback,this.__symbol,errorResult)}try{path=new TcHmi.ObjectPath(expression.getPathTokens()??[])}catch(e){const errorResult={error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": Symbol expression contains invalid path.",domain:"TcHmi.System.SymbolTypeContext",exception:e instanceof Error?e:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression};return void TcHmi.Callback.callSafeEx(callback,this.__symbol,errorResult)}const propertyToWrite=path.pop();if(void 0===propertyToWrite){const errorResult={error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": Cannot write with an empty path.",domain:"TcHmi.System.SymbolTypeContext"},expression:this.__symbol.getExpression(),expressionResolved:expression};return void TcHmi.Callback.callSafeEx(callback,this.__symbol,errorResult)}const pathDone=new TcHmi.ObjectPath;let token=path.shift();for(;!(containingObject instanceof TcHmi.Controls.System.baseTcHmiControl)&&void 0!==token;){if(!(token in containingObject)){const errorResult={error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+`: Failed to read value by path because the token: "${token}" does not exist below path: "${pathDone.toString()}" in current value.`,domain:"TcHmi.System.SymbolTypeContext"},expression:this.__symbol.getExpression(),expressionResolved:expression};return void TcHmi.Callback.callSafeEx(callback,this.__symbol,errorResult)}if(containingObject=containingObject[token],containingObject instanceof TcHmi.Controls.System.baseTcHmiControl)break;pathDone.push(token),token=path.shift()}if(containingObject instanceof TcHmi.Controls.System.baseTcHmiControl){path.unshift(containingObject.getId()),path.push(propertyToWrite);const start=expression.getOptions().Start,end=expression.getOptions().End,controlSymbol=new SystemSymbol({expression:`%ctrl%${path.toString()}${start?"|Start="+start:""}${end?"|End="+end:""}%/ctrl%`,ctx:this.__symbol.getContext()});return void controlSymbol.writeEx(value,dirtyPaths,data=>{controlSymbol.destroy(),TcHmi.Callback.callSafeEx(callback,this.__symbol,data)})}{const errorResult={error:TcHmi.Errors.E_SYMBOL_READONLY,details:{code:TcHmi.Errors.E_SYMBOL_READONLY,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_READONLY],reason:this.__printExpression(expression)+": Only control attributes are writable in ctx symbols.",domain:"TcHmi.System.SymbolTypeContext"},expression:this.__symbol.getExpression(),expressionResolved:expression};return void TcHmi.Callback.callSafeEx(callback,this.__symbol,errorResult)}}watch(expression,options,callback,reason){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeContext"}}),()=>{};let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid());let destroyOnPropertyChanged=null,destroyOnControlInitialized=null,destroyOnControlDestroyed=null,intervalId=0,destroy=()=>{Log.debug("[Source=Framework, Module=TcHmi.System.Symbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch destroy called."),destroyOnPropertyChanged?.(),destroyOnPropertyChanged=null,destroyOnControlInitialized?.(),destroyOnControlInitialized=null,destroyOnControlDestroyed?.(),destroyOnControlDestroyed=null,intervalId&&(clearInterval(intervalId),intervalId=0)};const successResult={error:TcHmi.Errors.NONE,expression:this.__symbol.getExpression()};let control=null,lastError=null;const checkForValueChange=(fromInterval=!1)=>{if(!this.__symbol){const errorResult={error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}};if(tchmi_equal(lastError,errorResult))return;return lastError=errorResult,void TcHmi.Callback.callSafeEx(callback,null,errorResult)}let path,value=this.__symbol.getContext();if(!value||"object"!=typeof value){const errorResult={error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Context is not defined.",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};if(tchmi_equal(lastError,errorResult))return;return lastError=errorResult,TcHmi.Callback.callSafeEx(callback,this.__symbol,errorResult),void Log.debugEx(`[Source=Framework, Module=TcHmi.System.Symbol, Expression=${this.__printExpression(expression)}', ObjectScopeDiagGUID=${this.__symbol.getDiagGUID()}, LogicalScopeDiagGUID=${diagGUID}] watch tick with:`,errorResult)}try{path=new TcHmi.ObjectPath(expression.getPathTokens()??[])}catch(e){const errorResult={error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": Symbol expression contains invalid path.",domain:"TcHmi.System.Symbol",exception:e instanceof Error?e:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};if(tchmi_equal(lastError,errorResult))return;return lastError=errorResult,TcHmi.Callback.callSafeEx(callback,this.__symbol,errorResult),void Log.debugEx(`[Source=Framework, Module=TcHmi.System.Symbol, Expression=${this.__printExpression(expression)}, ObjectScopeDiagGUID=${this.__symbol.getDiagGUID()}, LogicalScopeDiagGUID=${diagGUID}] watch tick with:`,errorResult)}const pathDone=new TcHmi.ObjectPath;let controlChanged=!1;for(const token of path){let isControlInstance=!1,attr=null;if("object"!=typeof value||!value||!(token in value||value instanceof TcHmi.Controls.System.baseTcHmiControl)){const errorResult={error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+`: Failed to read value by path because the token: "${token}" does not exist below path: "${pathDone.toString()}" in current value.`,domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression};if(tchmi_equal(lastError,errorResult))return;return lastError=errorResult,TcHmi.Callback.callSafeEx(callback,this.__symbol,errorResult),void Log.debugEx(`[Source=Framework, Module=TcHmi.System.Symbol, Expression=${this.__printExpression(expression)}, ObjectScopeDiagGUID=${this.__symbol.getDiagGUID()}, LogicalScopeDiagGUID=${diagGUID}] watch tick with:`,errorResult)}if("string"==typeof token&&value instanceof TcHmi.Controls.System.baseTcHmiControl){if(attr=controlManager.getAttributeByPropertyName(value,token),!attr?.propertyGetterName||!(attr.propertyGetterName in value)){const errorResult={error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+`: Failed to read value by path because the token: "${token}" does not exist below path: "${pathDone.toString()}" in current value.`,domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression};if(tchmi_equal(lastError,errorResult))return;return lastError=errorResult,TcHmi.Callback.callSafeEx(callback,this.__symbol,errorResult),void Log.debugEx(`[Source=Framework, Module=TcHmi.System.Symbol, Expression=${this.__printExpression(expression)}, ObjectScopeDiagGUID=${this.__symbol.getDiagGUID()}, LogicalScopeDiagGUID=${diagGUID}] watch tick with:`,errorResult)}isControlInstance=!0,value!==control&&(destroyOnPropertyChanged?.(),destroyOnPropertyChanged=TcHmi.EventProvider.register(`${value.getId()}.onPropertyChanged<${token}>`,()=>{checkForValueChange()}),destroyOnControlInitialized?.(),destroyOnControlInitialized=TcHmi.EventProvider.register(`${value.getId()}.onInitialized`,()=>{checkForValueChange()}),destroyOnControlDestroyed?.(),destroyOnControlDestroyed=TcHmi.EventProvider.register(`${value.getId()}.onDestroyed`,()=>{checkForValueChange()}),control=value,controlChanged=!0)}if(isControlInstance){if(fromInterval&&!controlChanged)return;try{value=tchmi_clone_object(value[attr.propertyGetterName].call(value))}catch(e){const errorResult={error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+`: Failed to read path "${token}" below path: "${pathDone.toString()}" in current value because of exception: "${String(e)}"`,domain:"TcHmi.System.Symbol",exception:e instanceof Error?e:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression};if(tchmi_equal(lastError,errorResult))return;return lastError=errorResult,TcHmi.Callback.callSafeEx(callback,this.__symbol,errorResult),void Log.debugEx(`[Source=Framework, Module=TcHmi.System.Symbol, Expression=${this.__printExpression(expression)}, ObjectScopeDiagGUID=${this.__symbol.getDiagGUID()}, LogicalScopeDiagGUID=${diagGUID}] watch tick with:`,errorResult)}}else value=value[token];pathDone.push(token)}if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return lastError=null,void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}"value"in successResult&&tchmi_equal(successResult.value,value)||(successResult.value=value,lastError=null,TcHmi.Callback.callSafeEx(callback,this.__symbol,successResult))};return checkForValueChange(),intervalId=setInterval(()=>{checkForValueChange(!0)},TcHmi.Config.get().tcHmiServer.websocketIntervalTime),destroy}}
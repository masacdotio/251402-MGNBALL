import{ControlAttributeType,ControlAttributeValueType}from"./_Types.js";import{bindingManager}from"./BindingManager.js";import{SymbolExpressionFromText}from"./SymbolExpressionFromText.js";import{config,Data,isInitialized,mapControlNamesFromPackageManifestApi1ToApi0}from"./System.js";import{resolveQualifiedName,resolveAttributesFromControlElement,resolveReplaceExpressions}from"./SystemFunctions.js";import{themeManager}from"./ThemeManager.js";import{typeManager}from"./Type.TypeManager.js";import*as StyleProvider from"../API/StyleProvider.js";import*as ValueConverter from"../API/ValueConverter.js";import*as ThemeResources from"../API/Theme.Resources.js";import{recurseThroughSchema}from"../API/Type.Schema.js";import{getSchema}from"../API/Type.js";import*as ErrorPane from"../API/Engineering.ErrorPane.js";import{Log}from"../API/Log.js";let ControlManager=(()=>{var _a,_b,_c,_d;let ___recheckControlsAfterInteraction_decorators,_resolveUcAttributes_decorators,___onAttributeMutation_decorators,___onDomMutation_decorators,_instanceExtraInitializers=[];return class ControlManager{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___recheckControlsAfterInteraction_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],_resolveUcAttributes_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___onAttributeMutation_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],___onDomMutation_decorators=[(_d=TcHmi).CallbackMethod.bind(_d)],__esDecorate(this,null,___recheckControlsAfterInteraction_decorators,{kind:"method",name:"__recheckControlsAfterInteraction",static:!1,private:!1,access:{has:obj=>"__recheckControlsAfterInteraction"in obj,get:obj=>obj.__recheckControlsAfterInteraction},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_resolveUcAttributes_decorators,{kind:"method",name:"resolveUcAttributes",static:!1,private:!1,access:{has:obj=>"resolveUcAttributes"in obj,get:obj=>obj.resolveUcAttributes},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onAttributeMutation_decorators,{kind:"method",name:"__onAttributeMutation",static:!1,private:!1,access:{has:obj=>"__onAttributeMutation"in obj,get:obj=>obj.__onAttributeMutation},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onDomMutation_decorators,{kind:"method",name:"__onDomMutation",static:!1,private:!1,access:{has:obj=>"__onDomMutation"in obj,get:obj=>obj.__onDomMutation},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){TcHmi.control??={},TcHmi.control=new Proxy(TcHmi.control,{get:(_target,name)=>this.__controls.get(name),ownKeys:_target=>Array.from(this.__controls.keys()),getOwnPropertyDescriptor:(_target,_key)=>({enumerable:!0,configurable:!0})}),this.__domMutationObserver=new MutationObserver(this.__onDomMutation),this.__domMutationObserver.observe(document.body,{childList:!0,subtree:!0}),this.__attributeMutationObserver=new MutationObserver(this.__onAttributeMutation);let checkControlGeometryAnimationFrame=0;const checkControlParam={force:!1},throttledControlSizeCheck=evt=>{if(!(evt instanceof TransitionEvent)||"opacity"!==evt.propertyName&&!evt.propertyName.startsWith("background")){if(evt instanceof Event&&"scroll"===evt.type&&evt.target!==document&&!checkControlParam.force){checkControlParam.geos||(checkControlParam.geos=new Map);const cnodes=evt.target.querySelectorAll("div[id][data-tchmi-type]");for(const childNode of cnodes){let childGeo=this.__controlsGeoMap.get(childNode.id);childGeo&&!checkControlParam.geos.has(childNode.id)&&(childGeo.isDirty=!0,checkControlParam.geos.set(childNode.id,childGeo))}checkControlParam.checkReason??="Event on an element: "+evt.type}else checkControlParam.force=!0,checkControlParam.geos=void 0,"type"in evt?checkControlParam.checkReason??="DOMEvent on "+(evt.target===document?"document":evt.target===window?"window":"element")+": "+evt.type:"name"in evt&&(checkControlParam.checkReason??="TcHmiEvent: "+evt.name);checkControlGeometryAnimationFrame||(checkControlGeometryAnimationFrame=window.requestAnimationFrame(()=>{checkControlGeometryAnimationFrame=0,this.checkControlGeometry(checkControlParam),checkControlParam.force=!1,checkControlParam.geos=void 0,checkControlParam.checkReason=void 0}))}};TCHMI_DESIGNER&&(import("./Engineering/DesignerModeMasterControlMoveMngr.js").then(module=>{this.#designerModeManagers.moveManager=module.controlMoveManager}).catch(ex=>{Log.errorEx("Failed to load designerModeManagers in Framework ControlManager:",ex)}),import("./Engineering/DesignerModeMasterControlResizeMngr.js").then(module=>{this.#designerModeManagers.resizeManager=module.controlResizeManager}).catch(ex=>{Log.errorEx("Failed to load designerModeManagers in Framework ControlManager:",ex)})),document.addEventListener("transitionend",throttledControlSizeCheck,{capture:!1});document.addEventListener("scroll",throttledControlSizeCheck,{capture:!0,passive:!0}),window.addEventListener("resize",throttledControlSizeCheck),TcHmi.EventProvider.register("System.onViewpartsChanged",throttledControlSizeCheck),TcHmi.EventProvider.register("System.onUserControlConfigCreated",this.resolveUcAttributes),TcHmi.EventProvider.register("System.onUserControlConfigChanged",this.resolveUcAttributes),TcHmi.EventProvider.register("System.onUserControlConfigRemoved",this.resolveUcAttributes),TcHmi.EventProvider.register("System.onControlSizeParameterChanged",this.__recheckControlsAfterInteraction),TcHmi.EventProvider.register("System.onControlPositionParameterChanged",this.__recheckControlsAfterInteraction)}#designerModeManagers=(__runInitializers(this,_instanceExtraInitializers),{resizeManager:void 0,moveManager:void 0});__inheritanceHierarchyTree;__controlsWeak=new WeakSet;__controls=new Map;__controlsGeoMap=new Map;__controlsPresavedGeoMap=new WeakMap;__controlsToRecheckAfterDesignerInteraction=new Set;__iframesSet=new WeakSet;__recheckControlsAfterInteraction(event){this.checkControlGeometry({delayUserEvents:!1,force:!0,geos:this.__controlsToRecheckAfterDesignerInteraction,checkReason:"TcHmiEvent: "+event.name}),this.__controlsToRecheckAfterDesignerInteraction.clear()}__domMutationObserver;__attributeMutationObserver;__usercontrolAttrDescrByPropertyName=new Map;__usercontrolAttrDescrBySetterName=new Map;__usercontrolAttrDescrByGetterName=new Map;resolveUcAttributes(){this.__usercontrolAttrDescrByPropertyName.clear(),this.__usercontrolAttrDescrBySetterName.clear(),this.__usercontrolAttrDescrByGetterName.clear(),Data.Caches.partialCompositeConfigCache.forEach((config,ucJsonPath)=>{if(config&&config.parameters){const UCdescrByPropertyName=new Map;this.__usercontrolAttrDescrByPropertyName.set(ucJsonPath,UCdescrByPropertyName);const UCdescrBySetterName=new Map;this.__usercontrolAttrDescrBySetterName.set(ucJsonPath,UCdescrBySetterName);const UCdescrByGetterName=new Map;this.__usercontrolAttrDescrByGetterName.set(ucJsonPath,UCdescrByGetterName);const parameters=config.parameters;for(let i=0,ii=parameters.length;i<ii;i++)UCdescrByPropertyName.set(parameters[i].propertyName,parameters[i]),parameters[i].propertySetterName&&UCdescrBySetterName.set(parameters[i].propertySetterName,parameters[i]),parameters[i].propertyGetterName&&UCdescrByGetterName.set(parameters[i].propertyGetterName,parameters[i])}})}__onAttributeMutation(mutations){let checkReason,mainViewPartChanged=!1,geos=new Map;const checkedNodes=new Set;for(const mutation of mutations){const node=mutation.target;if(node.nodeType!==Node.ELEMENT_NODE)continue;if(checkedNodes.has(node))continue;let controlElement;if(checkedNodes.add(node),mainViewPartChanged||=node.classList.contains("tchmi-in-specialviewport"),node.id&&node.hasAttribute("data-tchmi-type")){const geo=this.__controlsGeoMap.get(node.id);geo&&(controlElement=node,geo.isDirty=!0,geos.set(node.id,geo),checkReason??="DOM AttributeMutation: "+node.id)}if(controlElement??=node.closest("div[id][data-tchmi-type]"),controlElement){const ctrl=TcHmi.Controls.get(controlElement.id);if(ctrl&&(!ctrl.getIsAttached()||"Collapsed"===ctrl.getVisibility()))continue}else if(!node.isConnected)continue;const cnodes=node.querySelectorAll("div[id][data-tchmi-type]");for(const childNode of cnodes){let childGeo=this.__controlsGeoMap.get(childNode.id);childGeo&&!geos.has(childNode.id)&&(childGeo.isDirty=!0,geos.set(childNode.id,childGeo),checkReason??="DOM AttributeMutation: "+childNode.id)}}geos.size&&this.checkControlGeometry({geos,checkReason}),mainViewPartChanged&&TcHmi.EventProvider.raise("System.onViewpartsChanged",{size:!0})}__forceDetachList=[];forceDetach(ctrl){ctrl&&this.__forceDetachList.push(ctrl)}__delayedDomMutations=new Set;__delayedDomMutationTimeoutId=0;__onDomMutation(mutations){for(const mutation of mutations)this.__delayedDomMutations.add(mutation);let ControlManager___onDomMutation=()=>{if(this.__delayedDomMutationTimeoutId=0,0===this.__delayedDomMutations.size)return;let checkReason,domChanged=!1;const ctrlsAttachedSet=new Set,ctrlsDetachedSet=new Set,ctrlsAttached=[],ctrlsDetached=[];let task,ctrlsDelayedMoved=[],ctrlsDelayedResized=[];task=config.disableLoadingOptimization?new TcHmi.TimedAsyncTask(1/0):new TcHmi.TimedAsyncTask(1e4);const publishGeometry=ctrl=>{if(!ctrl)return;if(ctrl.getElement().length<1)return;const ctrlName=ctrl.getId();let geo={ctrl,layoutData:{moved:!1,movedLocal:!1,resized:!1,bounds:{leftGlobal:null,topGlobal:null,offsetLeft:null,offsetTop:null,width:null,height:null},computedStyles:{left:"",top:"",right:"",bottom:"",width:"",height:""}},isDirty:!0,isCollapsed:!1};if(ctrl.__getKeepAlive()){let geoOld=this.__controlsPresavedGeoMap.get(ctrl);geoOld&&(geo=geoOld,geo.isDirty=!0)}this.__controlsGeoMap.set(ctrlName,geo);let delayedEvents=this.checkControlGeometry({geos:geo,delayUserEvents:!0,checkReason:"DOM AttributeMutation: "+ctrlName});ctrlsDelayedMoved=ctrlsDelayedMoved.concat(delayedEvents.skippedMovedEventList),ctrlsDelayedResized=ctrlsDelayedResized.concat(delayedEvents.skippedResizedEventList)},detach=(ctrl,force)=>{if(!ctrl)return;const ctrlName=ctrl.getId();let geo=this.__controlsGeoMap.get(ctrlName);if(!geo)return;if(geo.ctrl.__getKeepAlive()&&this.__controlsPresavedGeoMap.set(geo.ctrl,geo),this.__controlsGeoMap.delete(ctrlName),!geo.ctrl)return;let ctrlElem=ctrl.getElement();if(ctrlElem.length<1)return;let inDom=ctrlElem[0].isConnected;if(force&&(inDom=!1),!inDom&&ctrl.getIsAttached()){ctrl.__setLifeCycleState(40),TcHmi.EventProvider.raise("System.onPrevControlDetached",ctrl),TcHmi.EventProvider.raise(ctrlName+".System.onPrevDetached",ctrl);try{ctrl.__detach()}catch(e){Log.errorEx("[Source=Framework, Module=TcHmi.System.ControlManager] Control __detach of "+ctrl.getId()+" failed with exception:\n",e)}ctrlsDetached.push(ctrl),domChanged=!0,checkReason??="after control detach "+ctrlName}},attach=ctrl=>{if(!ctrl)return;let ctrlElem=ctrl.getElement();if(ctrlElem.length<1)return;const ctrlName=ctrl.getId();if(ctrlElem[0].isConnected&&!ctrl.getIsAttached()){ctrl.__setLifeCycleState(30),TcHmi.EventProvider.raise("System.onPrevControlAttached",ctrl),TcHmi.EventProvider.raise(ctrlName+".System.onPrevAttached",ctrl);try{ctrl.__attach()}catch(e){Log.errorEx("[Source=Framework, Module=TcHmi.System.ControlManager] Control __attach of "+ctrlName+" failed with exception:\n",e)}ctrlsAttached.push(ctrl),domChanged=!0,checkReason??="after control attach "+ctrlName}},saveNewState=(controlId,newStateAttached)=>{newStateAttached?(ctrlsDetachedSet.delete(controlId),ctrlsAttachedSet.add(controlId)):newStateAttached||(ctrlsDetachedSet.add(controlId),ctrlsAttachedSet.delete(controlId))},procIFrameAdded=node=>{this.__iframesSet.has(node)||(this.__iframesSet.add(node),TcHmi.EventProvider.raise("System.onIFrameElementAdded",node))},procIFrameRemoved=node=>{this.__iframesSet.has(node)&&(this.__iframesSet.delete(node),TcHmi.EventProvider.raise("System.onIFrameElementRemoved",node))};for(const mutation of this.__delayedDomMutations){this.__delayedDomMutations.delete(mutation);for(const removedNode of mutation.removedNodes){const node=removedNode;if(node.nodeType!==Node.ELEMENT_NODE)continue;const controlChildElements=node.querySelectorAll("div[id][data-tchmi-type]");for(const controlChildElem of controlChildElements)saveNewState(controlChildElem.id,!1);node.id&&node.hasAttribute("data-tchmi-type")&&saveNewState(node.id,!1);const iframeNodeChilds=node.querySelectorAll("iframe");for(const childIframe of iframeNodeChilds)procIFrameRemoved(childIframe);node instanceof HTMLIFrameElement&&procIFrameRemoved(node)}for(const addedNode of mutation.addedNodes){const node=addedNode;if(node.nodeType!==Node.ELEMENT_NODE)continue;node.id&&node.hasAttribute("data-tchmi-type")&&saveNewState(node.id,!0),this.__attributeMutationObserver.observe(node,{attributes:!0,subtree:!0});const controlChildElements=node.querySelectorAll("div[id][data-tchmi-type]");for(const controlChildElem of controlChildElements)saveNewState(controlChildElem.id,!0);const iframeNodeChilds=node.querySelectorAll("iframe");for(const childIframe of iframeNodeChilds)procIFrameAdded(childIframe);node instanceof HTMLIFrameElement&&procIFrameAdded(node)}}(done=>{const ctrlsDetachedForced=Array.from(this.__forceDetachList);this.__forceDetachList=[];const forceDetachNext=()=>{for(;ctrlsDetachedForced.length;){if(task.timeQuotaReached()){setTimeout(forceDetachNext);break}{const ctrl=ctrlsDetachedForced.shift();detach(ctrl,!0)}}0===ctrlsDetachedForced.length&&done()};forceDetachNext()})(()=>{(done=>{const ctrlsDetached=Array.from(ctrlsDetachedSet),detachNext=()=>{for(;ctrlsDetached.length;){if(task.timeQuotaReached()){setTimeout(detachNext);break}{const ctrlName=ctrlsDetached.shift();detach(TcHmi.Controls.get(ctrlName),!1)}}0===ctrlsDetached.length&&done()};detachNext()})(()=>{for(const ctrlName of ctrlsAttachedSet)publishGeometry(TcHmi.Controls.get(ctrlName));(done=>{const ctrlsAttached=Array.from(ctrlsAttachedSet),attachNext=()=>{for(;ctrlsAttached.length;){if(task.timeQuotaReached()){setTimeout(attachNext);break}{const ctrlName=ctrlsAttached.shift();attach(TcHmi.Controls.get(ctrlName))}}ctrlsAttached.length||done()};attachNext()})(()=>{ctrlsDelayedResized.length&&TcHmi.EventProvider.raise("System.onControlsResized",ctrlsDelayedResized),ctrlsDelayedMoved.length&&TcHmi.EventProvider.raise("System.onControlsMoved",ctrlsDelayedMoved);for(const ctrl of ctrlsDelayedMoved){const ctrlId=ctrl.getId();TcHmi.EventProvider.raise(ctrlId+".onMoved",ctrl,{movedLocal:this.__controlsGeoMap.get(ctrlId)?.layoutData.movedLocal})}for(const ctrl of ctrlsDelayedResized)TcHmi.EventProvider.raise(ctrl.getId()+".onResized",ctrl);ctrlsDelayedResized=[],ctrlsDelayedMoved=[],domChanged&&this.checkControlGeometry({checkReason}),0!==ctrlsDetached.length&&TcHmi.EventProvider.raise("System.onPrevControlsDetached",ctrlsDetached),0!==ctrlsAttached.length&&TcHmi.EventProvider.raise("System.onPrevControlsAttached",ctrlsAttached)})})})};this.__delayedDomMutationTimeoutId||(this.__delayedDomMutationTimeoutId=setTimeout(ControlManager___onDomMutation))}checkControlGeometry(options){const geos=options?.geos??this.__controlsGeoMap,delayUserEvents=options?.delayUserEvents??!1;let force=options?.force??!1;if(TCHMI_DESIGNER&&(this.#designerModeManagers.resizeManager?.getControlResizing()||this.#designerModeManagers.moveManager?.getControlMoveActive())){if(geos instanceof Map||geos instanceof Set)for(const geo of geos.values())this.__controlsToRecheckAfterDesignerInteraction.add(geo);else this.__controlsToRecheckAfterDesignerInteraction.add(geos);return{skippedResizedEventList:[],skippedMovedEventList:[]}}let resized=[],moved=[],skippedMoved=[],skippedResized=[];const parentSizeCache=new Map,parentCellSizeCache=new Map;let checkCount=0,movedCount=0,resizedCount=0;const checkOne=geo=>{if(!force&&!geo.isDirty)return;let gctrl=geo.ctrl;if(!gctrl)return;if(gctrl.getIsDestroyed())return;let collapseCheckControl=gctrl;for(;collapseCheckControl;){if("Collapsed"===collapseCheckControl.getVisibility())return geo.isDirty=!0,void(geo.isCollapsed=!0);collapseCheckControl=collapseCheckControl.getParent()}checkCount++;let gElem=gctrl.getElement()[0],boundingRect=gElem.getBoundingClientRect();geo.layoutData.computedStyles=StyleProvider.getComputedElementStyle(gElem,["left","top","right","bottom","width","height"]);let offsetLeft=gElem.offsetLeft,offsetTop=gElem.offsetTop,parentCtrl=gctrl.getParent();if(parentCtrl)if(controlManager.getDescriptionTypes(parentCtrl.getType()).includes("TcHmi.Controls.System.TcHmiGrid")){const gridElem=gctrl.getElement()[0].parentElement.parentElement;let computedNumbers;if(parentCellSizeCache.has(gridElem))computedNumbers=parentCellSizeCache.get(gridElem);else{const computedGridCellStyle=StyleProvider.getComputedElementStyle(gridElem,["border-left-width","padding-left","border-top-width","padding-top"]);computedNumbers={"border-left-width":parseFloat(computedGridCellStyle["border-left-width"]),"padding-left":parseFloat(computedGridCellStyle["padding-left"]),"border-top-width":parseFloat(computedGridCellStyle["border-top-width"]),"padding-top":parseFloat(computedGridCellStyle["padding-top"])},parentCellSizeCache.set(gridElem,computedNumbers)}offsetLeft+=computedNumbers["border-left-width"]+computedNumbers["padding-left"],offsetTop+=computedNumbers["border-top-width"]+computedNumbers["padding-top"]}else{let computedNumbers;const elementToCheck=parentCtrl.getElement()[0];if(parentSizeCache.has(elementToCheck))computedNumbers=parentSizeCache.get(elementToCheck);else{const computedStyle=StyleProvider.getComputedElementStyle(elementToCheck,["border-left-width","border-top-width"]);computedNumbers={"border-left-width":parseFloat(computedStyle["border-left-width"]),"border-top-width":parseFloat(computedStyle["border-top-width"])},parentSizeCache.set(elementToCheck,computedNumbers)}offsetLeft+=computedNumbers["border-left-width"],offsetTop+=computedNumbers["border-top-width"]}let inject=!1;this.__checkResize(geo,{width:boundingRect.width,height:boundingRect.height})&&(geo.layoutData.resized=!0,resized.push(geo),inject=!0,resizedCount++);let eMoved=this.__checkMoved(geo,{boundingTop:boundingRect.top,boundingLeft:boundingRect.left,offsetTop,offsetLeft});0!==eMoved&&(geo.layoutData.moved=!0,geo.layoutData.movedLocal=1===eMoved,moved.push(geo),inject=!0,movedCount++),inject&&gctrl.__injectRenderedDimensions(geo.layoutData),geo.isDirty=!1};geos instanceof Map||geos instanceof Set?geos.forEach(checkOne):checkOne(geos),checkCount&&-1===TCHMI_CONSOLE_LOG_LEVEL&&performance.mark(`System.ControlManager: checked geometry of ${checkCount} controls (${movedCount} moved, ${resizedCount} resized).`);for(let i=0,ii=resized.length;i<ii;i++){let rgeo=resized[i];TcHmi.EventProvider.raise(rgeo.ctrl.getId()+".System.onPrevResized",rgeo),delayUserEvents?skippedResized.push(rgeo.ctrl):(TcHmi.EventProvider.raise(rgeo.ctrl.getId()+".onResized",rgeo.ctrl),TcHmi.EventProvider.raise("System.onControlsResized",[rgeo.ctrl]))}for(let i=0,ii=moved.length;i<ii;i++){let mgeo=moved[i];TcHmi.EventProvider.raise(mgeo.ctrl.getId()+".System.onPrevMoved",mgeo),delayUserEvents?skippedMoved.push(mgeo.ctrl):(TcHmi.EventProvider.raise(mgeo.ctrl.getId()+".onMoved",mgeo.ctrl,{movedLocal:mgeo.layoutData.movedLocal}),TcHmi.EventProvider.raise("System.onControlsMoved",[mgeo.ctrl]))}return{skippedResizedEventList:skippedResized,skippedMovedEventList:skippedMoved}}checkControlGeometryByControl(control){const id=control.getId(),geo=this.__controlsGeoMap.get(id);geo&&this.checkControlGeometry({geos:geo,checkReason:"size check for control "+id})}__checkResize(geo,{width,height}){const layoutData=geo.layoutData;let bResized=!1;return width=Math.round(width),height=Math.round(height),geo.isCollapsed?(layoutData.bounds.width=width,layoutData.bounds.height=height,geo.isCollapsed=!1,bResized=!0):null===layoutData.bounds.width&&null===layoutData.bounds.height?(layoutData.bounds.width=width,layoutData.bounds.height=height,bResized=!0):layoutData.bounds.width===width&&layoutData.bounds.height===height||(layoutData.bounds.width=width,layoutData.bounds.height=height,bResized=!0),bResized}__checkMoved(geo,{boundingTop,boundingLeft,offsetTop,offsetLeft}){const layoutData=geo.layoutData;let moved=0;return geo.isCollapsed?(layoutData.bounds.topGlobal=boundingTop,layoutData.bounds.leftGlobal=boundingLeft,layoutData.bounds.offsetTop=offsetTop,layoutData.bounds.offsetLeft=offsetLeft,geo.isCollapsed=!1,moved=2):null===layoutData.bounds.topGlobal&&null===layoutData.bounds.leftGlobal||layoutData.bounds.offsetTop!==offsetTop||layoutData.bounds.offsetLeft!==offsetLeft?(layoutData.bounds.topGlobal=boundingTop,layoutData.bounds.leftGlobal=boundingLeft,layoutData.bounds.offsetTop=offsetTop,layoutData.bounds.offsetLeft=offsetLeft,moved=1):layoutData.bounds.topGlobal===boundingTop&&layoutData.bounds.leftGlobal===boundingLeft||(layoutData.bounds.topGlobal=boundingTop,layoutData.bounds.leftGlobal=boundingLeft,layoutData.bounds.offsetTop=offsetTop,layoutData.bounds.offsetLeft=offsetLeft,moved=2),moved}getControlsCache(){return this.__controls}static __procConstructor(module,element,pcElement,attrs){if(!module.reg||!module.reg.ctrlConstructor)return{error:TcHmi.Errors.E_REGISTRATION_ERROR,details:{code:TcHmi.Errors.E_REGISTRATION_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_REGISTRATION_ERROR],domain:"TcHmi.System.ControlManager",reason:"Failed to compile control."+(module.reg?module.reg.ctrlConstructor?"":" Missing constructor.":" Missing registration.")},control:void 0};try{if(!module.reg.nativeEs6Control&&module.reg.nearestEs6Constructor){let nativeES6control=Reflect.construct(module.reg.nearestEs6Constructor,[element,pcElement,attrs],module.reg.ctrlConstructor);return module.reg.ctrlConstructor.apply(nativeES6control,[element,pcElement,attrs]),{error:TcHmi.Errors.NONE,control:nativeES6control}}return{error:TcHmi.Errors.NONE,control:new module.reg.ctrlConstructor(element,pcElement,attrs)}}catch(e){return Log.errorEx('[Source=Framework, Module=TcHmi.System.ControlManager] Constructor of control of type: "'+element.attr("data-tchmi-type")+'" and with id: "'+element.attr("id")+'" has thrown an exception:\n',e),{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],domain:"TcHmi.System.ControlManager",reason:'Failed to compile control. Constructor of control of type: "'+element.attr("data-tchmi-type")+'" and with id: "'+element.attr("id")+'" has thrown an exception.',exception:e instanceof Error?e:void 0},control:void 0}}}static __procPrevinit(co){try{return co.__previnit(),{code:TcHmi.Errors.NONE}}catch(e){try{Log.errorEx('[Source=Framework, Module=TcHmi.System.ControlManager] Function: "__previnit" of control of type: "'+co.getType()+'" and with id: "'+co.getId()+'" has thrown an exception:\n',e),co.destroy()}catch(e2){}return{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],domain:"TcHmi.System.ControlManager",reason:'Failed to compile control. Function: "__previnit" of control of type: "'+co.getType()+'" and with id: "'+co.getId()+'" has thrown an exception.',exception:e instanceof Error?e:void 0}}}static __procInit(co){try{return co.__init(),{code:TcHmi.Errors.NONE}}catch(e){try{Log.errorEx('[Source=Framework, Module=TcHmi.System.ControlManager] Function: "__init" of control of type: "'+co.getType()+'" and with id: "'+co.getId()+'" has thrown an exception:\n',e),co.destroy()}catch(e2){}return{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],domain:"TcHmi.System.ControlManager",reason:'Failed to compile control. Function: "__init" of control of type: "'+co.getType()+'" and with id: "'+co.getId()+'" has thrown an exception.',exception:e instanceof Error?e:void 0}}}setControlProperty(control,propertyName,valueNew,dirtyPaths){let attribute=this.getAttributeByPropertyName(control,propertyName);if(!attribute){let reason="";return propertyName&&(reason=`Missing attribute description of attribute property: ${propertyName} for control type: ${control.getType()}.`),{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason,domain:"TcHmi.System.ControlManager"}}return attribute.readOnly?{code:TcHmi.Errors.E_SYMBOL_READONLY,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_READONLY],reason:`Property: ${propertyName} of control type: ${control.getType()} is readonly.`,domain:"TcHmi.System.ControlManager"}:attribute.propertySetterName?this.setControlPropertyByAttribute(control,attribute,valueNew,dirtyPaths):{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_INVALID_CONFIGURATION,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_INVALID_CONFIGURATION],reason:`Missing propertySetterName in configuration of attribute property: ${propertyName} of control type: ${control.getType()}.`,domain:"TcHmi.System.ControlManager"}}__schemaWithNoPath=new Set;setControlPropertyByAttribute(control,attribute,valueNew,dirtyPaths){let attributeSetter=control[attribute.propertySetterName];if("function"!=typeof attributeSetter)return{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:`Missing implementation of setter function: ${attribute.propertySetterName} for attribute property: ${attribute.propertyName} of control type: ${control.getType()}.`,domain:"TcHmi.System.ControlManager"};let watchNeeded=!1,prepValue={error:TcHmi.Errors.NONE,value:valueNew};if(null===valueNew){const themeValue=themeManager.getDefaultPropertyValue(control,attribute.propertyName);if(prepValue.value=themeValue.value,themeValue.value&&!this.__schemaWithNoPath.has(attribute.type)){this.__schemaWithNoPath.add(attribute.type);const schema=getSchema(attribute.type),res=recurseThroughSchema(schema??{},prepValue.value,(subschema,subdata,_path)=>{if("tchmi:framework#/definitions/Path"===subschema.id&&(this.__schemaWithNoPath.delete(attribute.type),"string"==typeof subdata&&subdata.length>0)){return{changedValue:!0,value:ThemeResources.resolveBasePath(control,themeValue)+subdata}}return{changedValue:!1,value:subdata}});res.changedValue&&(prepValue.value=res.value)}watchNeeded=!0}if(prepValue=ValueConverter.toTypeEx(prepValue.value,attribute.type),null===prepValue.value&&(null!==prepValue.value||null!==valueNew))return this.setControlPropertyByAttribute(control,attribute,null),{code:TcHmi.Errors.E_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_VALUE_INVALID],reason:`Unable to convert js value of type "${typeof valueNew}" to tchmi type ${attribute.type} for control attribute "${control.getId()}::${attribute.propertyName}" (type ${control.getType()}).`,domain:"TcHmi.System.ControlManager",errors:prepValue.details?[prepValue.details]:void 0};try{attributeSetter.call(control,prepValue.value,dirtyPaths)}catch(e){return{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:`An uncaught exception occurred in setter function ${attribute.propertySetterName} of attribute property ${attribute.propertyName} of control of type ${control.getType()} with id ${control.getId()}`,exception:e,domain:"TcHmi.System.ControlManager"}}return watchNeeded&&"None"!==attribute.themeable?themeManager.watchAttributeDefaults(control,attribute.propertyName):themeManager.unwatchAttributeDefaults(control,attribute.propertyName),{code:TcHmi.Errors.NONE,message:TcHmi.Errors[TcHmi.Errors.NONE],domain:"TcHmi.System.ControlManager"}}destruct(control){const controlId=control.getId();this.__controlsGeoMap.has(controlId)&&this.__controlsGeoMap.delete(controlId),this.__controlsPresavedGeoMap.has(control)&&this.__controlsPresavedGeoMap.delete(control),this.__controls.has(controlId)?this.__controls.delete(controlId):Log.warn("[Source=Framework, Module=TcHmi.System.ControlManager] Unable to destroy control with id="+controlId+" because its already destroyed!")}compile(elem,parent,options){const controlType=elem.getAttribute("data-tchmi-type");if(!controlType)return Log.error("[Source=Framework, Module=TcHmi.System.ControlManager] Failed to compile control. Missing required attribute=data-tchmi-type in html="+elem.outerHTML),{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.ControlManager",reason:"Failed to compile control. Missing required attribute=data-tchmi-type in html="+elem.outerHTML},control:void 0};const controlId=elem.id;if(!controlId)return Log.error("[Source=Framework, Module=TcHmi.System.ControlManager] Failed to compile control. Missing required attribute=id in html="+elem.outerHTML),{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],domain:"TcHmi.System.ControlManager",reason:"Failed to compile control. Missing required attribute=id in html="+elem.outerHTML},control:void 0};let module=Data.Modules.controls.map.get(controlType);if(!module)return Log.errorEx("[Source=Framework, Module=TcHmi.System.ControlManager] Failed to compile control. Missing meta data for control type: %o\nSee error reporting on initial hmi loading for possible reasons.",controlType),{error:TcHmi.Errors.E_MODULE_ERROR,details:{code:TcHmi.Errors.E_MODULE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_MODULE_ERROR],domain:"TcHmi.System.ControlManager",reason:"Failed to compile control. Missing meta data for control type: "+controlType},control:void 0};if(module.error!==TcHmi.Errors.NONE||!module.reg){let message="[Source=Framework, Module=TcHmi.System.ControlManager] "+Log.buildMessage(module.errorDetails);return Log.error(message),{error:TcHmi.Errors.E_MODULE_ERROR,details:{code:TcHmi.Errors.E_MODULE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_MODULE_ERROR],domain:"TcHmi.System.ControlManager",reason:"Failed to compile control.",errors:module.errorDetails?[module.errorDetails]:void 0},control:void 0}}if(module.reg.error!==TcHmi.Errors.NONE){let message="[Source=Framework, Module=TcHmi.System.ControlManager] "+Log.buildMessage(module.reg.errorDetails);return Log.error(message),{error:TcHmi.Errors.E_REGISTRATION_ERROR,details:{code:TcHmi.Errors.E_REGISTRATION_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_REGISTRATION_ERROR],domain:"TcHmi.System.ControlManager",reason:"Failed to compile control.",errors:module.reg.errorDetails?[module.reg.errorDetails]:void 0},control:void 0}}TCHMI_DESIGNER&&options&&!0===options.designerIgnore&&elem.setAttribute("data-tchmi-designer-ignore","");let pcElement=$(elem.cloneNode(!0));if(TCHMI_DESIGNER&&(!options||options&&!options.designerIgnore)){let markup=elem.outerHTML;markup=resolveReplaceExpressions(markup,{PkgBasePath:"."});let purl=null;if("TcHmi.Controls.System.TcHmiUserControl"===controlType)purl=tchmi_path(elem.getAttribute("data-tchmi-partial-url"));else{let rootUc=null;if(parent){let temp=parent;for(;temp;){if("TcHmi.Controls.System.TcHmiUserControl"===temp.getType()){rootUc=temp;break}temp=temp.getParent()}}rootUc&&(purl=tchmi_path(rootUc.getElement()[0].getAttribute("data-tchmi-partial-url")))}if(purl&&purl===TCHMI_TARGET_PARTIAL){let exprsPartialParam=new SymbolExpressionFromText(markup).resolveExpressionsBySymbolType(TcHmi.SymbolType.PartialParam);if(exprsPartialParam)for(let i=0,ii=exprsPartialParam.length;i<ii;i++){let expr=exprsPartialParam[i];const content=expr.getContent();content&&(markup=markup.replace(new RegExp(tchmi_escape_regex(expr.toString()),"g"),`%pp%TCHMI_TARGET_DESIGNER_PARTIALPARAM::${content}%/pp%`))}}let tempDiv=document.createElement("div");tempDiv.innerHTML=markup,elem=tempDiv.firstElementChild}let attrs=resolveAttributesFromControlElement(elem);if(TCHMI_DESIGNER)attrs.error||ErrorPane.remove(`${controlId}.attributeResolveError`);else if(TCHMI_RUNTIME&&attrs.error){const message=`[Source=Framework, Module=TcHmi.System.ControlManager] Error while parsing attributes of control: "${controlId}". Details: `+Log.buildMessage(attrs.details);Log.errorEx(message)}if(elem.textContent="",options?.overrideAttr)for(const[name,value]of Object.entries(options.overrideAttr)){if(void 0===value)continue;const descr=this.getDescriptionAttributeByName(controlType,name);if(attrs.value[name]={name,value:tchmi_clone_object(value),type:ControlAttributeType.General,valueType:"object"==typeof value?ControlAttributeValueType.Complex:ControlAttributeValueType.Simple,descr},descr)attrs.value[name].type=ControlAttributeType.Control;else{const targetUserControl=attrs.value["data-tchmi-target-user-control"]?.value??options.overrideAttr["data-tchmi-target-user-control"]??void 0,targetUserControlConfig=targetUserControl?Data.Caches.partialCompositeConfigCache.get(tchmi_path(targetUserControl.replace(".usercontrol",".usercontrol.json"))):void 0;if(targetUserControlConfig&&targetUserControlConfig.parameters){let lowerCaseName=name.toLowerCase();for(const paramDescription of targetUserControlConfig.parameters)if(paramDescription.name.toLowerCase()===lowerCaseName){attrs.value[name].descr=paramDescription,attrs.value[name].descr&&(attrs.value[name].type=ControlAttributeType.UserControlParameter);break}}}attrs.value[name].descr||"object"==typeof value||elem.setAttribute(name,value)}let existingCo=this.__controls.get(controlId);if(void 0!==existingCo){let reason="Failed to compile control.";const existingControlPartialUrl=existingCo.getElement().attr("data-tchmi-partial-url");return!isInitialized&&existingControlPartialUrl&&existingControlPartialUrl===elem.getAttribute("data-tchmi-partial-url")||(Log.error('[Source=Framework, Module=TcHmi.System.ControlManager] Failed to create instance of control. The id: "'+controlId+'" does already exist.'),reason+=' Failed to create instance of control. The id: "'+controlId+'" does already exist.'),{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.ControlManager",reason,errors:module.reg.errorDetails?[module.reg.errorDetails]:void 0},control:void 0}}const contructorResult=ControlManager.__procConstructor(module,$(elem),pcElement,attrs.value),co=contructorResult.control;if(contructorResult.error!==TcHmi.Errors.NONE||void 0===co)return{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.ControlManager",reason:"Failed to compile control. Constructor failed",errors:contructorResult.details?[contructorResult.details]:void 0},control:void 0};if(this.__controlsWeak.add(co),parent||co.__setParent(null),this.__controls.set(controlId,co),parent){let pos=options?options.pos:void 0;parent.__addChild(co,pos)}if(module.descriptionExpanded?.inheritedTemplate){let templateElem=Data.Caches.templateMarkupElementCache.get(module.descriptionExpanded.inheritedTemplate)?.cloneNode(!0);if(!templateElem){const templateStr=Data.Caches.templateMarkupCache.get(module.descriptionExpanded.inheritedTemplate);if(!templateStr)return Log.error(`[Source=Framework, Module=TcHmi.System.ControlManager] Template markup for control type: "${controlType}" is not available.`),{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.ControlManager",reason:`Template markup for control type: "${controlType}" is not available.`},control:void 0};let tempDiv=document.createElement("div");templateStr.includes("{Id}")?tempDiv.innerHTML=templateStr.replace(/{Id}/g,controlId):(tempDiv.innerHTML=templateStr,tempDiv.firstElementChild&&Data.Caches.templateMarkupElementCache.set(module.descriptionExpanded.inheritedTemplate,tempDiv.firstElementChild.cloneNode(!0))),tempDiv.childElementCount>1&&Log.warnEx("[Source=Framework, Module=TcHmi.System.ControlManager] Template of control type %o has more than one child element. Only the first child element will be used.",controlType),templateElem=tempDiv.firstElementChild}if(templateElem){let recCompTemplate=e=>{let eChildren=e.children;for(let i=0,ii=eChildren.length;i<ii;i++){let eChild=eChildren[i];if(eChild.hasAttribute("data-tchmi-type")){let cco=this.compile(eChild,co,{designerIgnore:!0});cco.control&&cco.error===TcHmi.Errors.NONE&&co.__addChild(cco.control)}else eChild.hasChildNodes()&&recCompTemplate(eChild)}};recCompTemplate(templateElem),elem.appendChild(templateElem)}}const prevInitResult=ControlManager.__procPrevinit(co);if(prevInitResult.code!==TcHmi.Errors.NONE)return this.__controls.delete(controlId),{error:prevInitResult.code,details:prevInitResult,control:void 0};const settedProperties=new Set,destroySettedPropertyWatch=TcHmi.EventProvider.register(controlId+".onPropertyChanged",(e,data)=>{data.propertyName&&settedProperties.add(data.propertyName)});for(let htmlAttrName in attrs.value){let controlAttribute=attrs.value[htmlAttrName];if(void 0===controlAttribute.descr||null===controlAttribute.descr)continue;if(settedProperties.add(controlAttribute.descr.propertyName),"data-tchmi-trigger"===htmlAttrName)continue;let isSymbolExpression=TcHmi.Symbol.isSymbolExpression(controlAttribute.value),isSymbolExpressionEscaped=TcHmi.Symbol.isSymbolExpressionEscaped(controlAttribute.value);if(controlAttribute.descr.readOnly);else if(isSymbolExpression&&!isSymbolExpressionEscaped){let controlAttributeSchema=typeManager.getSchema(controlAttribute.descr.type);"TcHmi.Symbol"!==controlAttributeSchema?.frameworkInstanceOf&&this.setControlPropertyByAttribute(co,controlAttribute.descr,null),bindingManager.createBinding(controlAttribute.value,controlAttribute.descr.propertyName,co)}else{let prepValue=controlAttribute.value;isSymbolExpressionEscaped&&(prepValue=TcHmi.Symbol.escapeSymbolExpression(prepValue));let error=this.setControlPropertyByAttribute(co,controlAttribute.descr,prepValue);error&&error.code!==TcHmi.Errors.NONE&&(error.exception?Log.errorEx('[Source=Framework, Module=TcHmi.System.ControlManager] Failed to set property: "'+controlAttribute.descr.propertyName+'" of control: "'+controlId+'". '+Log.buildMessage(error),"\nException:",error.exception):Log.errorEx('[Source=Framework, Module=TcHmi.System.ControlManager] Failed to set property: "'+controlAttribute.descr.propertyName+'" of control: "'+controlId+'". '+Log.buildMessage(error)))}}destroySettedPropertyWatch(),ErrorPane.remove(controlId+".requiredAttributeMissing");const descriptionAttributes=this.getDescriptionAttributes(controlType)??[];for(let possibleControlAttr of descriptionAttributes){if(possibleControlAttr.readOnly)continue;if(settedProperties.has(possibleControlAttr.propertyName))continue;if(possibleControlAttr.requiredOnCompile)return ErrorPane.add(controlId+".requiredAttributeMissing","Error compiling control id="+controlId+" type="+co.getType()+". Attribute "+possibleControlAttr.propertyName+" is required but has not been set in HTML.",ErrorPane.MessageType.Error),this.__controls.delete(controlId),{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.ControlManager",reason:"Error compiling control id="+controlId+" type="+co.getType()+". Attribute "+possibleControlAttr.propertyName+" is required but has not been set in HTML."},control:void 0};let error=this.setControlPropertyByAttribute(co,possibleControlAttr,null);error&&error.code!==TcHmi.Errors.NONE&&(error.exception?Log.errorEx('[Source=Framework, Module=TcHmi.System.ControlManager] Failed to set property: "'+possibleControlAttr.propertyName+'" of control: "'+controlId+'". '+Log.buildMessage(error),"\nException:",error.exception):Log.errorEx('[Source=Framework, Module=TcHmi.System.ControlManager] Failed to set property: "'+possibleControlAttr.propertyName+'" of control: "'+controlId+'". '+Log.buildMessage(error)))}themeManager.startAttributeSetterWatcher(co);let controlAttributeTrigger=attrs.value["data-tchmi-trigger"];if(null!=controlAttributeTrigger&&void 0!==controlAttributeTrigger.descr&&null!==controlAttributeTrigger.descr){let isSymbolExpression=TcHmi.Symbol.isSymbolExpression(controlAttributeTrigger.value),isSymbolExpressionEscaped=TcHmi.Symbol.isSymbolExpressionEscaped(controlAttributeTrigger.value);if(controlAttributeTrigger.descr.readOnly);else if(isSymbolExpression&&!isSymbolExpressionEscaped)bindingManager.createBinding(controlAttributeTrigger.value,controlAttributeTrigger.descr.propertyName,co);else{let prepValue=controlAttributeTrigger.value;isSymbolExpressionEscaped&&(prepValue=TcHmi.Symbol.escapeSymbolExpression(prepValue));let error=this.setControlPropertyByAttribute(co,controlAttributeTrigger.descr,prepValue);error&&error.code!==TcHmi.Errors.NONE&&(error.exception?Log.errorEx('[Source=Framework, Module=TcHmi.System.ControlManager] Failed to set property: "Trigger" of control: "'+controlId+'". '+Log.buildMessage(error),"\nException:",error.exception):Log.errorEx('[Source=Framework, Module=TcHmi.System.ControlManager] Failed to set property: "Trigger" of control: "'+controlId+'". '+Log.buildMessage(error)))}}co.__setLifeCycleState(15);const initResult=ControlManager.__procInit(co);return initResult.code!==TcHmi.Errors.NONE?(this.__controls.delete(controlId),{error:initResult.code,details:initResult,control:void 0}):{error:TcHmi.Errors.NONE,control:co}}__resolveDescriptionTypes(module){if(!module.descriptionExpanded||!module.description)return void Log.error("[Source=Framework, Module=TcHmi.System.ControlManager] Internal error. DescriptionExpanded or Description not found.");module.descriptionExpanded.inheritedTypes=[];let base=module.descriptionExpanded.base;if(null!=base){let baseModule=Data.Modules.controls.map.get(base);if(!baseModule)return void Log.error("[Source=Framework, Module=TcHmi.System.ControlManager] Resolving description types of control "+module.description.name+' failed: Base control "'+base+'" not found.');if(baseModule.error!==TcHmi.Errors.NONE)return void Log.error("[Source=Framework, Module=TcHmi.System.ControlManager] Resolving description types of control "+module.description.name+' failed: Base control module "'+base+'" contains errors: '+Log.buildMessage(baseModule.errorDetails));this.__resolveDescriptionTypes(baseModule);let baseInhertedTypes=this.getDescriptionTypes(base);for(let i=0,ii=baseInhertedTypes.length;i<ii;i++){let bitype=baseInhertedTypes[i];module.descriptionExpanded.inheritedTypes.includes(bitype)||module.descriptionExpanded.inheritedTypes.push(bitype);let bitypeLegacy=mapControlNamesFromPackageManifestApi1ToApi0.get(bitype);bitypeLegacy&&(module.descriptionExpanded.inheritedTypes.includes(bitypeLegacy)||module.descriptionExpanded.inheritedTypes.push(bitypeLegacy))}}let type=resolveQualifiedName(module.description.name,module.description.namespace);module.descriptionExpanded.inheritedTypes.push(type);let legacyType=mapControlNamesFromPackageManifestApi1ToApi0.get(type);legacyType&&module.descriptionExpanded.inheritedTypes.push(legacyType)}__resolveDescriptionInheritance(module){if(!module.descriptionExpanded||!module.description)return void Log.error("[Source=Framework, Module=TcHmi.System.ControlManager] Internal error. DescriptionExpanded or Description not found.");let baseAttrs=[],baseAccess=[],baseFunctions=[],baseEvents=[],baseLanguages={};module.descriptionExpanded.inheritedAttributes=[],module.descriptionExpanded.inheritedAttributesNameMap=new Map,module.descriptionExpanded.inheritedAttributesPropertyNameMap=new Map,module.descriptionExpanded.inheritedAttributesPropertyGetterNameMap=new Map,module.descriptionExpanded.inheritedAttributesPropertySetterNameMap=new Map,module.descriptionExpanded.inheritedAccess=[],module.descriptionExpanded.inheritedFunctions=[],module.descriptionExpanded.inheritedEvents=[],module.descriptionExpanded.inheritedLanguages={};let base=module.descriptionExpanded.base;if(null!=base){let baseModule=Data.Modules.controls.map.get(base);if(!baseModule)return void Log.error("[Source=Framework, Module=TcHmi.System.ControlManager] Resolving description inheritance of control "+module.description.name+' failed: Base control "'+base+'" not found.');if(baseModule.error!==TcHmi.Errors.NONE||!baseModule.descriptionExpanded)return void Log.error("[Source=Framework, Module=TcHmi.System.ControlManager] Resolving description inheritance of control "+module.description.name+' failed: Base control module "'+base+'" contains errors: '+Log.buildMessage(baseModule.errorDetails));this.__resolveDescriptionInheritance(baseModule);let baseInheritedAttributes=baseModule.descriptionExpanded.inheritedAttributes;if(void 0!==baseInheritedAttributes)for(let i=0,ii=baseInheritedAttributes.length;i<ii;i++)baseInheritedAttributes[i].heritable&&baseAttrs.push(baseInheritedAttributes[i]);let baseInheritedAccess=baseModule.descriptionExpanded.inheritedAccess;void 0!==baseInheritedAccess&&0!==baseInheritedAccess.length&&(baseAccess=baseAccess.concat(baseInheritedAccess));let baseInheritedFunctions=baseModule.descriptionExpanded.inheritedFunctions;void 0!==baseInheritedFunctions&&0!==baseInheritedFunctions.length&&(baseFunctions=baseFunctions.concat(baseInheritedFunctions));let baseInheritedEvents=baseModule.descriptionExpanded.inheritedEvents;void 0!==baseInheritedEvents&&0!==baseInheritedEvents.length&&(baseEvents=baseEvents.concat(baseInheritedEvents));let baseInheritedLanguages=baseModule.descriptionExpanded.inheritedLanguages;if(null!=baseInheritedLanguages)for(let key in baseInheritedLanguages)baseLanguages[key]=baseInheritedLanguages[key]}let attributes=tchmi_clone_object(module.descriptionExpanded.attributes);null==attributes&&(attributes=[]);for(let i=0,ii=baseAttrs.length;i<ii;i++){let bOverwriteExists=!1;for(let j=0,jj=attributes.length;j<jj;j++)if(attributes[j].name.toLowerCase()===baseAttrs[i].name.toLowerCase()){bOverwriteExists=!0;break}bOverwriteExists||module.descriptionExpanded.inheritedAttributes.push(baseAttrs[i])}module.descriptionExpanded.inheritedAttributes=module.descriptionExpanded.inheritedAttributes.concat(attributes);for(let k=0,kk=module.descriptionExpanded.inheritedAttributes.length;k<kk;k++){let attr=module.descriptionExpanded.inheritedAttributes[k];module.descriptionExpanded.inheritedAttributesNameMap.set(attr.name.toLowerCase(),attr),attr.propertyName?module.descriptionExpanded.inheritedAttributesPropertyNameMap.set(attr.propertyName.toLowerCase(),attr):Log.error('[Source=Framework, Module=TcHmi.System.ControlManager] Description.json of control type "'+module.descriptionExpanded.displayName+'" attribute "'+attr.name+'" has no propertyName entry. Handling this attribute will not work.'),attr.propertyGetterName?module.descriptionExpanded.inheritedAttributesPropertyGetterNameMap.set(attr.propertyGetterName.toLowerCase(),attr):Log.error('[Source=Framework, Module=TcHmi.System.ControlManager] Description.json of control type "'+module.descriptionExpanded.displayName+'" attribute "'+attr.name+'" has no propertyGetterName entry. Handling this attribute will not work.'),attr.propertySetterName?module.descriptionExpanded.inheritedAttributesPropertySetterNameMap.set(attr.propertySetterName.toLowerCase(),attr):attr.readOnly||Log.error('[Source=Framework, Module=TcHmi.System.ControlManager] Description.json of control type "'+module.descriptionExpanded.displayName+'" attribute "'+attr.name+'" has no propertySetterName entry. Handling this attribute will not work.')}let access=module.descriptionExpanded.access;null==access&&(access=[]);for(let i=0,ii=baseAccess.length;i<ii;i++){let bOverwriteExists=!1;for(let j=0,jj=access.length;j<jj;j++)if(access[j].name===baseAccess[i].name){bOverwriteExists=!0;break}bOverwriteExists||module.descriptionExpanded.inheritedAccess.push(baseAccess[i])}0!==access.length&&(module.descriptionExpanded.inheritedAccess=module.descriptionExpanded.inheritedAccess.concat(access));let functions=module.descriptionExpanded.functions;null==functions&&(functions=[]);for(let i=0,ii=baseFunctions.length;i<ii;i++){let bOverwriteExists=!1;for(let j=0,jj=functions.length;j<jj;j++)if(functions[j].name===baseFunctions[i].name){bOverwriteExists=!0;break}bOverwriteExists||module.descriptionExpanded.inheritedFunctions.push(baseFunctions[i])}0!==functions.length&&(module.descriptionExpanded.inheritedFunctions=module.descriptionExpanded.inheritedFunctions.concat(functions));let events=module.descriptionExpanded.events;null==events&&(events=[]);for(let i=0,ii=baseEvents.length;i<ii;i++){let bOverwriteExists=!1;for(let j=0,jj=events.length;j<jj;j++)if(events[j].name===baseEvents[i].name){bOverwriteExists=!0;break}bOverwriteExists||module.descriptionExpanded.inheritedEvents.push(baseEvents[i])}0!==events.length&&(module.descriptionExpanded.inheritedEvents=module.descriptionExpanded.inheritedEvents.concat(events));let languages=module.descriptionExpanded.languages;null==languages&&(languages={});for(let keyBase in baseLanguages){let bOverwriteExists=!1;for(let keyCurrent in languages)if(keyCurrent===keyBase){bOverwriteExists=!0;break}bOverwriteExists||(module.descriptionExpanded.inheritedLanguages[keyBase]=baseLanguages[keyBase])}if(0!==events.length)for(let key in languages)module.descriptionExpanded.inheritedLanguages[key]=languages[key]}__resolveInheritanceHierarchy(module){if(!module||module.error!==TcHmi.Errors.NONE||!module.descriptionExpanded)return null;const newEntry={controlType:resolveQualifiedName(module.descriptionExpanded.name,module.descriptionExpanded.namespace),children:[]};if(module.descriptionExpanded.base){let findInheritanceBaseObj=(controlType,level)=>{if(!level){if(!module.descriptionExpanded)return null;let baseModule=Data.Modules.controls.map.get(module.descriptionExpanded.base);return this.__resolveInheritanceHierarchy(baseModule)}if(controlType===level.controlType)return level;for(let iterator=0;iterator<level.children.length;iterator++){let childEntry=level.children[iterator],subtreeHit=findInheritanceBaseObj(controlType,childEntry);if(subtreeHit)return subtreeHit}return null},inheritanceBaseObj=findInheritanceBaseObj(module.descriptionExpanded.base,this.__inheritanceHierarchyTree);if(inheritanceBaseObj){for(let iterator=0;iterator<inheritanceBaseObj.children.length;iterator++){let childEntry=inheritanceBaseObj.children[iterator];if(childEntry.controlType===resolveQualifiedName(module.descriptionExpanded.name,module.descriptionExpanded.namespace))return childEntry}inheritanceBaseObj.children.push(newEntry)}else{let baseModule=Data.Modules.controls.map.get(module.descriptionExpanded.base),inheritanceNewBaseObj=this.__resolveInheritanceHierarchy(baseModule);if(!inheritanceNewBaseObj)return null;inheritanceNewBaseObj.children.push(newEntry)}}else{if(this.__inheritanceHierarchyTree)return this.__inheritanceHierarchyTree;this.__inheritanceHierarchyTree=newEntry}return newEntry}__resolveTemplateInheritation(module){if(!module||!module.descriptionExpanded)return;let resolve=function(type){let module=Data.Modules.controls.map.get(type);if(module&&module.error===TcHmi.Errors.NONE&&module.descriptionExpanded)return module.descriptionExpanded.template?module.package||module.manifestData||!module.configData?module.package&&module.manifestData&&!module.configData?tchmi_path(module.package.basePath+"/"+module.manifestData.basePath+"/"+module.descriptionExpanded.template):void 0:tchmi_path(module.configData.basePath+"/"+module.descriptionExpanded.template):resolve(module.descriptionExpanded.base)};if(module.descriptionExpanded.template){let templateKey;module.package||module.manifestData||!module.configData?module.package&&module.manifestData&&!module.configData&&(templateKey=tchmi_path(module.package.basePath+"/"+module.manifestData.basePath+"/"+module.descriptionExpanded.template)):templateKey=tchmi_path(module.configData.basePath+"/"+module.descriptionExpanded.template),module.descriptionExpanded.inheritedTemplate=templateKey}else module.descriptionExpanded.inheritedTemplate=resolve(module.descriptionExpanded.base)}__validateDescriptionAttributes(module){if(module&&module.description)for(const attribute of module.description.attributes){const res=typeManager.getSchemaEx(attribute.type);res.error!==TcHmi.Errors.NONE&&Log.error("[Source=Framework, Module=TcHmi.System.ControlManager] Attribute "+attribute.propertyName+" of control "+resolveQualifiedName(module.description?.name??"",module.description?.namespace)+" uses invalid data type "+attribute.type+": "+Log.buildMessage(res.details))}}resolveDescriptionInheritation(){try{const modulesSorted=Array.from(Data.Modules.controls.array);modulesSorted.sort((a,b)=>a.descriptionExpanded?.base===b.descriptionExpanded?.name?1:b.descriptionExpanded?.base===a.descriptionExpanded?.name?-1:0);for(const module of modulesSorted)module&&module.descriptionExpanded&&!module.descriptionExpanded.inheritationResolved&&(this.__resolveDescriptionTypes(module),this.__resolveDescriptionInheritance(module),this.__resolveInheritanceHierarchy(module),this.__resolveTemplateInheritation(module),module.descriptionExpanded.inheritationResolved=!0)}catch(e){Log.errorEx("[Source=Framework, Module=TcHmi.System.ControlManager] resolveDescriptionInheritation failed with exception:\n",e)}}getInheritanceTree(){return this.__inheritanceHierarchyTree}getDescription(type,inheritanceExcluded){if(!type)return null;let module=Data.Modules.controls.map.get(type);return!module||module.error?null:!inheritanceExcluded&&module.descriptionExpanded?module.descriptionExpanded:inheritanceExcluded&&module.description?module.description:null}getDescriptionTypes(type){if(!type)return[];let module=Data.Modules.controls.map.get(type);return module&&module.error===TcHmi.Errors.NONE&&module.descriptionExpanded&&module.descriptionExpanded.inheritedTypes?module.descriptionExpanded.inheritedTypes:[]}isRegisteredDescriptionType(type){return!!type&&Data.Modules.controls.map.has(type)}getDescriptionPath(type){if(!type)return null;let module=Data.Modules.controls.map.get(type);return module&&module.error===TcHmi.Errors.NONE?module.package||module.manifestData||!module.configData?module.package&&module.manifestData&&!module.configData?tchmi_path(module.package.basePath+"/"+module.manifestData.basePath+"/"+module.manifestData.descriptionFile):null:tchmi_path(module.configData.basePath+"/"+module.configData.descriptionFile):null}getDescriptionAttributes(type){if(!type)return null;let module=Data.Modules.controls.map.get(type);return module&&module.error===TcHmi.Errors.NONE&&module.descriptionExpanded&&module.descriptionExpanded.inheritedAttributes?module.descriptionExpanded.inheritedAttributes:null}getDescriptionAccess(type){if(!type)return null;let module=Data.Modules.controls.map.get(type);return module&&module.error===TcHmi.Errors.NONE&&module.descriptionExpanded&&module.descriptionExpanded.inheritedAccess?module.descriptionExpanded.inheritedAccess:null}getDescriptionAttributeByName(type,name){if(!type||!name)return null;const lowerName=name.toLowerCase();let module=Data.Modules.controls.map.get(type);if(module&&module.error===TcHmi.Errors.NONE&&module.descriptionExpanded){let res=module.descriptionExpanded.inheritedAttributesNameMap.get(lowerName);return res||null}return null}getDescriptionAttributeByPropertyName(type,propertyName){if(!type||!propertyName)return null;const lowerName=propertyName.toLowerCase();let module=Data.Modules.controls.map.get(type);if(module&&module.error===TcHmi.Errors.NONE&&module.descriptionExpanded){let res=module.descriptionExpanded.inheritedAttributesPropertyNameMap.get(lowerName);return res||null}return null}getUserControlConfigAttributeByPropertyName(ucConfigUrl,propertyName){let UCEntry=this.__usercontrolAttrDescrByPropertyName.get(ucConfigUrl);if(!UCEntry)return null;let res=UCEntry.get(propertyName);return res||null}getDescriptionAttributeByPropertySetterName(type,propertySetterName){if(!type||!propertySetterName)return null;const lowerName=propertySetterName.toLowerCase();let module=Data.Modules.controls.map.get(type);if(module&&module.error===TcHmi.Errors.NONE&&module.descriptionExpanded){let res=module.descriptionExpanded.inheritedAttributesPropertySetterNameMap.get(lowerName);return res||null}return null}getDescriptionAttributeByPropertyGetterName(type,propertyGetterName){if(!type||!propertyGetterName)return null;const lowerName=propertyGetterName.toLowerCase();let module=Data.Modules.controls.map.get(type);if(module&&module.error===TcHmi.Errors.NONE&&module.descriptionExpanded){let res=module.descriptionExpanded.inheritedAttributesPropertyGetterNameMap.get(lowerName);return res||null}return null}getDescriptionLanguages(type){if(!type)return null;let module=Data.Modules.controls.map.get(type);if(module&&module.error===TcHmi.Errors.NONE&&module.descriptionExpanded){let res=module.descriptionExpanded.inheritedLanguages;return res||null}return null}getAttributeByPropertyName(control,propertyName){if(!propertyName)return null;let type=control.getType(),attr=this.getDescriptionAttributeByPropertyName(type,propertyName);if(attr)return attr;if("TcHmi.Controls.System.TcHmiUserControlHost"===type&&"getTargetUserControl"in control&&"function"==typeof control.getTargetUserControl){const targetUserControl=control.getTargetUserControl();if(targetUserControl){let ucConfigUrl=tchmi_path(targetUserControl.replace(".usercontrol",".usercontrol.json"));if(attr=this.getUserControlConfigAttributeByPropertyName(ucConfigUrl,propertyName),attr)return attr}}return null}getAttributeTypeByPropertyName(control,propertyName){if(!control)return ControlAttributeType.Invalid;let type=control.getType(),attr=this.getDescriptionAttributeByPropertyName(type,propertyName);if(attr)return ControlAttributeType.Control;if("TcHmi.Controls.System.TcHmiUserControlHost"===type&&"getTargetUserControl"in control&&"function"==typeof control.getTargetUserControl){const targetUserControl=control.getTargetUserControl();if(targetUserControl){const ucConfigUrl=tchmi_path(targetUserControl.replace(".usercontrol",".usercontrol.json"));if(attr=this.getUserControlConfigAttributeByPropertyName(ucConfigUrl,propertyName),attr)return ControlAttributeType.UserControlParameter}}return ControlAttributeType.Invalid}getAttributeByPropertySetterName(control,propertySetterName){if(!control)return null;let type=control.getType(),attr=controlManager.getDescriptionAttributeByPropertySetterName(type,propertySetterName);if(attr)return attr;if("TcHmi.Controls.System.TcHmiUserControlHost"===type&&"getTargetUserControl"in control&&"function"==typeof control.getTargetUserControl){const targetUserControl=control.getTargetUserControl();if(targetUserControl){let ucConfigUrl=tchmi_path(targetUserControl.replace(".usercontrol",".usercontrol.json")),UCEntry=this.__usercontrolAttrDescrBySetterName.get(ucConfigUrl);if(UCEntry){let UCattr=UCEntry.get(propertySetterName);if(UCattr)return UCattr}}}return null}getAttributeByPropertyGetterName(control,propertyGetterName){if(!control)return null;let type=control.getType(),attr=controlManager.getDescriptionAttributeByPropertyGetterName(type,propertyGetterName);if(attr)return attr;if("TcHmi.Controls.System.TcHmiUserControlHost"===type&&"getTargetUserControl"in control&&"function"==typeof control.getTargetUserControl){const targetUserControl=control.getTargetUserControl();if(targetUserControl){let ucConfigUrl=tchmi_path(targetUserControl.replace(".usercontrol",".usercontrol.json")),UCEntry=this.__usercontrolAttrDescrByGetterName.get(ucConfigUrl);if(UCEntry){let UCattr=UCEntry.get(propertyGetterName);if(UCattr)return UCattr}}}return null}getDescriptionAccessByName(type,name){let res=null,access=this.getDescriptionAccess(type);if(access)for(const acc of access)if(acc.name===name){res=acc;break}return res}}})();export{ControlManager};export const controlManager=new ControlManager;
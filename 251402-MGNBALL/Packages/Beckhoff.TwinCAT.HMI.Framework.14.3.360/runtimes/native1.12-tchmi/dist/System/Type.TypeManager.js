import*as TypeHelper from"./Type.Schema.Helper.js";import*as Server from"../API/Server.js";import{config}from"./System.js";export const SharedCacheRaw=new Map;export const SharedCacheResolved=new Map;let TypeManager=(()=>{var _a,_b;let ___onServerReady_decorators,___onServerNotReady_decorators,_instanceExtraInitializers=[];return class{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___onServerReady_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___onServerNotReady_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],__esDecorate(this,null,___onServerReady_decorators,{kind:"method",name:"__onServerReady",static:!1,private:!1,access:{has:obj=>"__onServerReady"in obj,get:obj=>obj.__onServerReady},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onServerNotReady_decorators,{kind:"method",name:"__onServerNotReady",static:!1,private:!1,access:{has:obj=>"__onServerNotReady"in obj,get:obj=>obj.__onServerNotReady},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){TcHmi.EventProvider.register("onServerReady",this.__onServerReady),TcHmi.EventProvider.register("onServerNotReady",this.__onServerNotReady)}__error=(__runInitializers(this,_instanceExtraInitializers),TcHmi.Errors.NONE);__active=!1;__commands=[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"GetDefinitions",writeValue:{resolve:"None",type:"general"}},{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"GetDefinitions",writeValue:{resolve:"None",type:"framework"}},{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"GetDefinitions",writeValue:{resolve:"None",type:"server"}},{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"GetDefinitions",writeValue:{resolve:"None",type:"project"}}];__hasCalledInitCallbackOnce=!1;__typesInitializing=new Set(["general","server","framework","project"]);__onServerReady(_event,_data){this.__hasCalledInitCallbackOnce&&this.__error!==TcHmi.Errors.NONE&&(this.__error=TcHmi.Errors.NONE,this.doWatchOrResolveSchemaDefinitions())}__onServerNotReady(_event,_data){this.__error=TcHmi.Errors.E_WEBSOCKET_NOT_READY}__cacheRawSchemaDefinitions(rv,source){void 0!==rv.definitions&&SharedCacheRaw.set(source,rv)}__processGetDefinitionsResponse(data){if(this.__error!==TcHmi.Errors.NONE)return{code:this.__error,message:TcHmi.Errors[this.__error],domain:"TcHmi.System.Type.TypeManager"};if(!data)return{code:TcHmi.Errors.ERROR,reason:"Failed to resolve types due to invalid response. Missing data.",domain:"TcHmi.System.Type.TypeManager"};if(data.error!==TcHmi.Errors.NONE)return data.details?data.details:{code:data.error};let response=data.response;if(!response)return{code:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_MISSING],reason:"Missing response from server.",domain:"TcHmi.System.Type.TypeManager"};if(response.error)return{code:TcHmi.Errors.E_SERVER_RESPONSE_ERROR,reason:"Error in response from server with id: "+response.id,domain:"TcHmi.System.Type.TypeManager",errors:[response.error]};let commands=response.commands;if(!commands)return{code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:"Missing commands in response from server with id: "+response.id,domain:"TcHmi.System.Type.TypeManager"};const bUpdateCase=!this.__typesInitializing.size;let errorDetails=[];for(const command of commands){if(!command)return{code:TcHmi.Errors.E_SERVER_COMMAND_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMAND_MISSING],reason:'Missing command for symbol: "GetDefinitions" in response from server with id: '+response.id,domain:"TcHmi.System.Type.TypeManager"};if(command.error)return{code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,reason:'Error in command for symbol: "GetDefinitions" in response from server with id: '+response.id,domain:"TcHmi.System.Type.TypeManager",errors:[command.error]};let wv=command.writeValue;if(!wv){errorDetails.push({code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,reason:"Failed to resolve type due to invalid response command for symbol="+command.symbol+". Missing writeValue property."});continue}if(!wv.type){errorDetails.push({code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,reason:"Failed to resolve type due to invalid response command for symbol="+command.symbol+". Missing type property in writeValue."});continue}let rv=command.readValue;rv?"project"===wv.type||Object.keys(rv).length?(this.__cacheRawSchemaDefinitions(rv,wv.type),this.__typesInitializing.delete(wv.type)):errorDetails.push({code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,reason:"Failed to resolve types for namespace="+wv.type+" due to invalid response command for symbol="+command.symbol+". Got no types which is an error."}):errorDetails.push({code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,reason:"Failed to resolve types for namespace="+wv.type+" due to invalid response command for symbol="+command.symbol+". Missing readValue property."})}if(this.__typesInitializing.size)return{code:TcHmi.Errors.ERROR,reason:"Failed to resolve type definitions for namespace="+Array.from(this.__typesInitializing).join(", "),domain:"TcHmi.System.Type.TypeManager",errors:errorDetails};if(bUpdateCase){const toResolve=Array.from(SharedCacheResolved.keys());SharedCacheResolved.clear();for(const typeId of toResolve){let res=this.getSchemaEx(typeId);if(res.error===TcHmi.Errors.NONE){TcHmi.EventProvider.raise("System.onTypeDefinitionChanged<"+typeId+">",{typeId,typeSchema:res.schema});let typeIdDecoded=decodeURI(typeId);typeIdDecoded!==typeId&&TcHmi.EventProvider.raise("System.onTypeDefinitionChanged<"+typeIdDecoded+">",{typeId:typeIdDecoded,typeSchema:res.schema}),TcHmi.EventProvider.raise("System.onTypeDefinitionChanged",{typeId,typeSchema:res.schema})}}}return{code:TcHmi.Errors.NONE}}doWatchOrResolveSchemaDefinitions(callback){if(this.__active)TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,reason:"Multiple calls to watch/read for type definition change detected.",domain:"TcHmi.System.Type.TypeManager"}});else if(Server.isReady())if(this.__active=!0,!TCHMI_ENGINEERING&&config.tcHmiServer.disableOptionalSystemSubscriptions)Server.requestEx({requestType:"ReadWrite",commands:this.__commands},{timeout:config.tcHmiServer.websocketSystemTimeout},data=>{this.__active=!1;let error=this.__processGetDefinitionsResponse(data);this.__hasCalledInitCallbackOnce||(TcHmi.Callback.callSafeEx(callback,this,{error:error.code,details:error}),this.__hasCalledInitCallbackOnce=!0)});else{let interval=5e3;TCHMI_ENGINEERING&&(interval=1e3),Server.subscribeEx(this.__commands,interval,{timeout:config.tcHmiServer.websocketSystemTimeout},data=>{let error=this.__processGetDefinitionsResponse(data);this.__hasCalledInitCallbackOnce||(TcHmi.Callback.callSafeEx(callback,this,{error:error.code,details:error}),this.__hasCalledInitCallbackOnce=!0)})}else TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_WEBSOCKET_NOT_READY,details:{code:TcHmi.Errors.E_WEBSOCKET_NOT_READY,reason:"Server connection not ready.",domain:"TcHmi.System.Type.TypeManager"}})}doForceSchemaDefinitions(callback){Server.requestEx({requestType:"ReadWrite",commands:this.__commands},{timeout:config.tcHmiServer.websocketSystemTimeout},data=>{let error=this.__processGetDefinitionsResponse(data);TcHmi.Callback.callSafeEx(callback,this,{error:error.code,details:error})})}getSchema(id){let res=this.getSchemaEx(id);return res.error===TcHmi.Errors.NONE&&res.schema?res.schema:null}getSchemaEx(id){let res;try{res=TypeHelper.__resolveRawSchemaDefinition(id,null,new Map)}catch(e){res={error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:"An uncaught exception occurred in the resolving datatype schema",exception:e,domain:"TcHmi.System.Type.TypeManager"}}}return res}}})();export{TypeManager};export const typeManager=new TypeManager;
import{Symbol as SystemSymbol}from"./Symbol.js";import{SymbolExpression}from"../API/SymbolExpression.js";import{packageSymbolManager}from"./PackageSymbolManager.js";export class SymbolTypePackage{constructor(symbol){this.__symbol=symbol,this.__symbolExpressionString=this.__symbol.getExpression().toString(),this.__symbolDiagGUID=this.__symbol.getDiagGUID();const symbolName=this.__symbol.getExpression().getName();symbolName&&(this.__destroyOnAddListener=TcHmi.EventProvider.register(`TcHmi.PackageSymbolManager<${symbolName}>.onAdd`,this.__onMappingChanged.bind(this)),this.__destroyOnRemoveListener=TcHmi.EventProvider.register(`TcHmi.PackageSymbolManager<${symbolName}>.onRemove`,this.__onMappingChanged.bind(this)),this.__destroyOnUpdateListener=TcHmi.EventProvider.register(`TcHmi.PackageSymbolManager<${symbolName}>.onUpdate`,this.__onMappingChanged.bind(this)))}__symbol;__symbolExpressionString;__symbolDiagGUID;__mappingSymbol=null;__activeOperationDestroyers=new Set;__destroyOnAddListener=null;__destroyOnRemoveListener=null;__destroyOnUpdateListener=null;__onMappingChanged(e){this.__cleanupMappingSymbol()}__cleanupActiveOperations(){for(const destroyer of this.__activeOperationDestroyers)destroyer?.();this.__activeOperationDestroyers.clear()}__cleanupMappingSymbol(){this.__cleanupActiveOperations(),this.__mappingSymbol&&(this.__mappingSymbol.destroy(),this.__mappingSymbol=null)}__getOrCreateMappingSymbol(mappingSymbolExpression){const newExpressionString=mappingSymbolExpression.toString();if(this.__mappingSymbol){if(this.__mappingSymbol.getExpression().toString()===newExpressionString)return this.__mappingSymbol;this.__mappingSymbol.destroy()}return this.__mappingSymbol=new SystemSymbol(mappingSymbolExpression),this.__mappingSymbol}static ResolveMappingSymbolExpression(expression,mappingExpression){let resolvedMappingExpressionString=`%${mappingExpression.getTag()}%${mappingExpression.getName()??""}${mappingExpression.getPath()??""}${expression.getPath()??""}${mappingExpression.getOptionsString()??""}${expression.getOptionsString()??""}%/${mappingExpression.getTag()}%`;return new SymbolExpression(resolvedMappingExpressionString)}destroy(){this.__symbol=null,this.__destroyOnAddListener?.(),this.__destroyOnRemoveListener?.(),this.__destroyOnUpdateListener?.(),this.__cleanupMappingSymbol()}read(expression,options,callback){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePackage"}}),()=>{};let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid());const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{}}),()=>{};const mapping=packageSymbolManager.get(name);if(!mapping)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): No mapping was found.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{}}),()=>{};if(!mapping.symbol)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__symbol.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Mapping symbol is not defined.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression}),()=>{};if(!TcHmi.Symbol.isSymbolExpression(mapping.symbol))return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__symbol.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Mapping symbol is not a valid symbol expression.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression}),()=>{};let destroyRead;try{let mappingSymbolExpression=new TcHmi.SymbolExpression(mapping.symbol),mappingSymbolExpressionPrepared=SymbolTypePackage.ResolveMappingSymbolExpression(expression,mappingSymbolExpression);const mappingSymbol=this.__getOrCreateMappingSymbol(mappingSymbolExpressionPrepared);destroyRead=mappingSymbol.readEx(options,data=>{this.__symbol?TcHmi.Callback.callSafeEx(callback,this.__symbol,{...data,expression:this.__symbol.getExpression(),expressionResolved:expression}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePackage"}})}),destroyRead&&this.__activeOperationDestroyers.add(destroyRead)}catch(e){TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__symbol.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): An exception occured while trying to parse the mapping symbol '"+mapping.symbol+"'.",exception:e,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression})}return()=>{destroyRead&&(destroyRead(),this.__activeOperationDestroyers.delete(destroyRead))}}write(expression,value,options,dirtyPaths,callback){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePackage"}}),()=>{};let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid());const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{}}),()=>{};const mapping=packageSymbolManager.get(name);if(!mapping)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): No mapping was found.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{}}),()=>{};if(!mapping.symbol)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__symbol.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Mapping symbol is not defined.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression}),()=>{};if(!TcHmi.Symbol.isSymbolExpression(mapping.symbol))return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__symbol.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Mapping symbol is not a valid symbol expression.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression}),()=>{};let destroyWrite;try{let mappingSymbolExpression=new TcHmi.SymbolExpression(mapping.symbol),mappingSymbolExpressionPrepared=SymbolTypePackage.ResolveMappingSymbolExpression(expression,mappingSymbolExpression);const mappingSymbol=this.__getOrCreateMappingSymbol(mappingSymbolExpressionPrepared);destroyWrite=mappingSymbol.writeEx2(value,options,dirtyPaths,data=>{this.__symbol?TcHmi.Callback.callSafeEx(callback,this.__symbol,{...data,expression:this.__symbol.getExpression(),expressionResolved:expression}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePackage"}})}),destroyWrite&&this.__activeOperationDestroyers.add(destroyWrite)}catch(e){TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__symbol.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): An exception occured while trying to parse the mapping symbol '"+mapping.symbol+"'.",exception:e,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression})}return()=>{destroyWrite&&(destroyWrite(),this.__activeOperationDestroyers.delete(destroyWrite))}}watch(expression,options,callback){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePackage"}}),()=>{};let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid());const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{}}),()=>{};let destroyWatch,isDestroyed=!1;const setupMappingWatch=()=>{if(isDestroyed||!this.__symbol)return;const mapping=packageSymbolManager.get(name);if(mapping)if(mapping.symbol)if(TcHmi.Symbol.isSymbolExpression(mapping.symbol))try{let mappingSymbolExpression=new TcHmi.SymbolExpression(mapping.symbol),mappingSymbolExpressionPrepared=SymbolTypePackage.ResolveMappingSymbolExpression(expression,mappingSymbolExpression);const mappingSymbol=this.__getOrCreateMappingSymbol(mappingSymbolExpressionPrepared);destroyWatch&&(destroyWatch(),this.__activeOperationDestroyers.delete(destroyWatch)),destroyWatch=mappingSymbol.watchEx(options,data=>{this.__symbol&&!isDestroyed?TcHmi.Callback.callSafeEx(callback,this.__symbol,{...data,expression:this.__symbol.getExpression(),expressionResolved:expression}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePackage"}})}),destroyWatch&&this.__activeOperationDestroyers.add(destroyWatch)}catch(e){TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__symbol.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): An exception occured while trying to parse the mapping symbol '"+mapping.symbol+"'.",exception:e,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__symbol.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Mapping symbol is not a valid symbol expression.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{}});else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__symbol.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Mapping symbol is not defined.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{}});else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__symbolExpressionString+" (Resolved to: '"+expression.toString()+"'): No mapping was found.",domain:"TcHmi.System.SymbolTypePackage"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{}})};setupMappingWatch();let refreshMapping=()=>{!isDestroyed&&this.__symbol&&(destroyWatch&&(destroyWatch(),this.__activeOperationDestroyers.delete(destroyWatch)),setupMappingWatch())};const destroyAddMappingListener=TcHmi.EventProvider.register(`TcHmi.PackageSymbolManager<${name}>.onAdd`,e=>{refreshMapping()}),destroyRemoveMappingListener=TcHmi.EventProvider.register(`TcHmi.PackageSymbolManager<${name}>.onRemove`,e=>{refreshMapping()}),destroyUpdateMappingListener=TcHmi.EventProvider.register(`TcHmi.PackageSymbolManager<${name}>.onUpdate`,e=>{refreshMapping()});return()=>{isDestroyed=!0,destroyAddMappingListener?.(),destroyRemoveMappingListener?.(),destroyUpdateMappingListener?.(),destroyWatch&&(destroyWatch(),this.__activeOperationDestroyers.delete(destroyWatch))}}}
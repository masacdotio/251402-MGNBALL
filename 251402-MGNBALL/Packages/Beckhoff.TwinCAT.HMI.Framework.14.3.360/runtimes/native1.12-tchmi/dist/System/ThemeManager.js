import{controlManager}from"./ControlManager.js";import{config,Data,isInitialized,mapControlNamesFromPackageManifestApi0ToApi1,mapControlNamesFromPackageManifestApi1ToApi0}from"./System.js";import{resolveQualifiedName}from"./SystemFunctions.js";import*as ValueConverter from"../API/ValueConverter.js";import*as ErrorPane from"../API/Engineering.ErrorPane.js";import{Log}from"../API/Log.js";import{getSchema}from"../API/Type.js";import{resolveDefault}from"../API/Type.Schema.js";let ThemeManager=(()=>{var _a,_b,_c;let _retriggerUserControls_decorators,___onControlDestroyed_decorators,___onControlClassNamesChanged_decorators,_instanceExtraInitializers=[];return class{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;_retriggerUserControls_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___onControlDestroyed_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___onControlClassNamesChanged_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],__esDecorate(this,null,_retriggerUserControls_decorators,{kind:"method",name:"retriggerUserControls",static:!1,private:!1,access:{has:obj=>"retriggerUserControls"in obj,get:obj=>obj.retriggerUserControls},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onControlDestroyed_decorators,{kind:"method",name:"__onControlDestroyed",static:!1,private:!1,access:{has:obj=>"__onControlDestroyed"in obj,get:obj=>obj.__onControlDestroyed},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onControlClassNamesChanged_decorators,{kind:"method",name:"__onControlClassNamesChanged",static:!1,private:!1,access:{has:obj=>"__onControlClassNamesChanged"in obj,get:obj=>obj.__onControlClassNamesChanged},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){TcHmi.EventProvider.register("System.onControlDestroyed",this.__onControlDestroyed),TcHmi.EventProvider.register("System.onControlClassNamesChanged",this.__onControlClassNamesChanged),TcHmi.EventProvider.register("System.onUserControlConfigCreated",this.retriggerUserControls),TcHmi.EventProvider.register("System.onUserControlConfigChanged",this.retriggerUserControls),TcHmi.EventProvider.register("System.onUserControlConfigRemoved",this.retriggerUserControls);const fontFaceSet=document.fonts;fontFaceSet?.addEventListener&&fontFaceSet.addEventListener("loadingdone",evt=>{Log.debugEx("[Source=Framework, Module=TcHmi.System.ThemeManager] System has loaded another font file. Triggering an %o event.","onThemeDataChanged"),TcHmi.EventProvider.raise("onThemeDataChanged")});const updatePixelRatio=(init,evt)=>{window.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`).addEventListener("change",updatePixelRatio.bind(null,!1),{once:!0}),init||(Log.debugEx("[Source=Framework, Module=TcHmi.System.ThemeManager] dpi of the window has changed. Triggering an %o event.","onThemeDataChanged"),TcHmi.EventProvider.raise("onThemeDataChanged"))};updatePixelRatio(!0)}__activeTheme=(__runInitializers(this,_instanceExtraInitializers),"Base");__registered_themedValueFiles_fromControl=new Map;__registered_styleCheets_fromControl=new Map;__control_themeFiles=new Map;__project_themeFiles=new Map;__clearProjectThemeUrl(cleanPath){if(cleanPath.endsWith(".theme"))this.__control_themeFiles.clear(),this.__project_themeFiles.clear();else if(cleanPath.endsWith(".css")){let currentLinkElem=document.head.querySelector('link[href="'+cleanPath+'"]');currentLinkElem&&(currentLinkElem.href="")}}getTheme(){return this.__activeTheme}setTheme(valueNew,processTheme){return"string"!=typeof valueNew||""===valueNew?TcHmi.Errors.E_PARAMETER_INVALID:(tchmi_equal(this.__activeTheme,valueNew)||(this.__activeTheme=valueNew,processTheme&&this.processActiveTheme()),TcHmi.Errors.NONE)}registerControlThemeFiles(controlDescr){let ctrlType=resolveQualifiedName(controlDescr.name,controlDescr.namespace),themeFiles=controlDescr.themes;if(themeFiles)for(const[themeName,themeEntry]of Object.entries(themeFiles))for(const themeFile of themeEntry.resources)if(themeFile.name){if("ThemedValues"===themeFile.type){let currentThemeEntry=this.__registered_themedValueFiles_fromControl.get(themeName);currentThemeEntry||(currentThemeEntry=new Map,this.__registered_themedValueFiles_fromControl.set(themeName,currentThemeEntry));let currentCtrlTypeEntry=currentThemeEntry.get(ctrlType);currentCtrlTypeEntry||(currentCtrlTypeEntry=[],currentThemeEntry.set(ctrlType,currentCtrlTypeEntry)),currentCtrlTypeEntry.push(themeFile)}else if("Stylesheet"===themeFile.type){let currentThemeEntry=this.__registered_styleCheets_fromControl.get(themeName);currentThemeEntry||(currentThemeEntry=new Map,this.__registered_styleCheets_fromControl.set(themeName,currentThemeEntry));let currentCtrlTypeEntry=currentThemeEntry.get(ctrlType);currentCtrlTypeEntry||(currentCtrlTypeEntry=[],currentThemeEntry.set(ctrlType,currentCtrlTypeEntry)),currentCtrlTypeEntry.push(themeFile)}}else Log.warnEx("[Source=Framework, Module=TcHmi.System.ThemeManager] No file path found for theme entry (%o) and control (%o) in Description.json:",themeName,ctrlType)}__resolveControlInheritance(){const resolve=(hierarchyEntry,parent)=>{if(!hierarchyEntry)return;const normalizeThemeFileForCurrrentControl=descr=>{descr.controlTypeValues??={},descr.controlTypeValues[hierarchyEntry.controlType]??={},descr.controlTypeValues[hierarchyEntry.controlType].attributes??={},descr.controlTypeValues[hierarchyEntry.controlType].themedResources??={}};this.__project_themeFiles.forEach(descr=>{if(descr&&(normalizeThemeFileForCurrrentControl(descr),parent)){const parentAttrValue=descr.controlTypeValues[parent.controlType],controlAttrValue=descr.controlTypeValues[hierarchyEntry.controlType];for(const parentAttrName of Object.keys(parentAttrValue.attributes))void 0===controlAttrValue.attributes[parentAttrName]&&(controlAttrValue.attributes[parentAttrName]=parentAttrValue.attributes[parentAttrName]);for(const parentResourceName of Object.keys(parentAttrValue.themedResources))void 0===controlAttrValue.themedResources[parentResourceName]&&(controlAttrValue.themedResources[parentResourceName]=parentAttrValue.themedResources[parentResourceName])}}),this.__control_themeFiles.forEach(controlTypeMap=>{controlTypeMap.forEach((descr,_controlName)=>{descr&&normalizeThemeFileForCurrrentControl(descr)});let descr=controlTypeMap.get(hierarchyEntry.controlType);if(descr||(descr={controlTypeValues:{}},descr.controlTypeValues[hierarchyEntry.controlType]={attributes:{},themedResources:{}},controlTypeMap.set(hierarchyEntry.controlType,descr)),parent&&controlTypeMap.has(parent.controlType)){const parentAttrValue=controlTypeMap.get(parent.controlType).controlTypeValues[parent.controlType],controlAttrValue=descr.controlTypeValues[hierarchyEntry.controlType];for(const parentAttrName of Object.keys(parentAttrValue.attributes))void 0===controlAttrValue.attributes[parentAttrName]&&(controlAttrValue.attributes[parentAttrName]=parentAttrValue.attributes[parentAttrName]);for(const parentResourceName of Object.keys(parentAttrValue.themedResources))void 0===controlAttrValue.themedResources[parentResourceName]&&(controlAttrValue.themedResources[parentResourceName]=parentAttrValue.themedResources[parentResourceName])}});for(let child of hierarchyEntry.children)resolve(child,hierarchyEntry)};resolve(controlManager.getInheritanceTree(),void 0)}__asyncLoadCount=0;__asyncJsonLoadCount=0;processActiveTheme(callback){const activeThemePjctCfg=config?.themes[this.__activeTheme];let jsonValueChanged=!1,asyncLoadingHandler=(evt,jsondataFetch=!1)=>{evt.target?.removeEventListener("error",asyncLoadingHandler),this.__asyncLoadCount--,jsondataFetch&&this.__asyncJsonLoadCount--,jsondataFetch&&this.__asyncJsonLoadCount<=0&&(this.__resolveControlInheritance(),jsonValueChanged&&(this.__triggerControlsWithImplicitValues(null),this.processThemedResources()),TcHmi.EventProvider.raise("System.onThemeJsonDataChanged")),this.__asyncLoadCount<=0&&(Log.debugEx("[Source=Framework, Module=TcHmi.System.ThemeManager] System has loaded and parsed all async files. Triggering a control resize check and event %o.","onThemeDataChanged"),controlManager.checkControlGeometry({checkReason:"TcHmiEvent: onThemeDataChanged"}),TcHmi.EventProvider.raise("onThemeDataChanged"),TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE}))};ErrorPane.remove("ThemeManager_multipleThemes");let foundProjectThemedValue="";for(const projectFile of activeThemePjctCfg?.resources??[]){if("Stylesheet"===projectFile.type)continue;if("ThemedValues"!==projectFile.type){Log.errorEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Type value of entry invalid in tchmiconfig.json (has to be ThemedValues or Stylesheet). %o",projectFile);continue}if(!projectFile.name){Log.errorEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Entry missing name property in tchmiconfig.json. %o",projectFile);continue}if(foundProjectThemedValue){ErrorPane.add("ThemeManager_multipleThemes","Only one ThemedValues entry per theme ("+this.__activeTheme+") allowed in tchmiconfig.json. Only "+foundProjectThemedValue+" will be used.",ErrorPane.MessageType.Error);break}foundProjectThemedValue=projectFile.name;let currentProjTheme=this.__project_themeFiles.get(this.__activeTheme);if(null===currentProjTheme)continue;if(void 0!==currentProjTheme){jsonValueChanged=!0;continue}this.__project_themeFiles.set(this.__activeTheme,null);const themeName=this.__activeTheme,fileName=projectFile.name;let xhr=new XMLHttpRequest;xhr.addEventListener("load",evt=>{if(200!==xhr.status)this.__project_themeFiles.delete(themeName),Log.warnEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Loading %o failed. Details: HTTP error %o",fileName,xhr.status+" "+xhr.statusText);else{const descr=ValueConverter.toObject(xhr.responseText,null);if(null!==descr){if(descr.controlTypeValues){let temp={};for(let key in descr.controlTypeValues){let newControlType=mapControlNamesFromPackageManifestApi0ToApi1.get(key);newControlType&&(temp[newControlType]=descr.controlTypeValues[key])}for(let key in temp)descr.controlTypeValues[key]=temp[key]}this.__project_themeFiles.set(themeName,descr),jsonValueChanged=!0,Log.debugEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Fetched and parsed: %o",fileName)}else this.__project_themeFiles.delete(themeName),Log.warnEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Failed to parse %o. Details: %o",fileName,xhr.responseText)}asyncLoadingHandler(evt,!0)});const errorHandler=evt=>{this.__project_themeFiles.delete(themeName),0===xhr.status||Log.warnEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Failed to load %o",fileName),asyncLoadingHandler(evt,!0)};xhr.addEventListener("error",errorHandler),xhr.addEventListener("abort",errorHandler),xhr.addEventListener("timeout",errorHandler),xhr.open("GET",tchmi_encode_uri_components(tchmi_path(fileName))),xhr.send(),this.__asyncLoadCount++,this.__asyncJsonLoadCount++,Log.debugEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Fetching %o async.",fileName)}let themeAndBase=[this.__activeTheme];"Base"!==this.__activeTheme&&themeAndBase.push("Base");for(const[controlThemedValueThemeName,controlTypeMap]of this.__registered_themedValueFiles_fromControl)if(themeAndBase.includes(controlThemedValueThemeName))for(const[ctrlType,registeredList]of controlTypeMap){let module=Data.Modules.controls.map.get(ctrlType);if(!module){Log.errorEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Missing package control module for type: %o",ctrlType);continue}if(module&&module.error!==TcHmi.Errors.NONE){Log.errorEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Can't load package control module for type: %o. Error: %o",ctrlType,Log.buildMessage(module.errorDetails));continue}let foundControlThemedValue=!1;for(const registered of registeredList){let currentControlThemeFiles=this.__control_themeFiles.get(controlThemedValueThemeName);if(currentControlThemeFiles||(currentControlThemeFiles=new Map,this.__control_themeFiles.set(controlThemedValueThemeName,currentControlThemeFiles)),foundControlThemedValue){Log.errorEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Only one ThemedValues entry per theme (%o) and control (%o) allowed in Description.json. %o",controlThemedValueThemeName,ctrlType,this.__registered_themedValueFiles_fromControl.get(controlThemedValueThemeName).get(ctrlType));break}foundControlThemedValue=!0;let currentControlThemeFile=currentControlThemeFiles.get(ctrlType);if(null===currentControlThemeFile)continue;if(void 0!==currentControlThemeFile){jsonValueChanged=!0;continue}currentControlThemeFiles.set(ctrlType,null);const themeName=controlThemedValueThemeName;let module=Data.Modules.controls.map.get(ctrlType);if(!module){Log.errorEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Missing package control module for type: %o",ctrlType);continue}if(module&&module.error!==TcHmi.Errors.NONE){Log.errorEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Can't load package control module for type: %o. Error: %o",ctrlType,Log.buildMessage(module.errorDetails));continue}let fileName=registered.name,fileNameFull=void 0!==module.package?.basePath&&void 0!==module.manifestData?.basePath&&fileName?tchmi_path(module.package.basePath+"/"+module.manifestData.basePath+"/"+fileName):"";if(!fileNameFull)continue;let xhr=new XMLHttpRequest;xhr.addEventListener("load",evt=>{if(200!==xhr.status)this.__control_themeFiles.get(themeName).delete(ctrlType),Log.warnEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Loading %o failed. Details: HTTP error %o",fileNameFull,xhr.status+" "+xhr.statusText);else{const descr=ValueConverter.toObject(xhr.responseText);if(null!==descr){if(descr.controlTypeValues){let temp={};for(let key in descr.controlTypeValues){let newControlType=mapControlNamesFromPackageManifestApi0ToApi1.get(key);newControlType&&(temp[newControlType]=descr.controlTypeValues[key])}for(let key in temp)descr.controlTypeValues[key]=temp[key]}this.__control_themeFiles.get(themeName).set(ctrlType,descr),jsonValueChanged=!0,Log.debugEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Fetched and parsed: %o",fileNameFull)}else this.__control_themeFiles.get(themeName).delete(ctrlType),Log.warnEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Failed to parse %o. Details: %o",fileNameFull,xhr.responseText)}asyncLoadingHandler(evt,!0)});const errorHandler=evt=>{this.__control_themeFiles.get(themeName).delete(ctrlType),0===xhr.status||Log.warnEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Failed to load %o",fileNameFull),asyncLoadingHandler(evt,!0)};xhr.addEventListener("error",errorHandler),xhr.addEventListener("abort",errorHandler),xhr.addEventListener("timeout",errorHandler),xhr.open("GET",tchmi_encode_uri_components(fileNameFull)),xhr.send(),this.__asyncLoadCount++,this.__asyncJsonLoadCount++,Log.debugEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Fetching %o async.",fileNameFull)}}let allCssStyles={package:[],projectGlobal:[],projectTheme:[]};if(config.packages.length>0){let processedPackageNames=new Set,sortedQueue=new Set,packagesQueue=new Set,sortDependency=packageInfo=>{let packageObj=Data.packages.get(packageInfo.name);if(packageObj){let preconditionFullfilled=!0;for(const moduleData of packageObj.manifest.modules)if("Package"===moduleData.type)if(Data.packages.has(moduleData.nugetId)){if(!processedPackageNames.has(moduleData.nugetId)){preconditionFullfilled=!1;break}}else;return preconditionFullfilled?(sortedQueue.has(packageObj)||(sortedQueue.add(packageObj),processedPackageNames.add(packageInfo.name)),void packagesQueue.delete(packageObj)):void packagesQueue.add(packageObj)}};config.packages.forEach(sortDependency);let maxSortCount=config.packages.length**2;for(;packagesQueue.size;){if(maxSortCount<0){Log.errorEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Recursion or unsatisfied dependency found in referenced Packages from %o","Properties/tchmiconfig.json");break}packagesQueue.forEach(sortDependency),maxSortCount--}let packageParser=packageInfo=>{let packageObj=Data.packages.get(packageInfo.name);if(packageObj){let themeToLoadForPackage="Base";packageObj.manifest.modules.some(module=>"Resource"===module.type&&module.theme===this.__activeTheme)&&(themeToLoadForPackage=this.__activeTheme);for(const moduleData of packageObj.manifest.modules)switch(moduleData.type){case"Package":break;case"Resource":moduleData.path?.endsWith(".css")&&(moduleData.theme?themeToLoadForPackage!==moduleData.theme||activeThemePjctCfg?.replacesThemeForPackageComponents?.includes(packageInfo.name+(moduleData.component?"/"+moduleData.component:""))||allCssStyles.package.push({theme:moduleData.theme,url:tchmi_path(packageInfo.basePath+"/"+moduleData.path)}):allCssStyles.package.push({theme:null,url:tchmi_path(packageInfo.basePath+"/"+moduleData.path)}));break;case"Control":const cleanPath=tchmi_path(packageInfo.basePath+"/"+moduleData.basePath+"/"+moduleData.descriptionFile);let module=Data.Modules.controls.urlMap.get(cleanPath);if(!module?.descriptionExpanded){module?.error!==TcHmi.Errors.E_CONTROL_INVALID_CONFIGURATION&&isInitialized&&Log.errorEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Internal Error: Did not find entry %o in url cache.",cleanPath);break}if(module.descriptionExpanded.dependencyFiles&&module.package&&module.manifestData?.basePath)for(let dependencyFile of module.descriptionExpanded.dependencyFiles)"Stylesheet"===dependencyFile.type&&allCssStyles.package.push({theme:null,url:tchmi_path(module.package.basePath+"/"+module.manifestData.basePath+"/"+dependencyFile.name)});let controlType=resolveQualifiedName(module.descriptionExpanded.name,module.descriptionExpanded.namespace);if(activeThemePjctCfg?.replacesThemeForControls?.includes(controlType))break;const legacyControlType=mapControlNamesFromPackageManifestApi1ToApi0.get(controlType);if(legacyControlType&&activeThemePjctCfg?.replacesThemeForControls?.includes(legacyControlType))break;let controlCssList=[],controlCssThemeName=this.__activeTheme,currentThemeEntry=this.__registered_styleCheets_fromControl.get(this.__activeTheme),currentCtrlTypeEntry=currentThemeEntry?.get(controlType);if(currentCtrlTypeEntry)controlCssList=currentCtrlTypeEntry;else{if(!this.__registered_styleCheets_fromControl.get("Base")?.has(controlType))break;controlCssList=this.__registered_styleCheets_fromControl.get("Base").get(controlType),controlCssThemeName="Base"}if(module.package&&module.manifestData)for(let controlThemeEntry of controlCssList)allCssStyles.package.push({theme:controlCssThemeName,url:tchmi_path(module.package.basePath+"/"+module.manifestData.basePath+"/"+controlThemeEntry.name)})}}};sortedQueue.forEach(packageParser)}if(config.dependencyFiles)for(const unthemeProjectFile of config.dependencyFiles)"Stylesheet"===unthemeProjectFile.type&&allCssStyles.projectGlobal.push({theme:null,url:unthemeProjectFile.name});for(const projectFile of activeThemePjctCfg?.resources??[])"Stylesheet"===projectFile.type&&(projectFile.name?allCssStyles.projectTheme.push({theme:this.__activeTheme,url:projectFile.name}):Log.errorEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Entry missing name property in tchmiconfig.json. %o",projectFile));let linkInserter=(cssStyles,origin)=>{cssStyles.length||cssStyles.push({url:"",theme:null});for(let currentIndex=0;currentIndex<cssStyles.length;currentIndex++){let currentStyle=cssStyles[currentIndex],cleanPath=tchmi_path(currentStyle.url),currentOriginStyles=document.head.querySelectorAll("link[data-tchmi-file-origin="+origin+"]");const currentLinkElem=currentOriginStyles[currentIndex],makeNewElem=()=>{const newLinkElem=document.createElement("link");return newLinkElem.rel="stylesheet",newLinkElem.type="text/css",newLinkElem.href=cleanPath,cleanPath?(newLinkElem.addEventListener("load",asyncLoadingHandler,{once:!0}),newLinkElem.addEventListener("error",asyncLoadingHandler),this.__asyncLoadCount++):newLinkElem.dataset.tchmiReason="internal marker",newLinkElem.dataset.tchmiFileOrigin=origin,currentStyle.theme&&(newLinkElem.dataset.tchmiFromTheme=currentStyle.theme),newLinkElem};if(currentLinkElem){if(currentLinkElem.getAttribute("href")!==cleanPath||(currentLinkElem.dataset.tchmiFromTheme??null)!==currentStyle.theme){const newLinkElem=makeNewElem();currentLinkElem.replaceWith(newLinkElem),Log.debugEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Replaced CSS style node for: %o"+currentStyle.url)}}else{const newLinkElem=makeNewElem();let lastElementSameOrigin=currentOriginStyles.length?currentOriginStyles[currentOriginStyles.length-1]:void 0;lastElementSameOrigin?lastElementSameOrigin.after(newLinkElem,"\n"):document.head.append(newLinkElem,"\n"),Log.debugEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Added CSS style node for: %o",currentStyle.url)}}let currentOriginStyles=document.head.querySelectorAll("link[data-tchmi-file-origin="+origin+"]");for(let removeCounter=cssStyles.length;removeCounter<currentOriginStyles.length;removeCounter++)currentOriginStyles[removeCounter].remove()};if(linkInserter(allCssStyles.package,"package"),linkInserter(allCssStyles.projectGlobal,"projectGlobal"),linkInserter(allCssStyles.projectTheme,"projectTheme"),TCHMI_DESIGNER){document.documentElement.setAttribute("tchmi-theme-name",this.__activeTheme);let linkElem=document.querySelector('link[href*="StyleEngineering.css"]');linkElem||(linkElem=document.createElement("link"),linkElem.rel="stylesheet",linkElem.type="text/css",linkElem.href=tchmi_path(config.basePath+"/System/Engineering/StyleEngineering.css")),document.head.appendChild(linkElem)}this.__asyncJsonLoadCount<=0&&(this.__resolveControlInheritance(),jsonValueChanged&&(this.__triggerControlsWithImplicitValues(null),TcHmi.EventProvider.raise("System.onThemeJsonDataChanged")),this.processThemedResources()),this.__asyncLoadCount<=0&&(Log.debugEx("[Source=Framework, Module=TcHmi.System.ThemeManager] System has loaded and found only sync files. Triggering an %o event.","onThemeDataChanged"),TcHmi.EventProvider.raise("onThemeDataChanged"),TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE}))}__triggerControlsWithImplicitValues(controlsToTrigger){let ThemeManager_triggerSingleControl=(attributeList,control)=>{for(const propertyName of attributeList){this.__settingThemeValueInProgress=propertyName;let error=controlManager.setControlProperty(control,propertyName,null);this.__settingThemeValueInProgress=null,error&&error.code!==TcHmi.Errors.NONE&&Log.error("[Source=Framework, Module=TcHmi.System.ThemeManager] "+Log.buildMessage(error))}};if(null===controlsToTrigger)for(const[control,attributeList]of this.__watchAttributeDefaults.entries())ThemeManager_triggerSingleControl(attributeList,control);else for(let controlToTrigger of controlsToTrigger){const attributeList=this.__watchAttributeDefaults.get(controlToTrigger);attributeList&&ThemeManager_triggerSingleControl(attributeList,controlToTrigger)}}retriggerUserControls(){let controlsToTrigger=[];controlManager.getControlsCache().forEach((control,controlName)=>{"TcHmi.Controls.System.TcHmiUserControlHost"===control.getType()&&controlsToTrigger.push(control)}),this.__triggerControlsWithImplicitValues(controlsToTrigger)}getDefaultPropertyValue(control,propertyName){const activeThemePjctCfg=config?.themes[this.__activeTheme];let res=null,currentProjectThemeFiles=this.__project_themeFiles.get(this.__activeTheme);const controlClasses=control.getClassNames()??[];for(let controlClass of controlClasses)currentProjectThemeFiles?.controlClassValues?.[controlClass]?.attributes&&void 0!==currentProjectThemeFiles.controlClassValues[controlClass].attributes[propertyName]&&null!==currentProjectThemeFiles.controlClassValues[controlClass].attributes[propertyName]&&(res=currentProjectThemeFiles.controlClassValues[controlClass].attributes[propertyName]);if(null!==res)return{error:TcHmi.Errors.NONE,origin:"project",originThemeName:this.__activeTheme,value:tchmi_clone_object(res)};const controlType=control.getType(),projectBasedThemeValue=currentProjectThemeFiles?.controlTypeValues?.[controlType]?.attributes?.[propertyName];if(null!=projectBasedThemeValue)return res=projectBasedThemeValue,{error:TcHmi.Errors.NONE,origin:"project",originThemeName:this.__activeTheme,value:tchmi_clone_object(res)};const legacyControlType=mapControlNamesFromPackageManifestApi1ToApi0.get(controlType);if(activeThemePjctCfg?.replacesThemeForControls?.includes(controlType));else if(legacyControlType&&activeThemePjctCfg?.replacesThemeForControls?.includes(legacyControlType));else{const ctrlDescription=controlManager.getDescription(controlType);let supportedTheme="Base";Object.keys(ctrlDescription?.themes??{}).some(themeName=>themeName===this.__activeTheme)&&(supportedTheme=this.__activeTheme);let currentControlThemeFiles=this.__control_themeFiles.get(supportedTheme),currentControlThemeFile=currentControlThemeFiles?.get(controlType);if(currentControlThemeFile?.controlTypeValues?.[controlType]?.attributes&&void 0!==currentControlThemeFile.controlTypeValues[controlType].attributes[propertyName]&&null!==currentControlThemeFile.controlTypeValues[controlType].attributes[propertyName])return res=currentControlThemeFile.controlTypeValues[controlType].attributes[propertyName],{error:TcHmi.Errors.NONE,origin:"control",originThemeName:supportedTheme,value:tchmi_clone_object(res)}}let ctrlDescrAttr=controlManager.getDescriptionAttributeByPropertyName(controlType,propertyName);if(ctrlDescrAttr){if(void 0!==ctrlDescrAttr.defaultValueInternal)return res=ctrlDescrAttr.defaultValueInternal,{error:TcHmi.Errors.NONE,origin:"control",originThemeName:this.__activeTheme,value:tchmi_clone_object(res)};let schema=getSchema(ctrlDescrAttr.type);if(schema)return res=resolveDefault(schema),{error:TcHmi.Errors.NONE,origin:"control",originThemeName:this.__activeTheme,value:res}}if("TcHmi.Controls.System.TcHmiUserControlHost"===controlType&&"getTargetUserControl"in control&&"function"==typeof control.getTargetUserControl){const targetUserControl=control.getTargetUserControl();if(targetUserControl){let ucConfigUrl=tchmi_path(targetUserControl.replace(".usercontrol",".usercontrol.json")),UCdescrAttr=controlManager.getUserControlConfigAttributeByPropertyName(ucConfigUrl,propertyName);if(void 0!==UCdescrAttr?.defaultValueInternal)return res=UCdescrAttr.defaultValueInternal,{error:TcHmi.Errors.NONE,origin:"control",originThemeName:this.__activeTheme,value:tchmi_clone_object(res)};if(UCdescrAttr){let type=UCdescrAttr.type;if(type){let schema=getSchema(type);if(schema)return res=resolveDefault(schema),{error:TcHmi.Errors.NONE,origin:"control",originThemeName:this.__activeTheme,value:res}}}}}return{error:TcHmi.Errors.NONE,origin:"control",originThemeName:this.__activeTheme,value:null}}getThemeResource(control,resourceName){let res=null,currentProjectThemeFiles=this.__project_themeFiles.get(this.__activeTheme);const controlClasses=control.getClassNames();if(controlClasses&&controlClasses.length>0){for(let controlClass of controlClasses)currentProjectThemeFiles?.controlClassValues?.[controlClass]?.themedResources&&void 0!==currentProjectThemeFiles.controlClassValues[controlClass].themedResources[resourceName]&&null!==currentProjectThemeFiles.controlClassValues[controlClass].themedResources[resourceName]&&(res=currentProjectThemeFiles.controlClassValues[controlClass].themedResources[resourceName]);if(null!==res)return{error:TcHmi.Errors.NONE,origin:"project",originThemeName:this.__activeTheme,value:tchmi_clone_object(res)}}const controlType=control.getType();if(currentProjectThemeFiles?.controlTypeValues?.[controlType]?.themedResources&&void 0!==currentProjectThemeFiles.controlTypeValues[controlType].themedResources[resourceName]&&null!==currentProjectThemeFiles.controlTypeValues[controlType].themedResources[resourceName])return res=currentProjectThemeFiles.controlTypeValues[controlType].themedResources[resourceName],{error:TcHmi.Errors.NONE,origin:"project",originThemeName:this.__activeTheme,value:tchmi_clone_object(res)};const ctrlDescription=controlManager.getDescription(controlType);let supportedTheme="Base";Object.keys(ctrlDescription?.themes??{}).some(themeName=>themeName===this.__activeTheme)&&(supportedTheme=this.__activeTheme);let currentControlThemeFiles=this.__control_themeFiles.get(supportedTheme),currentControlThemeFile=currentControlThemeFiles?.get(controlType);return currentControlThemeFile?.controlTypeValues?.[controlType]?.themedResources&&void 0!==currentControlThemeFile.controlTypeValues[controlType].themedResources[resourceName]&&null!==currentControlThemeFile.controlTypeValues[controlType].themedResources[resourceName]?(res=currentControlThemeFile.controlTypeValues[controlType].themedResources[resourceName],{error:TcHmi.Errors.NONE,origin:"control",originThemeName:supportedTheme,value:tchmi_clone_object(res)}):{error:TcHmi.Errors.ERROR,origin:"control",originThemeName:this.__activeTheme,value:null}}__watchAttributeDefaults=new Map;__destroyOnPropertyChanged=new Map;__settingThemeValueInProgress=null;watchAttributeDefaults(control,propertyName){let attributeList=this.__watchAttributeDefaults.get(control);attributeList||(attributeList=new Set,this.__watchAttributeDefaults.set(control,attributeList)),attributeList.add(propertyName)}startAttributeSetterWatcher(control){this.__watchAttributeDefaults.has(control)&&(this.__destroyOnPropertyChanged.has(control)||this.__destroyOnPropertyChanged.set(control,TcHmi.EventProvider.register(control.getId()+".onPropertyChanged",this.__createOnPropertyChangedHandler(control))))}unwatchAttributeDefaults(control,propertyName){const attributeList=this.__watchAttributeDefaults.get(control);if(attributeList&&attributeList.delete(propertyName)&&0===attributeList.size){this.__watchAttributeDefaults.delete(control);const destroy=this.__destroyOnPropertyChanged.get(control);destroy&&(destroy(),this.__destroyOnPropertyChanged.delete(control))}}__themedResourcesControl=new Map;__themedResourcesApplication=new Map;processThemedResources(){let registeredControlThemedResources=new Map,registeredApplicationThemedResources=new Map,currentControlThemeFiles=this.__control_themeFiles.get(this.__activeTheme);currentControlThemeFiles&&currentControlThemeFiles.forEach((controlThemeFile,ctrlType)=>{if(controlThemeFile?.controlTypeValues){let controlResources=controlThemeFile?.controlTypeValues[ctrlType];if(controlResources?.themedResources){let nameToValueMap=registeredControlThemedResources.get(ctrlType);nameToValueMap||(nameToValueMap=new Map,registeredControlThemedResources.set(ctrlType,nameToValueMap));for(let themedResourceName in controlResources.themedResources){nameToValueMap.get(themedResourceName)||nameToValueMap.set(themedResourceName,controlResources.themedResources[themedResourceName])}}}});let currentProjectThemeFile=this.__project_themeFiles.get(this.__activeTheme);if(currentProjectThemeFile&&currentProjectThemeFile.controlTypeValues)for(let ctrlType in currentProjectThemeFile.controlTypeValues){let controlResources=currentProjectThemeFile?.controlTypeValues[ctrlType];if(controlResources?.themedResources){let nameToValueMap=registeredControlThemedResources.get(ctrlType);nameToValueMap||(nameToValueMap=new Map,registeredControlThemedResources.set(ctrlType,nameToValueMap));for(let themedResourceName in controlResources.themedResources)nameToValueMap.set(themedResourceName,controlResources.themedResources[themedResourceName])}}if(config.symbols.themedResources){const missingNames=[];for(let[resourceName,configResource]of Object.entries(config.symbols.themedResources)){let value=configResource.values[this.__activeTheme];void 0===value&&missingNames.push(resourceName),registeredApplicationThemedResources.has(resourceName)||registeredApplicationThemedResources.set(resourceName,value)}missingNames.length&&Log.warnEx("[Source=Framework, Module=TcHmi.System.ThemeManager] Themed Resources with names",missingNames,"have no values defined for theme "+this.__activeTheme+". Symbols with one of these names will not get a valid value. Please add values via HMI config window.")}for(const ctrl of Data.Modules.controls.array)if(ctrl?.description?.themedResources?.length){let ctrlType=resolveQualifiedName(ctrl.description.name,ctrl.description.namespace);for(let themedResource of ctrl.description.themedResources)if(!registeredControlThemedResources.get(ctrlType)?.has(themedResource.name)&&!config.themes[this.__activeTheme]?.replacesThemeForControls?.includes(ctrlType)){let resourceValueBase=this.__control_themeFiles.get("Base")?.get(ctrlType)?.controlTypeValues?.[ctrlType]?.themedResources?.[themedResource.name],nameToValueMap=registeredControlThemedResources.get(ctrlType);nameToValueMap||(nameToValueMap=new Map,registeredControlThemedResources.set(ctrlType,nameToValueMap)),nameToValueMap.set(themedResource.name,resourceValueBase)}}let entriesToProcess=[];registeredControlThemedResources.forEach((themedResourceMap,namespace)=>{let namespaceResources=this.__themedResourcesControl.get(namespace);namespaceResources||(namespaceResources=new Map,this.__themedResourcesControl.set(namespace,namespaceResources)),themedResourceMap.forEach((value,resourceName)=>{let themedResource=namespaceResources.get(resourceName);themedResource||(themedResource={value:void 0,callbacks:[]},namespaceResources.set(resourceName,themedResource)),tchmi_equal(themedResource?.value,value)||(themedResource.value=value,entriesToProcess.push(themedResource))})}),this.__themedResourcesControl.forEach((controlResources,ctrlType)=>{controlResources.forEach((themedResource,resourceName)=>{registeredControlThemedResources.get(ctrlType)?.has(resourceName)||void 0===themedResource.value||(themedResource.value=void 0,entriesToProcess.push(themedResource))})});let resourcesToRemove=Array.from(this.__themedResourcesApplication.keys());registeredApplicationThemedResources.forEach((value,resourceName)=>{let themedResource=this.__themedResourcesApplication.get(resourceName);if(themedResource?resourcesToRemove=resourcesToRemove.filter(r=>r!==resourceName):(themedResource={value:void 0,callbacks:[]},this.__themedResourcesApplication.set(resourceName,themedResource)),!tchmi_equal(themedResource?.value,value)){let dirtyPathsNew=null;themedResource.value&&value&&"object"==typeof themedResource.value&&"object"==typeof value&&(dirtyPathsNew=tchmi_compare_object(themedResource.value,value)),themedResource.value=value,dirtyPathsNew&&dirtyPathsNew.length>0&&(themedResource.dirtyPaths=dirtyPathsNew),entriesToProcess.push(themedResource)}});for(let resourceToRemove of resourcesToRemove){let themedResource=this.__themedResourcesApplication.get(resourceToRemove);if(themedResource&&(themedResource.value=null,themedResource.callbacks)){let callbackList=[];for(let j=0,jj=themedResource.callbacks.length;j<jj;j++)callbackList[j]=themedResource.callbacks[j];for(let innerCallback of callbackList){if(!themedResource.callbacks.includes(innerCallback))continue;const res={error:TcHmi.Errors.NONE,value:themedResource.value,destroy:innerCallback.destroy};TcHmi.Callback.callSafeEx(innerCallback.callback,this,res)}}}for(let i=0,ii=entriesToProcess.length;i<ii;i++){let entry=entriesToProcess[i],callbackList=[];for(let j=0,jj=entry.callbacks.length;j<jj;j++)callbackList[j]=entry.callbacks[j];for(let innerCallback of callbackList){if(!entry.callbacks.includes(innerCallback))continue;const res={error:TcHmi.Errors.NONE,value:entry.value,destroy:innerCallback.destroy};entry.dirtyPaths&&entry.dirtyPaths.length>0&&(res.dirtyPaths=entry.dirtyPaths),TcHmi.Callback.callSafe(innerCallback.callback,this,res)}}}getThemedResource(name,namespaceTokens){if(0===namespaceTokens.length||1===namespaceTokens.length&&"Application"===namespaceTokens[0]){let themedResource=this.__themedResourcesApplication.get(name);if(themedResource)return themedResource.value}else if(2===namespaceTokens.length&&"Controls"===namespaceTokens[0]){let themedResource=this.__themedResourcesControl.get(namespaceTokens[1])?.get(name);if(themedResource)return themedResource.value}}getThemedResourceType(name,namespaceTokens,callback){let type,themedResource;if(0===namespaceTokens.length||1===namespaceTokens.length&&"Application"===namespaceTokens[0])type=config.symbols.themedResources?.[name]?.type,themedResource=this.__themedResourcesApplication.get(name);else if(2===namespaceTokens.length&&"Control"===namespaceTokens[0]){let module=Data.Modules.controls.map.get(namespaceTokens[1]);type=module?.description?.themedResources.find(themedResource=>themedResource.name===name)?.type,themedResource=this.__themedResourcesControl.get(namespaceTokens[1])?.get(name)}if(!type||!themedResource){let resourceName=name;return 2===namespaceTokens.length&&"Control"===namespaceTokens[0]&&(resourceName="Control::"+namespaceTokens[1]+"::"+name),void TcHmi.Callback.callSafe(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Themed resource with name="+resourceName+" does not exist.",domain:"TcHmi.System.ThemeManager"}})}TcHmi.Callback.callSafe(callback,this,{error:TcHmi.Errors.NONE,type})}watchThemedResource(name,namespaceTokens,callback){let themedResource;if(0===namespaceTokens.length||1===namespaceTokens.length&&"Application"===namespaceTokens[0]?themedResource=this.__themedResourcesApplication.get(name):2===namespaceTokens.length&&"Control"===namespaceTokens[0]&&(themedResource=this.__themedResourcesControl.get(namespaceTokens[1])?.get(name)),!themedResource){let resourceName=name;return 2===namespaceTokens.length&&"Control"===namespaceTokens[0]&&(resourceName="Control::"+namespaceTokens[1]+"::"+name),TcHmi.Callback.callSafe(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Themed resource: '"+resourceName+"' does not exist for theme: '"+this.__activeTheme+"'.",domain:"TcHmi.System.ThemeManager"}}),function(){}}let destroy=function(){if(!themedResource)return;let index=themedResource.callbacks.indexOf(co);-1!==index&&(themedResource.callbacks.splice(index,1),co.callback=null)},co={callback,destroy};return themedResource.callbacks.push(co),TcHmi.Callback.callSafe(callback,this,{error:TcHmi.Errors.NONE,value:themedResource.value,destroy}),destroy}__onControlDestroyed(_event,control){this.__watchAttributeDefaults.delete(control);const destroy=this.__destroyOnPropertyChanged.get(control);destroy&&(destroy(),this.__destroyOnPropertyChanged.delete(control))}__onControlClassNamesChanged(_event,data){let currentProjectThemeFiles=this.__project_themeFiles.get(this.__activeTheme);if(currentProjectThemeFiles){if(data.oldClassNames)for(let oldClassName of data.oldClassNames)if(currentProjectThemeFiles.controlClassValues?.[oldClassName])return void this.__triggerControlsWithImplicitValues([data.control]);for(let newClassName of data.newClassName)if(currentProjectThemeFiles.controlClassValues?.[newClassName])return void this.__triggerControlsWithImplicitValues([data.control])}}__createOnPropertyChangedHandler(control){return(_event,data)=>{this.__settingThemeValueInProgress!==data.propertyName&&this.unwatchAttributeDefaults(control,data.propertyName)}}}})();export{ThemeManager};export const themeManager=new ThemeManager;
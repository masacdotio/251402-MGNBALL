import{serverManager}from"./ServerManager.js";import{callSafeCallbacks1Param}from"./Callback.js";import{controlManager}from"./ControlManager.js";import*as Server from"../API/Server.js";import{Log}from"../API/Log.js";export class LocalizationManager{__files=new Map;__fileFetchPromises=new Map;__localizations=new Map;__localizationCallbacks=new Map;__localizationEngineeringCallbacks=new Map;__locale=void 0;__localeFallback=void 0;__localeEngineering=void 0;__localeEngineeringFallback=void 0;__localizationData=new Map;__localizationFallbackData=new Map;__localizationEngineeringData=new Map;__localizationEngineeringFallbackData=new Map;__localizationDataByNsAndUrl=new Map;__namespacesByUrl=new Map;__pendingToProcessEntries=new Set;__callbackMap=new Map;getLocale(options){return TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering?this.__localeEngineering??void 0:this.__locale??void 0}getLocaleFallback(options){return TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering?this.__localeEngineeringFallback:this.__localeFallback??void 0}getLocaleData(namespace,options){return TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering?this.__localizationEngineeringData.get(namespace):this.__localizationData.get(namespace)}setLocaleData(namespace,data,fileurl,options){let namespaceData=this.__localizationDataByNsAndUrl.get(namespace);namespaceData||(namespaceData=new Map,this.__localizationDataByNsAndUrl.set(namespace,namespaceData)),namespaceData.set(fileurl,data),TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering?(this.__localizationEngineeringData.delete(namespace),namespaceData.forEach(localeData=>{if(localeData.locale!==data.locale)return;const currentData=this.__localizationEngineeringData.get(namespace);currentData?currentData.localizedText={...currentData.localizedText,...localeData.localizedText}:this.__localizationEngineeringData.set(namespace,localeData)})):(this.__localizationData.delete(namespace),namespaceData.forEach(localeData=>{if(localeData.locale!==data.locale)return;const currentData=this.__localizationData.get(namespace);currentData?currentData.localizedText={...currentData.localizedText,...localeData.localizedText}:this.__localizationData.set(namespace,localeData)}))}getLocaleFallbackData(namespace,options){return TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering?this.__localizationEngineeringFallbackData.get(namespace):this.__localizationFallbackData.get(namespace)}setLocaleFallbackData(namespace,data,fileurl,options){let namespaceData=this.__localizationDataByNsAndUrl.get(namespace);namespaceData||(namespaceData=new Map,this.__localizationDataByNsAndUrl.set(namespace,namespaceData)),namespaceData.set(fileurl,data),TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering?(this.__localizationEngineeringFallbackData.delete(namespace),namespaceData.forEach(localeData=>{if(localeData.locale!==data.locale)return;const currentData=this.__localizationEngineeringFallbackData.get(namespace);currentData?currentData.localizedText={...currentData.localizedText,...localeData.localizedText}:this.__localizationEngineeringFallbackData.set(namespace,localeData)})):(this.__localizationFallbackData.delete(namespace),namespaceData.forEach(localeData=>{if(localeData.locale!==data.locale)return;const currentData=this.__localizationFallbackData.get(namespace);currentData?currentData.localizedText={...currentData.localizedText,...localeData.localizedText}:this.__localizationFallbackData.set(namespace,localeData)}))}loadLocale(locale,callback){locale||TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:"Missing locale.",domain:"TcHmi.System.LocalizationManager"}}),serverManager.request({requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"SetLocale",writeValue:locale}]},Server.handleResponse({error:data=>{if(data.error===TcHmi.Errors.NONE&&data.results){let res=data.results[0];TcHmi.Callback.callSafeEx(callback,this,{error:res.error,details:res.details})}else TcHmi.Callback.callSafeEx(callback,this,{error:data.error,details:data.details})},success:data=>{if(callback){if(locale===this.__locale)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE});let callbackList=this.__callbackMap.get(locale);callbackList||(callbackList=[],this.__callbackMap.set(locale,callbackList)),callbackList.push(callback)}}}))}processLocalizationData(namespace,data,fallback,options){if(!namespace)return TcHmi.Errors.E_PARAMETER_INVALID;const fileLocalizedText=data&&void 0!==data.locale&&null!==data.locale&&data.localizedText?data.localizedText:null,fallbackLocalizedText=fallback?fallback.localizedText:null;let localization=this.__localizations.get(namespace);localization||(localization={application:new Map,engineering:new Map},this.__localizations.set(namespace,localization));let keysToRemove=new Set,level=localization.application;TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering&&(level=localization.engineering);let keyTextBefore=new Map;if(level.forEach((entry,key)=>{!keyTextBefore.has(key)&&entry&&void 0!==entry.text&&null!==entry.text&&keyTextBefore.set(key,entry.text),keysToRemove.add(key)}),fallbackLocalizedText)for(let key in fallbackLocalizedText){const text=fallbackLocalizedText[key];if(null==text)continue;keysToRemove.delete(key);let entry=level.get(key);entry?tchmi_equal(entry.text,text)||(entry.text=text,entry.fallback=!0,entry.dummy=!1,this.__pendingToProcessEntries.add(entry)):(entry={key,text,fallback:!0,dummy:!1,callbacks:[]},level.set(key,entry))}if(fileLocalizedText)for(let key in fileLocalizedText){const text=fileLocalizedText[key];if(null==text)continue;keysToRemove.delete(key);let entry=level.get(key);if(entry){if(keyTextBefore.has(key)){let textBefore=keyTextBefore.get(key);tchmi_equal(textBefore,text)||this.__pendingToProcessEntries.add(entry)}else this.__pendingToProcessEntries.add(entry);entry.text=text,entry.fallback=!1,entry.dummy=!1}else entry={key,text,fallback:!1,dummy:!1,callbacks:[]},level.set(key,entry)}for(let keyToRemove of keysToRemove.values()){let entry=level.get(keyToRemove);entry&&(entry.dummy=!0,entry.fallback=!1,delete entry.text,this.__pendingToProcessEntries.add(entry))}return TcHmi.Errors.NONE}async __processLocaleForNamespace(newLocale,namespace,options){const files=this.__files.get(namespace);if(!files||0===files.size)return Promise.resolve(!1);const locale2fileurl=function(newLocale){if(!newLocale)return;let file=files.get(newLocale);if(!file){const arrNewLanguageAndRegion=newLocale.toLowerCase().split("-");for(let language of Array.from(files.keys()))if(language.toLowerCase().split("-")[0]===arrNewLanguageAndRegion[0])return files.get(language)}return file};let fileFallback,file=locale2fileurl(newLocale);fileFallback=TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering?locale2fileurl(this.__localeEngineeringFallback):locale2fileurl(this.__localeFallback),!fileFallback&&(namespace.startsWith("TcHmi.System.Localization.Framework")||namespace.startsWith("TcHmi.System.Localization.Control")||namespace.startsWith("TcHmi.System.Localization.Function")||namespace.startsWith("TcHmi.System.Localization.Package"))&&(fileFallback=locale2fileurl("en"));try{const[fallbackLocalization,localization]=await Promise.all([this.__loadLocalizationFile(fileFallback,namespace,options?.level).catch(error=>(Log.errorEx(`[Source=TcHmi, Module=TcHmi.System.LocalizationManager] Failed to load fallback localization file: ${error.message}. Proceeding without fallback language support.`),null)),this.__loadLocalizationFile(file,namespace,options?.level).catch(error=>{throw Log.errorEx(`[Source=TcHmi, Module=TcHmi.System.LocalizationManager] Failed to load localization file: ${error.message}.`),error})]);return TCHMI_DESIGNER&&options?.level===TcHmi.Locale.Level.Engineering?(localization?this.__localizationEngineeringData.set(namespace,localization):this.__localizationEngineeringData.delete(namespace),fallbackLocalization?this.__localizationEngineeringFallbackData.set(namespace,fallbackLocalization):this.__localizationEngineeringFallbackData.delete(namespace)):(localization?this.__localizationData.set(namespace,localization):this.__localizationData.delete(namespace),fallbackLocalization?this.__localizationFallbackData.set(namespace,fallbackLocalization):this.__localizationFallbackData.delete(namespace)),!0}catch(_error){return!1}}async __loadLocalizationFile(file,namespace,level){if(!file)return null;const fetcher=async file=>{let getLocaleData=this.__fileFetchPromises.get(file);getLocaleData||(getLocaleData=fetch(tchmi_encode_uri_components(file)+(TCHMI_ENGINEERING?"?preventcache="+Math.random():"")).then(response=>200===response.status&&response.ok?response.json().catch(_reason=>Promise.reject(new Error(`Could not parse localization JSON file ${file} for namespace ${namespace}`))):Promise.reject(new Error(`HTTP error ${response.status} ${response.statusText} while trying to fetch localization file ${file} for namespace ${namespace}`))),this.__fileFetchPromises.set(file,getLocaleData));const localeData=await getLocaleData;if(TCHMI_DESIGNER&&level===TcHmi.Locale.Level.Engineering||TCHMI_ENGINEERING){let namespaceData=this.__localizationDataByNsAndUrl.get(namespace);namespaceData||(namespaceData=new Map,this.__localizationDataByNsAndUrl.set(namespace,namespaceData)),namespaceData.set(file,localeData)}return localeData};let fetchPromise;fetchPromise="string"==typeof file?fetcher(file):Array.isArray(file)?Promise.all(file.map(fetcher)):Promise.reject(new Error);let localeData=await fetchPromise;return Array.isArray(localeData)&&(localeData=localeData.reduce((merged,current)=>(merged.localizedText={...merged.localizedText,...current.localizedText},merged))),localeData}async processLocale(newLocale,options,callback){this.__fileFetchPromises.clear();const savedCallbackList=this.__callbackMap.get(newLocale)??[];let localeOld;callback&&savedCallbackList.push(callback),savedCallbackList.push(()=>{this.__callbackMap.delete(newLocale)}),TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering?(localeOld=this.__localeEngineering,this.__localeEngineering=newLocale):(localeOld=this.__locale,this.__locale=newLocale),document.documentElement.lang=newLocale??"";const namespaces=[],promises=[];for(const namespace of this.__files.keys())promises.push(this.__processLocaleForNamespace(newLocale,namespace,options).then(success=>{success&&namespaces.push(namespace)}));await Promise.all(promises);for(let namespace of namespaces){let localeData,localeFallbackData;TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering?(localeData=this.__localizationEngineeringData.get(namespace),localeFallbackData=this.__localizationEngineeringFallbackData.get(namespace)):(localeData=this.__localizationData.get(namespace),localeFallbackData=this.__localizationFallbackData.get(namespace));this.processLocalizationData(namespace,localeData,localeFallbackData,options)!==TcHmi.Errors.NONE&&Log.error('[Source=TcHmi, Module=TcHmi.System.LocalizationManager] Processing localization data "" for locale: "'+newLocale+'" of namespace: "'+namespace+'" failed.')}this.__fileFetchPromises.clear(),this.resolveControlLocalizationFileInheritation(),this.processPendingEntryWatches(),this.processLocalizationWatches(namespaces,options),callSafeCallbacks1Param(savedCallbackList,null,{error:TcHmi.Errors.NONE}),TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering?localeOld!==newLocale&&TcHmi.EventProvider.raise("onEngineeringLocaleChanged",newLocale):localeOld!==newLocale&&TcHmi.EventProvider.raise("onLocaleChanged",newLocale)}processPendingEntryWatches(){for(let entry of this.__pendingToProcessEntries.values()){let callbackList=[];for(let j=0,jj=entry.callbacks.length;j<jj;j++)callbackList[j]=entry.callbacks[j];for(let innerCallback of callbackList)entry.callbacks.includes(innerCallback)&&TcHmi.Callback.callSafeEx(innerCallback.callback,this,{error:TcHmi.Errors.NONE,text:entry.text??entry.key,destroy:innerCallback.destroy})}this.__pendingToProcessEntries.clear()}processLocalizationWatches(namespace,options){let namespaces=[];Array.isArray(namespace)?namespaces=namespace:namespaces.push(namespace);for(let namespace of namespaces){let localizationCallbacks;if(localizationCallbacks=TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering?this.__localizationEngineeringCallbacks.get(namespace):this.__localizationCallbacks.get(namespace),localizationCallbacks){let localizationReader=this.get(namespace);for(let i=0,ii=localizationCallbacks.length;i<ii;i++){let localizationCallback=localizationCallbacks[i];localizationCallback&&TcHmi.Callback.callSafeEx(localizationCallback.callback,this,{error:TcHmi.Errors.NONE,reader:localizationReader,destroy:localizationCallback.destroy})}}}}registerLocalizationFile(namespace,locale,pathOrPathArray){let files=this.__files.get(namespace);if(files||(files=new Map,this.__files.set(namespace,files)),files.set(locale,pathOrPathArray),TCHMI_ENGINEERING)if(Array.isArray(pathOrPathArray)){let files=pathOrPathArray;for(let file of files)if(this.__namespacesByUrl.has(file)){let namespaces=this.__namespacesByUrl.get(file);namespaces&&namespaces.add(namespace)}else this.__namespacesByUrl.set(file,new Set([namespace]))}else if(this.__namespacesByUrl.has(pathOrPathArray)){let namespaces=this.__namespacesByUrl.get(pathOrPathArray);namespaces&&namespaces.add(namespace)}else this.__namespacesByUrl.set(pathOrPathArray,new Set([namespace]))}unregisterLocalizationFile(namespace,locale,pathOrPathArray){let files=this.__files.get(namespace);if(files&&(files.has(locale)&&tchmi_equal(files.get(locale),pathOrPathArray)&&files.delete(locale),0===files.size&&this.__files.delete(namespace),TCHMI_ENGINEERING))if(Array.isArray(pathOrPathArray)){let files=pathOrPathArray;for(let file of files){let namespaces=this.__namespacesByUrl.get(file);namespaces&&(namespaces.delete(namespace),0===namespaces.size&&this.__namespacesByUrl.delete(file))}}else{let namespaces=this.__namespacesByUrl.get(pathOrPathArray);namespaces&&(namespaces.delete(namespace),0===namespaces.size&&this.__namespacesByUrl.delete(pathOrPathArray))}}resolveControlLocalizationFileInheritation(){let root=controlManager.getInheritanceTree();if(!root)return;const merge=(entry,parents)=>{let inheritationHierarchyPath=[entry];parents&&(inheritationHierarchyPath=parents.concat([entry]));let currentInheritationApplicationLocalizations=[],currentInheritationEngineeringLocalizations=[];for(let i=0,ii=inheritationHierarchyPath.length;i<ii;i++){let current=inheritationHierarchyPath[i];if(!current)continue;let isNew=!1,currentLocalization=this.__localizations.get("TcHmi.System.Localization.Control<"+current.controlType+">");currentLocalization||(isNew=!0,currentLocalization={application:new Map,engineering:new Map});for(let j=0,jj=currentInheritationApplicationLocalizations.length;j<jj;j++){let currentInheritationApplicationLocalization=currentInheritationApplicationLocalizations[j];currentInheritationApplicationLocalization&&currentInheritationApplicationLocalization.forEach((localizedText,key)=>{if(currentLocalization.application.has(key)){let entryToUpdate=currentLocalization.application.get(key);entryToUpdate&&(entryToUpdate.text=localizedText.text,entryToUpdate.dummy=localizedText.dummy,entryToUpdate.fallback=localizedText.fallback)}else currentLocalization.application.set(key,{key,text:localizedText.text,dummy:localizedText.dummy,fallback:localizedText.fallback,callbacks:[]})})}for(let j=0,jj=currentInheritationEngineeringLocalizations.length;j<jj;j++){let currentInheritationEngineeringLocalization=currentInheritationEngineeringLocalizations[j];currentInheritationEngineeringLocalization&&currentInheritationEngineeringLocalization.forEach((localizedText,key)=>{if(currentLocalization.engineering.has(key)){let entryToUpdate=currentLocalization.engineering.get(key);entryToUpdate&&(entryToUpdate.text=localizedText.text,entryToUpdate.dummy=localizedText.dummy,entryToUpdate.fallback=localizedText.fallback)}else currentLocalization.engineering.set(key,{key,text:localizedText.text,dummy:localizedText.dummy,fallback:localizedText.fallback,callbacks:[]})})}currentInheritationApplicationLocalizations.push(currentLocalization.application),currentInheritationEngineeringLocalizations.push(currentLocalization.engineering),isNew&&this.__localizations.set("TcHmi.System.Localization.Control<"+current.controlType+">",currentLocalization)}},recurse=(entry,parents)=>{if(entry)for(let i=0,ii=entry.children.length;i<ii;i++){let child=entry.children[i],parentsNew=[];if(parents&&0!==parents.length){parentsNew=[];for(let i=0,ii=parents.length;i<ii;i++)parentsNew.push(parents[i]);parentsNew.push(entry)}else parentsNew.push(entry);child.children&&child.children.length>0?recurse(child,parentsNew):merge(child,parentsNew)}};recurse(root,null)}setFallbackLocale(fallback){this.__localeFallback=fallback??void 0}resetFallbackLocale(callback=null){this.__localizationFallbackData.clear(),this.processLocale(this.__locale)}clearFileFetchCache(){this.__fileFetchPromises.clear()}getFiles(){return this.__files}getNamespacesByUrl(url){let namespaces=this.__namespacesByUrl.get(url);if(namespaces)return Array.from(namespaces)}get(namespace,options){let res={},localization=this.__localizations.get(namespace);if(!localization)return new TcHmi.Locale.LocalizationReader(res);let level=localization.application;TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering&&(level=localization.engineering);let preventHtml=!1;return"boolean"==typeof options?.preventHtml&&(preventHtml=options.preventHtml),level.forEach((entry,key)=>{if(!entry.dummy){let text=entry.text;if(preventHtml&&text){let dummyDiv=document.createElement("div");dummyDiv.textContent=text,text=dummyDiv.innerHTML}res[key]=text??null}}),new TcHmi.Locale.LocalizationReader(res)}watch(namespace,options={},callback){let localization=this.__localizations.get(namespace);localization||(localization={application:new Map,engineering:new Map},this.__localizations.set(namespace,localization));let callbackCacheEntry={callback,destroy:()=>{}},callbackCache=this.__localizationCallbacks.get(namespace);callbackCache?callbackCache.push(callbackCacheEntry):(callbackCache=[callbackCacheEntry],this.__localizationCallbacks.set(namespace,callbackCache));let destroy=()=>{if(!callbackCache)return;let pos=callbackCache.indexOf(callbackCacheEntry);pos>-1&&callbackCache.splice(pos,1),0===callbackCache.length&&this.__localizationCallbacks.delete(namespace)};callbackCacheEntry.destroy=destroy;let reader=this.get(namespace,options);return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,reader,destroy}),destroy}getText(namespace,key,options){let localization=this.__localizations.get(namespace);if(localization){let level=localization.application;TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering&&(level=localization.engineering);let preventHtml=!1;"boolean"==typeof options?.preventHtml&&(preventHtml=options.preventHtml);let entry=level.get(key);if(!entry||entry.dummy)return key;{let text=entry.text;if(preventHtml&&text){let dummyDiv=document.createElement("div");dummyDiv.textContent=text,text=dummyDiv.innerHTML}return text??key}}return key}watchText(namespace,key,options={},callback){let localization=this.__localizations.get(namespace);localization||(localization={application:new Map,engineering:new Map},this.__localizations.set(namespace,localization));let level=localization.application;TCHMI_DESIGNER&&options&&options.level===TcHmi.Locale.Level.Engineering&&(level=localization.engineering);let preventHtml=!1;"boolean"==typeof options?.preventHtml&&(preventHtml=options.preventHtml);let entry=level.get(key);entry||(entry={key,fallback:!1,dummy:!0,callbacks:[]},level.set(key,entry));let destroy=function(){if(!entry)return;let index=entry.callbacks.indexOf(co);-1!==index&&(entry.callbacks.splice(index,1),co.callback=void 0)},co={callback,destroy};if(entry.callbacks.push(co),entry.dummy)TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,text:key,destroy});else{let text=entry.text;if(preventHtml&&text){let dummyDiv=document.createElement("div");dummyDiv.textContent=text,text=dummyDiv.innerHTML}TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,text:text??key,destroy})}return destroy}}export const localizationManager=new LocalizationManager;
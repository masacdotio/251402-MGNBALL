import{Log}from"../API/Log.js";import{SymbolExpression}from"../API/SymbolExpression.js";import{FunctionExpression}from"./FunctionExpression.js";import{localizationManager}from"./LocalizationManager.js";import{packageSymbolManager}from"./PackageSymbolManager.js";import{SymbolHelper}from"./Symbol.SymbolHelper.js";import{SymbolTypeContext}from"./Symbol.SymbolTypeContext.js";import{SymbolTypeControl}from"./Symbol.SymbolTypeControl.js";import{SymbolTypeFunction}from"./Symbol.SymbolTypeFunction.js";import{SymbolTypeInternal}from"./Symbol.SymbolTypeInternal.js";import{SymbolTypeLocalizedText}from"./Symbol.SymbolTypeLocalizedText.js";import{SymbolTypePackage}from"./Symbol.SymbolTypePackage.js";import{SymbolTypePartialParam}from"./Symbol.SymbolTypePartialParam.js";import{SymbolTypeServer}from"./Symbol.SymbolTypeServer.js";import{SymbolTypeTemplateParam}from"./Symbol.SymbolTypeTemplateParam.js";import{SymbolTypeThemedResource}from"./Symbol.SymbolTypeThemedResource.js";import{SymbolTypeTimer}from"./Symbol.SymbolTypeTimer.js";import{Data}from"./System.js";import{resolveServerSymbolNameParts}from"./SystemFunctions.js";export var SymbolState;!function(SymbolState){SymbolState[SymbolState.Invalid=0]="Invalid",SymbolState[SymbolState.Ready=10]="Ready",SymbolState[SymbolState.Destroyed=20]="Destroyed"}(SymbolState||(SymbolState={}));export class Symbol extends TcHmi.Destroyable{constructor(expressionOrExpressionObject){super(),(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(this.__diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=SystemSymbol, ObjectScopeDiagGUID="+this.__diagGUID+"] constructor called with: %o",expressionOrExpressionObject);let expression=null;if(this.__referenceDelegation={},"string"==typeof expressionOrExpressionObject?expression=new TcHmi.SymbolExpression(expressionOrExpressionObject):expressionOrExpressionObject instanceof SymbolExpression?expression=expressionOrExpressionObject:("string"==typeof expressionOrExpressionObject.expression?expression=new TcHmi.SymbolExpression(expressionOrExpressionObject.expression):expressionOrExpressionObject.expression instanceof SymbolExpression&&(expression=expressionOrExpressionObject.expression),expressionOrExpressionObject.ctx&&(this.__ctx=expressionOrExpressionObject.ctx)),this.__expression=expression,this.__expression.getType()===TcHmi.SymbolType.Invalid){const message=`Expression '${expression.toString()}' contains no valid symbol expression.`;throw new SyntaxError(message)}switch(this.__helper=new SymbolHelper(this),this.__expression.getType()){case TcHmi.SymbolType.Server:this.__symbolTypeServer=new SymbolTypeServer(this);break;case TcHmi.SymbolType.Internal:this.__symbolTypeInternal=new SymbolTypeInternal(this);break;case TcHmi.SymbolType.Control:this.__symbolTypeControl=new SymbolTypeControl(this);break;case TcHmi.SymbolType.PartialParam:this.__symbolTypePartialParam=new SymbolTypePartialParam(this);break;case TcHmi.SymbolType.TemplateParam:this.__symbolTypeTemplateParam=new SymbolTypeTemplateParam(this);break;case TcHmi.SymbolType.LocalizedText:this.__symbolTypeLocalizedText=new SymbolTypeLocalizedText(this);break;case TcHmi.SymbolType.Function:this.__symbolTypeFunction=new SymbolTypeFunction(this);break;case TcHmi.SymbolType.Context:this.__symbolTypeContext=new SymbolTypeContext(this);break;case TcHmi.SymbolType.ThemedResource:this.__symbolTypeThemedResource=new SymbolTypeThemedResource(this);break;case TcHmi.SymbolType.Timer:this.__symbolTypeTimer=new SymbolTypeTimer(this);break;case TcHmi.SymbolType.Package:this.__symbolTypePackage=new SymbolTypePackage(this)}this.__state=SymbolState.Ready}__diagGUID="";__expression;__state=SymbolState.Invalid;__ctx;__referenceDelegation;__helper;__symbolTypeServer;__symbolTypeInternal;__symbolTypeControl;__symbolTypePartialParam;__symbolTypeTemplateParam;__symbolTypeLocalizedText;__symbolTypeFunction;__symbolTypeContext;__symbolTypeThemedResource;__symbolTypeTimer;__symbolTypePackage;getDiagGUID(){return this.__diagGUID}getExpression(){return this.__expression}getState(){return this.__state}getReferenceDelegation(){return this.__referenceDelegation}getContext(){return this.__ctx}isReady(){return this.__state===SymbolState.Ready}isProcessedAsync(){return this.__isProcessedAsync(this.__expression)}__printExpression(expression){let message=this.__expression.toString();return expression?(this.__expression.toString()!==expression.toString()&&(message+=` (Resolved to: '${expression.toString()}')`),message):message}__isProcessedAsync(expression){let type=expression.getType();if(type===TcHmi.SymbolType.Server)return!0;if(type===TcHmi.SymbolType.Function){const content=expression.getContent();if(!content)return!1;let func=new FunctionExpression(content);if(func.isProcessedAsync()){let res=!0;return func.destroy(),res}func.destroy()}else{let children=expression.getChildren();for(let child of children)if(this.__isProcessedAsync(child))return!0}return!1}destroy(){if(this.isDestroyed())return void Log.debug("[Source=Framework, Module=SystemSymbol, ObjectScopeDiagGUID="+this.__diagGUID+"] destroy called and aborted because object is already marked as destroyed.");let diagExpression=this.__expression.toString();Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+diagExpression+", ObjectScopeDiagGUID="+this.__diagGUID+"] destroy called."),this.__releaseDestroyPrivilege(),this.isDestroyable()?(this.__helper.destroy(),this.__symbolTypeContext?.destroy(),this.__symbolTypeControl?.destroy(),this.__symbolTypeFunction?.destroy(),this.__symbolTypeInternal?.destroy(),this.__symbolTypeLocalizedText?.destroy(),this.__symbolTypePartialParam?.destroy(),this.__symbolTypeServer?.destroy(),this.__symbolTypeTemplateParam?.destroy(),this.__symbolTypeThemedResource?.destroy(),this.__symbolTypeTimer?.destroy(),this.__state=SymbolState.Destroyed,this.__isDestroyed=!0,Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+diagExpression+", ObjectScopeDiagGUID="+this.__diagGUID+"] destroy finished.")):Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+diagExpression+", ObjectScopeDiagGUID="+this.__diagGUID+"] destroy aborted. Not yet destroyable due to existing destroy privileges.")}resolveExpression(callback){if(!this.__expression.hasChildren()||this.__expression.getType()===TcHmi.SymbolType.Function)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,value:this.__expression,expression:this.__expression,expressionResolved:this.__expression}),()=>{};let destroyChildResources=[],destroy=()=>{for(let destroyChildRes of destroyChildResources)destroyChildRes();destroyChildResources=[]},results=new Map,res={error:TcHmi.Errors.NONE,value:this.__expression,expression:this.__expression},expressionStrResolved=this.__expression.toString(),children=this.__expression.getChildren(),proc=()=>{children.length===results.size&&(results.forEach((data,symbol)=>{if(data.error!==TcHmi.Errors.NONE)return res.error=TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,void(res.details||(res.details={code:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION],reason:this.__printExpression()+": Failed to resolve at least one child symbol expression.",domain:"TcHmi.System.Symbol"},data.details&&(res.details.errors=[data.details])));if(res.error!==TcHmi.Errors.NONE)return;let expression=symbol.getExpression();expressionStrResolved=expressionStrResolved.replace(new RegExp(tchmi_escape_regex(expression.toString()),"g"),data.value)}),res.error===TcHmi.Errors.NONE&&(res.value=new SymbolExpression(expressionStrResolved)),TcHmi.Callback.callSafeEx(callback,this,res),destroy())};for(let child of children){let childSymbol=new Symbol({expression:child,ctx:this.__ctx}),destroyRead=childSymbol.read(data=>{results.set(childSymbol,data),proc()});destroyRead&&destroyChildResources.push(destroyRead),destroyChildResources.push(()=>{childSymbol.destroy()})}return destroy}watchExpression(callback,reason){if(!this.__expression.hasChildren()||this.__expression.getType()===TcHmi.SymbolType.Function)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,value:this.__expression,expression:this.__expression,expressionResolved:this.__expression}),()=>{};let destroyChildResources=[],res={error:TcHmi.Errors.NONE,value:this.__expression,expression:this.__expression},children=this.__expression.getChildren(),results=new Map,proc=()=>{if(res={error:TcHmi.Errors.NONE,value:this.__expression,expression:this.__expression},children.length!==results.size)return;let expressionStrResolved=this.__expression.toString();results.forEach((data,symbol)=>{if(data.error!==TcHmi.Errors.NONE)return res.error=TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,void(res.details||(res.details={code:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION],reason:this.__printExpression()+": Failed to watch and resolve at least one child symbol expression.",domain:"TcHmi.System.Symbol"},data.details&&(res.details.errors=[data.details])));if(res.error!==TcHmi.Errors.NONE)return;let expression=symbol.getExpression();expressionStrResolved=expressionStrResolved.replace(new RegExp(tchmi_escape_regex(expression.toString()),"g"),data.value)}),res.error===TcHmi.Errors.NONE&&(res.value=new SymbolExpression(expressionStrResolved),res.expressionResolved=res.value),TcHmi.Callback.callSafeEx(callback,this,res)};for(let child of children){let childSymbol=new Symbol({expression:child,ctx:this.__ctx}),destroyChildWatch=childSymbol.watch(data=>{results.set(childSymbol,data),proc()});destroyChildResources.push(destroyChildWatch),destroyChildResources.push(()=>{childSymbol.destroy()})}return()=>{for(let destroyChildRes of destroyChildResources)destroyChildRes();destroyChildResources=[]}}resolveSchema(callback){let destroResolveSchema=null,destroyResolveExpression=this.resolveExpression(data=>{if(data.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION],reason:this.__expression.toString()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:data.expression,expressionResolved:data.expressionResolved};return data.details&&(res.details.errors=[data.details]),void TcHmi.Callback.callSafeEx(callback,this,res)}if(!data.value)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__expression.toString()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:data.expression,expressionResolved:data.expressionResolved});let expression=data.value;destroResolveSchema=this.__helper.resolveSchema(expression,callback)});return()=>{destroyResolveExpression?.(),destroResolveSchema?.(),destroResolveSchema=null}}resolveAttributes(callback){return this.resolveSchema(data=>{data.error===TcHmi.Errors.NONE?data.schema&&data.schema.attributes?TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,attributes:tchmi_clone_object(data.schema.attributes),expression:data.expression,expressionResolved:data.expressionResolved}):TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,attributes:{},expression:data.expression,expressionResolved:data.expressionResolved}):TcHmi.Callback.callSafeEx(callback,this,{error:data.error,details:data.details,expression:data.expression,expressionResolved:data.expressionResolved})})}resolveAttribute(name,callback){this.resolveAttributes(data=>{data.error===TcHmi.Errors.NONE?data.attributes&&void 0!==data.attributes[name]?TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,name,value:tchmi_clone_object(data.attributes[name]),expressionResolved:data.expressionResolved,expression:data.expression}):TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN_ATTRIBUTE,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN_ATTRIBUTE,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN_ATTRIBUTE],reason:this.getExpression().toString()+" (Resolved to: '"+data.expressionResolved?.toString()+"'): Failed to resolve attribute",domain:"TcHmi.System.Symbol"},expression:data.expression,expressionResolved:data.expressionResolved}):TcHmi.Callback.callSafeEx(callback,this,{error:data.error,details:data.details,expression:data.expression,expressionResolved:data.expressionResolved})})}resolveVersions(callback){this.resolveExpression(data=>{if(data.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION],reason:this.__expression.toString()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:data.expression,expressionResolved:data.expressionResolved};return data.details&&(res.details.errors=[data.details]),void TcHmi.Callback.callSafeEx(callback,this,res)}if(!data.value)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__expression.toString()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:data.expression,expressionResolved:data.expressionResolved});let expression=data.value;this.__resolveVersions(expression,callback)})}__resolveVersions(expression,callback){const type=expression.getType();if(type!==TcHmi.SymbolType.Server)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_NOT_SUPPORTED,details:{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],reason:this.__printExpression(expression)+": Symbols of type '"+TcHmi.SymbolType[type]+"' do not support versions.",domain:"TcHmi.System.Symbol"},expressionResolved:expression,expression:this.getExpression()});const name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression(expression)+": Failed to resolve name from expression.",domain:"TcHmi.System.Symbol"},expressionResolved:expression,expression:this.getExpression()});let baseName=resolveServerSymbolNameParts(name).name,data=Data.Caches.serverSymbolMetaDataCache.get(baseName);data?TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,versions:tchmi_clone_object(data.ListSymbols?.VERSIONS),expressionResolved:expression,expression:this.getExpression()}):TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression(expression)+": Meta data not found.",domain:"TcHmi.System.Symbol"},expressionResolved:expression,expression:this.getExpression()})}watchVersions(callback){let destroy=null,destroyWatchVersions=null,destroyWatchExpression=this.watchExpression(data=>{if(data.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expressionResolved:data.expressionResolved,expression:data.expression};return data.details&&(res.details.errors=[data.details]),void TcHmi.Callback.callSafeEx(callback,this,res)}if(!data.value)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expressionResolved:data.expressionResolved,expression:data.expression});let expression=data.value;destroyWatchVersions?.(),destroyWatchVersions=this.__watchVersions(expression,callback),destroy=()=>{destroyWatchVersions?.(),destroyWatchVersions=null}});return()=>{destroyWatchExpression(),destroy?.(),destroy=null}}__watchVersions(expression,callback){const type=expression.getType();if(type!==TcHmi.SymbolType.Server)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_NOT_SUPPORTED,details:{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],reason:expression.toString()+": Symbols of type '"+TcHmi.SymbolType[type]+"' do not support versions.",domain:"TcHmi.System.Symbol"},expression:this.getExpression(),expressionResolved:expression}),()=>{};const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Failed to resolve name from expression.",domain:"TcHmi.System.Symbol"},expressionResolved:expression,expression:this.getExpression()}),()=>{};let baseName=resolveServerSymbolNameParts(name).name,destroyEvent=TcHmi.EventProvider.register("System.onServerSymbolMetaDataChanged<"+baseName+">",(e,data)=>{tchmi_equal(data.entryOld?.ListSymbols?.VERSIONS,data.entryNew.ListSymbols?.VERSIONS)||TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,versions:tchmi_clone_object(data.entryNew?.ListSymbols?.VERSIONS),expressionResolved:expression,expression:this.getExpression()})});return this.__resolveVersions(expression,data=>{TcHmi.Callback.callSafeEx(callback,this,data)}),()=>{destroyEvent()}}resolveMetaData(callback){this.resolveExpression(data=>{if(data.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:data.expression};return data.details&&(res.details.errors=[data.details]),void TcHmi.Callback.callSafeEx(callback,this,res)}if(!data.value)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:data.expression,expressionResolved:data.expressionResolved});let expression=data.value;this.__resolveMetaData(expression,callback)})}__resolveMetaData(expression,callback){const type=expression.getType();if(type!==TcHmi.SymbolType.Server&&type!==TcHmi.SymbolType.Package)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_NOT_SUPPORTED,details:{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],reason:expression.toString()+": Symbols of type '"+TcHmi.SymbolType[type]+"' do not support meta data.",domain:"TcHmi.System.Symbol"},expressionResolved:expression,expression:this.getExpression()});const name=expression.getName();if(name){if(type===TcHmi.SymbolType.Server){let baseName=resolveServerSymbolNameParts(name).name,data=Data.Caches.serverSymbolMetaDataCache.get(baseName);if(!data)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Meta data not found.",domain:"TcHmi.System.Symbol"},expressionResolved:expression,expression:this.getExpression()});TcHmi.Callback.callSafeEx(callback,this,data)}else if(type===TcHmi.SymbolType.Package){const mapping=packageSymbolManager.get(name);if(!mapping)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): No mapping was found.",domain:"TcHmi.System.Symbol"},expressionResolved:expression,expression:this.getExpression(),destroy:()=>{}}),()=>{};if(!mapping.symbol)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Mapping symobl is not defined.",domain:"TcHmi.System.Symbol"},expression:this.getExpression(),expressionResolved:expression,destroy:()=>{}}),()=>{};if(!TcHmi.Symbol.isSymbolExpression(mapping.symbol))return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Mapping symobl is not a valid symbol expression.",domain:"TcHmi.System.Symbol"},expression:this.getExpression(),expressionResolved:expression}),()=>{};let mappingSymbol;try{let mappingSymbolExpression=new TcHmi.SymbolExpression(mapping.symbol),mappingSymbolExpressionPrepared=SymbolTypePackage.ResolveMappingSymbolExpression(expression,mappingSymbolExpression),mappingSymbol=new Symbol(mappingSymbolExpressionPrepared);mappingSymbol.resolveMetaData(data=>{mappingSymbol?.destroy(),TcHmi.Callback.callSafeEx(callback,this,data)})}catch(e){return mappingSymbol?.destroy(),void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): An exception occured while trying to parse the mapping symbol '"+mapping.symbol+"'.",exception:e,domain:"SystemSymbolHelper"},expression:this.getExpression(),expressionResolved:expression})}return}}else TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Failed to resolve name from expression.",domain:"TcHmi.System.Symbol"},expressionResolved:expression,expression:this.getExpression()})}watchMetaData(callback){let destroy=null,destroyWatchMetaData=null,destroyWatchExpression=this.watchExpression(data=>{if(data.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:data.expression};return data.details&&(res.details.errors=[data.details]),void TcHmi.Callback.callSafeEx(callback,this,res)}if(!data.value)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expressionResolved:data.expressionResolved,expression:data.expression});let expression=data.value;destroyWatchMetaData?.(),destroyWatchMetaData=this.__watchMetaData(expression,callback),destroy=()=>{destroyWatchMetaData?.(),destroyWatchMetaData=null}});return()=>{destroyWatchExpression(),destroy?.(),destroy=null}}__watchMetaData(expression,callback){const type=expression.getType();if(type!==TcHmi.SymbolType.Server&&type!==TcHmi.SymbolType.Package)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_NOT_SUPPORTED,details:{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],reason:expression.toString()+": Symbols of type '"+TcHmi.SymbolType[type]+"' do not support meta data.",domain:"TcHmi.System.Symbol"},expression:this.getExpression(),expressionResolved:expression}),()=>{};const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Failed to resolve name from expression.",domain:"TcHmi.System.Symbol"},expression:this.getExpression(),expressionResolved:expression}),()=>{};if(type===TcHmi.SymbolType.Server){let baseName=resolveServerSymbolNameParts(name).name,destroyEvent=TcHmi.EventProvider.register("System.onServerSymbolMetaDataChanged<"+baseName+">",(e,data)=>{TcHmi.Callback.callSafeEx(callback,this,data.entryNew)});return this.__resolveMetaData(expression,data=>{TcHmi.Callback.callSafeEx(callback,this,data)}),()=>{destroyEvent()}}if(type===TcHmi.SymbolType.Package){const mapping=packageSymbolManager.get(name);if(!mapping)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): No mapping was found.",domain:"TcHmi.System.Symbol"},expressionResolved:expression,expression:this.getExpression(),destroy:()=>{}}),()=>{};if(!mapping.symbol)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Mapping symobl is not defined.",domain:"TcHmi.System.Symbol"},expression:this.getExpression(),expressionResolved:expression,destroy:()=>{}}),()=>{};if(!TcHmi.Symbol.isSymbolExpression(mapping.symbol))return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Mapping symobl is not a valid symbol expression.",domain:"TcHmi.System.Symbol"},expression:this.getExpression(),expressionResolved:expression}),()=>{};let mappingSymbol;try{let mappingSymbolExpression=new TcHmi.SymbolExpression(mapping.symbol),mappingSymbolExpressionPrepared=SymbolTypePackage.ResolveMappingSymbolExpression(expression,mappingSymbolExpression);mappingSymbol=new Symbol(mappingSymbolExpressionPrepared);let destroyMetaDataWatch=mappingSymbol.watchMetaData(callback);return()=>{destroyMetaDataWatch?.(),mappingSymbol?.destroy()}}catch(e){return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): An exception occured while trying to parse the mapping symbol '"+mapping.symbol+"'.",exception:e,domain:"SystemSymbolHelper"},expression:this.getExpression(),expressionResolved:expression}),()=>{mappingSymbol?.destroy()}}}return()=>{}}read(callback){let diagGUID="";return(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read called."),this.readEx(null,callback)}readEx(options,callback){let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression()+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] __readEx called nwith:",{options});let destroyRead=null,destroyResolveExpression=this.resolveExpression(data=>{if(data.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:data.expression};return data.details&&(res.details.errors=[data.details]),void TcHmi.Callback.callSafeEx(callback,this,res)}if(!data.value)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:data.expression});let expression=data.value,destroy=this.__read(expression,options,callback);destroyRead=()=>{Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] readEx destroy called."),destroy&&destroy()}});return()=>{destroyRead?.(),destroyResolveExpression?.()}}__read(expression,options,callback){let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] __read called nwith:",{expression,options});let destroy=null;switch(expression.getType()){case TcHmi.SymbolType.Server:destroy=this.__symbolTypeServer.read(expression,options,data=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",{data}),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.Internal:this.__symbolTypeInternal.read(expression,options,data=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",{data}),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.LocalizedText:this.__symbolTypeLocalizedText.read(expression,options,data=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",{data}),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.Function:this.__symbolTypeFunction.read(expression,options,data=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",{data}),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.Control:this.__symbolTypeControl.read(expression,options,data=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",{data}),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.PartialParam:this.__symbolTypePartialParam.read(expression,options,data=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",{data}),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.TemplateParam:this.__symbolTypeTemplateParam.read(expression,options,data=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",{data}),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.Context:this.__symbolTypeContext.read(expression,options,data=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",{data}),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.ThemedResource:this.__symbolTypeThemedResource.read(expression,data=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",{data}),TcHmi.Callback.callSafe(callback,this,data)});break;case TcHmi.SymbolType.Timer:this.__symbolTypeTimer.read(expression,options,data=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",{data}),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.Package:this.__symbolTypePackage.read(expression,options,data=>{TcHmi.Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__expression.toString()+" (Resolved to: '"+expression.toString()+"')",", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",{data}),TcHmi.Callback.callSafeEx(callback,this,data)});break;default:{let res={error:TcHmi.Errors.E_NOT_SUPPORTED,details:{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],reason:this.__printExpression(expression)+": Failed to read from unsupported symbol type",domain:"TcHmi.System.Symbol"},expression:this.__expression,expressionResolved:expression};Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] read finished with:",res),TcHmi.Callback.callSafeEx(callback,this,res)}}return destroy}write(value,callback){let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression()+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] write called with:",{value});let destroy=this.writeEx(value,void 0,callback);return()=>{destroy&&destroy()}}writeEx(value,dirtyPaths,callback){let diagGUID="";return(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression()+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx called with:",{value,dirtyPaths}),this.writeEx2(value,null,dirtyPaths,callback)}writeEx2(value,options,dirtyPaths,callback){let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression()+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx2 called with:",{value,options,dirtyPaths});let destroyResolveExpression=this.resolveExpression(data=>{if(data.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:this.__expression};return data.details&&(res.details.errors=[data.details]),void TcHmi.Callback.callSafeEx(callback,this,res)}if(!data.value)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:this.__expression});let expression=data.value,destroy=this.__write(expression,value,options,dirtyPaths,callback);return()=>{Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx destroy called."),destroy&&destroy()}});return()=>{destroyResolveExpression?.()}}__write(expression,value,options,dirtyPaths,callback){let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] __write called with:",{expression,value,options,dirtyPaths}),null===dirtyPaths&&(dirtyPaths=void 0);let destroy=null;switch(expression.getType()){case TcHmi.SymbolType.Server:destroy=this.__symbolTypeServer.write(expression,value,options,dirtyPaths,(data,meta)=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished with:",{data}),meta&&meta.equal&&Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished without error because of data equality."),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.Internal:this.__symbolTypeInternal.write(expression,value,options,dirtyPaths,(data,meta)=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished with:",{data}),meta&&meta.equal&&Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished without error because of data equality."),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.LocalizedText:{let res={error:TcHmi.Errors.E_SYMBOL_READONLY,details:{code:TcHmi.Errors.E_SYMBOL_READONLY,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_READONLY],reason:this.__printExpression(expression)+": LocalizedText symbols are readonly.",domain:"TcHmi.System.Symbol"},expression:this.__expression,expressionResolved:expression};Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished with:",res),TcHmi.Callback.callSafeEx(callback,this,res)}break;case TcHmi.SymbolType.Function:{let res={error:TcHmi.Errors.E_SYMBOL_READONLY,details:{code:TcHmi.Errors.E_SYMBOL_READONLY,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_READONLY],reason:this.__printExpression(expression)+": Function symbols are readonly.",domain:"TcHmi.System.Symbol"},expression:this.__expression,expressionResolved:expression};Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished with:",res),TcHmi.Callback.callSafeEx(callback,this,res)}break;case TcHmi.SymbolType.Control:this.__symbolTypeControl.write(expression,value,options,dirtyPaths,(data,meta)=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished with:",{data}),meta&&meta.equal&&Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished without error because of data equality."),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.PartialParam:this.__symbolTypePartialParam.write(expression,value,options,dirtyPaths,(data,meta)=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished with:",{data}),meta&&meta.equal&&Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished without error because of data equality."),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.TemplateParam:this.__symbolTypeTemplateParam.write(expression,value,options,dirtyPaths,(data,meta)=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished with:",{data}),meta&&meta.equal&&Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished without error because of data equality."),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.ThemedResource:{let res={error:TcHmi.Errors.E_SYMBOL_READONLY,details:{code:TcHmi.Errors.E_SYMBOL_READONLY,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_READONLY],reason:this.__printExpression(expression)+": Themed resource symbols are readonly.",domain:"TcHmi.System.Symbol"},expression:this.__expression,expressionResolved:expression};Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished with:",res),TcHmi.Callback.callSafe(callback,this,res)}break;case TcHmi.SymbolType.Context:this.__symbolTypeContext.write(expression,value,options,dirtyPaths,(data,meta)=>{Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished with:",{data}),meta&&meta.equal&&Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished without error because of data equality."),TcHmi.Callback.callSafeEx(callback,this,data)});break;case TcHmi.SymbolType.Package:destroy=this.__symbolTypePackage.write(expression,value,options,dirtyPaths,(data,meta)=>{TcHmi.Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__expression.toString()+" (Resolved to: '"+expression.toString()+"')",", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished with:",{data}),meta&&meta.equal&&TcHmi.Log.debug("[Source=Framework, Module=SystemSymbol, Expression="+this.__expression.toString()+" (Resolved to: '"+expression.toString()+"'), ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] writeEx finished without error because of data equality."),TcHmi.Callback.callSafeEx(callback,this,data)});break;default:{let res={error:TcHmi.Errors.E_NOT_SUPPORTED,details:{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],reason:this.__printExpression(expression)+": Failed to write unsupported symbol type",domain:"TcHmi.System.Symbol"},expression:this.__expression,expressionResolved:expression};TcHmi.Callback.callSafeEx(callback,this,res)}}return destroy}watch(callback){let diagGUID="";return(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression()+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch called."),this.watchEx(null,callback)}watchEx(options,callback,reason){let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression()+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watchEx called with:",{options});let destroyWatch=null,destroyWatchExpression=this.watchExpression(data=>{if(data.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION],reason:this.__printExpression()+": Failed to watch and resolve the expression.",domain:"TcHmi.System.Symbol"},expression:this.__expression};return data.details&&(res.details.errors=[data.details]),void TcHmi.Callback.callSafeEx(callback,this,res)}if(!data.value)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression()+": Failed to watch the expression.",domain:"TcHmi.System.Symbol"},expression:this.__expression});let expression=data.value;destroyWatch&&(destroyWatch(),destroyWatch=null),destroyWatch=this.__watch(expression,options,callback)});return()=>{destroyWatch?.(),destroyWatchExpression?.()}}__watch(expression,options,callback,reason){let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] __watch called with:",{expression,options});let destroy=()=>{};switch(expression.getType()){case TcHmi.SymbolType.Server:destroy=this.__symbolTypeServer.watch(expression,options,callback);break;case TcHmi.SymbolType.Internal:destroy=this.__symbolTypeInternal.watch(expression,options,callback);break;case TcHmi.SymbolType.LocalizedText:destroy=this.__symbolTypeLocalizedText.watch(expression,options,callback);break;case TcHmi.SymbolType.Function:destroy=this.__symbolTypeFunction.watch(expression,options,callback);break;case TcHmi.SymbolType.Control:return destroy=this.__symbolTypeControl.watch(expression,options,callback),destroy;case TcHmi.SymbolType.PartialParam:destroy=this.__symbolTypePartialParam.watch(expression,options,callback);break;case TcHmi.SymbolType.TemplateParam:destroy=this.__symbolTypeTemplateParam.watch(expression,options,callback);break;case TcHmi.SymbolType.Context:destroy=this.__symbolTypeContext.watch(expression,options,callback);break;case TcHmi.SymbolType.ThemedResource:destroy=this.__symbolTypeThemedResource.watch(expression,options,callback);break;case TcHmi.SymbolType.Timer:destroy=this.__symbolTypeTimer.watch(expression,options,callback);break;case TcHmi.SymbolType.Package:destroy=this.__symbolTypePackage.watch(expression,options,callback);break;default:{let res={error:TcHmi.Errors.E_NOT_SUPPORTED,details:{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],reason:this.__printExpression(expression)+': SymbolType: "'+this.__expression.getType()+'" does not support watching.',domain:"TcHmi.System.Symbol"},expression:this.__expression,expressionResolved:expression,destroy};Log.debugEx("[Source=Framework, Module=SystemSymbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__diagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this,res)}}return destroy}static isServerSymbol(checkSymbol){return!!checkSymbol.getExpression()&&checkSymbol.getExpression().getType()===TcHmi.SymbolType.Server}static isInternalSymbol(checkSymbol){return!!checkSymbol.getExpression()&&checkSymbol.getExpression().getType()===TcHmi.SymbolType.Internal}static isLocalizedTextSymbol(checkSymbol){return!!checkSymbol.getExpression()&&checkSymbol.getExpression().getType()===TcHmi.SymbolType.LocalizedText}static isPartialParamSymbol(checkSymbol){return!!checkSymbol.getExpression()&&checkSymbol.getExpression().getType()===TcHmi.SymbolType.PartialParam}static isTemplateParamSymbol(checkSymbol){return!!checkSymbol.getExpression()&&checkSymbol.getExpression().getType()===TcHmi.SymbolType.TemplateParam}static isFunctionSymbol(checkSymbol){return!!checkSymbol.getExpression()&&checkSymbol.getExpression().getType()===TcHmi.SymbolType.Function}static isControlSymbol(checkSymbol){return!!checkSymbol.getExpression()&&checkSymbol.getExpression().getType()===TcHmi.SymbolType.Control}static isContextSymbol(checkSymbol){return!!checkSymbol.getExpression()&&checkSymbol.getExpression().getType()===TcHmi.SymbolType.Context}static isThemedResourceSymbol(checkSymbol){return!!checkSymbol.getExpression()&&checkSymbol.getExpression().getType()===TcHmi.SymbolType.ThemedResource}static isTimerSymbol(checkSymbol){return!!checkSymbol.getExpression()&&checkSymbol.getExpression().getType()===TcHmi.SymbolType.Timer}static isPackageSymbol(checkSymbol){return!!checkSymbol.getExpression()&&checkSymbol.getExpression().getType()===TcHmi.SymbolType.Package}exists(callback){this.resolveExpression(data=>{if(data.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_EXPRESSION],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:data.expression,expressionResolved:data.expressionResolved};return data.details&&(res.details.errors=[data.details]),void TcHmi.Callback.callSafeEx(callback,this,res)}if(!data.value)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression()+": Failed to resolve the expression.",domain:"TcHmi.System.Symbol"},expression:data.expression,expressionResolved:data.expressionResolved});let expression=data.value;if(Symbol.isFunctionSymbol(this))TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!0,expressionResolved:expression,expression:this.getExpression()});else{if(Symbol.isLocalizedTextSymbol(this)){let name,localizationNamespace="TcHmi.System.Localization.Application",pathTokens=tchmi_clone_object(expression.getPathTokens());if(pathTokens&&0!==pathTokens.length){let namespaceToken=expression.getName();if(!namespaceToken)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()});if(namespaceToken.startsWith("Control")){if(2!==pathTokens.length)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()});localizationNamespace="TcHmi.System.Localization.Control<"+pathTokens.shift()+">",name=pathTokens.shift()}else if(namespaceToken.startsWith("Function")){if(2!==pathTokens.length)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()});localizationNamespace="TcHmi.System.Localization.Function<"+pathTokens.shift()+">",name=pathTokens.shift()}else if(namespaceToken.startsWith("Package")){if(2!==pathTokens.length)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()});localizationNamespace="TcHmi.System.Localization.Package<"+pathTokens.shift()+">",name=pathTokens.shift()}else if(namespaceToken.startsWith("Framework")){if(1!==pathTokens.length)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()});localizationNamespace="TcHmi.System.Localization.Framework",name=pathTokens.shift()}else{if(!namespaceToken.startsWith("Application"))return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()});if(1!==pathTokens.length)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()});localizationNamespace="TcHmi.System.Localization.Application",name=pathTokens.shift()}}else name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()});let ns=localizationManager.get(localizationNamespace);if(ns){let localization=ns.getLocalization();if(localization&&void 0!==localization[name]&&null!==localization[name])return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!0,expressionResolved:expression,expression:this.getExpression()})}return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()})}this.read(data=>{if(data.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()});if(!Symbol.isServerSymbol(this)||!("response"in data))return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!0,expressionResolved:expression,expression:this.getExpression()});const response=data.response;if(response&&response.commands&&response.commands.length>0){return response.commands[0].error?void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()}):void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!0,expressionResolved:expression,expression:this.getExpression()})}TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:!1,expressionResolved:expression,expression:this.getExpression()})})}})}}
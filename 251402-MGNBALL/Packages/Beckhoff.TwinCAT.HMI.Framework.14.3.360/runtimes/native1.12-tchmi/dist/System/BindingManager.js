import{Binding,State as BindingState}from"./Binding.js";import{controlManager}from"./ControlManager.js";import{Log}from"../API/Log.js";let BindingManager=(()=>{var _a;let ___onBindingWatchState_decorators,_instanceExtraInitializers=[];return class{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___onBindingWatchState_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],__esDecorate(this,null,___onBindingWatchState_decorators,{kind:"method",name:"__onBindingWatchState",static:!1,private:!1,access:{has:obj=>"__onBindingWatchState"in obj,get:obj=>obj.__onBindingWatchState},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){}__bindingsByControl=(__runInitializers(this,_instanceExtraInitializers),new WeakMap);__bindingsPreloading=new Set;__bindingsPreloadingByPartial=new Map;__bindingsPreloadingByControl=new Map;__watchStateDestroyByBinding=new WeakMap;__watcherPreloadingBindings=new Set;__watcherPreloadingBindingsByPartial=new Set;__watcherPreloadingBindingsByControl=new Set;__onBindingWatchState(data){let partial=data.binding.getPartial();if(!partial)return;let control=data.binding.getControl();if(!control)return;let proc=(partial,control)=>{if(data.state===BindingState.Initialized||data.state===BindingState.Error){let bProcPreloading=!1,bProcPreloadingByPartial=!1,bProcPreloadingByControl=!1;this.__bindingsPreloading.has(data.binding)&&(this.__bindingsPreloading.delete(data.binding),bProcPreloading=!0);let bindingsPreloadingByPartial=this.__bindingsPreloadingByPartial.get(partial);bindingsPreloadingByPartial&&(bindingsPreloadingByPartial.delete(data.binding),0===bindingsPreloadingByPartial.size&&this.__bindingsPreloadingByPartial.delete(partial),bProcPreloadingByPartial=!0);let bindingsPreloadingByControl=this.__bindingsPreloadingByControl.get(control);bindingsPreloadingByControl&&(bindingsPreloadingByControl.delete(data.binding),0===bindingsPreloadingByControl.size&&this.__bindingsPreloadingByControl.delete(control),bProcPreloadingByControl=!0),bProcPreloading&&this.__procWatchPreloadingBindingDone(data.binding),bProcPreloadingByPartial&&this.__procWatchPreloadingBindingDoneByPartial(data.binding),bProcPreloadingByControl&&this.__procWatchPreloadingBindingDoneByControl(data.binding),data.destroy?.(),this.__watchStateDestroyByBinding.delete(data.binding)}};if(proc(partial,control),"TcHmi.Controls.System.TcHmiUserControl"===partial.getType()){let parent=partial.getParent();for(;null!==parent;){let parentType=parent.getType();"TcHmi.Controls.System.TcHmiView"!==parentType&&"TcHmi.Controls.System.TcHmiContent"!==parentType||proc(parent,control),parent=parent.getParent()}}}__procWatchPreloadingBindingDone(b){for(const watcher of this.__watcherPreloadingBindings.keys())TcHmi.Callback.callSafeEx(watcher.callback,this,{error:TcHmi.Errors.NONE,binding:b,destroy:watcher.destroy})}__procWatchPreloadingBindingDoneByPartial(b){for(const watcher of this.__watcherPreloadingBindingsByPartial.keys())TcHmi.Callback.callSafeEx(watcher.callback,this,{error:TcHmi.Errors.NONE,binding:b,destroy:watcher.destroy})}__procWatchPreloadingBindingDoneByControl(b){for(const watcher of this.__watcherPreloadingBindingsByControl.keys())TcHmi.Callback.callSafeEx(watcher.callback,this,{error:TcHmi.Errors.NONE,binding:b,destroy:watcher.destroy})}getPreloadingBindings(){return new Set(this.__bindingsPreloading)}getPreloadingBindingsByPartial(partial){return new Set(this.__bindingsPreloadingByPartial.get(partial))}getPreloadingBindingsByControl(control){return new Set(this.__bindingsPreloadingByControl.get(control))}watchPreloadingBindingDone(callback){const destroy=()=>{watcher&&this.__watcherPreloadingBindings.delete(watcher)},watcher={callback,destroy};return this.__watcherPreloadingBindings.add(watcher),destroy}watchPreloadingBindingDoneByPartial(partial,callback){const destroy=()=>{watcher&&this.__watcherPreloadingBindingsByPartial.delete(watcher)},watcher={partial,callback,destroy};return this.__watcherPreloadingBindingsByPartial.add(watcher),destroy}watchPreloadingBindingDoneByControl(control,callback){const destroy=()=>{watcher&&this.__watcherPreloadingBindingsByControl.delete(watcher)},watcher={control,callback,destroy};return this.__watcherPreloadingBindingsByControl.add(watcher),destroy}getBinding(propertyName,control){let res=null,controlMap=this.__bindingsByControl.get(control);if(void 0===controlMap)return res;if(!controlManager.getAttributeByPropertyName(control,propertyName))return res;let b=controlMap.get(propertyName);return void 0===b||(res=b),res}getBindingsByControl(control){return this.__bindingsByControl.get(control)}createBinding(expression,propertyName,control,options){this.removeBinding(propertyName,control,!1);let controlMap=this.__bindingsByControl.get(control);void 0===controlMap&&(controlMap=new Map,this.__bindingsByControl.set(control,controlMap));let b=new Binding(expression,propertyName,control,options);if(b.getPreload()){this.__bindingsPreloading.add(b);let bindingsPreloadingByPartial,partial=b.getPartial();partial&&(bindingsPreloadingByPartial=this.__bindingsPreloadingByPartial.get(partial),bindingsPreloadingByPartial||(bindingsPreloadingByPartial=new Set,this.__bindingsPreloadingByPartial.set(partial,bindingsPreloadingByPartial)),bindingsPreloadingByPartial.add(b));let bindingsPreloadingByControl=this.__bindingsPreloadingByControl.get(control);bindingsPreloadingByControl||(bindingsPreloadingByControl=new Set,this.__bindingsPreloadingByControl.set(control,bindingsPreloadingByControl)),bindingsPreloadingByControl.add(b);let destroyWatch=b.watchState(this.__onBindingWatchState);this.__watchStateDestroyByBinding.set(b,destroyWatch)}return controlMap.set(propertyName,b),b.__resume(),b}removeBinding(propertyName,control,bResetSetter=!0){let controlMap=this.__bindingsByControl.get(control);if(void 0===controlMap)return;let attr=controlManager.getAttributeByPropertyName(control,propertyName);if(!attr)return;let b=controlMap.get(propertyName);if(!b)return;controlMap.delete(propertyName),0===controlMap.size&&this.__bindingsByControl.delete(control),b.destroy();let destroyWatchState=this.__watchStateDestroyByBinding.get(b);destroyWatchState&&(destroyWatchState(),destroyWatchState=void 0);let partial=b.getPartial();if(partial){let bindingsPreloadingByPartial=this.__bindingsPreloadingByPartial.get(partial);bindingsPreloadingByPartial&&(bindingsPreloadingByPartial.delete(b),0===bindingsPreloadingByPartial.size&&this.__bindingsPreloadingByPartial.delete(partial),this.__procWatchPreloadingBindingDoneByPartial(b))}let bindingsPreloadingByControl=this.__bindingsPreloadingByControl.get(control);if(bindingsPreloadingByControl&&(bindingsPreloadingByControl.delete(b),0===bindingsPreloadingByControl.size&&this.__bindingsPreloadingByControl.delete(control),this.__procWatchPreloadingBindingDoneByControl(b)),this.__bindingsPreloading.has(b)&&(this.__bindingsPreloading.delete(b),this.__procWatchPreloadingBindingDone(b)),bResetSetter){let error;try{error=controlManager.setControlPropertyByAttribute(control,attr,null)}catch(e){Log.errorEx("[Source=Framework, Module=TcHmi.System.BindingManager] An uncaught exception occurred in setter function of attribute with propertyName="+propertyName+" of control="+control?.getId()+":\n",e)}error&&error.code!==TcHmi.Errors.NONE&&Log.error("[Source=Framework, Module=TcHmi.System.BindingManager] "+Log.buildMessage(error))}}}})();export{BindingManager};export const bindingManager=new BindingManager;
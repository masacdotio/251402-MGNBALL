import{Log}from"../API/Log.js";import{getSchema}from"../API/Type.js";import{firstLoadAfterPublish}from"../Main.js";import{hostPrefix}from"./System.js";import{resolveDefault}from"./Type.Schema.js";export class InternalSymbolManager{constructor(){}__entries=new Map;add(name,item){const entryEx={callbacks:[],...item};if(this.__entries.set(name,entryEx),void 0===entryEx.value){let schema=getSchema(item.type);schema&&(entryEx.value=resolveDefault(schema))}const fullName=hostPrefix+"TcHmi.System.InternalSymbolManager.symbol:"+name;if(!entryEx.persist||firstLoadAfterPublish&&!TCHMI_LIVEVIEW)window.localStorage.removeItem(fullName);else{const savedValue=window.localStorage.getItem(fullName);if(null!==savedValue)try{entryEx.value=JSON.parse(savedValue)}catch(e){}}}remove(name){this.__entries.delete(name)}update(name,item){let entry=this.__entries.get(name);if(!entry)return void this.add(name,item);let refresh=!1;tchmi_equal(entry.type,item.type)||(entry.type=item.type,refresh=!0);let value=item.value;if(void 0===value){let schema=getSchema(item.type);schema&&(value=resolveDefault(schema))}if(tchmi_equal(entry.value,value)||(entry.value=value,refresh=!0),tchmi_equal(entry.persist,item.persist)||(entry.persist=item.persist,refresh=!0,item.persist||window.localStorage.removeItem(hostPrefix+"TcHmi.System.InternalSymbolManager.symbol:"+name)),tchmi_equal(entry.readonly,item.readonly)||(entry.readonly=item.readonly,refresh=!0),refresh){let callbackList=Array.from(entry.callbacks);for(let innerCallback of callbackList)entry.callbacks.includes(innerCallback)&&TcHmi.Callback.callSafeEx(innerCallback.callback,this,{error:TcHmi.Errors.NONE,value:entry.value,destroy:innerCallback.destroy})}}get(name){return this.__entries.get(name)}write(name,value,dirtyPaths,callback){let entry=this.__entries.get(name);if(entry)if(entry.readonly)TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_READONLY,details:{code:TcHmi.Errors.E_SYMBOL_READONLY,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_READONLY],reason:"Internal symbol with name="+name+" is readonly.",domain:"TcHmi.System.InternalSymbolManager"}});else if(tchmi_equal(entry.value,value))TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE});else{null===dirtyPaths&&(dirtyPaths=void 0);let dirtyPathsNew=null;if(dirtyPaths&&dirtyPaths.length>0?dirtyPathsNew=Array.from(dirtyPaths):entry.value&&value&&"object"==typeof entry.value&&"object"==typeof value&&(dirtyPathsNew=tchmi_compare_object(entry.value,value)),entry.value=value,entry.persist)try{window.localStorage.setItem(hostPrefix+"TcHmi.System.InternalSymbolManager.symbol:"+name,JSON.stringify(entry.value))}catch(e){Log.errorEx(`[Source=Framework, Module=TcHmi.System.InternalSymbolManager] An exception occurred while persisting symbol ${name}:\n`,e)}let callbackList=Array.from(entry.callbacks);for(let innerCallback of callbackList)entry.callbacks.includes(innerCallback)&&TcHmi.Callback.callSafeEx(innerCallback.callback,this,dirtyPathsNew&&dirtyPathsNew.length>0?{error:TcHmi.Errors.NONE,value:entry.value,dirtyPaths:dirtyPathsNew,destroy:innerCallback.destroy}:{error:TcHmi.Errors.NONE,value:entry.value,destroy:innerCallback.destroy});TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})}else TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Internal symbol with name="+name+" does not exist.",domain:"TcHmi.System.InternalSymbolManager"}})}read(name,callback){let entry=this.__entries.get(name);entry?TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,value:entry.value}):TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Internal symbol with name="+name+" does not exist.",domain:"TcHmi.System.InternalSymbolManager"}})}getType(name,callback){let entry=this.__entries.get(name);entry?TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,type:entry.type}):TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Internal symbol with name="+name+" does not exist.",domain:"TcHmi.System.InternalSymbolManager"}})}watch(name,callback){let entry=this.__entries.get(name);if(!entry)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:"Internal symbol with name="+name+" does not exist.",domain:"TcHmi.System.InternalSymbolManager"}}),function(){};let destroy=function(){if(!entry)return;let index=entry.callbacks.indexOf(co);-1!==index&&(entry.callbacks.splice(index,1),co.callback=null),entry=void 0},co={callback,destroy};return entry.callbacks.push(co),TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,value:entry.value,destroy}),destroy}}export const internalSymbolManager=new InternalSymbolManager;
import{Symbol as SystemSymbol}from"./Symbol.js";import{resolveQualifiedName}from"./SystemFunctions.js";import{typeManager}from"./Type.TypeManager.js";import*as ValueConverter from"../API/ValueConverter.js";import{SymbolExpression}from"../API/SymbolExpression.js";import{Data}from"./System.js";import"./acornSymbolExpressionExtension.js";import{gIsolatedEval_TcHmi_System_FunctionExpression,gIsolatedEval_TcHmi_System_FunctionExpression_Results}from"./EvalIsolation.js";var ReferenceHandlingType;!function(ReferenceHandlingType){ReferenceHandlingType[ReferenceHandlingType.None=0]="None",ReferenceHandlingType[ReferenceHandlingType.Symbol=1]="Symbol",ReferenceHandlingType[ReferenceHandlingType.Generic=2]="Generic"}(ReferenceHandlingType||(ReferenceHandlingType={}));export class FunctionExpression extends TcHmi.Destroyable{__error;__originalAst;__expression;__ctxWatchMode;__enableWatchMode;__functionCallExpressions=[];__symbolExpressions=[];__forcedSymbolOptions;__symbolExpressionsMetaData=new Map;__watchSymbols=new Map;__callbacks=[];__processedWaitMode;__currentWatch={ctx:void 0,isInitialized:!1,isReady:!1,needsExecution:!0,hasPendingExecution:!1};__toDestroy=[];constructor(functionExpression,options){super(),this.__expression=functionExpression,this.__ctxWatchMode=options?.watchMode?.ctx??void 0,this.__enableWatchMode=options?.watchMode?.enable??!1,this.__forcedSymbolOptions=options?.forcedSymbolOptions??null;try{this.__originalAst=acorn.parse(functionExpression,{plugins:{symbolExpression:{onSymbolExpression:this.__symbolExpressions,onCallExpression:callExpression=>{let functionName=this.__resolveCallExpressionName(callExpression.callee);const module=Data.Modules.functions.map.get(functionName);if(module)if(module.error===TcHmi.Errors.NONE){let fnDescr=module.description,argoffset=0;if(!fnDescr){let error={code:TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION],reason:`Target function expression: "${this.__expression}". Missing description file (*.function.json) for function with registered name: "${functionName}".`,domain:"TcHmi.System.FunctionExpression"};this.__error?this.__error.errors?this.__error.errors.push(error):this.__error.errors=[error]:this.__error={code:TcHmi.Errors.E_FUNCTION_EXPRESSION_PARSER_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_EXPRESSION_PARSER_ERROR],reason:`At least one error occurred while parsing the function expression: "${this.__expression}"`,domain:"TcHmi.System.FunctionExpression",errors:[error]}}if(fnDescr&&!fnDescr.function){let error={code:TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION],reason:`Target function expression: "${this.__expression}", Invalid description file(*.function.json) for function with registered name: "${functionName}". Missing  property: "function".`,domain:"TcHmi.System.FunctionExpression"};this.__error?this.__error.errors?this.__error.errors.push(error):this.__error.errors=[error]:this.__error={code:TcHmi.Errors.E_FUNCTION_EXPRESSION_PARSER_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_EXPRESSION_PARSER_ERROR],reason:`At least one error occurred while parsing the function expression: "${this.__expression}"`,domain:"TcHmi.System.FunctionExpression",errors:[error]}}if(fnDescr&&fnDescr.function&&!0===fnDescr.function.injectContextObject&&argoffset++,fnDescr&&fnDescr.function&&void 0!==callExpression.arguments&&null!==callExpression.arguments)for(let i=0,ii=callExpression.arguments.length;i<ii;i++)if("SymbolExpression"===callExpression.arguments[i].type&&fnDescr&&fnDescr.function&&fnDescr.function.arguments){let descr;if(i+argoffset<fnDescr.function.arguments.length?descr=fnDescr.function.arguments[i+argoffset]:(descr=fnDescr.function.arguments[fnDescr.function.arguments.length-1],!0!==descr.restParameter&&(descr=void 0)),descr){let typeSchema=typeManager.getSchema(descr.type);if(typeSchema&&"TcHmi.Symbol"===typeSchema.frameworkInstanceOf){let expr=callExpression.arguments[i];this.__symbolExpressionsMetaData.set(expr,{options:{passAsSymbol:!0,allowSymbolReferenceWatchDelegation:descr.allowSymbolReferenceWatchDelegation??!1}})}}}this.__functionCallExpressions.push(callExpression)}else this.__error||(this.__error={code:TcHmi.Errors.E_FUNCTION_EXPRESSION_PARSER_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_EXPRESSION_PARSER_ERROR],reason:`At least one error occurred while parsing the function expression: "${this.__expression}"`,domain:"TcHmi.System.FunctionExpression"}),module.errorDetails&&(this.__error.errors?this.__error.errors.push(module.errorDetails):this.__error.errors=[module.errorDetails])}}}})}catch(ex){let error={code:TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION],reason:`An uncaught exception occurred executing target function expression: "${this.__expression}"`,exception:ex,domain:"TcHmi.System.FunctionExpression"};const acornException=ex;acornException instanceof Error&&acornException.loc&&acornException.loc.line&&"number"==typeof acornException.loc.column&&(error.reason="An uncaught exception occurred executing target function JavaScript expression: \n",error.reason+=this.__expression.split("\n").slice(acornException.loc.line-1,acornException.loc.line)[0],error.reason+="\n"+" ".repeat(acornException.loc.column)+"^ "+ex.message),this.__error?this.__error.errors?this.__error.errors.push(error):this.__error.errors=[error]:this.__error={code:TcHmi.Errors.E_FUNCTION_EXPRESSION_PARSER_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_EXPRESSION_PARSER_ERROR],reason:`At least one error occurred while parsing the function expression: "${this.__expression}"`,domain:"TcHmi.System.FunctionExpression",errors:[error]}}if(this.__enableWatchMode&&!this.__error)try{this.__initializeWatch()}catch(ex){this.__error={code:TcHmi.Errors.E_FUNCTION_EXPRESSION_PARSER_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_EXPRESSION_PARSER_ERROR],reason:`At least one error occurred while parsing the function expression: "${this.__expression}"`,domain:"TcHmi.System.FunctionExpression",exception:ex}}}__resolveCallExpressionName(expression){let res="";return"MemberExpression"===expression.type?(res+=this.__resolveCallExpressionName(expression.object),res+=".",res+=this.__resolveCallExpressionName(expression.property)):"Identifier"===expression.type&&(res+=expression.name),res}__initializeWatch(){if(this.__currentWatch.isInitialized)return;this.__currentWatch.isInitialized=!0;let watchSymbolsByExpression=new Map,watchStarted=!1,restartRequired=!1,watchSymbolExpressions=()=>{watchStarted||(watchStarted=!0,watchSymbolsByExpression.forEach((watchSymbols,expression)=>{let destroySymbolWatch=null,refs=watchSymbols.size,destroy=()=>{refs--,refs>0||(destroySymbolWatch?.(),destroySymbolWatch=null)};watchSymbols.forEach(watchObj=>{watchObj.destroy.symbolWatch=destroy});let symbol=new TcHmi.Symbol({expression,ctx:this.__ctxWatchMode});destroySymbolWatch=symbol.watch(data=>{watchSymbols&&(watchSymbols.forEach(watchObj=>{data.error===TcHmi.Errors.NONE?(watchObj.value=data.value,watchObj.error=null,watchObj.details=void 0):(watchObj.value=null,watchObj.error=data.error,watchObj.details=data.details),watchObj.ready=!0}),this.__currentWatch.needsExecution=!0,this.__doWatchExecute())})}))},pending=this.__symbolExpressions.length,done=()=>{pending>0&&pending--,pending>0||(restartRequired&&(watchSymbolsByExpression.forEach((watchSymbols,expression)=>{watchSymbols.forEach(watchObj=>{watchObj.destroy.symbolWatch?.(),watchObj.destroy.symbolWatch=void 0})}),watchStarted=!1),watchSymbolExpressions(),this.__doWatchExecute())},addWatchSymbolExpression=(expression,watchSymbol)=>{let expressionStr=expression.toString();if(watchStarted){let removeableExpressions=new Set;watchSymbolsByExpression.forEach((watchSymbols,expression)=>{watchSymbols.has(watchSymbol)&&(watchSymbols.delete(watchSymbol),0===watchSymbols.size&&removeableExpressions.add(expression))}),removeableExpressions.forEach(expression=>{watchSymbolsByExpression.delete(expression),restartRequired=!0}),removeableExpressions.clear()}if(watchSymbolsByExpression.has(expressionStr)){let expressionWatchSymbols=watchSymbolsByExpression.get(expressionStr);if(expressionWatchSymbols&&!expressionWatchSymbols.has(watchSymbol)&&(expressionWatchSymbols.add(watchSymbol),watchStarted)){const[firstWatchSymbol]=expressionWatchSymbols;watchSymbol.value=firstWatchSymbol.value,watchSymbol.error=firstWatchSymbol.error,watchSymbol.details=firstWatchSymbol.details,watchSymbol.ready=firstWatchSymbol.ready}}else watchSymbolsByExpression.set(expressionStr,new Set([watchSymbol]))},processSymbolExpression=symbolExpression=>{let metaData=this.__symbolExpressionsMetaData.get(symbolExpression),key=`${symbolExpression.expression}_${symbolExpression.start}_${symbolExpression.end}`,symbol=new TcHmi.Symbol({expression:symbolExpression.expression,ctx:this.__ctxWatchMode}),watchSymbol={symbol,ref:symbol,expression:symbolExpression.expression,ready:!1,error:TcHmi.Errors.NONE,destroy:{}};this.__watchSymbols.set(key,watchSymbol),symbol.resolveSchema(data=>{if(data.error!==TcHmi.Errors.NONE)return watchSymbol.ready=!0,watchSymbol.error=data.error,watchSymbol.details=data.details,void done();if(!data.schema)return watchSymbol.ready=!0,watchSymbol.error=TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,void done();let referenceHandling=ReferenceHandlingType.None;metaData?.options.passAsSymbol?referenceHandling=ReferenceHandlingType.Symbol:"TcHmi.Symbol"===data.schema.frameworkInstanceOf&&data.expressionResolved&&(referenceHandling="Value"===data.expressionResolved.getOptions().ReferenceResolution?ReferenceHandlingType.Generic:ReferenceHandlingType.None),referenceHandling===ReferenceHandlingType.None?(addWatchSymbolExpression(symbol.getExpression(),watchSymbol),done()):watchSymbol.destroy.referenceWatch=symbol.watchReference(data=>{if(data.destroy&&!watchSymbol.destroy.referenceWatch&&(watchSymbol.destroy.referenceWatch=data.destroy),watchStarted&&(this.__currentWatch.needsExecution=!0),data.error!==TcHmi.Errors.NONE)return watchSymbol.ready=!0,watchSymbol.error=data.error,watchSymbol.details=data.details,void done();if(!data.ref)return watchSymbol.ready=!0,watchSymbol.error=TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,void done();switch(watchSymbol.ref=data.ref,referenceHandling){case ReferenceHandlingType.Symbol:watchSymbol.value=data.ref,watchSymbol.ready=!0,watchSymbol.error=TcHmi.Errors.NONE,done();break;case ReferenceHandlingType.Generic:addWatchSymbolExpression(data.ref.getExpression(),watchSymbol),done()}})})};if(pending>0)for(const symbolExpression of this.__symbolExpressions)processSymbolExpression(symbolExpression);else done()}__doWatchExecute(){if(!this.__currentWatch.isInitialized)return;if(this.__currentWatch.hasPendingExecution)return;if(!this.__currentWatch.isReady){let ready=!0;for(const watchObj of this.__watchSymbols.values())if(watchObj&&!watchObj.ready){ready=!1;break}if(!ready)return;this.__currentWatch.isReady=!0}let allowSymbolReferenceWatchDelegation=!1;for(const metaData of this.__symbolExpressionsMetaData.values())if(metaData.options.allowSymbolReferenceWatchDelegation){allowSymbolReferenceWatchDelegation=!0;break}if(this.__currentWatch.ctx&&this.__currentWatch.ctx.destroy&&this.__currentWatch.ctx.destroy(),this.__currentWatch.needsExecution){this.__currentWatch.hasPendingExecution=!0,this.__currentWatch.needsExecution=!1;let bContextLock=!1,ctx={...this.__ctxWatchMode,success:result=>{if(allowSymbolReferenceWatchDelegation)bContextLock=!1;else{if(bContextLock)return;bContextLock=!0}this.__currentWatch.result=result,this.__currentWatch.hasPendingExecution=!1;const callbackList=[...this.__callbacks];for(let co of callbackList)this.__callbacks.includes(co)&&(co.isDirty=!1,TcHmi.Callback.callSafeEx(co.callback,this,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(result),destroy:co.destroy}))},error:(error,details)=>{if(bContextLock)return;bContextLock=!0,this.__currentWatch.hasPendingExecution=!1;const callbackList=[...this.__callbacks];for(let co of callbackList)this.__callbacks.includes(co)&&(co.isDirty=!1,TcHmi.Callback.callSafeEx(co.callback,this,{error,details,destroy:co.destroy}))},delegatedWatch:allowSymbolReferenceWatchDelegation};this.__currentWatch.ctx=ctx,this.execute(ctx)}else if(this.__error){const callbackList=[...this.__callbacks];for(let co of callbackList)this.__callbacks.includes(co)&&co.isDirty&&(co.isDirty=!1,TcHmi.Callback.callSafeEx(co.callback,this,{error:this.__error.code,details:this.__error,destroy:co.destroy}))}else{const callbackList=[...this.__callbacks];for(let co of callbackList)this.__callbacks.includes(co)&&co.isDirty&&(co.isDirty=!1,TcHmi.Callback.callSafeEx(co.callback,this,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(this.__currentWatch.result),destroy:co.destroy}))}}execute(ctx,skipCallbackWithSyncValue=!1){if(this.__error)return ctx.error(this.__error.code,this.__error),{error:TcHmi.Errors.NONE};let resultsSymbolExpressions=[],resultsFunctionCallExpressions=[];if(TCHMI_DESIGNER){let abort=!1;if(this.__symbolExpressions)for(const symbolExpression of this.__symbolExpressions){let expr=new SymbolExpression(symbolExpression.expression);if(!expr||expr.getType()===TcHmi.SymbolType.Invalid){abort=!0;break}if(expr.getType()===TcHmi.SymbolType.Server){abort=!0;break}}if(abort)return ctx.success(null),{error:TcHmi.Errors.NONE}}let syncResultValue,subCtx1,subCtx2,subCtx3,destroySubCtx2,syncResultSet=!1,executeReturned=!1;ctx.destroy=()=>{destroySubCtx2&&(destroySubCtx2(),destroySubCtx2=void 0)};const resolveExpression=ctx=>{let result,expressionTokens=this.__expression.split("");for(let i=0,ii=this.__symbolExpressions.length;i<ii;i++){let expr=this.__symbolExpressions[i];if(expr&&!expr.handled){let fill=[];for(let j=0,jj=expr.end-expr.start;j<jj;j++)fill.push("");expressionTokens.splice(expr.start,expr.end-expr.start,...fill),expressionTokens[expr.start]="resSE["+i+"]"}}for(let i=0,ii=this.__functionCallExpressions.length;i<ii;i++){let expr=this.__functionCallExpressions[i];if(expr&&!expr.handled){let fill=[];for(let j=0,jj=expr.end-expr.start;j<jj;j++)fill.push("");expressionTokens.splice(expr.start,expr.end-expr.start,...fill),expressionTokens[expr.start]="resFCE["+i+"]"}}try{let s="";for(let j=0,jj=expressionTokens.length;j<jj;j++)s+=expressionTokens[j];result=gIsolatedEval_TcHmi_System_FunctionExpression_Results(s,resultsSymbolExpressions,resultsFunctionCallExpressions)}catch(ex){return void ctx.error(TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION,{code:TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION],reason:`An exception occurred executing target function expression: "${this.__expression}"`,domain:"TcHmi.System.FunctionExpression",exception:ex})}ctx.success(result)},resolveFunctionCallExpressions=ctx=>{let destroyFunctionWatchesFromSubCtx=new Map;ctx.destroy=()=>{destroyFunctionWatchesFromSubCtx.forEach((destroy,fce)=>{destroy&&destroy()}),destroyFunctionWatchesFromSubCtx.clear()};const resolveFunctionCallExpression=(ctx,callExpression)=>{if(!callExpression)return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__expression,domain:"TcHmi.System.FunctionExpression"});let subCtx,name=this.__resolveCallExpressionName(callExpression.callee),args=[],module=Data.Modules.functions.map.get(name);if(!module)return void ctx.error(TcHmi.Errors.E_MODULE_MISSING,{code:TcHmi.Errors.E_MODULE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_MODULE_MISSING],reason:this.__expression,domain:"TcHmi.System.FunctionExpression"});if(module.error!==TcHmi.Errors.NONE)return void ctx.error(TcHmi.Errors.E_MODULE_ERROR,{code:TcHmi.Errors.E_MODULE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_MODULE_ERROR],reason:this.__expression,domain:"TcHmi.System.FunctionExpression",errors:module.errorDetails?[module.errorDetails]:void 0});if(!module.description)return void ctx.error(TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_DESCRIPTION,{code:TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_DESCRIPTION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_DESCRIPTION],reason:this.__expression,domain:"TcHmi.System.FunctionExpression"});if(!module.reg||!module.reg.func)return void ctx.error(TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_REFERENCE,{code:TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_REFERENCE],reason:this.__expression,domain:"TcHmi.System.FunctionExpression"});let res,argoffset=0;if("Asynchronous"===module.description.function.waitMode){if(!0!==module.description.function.injectContextObject)return void ctx.error(TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION,{code:TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION],reason:`${this.__expression}: Invalid configuration for hmi function with name=${name}. Setting waitMode=Asynchronous and injectContextObject=${module.description.function.injectContextObject} is an invalid function configuration. Please define a context object if you want to use waitMode=Asynchronous.`,domain:"TcHmi.System.FunctionExpression"});{let bContextLock=!1;subCtx={success:result=>{if(ctx.delegatedWatch)bContextLock=!1;else{if(bContextLock)return;bContextLock=!0}ctx.success(result)},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details))},...ctx&&ctx.args?{args:ctx.args}:{},...ctx&&ctx.delegatedWatch?{delegatedWatch:ctx.delegatedWatch}:{}},args.unshift(subCtx),argoffset++}}else!0===module.description.function.injectContextObject&&(subCtx={...ctx&&ctx.args?{args:ctx.args}:{},...ctx&&ctx.delegatedWatch?{delegatedWatch:ctx.delegatedWatch}:{}},args.unshift(subCtx),argoffset++);for(let i=0,ii=callExpression.arguments.length;i<ii;i++){let descr=null;if(module&&module.error===TcHmi.Errors.NONE)if(i+argoffset<module.description.function.arguments.length)descr=module.description.function.arguments[i+argoffset];else if(descr=module.description.function.arguments[module.description.function.arguments.length-1],!0!==descr.restParameter)return void ctx.error(TcHmi.Errors.E_FUNCTION_RESTPARAMETER_DEFINITION_MISSING,{code:TcHmi.Errors.E_FUNCTION_RESTPARAMETER_DEFINITION_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_RESTPARAMETER_DEFINITION_MISSING],reason:`${this.__expression}: ${resolveQualifiedName(module.description.function.name,module.description.function.namespace)}: Got a value for a parameter without definition but last parameter is not configured as rest parameter.`,domain:"TcHmi.System.FunctionExpression"});if(!descr)return void ctx.error(TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION,{code:TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION],domain:"TcHmi.System.FunctionExpression"});let typeSchema=typeManager.getSchema(descr.type);if(!typeSchema)return void ctx.error(TcHmi.Errors.E_UNKNOWN_TYPE,{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:`${this.__expression}: ${resolveQualifiedName(module.description.function.name,module.description.function.namespace)}: Unknown schema: "${descr.type}".`,domain:"TcHmi.System.FunctionExpression"});let ceArgType=callExpression.arguments[i].type,ceArgStart=callExpression.arguments[i].start,ceArgEnd=callExpression.arguments[i].end,expression=this.__expression.substr(ceArgStart,ceArgEnd-ceArgStart),isSymbolExpression=TcHmi.Symbol.isSymbolExpression(expression),isSymbolExpressionEscaped=TcHmi.Symbol.isSymbolExpressionEscaped(expression);if(isSymbolExpression&&!isSymbolExpressionEscaped){let value;for(let j=0,jj=this.__symbolExpressions.length;j<jj;j++){let expr=this.__symbolExpressions[j],exprStart=expr.start,exprEnd=expr.end;if(exprStart>=ceArgStart&&exprEnd<=ceArgEnd){value=resultsSymbolExpressions[j],expr.handled=!0;break}}if("TcHmi.Symbol"===typeSchema.frameworkInstanceOf){if(!(value instanceof TcHmi.Symbol))return void ctx.error(TcHmi.Errors.E_TYPE_INVALID,{code:TcHmi.Errors.E_TYPE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_TYPE_INVALID],domain:"TcHmi.System.FunctionExpression"});args[i+argoffset]=value}else{let cvalue=ValueConverter.toSchemaType(value,typeSchema);if(null===cvalue&&null!==value)return void ctx.error(TcHmi.Errors.E_TYPE_INVALID,{code:TcHmi.Errors.E_TYPE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_TYPE_INVALID],reason:`${this.__expression}:Unable to cast value: "${value}" of type "${typeof value}" for parameter: "${descr.name}" of function: "${resolveQualifiedName(module.description.function.name,module.description.function.namespace)}" to type "${descr.type}".`,domain:"TcHmi.System.FunctionExpression"});args[i+argoffset]=cvalue}}else{let prepExpression=expression;isSymbolExpressionEscaped&&(prepExpression=TcHmi.Symbol.escapeSymbolExpression(prepExpression));let value,expressionTokens=prepExpression.split("");for(let j=0,jj=this.__symbolExpressions.length;j<jj;j++){let expr=this.__symbolExpressions[j],exprStart=expr.start,exprEnd=expr.end,exprStartFixed=exprStart-ceArgStart,exprEndFixed=exprStartFixed+(exprEnd-exprStart),resultsSymbolExpression=resultsSymbolExpressions[j];if(exprStart>=ceArgStart&&exprEnd<=ceArgEnd){for(let k=exprStartFixed,kk=exprEndFixed;k<kk;k++)expressionTokens[k]="";expressionTokens[exprStartFixed]="string"==typeof resultsSymbolExpression?`'${resultsSymbolExpression}'`:resultsSymbolExpression,expr.handled=!0}}for(let j=0,jj=this.__functionCallExpressions.length;j<jj;j++){let expr=this.__functionCallExpressions[j],exprStart=expr.start,exprEnd=expr.end,exprStartFixed=exprStart-ceArgStart,exprEndFixed=exprStartFixed+(exprEnd-exprStart),resultsFunctionCallExpression=resultsFunctionCallExpressions[j];if(exprStart>=ceArgStart&&exprEnd<=ceArgEnd){for(let k=exprStartFixed,kk=exprEndFixed;k<kk;k++)expressionTokens[k]="";expressionTokens[exprStartFixed]="string"==typeof resultsFunctionCallExpression?`'${resultsFunctionCallExpression}'`:resultsFunctionCallExpression,expr.handled=!0}}let s="";for(let j=0,jj=expressionTokens.length;j<jj;j++)s+=expressionTokens[j];"ObjectExpression"===ceArgType&&(s="("+s+")");try{value=gIsolatedEval_TcHmi_System_FunctionExpression(s)}catch(e){return void ctx.error(TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION,{code:TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION],reason:`${this.__expression}: Exception was thrown while processing.`,exception:e,domain:"TcHmi.System.FunctionExpression"})}let cvalue=ValueConverter.toSchemaType(value,typeSchema);if(null===cvalue&&null!==value)return void ctx.error(TcHmi.Errors.E_TYPE_INVALID,{code:TcHmi.Errors.E_TYPE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_TYPE_INVALID],reason:`${this.__expression}:Unable to cast value: "${value}"of type: "`+typeof value+` for parameter: "${descr.name}"`+`of function: "${module.description.function.name}"`+`of type: "${descr.type}".`});args[i+argoffset]=cvalue}}try{res=module.reg.func(...args)}catch(e){return void ctx.error(TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION,{code:TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION],reason:`${this.__expression}: Exception was thrown while processing.`,exception:e,domain:"TcHmi.System.FunctionExpression"})}subCtx?.destroy&&(ctx.destroy=subCtx.destroy),"Asynchronous"===module.description.function.waitMode||ctx.success(res)};let next=i=>{let bContextLock=!1,subCtx={success:result=>{if(ctx.delegatedWatch)bContextLock=!1;else{if(bContextLock)return;bContextLock=!0}resultsFunctionCallExpressions[i]=result,i+1<this.__functionCallExpressions.length?next(i+1):ctx.success()},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details))},...ctx&&ctx.args?{args:ctx.args}:{},...ctx&&ctx.delegatedWatch?{delegatedWatch:ctx.delegatedWatch}:{}},fce=this.__functionCallExpressions[i],fceDestroy=destroyFunctionWatchesFromSubCtx.get(fce);fceDestroy&&(fceDestroy(),fceDestroy=void 0,destroyFunctionWatchesFromSubCtx.delete(fce)),resolveFunctionCallExpression(subCtx,fce),subCtx.destroy&&destroyFunctionWatchesFromSubCtx.set(fce,subCtx.destroy)};this.__functionCallExpressions.length>0?next(0):ctx.success()};let bContextLock=!1;return subCtx1={...ctx,success:_result1=>{if(ctx.delegatedWatch)bContextLock=!1;else{if(bContextLock)return;bContextLock=!0}let bContextLock2=!1;subCtx2={...ctx,success:_result2=>{if(ctx.delegatedWatch)bContextLock2=!1;else{if(bContextLock2)return;bContextLock2=!0}let bContextLock3=!1;subCtx3={...ctx,success:result3=>{if(ctx.delegatedWatch)bContextLock3=!1;else{if(bContextLock3)return;bContextLock3=!0}if(!executeReturned&&skipCallbackWithSyncValue)return syncResultValue=result3,void(syncResultSet=!0);ctx.success(result3)},error:(error,details)=>{bContextLock3||(bContextLock3=!0,ctx.error(error,details))},...ctx&&ctx.args?{args:ctx.args}:{},...ctx&&ctx.delegatedWatch?{delegatedWatch:ctx.delegatedWatch}:{}},resolveExpression(subCtx3)},error:(error,details)=>{bContextLock2||(bContextLock2=!0,ctx.error(error,details))},...ctx&&ctx.args?{args:ctx.args}:{},...ctx&&ctx.delegatedWatch?{delegatedWatch:ctx.delegatedWatch}:{}},destroySubCtx2&&(destroySubCtx2(),destroySubCtx2=void 0),resolveFunctionCallExpressions(subCtx2),destroySubCtx2=subCtx2.destroy},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details))},...ctx&&ctx.args?{args:ctx.args}:{},...ctx&&ctx.delegatedWatch?{delegatedWatch:ctx.delegatedWatch}:{}},(ctx=>{const resolveSymbolExpression=(ctx,symbolExpression,i)=>{if(!symbolExpression)return void ctx.error(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:`${this.__expression}: Resolving expression for parameter at index: ${i} failed.`,domain:"TcHmi.System.FunctionExpression"});let metaData=this.__symbolExpressionsMetaData.get(symbolExpression);if(this.__enableWatchMode){let watchObj=this.__watchSymbols.get(`${symbolExpression.expression}_${symbolExpression.start}_${symbolExpression.end}`);return watchObj?watchObj.error?void ctx.error(watchObj.error,watchObj.details):void ctx.success(tchmi_clone_object(watchObj.value)):void ctx.error(TcHmi.Errors.ERROR,{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:`${this.__expression}: Internal Error: Did not find ${this.__expression} in __symbols`,domain:"TcHmi.System.FunctionExpression"})}{let refBase=new TcHmi.Symbol({expression:symbolExpression.expression,ctx});return void refBase.resolveSchema(data=>{if(!refBase)return;if(data.error!==TcHmi.Errors.NONE)return void(data.details?ctx.error(TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE],reason:`${this.__expression}: Resolving schema for symbol with expression "${symbolExpression.expression}" for parameter at index "${i}" failed.`,domain:"TcHmi.System.FunctionExpression",errors:[data.details]}):ctx.error(TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE],reason:`${this.__expression}: Resolving schema for symbol with expression "${symbolExpression.expression}" for parameter at index "${i}" failed.`,domain:"TcHmi.System.FunctionExpression"}));let symbolSchema=data.schema;if(!symbolSchema)return void(data.details?ctx.error(TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE],reason:`${this.__expression}: Resolving schema for symbol with expression "${symbolExpression.expression}" for parameter at index "${i}" failed.`,domain:"TcHmi.System.FunctionExpression",errors:[data.details]}):ctx.error(TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE],reason:`${this.__expression}: Resolving schema for symbol with expression "${symbolExpression.expression}" for parameter at index "${i}" failed.`,domain:"TcHmi.System.FunctionExpression"}));let referenceHandling=ReferenceHandlingType.None;if(metaData?.options.passAsSymbol?referenceHandling=ReferenceHandlingType.Symbol:"TcHmi.Symbol"===symbolSchema.frameworkInstanceOf&&data.expressionResolved&&(referenceHandling="Value"===data.expressionResolved.getOptions().ReferenceResolution?ReferenceHandlingType.Generic:ReferenceHandlingType.None),referenceHandling!==ReferenceHandlingType.None){let destroyResolveReference;destroyResolveReference=refBase.resolveReference(data=>{if(data.error===TcHmi.Errors.NONE)if(data.ref)switch(referenceHandling){case ReferenceHandlingType.Symbol:ctx.success(data.ref);break;case ReferenceHandlingType.Generic:try{let symbol=data.ref;symbol.readEx2(this.__forcedSymbolOptions,data=>{data.error?ctx.error(data.error,data.details):ctx.success(data.value),symbol?.destroy(),symbol=null})}catch(ex){return void ctx.error(TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED,{code:TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED],reason:`${this.__expression}: Resolving expression "${symbolExpression.expression}" for parameter at index "${i}" failed with exception.`,domain:"TcHmi.Function",exception:ex})}}else ctx.error(TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE],reason:`${this.__expression}: Resolving expression "${symbolExpression.expression}" for parameter at index "${i}" failed.`,domain:"TcHmi.System.FunctionExpression"});else data.details?ctx.error(TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE],reason:`${this.__expression}: Resolving expression "${symbolExpression.expression}" for parameter at index "${i}" failed.`,domain:"TcHmi.System.FunctionExpression",errors:[data.details]}):ctx.error(TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE],reason:`${this.__expression}: Resolving expression "${symbolExpression.expression}" for parameter at index "${i}" failed.`,domain:"TcHmi.System.FunctionExpression"})}),this.__toDestroy.push(()=>{destroyResolveReference?.(),destroyResolveReference=void 0,refBase?.destroy(),refBase=null})}else try{let symbol=new SystemSymbol({expression:symbolExpression.expression,ctx}),destroyRead=symbol.readEx(this.__forcedSymbolOptions,data=>{data.error?ctx.error(data.error,data.details):ctx.success(data.value),symbol?.destroy(),symbol=null});this.__toDestroy.push(()=>{destroyRead?.(),destroyRead=null,refBase?.destroy(),refBase=null})}catch(ex){return void ctx.error(TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED,{code:TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED],reason:`${this.__expression}: Resolving expression "${symbolExpression.expression}" for parameter at index "${i}" failed with exception.`,domain:"TcHmi.Function",exception:ex})}})}};let next=i=>{let symbolExpression=this.__symbolExpressions[i],bContextLock=!1;resolveSymbolExpression({...ctx,success:result=>{bContextLock||(bContextLock=!0,resultsSymbolExpressions[i]=result,i+1<this.__symbolExpressions.length?next(i+1):ctx.success())},error:(error,details)=>{bContextLock||(bContextLock=!0,ctx.error(error,details))}},symbolExpression,i)};this.__symbolExpressions.length>0?next(0):ctx.success()})(subCtx1),executeReturned=!0,syncResultSet&&skipCallbackWithSyncValue?{value:syncResultValue,error:TcHmi.Errors.E_FUNCTION_HANDLED_VIA_RETURN_VALUE}:{error:TcHmi.Errors.NONE}}watch(callback){if(this.__isDestroyed)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,destroy:()=>{},details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:`${this.__expression}: Function Expression already destroyed.`,domain:"TcHmi.System.FunctionExpression"}}),()=>{};if(!this.__enableWatchMode)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,destroy:()=>{},details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:`${this.__expression}: Function Expression has no watch mode.`,domain:"TcHmi.System.FunctionExpression"}}),()=>{};let destroy=()=>{let index=this.__callbacks.indexOf(co);-1!==index&&this.__callbacks.splice(index,1)},co={callback,destroy,isDirty:!0};return this.__callbacks.push(co),this.__doWatchExecute(),destroy}__resolveProcessedWaitMode(){let res="Synchronous";if(this.__processedWaitMode)return res=this.__processedWaitMode,res;if(this.__isDestroyed)throw new Error("Object was already destroyed.");if("Synchronous"===res){let resolveExpressionWaitMode=expression=>{let type=expression.getType();if(type===TcHmi.SymbolType.Server)return res="Asynchronous",res;if(type===TcHmi.SymbolType.Function){const content=expression.getContent();if(!content)return"Synchronous";let func=new FunctionExpression(content);if(func.isProcessedAsync())return res="Asynchronous",func.destroy(),res;func.destroy()}else{let children=expression.getChildren();for(let child of children)if(res=resolveExpressionWaitMode(child),"Asynchronous"===res)return res}return"Synchronous"};for(let i=0,ii=this.__symbolExpressions.length;i<ii;i++){let symbolExpression=this.__symbolExpressions[i],expression=new SymbolExpression(symbolExpression.expression);if(res=resolveExpressionWaitMode(expression),"Asynchronous"===res)break}}return this.__processedWaitMode=res,res}isProcessedAsync(){return"Asynchronous"===this.__resolveProcessedWaitMode()}destroy(){this.isDestroyed()||(this.__releaseDestroyPrivilege(),this.isDestroyable()&&(this.__enableWatchMode&&(this.__watchSymbols.forEach(watchObj=>{watchObj.destroy.symbolWatch?.(),watchObj.destroy.symbolWatch=void 0,watchObj.destroy.referenceWatch?.(),watchObj.destroy.referenceWatch=void 0,watchObj.symbol.destroy(),watchObj.ref?.destroy()}),this.__watchSymbols.clear()),this.__currentWatch.ctx&&(this.__currentWatch.ctx.destroy&&(this.__currentWatch.ctx.destroy(),this.__currentWatch.ctx.destroy=void 0),this.__currentWatch.ctx=void 0),this.__toDestroy.forEach(destroy=>{destroy()}),this.__toDestroy=[],this.__isDestroyed=!0))}}
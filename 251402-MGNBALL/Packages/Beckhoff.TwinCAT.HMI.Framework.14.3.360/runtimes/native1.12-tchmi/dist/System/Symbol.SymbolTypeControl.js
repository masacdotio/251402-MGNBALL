import{controlManager}from"./ControlManager.js";import{Symbol as SystemSymbol}from"./Symbol.js";import*as ValueConverter from"../API/ValueConverter.js";import{getSchema}from"../API/Type.js";import{Log}from"../API/Log.js";export class SymbolTypeControl extends TcHmi.Destroyable{constructor(symbol){super(),this.__symbol=symbol,this.__symbolExpressionString=this.__symbol.getExpression().toString(),this.__symbolDiagGUID=this.__symbol.getDiagGUID()}__symbol;__symbolExpressionString;__symbolDiagGUID;__printExpression(expression){let message=this.__symbolExpressionString;return expression?(this.__symbolExpressionString!==expression.toString()&&(message+=` (Resolved to: '${expression.toString()}')`),message):message}destroy(){this.isDestroyed()||(this.__releaseDestroyPrivilege(),this.isDestroyable()&&(this.__symbol=null))}read(expression,options,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}});const name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});let pathTokens=tchmi_clone_object(expression.getPathTokens()),waitForControl=expression.getOptions().WaitForControl??!0,waitForControlTimeout=expression.getOptions().Timeout??1e3,timeoutId=0,destroyOnControlInitialized=null,control=TcHmi.Controls.get(name),proc=()=>{if(destroyOnControlInitialized&&(destroyOnControlInitialized(),destroyOnControlInitialized=null),timeoutId>0&&clearTimeout(timeoutId),timeoutId=0,this.__symbol)if(control){if(null!==pathTokens){let propertyName;pathTokens&&pathTokens.length>0&&(propertyName=pathTokens.shift());let attr=controlManager.getAttributeByPropertyName(control,propertyName);if(null==attr)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control attribute with propertyName: "+propertyName,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(void 0===control[attr.propertyGetterName])return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control attribute implementation with propertyName: "+propertyName,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});let value=tchmi_clone_object(control[attr.propertyGetterName].call(control));if(pathTokens&&pathTokens.length>0){let rootSchema=getSchema(attr.type);if(rootSchema&&rootSchema.frameworkInstanceOf&&"TcHmi.Controls.System.TcHmiControl"===rootSchema.frameworkInstanceOf){if(!(value instanceof TcHmi.Controls.System.baseTcHmiControl))return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason:this.__printExpression(expression)+": Missing control instance for attribute: "+propertyName,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});let controlId=value.getId(),start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0,subSymbol=new SystemSymbol({expression:"%ctrl%"+controlId+this.__symbol.__helper.resolveSanitizedPath(pathTokens)+(start?"|Start="+start:"")+(end?"|End="+end:"")+"%/ctrl%",ctx:this.__symbol.getContext()});return void subSymbol.read(dataSubSymbol=>{if(this.__symbol){if(dataSubSymbol.error!==TcHmi.Errors.NONE)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR,details:{code:TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR],reason:this.__printExpression(expression)+": Error reading subsymbol "+subSymbol.getExpression().toString(),domain:"TcHmi.System.SymbolTypeControl",errors:dataSubSymbol.details?[dataSubSymbol.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression}),void subSymbol.destroy();TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(dataSubSymbol.value),expressionResolved:expression,expression:this.__symbol.getExpression()}),subSymbol.destroy()}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}})})}return void this.__symbol.__helper.readSubValue(expression,value,pathTokens,name+"::"+propertyName,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){let value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}})})}if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression()})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:control,expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control instance with id: "+name,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}})};control||!waitForControl?proc():!control&&waitForControl&&(destroyOnControlInitialized=TcHmi.EventProvider.register(name+".onInitialized",(e,data)=>{timeoutId>0&&(clearTimeout(timeoutId),timeoutId=0),control=data,proc()}),timeoutId=setTimeout(()=>{timeoutId=0,proc()},waitForControlTimeout))}write(expression,value,options,dirtyPaths,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}});null===dirtyPaths&&(dirtyPaths=void 0);const name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});let pathTokens=tchmi_clone_object(expression.getPathTokens()),waitForControl=expression.getOptions().WaitForControl??!0,waitForControlTimeout=expression.getOptions().Timeout??1e3,timeoutId=0,destroyOnControlInitialized=null,control=TcHmi.Controls.get(name),proc=()=>{if(destroyOnControlInitialized&&(destroyOnControlInitialized(),destroyOnControlInitialized=null),timeoutId>0&&clearTimeout(timeoutId),timeoutId=0,this.__symbol)if(control)if(null!==pathTokens){let searchPropertyName;if(pathTokens&&pathTokens.length>0&&(searchPropertyName=pathTokens.shift()),!searchPropertyName)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+" has no valid control property",domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});const propertyName=searchPropertyName,attr=controlManager.getAttributeByPropertyName(control,propertyName);if(null==attr)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND],reason:this.__printExpression(expression)+': Can not find attribute with property name: "'+propertyName+'" in control: '+control.getId(),domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(attr.readOnly&&0===pathTokens.length)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_READONLY,details:{code:TcHmi.Errors.E_SYMBOL_READONLY,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_READONLY],reason:this.__printExpression(expression)+': Writing to readonly symbol is not allowed. Symbol is readonly because attribute with property name: "'+propertyName+'" in control: "'+control.getId()+'" is readonly.',domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});this.__symbol.__helper.resolveSchema(expression,dataResolveSchema=>{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}});if(!control)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control instance with id: "+name,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(dataResolveSchema&&dataResolveSchema.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:this.__printExpression(expression)+": Failed to resolve schema definition",domain:"TcHmi.System.SymbolTypeControl",errors:dataResolveSchema.details?[dataResolveSchema.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression});let currentValue,schema=this.__symbol.__helper.getSchema(),newValue=tchmi_clone_object(value);try{currentValue=control[attr.propertyGetterName].call(control)}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+": An uncaught exception occurred in the getter call for preparation of the write operation",exception:e,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression})}let currentCloneValue=tchmi_clone_object(currentValue);if(!attr.readOnly||__tchmi_is_instanced_object(currentCloneValue)){if(pathTokens&&pathTokens.length>0){let rootSchema=getSchema(attr.type);if(rootSchema&&rootSchema.frameworkInstanceOf&&"TcHmi.Controls.System.TcHmiControl"===rootSchema.frameworkInstanceOf){if(!(currentCloneValue instanceof TcHmi.Controls.System.baseTcHmiControl))return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": Missing control instance for parameter: "+attr.propertyName,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});{let controlId=currentCloneValue.getId(),start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0,subSymbol=new SystemSymbol({expression:"%ctrl%"+controlId+this.__symbol.__helper.resolveSanitizedPath(pathTokens)+(start?"|Start="+start:"")+(end?"|End="+end:"")+"%/ctrl%",ctx:this.__symbol.getContext()});subSymbol.writeEx(value,dirtyPaths,dataSubSymbol=>{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}});if(dataSubSymbol.error!==TcHmi.Errors.NONE)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR,details:{code:TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR],reason:this.__printExpression(expression)+": Failed to write subsymbol "+subSymbol.getExpression().toString(),domain:"TcHmi.System.SymbolTypeControl",errors:dataSubSymbol.details?[dataSubSymbol.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression}),void subSymbol.destroy();let readValue;try{readValue=control[attr.propertyGetterName].call(control)}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+": An uncaught exception occurred in the getter call for preparation of the write operation",exception:e,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(readValue),expressionResolved:expression,expression:this.__symbol.getExpression()}),subSymbol.destroy()})}return}{let currentSubValue,currentSubValueErrorDetails,dirtyPathsNew=[];if(dirtyPaths&&dirtyPaths.length>0)for(let i=0,ii=dirtyPaths.length;i<ii;i++)dirtyPathsNew.push(this.__symbol.__helper.resolveSanitizedPath(pathTokens)+dirtyPaths[i]);else dirtyPathsNew.push(this.__symbol.__helper.resolveSanitizedPath(pathTokens));if(this.__symbol.__helper.readSubValue(expression,currentCloneValue,pathTokens,name+"::"+propertyName,data=>{this.__symbol?data.error===TcHmi.Errors.NONE?currentSubValue=tchmi_clone_object(data.value):currentSubValueErrorDetails={code:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR],reason:this.__printExpression(expression)+": Error while reading sub value.",domain:"TcHmi.System.SymbolTypeControl",errors:[data.details?data.details:{code:data.error,message:TcHmi.Errors[data.error]}]}:TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}})}),currentSubValueErrorDetails)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,details:currentSubValueErrorDetails,expression:this.__symbol.getExpression(),expressionResolved:expression});let prepValue=ValueConverter.toSchemaType(newValue,schema);if(null===prepValue&&null!==newValue){let reason,value=newValue;return reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor.name+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+value+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".",void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression})}const write=(currentCloneValue,newValue,pathTokens,name,propertyName)=>{this.__symbol?this.__symbol.__helper.writeSubValue(expression,currentCloneValue,newValue,pathTokens,name+"::"+propertyName,data=>{if(this.__symbol)if(control)if(data.error===TcHmi.Errors.NONE){let error=controlManager.setControlPropertyByAttribute(control,attr,currentCloneValue,dirtyPathsNew);if(error&&error.code!==TcHmi.Errors.NONE)TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:error.code,details:error,expression:this.__symbol.getExpression(),expressionResolved:expression});else{let readValue;try{readValue=control[attr.propertyGetterName].call(control)}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+": An uncaught exception occurred in the getter call for preparation of the write operation",exception:e,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression})}if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}});this.__symbol.__helper.readSubValue(expression,tchmi_clone_object(readValue),pathTokens,name+"::"+propertyName,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){if(Array.isArray(data.value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(tchmi_clone_object(data.value),start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:res.error,details:res.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(res.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,details:{code:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR],reason:this.__symbol.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Error while reading sub value.",domain:"TcHmi.System.SymbolTypeControl",errors:[data.details?data.details:{code:data.error,message:TcHmi.Errors[data.error]}]},expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}})})}}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,details:{code:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR],reason:this.__printExpression(expression)+": Error while writing sub value.",domain:"TcHmi.System.SymbolTypeControl",errors:[data.details?data.details:{code:data.error,message:TcHmi.Errors[data.error]}]},expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control instance with id: "+name,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}})}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}})};if(Array.isArray(prepValue)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){if(Array.isArray(currentSubValue)){let newValue=tchmi_clone_object(currentSubValue),res=this.__symbol.__helper.writeArraySlice(newValue,prepValue,start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,res):void write(currentCloneValue,newValue,pathTokens,name,propertyName)}return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+": Failed to write value. Current value is not an array.",domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression})}return void write(currentCloneValue,prepValue,pathTokens,name,propertyName)}return void write(currentCloneValue,prepValue,pathTokens,name,propertyName)}}{let prepValue=ValueConverter.toSchemaType(newValue,schema);if(null===prepValue&&null!==newValue){let reason,value=newValue;return reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor.name+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+value+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".",void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression})}const write=(currentValue,newValue,control,attr)=>{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}});let error=controlManager.setControlPropertyByAttribute(control,attr,tchmi_clone_object(newValue));if(error&&error.code!==TcHmi.Errors.NONE)TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:error.code,details:error,expression:this.__symbol.getExpression(),expressionResolved:expression});else{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}});let readValue;try{readValue=control[attr.propertyGetterName].call(control)}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+": An uncaught exception occurred in the getter call for preparation of the write operation",exception:e,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(readValue),expressionResolved:expression,expression:this.__symbol.getExpression()})}};if(Array.isArray(prepValue)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){if(Array.isArray(currentCloneValue)){let newValue=tchmi_clone_object(currentCloneValue),res=this.__symbol.__helper.writeArraySlice(newValue,prepValue,start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,res):void write(currentCloneValue,newValue,control,attr)}return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+": Failed to write value. Current value is not an array.",domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression})}return void write(currentCloneValue,prepValue,control,attr)}return void write(currentCloneValue,prepValue,control,attr)}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_READONLY,details:{code:TcHmi.Errors.E_SYMBOL_READONLY,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_READONLY],reason:this.__printExpression(expression)+': Writing to readonly symbol is not allowed. Symbol is readonly because attribute with property name: "'+propertyName+'" in control: "'+control.getId()+'" is readonly.',domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression})})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_NOT_ALLOWED,details:{code:TcHmi.Errors.E_NOT_ALLOWED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_ALLOWED],reason:this.__printExpression(expression)+": Writing on control instance symbol is not allowed.",domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control instance with id: "+name,domain:"TcHmi.System.SymbolTypeControl"},expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}})};control||!waitForControl?proc():!control&&waitForControl&&(destroyOnControlInitialized=TcHmi.EventProvider.register(name+".onInitialized",(e,data)=>{timeoutId>0&&(clearTimeout(timeoutId),timeoutId=0),control=data,proc()}),timeoutId=setTimeout(()=>{timeoutId=0,proc()},waitForControlTimeout))}watch(expression,options,callback,reason){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}}),()=>{};let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid());let destroyOnPropertyChanged=null,destroyOnControlInitialized=null,destroyOnControlDestroyed=null,destroy=()=>{Log.debug("[Source=Framework, Module=TcHmi.System.Symbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch destroy called."),null!==destroyOnControlInitialized&&(destroyOnControlInitialized(),destroyOnControlInitialized=null),null!==destroyOnControlDestroyed&&(destroyOnControlDestroyed(),destroyOnControlDestroyed=null),null!==destroyOnPropertyChanged&&(destroyOnPropertyChanged(),destroyOnPropertyChanged=null)},name=expression.getName();if(!name){let res={error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+": Expression does not contain a valid name token.",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}let control=TcHmi.Controls.get(name),controlWasAvailable=!1;control&&(controlWasAvailable=!0);let waitForControl=expression.getOptions().WaitForControl??!0,waitForControlTimeout=expression.getOptions().Timeout??1e3,timeoutId=0,proc=()=>{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}});let propertyName,pathTokens=tchmi_clone_object(expression.getPathTokens()),pathSanitized="";if(!control){if(controlWasAvailable)return;{let res={error:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control instance with name: "+name,domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}}if(pathTokens&&pathTokens.length>0&&(propertyName=pathTokens.shift(),pathTokens.length>0&&(pathSanitized=this.__symbol.__helper.resolveSanitizedPath(pathTokens))),propertyName){let last,attr=controlManager.getAttributeByPropertyName(control,propertyName);if(!attr){let res={error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND],reason:this.__printExpression(expression)+': Can not find attribute definition for property: "'+propertyName+'" of control: "'+name+'" of type: '+control.getType(),domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}if(!attr.propertyGetterName){let res={error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_INVALID_CONFIGURATION,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_INVALID_CONFIGURATION,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_INVALID_CONFIGURATION],reason:this.__printExpression(expression)+': Can not find valid "propertyGetterName" in attribute definition for property: "'+propertyName+'" of control: "'+name+'" of type: "'+control.getType()+'". Please check Description.json',domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}destroyOnPropertyChanged=TcHmi.EventProvider.register(name+".onPropertyChanged<"+attr.propertyName+">",(e,data)=>{if(!data)return;let doWork=!1,dirtyPaths=data.dirtyPaths,dirtyPathsNew=[];if(pathSanitized&&dirtyPaths&&dirtyPaths.length>0)for(let j=0,jj=dirtyPaths.length;j<jj;j++){let dirtyPath=dirtyPaths[j];dirtyPath.startsWith(pathSanitized)?(doWork=!0,dirtyPath!==pathSanitized&&dirtyPathsNew.push(dirtyPath.replace(pathSanitized,""))):pathSanitized.startsWith(dirtyPath)&&(doWork=!0)}else doWork=!0;doWork&&this.read(expression,null,data=>{if(this.__symbol){if(data.error===TcHmi.Errors.NONE){let res,value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){if(tchmi_equal(last,value))return;last=tchmi_clone_object(value)}}return res=dirtyPathsNew&&dirtyPathsNew.length>0?{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression(),dirtyPaths:dirtyPathsNew,destroy}:{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy},Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}{let res={error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}}TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}})})})}this.read(expression,null,data=>{if(this.__symbol){if(data.error===TcHmi.Errors.NONE){let res={error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.value),expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}{let res={error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}}TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeControl"}})})};return destroyOnControlInitialized=TcHmi.EventProvider.register(name+".onInitialized",(e,data)=>{timeoutId>0&&(clearTimeout(timeoutId),timeoutId=0),control=data,control&&(controlWasAvailable=!0),proc()}),destroyOnControlDestroyed=TcHmi.EventProvider.register(name+".onDestroyed",(e,data)=>{timeoutId>0&&(clearTimeout(timeoutId),timeoutId=0),control=void 0,proc()}),control||!waitForControl?proc():!control&&waitForControl&&(timeoutId=setTimeout(()=>{timeoutId=0,proc()},waitForControlTimeout)),destroy}}
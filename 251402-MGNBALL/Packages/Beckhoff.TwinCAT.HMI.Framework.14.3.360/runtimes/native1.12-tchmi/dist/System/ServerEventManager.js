import{serverManager}from"./ServerManager.js";import*as Server from"../API/Server.js";export class ServerEventManager{constructor(){}__subscriptions=[];confirmAlarm(alarm,callback){let reqObj={requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage"],symbol:"ConfirmAlarm",writeValue:alarm}]};serverManager.request(reqObj,Server.handleResponse({error:data=>{if(data.error===TcHmi.Errors.NONE&&data.results){let res=data.results[0];TcHmi.Callback.callSafeEx(callback,this,{error:res.error,details:res.details})}else TcHmi.Callback.callSafeEx(callback,this,{error:data.error,details:data.details})},success:data=>{TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})}}))}listEvents(filter,callback){const reqObj={requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"ListEvents"}]};filter&&(reqObj.commands[0].filter=filter),serverManager.request(reqObj,Server.handleResponse({error:data=>{if(data.error===TcHmi.Errors.NONE&&data.results){let res=data.results[0];TcHmi.Callback.callSafeEx(callback,this,{error:res.error,details:res.details})}else TcHmi.Callback.callSafeEx(callback,this,{error:data.error,details:data.details})},success:data=>{setTimeout(()=>{TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE,events:data.results[0].value})})}}))}subscribe(filter,eventCallback,doneCallback){const responseId=serverManager.getFreeRequestId();if(!responseId)return TcHmi.Callback.callSafeEx(eventCallback,null,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.ServerEventManager",reason:"Reached maxium of parallel requests."}}),responseId;const reqObj={requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"SubscribeEvents",writeValue:responseId}]};filter&&(reqObj.commands[0].filter=filter);let subscription={responseId,callback:eventCallback};return this.__subscriptions.push(subscription),serverManager.request(reqObj,Server.handleResponse({error:data=>{let res;res=data.error===TcHmi.Errors.NONE&&data.results?{error:data.results[0].error,details:data.results[0].details}:{error:data.error,details:data.details},TcHmi.Callback.callSafeEx(eventCallback,null,res),TcHmi.Callback.callSafeEx(doneCallback,null,res)},success:()=>{let callbackId=serverManager.registerEventCallback(responseId,Server.handleResponse({error:data=>{if(data.error===TcHmi.Errors.NONE&&data.results){let res=data.results[0];TcHmi.Callback.callSafeEx(eventCallback,this,{error:res.error,details:res.details})}else TcHmi.Callback.callSafeEx(eventCallback,this,{error:data.error,details:data.details})},success:data=>{setTimeout(()=>{TcHmi.Callback.callSafeEx(eventCallback,null,{error:TcHmi.Errors.NONE,event:data.results[0].value})})}})),result={error:TcHmi.Errors.NONE};null===callbackId&&(result={error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.ServerEventManager",reason:"Internal Error: Multiple callbacks registered to request id "+responseId}},TcHmi.Callback.callSafeEx(eventCallback,null,result)),TcHmi.Callback.callSafeEx(doneCallback,null,result)}})),responseId}unsubscribe(id,callback){const subscription=this.__subscriptions.find(item=>item.responseId===id);if(subscription){const reqObj={requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"UnsubscribeEvents",writeValue:subscription.responseId}]};serverManager.releaseRequest(subscription.responseId);const subscriptionIndex=this.__subscriptions.indexOf(subscription);-1!==subscriptionIndex&&this.__subscriptions.splice(subscriptionIndex,1),serverManager.request(reqObj,Server.handleResponse({error:data=>{if(data.error===TcHmi.Errors.NONE&&data.results){let res=data.results[0];TcHmi.Callback.callSafeEx(callback,null,{error:res.error,details:res.details})}else TcHmi.Callback.callSafeEx(callback,null,{error:data.error,details:data.details})},success:data=>{TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE})}}))}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:`Failed unsubscribe because no event subscription with the given id ${id} exists`,domain:"TcHmi.System.ServerEventManager"}})}updateSubscription(id,filter,callback){const subscription=this.__subscriptions.find(item=>item.responseId===id);if(subscription){let reqObj={requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"UpdateEventsSubscription",writeValue:subscription.responseId}]};filter&&(reqObj.commands[0].filter=filter),serverManager.request(reqObj,Server.handleResponse({error:data=>{if(data.error===TcHmi.Errors.NONE&&data.results){let res=data.results[0];TcHmi.Callback.callSafeEx(callback,null,{error:res.error,details:res.details})}else TcHmi.Callback.callSafeEx(callback,null,{error:data.error,details:data.details})},success:()=>{TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE})}}))}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:`Failed update the subscription because no event subscription with the given id ${id} exists`,domain:"TcHmi.System.ServerEventManager"}})}}export const serverEventManager=new ServerEventManager;
import{controlManager}from"./ControlManager.js";import{Symbol as SystemSymbol}from"./Symbol.js";import*as ValueConverter from"../API/ValueConverter.js";import{getSchema}from"../API/Type.js";import{resolveDefault}from"../API/Type.Schema.js";import{Log}from"../API/Log.js";let userControlParameterManager;TCHMI_ENGINEERING&&import("./Engineering/DesignerModeUserControlParameterManager.js").then(module=>{userControlParameterManager=module.userControlParameterManager});export class SymbolTypePartialParam extends TcHmi.Destroyable{constructor(symbol){super(),this.__symbol=symbol,this.__symbolExpressionString=this.__symbol.getExpression().toString(),this.__symbolDiagGUID=this.__symbol.getDiagGUID()}__symbol;__symbolExpressionString;__symbolDiagGUID;__printExpression(expression){let message=this.__symbolExpressionString;return expression?(this.__symbolExpressionString!==expression.toString()&&(message+=` (Resolved to: '${expression.toString()}')`),message):message}destroy(){this.isDestroyed()||(this.__releaseDestroyPrivilege(),this.isDestroyable()&&(this.__symbol=null))}read(expression,options,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}});const name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});let value,propertyName,designerParam,pathTokens=tchmi_clone_object(expression.getPathTokens()),attr=null;if(!pathTokens)return void("TCHMI_TARGET_DESIGNER_PARTIALPARAM"!==name?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+" is not a valid PartialParameter. Expected: UserControlHost::Parameter",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+" is not a valid PartialParameter. Expected: TCHMI_TARGET_DESIGNER_PARTIALPARAM::Parameter",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression}));if(propertyName=pathTokens.shift(),!propertyName)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+" has no valid control property",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});const processValue=()=>{if(this.__symbol&&attr){if(pathTokens&&pathTokens.length>0){let rootSchema=TcHmi.Type.getSchema(attr.type);if(rootSchema&&rootSchema.frameworkInstanceOf&&"TcHmi.Controls.System.TcHmiControl"===rootSchema.frameworkInstanceOf){if(value||"TCHMI_TARGET_DESIGNER_PARTIALPARAM"!==name){if(!value)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason:this.__printExpression(expression)+": Missing control instance for parameter: "+propertyName,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});{if(!(value instanceof TcHmi.Controls.System.baseTcHmiControl))return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason:this.__printExpression(expression)+": Missing control instance for parameter: "+propertyName,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});let controlId=value.getId(),start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0,subSymbol=new SystemSymbol({expression:"%ctrl%"+controlId+this.__symbol.__helper.resolveSanitizedPath(pathTokens)+(start?"|Start="+start:"")+(end?"|End="+end:"")+"%/ctrl%",ctx:this.__symbol.getContext()});subSymbol.read(dataSubSymbol=>{if(this.__symbol){if(dataSubSymbol&&dataSubSymbol.error!==TcHmi.Errors.NONE)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR,details:{code:TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR],reason:this.__printExpression(expression)+": Failed to read subsymbol "+subSymbol.getExpression().toString(),domain:"TcHmi.System.SymbolTypePartialParam",errors:dataSubSymbol.details?[dataSubSymbol.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression}),void subSymbol.destroy();TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(dataSubSymbol.value),expressionResolved:expression,expression:this.__symbol.getExpression()}),subSymbol.destroy()}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})})}}else this.__symbol.__helper.resolveSchema(expression,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE&&data.schema){let defaultValue=resolveDefault(data.schema),res={error:TcHmi.Errors.NONE,value:defaultValue};TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:this.__printExpression(expression)+": Missing schema of the symbol.",domain:"TcHmi.System.SymbolTypePartialParam",errors:data.details?[data.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})});return}return void this.__symbol.__helper.readSubValue(expression,value,pathTokens,name+"::"+propertyName,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){let value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})})}if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(value),expressionResolved:expression,expression:this.__symbol.getExpression()})}};if("TCHMI_TARGET_DESIGNER_PARTIALPARAM"!==name){let control=TcHmi.Controls.get(name);if(!control)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control instance with id: "+name,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(attr=controlManager.getAttributeByPropertyName(control,propertyName),null==attr)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control attribute with propertyName: "+propertyName,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});let params=control.__params;if(params){let param=params.get(attr.name);if(param&&!param.isReady)return void TcHmi.EventProvider.register(name+".onPropertyChanged<"+attr.propertyName+">",(e,data)=>{if(!this.__symbol)return void e.destroy();if(!attr)return void e.destroy();let param=control.__params[attr.name];if(!param||param.isReady){try{value=control[attr.propertyGetterName].call(control)}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+": An uncaught exception occurred in the callback for the read operation",exception:e,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}processValue()}})}try{value=control[attr.propertyGetterName].call(control)}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+": An uncaught exception occurred in the callback for the read operation",exception:e,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}processValue()}else{if(designerParam=userControlParameterManager?.get(propertyName),!designerParam)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:this.__printExpression(expression)+": Unknown template parameter "+propertyName,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(attr=designerParam.descr,!attr)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control attribute with propertyName: "+name,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});value=designerParam.value,processValue()}}write(expression,value,options,dirtyPaths,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}});null===dirtyPaths&&(dirtyPaths=void 0);const name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});let searchPropertyName,pathTokens=tchmi_clone_object(expression.getPathTokens()),searchAttr=null;if(!pathTokens)return void("TCHMI_TARGET_DESIGNER_PARTIALPARAM"!==name?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+" is not a valid PartialParameter. Expected: UserControlHost::Parameter",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+" is not a valid PartialParameter. Expected: TCHMI_TARGET_DESIGNER_PARTIALPARAM::Parameter",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression}));if(searchPropertyName=pathTokens.shift(),!searchPropertyName)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+" has no valid control property",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});const propertyName=searchPropertyName;let designerParam,control;if("TCHMI_TARGET_DESIGNER_PARTIALPARAM"!==name){if(control=TcHmi.Controls.get(name),!control)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control instance with id: "+name,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});searchAttr=controlManager.getAttributeByPropertyName(control,propertyName)}else{if(designerParam=userControlParameterManager?.get(propertyName),!designerParam)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:this.__printExpression(expression)+": Unknown template parameter "+propertyName,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});searchAttr=designerParam.descr}if(!searchAttr)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control attribute with propertyName: "+name,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});const attr=searchAttr;this.__symbol.__helper.resolveSchema(expression,dataResolveSchema=>{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}});if(dataResolveSchema&&dataResolveSchema.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:this.__printExpression(expression)+": Failed to resolve schema definition.",domain:"TcHmi.System.SymbolTypePartialParam",errors:dataResolveSchema.details?[dataResolveSchema.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression});let currentValue,schema=this.__symbol.__helper.getSchema(),newValue=tchmi_clone_object(value);if(control)try{currentValue=control[attr.propertyGetterName].call(control)}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+": An uncaught exception occurred in the getter call for preparation of the write operation",exception:e,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}else{if(!designerParam)return Log.errorEx("Internal Error: Invalid code path. Found no control and no designer parameter."),void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression(expression)+": Internal Error: Invalid code path. Found no control and no designer parameter.",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});currentValue=designerParam.value}const currentCloneValue=tchmi_clone_object(currentValue);if(pathTokens&&pathTokens.length>0){let rootSchema=getSchema(attr.type);if(rootSchema&&rootSchema.frameworkInstanceOf&&"TcHmi.Controls.System.TcHmiControl"===rootSchema.frameworkInstanceOf){if(!(currentCloneValue instanceof TcHmi.Controls.System.baseTcHmiControl))return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": Missing control instance for parameter: "+propertyName,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});{let controlId=currentCloneValue.getId(),start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0,subSymbol=new SystemSymbol({expression:"%ctrl%"+controlId+this.__symbol.__helper.resolveSanitizedPath(pathTokens)+(start?"|Start="+start:"")+(end?"|End="+end:"")+"%/ctrl%",ctx:this.__symbol.getContext()});subSymbol.writeEx(value,dirtyPaths,dataSubSymbol=>{if(this.__symbol){if(dataSubSymbol&&dataSubSymbol.error!==TcHmi.Errors.NONE)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR,details:{code:TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR],reason:this.__printExpression(expression)+": Failed to write to subsymbol "+subSymbol.getExpression().toString(),domain:"TcHmi.System.SymbolTypePartialParam",errors:dataSubSymbol.details?[dataSubSymbol.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression}),void subSymbol.destroy();TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(dataSubSymbol.value),expressionResolved:expression,expression:this.__symbol.getExpression()}),subSymbol.destroy()}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})})}return}{let currentSubValue,currentSubValueErrorDetails,dirtyPathsNew=[];if(dirtyPaths&&dirtyPaths.length>0)for(let i=0,ii=dirtyPaths.length;i<ii;i++)dirtyPathsNew.push(this.__symbol.__helper.resolveSanitizedPath(pathTokens)+dirtyPaths[i]);else dirtyPathsNew.push(this.__symbol.__helper.resolveSanitizedPath(pathTokens));if(this.__symbol.__helper.readSubValue(expression,currentCloneValue,pathTokens,name+"::"+propertyName,data=>{this.__symbol?data.error===TcHmi.Errors.NONE?currentSubValue=tchmi_clone_object(data.value):currentSubValueErrorDetails={code:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR],reason:this.__printExpression(expression)+": Error while reading sub value.",domain:"TcHmi.System.SymbolTypePartialParam",errors:[data.details?data.details:{code:data.error,message:TcHmi.Errors[data.error]}]}:TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})}),currentSubValueErrorDetails)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,details:currentSubValueErrorDetails,expression:this.__symbol.getExpression(),expressionResolved:expression});let prepValue=ValueConverter.toSchemaType(newValue,schema);if(null===prepValue&&null!==newValue){let reason,value=newValue;return reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor.name+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+value+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".",void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}const write=(currentCloneValue,currentSubValue,newValue,pathTokens,name,propertyName)=>{if(this.__symbol)return tchmi_equal(currentSubValue,newValue)?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(prepValue),expression:this.__symbol.getExpression(),expressionResolved:expression},{equal:!0}):void this.__symbol.__helper.writeSubValue(expression,currentCloneValue,newValue,pathTokens,name+"::"+propertyName,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE)if(control){let error=controlManager.setControlPropertyByAttribute(control,attr,currentCloneValue,dirtyPathsNew);if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}});if(error&&error.code!==TcHmi.Errors.NONE)TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:error.code,details:error,expression:this.__symbol.getExpression(),expressionResolved:expression});else{let readValue;try{readValue=control[attr.propertyGetterName].call(control)}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+": An uncaught exception occurred in the getter call for preparation of the write operation",exception:e,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}});this.__symbol.__helper.readSubValue(expression,tchmi_clone_object(readValue),pathTokens,name+"::"+propertyName,data=>{if(this.__symbol){if(data.error!==TcHmi.Errors.NONE)return data.details?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:{code:data.error,message:TcHmi.Errors[data.error],reason:this.__symbol.getExpression().toString()+" (Resolved to: '"+expression.toString()+"'): Error while reading sub value.",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(Array.isArray(data.value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(tchmi_clone_object(data.value),start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:res.error,details:res.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(res.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})})}}else{if(!designerParam)return Log.errorEx("Internal Error: Invalid code path. Found no control and no designer parameter."),void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression(expression)+": Internal Error: Invalid code path. Found no control and no designer parameter.",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});designerParam.value=currentCloneValue,TcHmi.EventProvider.raise("System.onDesignerUserControlParameterChanged<"+propertyName+">"),TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(designerParam.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,details:{code:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR],reason:this.__printExpression(expression)+": Error while writing sub value.",domain:"TcHmi.System.SymbolTypePartialParam",errors:[data.details?data.details:{code:data.error,message:TcHmi.Errors[data.error]}]},expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})});TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})};if(Array.isArray(prepValue)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){if(Array.isArray(currentSubValue)){let newValue=tchmi_clone_object(currentSubValue),res=this.__symbol.__helper.writeArraySlice(newValue,prepValue,start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,res):void write(currentCloneValue,currentSubValue,newValue,pathTokens,name,propertyName)}return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+": Failed to write value. Current value is not an array.",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}return void write(currentCloneValue,currentSubValue,prepValue,pathTokens,name,propertyName)}return void write(currentCloneValue,currentSubValue,prepValue,pathTokens,name,propertyName)}}{let prepValue=ValueConverter.toSchemaType(newValue,schema);if(null===prepValue&&null!==newValue){let reason,value=newValue;return reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor.name+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+value+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".",void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}const write=(currentValue,newValue)=>{if(this.__symbol)if(control){let error=controlManager.setControlPropertyByAttribute(control,attr,newValue);if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}});if(error&&error.code!==TcHmi.Errors.NONE)TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:error.code,details:error,expression:this.__symbol.getExpression(),expressionResolved:expression});else{let readValue;try{readValue=control[attr.propertyGetterName].call(control)}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+": An uncaught exception occurred in the getter call for preparation of the write operation",exception:e,domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}});if(Array.isArray(readValue)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(tchmi_clone_object(readValue),start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:res.error,details:res.details,expression:this.__symbol.getExpression(),expressionResolved:expression}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(res.value),expressionResolved:expression,expression:this.__symbol.getExpression()})}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(readValue),expressionResolved:expression,expression:this.__symbol.getExpression()})}}else{if(!designerParam)return Log.errorEx("Internal Error: Invalid code path. Found no control and no designer parameter."),void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression(expression)+": Internal Error: Invalid code path. Found no control and no designer parameter.",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression});designerParam.value=currentValue,TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(currentValue),expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})};if(Array.isArray(prepValue)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){if(Array.isArray(currentCloneValue)){let newValue=tchmi_clone_object(currentCloneValue),res=this.__symbol.__helper.writeArraySlice(newValue,prepValue,start,end);return res.error!==TcHmi.Errors.NONE?void TcHmi.Callback.callSafeEx(callback,this.__symbol,res):void write(currentCloneValue,newValue)}return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+": Failed to write value. Current value is not an array.",domain:"TcHmi.System.SymbolTypePartialParam"},expression:this.__symbol.getExpression(),expressionResolved:expression})}return void write(currentCloneValue,prepValue)}return void write(currentCloneValue,prepValue)}})}watch(expression,options,callback,reason){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}}),()=>{};let diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid());let destroyOnPropertyChanged=null,destroyDesignerSymbolDataSourceChanged=null,destroy=()=>{Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch destroy called."),null!==destroyOnPropertyChanged&&(destroyOnPropertyChanged(),destroyOnPropertyChanged=null),null!==destroyDesignerSymbolDataSourceChanged&&(destroyDesignerSymbolDataSourceChanged(),destroyDesignerSymbolDataSourceChanged=null)};const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;let propertyName,designerParam,control,pathTokens=tchmi_clone_object(expression.getPathTokens()),attr=null,pathSanitized="";if(!pathTokens){let res={error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the token of the symbol.",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return res.details.reason+="TCHMI_TARGET_DESIGNER_PARTIALPARAM"!==name?" is not a valid PartialParameter. Expected: UserControlHost::Parameter":" is not a valid PartialParameter. Expected: TCHMI_TARGET_DESIGNER_PARTIALPARAM::Parameter",Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}if(propertyName=pathTokens.shift(),pathTokens.length>0&&(pathSanitized=this.__symbol.__helper.resolveSanitizedPath(pathTokens)),!propertyName)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+" has no valid control property",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;if("TCHMI_TARGET_DESIGNER_PARTIALPARAM"!==name){if(control=TcHmi.Controls.get(name),!control){let res={error:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control instance with id: "+name,domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}if(attr=controlManager.getAttributeByPropertyName(control,propertyName),!attr){let res={error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND],reason:this.__printExpression(expression)+': Can not find attribute definition for property: "'+propertyName+'" of control: "'+name+'" of type: '+control.getType(),domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}if(!attr.propertyGetterName){let res={error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_INVALID_CONFIGURATION,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_INVALID_CONFIGURATION,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_INVALID_CONFIGURATION],reason:this.__printExpression(expression)+': Can not find valid "propertyGetterName" in attribute definition for property: "'+propertyName+'" of control: "'+name+'" of type: "'+control.getType()+'". Please check Description.json.',domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}let last;destroyOnPropertyChanged=TcHmi.EventProvider.register(name+".onPropertyChanged<"+attr.propertyName+">",(e,data)=>{if(!data)return;if(!control)return;if(!attr)return;let params=control.__params;if(params){let param=params.get(attr.name);if(param&&!param.isReady)return}let doWork=!1,dirtyPaths=data.dirtyPaths,dirtyPathsNew=[];if(pathSanitized&&dirtyPaths&&dirtyPaths.length>0)for(let j=0,jj=dirtyPaths.length;j<jj;j++){let dirtyPath=dirtyPaths[j];dirtyPath.startsWith(pathSanitized)&&(doWork=!0,dirtyPath!==pathSanitized?dirtyPathsNew.push(dirtyPath.replace(pathSanitized,"")):pathSanitized.startsWith(dirtyPath)&&(doWork=!0))}else doWork=!0;doWork&&this.read(expression,null,data=>{if(this.__symbol){if(data.error!==TcHmi.Errors.NONE){let res={error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}{let res,value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){if(tchmi_equal(last,value))return;last=tchmi_clone_object(value)}}res=dirtyPathsNew.length>0?{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression(),dirtyPaths:dirtyPathsNew,destroy}:{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy},Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})})})}else{let last;if(destroyDesignerSymbolDataSourceChanged=TcHmi.EventProvider.register("System.onDesignerUserControlParameterChanged<"+propertyName+">",e=>{this.read(expression,null,data=>{if(this.__symbol){if(data.error===TcHmi.Errors.NONE){let res,value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){if(tchmi_equal(last,value))return;last=tchmi_clone_object(value)}}return res={error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy},Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}{let res={error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}}TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})})}),designerParam=userControlParameterManager?.get(propertyName),!designerParam)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:this.__printExpression(expression)+": Unknown template parameter "+propertyName,domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;if(attr=designerParam.descr,!attr)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control attribute with propertyName: "+name,domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy}let isControlSubValue=!1;if(pathTokens&&pathTokens.length>0){let rootSchema=getSchema(attr.type);if(rootSchema&&rootSchema.frameworkInstanceOf&&"TcHmi.Controls.System.TcHmiControl"===rootSchema.frameworkInstanceOf){isControlSubValue=!0;let resControl=null;if(control)resControl=control[attr.propertyGetterName].call(control);else{if(!designerParam)throw new Error("Invalid code path. Found no control and no designer parameter.");resControl=designerParam.value}if(resControl&&resControl instanceof TcHmi.Controls.System.baseTcHmiControl){let resControlId=resControl.getId(),start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0,subSymbol=new SystemSymbol({expression:"%ctrl%"+resControlId+this.__symbol.__helper.resolveSanitizedPath(pathTokens)+(start?"|Start="+start:"")+(end?"|End="+end:"")+"%/ctrl%",ctx:this.__symbol.getContext()});subSymbol.watch(dataSubSymbol=>{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}});if(dataSubSymbol.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR,details:{code:TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBSYMBOL_ERROR],reason:this.__printExpression(expression)+": Failed to watch subsymbol "+subSymbol.getExpression().toString(),domain:"TcHmi.System.Symbol",errors:dataSubSymbol.details?[dataSubSymbol.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{destroy?.(),subSymbol.destroy()}};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}let res={error:TcHmi.Errors.NONE,value:tchmi_clone_object(dataSubSymbol.value),expression:this.__symbol.getExpression(),expressionResolved:expression,destroy:()=>{destroy?.(),subSymbol.destroy()}};Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res)})}else if("TCHMI_TARGET_DESIGNER_PARTIALPARAM"!==name){let res={error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": Missing control instance for parameter: "+propertyName,domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}else this.__symbol.__helper.resolveSchema(expression,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE&&data.schema){let res,defaultValue=resolveDefault(data.schema),value=tchmi_clone_object(defaultValue);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}res={error:TcHmi.Errors.NONE,value,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy},Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:this.__printExpression(expression)+": Failed to resolve schema definition.",domain:"TcHmi.System.Symbol",errors:data.details?[data.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})})}}if(!isControlSubValue){let hasToRead=!0;if(destroyOnPropertyChanged){let params=control.__params;if(params){let param=params.get(attr.name);param&&!param.isReady&&(hasToRead=!1)}}hasToRead&&this.read(expression,null,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){let res,value=tchmi_clone_object(data.value);res={error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy},Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}else{let res={error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypePartialParam"}})})}return destroy}}
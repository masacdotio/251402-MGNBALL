import{Status}from"../API/Animation.js";import{styleManager}from"./StyleManager.js";import*as StyleProvider from"../API/StyleProvider.js";import{Log}from"../API/Log.js";export class AnimationProvider{constructor(){}createAnimationController(animation,statusChangeCallback){return animation.useCss()?new CssAnimationController(animation,statusChangeCallback):new JavaScriptAnimationController(animation,statusChangeCallback)}}let CssAnimationController=(()=>{var _a,_b,_c;let ___onAnimationStart_decorators,___onAnimationIteration_decorators,___onAnimationEnd_decorators,_instanceExtraInitializers=[];return class CssAnimationController{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___onAnimationStart_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___onAnimationIteration_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___onAnimationEnd_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],__esDecorate(this,null,___onAnimationStart_decorators,{kind:"method",name:"__onAnimationStart",static:!1,private:!1,access:{has:obj=>"__onAnimationStart"in obj,get:obj=>obj.__onAnimationStart},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onAnimationIteration_decorators,{kind:"method",name:"__onAnimationIteration",static:!1,private:!1,access:{has:obj=>"__onAnimationIteration"in obj,get:obj=>obj.__onAnimationIteration},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onAnimationEnd_decorators,{kind:"method",name:"__onAnimationEnd",static:!1,private:!1,access:{has:obj=>"__onAnimationEnd"in obj,get:obj=>obj.__onAnimationEnd},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}__animation=__runInitializers(this,_instanceExtraInitializers);__statusChangeCallback;static __styleSheet=new CSSStyleSheet;static __isAdopted=!1;__selector;__elements;__mainRule=null;__keyframeRule=null;__hasStarted=!1;constructor(animation,statusChangeCallback){this.__animation=animation,this.__statusChangeCallback=statusChangeCallback,this.__selector=styleManager.expandSelector(this.__animation.selector(),this.__animation.controlName()),this.__elements=document.querySelectorAll(this.__selector)}isValid(){return this.__animation.useCss()}run(){let doRun=()=>{if(TcHmi.Controls.get(this.__animation.controlName()))if(this.__animation.state()===Status.CONFIGURE||this.__animation.state()===Status.INITIALIZED){this.__statusChangeCallback(Status.INITIALIZED);for(const element of this.__elements)element.addEventListener("animationstart",this.__onAnimationStart),element.addEventListener("animationiteration",this.__onAnimationIteration),element.addEventListener("animationend",this.__onAnimationEnd);this.__writeAnimationToCss()}else this.__animation.state()===Status.PAUSED&&(this.__setAnimationProperty(this.__animation.animationName(),"animationPlayState","running"),this.__hasStarted?this.__statusChangeCallback(Status.RUNNING):this.__statusChangeCallback(Status.INITIALIZED))};this.__animation.state()===Status.ENDED?(this.reset(doRun),this.__statusChangeCallback(Status.INITIALIZED)):doRun()}pause(){this.__animation.state()!==Status.RUNNING&&this.__animation.state()!==Status.INITIALIZED||(this.__setAnimationProperty(this.__animation.animationName(),"animationPlayState","paused"),this.__statusChangeCallback(Status.PAUSED))}skip(){this.cleanup(!0),this.__statusChangeCallback(Status.ENDED);for(const element of this.__elements)element.removeEventListener("animationstart",this.__onAnimationStart),element.removeEventListener("animationiteration",this.__onAnimationIteration),element.removeEventListener("animationend",this.__onAnimationEnd)}reset(callback){if(!this.__mainRule)return this.__statusChangeCallback(Status.CONFIGURE),void callback?.();const keyframe=this.__animation.keyframes().find(keyframe=>0===keyframe.progressPoint);let firstKeyframeRule=null;if(keyframe){let declarations="";for(const[property,values]of Object.entries(keyframe.styles))for(const value of values)declarations+=`\n    ${property}: ${value} !important;`;const ruleIndex=CssAnimationController.__styleSheet.insertRule(`${this.__selector} {${declarations}\n}`);firstKeyframeRule=CssAnimationController.__styleSheet.cssRules[ruleIndex]}this.__setAnimationProperty(this.__animation.animationName(),"animationPlayState","paused"),this.__setAnimationProperty(this.__animation.animationName(),"animationName","reset_"+this.__animation.animationName()),requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(void 0!==TcHmi.Controls.get(this.__animation.controlName())&&this.__mainRule){if(this.__setAnimationProperty("reset_"+this.__animation.animationName(),"animationName",this.__animation.animationName()),firstKeyframeRule){const ruleIndex=[...CssAnimationController.__styleSheet.cssRules].indexOf(firstKeyframeRule);-1!==ruleIndex&&CssAnimationController.__styleSheet.deleteRule(ruleIndex)}this.__statusChangeCallback(Status.CONFIGURE)}callback?.()})}),this.__hasStarted=!1}cleanup(skip=!1){if(this.__mainRule){if("forwards"===this.__animation.fillMode()||"both"===this.__animation.fillMode()||skip){let progressPoint;switch(this.__animation.direction()){case"normal":progressPoint=1;break;case"reverse":progressPoint=0;break;case"alternate":progressPoint=this.__animation.iterationCount()%2==0?0:1;break;case"alternate-reverse":progressPoint=this.__animation.iterationCount()%2==0?1:0}let keyframe=this.__animation.keyframes().find(keyframe=>keyframe.progressPoint===progressPoint);keyframe&&StyleProvider.setSimpleElementStyle(this.__elements,keyframe.styles)}if(this.__setAnimationProperty(this.__animation.animationName(),"animationDuration",null),this.__setAnimationProperty(this.__animation.animationName(),"animationDelay",null),this.__setAnimationProperty(this.__animation.animationName(),"animationIterationCount",null),this.__setAnimationProperty(this.__animation.animationName(),"animationDirection",null),this.__setAnimationProperty(this.__animation.animationName(),"animationTimingFunction",null),this.__setAnimationProperty(this.__animation.animationName(),"animationFillMode",null),this.__setAnimationProperty(this.__animation.animationName(),"animationPlayState",null),this.__setAnimationProperty(this.__animation.animationName(),"animationName",null),""===this.__mainRule.style.animationName){const ruleIndex=[...CssAnimationController.__styleSheet.cssRules].indexOf(this.__mainRule);-1!==ruleIndex&&CssAnimationController.__styleSheet.deleteRule(ruleIndex),this.__mainRule=null}if(this.__keyframeRule){const ruleIndex=[...CssAnimationController.__styleSheet.cssRules].indexOf(this.__keyframeRule);-1!==ruleIndex&&CssAnimationController.__styleSheet.deleteRule(ruleIndex)}}}__writeAnimationToCss(run=!0){let setProperties=!0;if(!this.__mainRule){let mainRule=[...CssAnimationController.__styleSheet.cssRules].find(rule=>rule instanceof CSSStyleRule&&rule.selectorText===this.__selector);if(mainRule)this.__mainRule=mainRule;else{const styles=`${this.__selector} {\n    animation-name: ${this.__animation.animationName()};\n    animation-duration: ${this.__animation.duration()}ms;\n    animation-delay: ${this.__animation.delay()}ms;\n    animation-iteration-count: ${this.__animation.iterationCount().toString()};\n    animation-direction: ${this.__animation.direction()};\n    animation-timing-function: ${this.__animation.timingFunction()};\n    animation-fill-mode: ${this.__animation.fillMode()};\n    animation-play-state: ${run?"running":"paused"};\n}`,ruleIndex=CssAnimationController.__styleSheet.insertRule(styles);this.__mainRule=CssAnimationController.__styleSheet.cssRules[ruleIndex],setProperties=!1}}if(setProperties&&(this.__setAnimationProperty(this.__animation.animationName(),"animationName",this.__animation.animationName()),this.__setAnimationProperty(this.__animation.animationName(),"animationDuration",this.__animation.duration()+"ms"),this.__setAnimationProperty(this.__animation.animationName(),"animationDelay",this.__animation.delay()+"ms"),this.__setAnimationProperty(this.__animation.animationName(),"animationIterationCount",this.__animation.iterationCount().toString()),this.__setAnimationProperty(this.__animation.animationName(),"animationDirection",this.__animation.direction()),this.__setAnimationProperty(this.__animation.animationName(),"animationTimingFunction",this.__animation.timingFunction()),this.__setAnimationProperty(this.__animation.animationName(),"animationFillMode",this.__animation.fillMode()),this.__setAnimationProperty(this.__animation.animationName(),"animationPlayState",run?"running":"paused")),this.__keyframeRule){const ruleIndex=[...CssAnimationController.__styleSheet.cssRules].indexOf(this.__keyframeRule);-1!==ruleIndex&&CssAnimationController.__styleSheet.deleteRule(ruleIndex)}const keyframes=this.__animation.keyframes().map(keyframe=>{let declarations="";for(const[property,values]of Object.entries(keyframe.styles))for(const value of values)declarations+=`\n        ${property}: ${value};`;return`    ${100*keyframe.progressPoint}% {${declarations}\n    }`}),keyframeStyles=`@keyframes ${this.__animation.animationName()} {\n    ${keyframes.join("\n\n")}\n}`,ruleIndex=CssAnimationController.__styleSheet.insertRule(keyframeStyles);this.__keyframeRule=CssAnimationController.__styleSheet.cssRules[ruleIndex],CssAnimationController.__isAdopted||(document.adoptedStyleSheets=[...document.adoptedStyleSheets,CssAnimationController.__styleSheet],CssAnimationController.__isAdopted=!0)}__setAnimationProperty(animationName,property,value){if(!this.__mainRule)return;const animationNames=this.__splitCssValue(this.__mainRule.style.animationName);let animationIndex=animationNames.indexOf(animationName);if(-1===animationIndex){if(!value)return;animationIndex=animationNames.length,animationNames.push(animationName),this.__mainRule.style.animationName=animationNames.join(", ")}const values=this.__splitCssValue(this.__mainRule.style[property]);value?values.splice(animationIndex,1,value):values.splice(animationIndex,1),this.__mainRule.style[property]=values.join(", ")}__splitCssValue(value){let startindex=0,braceCounter=0,quote="",res=[];for(let i=0,ii=value.length;i<ii;i++){const currentChar=value.charAt(i);switch(currentChar){case"(":braceCounter++;break;case")":braceCounter>0&&braceCounter--;break;case'"':case"'":quote?quote===currentChar&&(quote=""):quote=currentChar;break;case"\\":i++;break;case",":0===braceCounter&&!quote&&i>startindex&&(res.push(value.substring(startindex,i).trim()),startindex=i+1)}}return startindex<value.length&&res.push(value.substring(startindex).trim()),res.map(property=>property.trim())}__onAnimationStart(event){event.animationName===this.__animation.animationName()&&(this.__statusChangeCallback(Status.RUNNING),this.__animation.eventHandlers().filter(handler=>"animationstart"===handler.name).forEach(handler=>handler.callback({error:TcHmi.Errors.NONE,animationName:event.animationName,elapsedTime:event.elapsedTime})))}__onAnimationIteration(event){event.animationName===this.__animation.animationName()&&this.__animation.eventHandlers().filter(handler=>"animationiteration"===handler.name).forEach(handler=>handler.callback({error:TcHmi.Errors.NONE,animationName:event.animationName,elapsedTime:event.elapsedTime}))}__onAnimationEnd(event){if(event.animationName===this.__animation.animationName()){this.__statusChangeCallback(Status.ENDED);for(const element of this.__elements)element.removeEventListener("animationstart",this.__onAnimationStart),element.removeEventListener("animationiteration",this.__onAnimationIteration),element.removeEventListener("animationend",this.__onAnimationEnd);this.__animation.cleanup()&&this.cleanup(),this.__animation.eventHandlers().filter(handler=>"animationend"===handler.name).forEach(handler=>handler.callback({error:TcHmi.Errors.NONE,animationName:event.animationName,elapsedTime:event.elapsedTime}))}}}})();export{CssAnimationController};export class JavaScriptAnimationController{__animation;__statusChangeCallback;__element;__animatedStyles={};__initialStyles={};__animationRunner;static __animationFrameID=0;static __animationRunnerList=new Map;static __addAnimation(controller,runner){this.__animationFrameID||(this.__animationFrameID=window.requestAnimationFrame(timestamp=>{const currentRunners=new Map(this.__animationRunnerList);this.__animationRunnerList.clear(),this.__animationFrameID=0;for(const[controller,runner]of currentRunners)runner.call(controller,timestamp)})),this.__animationRunnerList.set(controller,runner)}__start=null;__started=0;__iteration=0;__elapsedTime=0;__resetToInitial=!0;__delayTimer=null;constructor(animation,statusChangeCallback){this.__animation=animation,this.__statusChangeCallback=statusChangeCallback,this.__element=$(styleManager.expandSelector(this.__animation.selector(),this.__animation.controlName()))}isValid(){return!this.__animation.useCss()}run(){if(this.__animation.state()===Status.CONFIGURE||this.__animation.state()===Status.ENDED){this.__animationRunner=this.__getAnimationRunner(),this.__iteration=0,this.__start=null,this.__elapsedTime=0,this.__resetToInitial=!0,this.__animation.delay()>0?this.__delayTimer=new Timer(()=>{this.__animationRunner&&(JavaScriptAnimationController.__addAnimation(this,this.__animationRunner),this.__delayTimer=null)},this.__animation.delay()):JavaScriptAnimationController.__addAnimation(this,this.__animationRunner),this.__statusChangeCallback(Status.INITIALIZED),this.__animatedStyles={};let keyframes=this.__animation.keyframes();for(let i=0,ii=keyframes.length;i<ii;i++)for(let key in keyframes[i].styles)keyframes[i].styles.hasOwnProperty(key)&&(void 0===this.__animatedStyles[key]&&(this.__animatedStyles[key]=[]),this.__animatedStyles[key].push({progressPoint:keyframes[i].progressPoint,values:keyframes[i].styles[key].map(value=>this.__parseKeyframeStyle(value))}));let initialStyles=StyleProvider.getSimpleElementStyle(this.__element);this.__initialStyles={};for(let key in this.__animatedStyles)if(this.__animatedStyles.hasOwnProperty(key)){if(this.__animatedStyles[key].sort((a,b)=>a.progressPoint-b.progressPoint),0!==this.__animatedStyles[key][0].progressPoint||1!==this.__animatedStyles[key][this.__animatedStyles[key].length-1].progressPoint)throw new Error("Start and end keyframes with progress points 0 and 1 must be defined for all animated properties.");this.__initialStyles[key]=initialStyles&&void 0!==initialStyles[key]?initialStyles[key]:null}let fillMode=this.__animation.fillMode();if("backwards"===fillMode||"both"===fillMode)switch(this.__animation.direction()){case"normal":case"alternate":StyleProvider.setSimpleElementStyle(this.__element,keyframes.find(keyframe=>0===keyframe.progressPoint).styles);break;case"reverse":case"alternate-reverse":StyleProvider.setSimpleElementStyle(this.__element,keyframes.find(keyframe=>1===keyframe.progressPoint).styles)}}else this.__animation.state()===Status.PAUSED&&(null!==this.__delayTimer?this.__delayTimer.resume():this.__animationRunner&&JavaScriptAnimationController.__addAnimation(this,this.__animationRunner))}pause(){this.__animation.state()===Status.RUNNING?(JavaScriptAnimationController.__animationRunnerList.delete(this),this.__statusChangeCallback(Status.PAUSED)):this.__animation.state()===Status.INITIALIZED&&null!==this.__delayTimer&&(this.__delayTimer.pause(),this.__statusChangeCallback(Status.PAUSED))}skip(){this.__animation.state()!==Status.ENDED&&(JavaScriptAnimationController.__animationRunnerList.delete(this),this.cleanup(!0),this.__statusChangeCallback(Status.ENDED))}reset(callback){if(this.__resetToInitial&&this.__animation.state()!==Status.CONFIGURE)for(let key in this.__initialStyles)this.__initialStyles.hasOwnProperty(key)&&StyleProvider.setSimpleElementStyle(this.__element,key,this.__initialStyles[key]);this.__statusChangeCallback(Status.CONFIGURE),"function"==typeof callback&&callback()}cleanup(skip=!1){let progressPoint=null;if("forwards"===this.__animation.fillMode()||"both"===this.__animation.fillMode()||skip)switch(this.__animation.direction()){case"normal":progressPoint=1;break;case"reverse":progressPoint=0;break;case"alternate":progressPoint=this.__animation.iterationCount()%2==0?0:1;break;case"alternate-reverse":progressPoint=this.__animation.iterationCount()%2==0?1:0}null===progressPoint?StyleProvider.setSimpleElementStyle(this.__element,this.__initialStyles):StyleProvider.setSimpleElementStyle(this.__element,this.__animation.keyframes().find(keyframe=>keyframe.progressPoint===progressPoint).styles)}__parseKeyframeStyle(value){let numberAndUnitMatch=/^(-?\d*\.?\d+)(?:%|px)?$/.exec(value);if(null!==numberAndUnitMatch)return[parseFloat(numberAndUnitMatch[1]),value.substring(numberAndUnitMatch[1].length)];let parsed=[],hexColorRegEx=/#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3}/g,hexColorMatch=hexColorRegEx.exec(value);for(;null!==hexColorMatch;){let hexString=hexColorMatch[0].slice(1);parsed.push({value:Color.fromHexString(hexString),replaceIndex:hexColorMatch.index,replaceLength:hexColorMatch[0].length}),hexColorMatch=hexColorRegEx.exec(value)}let rgbaColorRegEx=/rgba?\( *(-?\d+) *, *(-?\d+) *, *(-?\d+) *(?:, *(-?\d*\.?\d+) *)?\)/g,rgbaColorMatch=rgbaColorRegEx.exec(value);for(;null!==rgbaColorMatch;){let r=parseInt(rgbaColorMatch[1],10),g=parseInt(rgbaColorMatch[2],10),b=parseInt(rgbaColorMatch[3],10),a=rgbaColorMatch[4]?parseFloat(rgbaColorMatch[4]):1;parsed.push({value:Color.fromRgb(r,g,b,a),replaceIndex:rgbaColorMatch.index,replaceLength:rgbaColorMatch[0].length}),rgbaColorMatch=rgbaColorRegEx.exec(value)}let hslaColorRegEx=/hsla?\( *(-?\d*\.?\d+) *, *(-?\d*\.?\d+)% *, *(-?\d*\.?\d+)% *(?:, *(-?\d*\.?\d+) *)?\)/g,hslaColorMatch=hslaColorRegEx.exec(value);for(;null!==hslaColorMatch;){let h=parseFloat(hslaColorMatch[1]),s=parseFloat(hslaColorMatch[2])/100,l=parseFloat(hslaColorMatch[3])/100,a=hslaColorMatch[4]?parseFloat(hslaColorMatch[4]):1;parsed.push({value:Color.fromHsl(h,s,l,a),replaceIndex:hslaColorMatch.index,replaceLength:hslaColorMatch[0].length}),hslaColorMatch=hslaColorRegEx.exec(value)}let res=[];if(parsed.length>0){parsed.sort((a,b)=>a.replaceIndex-b.replaceIndex);for(let i=parsed.length-1,ii=0;i>=ii;i--){let start=parsed[i].replaceIndex+parsed[i].replaceLength,end=i<parsed.length-1?parsed[i+1].replaceIndex:void 0;start!==end&&start<value.length&&res.unshift(value.substring(start,end)),res.unshift(parsed[i].value)}parsed[0].replaceIndex>0&&res.unshift(value.substring(0,parsed[0].replaceIndex-1))}else res.push(value);let numberRegex=/-?\d*\.?\d+/;for(let i=0,ii=res.length;i<ii;i++){let item=res[i];if("string"==typeof item){let numberMatch=numberRegex.exec(item);if(null!==numberMatch){let replace=[],iIncrement=0;numberMatch.index>0&&(replace.push(item.substring(0,numberMatch.index)),ii++,iIncrement++),replace.push(parseFloat(numberMatch[0])),numberMatch.index+numberMatch[0].length<item.length&&(replace.push(item.substring(numberMatch.index+numberMatch[0].length)),ii++),res.splice(i,1,...replace),i+=iIncrement}}}return res}__getTimingFunction(){let tf=this.__animation.timingFunction();if("function"==typeof tf)return tf;function createCubicBezier(x1,y1,x2,y2){let points=[{x:0,y:0},{x:x1,y:y1},{x:x2,y:y2},{x:1,y:1}];return x=>{function reduce(points,t){let reduced=[];for(let i=0;i<points.length-1;i++){let x=points[i].x+(points[i+1].x-points[i].x)*t,y=points[i].y+(points[i+1].y-points[i].y)*t;reduced.push({x,y})}return 1===reduced.length?reduced[0]:reduce(reduced,t)}let point={x:0,y:0},t=.5,lowerBound=0,upperBound=1;for(let i=0;i<10;i++){if(point=reduce(points,t),Math.abs(point.x-x)<5e-4)return point.y;point.x<x?lowerBound=t:upperBound=t,t=lowerBound+(upperBound-lowerBound)/2}return point.y}}function createSteps(count,startLeft){let step=1/count;return t=>startLeft?Math.ceil(t/step)*step:Math.floor(t/step)*step}switch(tf){case"linear":return t=>t;case"ease":return createCubicBezier(.25,.1,.25,1);case"ease-in":return createCubicBezier(.42,0,1,1);case"ease-out":return createCubicBezier(0,0,.58,1);case"ease-in-out":return createCubicBezier(.42,0,.58,1);case"step-start":return createSteps(1,!0);case"step-end":return createSteps(1,!1);default:let bezierMatch=/cubic-bezier\( *(1(?:.0+)?|0|0?\.\d+) *, *(-?\d*\.?\d+) *, *(1(?:.0+)?|0|0?\.\d+) *, *(-?\d*\.?\d+) *\)/.exec(tf);if(null!==bezierMatch)return createCubicBezier(parseFloat(bezierMatch[1]),parseFloat(bezierMatch[2]),parseFloat(bezierMatch[3]),parseFloat(bezierMatch[4]));let stepMatch=/steps\( *([1-9][0-9]*) *(?:, *(start|end) *)?\)/.exec(tf);if(null!==stepMatch)return createSteps(parseInt(stepMatch[1],10),"start"===stepMatch[2])}return Log.error(`[Source=Framework, Module=TcHmi.System.AnimationProvider] Unknown timing function ${tf}.`),createCubicBezier(.25,.1,.25,1)}__getAnimationRunner(){let directionFunction,duration=this.__animation.duration(),timingFunction=this.__getTimingFunction();switch(this.__animation.direction()){case"normal":directionFunction=progress=>progress;break;case"reverse":directionFunction=progress=>1-progress;break;case"alternate":directionFunction=progress=>this.__iteration%2==0?progress:1-progress;break;case"alternate-reverse":directionFunction=progress=>this.__iteration%2==0?1-progress:progress}let doRun=timestamp=>{if(null===this.__start)this.__started=this.__start=timestamp,this.__statusChangeCallback(Status.RUNNING),this.__animation.eventHandlers().filter(handler=>"animationstart"===handler.name).forEach(handler=>handler.callback({error:TcHmi.Errors.NONE,animationName:this.__animation.animationName(),elapsedTime:0}));else if(this.__animation.state()===Status.PAUSED){let pausedTime=timestamp-this.__elapsedTime-this.__start;this.__start+=pausedTime,this.__started+=pausedTime,this.__statusChangeCallback(Status.RUNNING)}this.__elapsedTime=timestamp-this.__start;let progress=this.__elapsedTime/duration;progress=directionFunction(progress);let styles={};for(let key in this.__animatedStyles)if(this.__animatedStyles.hasOwnProperty(key)){let keyframes=this.__getBorderingKeyframes(key,progress);if(1===keyframes.length)styles[key]=keyframes[0].values.map(value=>value.join(""));else{let interFrameProgress=(progress-keyframes[0].progressPoint)/(keyframes[1].progressPoint-keyframes[0].progressPoint);styles[key]=this.__interpolate(keyframes[0].values,keyframes[1].values,timingFunction(interFrameProgress))}}try{StyleProvider.setSimpleElementStyle(this.__element,styles)}catch(ex){return void this.__statusChangeCallback(Status.PAUSED)}if(progress>=0&&progress<=1)JavaScriptAnimationController.__addAnimation(this,doRun);else{this.__iteration++;let iterationCount=this.__animation.iterationCount();"infinite"===iterationCount||this.__iteration<iterationCount?(this.__start=timestamp,JavaScriptAnimationController.__addAnimation(this,doRun),this.__animation.eventHandlers().filter(handler=>"animationiteration"===handler.name).forEach(handler=>handler.callback({error:TcHmi.Errors.NONE,animationName:this.__animation.animationName(),elapsedTime:(timestamp-this.__started)/1e3}))):(JavaScriptAnimationController.__animationRunnerList.delete(this),this.__statusChangeCallback(Status.ENDED),this.__animation.cleanup()&&(this.__resetToInitial=!1),this.cleanup(),this.__animation.eventHandlers().filter(handler=>"animationend"===handler.name).forEach(handler=>handler.callback({error:TcHmi.Errors.NONE,animationName:this.__animation.animationName(),elapsedTime:(timestamp-this.__started)/1e3})))}};return doRun}__getBorderingKeyframes(style,progress){let styles=this.__animatedStyles[style];for(let i=0,ii=styles.length;i<ii;i++){if(styles[i].progressPoint===progress)return[styles[i]];if(styles[i].progressPoint>progress)return i<1?[styles[i]]:[styles[i-1],styles[i]]}return[styles[styles.length-1]]}__interpolate(start,end,progress){let res=[];function numInterpolate(start,end){return start+(end-start)*progress}for(let i=0,ii=Math.min(start.length,end.length);i<ii;i++){let interpolated=[];for(let j=0,jj=Math.max(start[i].length,end[i].length);j<jj;j++){let startValue=start[i][j],endValue=end[i][j],startType=typeof startValue,endType=typeof endValue;if(void 0===startValue){switch(endType){case"string":startValue=endValue;break;case"number":startValue=0;break;case"object":startValue=Color.fromRgb(0,0,0,0)}startType=endType}if(void 0===endValue){switch(startType){case"string":endValue=startValue;break;case"number":endValue=0;break;case"object":endValue=Color.fromRgb(0,0,0,0)}endType=startType}if(startType!==endType||"string"===startType)interpolated.push(progress<.5?startValue:endValue);else switch(startType){case"number":interpolated.push(numInterpolate(startValue,endValue));break;case"object":interpolated.push(Color.fromRgb(numInterpolate(startValue.red,endValue.red),numInterpolate(startValue.green,endValue.green),numInterpolate(startValue.blue,endValue.blue),numInterpolate(startValue.alpha,endValue.alpha)))}}res.push(interpolated.join(""))}return res}}class Timer{__callback;__timerId=0;__start=0;__remaining;constructor(callback,delay){this.__callback=callback,this.__remaining=delay,this.resume()}pause(){window.clearTimeout(this.__timerId),this.__remaining-=Date.now()-this.__start}resume(){this.__start=Date.now(),window.clearTimeout(this.__timerId),this.__timerId=window.setTimeout(this.__callback,this.__remaining)}}class Color{red;green;blue;alpha;constructor(red,green,blue,alpha){function clamp(num,min,max){return num<=min?min:num>=max?max:num}this.red=Math.round(clamp(red,0,255)),this.green=Math.round(clamp(green,0,255)),this.blue=Math.round(clamp(blue,0,255)),this.alpha=clamp(alpha,0,1)}static fromRgb(r,g,b,a=1){return new Color(r,g,b,a)}static fromHsl(h,s,l,a=1){function clamp(num,min,max){return num<=min?min:num>=max?max:num}let r,g,b;if(h=clamp(h%360/360,0,1),s=clamp(s,0,1),l=clamp(l,0,1),0===s)r=g=b=l;else{let hue2rgb=(p,q,t)=>(t<0&&(t+=1),t>1&&(t-=1),t<1/6?p+6*(q-p)*t:t<.5?q:t<2/3?p+(q-p)*(2/3-t)*6:p),q=l<.5?l*(1+s):l+s-l*s,p=2*l-q;r=hue2rgb(p,q,h+1/3),g=hue2rgb(p,q,h),b=hue2rgb(p,q,h-1/3)}return new Color(255*r,255*g,255*b,a)}static fromHexString(hex){return 3===hex.length&&(hex=hex.replace(/./g,"$&$&")),new Color(parseInt(hex.substr(0,2),16),parseInt(hex.substr(2,2),16),parseInt(hex.substr(4,2),16),1)}toString(){return`rgba(${this.red}, ${this.green}, ${this.blue}, ${this.alpha})`}}export const animationProvider=new AnimationProvider;
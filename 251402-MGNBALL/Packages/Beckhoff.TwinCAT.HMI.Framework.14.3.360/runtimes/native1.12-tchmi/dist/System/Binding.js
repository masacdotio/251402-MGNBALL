import{ControlAttributeType}from"./_Types.js";import{bindingManager}from"./BindingManager.js";import{controlManager}from"./ControlManager.js";import{compareISO8601ServerCommandDateTimeStrings,compareISO8601ServerCommandDurationStrings}from"./SystemFunctions.js";import{typeManager}from"./Type.TypeManager.js";import{Symbol as SystemSymbol}from"./Symbol.js";import{config,Data,isPreloaded}from"./System.js";import*as Server from"../API/Server.js";import{Log}from"../API/Log.js";import*as ValueConverter from"../API/ValueConverter.js";var ReferenceHandlingType;!function(ReferenceHandlingType){ReferenceHandlingType[ReferenceHandlingType.None=0]="None",ReferenceHandlingType[ReferenceHandlingType.Symbol=1]="Symbol",ReferenceHandlingType[ReferenceHandlingType.Generic=2]="Generic"}(ReferenceHandlingType||(ReferenceHandlingType={}));let Binding=(()=>{var _a,_b,_c,_d,_e;let ___onBindingEvent_decorators,___onPropertyChanged_decorators,___onWatchExpressionCallback_decorators,___onWatchCallback_decorators,___onReadCallback_decorators,_classSuper=TcHmi.Destroyable,_instanceExtraInitializers=[];return class Binding extends _classSuper{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;___onBindingEvent_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___onPropertyChanged_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___onWatchExpressionCallback_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],___onWatchCallback_decorators=[(_d=TcHmi).CallbackMethod.bind(_d)],___onReadCallback_decorators=[(_e=TcHmi).CallbackMethod.bind(_e)],__esDecorate(this,null,___onBindingEvent_decorators,{kind:"method",name:"__onBindingEvent",static:!1,private:!1,access:{has:obj=>"__onBindingEvent"in obj,get:obj=>obj.__onBindingEvent},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onPropertyChanged_decorators,{kind:"method",name:"__onPropertyChanged",static:!1,private:!1,access:{has:obj=>"__onPropertyChanged"in obj,get:obj=>obj.__onPropertyChanged},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onWatchExpressionCallback_decorators,{kind:"method",name:"__onWatchExpressionCallback",static:!1,private:!1,access:{has:obj=>"__onWatchExpressionCallback"in obj,get:obj=>obj.__onWatchExpressionCallback},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onWatchCallback_decorators,{kind:"method",name:"__onWatchCallback",static:!1,private:!1,access:{has:obj=>"__onWatchCallback"in obj,get:obj=>obj.__onWatchCallback},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onReadCallback_decorators,{kind:"method",name:"__onReadCallback",static:!1,private:!1,access:{has:obj=>"__onReadCallback"in obj,get:obj=>obj.__onReadCallback},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}static __compareTiming(a,b){return"0.0.0.0"===Server.getApiVersion()?compareISO8601ServerCommandDateTimeStrings(a,b):compareISO8601ServerCommandDurationStrings(a,b)}constructor(expression,propertyName,control,options){if(super(),(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(this.__diagGUID=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, ObjectScopeDiagGUID="+this.__diagGUID+"] constructor called with:",{expression,propertyName,control}),!expression){let message='Invalid value: "'+expression+'" for parameter: "expression".';throw Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, ObjectScopeDiagGUID="+this.__diagGUID+"] constructor failed with: "+message),new Error(message)}if(!propertyName){let message='Invalid value: "'+propertyName+'" for parameter: "propertyName".';throw Log.debugEx("[Source=Framework, ObjectScopeDiagGUID="+this.__diagGUID+"] constructor failed with: "+message),new Error(message)}if(!control)throw Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, ObjectScopeDiagGUID="+this.__diagGUID+'] constructor failed with invalid value "',control,'" for parameter: "control".'),new Error('Invalid value: "'+control+'" for parameter: "control".');this.__expression=expression,this.__propertyName=propertyName,this.__control=control,this.__controlId=control.getId(),this.__stateOld=this.__state,this.__state=State.Initializing,this.__preload=!1,this.__partial=null,this.__ctx=options?.ctx??void 0,this.__symbol=new SystemSymbol({expression,ctx:this.__ctx}),this.__symbol.claimDestroyPrivilege();let attr=controlManager.getAttributeByPropertyName(this.__control,this.__propertyName);if(!attr){let message='The attribute property name: "'+this.__propertyName+'" does not exist for control: '+control.getId();throw Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+propertyName+", Symbol="+expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] constructor failed with: "+message),new Error(message)}this.__attr=attr,this.__attrSchema=typeManager.getSchema(this.__attr.type);let parent=this.__control.getParent();for(;null!==parent;){let parentType=parent.getType();if(("TcHmi.Controls.System.TcHmiView"===parentType||"TcHmi.Controls.System.TcHmiContent"===parentType||"TcHmi.Controls.System.TcHmiUserControl"===parentType)&&(this.__partial||(this.__partial=parent),"TcHmi.Controls.System.TcHmiView"===parentType||"TcHmi.Controls.System.TcHmiContent"===parentType)){let partialUrl=tchmi_path(parent.getElement()[0].getAttribute("data-tchmi-partial-url"));if(partialUrl&&!0===Data.isPreloadBindingPartial.get(partialUrl)){this.__preload=!0;break}}parent=parent.getParent()}this.__partial?this.__onInitializedDestroyCallback=TcHmi.EventProvider.register(this.__partial.getId()+".System.onInitialized",()=>{this.__resume({reason:this.__partial?.getId()+".onInitialized>BindingResume>"+this.__expression})}):this.__onInitializedDestroyCallback=TcHmi.EventProvider.register(this.__control.getId()+".System.onInitialized",()=>{this.__resume({reason:this.__controlId+".onInitialized>BindingResume>"+this.__expression})}),this.__onControlAttachedDestroyCallback=TcHmi.EventProvider.register(this.__control.getId()+".System.onAttached",()=>{this.__resume({reason:this.__controlId+".onAttached>BindingResume>"+this.__expression})}),this.__onControlDetachedDestroyCallback=TcHmi.EventProvider.register(this.__control.getId()+".System.onDetached",()=>{this.__suspend()}),this.__stateWatcher=new Set,this.__attr.allowEarlySymbolReferenceInjection&&this.__resume()}__diagGUID=(__runInitializers(this,_instanceExtraInitializers),"");__stateOld=State.Invalid;__stateWatcher;__attr;__attrSchema;__lockWriteToControl=!1;__lockWriteToControlValue;__lockWatchError=!1;__lockLastWriteError=!1;__lastReportedError;__pendingWriteCount=0;__latestWrite=!1;__latestWriteProcessedStart;__latestWriteProcessedEnd;__forwardWriteToSymbolResponse=!1;__pendingForceReadRequestId=null;__resumeLock=!1;__resumeStage=0;__destroyWatchExpression=null;__destroyWatch=null;__destroyRead=null;__destroyWrite=new Set;__destroyHostPreloadingBindingsWatch=null;__destroyReferenceWatch=null;__referenceWatchSymbol=null;__referenceBinding=null;__destroyReferencBindingStateWatch=null;__ctx;destroy(){if(this.isDestroyed())return void Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, ObjectScopeDiagGUID="+this.__diagGUID+"] destroy called and aborted because object is already marked as destroyed.");if(this.__releaseDestroyPrivilege(),!this.isDestroyable())return;let diagControlId=this.__controlId,diagPropertyName=this.__propertyName,diagSymbolExpression=this.__symbol?.getExpression().toString();Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+diagControlId+", Property="+diagPropertyName+", Symbol="+diagSymbolExpression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] destroy called."),this.__control=null,this.__destroyReferencBindingStateWatch?.(),this.__destroyReferencBindingStateWatch=null,this.__destroyReferenceWatch?.(),this.__destroyReferenceWatch=null,this.__referenceBinding?.destroy(),this.__referenceBinding=null,this.__destroyRead?.(),this.__destroyRead=null;for(const destr of this.__destroyWrite)destr();if(this.__destroyWrite.clear(),this.__destroyWatchExpression?.(),this.__destroyWatchExpression=null,this.__destroyWatch?.(),this.__destroyWatch=null,this.__symbol?.destroy(),this.__symbol=null,this.__destroyHostPreloadingBindingsWatch?.(),this.__destroyHostPreloadingBindingsWatch=null,this.__onPropertyChangedDestroyCallback?.(),this.__onPropertyChangedDestroyCallback=null,this.__onBindingEventDestroyCallbacks)for(;this.__onBindingEventDestroyCallbacks.length>0;){let onBindingEventDestroyCallback=this.__onBindingEventDestroyCallbacks.shift();onBindingEventDestroyCallback?.(),onBindingEventDestroyCallback=void 0}this.__onInitializedDestroyCallback?.(),this.__onInitializedDestroyCallback=null,this.__onControlAttachedDestroyCallback?.(),this.__onControlAttachedDestroyCallback=null,this.__onControlDetachedDestroyCallback?.(),this.__onControlDetachedDestroyCallback=null,this.__stateOld=this.__state,this.__state=State.Destroyed,this.__procWatchState(),this.__stateWatcher.clear(),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+diagControlId+", Property="+diagPropertyName+", Symbol="+diagSymbolExpression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] destroy finished.")}__waitForPreloadBindings(callback){if(this.__partial&&"TcHmi.Controls.System.TcHmiUserControl"===this.__partial.getType()){const host=this.__partial.getParent();if(host){let hostId=host.getId();const waitForPreloadingBindings=host=>{let preloadingBindings=bindingManager.getPreloadingBindingsByControl(host);if(preloadingBindings.size>0){let preloadingBindingsDone=0;this.__destroyHostPreloadingBindingsWatch=bindingManager.watchPreloadingBindingDoneByControl(host,data=>{if(preloadingBindings.has(data.binding))return preloadingBindingsDone++,preloadingBindingsDone===preloadingBindings.size?(preloadingBindings=bindingManager.getPreloadingBindingsByControl(host),void(0===preloadingBindings.size?(data.destroy?.(),this.__destroyHostPreloadingBindingsWatch&&(this.__destroyHostPreloadingBindingsWatch=null),TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})):preloadingBindingsDone=0)):void 0})}else TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})};return host.getIsInitialized()?void waitForPreloadingBindings(host):void TcHmi.EventProvider.register(hostId+".System.onInitialized",()=>{waitForPreloadingBindings(host)})}}TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})}__referenceHandlingRequired(callback){this.__control&&this.__symbol&&this.__symbol.resolveSchema(data=>{if(data.error===TcHmi.Errors.NONE){if(this.__control&&this.__symbol)return"TcHmi.Symbol"!==this.__attrSchema?.frameworkInstanceOf?"TcHmi.Symbol"!==data.schema?.frameworkInstanceOf?void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:ReferenceHandlingType.None}):data.expressionResolved?void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,expression:data.expression,expressionResolved:data.expressionResolved,result:"Value"===data.expressionResolved.getOptions().ReferenceResolution?ReferenceHandlingType.Generic:ReferenceHandlingType.None}):void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result:ReferenceHandlingType.None}):void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,expression:data.expression,expressionResolved:data.expressionResolved,result:ReferenceHandlingType.Symbol})}else TcHmi.Callback.callSafeEx(callback,this,{error:data.error,details:data.details,expression:data.expression,expressionResolved:data.expressionResolved})})}__handleReference(type,resumeArgs){this.__control&&this.__symbol&&type!==ReferenceHandlingType.None?this.__waitForPreloadBindings(data=>{if(!this.__control)return void(this.__resumeLock=!1);if(!this.__symbol)return void(this.__resumeLock=!1);let isAttached=this.__control.getIsAttached();if(this.__state===State.Initialized&&!isAttached)return Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__control.getId()+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+'] __resume aborted because binding is already in state "Initialized" and control is not attached to dom.'),void(this.__resumeLock=!1);isAttached&&(this.__stateOld=this.__state,this.__state=State.Resuming,this.__procWatchState(),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__control.getId()+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+'] __resume switches state to "Resuming".')),this.__destroyReferencBindingStateWatch?.(),this.__destroyReferencBindingStateWatch=null,this.__destroyReferenceWatch?.(),this.__destroyReferenceWatch=null,this.__referenceWatchSymbol?.destroy(),this.__referenceWatchSymbol=null,this.__referenceWatchSymbol=new TcHmi.Symbol({expression:this.__symbol.getExpression().toString(),ctx:this.__symbol.getContext()}),this.__referenceWatchSymbol.claimDestroyPrivilege(),this.__destroyReferenceWatch=this.__referenceWatchSymbol.watchReference(data=>{if(data.error!==TcHmi.Errors.NONE){Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] "+Log.buildMessage(data.details));let reset=!1;if("Reset"===config.binding.symbolError?reset=!0:"Ignore"===config.binding.symbolError&&(reset=!1),data.expressionResolved){let options=data.expressionResolved.getOptions();"Reset"===options.BindingErrorHandling?reset=!0:"Ignore"===options.BindingErrorHandling&&(reset=!1)}return reset&&this.__writeToControl(null),this.__stateOld=this.__state,this.__state=State.Error,this.__resumeLock=!1,void this.__procWatchState()}if(this.__state===State.Error){let restoredState=this.__stateOld;this.__stateOld=this.__state,this.__state=restoredState,this.__procWatchState()}if(!this.__control)return void(this.__resumeLock=!1);if(!this.__symbol)return void(this.__resumeLock=!1);let ref=data.ref;if(ref)switch(type){case ReferenceHandlingType.Symbol:if(this.__state===State.Initializing||this.__state===State.Resuming){const referenceDelegation=ref.getReferenceDelegation();if(ref.claimDestroyPrivilege(),this.__writeToControl(ref),referenceDelegation&&referenceDelegation.preload&&this.__preload&&!isPreloaded){this.__stateOld=this.__state,this.__state=State.Preloading,this.__procWatchState();let done=!1;const timeout=setTimeout(()=>{this.__state!==State.Initialized&&this.__state!==State.Ready&&(this.__stateOld=this.__state,this.__state=State.Initialized,this.__resumeLock=!1,done=!0,this.__procWatchState())},config.tcHmiServer.websocketSystemTimeout);return void referenceDelegation.preload(()=>{if(clearTimeout(timeout),done)return;if(this.__state===State.Initialized||this.__state===State.Ready)return;this.__resumeLock=!1,this.__stateOld=this.__state,this.__state=State.Initialized,this.__procWatchState();let isAttached=this.__control?.getIsAttached();isAttached?(this.__stateOld=this.__state,this.__state=State.Ready,this.__procWatchState()):this.__suspend(),done=!0,Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __resume finished.")})}return this.__resumeLock=!1,this.__stateOld=this.__state,this.__state=State.Initialized,this.__procWatchState(),this.__control.getIsAttached()?(this.__stateOld=this.__state,this.__state=State.Ready,this.__procWatchState()):this.__suspend(),void Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __resume finished.")}this.__resumeLock=!1;break;case ReferenceHandlingType.Generic:{this.__preload&&!isPreloaded&&(this.__stateOld=this.__state,this.__state=State.Preloading,this.__procWatchState()),this.__referenceBinding||(this.__referenceBinding=new Binding(ref.getExpression().toString(),this.__propertyName,this.__control,{ctx:this.__ctx}));const timeout=setTimeout(()=>{this.__destroyReferencBindingStateWatch?.(),this.__destroyReferencBindingStateWatch=null,this.__resumeLock=!1,this.__stateOld=this.__state,this.__state=State.Initialized,this.__procWatchState();let isAttached=this.__control?.getIsAttached();isAttached?(this.__stateOld=this.__state,this.__state=State.Ready,this.__procWatchState()):this.__suspend()},config.tcHmiServer.websocketSystemTimeout);this.__destroyReferencBindingStateWatch=this.__referenceBinding.watchState(data=>{if(data.error===TcHmi.Errors.NONE&&(data.state===State.Initialized||data.state===State.Ready)||data.error!==TcHmi.Errors.NONE){clearTimeout(timeout),data.destroy&&(data.destroy(),this.__destroyReferencBindingStateWatch=null),this.__resumeLock=!1,this.__stateOld=this.__state,this.__state=State.Initialized,this.__procWatchState();let isAttached=this.__control?.getIsAttached();isAttached?(this.__stateOld=this.__state,this.__state=State.Ready,this.__procWatchState()):this.__suspend()}}),this.__referenceBinding.__resume(resumeArgs)}break;default:this.__resumeLock=!1}else this.__resumeLock=!1})}):this.__resumeLock=!1}__resume(args){if(Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __resume called."),!this.__resumeLock){if(this.__resumeLock=!0,!this.__control)return Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __resume aborted. Binding is already destroyed."),void(this.__resumeLock=!1);if(!this.__symbol)return Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __resume aborted. Binding is already destroyed."),void(this.__resumeLock=!1);if(this.__state===State.Ready)return Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __resume aborted. State is already Ready."),void(this.__resumeLock=!1);if(!isPreloaded&&!args?.forcePreload)return Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __resume aborted. System is not preloaded and forced preload is not set."),void(this.__resumeLock=!1);if(0===this.__resumeStage)return Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __resumeStage 0"),this.__state!==State.Initializing&&this.__state!==State.Suspended?void Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__control.getId()+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+'] __resume stage 0 aborted because binding is neither in state "Initializing" or "Suspended".'):void this.__referenceHandlingRequired(data=>{if(data.error!==TcHmi.Errors.NONE){Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] "+Log.buildMessage(data.details));let reset=!1;if("Reset"===config.binding.symbolError?reset=!0:"Ignore"===config.binding.symbolError&&(reset=!1),data.expressionResolved){let options=data.expressionResolved.getOptions();"Reset"===options.BindingErrorHandling?reset=!0:"Ignore"===options.BindingErrorHandling&&(reset=!1)}return reset&&this.__writeToControl(null),this.__stateOld=this.__state,this.__state=State.Error,this.__resumeLock=!1,void this.__procWatchState()}return void 0!==data.result&&data.result!==ReferenceHandlingType.None?void this.__handleReference(data.result,args):(this.__resumeLock=!1,this.__resumeStage=1,void this.__resume(args))});if(1===this.__resumeStage){if(!this.__control.getIsInitialized())return Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__control.getId()+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __resume aborted. Control is not initialized."),void(this.__resumeLock=!1);if(this.__state!==State.Initializing&&this.__state!==State.Preloading&&this.__state!==State.Initialized&&this.__state!==State.Suspended&&this.__state!==State.Error||!this.__symbol)return Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__control.getId()+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+'] __resume aborted because binding is neither in state "Initializing", "Preloading", "Initialized", "Suspended" or "Error". Current state is '+this.__state),void(this.__resumeLock=!1);let isAttached=this.__control.getIsAttached();return this.__state!==State.Initialized||isAttached?isAttached?(this.__stateOld=this.__state,this.__state=State.Resuming,this.__procWatchState(),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__control.getId()+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+'] __resume switches state to "Resuming".'),this.__resumeLock=!1,this.__resumeStage=2,void this.__resume(args)):!isPreloaded&&this.__preload?(this.__stateOld=this.__state,this.__state=State.Preloading,this.__procWatchState(),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__control.getId()+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+'] __resume switches state to "Preloading".'),void this.__waitForPreloadBindings(data=>{this.__resumeLock=!1,this.__resumeStage=2,this.__resume(args)})):void(this.__resumeLock=!1):(Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__control.getId()+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+'] __resume aborted because binding is already in state "Initialized" and control is not attached to dom.'),void(this.__resumeLock=!1))}return 2===this.__resumeStage?(this.__resumeStage=0,this.__state===State.Preloading?void(this.__symbol.isProcessedAsync()?this.__symbol.readEx({forceParallel:!0,forceReadWriteGroup:"TCHMI_BINDING_PRELOAD"},this.__onReadCallback):queueMicrotask(()=>{this.__symbol?.readEx({forceParallel:!0,forceReadWriteGroup:"TCHMI_BINDING_PRELOAD"},this.__onReadCallback)})):this.__state===State.Resuming?(this.__propertyName&&(this.__destroyWatchExpression=this.__symbol.watchExpression(this.__onWatchExpressionCallback)),void Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__control.getId()+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __resume finished.")):void(this.__resumeLock=!1)):void 0}Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __resume aborted. Pending lock.")}__suspend(){if(Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __suspend called."),this.__destroyWatchExpression?.(),this.__destroyWatchExpression=null,this.__destroyWatch?.(),this.__destroyWatch=null,this.__onPropertyChangedDestroyCallback?.(),this.__onPropertyChangedDestroyCallback=null,this.__onBindingEventDestroyCallbacks)for(;this.__onBindingEventDestroyCallbacks.length>0;){let onBindingEventDestroyCallback=this.__onBindingEventDestroyCallbacks.shift();onBindingEventDestroyCallback?.(),onBindingEventDestroyCallback=void 0}this.__destroyReferenceWatch?.(),this.__destroyReferenceWatch=null,this.__referenceWatchSymbol?.destroy(),this.__referenceWatchSymbol=null,this.__destroyReferencBindingStateWatch?.(),this.__destroyReferencBindingStateWatch=null,this.__referenceBinding?.__suspend(),this.__stateOld=this.__state,this.__state=State.Suspended,this.__procWatchState(),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __suspend finished.")}__expression;getExpression(){return this.__expression}__symbol;getSymbol(){return this.__symbol}__propertyName;getPropertyName(){return this.__propertyName}__controlId="Unknown";__control;getControl(){return this.__control}__state=State.Invalid;getState(){return this.__state}__preload;getPreload(){return this.__preload}__partial;getPartial(){return this.__partial}__onInitializedDestroyCallback=null;__onControlAttachedDestroyCallback=null;__onControlDetachedDestroyCallback=null;__onBindingEventDestroyCallbacks=[];__onBindingEvent(){if(Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] __onBindingEvent called."),this.__state===State.Ready){if(!this.__lockWatchError&&this.__control&&void 0!==this.__control[this.__attr.propertyGetterName]){let value=this.__control[this.__attr.propertyGetterName].call(this.__control);if(this.__lockWriteToControl&&tchmi_equal(this.__lockWriteToControlValue,value))return void Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+'] __onBindingEvent aborted because of "__lockWriteToControl".');this.__writeToSymbol(tchmi_clone_object(value))}}else Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+']  __onBindingEvent because Binding is not in state "Ready".')}__onPropertyChangedDestroyCallback=null;__onPropertyChanged(_event,data){if(Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"]  __onPropertyChanged"),this.__state===State.Ready)if(data){if(!this.__lockWatchError&&this.__control&&void 0!==this.__control[this.__attr.propertyGetterName]){let value=this.__control[this.__attr.propertyGetterName].call(this.__control);if(this.__lockWriteToControl&&tchmi_equal(this.__lockWriteToControlValue,value))return void Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+']  __onPropertyChanged aborted because of "__lockWriteToControl".');this.__writeToSymbol(tchmi_clone_object(value),data.dirtyPaths)}}else Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+']  __onPropertyChanged aborted because "data" is not defined.');else Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+']  __onPropertyChanged aborted because Binding is not in state "Ready".')}__onWatchExpressionCallback(data){let guid="";if(TCHMI_CONSOLE_LOG_LEVEL>=4&&(guid=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__symbol?.getExpression().toString()+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onWatchExpressionCallback called with:",{data}),!this.__control)return;if(data.error!==TcHmi.Errors.NONE){this.__lockWatchError=!0;let message="[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] ";if(data.details?message+=Log.buildMessage(data.details):message+=Log.buildMessage({code:data.error,message:TcHmi.Errors[data.error]}),Log.error(message),this.__lockWriteToControl&&null===this.__lockWriteToControlValue)return void Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+'] __onWatchExpressionCallback aborted because of "__lockWriteToControl".');let reset=!1;if("Reset"===config.binding.symbolError?reset=!0:"Ignore"===config.binding.symbolError&&(reset=!1),data.expressionResolved){let options=data.expressionResolved.getOptions();"Reset"===options.BindingErrorHandling?reset=!0:"Ignore"===options.BindingErrorHandling&&(reset=!1)}return void(reset&&this.__writeToControl(null))}const expression=data.value;if(!expression)return;if(!this.__symbol)return void Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__control.getId()+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onWatchExpressionCallback aborted because symbol object is not defined.");if(this.__onPropertyChangedDestroyCallback&&(this.__onPropertyChangedDestroyCallback(),this.__onPropertyChangedDestroyCallback=null),this.__onBindingEventDestroyCallbacks)for(;this.__onBindingEventDestroyCallbacks.length>0;){let onBindingEventDestroyCallback=this.__onBindingEventDestroyCallbacks.shift();onBindingEventDestroyCallback?.(),onBindingEventDestroyCallback=void 0}let bindingMode=expression.getOptions().BindingMode,attrType=controlManager.getAttributeTypeByPropertyName(this.__control,this.__propertyName);if("TwoWay"===bindingMode||!bindingMode&&attrType===ControlAttributeType.UserControlParameter||!bindingMode&&this.__attr&&"TwoWay"===this.__attr.defaultBindingMode){let bindingEvents=expression.getOptions().BindingEvents;if(bindingEvents)for(let i=0,ii=bindingEvents.length;i<ii;i++){let bindingEvent=bindingEvents[i];this.__onBindingEventDestroyCallbacks.push(TcHmi.EventProvider.register(this.__controlId+"."+bindingEvent,this.__onBindingEvent))}else this.__onPropertyChangedDestroyCallback=TcHmi.EventProvider.register(this.__controlId+".onPropertyChanged<"+this.__propertyName+">",this.__onPropertyChanged)}this.__destroyWatch||(this.__destroyWatch=this.__symbol.watchEx(null,this.__onWatchCallback))}__onWatchCallback(data){let guid="";if(TCHMI_CONSOLE_LOG_LEVEL>=4&&(guid=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__symbol?.getExpression().toString()+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onWatchCallback called with:",{data}),null!==this.__pendingForceReadRequestId&&(Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onWatchCallback release pending forced read request with id: "+this.__pendingForceReadRequestId),Server.releaseRequest(this.__pendingForceReadRequestId),this.__pendingForceReadRequestId=null),this.__state===State.Ready||this.__state===State.Resuming||this.__state===State.Error)if(this.__symbol)if(data.expressionResolved&&data.expressionResolved.getType()===TcHmi.SymbolType.Server&&this.__lockLastWriteError)Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+'] __onWatchCallback aborted because of "__lockLastWriteError".');else{if(data.expressionResolved&&data.expressionResolved.getType()===TcHmi.SymbolType.Server&&this.__pendingWriteCount>0)return Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+'] __onWatchCallback aborted because "__pendingWriteCount > 0". "__pendingWriteCount: '+this.__pendingWriteCount),void(this.__forwardWriteToSymbolResponse=!0);if(data.error===TcHmi.Errors.NONE)if(this.__state!==State.Resuming&&this.__state!==State.Error||(this.__state===State.Resuming&&(this.__resumeLock=!1),this.__stateOld=this.__state,this.__state=State.Ready,this.__procWatchState()),this.__lockWatchError=!1,!TCHMI_DESIGNER&&this.__latestWrite&&data.expressionResolved&&data.expressionResolved.getType()===TcHmi.SymbolType.Server)if(data.processedStart&&data.processedEnd)if(this.__latestWriteProcessedStart&&this.__latestWriteProcessedEnd){let startTimingComparison,endTimingComparison,symbolName=data.expressionResolved.getName(),caughtException=!1;try{startTimingComparison=Binding.__compareTiming(data.processedStart,this.__latestWriteProcessedEnd),endTimingComparison=Binding.__compareTiming(this.__latestWriteProcessedStart,data.processedEnd)}catch(ex){ex instanceof Error&&ex.message!==this.__lastReportedError&&(Log.errorEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] __onWatchCallback aborted in processed date comparison",ex),this.__lastReportedError=ex.message),caughtException=!0}1===startTimingComparison?(Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onWatchCallback calls __writeToControl because watch tick data is newer than last server write."),this.__writeToControl(data.value,data.dirtyPaths)):1===endTimingComparison?Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onWatchCallback aborted because server read has ended before last server write has started. Data is outdated."):symbolName?caughtException||(this.__lastReportedError=void 0,Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onWatchCallback forces read from server because last write and watch callback were processed at roughly the same time."),this.__pendingForceReadRequestId=Server.request({requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage"],symbol:symbolName}]},data=>{if(Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__symbol?.getExpression().toString()+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onWatchCallback forced read finished with:",{data}),this.__pendingForceReadRequestId=null,data.error!==TcHmi.Errors.NONE){let message="[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] ";return data.details?message+=Log.buildMessage(data.details):message+=Log.buildMessage({code:data.error,message:TcHmi.Errors[data.error]}),void Log.error(message)}let response=data.response;if(void 0===response)return void Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] "+Log.buildMessage({code:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_MISSING],reason:"Missing response from server.",domain:"TcHmi.System.Binding"}));if(response&&response.error)return void Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] "+Log.buildMessage({code:TcHmi.Errors.E_SERVER_RESPONSE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_ERROR],reason:"Error in response from server with id: "+response.id,domain:"TcHmi.System.Binding",errors:[response.error]}));let command,commands=response.commands;if(!commands)return void Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] Server responds with error: "+Log.buildMessage({code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:"Missing commands in response from server with id: "+response.id,domain:"TcHmi.System.Symbol"}));for(let i=0,ii=commands.length;i<ii;i++){let command2=commands[i];if(command2&&command2.symbol===symbolName){command=command2;break}}if(!command)return void Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] Server responds with error: "+Log.buildMessage({code:TcHmi.Errors.E_SERVER_COMMAND_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMAND_MISSING],reason:'Missing command for symbol: "'+symbolName+'" in response from server with id: '+response.id,domain:"TcHmi.System.Symbol"}));if(command.error)return void Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] Server responds with error: "+Log.buildMessage({code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMAND_ERROR],reason:'Error in command for symbol: "'+symbolName+'" in response from server with id: '+response.id,domain:"TcHmi.System.Symbol",errors:[command.error]}));if(void 0===command.readValue)return void Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] Server responds with error: "+Log.buildMessage({code:TcHmi.Errors.E_SERVER_READVALUE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_READVALUE_MISSING],reason:'Missing property: "readValue" in command for symbol: "'+symbolName+'" in response from server with id: '+response.id,domain:"TcHmi.System.Symbol"}));let value=command.readValue;this.__lockWriteToControl&&tchmi_equal(this.__lockWriteToControlValue,value)?Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+'] __onWatchCallback aborted because of "__lockWriteToControl".'):(Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onWatchCallback calls __writeToControl with forced read data."),this.__writeToControl(value))})):Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] __onWatchCallback aborted: Symbol Expression is not valid.")}else Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+'] Missing property "processedStart" or "processedEnd" in response.');else Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+'] Missing property "processedStart" or "processedEnd" in response.');else{let value=data.value;if(this.__lockWriteToControl&&tchmi_equal(this.__lockWriteToControlValue,value))return void Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+'] __onWatchCallback aborted because of "__lockWriteToControl".');this.__writeToControl(value,data.dirtyPaths)}else{this.__lockWatchError=!0;let message="[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] ";if(data.details?message+=Log.buildMessage(data.details):message+=Log.buildMessage({code:data.error,message:TcHmi.Errors[data.error]}),Log.error(message),this.__lockWriteToControl&&null===this.__lockWriteToControlValue)return void Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+'] __onWatchCallback aborted because of "__lockWriteToControl".');let reset=!1;if("Reset"===config.binding.symbolError?reset=!0:"Ignore"===config.binding.symbolError&&(reset=!1),data.expressionResolved){let options=data.expressionResolved.getOptions();"Reset"===options.BindingErrorHandling?reset=!0:"Ignore"===options.BindingErrorHandling&&(reset=!1)}reset&&this.__writeToControl(null),this.__stateOld=this.__state,this.__state=State.Error,this.__procWatchState()}}else Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onWatchCallback aborted because symbol object is not defined.");else Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+'] __onWatchCallback aborted because state is neither "Ready", "Resuming" or "Error".')}__onReadCallback(data){let guid="";if(TCHMI_CONSOLE_LOG_LEVEL>=4&&(guid=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__symbol?.getExpression().toString()+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onReadCallback called with:",{data}),this.__state===State.Preloading)if(this.__symbol)if(this.__control){if(data.error!==TcHmi.Errors.NONE){let message="[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] ";data.details?message+=Log.buildMessage(data.details):message+=Log.buildMessage({code:data.error,message:TcHmi.Errors[data.error]}),Log.error(message)}if(data.error!==TcHmi.Errors.NONE)return"Reset"===config.binding.symbolError&&this.__writeToControl(null),this.__resumeLock=!1,this.__stateOld=this.__state,this.__state=State.Error,void this.__procWatchState();this.__resumeLock=!1,this.__writeToControl(data.value,data.dirtyPaths),this.__stateOld=this.__state,this.__state=State.Initialized,this.__procWatchState(),this.__control.getIsAttached()||this.__suspend()}else Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onReadCallback aborted because control object is not defined.");else Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"] __onReadCallback aborted because symbol object is not defined.");else Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+'] __onReadCallback aborted because state is not "Preloading".')}__writeToSymbol(value,dirtyPaths){if(null===dirtyPaths&&(dirtyPaths=void 0),void 0===value)return;if(!this.__symbol)return;let guid="";TCHMI_CONSOLE_LOG_LEVEL>=4&&(guid=tchmi_create_guid()),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__symbol?.getExpression().toString()+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+"]  __writeToSymbol called with:",{value,dirtyPaths}),null!==this.__pendingForceReadRequestId&&(Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+']  __writeToSymbol release pending forced read request with id: "'+this.__pendingForceReadRequestId),Server.releaseRequest(this.__pendingForceReadRequestId),this.__pendingForceReadRequestId=null,this.__forwardWriteToSymbolResponse=!0),this.__pendingWriteCount++;let syncCb=!1;const destroyWrite=this.__symbol.writeEx(value,dirtyPaths,data=>{if(syncCb=!0,this.__symbol&&this.__state!==State.Destroyed)if(data.error===TcHmi.Errors.NONE)this.__pendingWriteCount--,this.__symbol.getExpression().getType()===TcHmi.SymbolType.Server&&(this.__latestWrite=!0,data.processedStart&&data.processedEnd?(this.__latestWriteProcessedStart=data.processedStart,this.__latestWriteProcessedEnd=data.processedEnd):(Log.error("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+'] Missing property "processedStart" or "processedEnd" in response.'),this.__lockLastWriteError=!0),!this.__lockLastWriteError&&0===this.__pendingWriteCount&&this.__forwardWriteToSymbolResponse?(this.__writeToControl(data.value,dirtyPaths),this.__forwardWriteToSymbolResponse=!1):this.__lockLastWriteError?Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+']  __writeToSymbol aborted because of "__lockLastWriteError".'):this.__pendingWriteCount>0?Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+']  __writeToSymbol aborted because "__pendingWriteCount > 0". __pendingWriteCount: '+this.__pendingWriteCount):this.__forwardWriteToSymbolResponse||Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+", FunctionScopeGuid="+guid+']  __writeToSymbol aborted because "__forwardWriteToSymbolResponse === false".'));else{let message="[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"] ";data.details?message+=Log.buildMessage(data.details):message+=Log.buildMessage({code:data.error,message:TcHmi.Errors[data.error]}),Log.error(message);let readBack=!0;if(data.expressionResolved){"Ignore"===data.expressionResolved.getOptions().BindingWriteErrorHandling&&(readBack=!1)}readBack?this.__symbol?.read(data=>{this.__pendingWriteCount--,data.error===TcHmi.Errors.NONE&&this.__writeToControl(data.value)}):this.__pendingWriteCount--}});!syncCb&&destroyWrite&&this.__destroyWrite.add(destroyWrite)}__writeToControl(value,dirtyPaths){if(null===dirtyPaths&&(dirtyPaths=void 0),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__symbol?.getExpression().toString()+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"]  __writeToControl called with:",{value,dirtyPaths}),void 0===value)return;if(!this.__control)return;const preDetached=this.__partial?.getLifeCycleState().detaching;if(preDetached)return void(-1===TCHMI_CONSOLE_LOG_LEVEL&&performance.mark("System.Binding: Skipped binding write to predetached "+this.__controlId,{detail:{control:this.__controlId,partial:this.__partial?.getId()}}));this.__lockWriteToControl=!0;let error,conversionException=!1;try{this.__lockWriteToControlValue=ValueConverter.toType(tchmi_clone_object(value),this.__attr.type)}catch(e){conversionException=!0,Log.errorEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] An uncaught exception occurred while converting the current value of type '"+typeof value+"' to the expected control attribute type schema '"+this.__attr.type+"':\n",e)}if(conversionException)return this.__lockWriteToControl=!1,void(this.__lockWriteToControlValue=void 0);try{Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"]  __writeToControl calling attribute setter."),error=controlManager.setControlPropertyByAttribute(this.__control,this.__attr,tchmi_clone_object(value),dirtyPaths),Log.debugEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__symbol?.getExpression().toString()+", State="+State[this.__state]+", ObjectScopeDiagGUID="+this.__diagGUID+"]  __writeToControl calling attribute finished with:",{error})}catch(e){Log.errorEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] An uncaught exception occurred in setter function of attribute with propertyName="+this.__propertyName+" of control="+this.__controlId+":\n",e)}finally{this.__lockWriteToControl=!1,this.__lockWriteToControlValue=void 0}error&&error.code!==TcHmi.Errors.NONE&&(error.exception?Log.errorEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] "+Log.buildMessage(error),"\n",error.exception):Log.errorEx("[Source=Framework, Module=TcHmi.System.Binding, Control="+this.__controlId+", Property="+this.__propertyName+", Symbol="+this.__expression+"] "+Log.buildMessage(error)))}__procWatchState(){for(const stateWatcher of this.__stateWatcher.keys())TcHmi.Callback.callSafeEx(stateWatcher.callback,this,{error:TcHmi.Errors.NONE,binding:this,state:this.__state,stateOld:this.__stateOld,destroy:stateWatcher.destroy})}watchState(callback){const destroy=()=>{watcher&&this.__stateWatcher.delete(watcher)},watcher={callback,destroy};return this.__stateWatcher.add(watcher),TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,binding:this,state:this.__state,stateOld:this.__stateOld,destroy}),destroy}}})();export{Binding};export var State;!function(State){State[State.Invalid=0]="Invalid",State[State.Error=1]="Error",State[State.Initializing=100]="Initializing",State[State.Resuming=200]="Resuming",State[State.Preloading=300]="Preloading",State[State.Initialized=400]="Initialized",State[State.Ready=500]="Ready",State[State.Suspended=600]="Suspended",State[State.Destroyed=700]="Destroyed"}(State||(State={}));
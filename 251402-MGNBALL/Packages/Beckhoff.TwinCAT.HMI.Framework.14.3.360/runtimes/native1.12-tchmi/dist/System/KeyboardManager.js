import{getProviders}from"../API/UiProvider.js";import{config}from"./System.js";import{Log}from"../API/Log.js";export class KeyboardManager{constructor(){}__eventsRegistered=!1;__activeProvider;__providerName="";__autoOpen=!1;__systemKeyboardLayout=null;__projectKeyboardMapping={};refreshConfig(){if(this.__projectKeyboardMapping=tchmi_clone_object(config.systemKeyboard?.projectKeyboardMapping)??{},this.__systemKeyboardLayout=tchmi_clone_object(config.systemKeyboard?.layout)??null,!1===config.systemKeyboard?.autoOpen||!config.systemKeyboard?.providerName){if(this.__autoOpen=!1,config.systemKeyboard?.providerName)this.__providerName=config.systemKeyboard.providerName;else{const registeredProviders=getProviders("keyboard");this.__providerName=registeredProviders.keys().next().value??""}return void this.close()}if(this.__autoOpen=!0,this.__providerName=config.systemKeyboard.providerName,this.__activeProvider?.refreshConfig(),this.__eventsRegistered)return;let focusOutAnimationFrameId=0;const passiveEventOptions={passive:!0,capture:!1},handleFinalInteraction=evt=>{const activeElement=evt.target&&void 0!==evt.target.ownerDocument?evt.target.ownerDocument.activeElement:document.activeElement;activeElement&&activeElement!==evt.target||this.close()},handleFocusIn=evt=>{if(!this.__autoOpen)return;const eventTarget=evt.target;if("TEXTAREA"!==eventTarget.tagName.toUpperCase()&&"INPUT"!==eventTarget.tagName.toUpperCase())return;if("INPUT"===eventTarget.tagName.toUpperCase()&&["button","checkbox","file","image","radio","reset","submit"].includes(eventTarget.type))return;if(eventTarget.readOnly)return;const requestedInputMode=eventTarget.getAttribute("data-tchmi-input-mode");if("skip"!==requestedInputMode)if("none"!==requestedInputMode){focusOutAnimationFrameId&&(cancelAnimationFrame(focusOutAnimationFrameId),focusOutAnimationFrameId=0);try{const registeredKeyboard=TcHmi.UiProvider.getPreferredProvider("keyboard");if(registeredKeyboard){const refocus=!!this.__activeProvider;this.__activeProvider=registeredKeyboard;const result=this.__activeProvider.open(eventTarget);result&&result.code!==TcHmi.Errors.NONE?Log.errorEx("[Source=Framework, Module=TcHmi.Keyboard] Could not open keyboard: ",Log.buildMessage(result)):TcHmi.EventProvider.raise("onSystemKeyboardOpened",{refocus,textElement:eventTarget}),eventTarget.addEventListener("focusout",handleFocusOut,{once:!0})}}catch(ex){Log.errorEx("[Source=Framework, Module=TcHmi.Keyboard] Could not open keyboard.",ex)}}else this.close()},handleFocusOut=_evt=>{focusOutAnimationFrameId=requestAnimationFrame(()=>{this.__activeProvider?.hasActiveUserInteraction&&!this.__activeProvider.hasActiveUserInteraction()&&this.close(),focusOutAnimationFrameId=0})};document.addEventListener("focusin",handleFocusIn,passiveEventOptions),document.addEventListener("indirectinputfinished",handleFinalInteraction),document.addEventListener("indirectinputcanceled",handleFinalInteraction);const handleIframeLoad=evt=>{const iframe=evt.target;iframe.contentDocument?.addEventListener("focusin",handleFocusIn),iframe.contentDocument?.addEventListener("indirectinputfinished",handleFinalInteraction),iframe.contentDocument?.addEventListener("indirectinputcanceled",handleFinalInteraction)},armIframeEvents=iframe=>{iframe.addEventListener("load",handleIframeLoad,passiveEventOptions),iframe.contentDocument&&"loading"!==iframe.contentDocument.readyState&&(iframe.contentDocument.addEventListener("focusin",handleFocusIn),iframe.contentDocument.addEventListener("indirectinputfinished",handleFinalInteraction),iframe.contentDocument.addEventListener("indirectinputcanceled",handleFinalInteraction))};TcHmi.EventProvider.register("System.onIFrameElementAdded",(evt,iframe)=>{armIframeEvents(iframe)}),TcHmi.EventProvider.register("System.onIFrameElementRemoved",(evt,iframe)=>{iframe.contentDocument?.removeEventListener("focusin",handleFocusIn),iframe.contentDocument?.removeEventListener("indirectinputfinished",handleFinalInteraction),iframe.contentDocument?.removeEventListener("indirectinputcanceled",handleFinalInteraction),iframe.removeEventListener("load",handleIframeLoad,passiveEventOptions)});for(const iframe of document.querySelectorAll("iframe"))armIframeEvents(iframe);this.__eventsRegistered=!0}close(){if(this.__activeProvider){const result=this.__activeProvider.close();this.__activeProvider=void 0,result&&result.code!==TcHmi.Errors.NONE||TcHmi.EventProvider.raise("onSystemKeyboardClosed")}}getProviderName(){return this.__providerName}setProviderName(providerName){this.__providerName=providerName}getAutoOpen(){return this.__autoOpen}setAutoOpen(newState){this.__autoOpen=newState}getLayoutFileFromInputMode(requestedInputMode){let configuredInputModeMapping,configuredNoregionInputModeMapping,fallbackLanguageInputModeMapping;const locale=(TcHmi.Locale.get()??"en").toLowerCase(),fallbackLocale=(config.languageFallback||"en").toLowerCase();for(const[localeMixedCase,setting]of Object.entries(this.__projectKeyboardMapping??{})){const configLocale=localeMixedCase.toLowerCase();configLocale!==locale||configuredInputModeMapping||(configuredInputModeMapping=setting),configLocale.split("-")[0]!==fallbackLocale.split("-")[0]||fallbackLanguageInputModeMapping||(fallbackLanguageInputModeMapping=setting),configuredNoregionInputModeMapping||(configLocale.split("-")[0]===locale.split("-")[0]||configLocale.split("-")[0]===fallbackLocale.split("-")[0])&&(configuredNoregionInputModeMapping=setting)}let keyboardUrl=configuredInputModeMapping?.[requestedInputMode]||configuredNoregionInputModeMapping?.[requestedInputMode]||fallbackLanguageInputModeMapping?.[requestedInputMode]||("numeric"===requestedInputMode?configuredInputModeMapping?.decimal||configuredNoregionInputModeMapping?.decimal||fallbackLanguageInputModeMapping?.decimal:void 0)||configuredInputModeMapping?.text||configuredNoregionInputModeMapping?.text||fallbackLanguageInputModeMapping?.text;return keyboardUrl&&config.keyboardLayouts.some(projectLayoutFile=>projectLayoutFile.url===keyboardUrl)?{error:TcHmi.Errors.NONE,layoutUrl:keyboardUrl}:{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:`There is no keyboard layout configured for the requested input mode ${requestedInputMode} in the current locale ${locale} or the fallback locale ${fallbackLocale}.`,domain:"TcHmi.System.KeyboardManager"}}}getProjectKeyboardMapping(){return this.__projectKeyboardMapping}setProjectKeyboardMapping(projectKeyboardMapping){this.__projectKeyboardMapping=projectKeyboardMapping}getContainerLayout(){return this.__systemKeyboardLayout}setContainerLayout(newLayout){this.__systemKeyboardLayout=newLayout}}export const keyboardManager=new KeyboardManager;
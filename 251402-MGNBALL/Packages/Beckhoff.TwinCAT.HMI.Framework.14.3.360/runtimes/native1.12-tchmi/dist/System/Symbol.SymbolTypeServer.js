import{serverManager}from"./ServerManager.js";import{SymbolState}from"./Symbol.js";import{compareISO8601ServerCommandDateTimeStrings}from"./SystemFunctions.js";import*as TypeHelper from"./Type.Schema.Helper.js";import*as Server from"../API/Server.js";import*as ValueConverter from"../API/ValueConverter.js";import{resolveDefault}from"../API/Type.Schema.js";import{Log}from"../API/Log.js";export class SymbolTypeServer extends TcHmi.Destroyable{constructor(symbol){super(),this.__symbol=symbol,this.__symbolExpressionString=this.__symbol.getExpression().toString(),this.__symbolDiagGUID=this.__symbol.getDiagGUID()}__symbol;__symbolExpressionString;__symbolDiagGUID;__printExpression(expression){let message=this.__symbolExpressionString;return expression?(this.__symbolExpressionString!==expression.toString()&&(message+=` (Resolved to: '${expression.toString()}')`),message):message}destroy(){this.isDestroyed()||(this.__releaseDestroyPrivilege(),this.isDestroyable()&&(this.__symbol=null))}read(expression,options,callback){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}}),()=>{};let symbol=expression.getName();if(!symbol)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypeServer"},expression:this.__symbol.getExpression(),expressionResolved:expression}),()=>{};let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(TCHMI_DESIGNER)return this.__symbol.__helper.resolveSchema(expression,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE&&data.schema){let value=resolveDefault(data.schema);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}})}),()=>{};{let version,writeValue;version=options&&void 0!==options.forceVersion?options.forceVersion:expression.getOptions().Version??void 0,writeValue=options&&void 0!==options.forceWriteValue?options.forceWriteValue:expression.getOptions().WriteValue??void 0;let command={commandOptions:["SendErrorMessage"],symbol};writeValue&&(command.writeValue=writeValue);let message={requestType:"ReadWrite",commands:[command]};if(version){let av=Server.getApiVersion();if(av){let cvr=tchmi_compare_version(av,"1.0.0.1");if(0!==cvr&&1!==cvr)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_NOT_SUPPORTED,details:{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],reason:this.__printExpression(expression)+": Current server instance does not support version for symbols.",domain:"TcHmi.System.SymbolTypeServer"},expression:this.__symbol.getExpression(),expressionResolved:expression}),()=>{};command.version=version}}void 0!==start&&(command.offset=start),void 0!==end&&(command.limit=void 0!==start?end-start+1:end+1);let parallel,readWriteGroup,timeout=expression.getOptions().Timeout;parallel=options&&void 0!==options.forceParallel?options.forceParallel:expression.getOptions().Parallel??!1,readWriteGroup=options&&void 0!==options.forceReadWriteGroup?options.forceReadWriteGroup.toString():expression.getOptions().ReadWriteGroup??void 0;let requestId=serverManager.requestEx(message,{symbol:this.__symbol,timeout,parallel,groupId:readWriteGroup},Server.handleResponse({completed:dataRequest=>{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}});if(dataRequest.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:dataRequest.error,details:dataRequest.details});let response=dataRequest.response;if(void 0===response)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SERVER_INVALID_RESPONSE,details:{code:TcHmi.Errors.E_SERVER_INVALID_RESPONSE,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_INVALID_RESPONSE],reason:this.__printExpression(expression)+": Missing response from server.",domain:"TcHmi.System.SymbolTypeServer"},expression:this.__symbol.getExpression(),expressionResolved:expression,response});if(response&&response.error&&response.error)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SERVER_RESPONSE_ERROR,details:{code:TcHmi.Errors.E_SERVER_RESPONSE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_ERROR],reason:this.__printExpression(expression)+": Error in response from server with id: "+response.id,domain:"TcHmi.System.SymbolTypeServer",errors:[response.error]},expression:this.__symbol.getExpression(),expressionResolved:expression,response});let commands=response.commands;if(!commands)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,details:{code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:this.__printExpression(expression)+": Missing commands in response from server with id: "+response.id,domain:"TcHmi.System.SymbolTypeServer"},expression:this.__symbol.getExpression(),expressionResolved:expression,response});let command=commands[0];if(dataRequest.responseCommandIndices&&(command=commands[dataRequest.responseCommandIndices[0]]),command)return command.error?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SERVER_COMMAND_ERROR,details:{code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMAND_ERROR],reason:this.__printExpression(expression)+': Error in command for symbol: "'+symbol+'" in response from server with id: '+response.id,domain:"TcHmi.System.SymbolTypeServer",errors:[command.error]},expression:this.__symbol.getExpression(),expressionResolved:expression,value:command.readValue,response}):void this.__symbol.__helper.resolveSchema(expression,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){let prepValue=ValueConverter.toSchemaType(command.readValue,data.schema);if(null===prepValue&&null!==command.readValue){let reason,value=command.readValue,schema=data.schema;reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor.name+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+String(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".",TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.SymbolTypeServer"},value:command.readValue,expressionResolved:expression,expression:this.__symbol.getExpression(),response})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:prepValue,expressionResolved:expression,expression:this.__symbol.getExpression(),response})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:{code:data.error,message:TcHmi.Errors[data.error],reason:this.__printExpression(expression)+": Resolving schema failed.",domain:"TcHmi.System.SymbolTypeServer",errors:data.details?[data.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,value:command.readValue,response});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}})});TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SERVER_COMMAND_MISSING,details:{code:TcHmi.Errors.E_SERVER_COMMAND_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMAND_MISSING],reason:this.__printExpression(expression)+': Missing command for symbol: "'+symbol+'" in response from server with id: '+response.id,domain:"TcHmi.System.SymbolTypeServer"},expression:this.__symbol.getExpression(),expressionResolved:expression,response})}}));return()=>{Server.releaseRequest(requestId)}}}write(expression,value,options,dirtyPaths,callback){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}}),()=>{};null===dirtyPaths&&(dirtyPaths=void 0);const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypeServer"},expression:this.__symbol.getExpression(),expressionResolved:expression}),()=>{};if(TCHMI_DESIGNER)return this.__symbol.__helper.resolveSchema(expression,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE&&data.schema){let value=resolveDefault(data.schema);TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}})}),()=>{};{let newValue=tchmi_clone_object(value),destroyed=!1,requestId=null;return this.__symbol.__helper.resolveSchema(expression,dataResolveSchema=>{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}});if(destroyed)return;if(this.__symbol.getState()!==SymbolState.Ready)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_STATE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_STATE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_STATE_INVALID],reason:this.__printExpression(expression)+":Symbol is not ready",domain:"TcHmi.System.SymbolTypeServer",errors:dataResolveSchema.details?[dataResolveSchema.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression});let version,schema=this.__symbol.__helper.getSchema();if(dataResolveSchema.error!==TcHmi.Errors.NONE||!schema)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,details:{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:this.__printExpression(expression)+": Failed to resolve schema definition.",domain:"TcHmi.System.SymbolTypeServer",errors:dataResolveSchema.details?[dataResolveSchema.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression});version=options&&void 0!==options.forceVersion?options.forceVersion:expression.getOptions().Version??void 0;let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(version){let av=Server.getApiVersion();if(av){let cvr=tchmi_compare_version(av,"1.0.0.1");if(0!==cvr&&1!==cvr)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_NOT_SUPPORTED,details:{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],reason:this.__printExpression(expression)+": Current server instance does not support version for symbols.",domain:"TcHmi.System.SymbolTypeServer"},expression:this.__symbol.getExpression(),expressionResolved:expression})}}let parallel,readWriteGroup,timeout=expression.getOptions().Timeout;parallel=options&&void 0!==options.forceParallel?options.forceParallel:expression.getOptions().Parallel??!1,readWriteGroup=options&&void 0!==options.forceReadWriteGroup?options.forceReadWriteGroup.toString():expression.getOptions().ReadWriteGroup??void 0;let errorDetails,message={requestType:"ReadWrite",commands:[]},error=TcHmi.Errors.NONE;if(dirtyPaths&&dirtyPaths.length>0)for(let i=0,ii=dirtyPaths.length;i<ii;i++){let subschema,subschemaErrorDetails,subvalue,path=dirtyPaths[i],pathTokens=TcHmi.ObjectPath.toPathTokens(path),subschemaError=TcHmi.Errors.NONE;TypeHelper.__resolveSubSchema(schema,pathTokens,data=>{data.error===TcHmi.Errors.NONE?subschema=tchmi_clone_object(data.schema):(subschemaError=data.error,subschemaErrorDetails=data.details)});let subvalueErrorDetails,subvalueError=TcHmi.Errors.NONE;if(this.__symbol.__helper.readSubValue(expression,newValue,pathTokens,name,data=>{data.error===TcHmi.Errors.NONE?subvalue=tchmi_clone_object(data.value):(subvalueError=data.error,subvalueErrorDetails=data.details)}),subschemaError===TcHmi.Errors.NONE&&subvalueError===TcHmi.Errors.NONE){let prepValue=ValueConverter.toSchemaType(subvalue,subschema,{convertDirection:ValueConverter.ConvertDirection.Backward});if(null===prepValue&&null!==subvalue){let reason,value=subvalue,schema=subschema;reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor.name+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+value+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".",error=TcHmi.Errors.E_SYMBOL_VALUE_INVALID,errorDetails||(errorDetails={code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.SymbolTypeServer"})}else{let command={commandOptions:["SendErrorMessage"],symbol:name+path,writeValue:prepValue};version&&(command.version=version),void 0!==start&&(command.offset=start),void 0!==end&&(command.limit=void 0!==start?end-start+1:end+1),message.commands.push(command)}}else error=TcHmi.Errors.ERROR,errorDetails||(errorDetails={code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression(expression)+": Sub schema or sub value error.",domain:"TcHmi.System.SymbolTypeServer"}),subschemaError!==TcHmi.Errors.NONE&&(errorDetails.errors||(errorDetails.errors=[]),subschemaErrorDetails?errorDetails.errors.push(subschemaErrorDetails):errorDetails.errors.push({code:subschemaError,message:TcHmi.Errors[subschemaError],reason:this.__printExpression(expression)+": Sub schema error.",domain:"TcHmi.System.SymbolTypeServer"})),subvalueError!==TcHmi.Errors.NONE&&(errorDetails.errors||(errorDetails.errors=[]),errorDetails.errors.push({code:TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_SUBVALUE_ERROR],reason:this.__printExpression(expression)+": Error while reading sub value.",domain:"TcHmi.System.SymbolTypeServer",errors:[subvalueErrorDetails||{code:subvalueError,message:TcHmi.Errors[subvalueError]}]}))}else{let prepValue=ValueConverter.toSchemaType(newValue,schema,{convertDirection:ValueConverter.ConvertDirection.Backward,resolveFunctionWriteValue:!0});if(null===prepValue&&null!==newValue){let reason,value=newValue;reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor.name+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+value+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".",error=TcHmi.Errors.E_SYMBOL_VALUE_INVALID,errorDetails||(errorDetails={code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.SymbolTypeServer"})}else{let command={commandOptions:["SendErrorMessage"],symbol:name,writeValue:prepValue};version&&(command.version=version),void 0!==start&&(command.offset=start),void 0!==end&&(command.limit=void 0!==start?end-start+1:end),message.commands.push(command)}}error===TcHmi.Errors.NONE?requestId=serverManager.requestEx(message,{symbol:this.__symbol,timeout,parallel,groupId:readWriteGroup},Server.handleResponse({completed:dataRequest=>{if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}});if(dataRequest.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:dataRequest.error,details:{code:dataRequest.error,reason:this.__printExpression(expression)+": Error while writing to the server.",domain:"TcHmi.System.SymbolTypeServer",errors:dataRequest.details?[dataRequest.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression});let response=dataRequest.response;if(!response)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,details:{code:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_MISSING],reason:this.__printExpression(expression)+": Missing response from server.",domain:"TcHmi.System.SymbolTypeServer"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(response&&response.error)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SERVER_RESPONSE_ERROR,details:{code:TcHmi.Errors.E_SERVER_RESPONSE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_ERROR],reason:this.__printExpression(expression)+": Error in response from server with id: "+response.id,domain:"TcHmi.System.SymbolTypeServer",errors:[response.error]},expression:this.__symbol.getExpression(),expressionResolved:expression,response});let commands=response.commands;if(commands){if(dirtyPaths&&dirtyPaths.length>0){let processedStart,processedEnd,errors=[];for(let i=0,ii=commands.length;i<ii;i++){let command=commands[i];if(command.error){errors.push({code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMAND_ERROR],reason:this.__printExpression(expression)+": Error in command for symbol: "+name+'" in response from server with id: '+response.id,domain:"TcHmi.System.SymbolTypeServer",errors:[command.error]});continue}(!processedStart||command.processedStart&&-1===compareISO8601ServerCommandDateTimeStrings(command.processedStart,processedStart))&&(processedStart=command.processedStart),(!processedEnd||command.processedEnd&&1===compareISO8601ServerCommandDateTimeStrings(command.processedEnd,processedEnd))&&(processedEnd=command.processedEnd);let path=command.symbol.replace(name,""),pathTokens=TcHmi.ObjectPath.toPathTokens(path);this.__symbol.__helper.writeSubValue(expression,newValue,command.readValue,pathTokens,name,data=>{this.__symbol?data.error===TcHmi.Errors.NONE||(data.details?errors.push(data.details):errors.push({code:data.error,message:TcHmi.Errors[data.error],reason:this.__printExpression(expression)+": Error while writing subvalue for symbol: "+name,domain:"TcHmi.System.SymbolTypeServer"})):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}})})}return errors.length>0?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression(expression)+': Error while processing command for symbol: "'+name+'" in response from server with id: '+response.id,domain:"TcHmi.System.SymbolTypeServer",errors},expression:this.__symbol.getExpression(),expressionResolved:expression,response}):processedStart&&processedEnd?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:newValue,expressionResolved:expression,expression:this.__symbol.getExpression(),processedStart,processedEnd,response}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:newValue,expression:this.__symbol.getExpression(),expressionResolved:expression})}{let command=commands[0];return command?command.error?void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SERVER_COMMAND_ERROR,details:{code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMAND_ERROR],reason:this.__printExpression(expression)+': Error in command for symbol: "'+name+'" in response from server with id: '+response.id,domain:"TcHmi.System.SymbolTypeServer",errors:[command.error]},expression:this.__symbol.getExpression(),expressionResolved:expression,response}):void(command.processedStart&&command.processedEnd?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:command.readValue,expressionResolved:expression,expression:this.__symbol.getExpression(),processedStart:command.processedStart,processedEnd:command.processedEnd,response}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:command.readValue,expressionResolved:expression,expression:this.__symbol.getExpression(),response})):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SERVER_COMMAND_MISSING,details:{code:TcHmi.Errors.E_SERVER_COMMAND_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMAND_MISSING],reason:this.__printExpression(expression)+': Missing command for symbol: "'+name+'" in response from server with id: '+response.id,domain:"TcHmi.System.SymbolTypeServer"},expression:this.__symbol.getExpression(),expressionResolved:expression,response})}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,details:{code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:this.__printExpression(expression)+": Missing commands in response from server with id: "+response.id,domain:"TcHmi.System.SymbolTypeServer"},expression:this.__symbol.getExpression(),expressionResolved:expression,response})}})):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error,details:errorDetails,expression:this.__symbol.getExpression(),expressionResolved:expression})}),()=>{destroyed=!0,null!=requestId&&Server.releaseRequest(requestId)}}}watch(expression,options,callback,reason){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}}),()=>{};let destroySubWatch,diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid());let destroy=()=>{Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch destroy called."),destroySubWatch&&(destroySubWatch(),destroySubWatch=null)};return TCHMI_DESIGNER?this.read(expression,options,data=>{this.__symbol?data.error===TcHmi.Errors.NONE?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:data.value,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}})}):destroySubWatch=serverManager.watch(this.__symbol,expression,options,dataWatch=>{if(this.__symbol){if(destroySubWatch||(destroySubWatch=dataWatch.destroy),dataWatch.error!==TcHmi.Errors.NONE){let res={error:dataWatch.error,details:{code:dataWatch.error,message:TcHmi.Errors[dataWatch.error],reason:this.__printExpression(expression)+": Failed to watch",domain:"TcHmi.System.Symbol",errors:dataWatch.details?[dataWatch.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}this.__symbol.__helper.resolveSchema(expression,dataSchema=>{if(this.__symbol){if(dataSchema.error===TcHmi.Errors.NONE){let prepValue=ValueConverter.toSchemaType(dataWatch.value,dataSchema.schema);if(null===prepValue&&null!==dataWatch.value){let reason,value=dataWatch.value,schema=dataSchema.schema;reason="object"==typeof value&&__tchmi_is_instanced_object(value)?this.__printExpression(expression)+': Value of type: "Instance of '+value.constructor.name+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":"object"==typeof value?this.__printExpression(expression)+': Value: "'+JSON.stringify(value)+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".":this.__printExpression(expression)+': Value: "'+value+'" of type: "'+typeof value+'" '+(schema?"can not be converted to type schema: "+(schema.id?'"'+schema.id+'": ':"")+'"'+JSON.stringify(schema)+'"':"can not be converted because type schema is missing")+".";let res={error:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,details:{code:TcHmi.Errors.E_SYMBOL_VALUE_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_VALUE_INVALID],reason,domain:"TcHmi.System.Symbol"},destroy,value:dataWatch.value,expressionResolved:expression,expression:this.__symbol.getExpression()};return dataWatch.response&&(res.response=dataWatch.response),dataWatch.processedStart&&dataWatch.processedEnd&&(res.processedStart=dataWatch.processedStart,res.processedEnd=dataWatch.processedEnd),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}{let res={error:TcHmi.Errors.NONE,value:prepValue,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy};return dataWatch.response&&(res.response=dataWatch.response),dataWatch.processedStart&&dataWatch.processedEnd&&(res.processedStart=dataWatch.processedStart,res.processedEnd=dataWatch.processedEnd),Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}}{let res={error:dataSchema.error,details:{code:dataSchema.error,message:TcHmi.Errors[dataSchema.error],reason:this.__printExpression(expression)+": Resolving schema failed.",domain:"TcHmi.System.Symbol",errors:dataSchema.details?[dataSchema.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return void 0!==dataWatch.value&&(res.value=dataWatch.value),dataWatch.response&&(res.response=dataWatch.response),dataWatch.processedStart&&dataWatch.processedEnd&&(res.processedStart=dataWatch.processedStart,res.processedEnd=dataWatch.processedEnd),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}}TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}})})}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeServer"}})}),destroy}}
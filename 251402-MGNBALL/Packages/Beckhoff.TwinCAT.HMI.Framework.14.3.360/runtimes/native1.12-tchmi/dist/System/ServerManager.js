import{dialogManager}from"./DialogManager.js";import{frameworkLocalization as localization}from"./Locale.js";import{isParameterTypeInvalid,resolveServerSymbolNameParts}from"./SystemFunctions.js";import{config,Data,hostBaseUri,hostPrefix}from"./System.js";import{accessManager}from"./AccessManager.js";import{callSafeCallbacks1Param}from"./Callback.js";import{isEnabled as AuditTrailisEnabled}from"./AuditTrail.js";import*as Server from"../API/Server.js";import*as ValueConverter from"../API/ValueConverter.js";import*as ErrorPane from"../API/Engineering.ErrorPane.js";import*as DiagnosticsServer from"./Diagnostics.Server.js";import*as InteractiveWriteQueue from"./InteractiveWrite.Queue.js";import{Log}from"../API/Log.js";import{EventProvider}from"../API/EventProvider.js";let ServerManager=(()=>{var _a,_b,_c;let ___disableCommunication_decorators,_onWebsocketMessage_decorators,_onWatcherTick_decorators,_instanceExtraInitializers=[];return class ServerManager{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___disableCommunication_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],_onWebsocketMessage_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],_onWatcherTick_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],__esDecorate(this,null,___disableCommunication_decorators,{kind:"method",name:"__disableCommunication",static:!1,private:!1,access:{has:obj=>"__disableCommunication"in obj,get:obj=>obj.__disableCommunication},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_onWebsocketMessage_decorators,{kind:"method",name:"onWebsocketMessage",static:!1,private:!1,access:{has:obj=>"onWebsocketMessage"in obj,get:obj=>obj.onWebsocketMessage},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,_onWatcherTick_decorators,{kind:"method",name:"onWatcherTick",static:!1,private:!1,access:{has:obj=>"onWatcherTick"in obj,get:obj=>obj.onWatcherTick},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){EventProvider.register("System.disableCommunication",this.__disableCommunication),this.__serverBaseUri=hostBaseUri,this.__serverWebsocketUri=this.__serverBaseUri.replace("http:","ws:").replace("https:","wss:")}static REGEXP_ISO8601_DURATION_PARTS=/^(-?)P(?=\d|T\d)(?:(\d+)Y)?(?:(\d+)M)?(?:(\d+)([DW]))?(?:T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+(?:\.\d+)?)S)?)?$/;__serverBaseUri=__runInitializers(this,_instanceExtraInitializers);__serverWebsocketUri;__websocket;__isReady=!1;__disabledCommunication=!1;__lastConnectState=0;__cyclicReconnect=!1;__symbolWatchEntryCacheByOptions=new Map;__symbolWatchEntryCacheById=new Map;__symbolWatchEntryCacheByRef=new Map;__symbolWatchEntryGroups=new Map;__requestCache=new Map;__requestCacheInteractiveWrite=new Map;__requestQueue=[];__requestQueuePendingRequest=null;__requestIdCount=0;__requestGroups=new Map;__conWatcherIntervalId=0;__firstAccessReject=0;__firstAccessRejectTimeoutId=0;__refreshSymbolWatchesPending=!1;__refreshSymbolWatchesIntervalId=0;static RECONNECT_INTERVAL=5e3;__checkLicenseSubscriptionId=null;__serverStateUrlApiVersion=2;__serverStateWatcherIntervalId=0;__serverState=null;__serverStateOld=null;__serverStateLastErrorStatus=null;__serverStateLastErrorStatusText=null;__serverStateLastErrorStatusOld=null;__serverStateLastErrorStatusTextOld=null;__serverStateRepeatingInfoConfirmend=!1;__serverStateLastRepeatingInfoConfirmend=!1;__forceShowErrorOnClose=!1;__forcedClose=!1;__serverSymbolMetaDataWatchId=null;__frameworkSupportedApiVersion="1.0.0.1";__serverSupportedApiVersion="0.0.0.0";watchServerState(){TCHMI_ENGINEERING||this.__serverStateWatcherIntervalId||(this.__serverStateWatcherIntervalId=setInterval(()=>{this.resolveHandleServerState()},TCHMI_SERVER_STATE_WATCH_INTERVAL))}unwatchServerState(){this.__serverStateWatcherIntervalId&&(clearInterval(this.__serverStateWatcherIntervalId),this.__serverStateWatcherIntervalId=0)}resolveServerState(callback){if(TCHMI_ENGINEERING)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE});let urlv1=this.__serverBaseUri+"/Config/ServerState",urlv2=urlv1+"/v2",proc=url=>{let xhr=new XMLHttpRequest;xhr.open("GET",url),xhr.addEventListener("load",evt=>{if(200!==xhr.status)return 404===xhr.status&&url===urlv2?(this.__serverStateUrlApiVersion=1,void proc(urlv1)):(this.__serverStateLastErrorStatusOld=this.__serverStateLastErrorStatus,this.__serverStateLastErrorStatusTextOld=this.__serverStateLastErrorStatusText,this.__serverStateLastErrorStatus=xhr.status,this.__serverStateLastErrorStatusText=xhr.statusText,void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR]}}));let response;this.__serverStateLastErrorStatusOld=this.__serverStateLastErrorStatus,this.__serverStateLastErrorStatusTextOld=this.__serverStateLastErrorStatusText,this.__serverStateLastErrorStatus=null,this.__serverStateLastErrorStatusText=null;try{response=JSON.parse(xhr.responseText)}catch(e){return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR]}})}response?(this.__serverStateOld=this.__serverState,this.__serverState=response,TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})):TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR]}})}),xhr.addEventListener("error",evt=>{TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Fetching server state failed. Details: HTTP error "+xhr.status+" "+xhr.statusText}})}),xhr.send()};if(1===this.__serverStateUrlApiVersion)proc(urlv1);else proc(urlv2)}resolveHandleServerState(callback){TCHMI_ENGINEERING?TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE}):this.resolveServerState(data=>{if(data.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this,data);let timedClient=this.__serverState?.timedClient,timedClientOld=this.__serverStateOld?.timedClient,maintenanceMode=this.__serverState?.maintenanceMode;if(null!==this.__serverStateLastErrorStatus&&this.__serverStateOld&&this.__serverStateOld.maintenanceMode&&this.__serverStateOld.maintenanceMode.isActive&&this.__serverStateOld.maintenanceMode.isMaintenanceUser)return void window.location.reload();if(this.__serverState&&this.__serverState.maintenanceMode&&this.__serverState.maintenanceMode.isActive&&!this.__serverState.maintenanceMode.isMaintenanceUser)return this.__forceShowErrorOnClose=!0,this.__forcedClose=!0,this.close(),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Maintenance_Mode_Lock",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br>"+localization.getText("Restore_When_Maintenance_Mode_Lock_Cleared",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),void dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay);if(this.__serverState&&this.__serverState.maintenanceMode&&!this.__serverState.maintenanceMode.isActive&&!this.__serverState.maintenanceMode.isMaintenanceUser&&this.__serverStateOld&&this.__serverStateOld.maintenanceMode&&this.__serverStateOld.maintenanceMode.isActive&&!this.__serverStateOld.maintenanceMode.isMaintenanceUser)return dialogManager.showDialog("__TcHmiServerManager",!1,TcHmi.DialogManager.DialogType.Overlay),void this.open();let resolveTimerAsString=then=>{if(!then)return"00:00:00";let hours=-1,minutes=-1,seconds=-1;if(2===this.__serverStateUrlApiVersion){let parts=ServerManager.REGEXP_ISO8601_DURATION_PARTS.exec(then);const days=parseInt(parts?.[4]??"0",10);hours=parseInt(parts?.[6]??"0",10),minutes=parseInt(parts?.[7]??"0",10),seconds=parseInt(parts?.[8]??"0",10),days>0&&(hours+=24*days)}else{let now=this.__serverState?.serverTime?new Date(this.__serverState.serverTime).getTime():Date.now(),timeleft=new Date(then).getTime()-now,baseHours=36e5,baseMinutes=6e4,baseSeconds=1e3;hours=-1,timeleft>=0&&(hours=Math.floor(timeleft/baseHours),timeleft-=hours*baseHours),minutes=-1,timeleft>=0&&(minutes=Math.floor(timeleft/baseMinutes),timeleft-=minutes*baseMinutes),seconds=-1,timeleft>=0&&(seconds=Math.floor(timeleft/baseSeconds),timeleft-=seconds*baseSeconds)}return(hours<0?"00":hours>=10?hours:"0"+hours)+":"+(minutes<0?"00":minutes>=10?minutes:"0"+minutes)+":"+(seconds<0?"00":seconds>=10?seconds:"0"+seconds)},showWaterMark=then=>{if(!then)return;const timerString=resolveTimerAsString(then);dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Watermark,{forceable:!0}),dialogManager.updateTextEx("__TcHmiServerManager",timerString,{dialogType:TcHmi.DialogManager.DialogType.Watermark,severity:TcHmi.DialogManager.DialogSeverity.Info})},resolveTimeLeft=then=>{let timeleft=0;if(!then)return timeleft;let parts=ServerManager.REGEXP_ISO8601_DURATION_PARTS.exec(then),days=parseInt(parts?.[4]??"0",10);days>0&&(timeleft+=24*days*60*60*1e3);let hours=parseInt(parts?.[6]??"0",10);hours>0&&(timeleft+=60*hours*60*1e3);let minutes=parseInt(parts?.[7]??"0",10);minutes>0&&(timeleft+=60*hours*1e3);let seconds=parseInt(parts?.[8]??"0",10);return minutes>0&&(timeleft+=1e3*seconds),timeleft};if(timedClient&&timedClient.isTimed){if(timedClientOld&&timedClientOld.isTimed&&timedClientOld.expiration&&timedClientOld.availableAgain&&(!timedClient||timedClient&&!timedClient.isTimed||timedClient&&timedClient.isTimed&&!timedClient.availableAgain))return void window.location.reload();if(timedClient&&timedClient.isTimed&&timedClient.expiration&&!timedClient.availableAgain){let timeleft;if(2===this.__serverStateUrlApiVersion)timeleft=resolveTimeLeft(timedClient.expiration);else{let now=this.__serverState?.serverTime?new Date(this.__serverState.serverTime).getTime():Date.now(),then=new Date(timedClient.expiration).getTime();timeleft=then-now}const timeleftLastWarning=12e4;if(!this.__serverStateRepeatingInfoConfirmend||!this.__serverStateLastRepeatingInfoConfirmend&&timeleft<=timeleftLastWarning){let buttonGuid=tchmi_create_guid();const timerString=resolveTimerAsString(timedClient.expiration);dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay,{forceable:!0}),dialogManager.updateTextEx("__TcHmiServerManager",tchmi_format_string(localization.getText("Time_Based_Client_License_Mode",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),timerString)+'<br />\n<br />\n<input id="'+buttonGuid+'" type="submit" value="'+localization.getText("OK",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+'" style="padding:10px;">',{severity:TcHmi.DialogManager.DialogSeverity.Info,buttonReload:!1}),document.getElementById(buttonGuid)?.addEventListener("click",e=>{this.__serverStateRepeatingInfoConfirmend=!0,timeleft<=timeleftLastWarning&&(this.__serverStateLastRepeatingInfoConfirmend=!0),dialogManager.showDialog("__TcHmiServerManager",!1,TcHmi.DialogManager.DialogType.Overlay),timedClient&&timedClient.expiration&&showWaterMark(timedClient.expiration)})}else showWaterMark(timedClient.expiration)}else if(timedClient&&timedClient.isTimed&&timedClient.expiration&&timedClient.availableAgain){const timerString=resolveTimerAsString(timedClient.availableAgain);dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Time_Based_Client_License_Client_Limit_Exceeded",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br />"+localization.getText("Reloading_When_Client_License_Available",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" "+tchmi_format_string(localization.getText("Time_Based_Client_License_Available_Again_In",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),timerString),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay)}}else if(maintenanceMode&&maintenanceMode.isActive&&maintenanceMode.isMaintenanceUser){let timeleft=resolveTimeLeft(maintenanceMode.timer);const timeleftLastWarning=12e4;if(!this.__serverStateRepeatingInfoConfirmend||!this.__serverStateLastRepeatingInfoConfirmend&&timeleft<=timeleftLastWarning){let buttonGuid=tchmi_create_guid();const timerString=resolveTimerAsString(maintenanceMode.timer);dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay,{forceable:!0}),dialogManager.updateTextEx("__TcHmiServerManager",tchmi_format_string(localization.getText("Maintenance_Mode",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),timerString)+'<br />\n<br />\n<input id="'+buttonGuid+'" type="submit" value="'+localization.getText("OK",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+'" style="padding:10px;">',{severity:TcHmi.DialogManager.DialogSeverity.Info,buttonReload:!1}),document.getElementById(buttonGuid)?.addEventListener("click",e=>{this.__serverStateRepeatingInfoConfirmend=!0,timeleft<=timeleftLastWarning&&(this.__serverStateLastRepeatingInfoConfirmend=!0),dialogManager.showDialog("__TcHmiServerManager",!1,TcHmi.DialogManager.DialogType.Overlay),maintenanceMode&&maintenanceMode.timer&&showWaterMark(maintenanceMode.timer)})}else showWaterMark(maintenanceMode.timer)}let publishInProgress=!1,publishInProgressOld=!1;if(this.__serverState&&void 0!==this.__serverState.publishInProgress&&(publishInProgress=this.__serverState.publishInProgress),this.__serverStateOld&&void 0!==this.__serverStateOld.publishInProgress&&(publishInProgressOld=this.__serverStateOld.publishInProgress),null===this.__serverStateLastErrorStatus&&publishInProgress&&!publishInProgressOld)dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Publish_In_Progress",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br />"+localization.getText("Application_Reload_When_Publish_Done",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Warning,buttonReload:!TCHMI_DESIGNER});else if(null===this.__serverStateLastErrorStatus&&!publishInProgress&&publishInProgressOld)return void window.location.reload();465===this.__serverStateLastErrorStatus?(dialogManager.updateTextEx("__TcHmiServerManager",(this.__websocket?"":localization.getText("Server_Connection_Lost",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" ")+localization.getText("Client_Limit_Exceeded",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br />"+(this.__websocket?"":(this.__forcedClose?localization.getText("Forced_Logout_By_Framework",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}):localization.getText("Forced_Logout_By_Server",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}))+"<br />")+localization.getText("Reloading_When_Client_License_Available",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay)):460===this.__serverStateLastErrorStatus?(dialogManager.updateTextEx("__TcHmiServerManager",(this.__websocket?"":localization.getText("Server_Connection_Lost",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" ")+localization.getText("License_Expired",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br />"+(this.__websocket?"":(this.__forcedClose?localization.getText("Forced_Logout_By_Framework",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}):localization.getText("Forced_Logout_By_Server",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}))+"<br />")+localization.getText("Reloading_When_Client_License_Available",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay)):null!==this.__serverStateLastErrorStatus&&(dialogManager.updateTextEx("__TcHmiServerManager",(this.__websocket?"":localization.getText("Server_Connection_Lost",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" ")+tchmi_format_string(localization.getText("Server_State_Request_Failed",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),"Details: HTTP error "+this.__serverStateLastErrorStatus+" "+this.__serverStateLastErrorStatusText)+"<br />"+(this.__websocket?"":(this.__forcedClose?localization.getText("Forced_Logout_By_Framework",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}):localization.getText("Forced_Logout_By_Server",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}))+"<br />")+localization.getText("Reloading_When_Error_State_Cleared",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay)),this.__websocket&&!this.__forcedClose&&null===this.__serverStateLastErrorStatusOld&&null!==this.__serverStateLastErrorStatus&&(this.__forceShowErrorOnClose=!0,this.__forcedClose=!0,this.close()),this.__serverState&&this.__serverState.publishInProgress||(!this.__websocket&&this.__forcedClose&&null===this.__serverStateLastErrorStatus?this.reconnect():null===this.__serverStateLastErrorStatus&&null!==this.__serverStateLastErrorStatusOld&&window.location.reload()),TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})})}__disableCommunication(_event){"__TcHmiServerManager"===dialogManager.getDialogOwner()&&dialogManager.showDialog("__TcHmiServerManager",!1),this.__disabledCommunication=!0,this.__cyclicReconnect=!1,this.__lastConnectState=4,this.close()}createWebsocketOpenHandler(callback){return _openEvent=>{if(!this.__websocket)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_WEBSOCKET_NOT_READY,details:{code:TcHmi.Errors.E_WEBSOCKET_NOT_READY,message:TcHmi.Errors[TcHmi.Errors.E_WEBSOCKET_NOT_READY],domain:"TcHmi.System.ServerManager"},url:this.__serverWebsocketUri});TCHMI_ENGINEERING&&ErrorPane.remove("E_SERVER_CONNECTION_LOST"),TCHMI_UNITTEST_MODE||this.watchServerState(),Log.debugEx("[Source=Framework, Module=TcHmi.System.ServerManager] WebSocket with url=%o opened.",this.__websocket.url);let callbackPending=!0,licenseCheck=callback=>{if(this.__checkLicenseSubscriptionId=Server.subscribeEx([{commandOptions:["SendErrorMessage"],symbol:"Diagnostics::LICENSE"}],1e3,{timeout:config.tcHmiServer.websocketSystemTimeout,parallel:!0},data=>{let connectState=1,errorDetails={code:TcHmi.Errors.NONE};if(data&&data.response&&(data.error===TcHmi.Errors.NONE||data.error===TcHmi.Errors.E_SERVER_RESPONSE_ERROR)){let error=data.response.error;if(void 0!==error)error.code===Server.Error.HMI_E_MISSING_LICENSE_HANDSHAKE||error.code===Server.Error.HMI_E_LICENSE_VERIFY||error.code===Server.Error.HMI_E_LICENSE_TARGET?(connectState=6,errorDetails.code=TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING,dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("License_Missing",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+'<br />\n<br />\n<input type="submit" value="'+localization.getText("Reload",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+'" style="padding:10px;" onclick="window.location.reload()">"',{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER})):(connectState=1,errorDetails.code=TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_CHECK_FAILED,dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Server_License_Check_Failed",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br />"+TcHmi.DialogManager.buildMessage(error),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}));else{let commands=data.response.commands;if(null==commands||void 0===commands[0]||null===commands[0])connectState=1,dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Server_License_Check_Failed",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br />"+localization.getText("Server_Response_Invalid",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" "+localization.getText("Missing_Commands_Or_Command",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER});else if(void 0!==commands[0].error){let cmdErr=commands[0].error,cmdReason=commands[0].symbol;if(cmdErr.code===Server.Error.HMI_E_MISSING_LICENSE_HANDSHAKE||cmdErr.code===Server.Error.HMI_E_LICENSE_VERIFY||cmdErr.code===Server.Error.HMI_E_LICENSE_TARGET)connectState=6,errorDetails.code=TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING,errorDetails.errors=[cmdErr],errorDetails.reason=cmdReason,dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),TCHMI_DESIGNER?dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("License_Missing",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" "+localization.getText("Try_Reopen_Designer_Window",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}):dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("License_Missing",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER});else if(cmdErr.code===Server.Error.HMI_E_INSUFFICIENT_ACCESS)if(TCHMI_DESIGNER)connectState=5,errorDetails.code=TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_NO_ACCESS,errorDetails.errors=[cmdErr],errorDetails.reason=cmdReason,dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Server_License_Check_Failed",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br />"+localization.getText("Insufficient_Access",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" "+localization.getText("Try_Reopen_Designer_Window",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER});else{let bRecon=!1;if(0===this.__lastConnectState)try{const lsReconCount=window.localStorage.getItem(hostPrefix+"TcHmi.System.ServerManager.reconnectCount")??"0",nReconCount=parseInt(lsReconCount,10)+1;window.localStorage.setItem(hostPrefix+"TcHmi.System.ServerManager.reconnectCount",nReconCount.toString()),nReconCount<2&&(bRecon=!0)}catch(ex){}if(bRecon)return void window.location.reload();window.localStorage.removeItem(hostPrefix+"TcHmi.System.ServerManager.reconnectCount"),connectState=5,errorDetails.code=TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_NO_ACCESS,errorDetails.errors=[cmdErr],errorDetails.reason=cmdReason,dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Server_License_Check_Failed",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br />"+localization.getText("Insufficient_Access",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER})}else connectState=2,errorDetails.code=TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_CHECK_FAILED,errorDetails.errors=[cmdErr],errorDetails.reason=cmdReason,dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Server_License_Check_Failed",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br />"+TcHmi.DialogManager.buildMessage(cmdErr),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER})}else{let rv=commands[0].readValue;if(null==rv)connectState=1,errorDetails.code=TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_CHECK_FAILED,errorDetails.reason="Server response is invalid. Missing readValue in command object.",dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Server_License_Check_Failed",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" "+localization.getText("Server_Response_Invalid",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" "+localization.getText("Missing_ReadValue",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER});else switch(rv.STATE){case"Engineering":case"Demo":case"OK":connectState=3,dialogManager.showDialog("__TcHmiServerManager",!1,TcHmi.DialogManager.DialogType.Overlay);break;case"Unregistered":case"Pending":case"Error":connectState=6,errorDetails.code=TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING,errorDetails.reason="License state: '"+rv.STATE+"'.",dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("License_Missing",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" "+tchmi_format_string(localization.getText("License_State_Placeholder",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),rv.STATE),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER});break;default:connectState=6,errorDetails.code=TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING,errorDetails.reason="Unknown license state: '"+rv.STATE+"'.",dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("License_Missing",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" "+tchmi_format_string(localization.getText("License_State_Unknown_Placeholder",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),rv.STATE),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER})}}}}else if(connectState=1,errorDetails.code=TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_CHECK_FAILED,dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),data.error!==TcHmi.Errors.NONE){let details=data.details;details||(details={code:data.error,message:TcHmi.Errors[data.error]}),errorDetails.errors=[details],dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Server_License_Check_Failed",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br />"+TcHmi.DialogManager.buildMessage(details),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER})}else dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Server_License_Check_Failed",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER});TcHmi.Callback.callSafeEx(callback,null,{error:errorDetails.code,details:errorDetails,connectState})}),this.__checkLicenseSubscriptionId){let request=this.__requestCache.get(this.__checkLicenseSubscriptionId);request&&(request.refreshLock=!0)}},finalize=(connectState,errorDetails)=>{errorDetails||(errorDetails={code:TcHmi.Errors.NONE});let result={error:errorDetails.code,url:this.__serverWebsocketUri,details:errorDetails};if(errorDetails.message=TcHmi.Errors[errorDetails.code],errorDetails.domain="TcHmi.System.ServerManager",callbackPending&&"function"==typeof callback&&"__TcHmiServerManager"===dialogManager.getDialogOwner()&&dialogManager.showDialog("__TcHmiServerManager",!1),3===connectState)this.__isReady=!0,this.__cyclicReconnect=!0,this.__forceShowErrorOnClose=!1,this.__forcedClose=!1,window.localStorage.removeItem(hostPrefix+"TcHmi.System.ServerManager.reconnectCount"),callbackPending&&(callbackPending=!1,0!==this.__conWatcherIntervalId&&(window.clearInterval(this.__conWatcherIntervalId),this.__conWatcherIntervalId=0),this.refreshSubscriptions(data=>{TcHmi.EventProvider.raise("onWebSocketOpened"),TcHmi.EventProvider.raise("onServerReady"),TcHmi.Callback.callSafeEx(callback,null,result),this.__lastConnectState=connectState,this.refreshSymbolWatches()}));else if(6===connectState){if(TCHMI_ENGINEERING){const now=Date.now();let isFirstReject=!1;0===this.__firstAccessReject&&(isFirstReject=!0),this.__lastConnectState!==connectState&&(this.__firstAccessReject=now),isFirstReject&&0===this.__firstAccessRejectTimeoutId?(this.__firstAccessReject=0,this.__firstAccessRejectTimeoutId=setTimeout(()=>{6===this.__lastConnectState&&(callbackPending&&(TcHmi.Callback.callSafeEx(callback,null,result),callbackPending=!1),this.__firstAccessRejectTimeoutId=0)},5e3)):now-this.__firstAccessReject>5e3&&(this.__firstAccessReject=0,0!==this.__firstAccessRejectTimeoutId&&(clearTimeout(this.__firstAccessRejectTimeoutId),this.__firstAccessRejectTimeoutId=0),callbackPending&&(TcHmi.Callback.callSafeEx(callback,null,result),callbackPending=!1),callbackPending=!1)}else callbackPending&&(TcHmi.Callback.callSafeEx(callback,null,result),callbackPending=!1),callbackPending=!1;this.__lastConnectState=connectState}else this.__lastConnectState=connectState,callbackPending&&(TcHmi.Callback.callSafeEx(callback,null,result),callbackPending=!1)},handshakeRequired=!1,handshakeApiVersion=this.__frameworkSupportedApiVersion;if(TCHMI_RUNTIME&&this.__serverState&&this.__serverState.frameworkApiVersion){let cvres1=tchmi_compare_version(this.__serverState.frameworkApiVersion,"1.0.0.1");if(0===cvres1||1===cvres1){handshakeRequired=!0;let cvres2=tchmi_compare_version(this.__serverState.frameworkApiVersion,this.__frameworkSupportedApiVersion);handshakeApiVersion=-1===cvres2?this.__serverState.frameworkApiVersion:this.__frameworkSupportedApiVersion}}else TCHMI_ENGINEERING&&(handshakeRequired=!0);handshakeRequired?Server.requestEx({requestType:"ReadWrite",commands:[{commandOptions:["ProcessTimingAsTimespan","SendErrorMessage"],symbol:"__FrameworkHandshake",writeValue:{frameworkApiVersion:handshakeApiVersion}}]},{parallel:!0},data=>{if(data.error!==TcHmi.Errors.NONE){let errObj;return errObj=data.error===TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING||data.details?.code===TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING||data.details?.errors?.some(error=>error.code===TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING)?{error:TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING,details:{code:TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING],domain:"TcHmi.System.ServerManager"},url:this.__serverWebsocketUri}:{error:TcHmi.Errors.E_SERVER_HANDSHAKE,details:{code:TcHmi.Errors.E_SERVER_HANDSHAKE,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_HANDSHAKE],domain:"TcHmi.System.ServerManager"},url:this.__serverWebsocketUri},data.details&&(errObj.details.errors=[data.details]),void TcHmi.Callback.callSafeEx(callback,null,errObj)}if(data.results&&data.results[0]){if(data.results[0].error!==TcHmi.Errors.NONE){let errObj={error:TcHmi.Errors.E_SERVER_HANDSHAKE,details:{code:TcHmi.Errors.E_SERVER_HANDSHAKE,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_HANDSHAKE],domain:"TcHmi.System.ServerManager",reason:"Server does not support required api version. Please update server."},url:this.__serverWebsocketUri};return data.details&&(errObj.details.errors=[data.details]),void TcHmi.Callback.callSafeEx(callback,null,errObj)}}this.__serverSupportedApiVersion=handshakeApiVersion,TCHMI_RUNTIME&&this.__serverState?.maintenanceMode&&this.__serverState?.maintenanceMode.isActive&&this.__serverState?.maintenanceMode.isMaintenanceUser?finalize(3):licenseCheck(data=>{finalize(data.connectState,data.details)})}):licenseCheck(data=>{finalize(data.connectState,data.details)})}}createWebsocketCloseHandler(callback){return closeEvent=>{let bShowError=!1;if(this.__forceShowErrorOnClose&&(this.__forceShowErrorOnClose=!1,bShowError=!0),this.__isReady=!1,this.releaseRequest(this.__checkLicenseSubscriptionId),this.unwatchServerState(),this.__disabledCommunication);else{let message="[Source=Framework, Module=TcHmi.System.ServerManager] WebSocket with url="+this.__serverWebsocketUri+" was closed";1e3!==closeEvent.code?(message+=" with code="+closeEvent.code,closeEvent.reason&&(message+=" and reason="+closeEvent.reason),message+=".",Log.errorEx(message)):(message+=".",Log.debugEx(message))}if(3===this.__lastConnectState&&(this.__lastConnectState=0,!this.__disabledCommunication)){bShowError=!0;const publishInProgress=this.__serverState?.publishInProgress??!1;TCHMI_RUNTIME&&!publishInProgress&&(dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Server_Connection_Lost",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+"<br />"+localization.getText("Determining_Publish_Or_Failure",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" "+localization.getText("This_Will_Take_A_Few_Seconds",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Warning,buttonReload:!TCHMI_DESIGNER}))}this.__symbolWatchEntryCacheByOptions.forEach((ws,key)=>{let callbacks=Array.from(ws.callbacks);for(let i=0,ii=callbacks.length;i<ii;i++){let callback=callbacks[i];TcHmi.Callback.callSafeEx(callback.callback,this,{error:TcHmi.Errors.E_WEBSOCKET_CLOSED,details:{code:TcHmi.Errors.E_WEBSOCKET_CLOSED,message:TcHmi.Errors[TcHmi.Errors.E_WEBSOCKET_CLOSED],reason:"The underlying websocket was closed.",domain:"TcHmi.System.ServerManager"}}),callback.dirty=!0}ws.reqId=null,ws.commandIndex=null});let removeableRequestCacheEntries=[];if(this.__requestCache.forEach((req,id)=>{clearTimeout(req.timeoutTimer);let callbacks=Array.from(req.callbacks);for(const callback of callbacks){const errObj={error:TcHmi.Errors.E_WEBSOCKET_CLOSED,details:{code:TcHmi.Errors.E_WEBSOCKET_CLOSED,message:TcHmi.Errors[TcHmi.Errors.E_WEBSOCKET_CLOSED],reason:"The underlying websocket was closed"+(closeEvent.code?" with code="+closeEvent.code:"")+(closeEvent.reason?" with reason="+closeEvent.reason:"")+".",domain:"TcHmi.System.ServerManager"}};4460!==closeEvent.code&&4465!==closeEvent.code||(errObj.details.errors=[{code:TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING],reason:"License is missing.",domain:"TcHmi.System.ServerManager"}]),TcHmi.Callback.callSafeEx(callback,this,errObj)}(200!==req.type||200===req.type&&req.managed)&&removeableRequestCacheEntries.push(req)}),removeableRequestCacheEntries.forEach((req,index,array)=>{this.unregisterRequest(req.id)}),TcHmi.EventProvider.raise("onWebSocketClosed"),TcHmi.EventProvider.raise("onServerNotReady"),4460===closeEvent.code||4465===closeEvent.code?TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING,url:this.__serverWebsocketUri}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_WEBSOCKET_NOT_READY,url:this.__serverWebsocketUri}),this.__websocket=void 0,!this.__disabledCommunication){const processServerState=()=>{const publishInProgress=this.__serverState?.publishInProgress??!1,licenseTimeout=!!(this.__serverState?.timedClient?.isTimed&&this.__serverState?.timedClient?.expiration&&this.__serverState?.timedClient?.availableAgain),maintenanceModeLock=!(!(this.__serverState&&this.__serverState.maintenanceMode&&this.__serverState.maintenanceMode.isActive)||this.__serverState.maintenanceMode.isMaintenanceUser);!bShowError||publishInProgress||licenseTimeout||maintenanceModeLock||(ErrorPane.add("E_SERVER_CONNECTION_LOST",localization.getText("Server_Connection_Lost",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" "+localization.getText("Reopen_Connection_In_Progress",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),ErrorPane.MessageType.Error),dialogManager.updateTextEx("__TcHmiServerManager",localization.getText("Server_Connection_Lost",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+" "+localization.getText("Reopen_Connection_In_Progress",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),dialogManager.showDialog("__TcHmiServerManager",!0,TcHmi.DialogManager.DialogType.Overlay)),this.__forcedClose||publishInProgress||licenseTimeout||maintenanceModeLock||this.reconnect(),this.watchServerState()};this.__forcedClose?processServerState():this.resolveHandleServerState(()=>{processServerState()})}}}onWebsocketMessage(messageEvent){const response=ValueConverter.toObject(messageEvent.data,null);if(TCHMI_LOG_TCHMISERVER_MESSAGES&&Log.debugEx("[Source=Framework, Module=TcHmi.System.ServerManager] Response from TwinCAT HMI Server:",{response}),null==response)return;if(void 0===response.id||null===response.id)return;const request=this.getRequest(response.id);request&&(TCHMI_DIAGNOSTICS_SERVER&&DiagnosticsServer.requestReceived(request,response),0!==request.timeoutTimer&&(clearTimeout(request.timeoutTimer),request.timeoutTimer=0),TcHmi.Callback.callSafeEx(request.responseCallback,this,{error:TcHmi.Errors.NONE,response}))}reconnect(){this.__cyclicReconnect&&0===this.__conWatcherIntervalId&&(this.__conWatcherIntervalId=window.setInterval(this.onWatcherTick,ServerManager.RECONNECT_INTERVAL))}onWatcherTick(){this.__cyclicReconnect&&void 0===this.__websocket&&this.open()}open(callback){this.__websocket||(TCHMI_DIAGNOSTICS_SERVER&&DiagnosticsServer.start(!0),this.resolveServerState(data=>{if(data.error===TcHmi.Errors.NONE){try{this.__websocket=new WebSocket(this.__serverWebsocketUri)}catch(ex){return void Log.error("[Source=Framework, Module=TcHmi.System.ServerManager] Opening connection to Hmi Webserver failed!")}this.__websocket.onopen=this.createWebsocketOpenHandler(callback),this.__websocket.onclose=this.createWebsocketCloseHandler(callback),this.__websocket.onmessage=this.onWebsocketMessage}else TcHmi.Callback.callSafeEx(callback,this,{...data,url:this.__serverWebsocketUri})}))}__close(){this.__websocket&&(this.__websocket.close(1e3),this.__websocket=void 0)}close(){this.__websocket&&(0!==this.__conWatcherIntervalId&&(window.clearInterval(this.__conWatcherIntervalId),this.__conWatcherIntervalId=0),this.__close())}requestQueueHasPendingRequest(){return!!this.__requestQueuePendingRequest}requestQueueDone(request){request&&this.__requestQueuePendingRequest&&this.__requestQueuePendingRequest.id===request.id&&(this.__requestQueuePendingRequest.queuePending=!1,this.__requestQueuePendingRequest.queue=!1,this.__requestQueuePendingRequest=null,TCHMI_DIAGNOSTICS_SERVER&&DiagnosticsServer.requestPendingDone(request),this.requestQueueNext())}requestQueueAdd(request){this.__requestQueue.push(request),request.queue=!0,TCHMI_DIAGNOSTICS_SERVER&&DiagnosticsServer.requestQueued(request),this.requestQueueHasPendingRequest()||this.requestQueueNext()}requestQueueRemove(request){let pos=-1;for(let i=0,ii=this.__requestQueue.length;i<ii;i++){if(this.__requestQueue[i].id===request.id){pos=i;break}}pos>=0&&this.__requestQueue.splice(pos,1),TCHMI_DIAGNOSTICS_SERVER&&DiagnosticsServer.requestUnqueued(request),this.requestQueueDone(request)}requestQueueNext(){if(!this.__websocket||this.__websocket.readyState!==WebSocket.OPEN)return;let request=this.__requestQueue.shift();request&&(TCHMI_DIAGNOSTICS_SERVER&&DiagnosticsServer.requestUnqueued(request),request.queuePending=!0,this.__requestQueuePendingRequest=request,this.__websocket.send(JSON.stringify(request.message)),TCHMI_DIAGNOSTICS_SERVER&&DiagnosticsServer.requestSent(request))}getFreeRequestId(){let res=0,loopcount=0;do{if(res=0,loopcount++,loopcount>=1e6){Log.error("[Source=Framework, Module=TcHmi.System.ServerManager] Reached maxium of parallel requests."),res=null;break}this.__requestIdCount++,this.__requestIdCount>=1e6&&(this.__requestIdCount=1),res=this.__requestIdCount}while(this.__requestCache.has(res));return res}setServerAddress(protocol,host,port){this.__serverBaseUri=protocol+"//"+host+(port?":"+port:""),this.__serverWebsocketUri=this.__serverBaseUri.replace("http:","ws:").replace("https:","wss:")}getRequest(id){if(null!==id)return this.__requestCache.get(id)}getInteractiveWriteRequest(id){if(null!==id)return this.__requestCacheInteractiveWrite.get(id)}registerRequest(id,type,message){if(this.__requestCache.has(id))return null;let request={id,type,message,deletionPending:!1,timeoutCallback:null,timeoutTimer:0,timeout:null,interval:null,callbacks:[],responseCallback:null,queue:!1,queuePending:!1,managed:!1,refreshLock:!1};return this.__requestCache.set(id,request),TCHMI_DIAGNOSTICS_SERVER&&DiagnosticsServer.requestRegistered(request),request}unregisterRequest(id){if(null===id)return;let request=this.__requestCache.get(id);if(!request){let requestInteractiveWrite=this.__requestCacheInteractiveWrite.get(id);return void requestInteractiveWrite?.destroy()}if(0!==request.timeoutTimer&&(clearTimeout(request.timeoutTimer),request.timeoutTimer=0),this.requestQueueRemove(request),this.__requestCache.delete(id),TCHMI_DIAGNOSTICS_SERVER&&DiagnosticsServer.requestUnregistered(request),request.symbol){let watchEntry=this.__symbolWatchEntryCacheByRef.get(request.symbol);watchEntry&&"ClientPoll"===watchEntry.clientMode&&"ReadWrite"===request.message?.requestType&&watchEntry.clientPendingReadWriteCount>0&&(watchEntry.clientPendingReadWriteCount--,0===watchEntry.clientPendingReadWriteCount&&watchEntry.resetClientPollInterval())}}registerRequestCallback(reqId,callback){let request=this.__requestCache.get(reqId);request&&request.callbacks.push(callback)}unregisterRequestCallback(reqId,callback){let request=this.__requestCache.get(reqId);if(request){let pos=request.callbacks.findIndex(entry=>entry===callback);pos>-1&&request.callbacks.splice(pos,1)}}registerEventCallback(reqId,callback){let request=this.registerRequest(reqId,300);return request?(request.responseCallback=data=>{request&&callSafeCallbacks1Param(request.callbacks,this,{error:TcHmi.Errors.NONE,response:data.response})},this.registerRequestCallback(reqId,callback),reqId):null}refreshSymbolWatches(){this.__refreshSymbolWatchesPending||(this.__refreshSymbolWatchesPending=!0,setTimeout(()=>{let proc=()=>{if(this.__isReady&&void 0!==this.__websocket&&null!==this.__websocket&&this.__websocket.readyState===WebSocket.OPEN){if(!this.procRefreshSymbolWatches())return 0!==this.__refreshSymbolWatchesIntervalId&&(window.clearInterval(this.__refreshSymbolWatchesIntervalId),this.__refreshSymbolWatchesIntervalId=0),void(this.__refreshSymbolWatchesPending=!1)}0===this.__refreshSymbolWatchesIntervalId&&(this.__refreshSymbolWatchesIntervalId=window.setInterval(()=>{proc()},25))};proc()}))}procRefreshSymbolWatches(){let error=!1,toUnsubscribe=[],toSubscribeEntries=new Map;this.__symbolWatchEntryCacheByOptions.forEach((watchEntry,key)=>{let reqId=watchEntry.reqId;if(null!==reqId&&0===watchEntry.refs){const watchEntryGroupKey=`INTERVAL=${watchEntry.interval??"DEFAULT"}_TIMEOUT=${watchEntry.timeout??"DEFAULT"}_GROUP=${watchEntry.group??"DEFAULT"}`;this.__symbolWatchEntryCacheByOptions.delete(key),this.__symbolWatchEntryCacheById.delete(`${watchEntry.name}_${watchEntry.reqId}_${watchEntry.commandIndex??"Unknown"}`),this.__symbolWatchEntryCacheById.delete(`${watchEntry.name}_${watchEntry.reqId}_Unknown`);let watchEntryGroup=this.__symbolWatchEntryGroups.get(watchEntryGroupKey);watchEntryGroup&&(watchEntryGroup.watchEntries.has(key)&&watchEntryGroup.watchEntries.delete(key),0===watchEntryGroup.watchEntries.size&&this.__symbolWatchEntryGroups.delete(watchEntryGroupKey)),watchEntry.clientWriteConfirmTimeout>0&&(clearTimeout(watchEntry.clientWriteConfirmTimeout),watchEntry.clientWriteConfirmTimeout=0),watchEntry.clientPollInterval>0&&(clearInterval(watchEntry.clientPollInterval),watchEntry.clientPollInterval=0),toUnsubscribe.push(reqId),watchEntry.reqId=null,watchEntry.commandIndex=null}}),this.__symbolWatchEntryCacheByOptions.forEach((s,key)=>{let reqId=s.reqId;(null===reqId||toUnsubscribe.includes(reqId))&&(toSubscribeEntries.get(key)||toSubscribeEntries.set(key,s))});let oldWatchEntryDataMap=new Map;if(toSubscribeEntries.forEach((s,key)=>{const watchEntryGroupKey=`INTERVAL=${s.interval??"DEFAULT"}_TIMEOUT=${s.timeout??"DEFAULT"}_GROUP=${s.group??"DEFAULT"}`;let watchEntryGroup=this.__symbolWatchEntryGroups.get(watchEntryGroupKey);watchEntryGroup&&watchEntryGroup.watchEntries.forEach((s2,key2)=>{s2.reqId&&!toUnsubscribe.includes(s2.reqId)&&toUnsubscribe.push(s2.reqId),null!==s2.reqId&&oldWatchEntryDataMap.set(s2,{reqId:s2.reqId,commandIndex:s2.commandIndex}),s2.reqId=null,s2.commandIndex=null,toSubscribeEntries.get(key2)||toSubscribeEntries.set(key2,s2)})}),toUnsubscribe.length>0){let requestObj={requestType:"ReadWrite",commands:[]};for(let i=0,ii=toUnsubscribe.length;i<ii;i++){let reqId=toUnsubscribe[i],req=this.getRequest(reqId);req&&(this.releaseRequest(reqId),req.queue||(requestObj.commands.push({commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"Unsubscribe",writeValue:reqId}),Log.debug("[Source=Framework, Module=TcHmi.System.ServerManager] Unsubscribing request with id="+reqId+".")))}requestObj.commands&&requestObj.commands.length>0&&this.request(requestObj,data=>{let response=data.response;if(void 0===response)return;response.error&&Log.error("[Source=Framework, Module=TcHmi.System.ServerManager] Server responds with error. "+TcHmi.Log.buildMessage(response.error));let commands=response.commands;if(null!=commands)for(let i=0,ii=commands.length;i<ii;i++){let command=commands[i];null!=command&&(void 0!==command.error&&null!==command.error&&Log.errorEx("[Source=Framework, Module=TcHmi.System.ServerManager] Server responds with error for unsubscribe id="+command.writeValue+". ",TcHmi.Log.buildMessage(command.error)))}})}let toSubscribeMessages=new Map;if(toSubscribeEntries.forEach(entry=>{const watchEntryGroupKey=`INTERVAL=${entry.interval??"DEFAULT"}_TIMEOUT=${entry.timeout??"DEFAULT"}_GROUP=${entry.group??"DEFAULT"}`;let watchEntryGroup=this.__symbolWatchEntryGroups.get(watchEntryGroupKey);if(!watchEntryGroup)return;let toSubscribeMessage=toSubscribeMessages.get(watchEntryGroupKey),reqId=this.getFreeRequestId();if(reqId){toSubscribeMessage?entry.reqId=toSubscribeMessage.message.id??null:(entry.reqId=reqId,toSubscribeMessage={interval:entry.interval,timeout:entry.timeout,group:entry.group,watchEntryGroup,message:{requestType:"Subscription",id:reqId,commands:[]}},null!==entry.interval&&(toSubscribeMessage.message.intervalTime=entry.interval));let nSubCmds=toSubscribeMessage.message.commands;if(!nSubCmds)return void(error=!0);let bCreate=!0;for(let i=0,ii=nSubCmds.length;i<ii;i++){let nSubCmd=nSubCmds[i];if(nSubCmd.symbol===entry.name&&nSubCmd.version===entry.version&&tchmi_equal(nSubCmd.commandOptions,entry.options)&&tchmi_equal(nSubCmd.writeValue,entry.writeValue)){bCreate=!1;break}}if(bCreate){let cmd={commandOptions:entry.options,symbol:entry.name};void 0!==entry.writeValue&&(cmd.writeValue=entry.writeValue),entry.version&&(cmd.version=entry.version),void 0!==entry.start&&null!==entry.start&&(cmd.offset=entry.start),void 0!==entry.end&&null!==entry.end&&(void 0!==entry.start&&null!==entry.start?cmd.limit=entry.end-entry.start+1:cmd.limit=entry.end+1),nSubCmds.push(cmd),entry.commandIndex=nSubCmds.indexOf(cmd),Log.debugEx("[Source=Framework, Module=TcHmi.System.ServerManager] Subscribing symbol %o in request id=%o.",entry.name,reqId)}toSubscribeMessages.set(watchEntryGroupKey,toSubscribeMessage)}else error=!0}),error)return!0;let subscribe=m=>{m.watchEntryGroup.watchEntries.forEach(watchEntry=>{for(let j=0,jj=watchEntry.callbacks.length;j<jj;j++){let watchEntryCallback=watchEntry.callbacks[j];watchEntryCallback.dirty||(watchEntryCallback.refreshLock=!0)}});let request=this.getRequest(this.request(m.message,data=>{if(data.error===TcHmi.Errors.NONE){let response=data.response;response.error&&Log.error("[Source=Framework, Module=TcHmi.System.ServerManager] Server responds with error: "+TcHmi.Log.buildMessage(response.error));for(let command of response.commands){if(!command)continue;let watchEntryId=`${command.symbol}_${response.id}_${command.commandIndex??"Unknown"}`,watchEntry=this.__symbolWatchEntryCacheById.get(watchEntryId);if(!watchEntry)continue;if(watchEntry.clientWriteConfirmTimeout>0&&(clearTimeout(watchEntry.clientWriteConfirmTimeout),watchEntry.clientWriteConfirmTimeout=0),watchEntry.clientPollInterval>0&&(clearInterval(watchEntry.clientPollInterval),watchEntry.clientPollInterval=0),void 0!==command.error){let res={error:TcHmi.Errors.E_SERVER_COMMAND_ERROR,details:{code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMAND_ERROR],domain:"TcHmi.System.ServerManager",reason:command.symbol,errors:[command.error]}};response&&(res.response=response),command.processedStart&&(res.processedStart=command.processedStart),command.processedEnd&&(res.processedEnd=command.processedEnd),ServerManager.__callSymbolWatchEntryCallbacks(watchEntry.callbacks,this,res);continue}if(void 0===command.readValue)continue;let hasChanged=!tchmi_equal(watchEntry.value,command.readValue);watchEntry.value=command.readValue,watchEntry.response=response,command.processedStart&&(watchEntry.processedStart=command.processedStart),command.processedEnd&&(watchEntry.processedEnd=command.processedEnd);let callbackList=[];for(let i=0,ii=watchEntry.callbacks.length;i<ii;i++){let wecb=watchEntry.callbacks[i];callbackList.push(wecb)}for(let innerCallback of callbackList)if(watchEntry.callbacks.includes(innerCallback))if(!innerCallback.refreshLock||hasChanged){innerCallback.refreshLock=!1,innerCallback.dirty=!1;let res={error:TcHmi.Errors.NONE,destroy:innerCallback.destroy,value:tchmi_clone_object(watchEntry.value)};response&&(res.response=response),watchEntry.processedStart&&(res.processedStart=watchEntry.processedStart),watchEntry.processedEnd&&(res.processedEnd=watchEntry.processedEnd),TcHmi.Callback.callSafeEx(innerCallback.callback,this,res)}else innerCallback.refreshLock=!1;"ClientPoll"===watchEntry.clientMode&&0===watchEntry.clientPollInterval&&watchEntry.resetClientPollInterval()}}else m.watchEntryGroup.watchEntries.forEach(watchEntry=>{ServerManager.__callSymbolWatchEntryCallbacks(watchEntry.callbacks,this,{error:data.error,details:data.details})})}));request&&(request.managed=!0,m.watchEntryGroup.watchEntries.forEach(watchEntry=>{let oldWatchEntryData=oldWatchEntryDataMap.get(watchEntry);oldWatchEntryData&&(this.__symbolWatchEntryCacheById.delete(`${watchEntry.name}_${oldWatchEntryData.reqId}_Unknown`),void 0!==watchEntry.commandIndex&&null!==watchEntry&&this.__symbolWatchEntryCacheById.delete(`${watchEntry.name}_${oldWatchEntryData.reqId}_${oldWatchEntryData.commandIndex}`)),this.__symbolWatchEntryCacheById.set(`${watchEntry.name}_${watchEntry.reqId}_Unknown`,watchEntry),void 0!==watchEntry.commandIndex&&null!==watchEntry&&this.__symbolWatchEntryCacheById.set(`${watchEntry.name}_${watchEntry.reqId}_${watchEntry.commandIndex}`,watchEntry)}))};return toSubscribeMessages.forEach((message,key)=>{subscribe(message)}),oldWatchEntryDataMap.clear(),error}watch(symbol,expression,options,callback,reason){if(null==expression)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:"No expression given.",domain:"TcHmi.System.ServerManager"}}),()=>{};if(expression.getType()!==TcHmi.SymbolType.Server)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:"No valid expression given. Needs server symbol expression",domain:"TcHmi.System.ServerManager"}}),()=>{};if(null==callback||"function"!=typeof callback)return()=>{};let name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:"No valid expression given. Needs valid server symbol expression",domain:"TcHmi.System.ServerManager"}}),()=>{};let expressionOptions=expression.getOptions(),interval=expressionOptions.Interval??null,timeout=expressionOptions.Timeout??null;0===timeout&&(timeout=null);let writeValue,subscriptionMode=expressionOptions.SubscriptionMode??null,subscriptionGroup=expressionOptions.SubscriptionGroup??null,uniqueHash=expressionOptions.UniqueHash??null,version=options?.forceVersion??expressionOptions.Version??null,start=expressionOptions.Start??null,end=expressionOptions.End??null,watchEntryOptions=["SendErrorMessage"],watchEntryClientMode=null,watchEntryId=name+`_INTERVAL=${interval??"DEFAULT"}`+`_TIMEOUT=${timeout??"DEFAULT"}`;switch(subscriptionMode){case"Poll":watchEntryId+="_SUBSCRIPTIONMODE=POLL",watchEntryOptions.push("Poll");break;case"Change":watchEntryId+="_SUBSCRIPTIONMODE=DEFAULT";break;case"ClientPoll":case"ClientWriteConfirm":watchEntryId+="_SUBSCRIPTIONMODE=DEFAULT",watchEntryClientMode=subscriptionMode;break;default:switch(config.tcHmiServer.websocketSubscriptionMode){case"Poll":watchEntryId+="_SUBSCRIPTIONMODE=POLL",watchEntryOptions.push("Poll");break;case"Change":watchEntryId+="_SUBSCRIPTIONMODE=DEFAULT";break;case"ClientPoll":case"ClientWriteConfirm":watchEntryId+="_SUBSCRIPTIONMODE=DEFAULT",watchEntryClientMode=config.tcHmiServer.websocketSubscriptionMode;break;default:watchEntryId+="_SUBSCRIPTIONMODE=DEFAULT",watchEntryClientMode="ClientWriteConfirm"}}watchEntryId+=`_GROUP=${subscriptionGroup??"DEFAULT"}`,uniqueHash?(watchEntryId+="_UNIQUEHASH=UNIQUEHASH",watchEntryOptions.push("UniqueHash")):watchEntryId+="_UNIQUEHASH=DEFAULT",watchEntryId+=`_VERSION=${version??"DEFAULT"}`,watchEntryId+=`_START=${start??"DEFAULT"}`,watchEntryId+=`_END=${end??"DEFAULT"}`,writeValue=options&&void 0!==options.forceWriteValue?options.forceWriteValue:expressionOptions.WriteValue??void 0,writeValue&&(watchEntryId+=JSON.stringify(writeValue));let watchEntry=this.__symbolWatchEntryCacheByOptions.get(watchEntryId),destroy=()=>{let refresh=!1;if(watchEntry){watchEntry.refs--;let index=-1;for(let i=0,ii=watchEntry.callbacks.length;i<ii;i++)if(watchEntry.callbacks[i].callback===callback){index=i;break}index>-1&&watchEntry.callbacks.splice(index,1),0===watchEntry.refs&&(refresh=!0);let deleteWatchEntryByRef=!0;for(let i=0,ii=watchEntry.callbacks.length;i<ii;i++)if(watchEntry.callbacks[i].symbol===symbol){deleteWatchEntryByRef=!1;break}deleteWatchEntryByRef&&this.__symbolWatchEntryCacheByRef.delete(symbol)}refresh&&this.refreshSymbolWatches()},resetClientPollInterval=()=>{watchEntry&&(watchEntry.clientPollInterval>0&&(clearInterval(watchEntry.clientPollInterval),watchEntry.clientPollInterval=0),watchEntry.clientPollInterval=setInterval(()=>{if(!watchEntry)return;if(watchEntry.clientPendingReadWriteCount>0)return;let callbackList=[];for(let i=0,ii=watchEntry.callbacks.length;i<ii;i++){let wecb=watchEntry.callbacks[i];callbackList.push(wecb)}for(let innerCallback of callbackList){if(!watchEntry.callbacks.includes(innerCallback))continue;let res={error:TcHmi.Errors.NONE,destroy:innerCallback.destroy,value:tchmi_clone_object(watchEntry.value)};watchEntry.response&&(res.response=watchEntry.response),watchEntry.processedStart&&(res.processedStart=watchEntry.processedStart),watchEntry.processedEnd&&(res.processedEnd=watchEntry.processedEnd),TcHmi.Callback.callSafeEx(innerCallback.callback,this,res)}},watchEntry.interval??config.tcHmiServer.websocketIntervalTime))};if(watchEntry){if(watchEntry.callbacks.push({callback,symbol,dirty:!1,refreshLock:!1,destroy}),this.__symbolWatchEntryCacheByRef.set(symbol,watchEntry),watchEntry.refs++,void 0!==watchEntry.value){let res={error:TcHmi.Errors.NONE,destroy,value:tchmi_clone_object(watchEntry.value)};watchEntry.response&&(res.response=watchEntry.response),watchEntry.processedStart&&(res.processedStart=watchEntry.processedStart),watchEntry.processedEnd&&(res.processedEnd=watchEntry.processedEnd),queueMicrotask(()=>{TcHmi.Callback.callSafeEx(callback,this,res)})}}else{watchEntry={reqId:null,commandIndex:null,name,interval,timeout,group:subscriptionGroup,clientMode:watchEntryClientMode,clientPollInterval:0,resetClientPollInterval,clientWriteConfirmTimeout:0,clientPendingReadWriteCount:0,version,start,end,refs:1,value:void 0,writeValue,options:watchEntryOptions,callbacks:[{symbol,callback,dirty:!0,refreshLock:!1,destroy}]},this.__symbolWatchEntryCacheByOptions.set(watchEntryId,watchEntry),this.__symbolWatchEntryCacheByRef.set(symbol,watchEntry);const watchEntryGroupKey=`INTERVAL=${interval??"DEFAULT"}_TIMEOUT=${timeout??"DEFAULT"}_GROUP=${subscriptionGroup??"DEFAULT"}`;let watchEntryGroup=this.__symbolWatchEntryGroups.get(watchEntryGroupKey);if(watchEntryGroup)watchEntryGroup.watchEntries.set(watchEntryId,watchEntry);else{let watchEntryGroup={watchEntries:new Map};this.__symbolWatchEntryGroups.set(watchEntryGroupKey,watchEntryGroup),watchEntryGroup.watchEntries.set(watchEntryId,watchEntry)}}return this.refreshSymbolWatches(),destroy}request(requestObj,callback){return this.requestEx(requestObj,null,callback)}requestEx(requestObj,options,callback){let res=null;if(!(requestObj=tchmi_clone_object(requestObj)))return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:"No request given",domain:"TcHmi.System.ServerManager"}}),null;if(options&&(isParameterTypeInvalid(options.parallel,"options.parallel",{type:"boolean",required:"undefinedOk"},"TcHmi.System.ServerManager",callback)||isParameterTypeInvalid(options.refresh,"options.refresh",{type:"boolean",required:"undefinedOk"},"TcHmi.System.ServerManager",callback)||isParameterTypeInvalid(options.timeout,"options.timeout",{type:"number",required:"undefinedOk"},"TcHmi.System.ServerManager",callback)||isParameterTypeInvalid(options.groupId,"options.groupId",{type:["number","string"],required:"undefinedOk"},"TcHmi.System.ServerManager",callback)))return null;const symbol=options?.symbol??void 0,groupId=options?.groupId;let parallel=options?.parallel??!1;const timeout=options?.timeout,refresh=options?.refresh??!1;let queue=!parallel,byInteractiveWrite=!1,symbolMetaData=null,type=0;switch(requestObj.requestType){case"ReadWrite":if(type=100,Data.Caches.serverSymbolInteractiveWriteMetaDataCache.size>0&&requestObj.commands)for(let command of requestObj.commands){if(void 0===command.writeValue)continue;let metaData=Data.Caches.serverSymbolInteractiveWriteMetaDataCache.get(command.symbol);if(metaData||(metaData=Data.Caches.serverSymbolInteractiveWriteMetaDataCache.get(resolveServerSymbolNameParts(command.symbol).name)),metaData&&(symbolMetaData=metaData,metaData.ListSymbols&&!0===metaData.ListSymbols.REAUTHENTICATION_REQUIRED||metaData.TcHmiAuditTrail&&metaData.TcHmiAuditTrail.AuditTrailSymbols&&metaData.TcHmiAuditTrail.AuditTrailSymbols.enabled&&metaData.TcHmiAuditTrail.AuditTrailSymbols.commentRequired)){byInteractiveWrite=!0;break}}break;case"Subscription":type=200;break;case"Event":type=300,queue=!1,parallel=!0}if(byInteractiveWrite){let request=null;if(void 0===requestObj.id||null===requestObj.id){const newId=this.getFreeRequestId();if(null===newId)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"No request id could be generated",domain:"TcHmi.System.ServerManager"}}),null;requestObj.id=newId}res=requestObj.id;let isDestroyed=!1;if(requestObj.commands&&1===requestObj.commands.length){let InteractiveWriteQueueItem=null,destroy=()=>{isDestroyed=!0,InteractiveWriteQueueItem&&InteractiveWriteQueue.remove(InteractiveWriteQueueItem.id),null!=res&&this.__requestCacheInteractiveWrite.delete(res)};request={id:res,destroy},this.__requestCacheInteractiveWrite.set(res,request);let command=requestObj.commands[0];const metaData={reauthenticationRequired:symbolMetaData?.ListSymbols?.REAUTHENTICATION_REQUIRED??!1,reviewerGroups:symbolMetaData?.ListSymbols?.REVIEWER_GROUPS??void 0,auditTrail:{enabled:symbolMetaData?.TcHmiAuditTrail?.AuditTrailSymbols?.enabled??!1,commentRequired:symbolMetaData?.TcHmiAuditTrail?.AuditTrailSymbols?.commentRequired??!1}},iwSymbol={name:command.symbol,writeValue:command.writeValue,metaData};InteractiveWriteQueueItem=InteractiveWriteQueue.add(iwSymbol,{requestOptions:{timeout,parallel,groupId}}),InteractiveWriteQueueItem.promise.then(result=>{if(result.isOk){let res={error:TcHmi.Errors.NONE};void 0!==result.value?.result?.value&&(res.value=result.value.result.value),void 0!==result.value?.result?.response&&(res.response=result.value.result.response),TcHmi.Callback.callSafeEx(callback,this,res)}else{let res={error:TcHmi.Errors.E_INTERACTIVE_WRITE_ABORT,details:{code:TcHmi.Errors.E_INTERACTIVE_WRITE_ABORT,message:TcHmi.Errors[TcHmi.Errors.E_INTERACTIVE_WRITE_ABORT],reason:"InteractiveWritePrompt has been aborted.",domain:"TcHmi.System.ServerManager"}};void 0!==result.value?.result?.value&&(res.value=result.value.result.value),void 0!==result.value?.result?.response&&(res.response=result.value.result.response),TcHmi.Callback.callSafeEx(callback,this,res)}destroy()}).catch(e=>{TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:"InteractiveWritePrompt has been closed due to unexpected exception.",exception:e,domain:"TcHmi.System.ServerManager"}}),destroy()})}else if(requestObj.commands&&requestObj.commands.length>1){let requests=[],results=[],destroy=()=>{isDestroyed=!0;for(let request of requests)void 0!==request.id&&this.releaseRequest(request.id);null!==res&&this.__requestCacheInteractiveWrite.delete(res)};request={id:res,destroy},this.__requestCacheInteractiveWrite.set(res,request);for(let command of requestObj.commands){let requestObjNew=tchmi_clone_object(requestObj),newId=this.getFreeRequestId();null!=newId&&(requestObjNew.id=newId),requestObjNew.commands=[command],requests.push(requestObjNew)}let processSingleRequest=index=>{isDestroyed||this.requestEx(requests[index],options,Server.handleResponse({completed:data=>{if(!isDestroyed){if(data.error!==TcHmi.Errors.NONE){let res={error:data.error};data.details&&(res.details=data.details),results.push(res)}else results.push(data.results[0]);if(index+1>=requests.length)return destroy(),void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,results});processSingleRequest(index+1)}}}))};processSingleRequest(0)}}else{let request,group;if(null!=groupId){if(group=this.__requestGroups.get(groupId+"_PARALLEL="+(parallel?"TRUE":"FALSE")+"_REFRESH="+(refresh?"TRUE":"FALSE")+`_TIMEOUT${timeout??"UNDEFINED"}`),group)res=group.requestId,group.requests.push({message:requestObj,options,callback});else{const newId=this.getFreeRequestId();if(null===newId)return TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"No request id could be generated",domain:"TcHmi.System.ServerManager"}}),null;res=newId,group={id:groupId,requestId:newId,options:{parallel,timeout,refresh},requests:[{message:requestObj,options,callback}]},this.__requestGroups.set(groupId+"_PARALLEL="+(parallel?"TRUE":"FALSE")+"_REFRESH="+(refresh?"TRUE":"FALSE")+`_TIMEOUT${timeout??"UNDEFINED"}`,group),(group=>{setTimeout(()=>{this.__requestGroups.delete(groupId+"_PARALLEL="+(parallel?"TRUE":"FALSE")+"_REFRESH="+(refresh?"TRUE":"FALSE")+`_TIMEOUT${timeout??"UNDEFINED"}`);let bundledRequest={requestType:"ReadWrite",id:group.requestId,commands:[]},requestCommandIndicesMap=new Map,responseCommandIndexMap=new Map,responseCommandIndex=0;group.requests.forEach(request=>{let requestResponseCommandIndices=[];request.message.commands?.forEach(command=>{let key=command.symbol;if(command.commandOptions){let clone=tchmi_clone_object(command.commandOptions);clone.sort();for(let option of clone)key+="_"+option}let responseCommandIndexWriteValueIndexList=responseCommandIndexMap.get(key);if(responseCommandIndexWriteValueIndexList){let foundIndex;for(let responseCommandIndexWriteValueIndex of responseCommandIndexWriteValueIndexList)if(tchmi_equal(responseCommandIndexWriteValueIndex.writeValue,command.writeValue)){foundIndex=responseCommandIndexWriteValueIndex.index;break}void 0!==foundIndex?requestResponseCommandIndices.push(foundIndex):(bundledRequest.commands?.push(command),responseCommandIndexWriteValueIndexList.push({writeValue:command.writeValue,index:responseCommandIndex}),requestResponseCommandIndices.push(responseCommandIndex),responseCommandIndex++)}else bundledRequest.commands?.push(command),responseCommandIndexMap.set(key,[{writeValue:command.writeValue,index:responseCommandIndex}]),requestResponseCommandIndices.push(responseCommandIndex),responseCommandIndex++}),requestCommandIndicesMap.set(request,requestResponseCommandIndices)});let options={};group&&group.options&&group.options.timeout&&(options.timeout=group.options.timeout),this.requestEx(bundledRequest,options,data=>{group.requests.forEach(request=>{let requestResponseCommandIndicesObject={},requestResponseCommandIndices=requestCommandIndicesMap.get(request);requestResponseCommandIndices&&requestResponseCommandIndices.length>0&&(requestResponseCommandIndicesObject.responseCommandIndices=requestResponseCommandIndices),TcHmi.Callback.callSafeEx(request.callback,this,{...data,...requestResponseCommandIndicesObject})})})})})(group)}return res}let requestTimeout=timeout??config.tcHmiServer.websocketTimeout,requestResponseCallback=data=>{if(request){if(callSafeCallbacks1Param(request.callbacks,this,{error:TcHmi.Errors.NONE,response:data.response}),symbol){let watchEntry=this.__symbolWatchEntryCacheByRef.get(symbol);watchEntry&&"ClientWriteConfirm"===watchEntry.clientMode&&(watchEntry.clientWriteConfirmTimeout&&(clearTimeout(watchEntry.clientWriteConfirmTimeout),watchEntry.clientWriteConfirmTimeout=0),watchEntry.clientWriteConfirmTimeout=setTimeout(()=>{let callbackList=[];for(let i=0,ii=watchEntry.callbacks.length;i<ii;i++){let wecb=watchEntry.callbacks[i];callbackList.push(wecb)}for(let innerCallback of callbackList){if(!watchEntry.callbacks.includes(innerCallback))continue;let res={error:TcHmi.Errors.NONE,destroy:innerCallback.destroy,value:tchmi_clone_object(watchEntry.value)};watchEntry.response&&(res.response=watchEntry.response),watchEntry.processedStart&&(res.processedStart=watchEntry.processedStart),watchEntry.processedEnd&&(res.processedEnd=watchEntry.processedEnd),TcHmi.Callback.callSafeEx(innerCallback.callback,this,res)}},watchEntry.interval??config.tcHmiServer.websocketIntervalTime))}request.queue&&this.requestQueueDone(request),200!==request.type&&this.releaseRequest(request.id)}},requestTimeoutCallback=()=>{const reasonObject={};if(void 0!==groupId?reasonObject.reason=`Request for group id "${groupId}" did not respond within expected time of ${requestTimeout/1e3} seconds.`:requestObj.id?reasonObject.reason=`Request with id "${requestObj.id}" did not respond within expected time of ${requestTimeout/1e3} seconds.`:reasonObject.reason=`Request did not respond within expected time of ${requestTimeout/1e3} seconds.`,TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_TIMEOUT,details:{code:TcHmi.Errors.E_TIMEOUT,message:TcHmi.Errors[TcHmi.Errors.E_TIMEOUT],domain:"TcHmi.System.ServerManager",...reasonObject}}),request)request.queue&&this.requestQueueDone(request),this.releaseRequest(request.id),request=null;else if(symbol){let watchEntry=this.__symbolWatchEntryCacheByRef.get(symbol);watchEntry&&"ClientPoll"===watchEntry.clientMode&&100===type&&watchEntry.clientPendingReadWriteCount>0&&(watchEntry.clientPendingReadWriteCount--,0===watchEntry.clientPendingReadWriteCount&&watchEntry.resetClientPollInterval())}},requestTimeoutTimer=setTimeout(()=>{TcHmi.Callback.callSafeEx(requestTimeoutCallback,this)},requestTimeout),clearRequestTimeout=()=>{requestTimeoutTimer&&(clearTimeout(requestTimeoutTimer),requestTimeoutTimer=0),request&&request.timeoutTimer&&(request.timeoutTimer=0),request&&request.timeoutCallback&&(request.timeoutCallback=null)};if(void 0===requestObj.id||null===requestObj.id){const newId=this.getFreeRequestId();if(null===newId)return clearRequestTimeout(),TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"No request id could be generated",domain:"TcHmi.System.ServerManager"}}),null;requestObj.id=newId}if(res=requestObj.id,this.__websocket&&this.__websocket.readyState!==WebSocket.CLOSING&&this.__websocket.readyState!==WebSocket.CLOSED&&this.__websocket.readyState!==WebSocket.CONNECTING){if(request=refresh?this.getRequest(requestObj.id):this.registerRequest(requestObj.id,type,requestObj),!request)return clearRequestTimeout(),TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:'A request with the same id: "'+requestObj.id+'" is already in progress.',domain:"TcHmi.System.ServerManager"}}),null;if("function"==typeof callback&&this.registerRequestCallback(requestObj.id,callback),TCHMI_LOG_TCHMISERVER_MESSAGES&&Log.debugEx("[Source=Framework, Module=TcHmi.System.ServerManager] Request to TwinCAT HMI Server:",{requestObj}),"Subscription"===requestObj.requestType&&(requestObj.intervalTime??=config.tcHmiServer.websocketIntervalTime,request.interval=requestObj.intervalTime),request.timeout=requestTimeout,request.timeoutCallback=requestTimeoutCallback,request.responseCallback=requestResponseCallback,request.timeoutTimer=requestTimeoutTimer,request.symbol=symbol,symbol&&100===type){let watchEntry=this.__symbolWatchEntryCacheByRef.get(symbol);watchEntry&&"ClientPoll"===watchEntry.clientMode&&(watchEntry.clientPendingReadWriteCount++,watchEntry.clientPollInterval>0&&(clearInterval(watchEntry.clientPollInterval),watchEntry.clientPollInterval=0))}queue?this.requestQueueAdd(request):(this.__websocket.send(JSON.stringify(request.message)),TCHMI_DIAGNOSTICS_SERVER&&DiagnosticsServer.requestSent(request))}else clearRequestTimeout(),TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.E_WEBSOCKET_NOT_READY,details:{code:TcHmi.Errors.E_WEBSOCKET_NOT_READY,message:TcHmi.Errors[TcHmi.Errors.E_WEBSOCKET_NOT_READY],domain:"TcHmi.System.ServerManager"}})}return res}releaseRequest(id){this.unregisterRequest(id)}getWebsocketReadyState(){return this.__websocket?.readyState??null}isReady(){return this.__isReady}login(username,password,persistent=!0,reload=!0,options,callback){const message={requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"Login",writeValue:{userName:username,password,persistent}}]};return accessManager.unsubscribe(data=>{accessManager.enableReload(reload),serverManager.requestEx(message,options,Server.handleResponse({error:data=>{accessManager.subscribe(()=>{if(data.error===TcHmi.Errors.NONE&&data.results){let res=data.results[0];TcHmi.Callback.callSafeEx(callback,this,{error:res.error,details:res.details})}else TcHmi.Callback.callSafeEx(callback,this,{error:data.error,details:data.details})})},success:data=>{Log.debug("Login successful with username: "+data.response.commands[0].writeValue.userName);let cookieName="sessionId";data.response.serverId&&(cookieName+="-"+data.response.serverId,document.cookie="sessionId=; expires=Thu, 01 Jan 1970 00:00:00 GMT"),document.cookie=cookieName+"="+data.response.sessionId+"; path=/",reload?window.location.reload():accessManager.subscribe(()=>{TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})})}}))}),!0}logout(reload=!0,options,callback){return accessManager.unsubscribe(data=>{accessManager.enableReload(reload);serverManager.requestEx({requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"Logout"}]},options,Server.handleResponse({error:data=>{accessManager.subscribe(()=>{if(data.error===TcHmi.Errors.NONE&&data.results){let res=data.results[0];TcHmi.Callback.callSafeEx(callback,this,{error:res.error,details:res.details})}else TcHmi.Callback.callSafeEx(callback,this,{error:data.error,details:data.details})})},success:data=>{if(reload)window.location.reload();else{let cookieName="sessionId";data.response.serverId&&(cookieName+="-"+data.response.serverId,document.cookie="sessionId=; expires=Thu, 01 Jan 1970 00:00:00 GMT"),document.cookie=cookieName+"="+data.response.sessionId+"; path=/",accessManager.subscribe(data=>{TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})})}}}))}),!0}forceLogout(username,options,callback){const message={requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"ForceLogout",writeValue:username}]};return serverManager.requestEx(message,options,Server.handleResponse({error:data=>{if(data.error===TcHmi.Errors.NONE&&data.results){let res=data.results[0];TcHmi.Callback.callSafeEx(callback,null,{error:res.error,details:res.details})}else TcHmi.Callback.callSafeEx(callback,null,{error:data.error,details:data.details})},success:data=>{TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE})}})),!0}refreshSubscription(request,callback){this.request({requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"Unsubscribe",writeValue:request.id}]},data=>{request.message?"Subscription"===request.message?.requestType&&(null===request.interval&&delete request.message.intervalTime,null===request.timeout&&request.timeoutTimer&&(clearTimeout(request.timeoutTimer),request.timeoutTimer=0),this.requestEx(request.message,{refresh:!0},data=>{TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})})):TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"No message found for refreshSubscription",domain:"TcHmi.System.ServerManager"}})})}refreshSubscriptions(callback){let pending=0,finalize=()=>{0===pending&&TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})};this.__requestCache.forEach((request,id)=>{200!==request.type||request.refreshLock||(pending++,this.refreshSubscription(request,data=>{pending--,finalize()})),request.refreshLock&&(request.refreshLock=!1)}),finalize()}static __callSymbolWatchEntryCallbacks(callbacks,thisArg,data){let callbackList=[];for(let i=0,ii=callbacks.length;i<ii;i++)callbackList.push(callbacks[i]);for(let innerCallback of callbackList)callbacks.includes(innerCallback)&&TcHmi.Callback.callSafeEx(innerCallback.callback,thisArg,data)}getApiVersion(){return this.isReady()?this.__serverSupportedApiVersion:null}__processServerSymbolMetaData(results){let changes=[];for(let result of results)if("ListSymbols"===result.symbol){let rv=result.value;for(let symbol in rv){let cacheEntry=Data.Caches.serverSymbolMetaDataCache.get(symbol),cachEntryOld=tchmi_clone_object(cacheEntry);cacheEntry?cacheEntry.ListSymbols=rv[symbol]:(cacheEntry={error:TcHmi.Errors.NONE,ListSymbols:rv[symbol]},Data.Caches.serverSymbolMetaDataCache.set(symbol,cacheEntry)),changes.push({symbol,entryOld:cachEntryOld,entryNew:cacheEntry})}}else if("TcHmiAuditTrail.AuditTrailSymbols"===result.symbol){let rv=result.value;if(!rv)return;for(let symbol in rv){let cacheEntry=Data.Caches.serverSymbolMetaDataCache.get(symbol),cachEntryOld=tchmi_clone_object(cacheEntry);cacheEntry?cacheEntry.TcHmiAuditTrail={AuditTrailSymbols:rv[symbol]}:(cacheEntry={error:TcHmi.Errors.NONE,TcHmiAuditTrail:{AuditTrailSymbols:rv[symbol]}},Data.Caches.serverSymbolMetaDataCache.set(symbol,cacheEntry)),changes.push({symbol,entryOld:cachEntryOld,entryNew:cacheEntry})}}this.__resolveServerSymbolInteractiveWriteMetaDataCache(),changes.length&&TcHmi.EventProvider.raise("System.onServerSymbolsMetaDataChanged",tchmi_clone_object(changes));for(let change of changes)TcHmi.EventProvider.raise("System.onServerSymbolMetaDataChanged",tchmi_clone_object(change)),TcHmi.EventProvider.raise("System.onServerSymbolMetaDataChanged<"+change.symbol+">",tchmi_clone_object(change))}__resolveServerSymbolInteractiveWriteMetaDataCache(){Data.Caches.serverSymbolInteractiveWriteMetaDataCache.clear(),Data.Caches.serverSymbolMetaDataCache.forEach((metaData,symbolName)=>{(metaData.ListSymbols&&!0===metaData.ListSymbols.REAUTHENTICATION_REQUIRED||metaData.TcHmiAuditTrail&&metaData.TcHmiAuditTrail.AuditTrailSymbols&&metaData.TcHmiAuditTrail.AuditTrailSymbols.enabled&&metaData.TcHmiAuditTrail.AuditTrailSymbols.commentRequired)&&Data.Caches.serverSymbolInteractiveWriteMetaDataCache.set(symbolName,metaData)})}resolveServerSymbolMetaData(callback){let request={requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage"],symbol:"ListSymbols"}]};AuditTrailisEnabled&&request.commands?.push({commandOptions:["SendErrorMessage"],symbol:"TcHmiAuditTrail.AuditTrailSymbols"}),Server.requestEx(request,null,Server.handleResponse({error:data=>{if(data.error!==TcHmi.Errors.NONE)TcHmi.Callback.callSafeEx(callback,null,{error:data.error,details:data.details});else if(data.results&&data.results.length){let res={error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR]}};for(let result of data.results)result.error!==TcHmi.Errors.NONE&&(result.details&&res.details&&!res.details.errors?res.details.errors=[result.details]:result.details&&res.details&&res.details.errors&&res.details.errors.push(result.details));TcHmi.Callback.callSafeEx(callback,null,res)}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR]}})},success:data=>{this.__processServerSymbolMetaData(data.results),TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE})}}))}watchOrResolveServerSymbolMetaData(callback){if(TCHMI_ENGINEERING||!config.tcHmiServer.disableOptionalSystemSubscriptions){let called=!1;if(this.__serverSymbolMetaDataWatchId)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR]}});let request={requestType:"Subscription",intervalTime:1e3,commands:[{commandOptions:["SendErrorMessage"],symbol:"ListSymbols"}]};AuditTrailisEnabled&&request.commands?.push({commandOptions:["SendErrorMessage"],symbol:"TcHmiAuditTrail.AuditTrailSymbols"}),this.__serverSymbolMetaDataWatchId=Server.requestEx(request,null,Server.handleResponse({error:data=>{if(called);else if(called=!0,data.error!==TcHmi.Errors.NONE)TcHmi.Callback.callSafeEx(callback,null,{error:data.error,details:data.details});else if(data.results&&data.results.length){let res={error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR]}};for(let result of data.results)result.error!==TcHmi.Errors.NONE&&(result.details&&res.details&&!res.details.errors?res.details.errors=[result.details]:result.details&&res.details&&res.details.errors&&res.details.errors.push(result.details));TcHmi.Callback.callSafeEx(callback,null,res)}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR]}})},success:data=>{this.__processServerSymbolMetaData(data.results),this.__resolveServerSymbolInteractiveWriteMetaDataCache(),called||(called=!0,TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE}))}}))}else this.resolveServerSymbolMetaData(callback)}}})();export{ServerManager};export const serverManager=new ServerManager;
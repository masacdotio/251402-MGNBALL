import*as View from"../API/View.js";import{Log}from"../API/Log.js";import{controlManager}from"./ControlManager.js";import{splashScreen}from"./SplashScreen.js";import{Data}from"./System.js";import{resolveMarkupReplaceExpressions,resolveViewMarkupReplaceExpressions}from"./SystemFunctions.js";const jqBody=$(document.body);export var ScaleMode;!function(ScaleMode){ScaleMode[ScaleMode.None=0]="None",ScaleMode[ScaleMode.ScaleToFit=1]="ScaleToFit",ScaleMode[ScaleMode.ScaleToFitWidth=2]="ScaleToFitWidth",ScaleMode[ScaleMode.ScaleToFitHeight=3]="ScaleToFitHeight",ScaleMode[ScaleMode.ScaleToFill=4]="ScaleToFill"}(ScaleMode||(ScaleMode={}));let ViewManager=(()=>{var _a,_b,_c,_d;let ___handlePosition_decorators,___onWindowResized_decorators,___onViewDestroyed_decorators,___onViewResized_decorators,_instanceExtraInitializers=[];return class{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___handlePosition_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___onWindowResized_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___onViewDestroyed_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],___onViewResized_decorators=[(_d=TcHmi).CallbackMethod.bind(_d)],__esDecorate(this,null,___handlePosition_decorators,{kind:"method",name:"__handlePosition",static:!1,private:!1,access:{has:obj=>"__handlePosition"in obj,get:obj=>obj.__handlePosition},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onWindowResized_decorators,{kind:"method",name:"__onWindowResized",static:!1,private:!1,access:{has:obj=>"__onWindowResized"in obj,get:obj=>obj.__onWindowResized},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onViewDestroyed_decorators,{kind:"method",name:"__onViewDestroyed",static:!1,private:!1,access:{has:obj=>"__onViewDestroyed"in obj,get:obj=>obj.__onViewDestroyed},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onViewResized_decorators,{kind:"method",name:"__onViewResized",static:!1,private:!1,access:{has:obj=>"__onViewResized"in obj,get:obj=>obj.__onViewResized},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){window.addEventListener("resize",this.__onWindowResized),document.addEventListener("scroll",this.__handlePosition,{passive:!1}),TcHmi.EventProvider.register("System.onViewpartsChanged",this.__handlePosition),window.visualViewport&&(window.visualViewport.addEventListener("resize",this.__handlePosition),window.visualViewport.addEventListener("scroll",this.__handlePosition,{passive:!1})),TCHMI_DESIGNER&&import("./Engineering/DesignerModeMasterRootControlMngr.js").then(module=>{this.#rootControlManager=module.rootControlManager}).catch(ex=>{Log.errorEx("Failed to load rootControlManager in Framework ViewManager:",ex)})}#rootControlManager=__runInitializers(this,_instanceExtraInitializers);boundingClientRectNeedsViewPortOffset=null;__offsetAnimationFrameId=0;__handlePosition(){const centerElement=this.__view?.getElement()[0].parentElement;centerElement&&(this.__offsetAnimationFrameId||(this.__offsetAnimationFrameId=window.requestAnimationFrame(time=>{this.__offsetAnimationFrameId=0,this.boundingClientRectNeedsViewPortOffset&&window.visualViewport?(document.body.style.setProperty("--mainViewOffsetTop",centerElement.offsetTop+window.visualViewport.offsetTop+"px"),document.body.style.setProperty("--mainViewOffsetLeft",centerElement.offsetLeft+window.visualViewport.offsetLeft+"px")):(document.body.style.setProperty("--mainViewOffsetTop",centerElement.offsetTop+"px"),document.body.style.setProperty("--mainViewOffsetLeft","0px"))})))}__scaleMode=ScaleMode.None;__view=null;__animationFrameTimeId=0;__viewUrl=null;__onSystemSplashScreenHideEvent=null;__onViewResizedEventDestroyEvent=null;__onViewDestroyedEventDestroyEvent=null;__pending=!1;__onWindowResized(){this.__handlePosition(),this.__scaleMode!==ScaleMode.None&&this.__scale()}__onViewDestroyed(_event,tco){this.__view===tco&&(jqBody.children().detach(),null!==this.__onViewResizedEventDestroyEvent&&(this.__onViewResizedEventDestroyEvent(),this.__onViewResizedEventDestroyEvent=null),null!==this.__onViewDestroyedEventDestroyEvent&&(this.__onViewDestroyedEventDestroyEvent(),this.__onViewDestroyedEventDestroyEvent=null),this.__view=null,this.__viewUrl=null)}__onViewResized(_event,_tco){this.__scaleMode!==ScaleMode.None&&this.__scale()}checkBrowserFeatures(){if(!window.visualViewport)return;const visualViewport=window.visualViewport,checkVVOS=evt=>{if("boolean"==typeof this.boundingClientRectNeedsViewPortOffset||visualViewport.scale<1.01||visualViewport.offsetTop<1&&visualViewport.offsetLeft<1)return;const dummyElem=document.createElement("div");dummyElem.style.position="fixed",dummyElem.style.top="50px",dummyElem.style.left="50px",dummyElem.style.width="1px",dummyElem.style.height="1px",document.body.append(dummyElem);const detectedElem=document.elementFromPoint(50,50);dummyElem.remove(),this.boundingClientRectNeedsViewPortOffset=detectedElem!==dummyElem,visualViewport.removeEventListener("resize",checkVVOS)};visualViewport.addEventListener("resize",checkVVOS),checkVVOS()}__scale(){this.__animationFrameTimeId||(this.__animationFrameTimeId=window.requestAnimationFrame(()=>{this.__doScaling()}))}__doScaling(){if(this.__animationFrameTimeId=0,TCHMI_DESIGNER)return;if(!this.__view)return;const elem=this.__view.getElement()[0];if(!elem)return;const rendWidth=this.__view.getRenderedWidth(),rendHeight=this.__view.getRenderedHeight();if(rendHeight&&rendWidth)switch(this.__scaleMode){case ScaleMode.ScaleToFit:{let ratioW=(View.getViewportElementDimension()?.width??window.innerWidth)/rendWidth,ratioH=(View.getViewportElementDimension()?.height??window.innerHeight)/rendHeight,ratio=ratioW>ratioH?ratioH:ratioW;elem.style.transform=`scale(${ratio})`,elem.style.transformOrigin="0 0"}break;case ScaleMode.ScaleToFitWidth:{let ratio=(View.getViewportElementDimension()?.width??window.innerWidth)/rendWidth;elem.style.transform=`scale(${ratio})`,elem.style.transformOrigin="0 0"}break;case ScaleMode.ScaleToFitHeight:{let ratio=(View.getViewportElementDimension()?.height??window.innerHeight)/rendHeight;elem.style.transform=`scale(${ratio})`,elem.style.transformOrigin="0 0"}break;case ScaleMode.ScaleToFill:{let ratioW=(View.getViewportElementDimension()?.width??window.innerWidth)/rendWidth,ratioH=(View.getViewportElementDimension()?.height??window.innerHeight)/rendHeight;elem.style.transform=`scale(${ratioW},${ratioH})`,elem.style.transformOrigin="0 0"}break;case ScaleMode.None:elem.style.transform="",elem.style.transformOrigin=""}}setScaleMode(scaleModeStr){let sm=ScaleMode.None;switch(scaleModeStr){case"ScaleToFit":sm=ScaleMode.ScaleToFit;break;case"ScaleToFitWidth":sm=ScaleMode.ScaleToFitWidth;break;case"ScaleToFitHeight":sm=ScaleMode.ScaleToFitHeight;break;case"ScaleToFill":sm=ScaleMode.ScaleToFill}this.__scaleMode=sm,this.__scale()}getView(){return this.__view}loadView(url,callback=null){const benchmarkObj={processStart:NaN,htmlFetchStart:NaN,htmlFetchEnd:NaN,compileStart:NaN,compileEnd:NaN,addContentToDomStart:NaN,addContentToDomEnd:NaN,asyncAttachStart:NaN,asyncAttachEnd:NaN,removeContentFromDomStart:NaN,removeContentFromDomEnd:NaN,screenUpdated:NaN};if(-1===TCHMI_CONSOLE_LOG_LEVEL&&(benchmarkObj.processStart=performance.now()),this.__pending)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Loading "+url+" failed because we have already another load pending.",domain:"TcHmi.System.ViewManager"}});const partialUrl=tchmi_path(url);if(this.__viewUrl===partialUrl)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE});if(this.__pending=!0,this.__view){-1===TCHMI_CONSOLE_LOG_LEVEL&&(benchmarkObj.removeContentFromDomStart=performance.now()),jqBody.children().detach(),this.__onSystemSplashScreenHideEvent&&(this.__onSystemSplashScreenHideEvent(),this.__onSystemSplashScreenHideEvent=null),null!==this.__onViewResizedEventDestroyEvent&&(this.__onViewResizedEventDestroyEvent(),this.__onViewResizedEventDestroyEvent=null),null!==this.__onViewDestroyedEventDestroyEvent&&(this.__onViewDestroyedEventDestroyEvent(),this.__onViewDestroyedEventDestroyEvent=null),this.__view.destroy();const viewportContainer=this.__view.getElement()[0].parentElement;viewportContainer&&this.removeViewportElement(viewportContainer),this.__view=null,this.__viewUrl=null,-1===TCHMI_CONSOLE_LOG_LEVEL&&(benchmarkObj.removeContentFromDomEnd=performance.now())}if(!partialUrl)return this.__pending=!1,void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE});let __proc=(url,markup,keepAlive)=>{let loadingSpinnerDiv=null;if(!TCHMI_DESIGNER&&!splashScreen.isVisible()){let loadingSpinnerDivTempDiv=document.createElement("div");loadingSpinnerDivTempDiv.innerHTML='<div class="tchmi-view-loading-spinner-container">\n                    <div class="tchmi-view-loading-spinner">\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                    </div>\n                </div>',loadingSpinnerDiv=loadingSpinnerDivTempDiv.firstElementChild,loadingSpinnerDiv&&document.body.appendChild(loadingSpinnerDiv)}setTimeout(()=>{let tempDiv=document.createElement("div");TCHMI_DESIGNER&&url===TCHMI_TARGET_PARTIAL?tempDiv.innerHTML=resolveMarkupReplaceExpressions(url,markup):tempDiv.innerHTML=resolveViewMarkupReplaceExpressions(url,markup);const elem=tempDiv.firstElementChild;let errorreason;if(elem)if(elem.hasAttribute("data-tchmi-type")){const duplicates=Array.from(tempDiv.querySelectorAll("[data-tchmi-type]")).map(data=>data.id).filter((value,index,array)=>array.indexOf(value)!==index);duplicates.length&&(errorreason="Duplicate control names found: "+duplicates.join(", "))}else errorreason="First html element is no tchmi control (missing data-tchmi-type attribute).";else errorreason="No valid html elements found.";if(errorreason||!elem)return void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Compiling "+url+" failed. "+errorreason,domain:"TcHmi.System.ViewManager"}});elem.remove();let vo=TcHmi.Controls.get(elem.id),controlResult={error:vo?TcHmi.Errors.NONE:TcHmi.Errors.ERROR,control:vo};if(vo||(url===TCHMI_TARGET_PARTIAL&&elem.setAttribute("data-tchmi-creator-partial-key",TCHMI_TARGET_PARTIAL),elem.setAttribute("data-tchmi-partial-url",url),-1===TCHMI_CONSOLE_LOG_LEVEL&&(benchmarkObj.compileStart=performance.now()),controlResult=controlManager.compile(elem),-1===TCHMI_CONSOLE_LOG_LEVEL&&(benchmarkObj.compileEnd=performance.now()),vo=controlResult.control),!vo)return this.__pending=!1,void TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Compiling "+url+" failed.",domain:"TcHmi.System.ViewManager",errors:controlResult.details?[controlResult.details]:void 0}});if(keepAlive&&vo.__setKeepAlive(!0),this.__view=vo,this.__viewUrl=url,this.__onViewResizedEventDestroyEvent=TcHmi.EventProvider.register(this.__view.getId()+".onResized",this.__onViewResized),this.__onViewDestroyedEventDestroyEvent=TcHmi.EventProvider.register(this.__view.getId()+".onDestroyed",this.__onViewDestroyed),splashScreen.isVisible()||jqBody.children().detach(),-1===TCHMI_CONSOLE_LOG_LEVEL&&(benchmarkObj.addContentToDomStart=performance.now()),TCHMI_DESIGNER&&this.#rootControlManager){const vpSimulator=this.#rootControlManager.getViewPortSimulator();$(vpSimulator).empty(),vpSimulator.appendChild(this.__view.getElement()[0]),document.body.appendChild(vpSimulator)}else{!splashScreen.isVisible()&&loadingSpinnerDiv&&loadingSpinnerDiv.remove(),splashScreen.isVisible()&&(this.__view.getElement()[0].style.opacity="0",this.__onSystemSplashScreenHideEvent=TcHmi.EventProvider.register("System.onSplashScreenHide",e=>{this.__onSystemSplashScreenHideEvent&&(this.__onSystemSplashScreenHideEvent(),this.__onSystemSplashScreenHideEvent=null),this.__view&&(this.__view.getElement()[0].style.opacity=""),this.__renderViewParts()}));const viewportContainer=document.createElement("div");viewportContainer.classList.add("tchmi-main-hmi-container"),viewportContainer.style.overflow="auto",viewportContainer.append(this.__view.getElement()[0]),this.addViewportElement(viewportContainer,{name:"mainView",area:"main"})}this.__pending=!1,-1===TCHMI_CONSOLE_LOG_LEVEL&&(benchmarkObj.addContentToDomEnd=benchmarkObj.asyncAttachStart=performance.now(),TcHmi.EventProvider.register("System.onPrevControlsAttached",(evt,_controls)=>{evt.destroy();const baseName=this.__view?.getId()+" loads "+url;benchmarkObj.asyncAttachEnd=performance.now(),window.requestAnimationFrame(()=>{benchmarkObj.screenUpdated=performance.now(),performance.measure(baseName,{start:benchmarkObj.processStart,end:benchmarkObj.screenUpdated,detail:{htmlFetchTime:benchmarkObj.htmlFetchEnd-benchmarkObj.htmlFetchStart,compileTime:benchmarkObj.compileEnd-benchmarkObj.compileStart,addContentToDomTime:benchmarkObj.addContentToDomEnd-benchmarkObj.addContentToDomStart,asyncAttach:benchmarkObj.asyncAttachEnd-benchmarkObj.asyncAttachStart,overallTime:benchmarkObj.screenUpdated-benchmarkObj.processStart,removeContentFromDomTime:benchmarkObj.removeContentFromDomEnd-benchmarkObj.removeContentFromDomStart}})})})),TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})})};-1===TCHMI_CONSOLE_LOG_LEVEL&&(benchmarkObj.htmlFetchStart=performance.now());let partialMarkup=Data.Caches.partialMarkupCache.get(partialUrl),partialMarkupKeepAlive=!1;if(!0===Data.isKeepAlivePartial.get(partialUrl)&&(partialMarkupKeepAlive=!0),partialMarkup)-1===TCHMI_CONSOLE_LOG_LEVEL&&(benchmarkObj.htmlFetchEnd=performance.now()),__proc(partialUrl,partialMarkup.markup,partialMarkupKeepAlive);else{let isPackageView=Data.isPackageView.get(partialUrl)??!1;if(!TCHMI_ENGINEERING||isPackageView){let xhr=new XMLHttpRequest;xhr.open("GET",tchmi_encode_uri_components(partialUrl));let ViewManager_loadView_getMarkup_success=event=>{200===xhr.status?(partialMarkupKeepAlive&&Data.Caches.partialMarkupCache.set(partialUrl,{markup:xhr.responseText}),-1===TCHMI_CONSOLE_LOG_LEVEL&&(benchmarkObj.htmlFetchEnd=performance.now()),__proc(partialUrl,xhr.responseText,partialMarkupKeepAlive)):ViewManager_loadView_getMarkup_error(event)},ViewManager_loadView_getMarkup_error=_event=>{this.__pending=!1,TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Loading "+partialUrl+" failed. Details: HTTP error "+xhr.status+" "+xhr.statusText,domain:"TcHmi.System.ViewManager"}})};xhr.addEventListener("load",ViewManager_loadView_getMarkup_success),xhr.addEventListener("error",ViewManager_loadView_getMarkup_error),xhr.send()}else import("./Engineering/DesignerModePartialContentManager.js").then(module=>{module.partialContentManager.requestCurrentPartialContents([{path:partialUrl}],data=>{const newContent=data?.targetPartials?.at(0);data.error===TcHmi.Errors.NONE&&newContent?.content?(-1===TCHMI_CONSOLE_LOG_LEVEL&&(benchmarkObj.htmlFetchEnd=performance.now()),__proc(partialUrl,newContent.content,partialMarkupKeepAlive)):(this.__pending=!1,TcHmi.Callback.callSafeEx(callback,this,{error:data.error,details:{code:data.error,message:TcHmi.Errors[data.error],reason:"Loading "+partialUrl+" failed.",domain:"TcHmi.System.ViewManager",errors:data.details?[data.details]:void 0}}))})}).catch(ex=>{Log.errorEx("Failed to load partialContentManager in Framework ViewManager:",ex)})}}loadViewObject(view,callback=null){if(this.__pending)"function"==typeof callback&&callback.call(this,{error:TcHmi.Errors.ERROR});else{if(this.__pending=!0,void 0!==this.__view&&null!==this.__view){jqBody.children().detach(),null!==this.__onViewResizedEventDestroyEvent&&(this.__onViewResizedEventDestroyEvent(),this.__onViewResizedEventDestroyEvent=null),null!==this.__onViewDestroyedEventDestroyEvent&&(this.__onViewDestroyedEventDestroyEvent(),this.__onViewDestroyedEventDestroyEvent=null),this.__view.destroy();const viewportContainer=this.__view.getElement()[0].parentElement;viewportContainer&&this.removeViewportElement(viewportContainer),this.__view=null,this.__viewUrl=null}if(this.__view=view,this.__viewUrl=null,this.__onViewResizedEventDestroyEvent=TcHmi.EventProvider.register(this.__view.getId()+".onResized",this.__onViewResized),this.__onViewDestroyedEventDestroyEvent=TcHmi.EventProvider.register(this.__view.getId()+".onDestroyed",this.__onViewDestroyed),jqBody.children().detach(),TCHMI_DESIGNER&&this.#rootControlManager){const backgroundTarget=this.#rootControlManager.getBackgroundTarget(),viewportSim=this.#rootControlManager.getViewPortSimulator();$(viewportSim).empty(),viewportSim.append(this.__view.getElement()[0]),document.body.append(backgroundTarget,viewportSim)}else document.body.appendChild(this.__view.getElement()[0]);this.__pending=!1,TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})}}__registeredViewportElements=[];addViewportElement(element,options){if(TCHMI_DESIGNER||TCHMI_SINGLECONTROL)return{code:TcHmi.Errors.NONE};const oldIndex=this.__registeredViewportElements.findIndex(item=>item.element===element);-1!==oldIndex&&this.__registeredViewportElements.splice(oldIndex,1);const internalName=options.name??tchmi_create_guid();return"header"===options.area?this.__registeredViewportElements.unshift({element,name:internalName,area:options.area}):"footer"!==options.area&&"main"!==options.area||this.__registeredViewportElements.push({element,name:internalName,area:options.area}),element.style.position="relative",element.style.gridArea="main"===options.area?"main":internalName,this.__renderViewParts(),{code:TcHmi.Errors.NONE}}__renderViewParts(){if(!document.body)return;let gridTemplateAreaArr=['"main"'],gridTemplateRowsArr=["auto"];for(const viewPart of this.__registeredViewportElements)if("header"===viewPart.area?(gridTemplateAreaArr.unshift('"'+viewPart.name+'"'),gridTemplateRowsArr.unshift("max-content")):"footer"===viewPart.area&&(gridTemplateAreaArr.push('"'+viewPart.name+'"'),gridTemplateRowsArr.push("max-content")),viewPart.element.parentElement!==document.body&&document.body.appendChild(viewPart.element),"main"!==viewPart.area){viewPart.element.classList.add("tchmi-in-specialviewport");const subcontrolElements=viewPart.element.querySelectorAll("div[data-tchmi-type]");for(const element of subcontrolElements){element.classList.add("tchmi-in-specialviewport");let control=TcHmi.Controls.get(element.id);control&&!control.getParent()&&(control.__processIsEnabled(),control.__processAccessConfig())}}document.body.style.display="grid",document.body.style.gridTemplateAreas=gridTemplateAreaArr.join(" "),document.body.style.gridTemplateRows=gridTemplateRowsArr.join(" "),TcHmi.EventProvider.raise("System.onViewpartsChanged",{structure:!0})}removeViewportElement(element){if(TCHMI_DESIGNER)return{code:TcHmi.Errors.NONE};const index=this.__registeredViewportElements.findIndex(item=>item.element===element);return index<0||(this.__registeredViewportElements.splice(index,1),element.remove(),element.classList.remove("tchmi-in-specialviewport"),this.__renderViewParts()),{code:TcHmi.Errors.NONE}}getViewportElementDimension(area){const viewportElements=this.__registeredViewportElements.filter(entry=>entry.area===area);return 0===viewportElements.length?null:1===viewportElements.length?viewportElements[0].element.getBoundingClientRect():viewportElements.map(item=>item.element.getBoundingClientRect()).reduce((result,current)=>(current.width+current.x>result.width+result.x&&(result.width=current.width+current.x-result.x),current.height+current.y>result.height+result.y&&(result.height=current.height+current.y-result.y),current.x<result.x&&(result.width+=current.x-result.x,result.x=current.x),current.y<result.y&&(result.height+=current.y-result.y,result.y=current.y),result))}}})();export{ViewManager};export const viewManager=new ViewManager;
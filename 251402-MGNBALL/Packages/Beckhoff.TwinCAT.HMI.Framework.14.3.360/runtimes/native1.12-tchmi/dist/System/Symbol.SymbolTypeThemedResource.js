import{themeManager}from"./ThemeManager.js";import{Log}from"../API/Log.js";export class SymbolTypeThemedResource extends TcHmi.Destroyable{constructor(symbol){super(),this.__symbol=symbol,this.__symbolExpressionString=this.__symbol.getExpression().toString(),this.__symbolDiagGUID=this.__symbol.getDiagGUID()}__symbol;__symbolExpressionString;__symbolDiagGUID;__printExpression(expression){let message=this.__symbolExpressionString;return expression?(this.__symbolExpressionString!==expression.toString()&&(message+=` (Resolved to: '${expression.toString()}')`),message):message}destroy(){this.isDestroyed()||(this.__releaseDestroyPrivilege(),this.isDestroyable()&&(this.__symbol=null))}read(expression,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeThemedResource"}});let pathTokens=tchmi_clone_object(expression.getPathTokens()),namespaceTokens=["Application"],name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypeThemedResource"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(name.startsWith("Application;")){let nameTokens=name.split(";"),resourceIdentifier=nameTokens[0];namespaceTokens[0]=resourceIdentifier,name=nameTokens[1]}else if(name.startsWith("Application")){if(!pathTokens||pathTokens&&pathTokens.length<1)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": 'Application' themed symbol expressions localization symbol expressions must be in the form: Application::[Key] (Legacy) or Application;[Key] (New).",domain:"TcHmi.System.SymbolTypeThemedResource"},expression:this.__symbol.getExpression(),expressionResolved:expression});namespaceTokens[0]=name,name=pathTokens.shift()}else if(name.startsWith("Control:")){let nameTokens=name.split(";"),resourceIdentifier=nameTokens[0];name=nameTokens[1];let resourceIdentifierTokens=resourceIdentifier.split(":");namespaceTokens[0]=resourceIdentifierTokens[0],namespaceTokens[1]=resourceIdentifierTokens[1]}else if(name.startsWith("Control")){if(!pathTokens||pathTokens&&pathTokens.length<2)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": 'Control' themed symbol expressions localization symbol expressions must be in the form: Control::[Control-Type]::[Key] (Legacy) or Control:[Control-Type];[Key] (New).",domain:"TcHmi.System.SymbolTypeThemedResource"},expression:this.__symbol.getExpression(),expressionResolved:expression});namespaceTokens[0]=name,namespaceTokens[1]=pathTokens.shift(),name=pathTokens.shift()}else namespaceTokens[0]="Application",name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name and namespace of the symbol.",domain:"TcHmi.System.SymbolTypeThemedResource"},expression:this.__symbol.getExpression(),expressionResolved:expression});let themedResource=themeManager.getThemedResource(name,namespaceTokens);if(void 0!==themedResource){if(!(pathTokens&&pathTokens.length>0)){let value=tchmi_clone_object(themedResource);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression()})}this.__symbol.__helper.readSubValue(expression,themedResource,pathTokens,name,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){let value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression()})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression});else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeThemedResource"}})})}else TcHmi.Callback.callSafe(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:this.__printExpression(expression),domain:"TcHmi.System.SymbolTypeThemedResource"},expression:this.__symbol.getExpression(),expressionResolved:expression})}watch(expression,options,callback,reason){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeThemedResource"}}),()=>{};let destroySubWatch,diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid());let name,destroy=()=>{Log.debug("[Source=Framework, Module=TcHmi.System.Symbol, Expression="+this.__printExpression(expression)+", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch destroy called."),destroySubWatch&&(destroySubWatch(),destroySubWatch=null)},pathTokens=tchmi_clone_object(expression.getPathTokens()),namespaceTokens=["Application"];if(pathTokens&&0!==pathTokens.length){let namespaceToken=expression.getName();if(!namespaceToken)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;if(namespaceTokens[0]=namespaceToken,namespaceTokens[0].startsWith("Application")){if(!pathTokens.length)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": 'Application' themed symbol expressions must be in the form: 'Application::[Key]' or 'Key'.",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;name=pathTokens.shift()}else if(namespaceTokens[0].startsWith("Control")){if(pathTokens.length<2)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": 'Control' themed symbol expressions must be in the form: 'Control::[Control-Type]::[Key]'.",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;namespaceTokens[1]=pathTokens.shift(),name=pathTokens.shift()}else namespaceTokens[0]="Application",name=expression.getName()}else name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name and namespace of the symbol.",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;let last=null;return destroySubWatch=themeManager.watchThemedResource(name,namespaceTokens,data=>{if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeThemedResource"}}),()=>{};if(destroySubWatch||(destroySubWatch=data.destroy),data.error===TcHmi.Errors.NONE){if(pathTokens&&pathTokens.length>0){let doWork=!1,dirtyPaths=data.dirtyPaths,dirtyPathsNew=[];if(dirtyPaths){let pathSanitized=this.__symbol.__helper.resolveSanitizedPath(pathTokens);for(let i=0,ii=dirtyPaths.length;i<ii;i++){let dirtyPath=dirtyPaths[i];dirtyPath.startsWith(pathSanitized)&&(doWork=!0,dirtyPath!==pathSanitized?dirtyPathsNew.push(dirtyPath.replace(pathSanitized,"")):pathSanitized.startsWith(dirtyPath)&&(doWork=!0))}}else doWork=!0;return doWork&&this.__symbol.__helper.readSubValue(expression,data.value,pathTokens,name,data=>{if(this.__symbol)if(data.error===TcHmi.Errors.NONE){let res,value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,res);value=res.value}}res=dirtyPathsNew&&dirtyPathsNew.length>0?{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression(),dirtyPaths:dirtyPathsNew,destroy}:{error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy},Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}else{const res={error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeThemedResource"}})}),destroy}{let res,value=tchmi_clone_object(data.value);if(Array.isArray(value)){let start=expression.getOptions().Start??void 0,end=expression.getOptions().End??void 0;if(void 0!==start||void 0!==end){let res=this.__symbol.__helper.readArraySlice(value,start,end);if(res.error!==TcHmi.Errors.NONE)return TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy;if(value=res.value,tchmi_equal(last,value))return destroy;last=tchmi_clone_object(value)}}return res={error:TcHmi.Errors.NONE,value,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy},Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}}{let res={error:data.error,details:{code:data.error,message:TcHmi.Errors[data.error],reason:this.__printExpression(expression),domain:"TcHmi.System.Symbol",errors:data.details?[data.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}}),destroy}}
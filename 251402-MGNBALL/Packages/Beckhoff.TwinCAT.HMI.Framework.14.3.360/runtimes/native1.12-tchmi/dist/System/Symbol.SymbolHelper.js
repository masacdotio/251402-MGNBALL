import{resolveServerSymbolNameParts}from"./SystemFunctions.js";import{Symbol as SystemSymbol}from"./Symbol.js";import*as Server from"../API/Server.js";import{Log}from"../API/Log.js";import*as TypeHelper from"./Type.Schema.Helper.js";import{controlManager}from"./ControlManager.js";import{templateParamSymbolManager}from"./TemplateParamSymbolManager.js";import{serverManager}from"./ServerManager.js";import{themeManager}from"./ThemeManager.js";import{internalSymbolManager}from"./InternalSymbolManager.js";import{timerSymbolManager}from"./TimerSymbolManager.js";import{typeManager}from"./Type.TypeManager.js";import{packageSymbolManager}from"./PackageSymbolManager.js";import{SymbolTypePackage}from"./Symbol.SymbolTypePackage.js";let userControlParameterManager;TCHMI_ENGINEERING&&import("./Engineering/DesignerModeUserControlParameterManager.js").then(module=>{userControlParameterManager=module.userControlParameterManager}).catch(ex=>{Log.errorEx("Failed to load userControlParameterManager in Framework SymbolHelper:",ex)});let SymbolHelper=(()=>{var _a;let ___onMetaDataChanged_decorators,_classSuper=TcHmi.Destroyable,_instanceExtraInitializers=[];return class extends _classSuper{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;___onMetaDataChanged_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],__esDecorate(this,null,___onMetaDataChanged_decorators,{kind:"method",name:"__onMetaDataChanged",static:!1,private:!1,access:{has:obj=>"__onMetaDataChanged"in obj,get:obj=>obj.__onMetaDataChanged},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(symbol){super(),this.__symbol=symbol,this.__symbol.getExpression().getType()===TcHmi.SymbolType.Server&&(this.__destroyExpressionWatch=this.__symbol.watchExpression(data=>{if(data.error===TcHmi.Errors.NONE&&(this.__destroyOnServerSymbolMetaDataChanged&&(this.__destroyOnServerSymbolMetaDataChanged(),this.__destroyOnServerSymbolMetaDataChanged=null),data.expressionResolved)){let name=data.expressionResolved.getName();if(name){let baseName=resolveServerSymbolNameParts(name).name;this.__destroyOnServerSymbolMetaDataChanged=TcHmi.EventProvider.register("System.onServerSymbolMetaDataChanged<"+baseName+">",this.__onMetaDataChanged)}this.__expressionResolved!==data.expressionResolved&&(this.__expressionResolved=data.expressionResolved,this.__schema=null)}}))}__symbol=__runInitializers(this,_instanceExtraInitializers);__expressionResolved=null;__schema=null;__destroyExpressionWatch=null;__destroyTypeDefinitionChanged=null;__destroyOnServerSymbolMetaDataChanged=null;__destroyResolveSchema=null;__printExpression(expression){let message=this.__symbol.getExpression().toString();return expression?(this.__symbol.getExpression().toString()!==expression.toString()&&(message+=` (Resolved to: '${expression.toString()}')`),message):message}__onMetaDataChanged(_event,data){(!data.entryOld||!data.entryOld.ListSymbols&&data.entryNew.ListSymbols||data.entryOld.ListSymbols&&data.entryNew.ListSymbols&&!tchmi_equal(data.entryOld.ListSymbols.SCHEMA,data.entryNew.ListSymbols.SCHEMA))&&(this.__schema=null)}__createTypeDefinitionChangedHandler(expression){return(_event,data)=>{this.__schema=null;let rootSchema=typeManager.getSchema(data.typeId);rootSchema&&TypeHelper.__resolveSubSchema(rootSchema,expression.getPathTokens(),data=>{data.error===TcHmi.Errors.NONE&&data.schema&&(this.__schema=tchmi_clone_object(data.schema))})}}destroy(){this.isDestroyed()||(this.__releaseDestroyPrivilege(),this.isDestroyable()&&(this.__destroyExpressionWatch?.(),this.__destroyExpressionWatch=null,this.__destroyTypeDefinitionChanged?.(),this.__destroyTypeDefinitionChanged=null,this.__destroyOnServerSymbolMetaDataChanged?.(),this.__destroyOnServerSymbolMetaDataChanged=null,this.__destroyResolveSchema?.(),this.__destroyResolveSchema=null))}readSubValue(expression,obj,pathTokens,pathEntryPoint,callback){if(!obj||"object"!=typeof obj)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": Failed to read value by path because current value is not a valid object. Are all default values and written values valid for this schema?",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression});let p=obj,pathDone="";for(let pToken of pathTokens){let isArrayToken=!1;pToken&&pToken.startsWith("[")&&pToken.endsWith("]")&&(isArrayToken=!0,pToken=pToken.replace("[","").replace("]",""));let isControlInstance=!1,attr=null;if(!pToken)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Failed to read value by path because there is an invalid (missing) token at path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'" in current value.',domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(!(void 0!==p[pToken]||p instanceof TcHmi.Controls.System.baseTcHmiControl))return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Failed to read value by path because the token: "'+pToken+'" does not exist below path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'" in current value.',domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(p instanceof TcHmi.Controls.System.baseTcHmiControl){if(attr=controlManager.getAttributeByPropertyName(p,pToken),!attr?.propertyGetterName||void 0===p[attr.propertyGetterName])return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Failed to read value by path because the controls Getter referenced by token: "'+pToken+'" is not defined or implemented in control named "'+p.getId()+'" with type: '+p.getType()+' below path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'"',domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression});isControlInstance=!0}if(isControlInstance)try{p=tchmi_clone_object(p[attr.propertyGetterName].call(p))}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+': Failed to read path "'+pToken+'"below path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'" in current value because of exception: "'+String(e)+'"',domain:"TcHmi.System.SymbolHelper",exception:e},expression:this.__symbol.getExpression(),expressionResolved:expression})}else p=p[pToken];pathDone+=isArrayToken?"["+pToken+"]":pathDone.length>0?"::"+pToken:pToken}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:p,expressionResolved:expression,expression:this.__symbol.getExpression()})}writeSubValue(expression,obj,value,pathTokens,pathEntryPoint,callback){if(!obj||"object"!=typeof obj)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": Failed to read value by path because current value is not a valid object. Are all default values and written values valid for this schema?",domain:"TcHmi.System.SymbolHelper"}});let p=obj,pTokens=tchmi_clone_object(pathTokens),pathDone="",pToken=pTokens.shift();for(;;){let isArrayToken=!1;pToken&&pToken.startsWith("[")&&pToken.endsWith("]")&&(isArrayToken=!0,pToken=pToken.replace("[","").replace("]",""));let isControlInstance=!1,attr=null;if(!pToken)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Failed to write value by path because the token: "'+pToken+'" does not exist below path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'" in current value.',domain:"TcHmi.System.SymbolHelper"}});if(!(void 0!==p[pToken]||p instanceof TcHmi.Controls.System.baseTcHmiControl))return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Failed to write value by path because the token: "'+pToken+'" does not exist below path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'" in current value.',domain:"TcHmi.System.SymbolHelper"}});if(p instanceof TcHmi.Controls.System.baseTcHmiControl){if(attr=controlManager.getAttributeByPropertyName(p,pToken),!attr?.propertyGetterName||void 0===p[attr.propertyGetterName])return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Failed to write value by path because the token: "'+pToken+'" does not exist below path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'" in current value.',domain:"TcHmi.System.SymbolHelper"}});isControlInstance=!0}if(!(pTokens.length>0))break;if(isControlInstance)try{p=tchmi_clone_object(p[attr.propertyGetterName].call(p))}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+': Failed to write value by path "'+pToken+'"below path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'" in current value because of exception: "'+String(e)+'"',domain:"TcHmi.System.SymbolHelper",exception:e}})}else p=p[pToken];pathDone+=isArrayToken?"["+pToken+"]":pathDone.length>0?"::"+pToken:pToken,pToken=pTokens.shift()}let isControlInstance=!1,attr=null;if(pToken)if(void 0!==p[pToken]||p instanceof TcHmi.Controls.System.baseTcHmiControl){if(p instanceof TcHmi.Controls.System.baseTcHmiControl){if(attr=controlManager.getAttributeByPropertyName(p,pToken),!attr?.propertySetterName||void 0===p[attr.propertySetterName])return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Failed to write value by path because the token: "'+pToken+'" does not exist below path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'" in current value.',domain:"TcHmi.System.SymbolHelper"}});isControlInstance=!0}if(isControlInstance)try{p[attr.propertySetterName].call(p,value)}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+': Failed to write value by path "'+pToken+'"below path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'" in current value because of exception: "'+String(e)+'"',domain:"TcHmi.System.SymbolHelper",exception:e}})}else p[pToken]=value;TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Failed to write value by path because the token: "'+pToken+'" does not exist below path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'" in current value.',domain:"TcHmi.System.SymbolHelper"}});else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Failed to write value by path because the token: "'+pToken+'" does not exist below path: "'+(pathEntryPoint?pathEntryPoint+(pathDone.length>0?"::"+pathDone:""):pathDone)+'" in current value.',domain:"TcHmi.System.SymbolHelper"}})}readArraySlice(array,start,end){let value=null;if(void 0!==start||void 0!==end){if(void 0!==start&&start<0)return{error:TcHmi.Errors.E_OUT_OF_RANGE,details:{code:TcHmi.Errors.E_OUT_OF_RANGE,message:TcHmi.Errors[TcHmi.Errors.E_OUT_OF_RANGE],reason:this.__printExpression()+": Failed to read value. Start can not be smaller than 0.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression()};if(void 0!==end&&end<0)return{error:TcHmi.Errors.E_OUT_OF_RANGE,details:{code:TcHmi.Errors.E_OUT_OF_RANGE,message:TcHmi.Errors[TcHmi.Errors.E_OUT_OF_RANGE],reason:this.__printExpression()+": Failed to read value. End can not be smaller than 0.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression()};if(void 0!==start&&void 0!==end&&end<start)return{error:TcHmi.Errors.E_OUT_OF_RANGE,details:{code:TcHmi.Errors.E_OUT_OF_RANGE,message:TcHmi.Errors[TcHmi.Errors.E_OUT_OF_RANGE],reason:this.__printExpression()+": Failed to read value. End can not be smaller than Start.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression()};if(void 0!==start&&void 0!==end){if(end>array.length-1)return{error:TcHmi.Errors.E_OUT_OF_RANGE,details:{code:TcHmi.Errors.E_OUT_OF_RANGE,message:TcHmi.Errors[TcHmi.Errors.E_OUT_OF_RANGE],reason:this.__printExpression()+": Failed to read value. End can not be bigger than current array length.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression()};value=array.slice(start,end+1)}else void 0!==start&&void 0===end?value=array.slice(start,array.length):void 0===start&&void 0!==end&&(value=array.slice(0,end+1))}return value?{error:TcHmi.Errors.NONE,value,expression:this.__symbol.getExpression()}:{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:this.__printExpression()+": Failed to read value. Array slice could not be read unexpectedly.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression()}}writeArraySlice(array,slice,start,end){if(void 0!==start&&start<0)return{error:TcHmi.Errors.E_OUT_OF_RANGE,details:{code:TcHmi.Errors.E_OUT_OF_RANGE,message:TcHmi.Errors[TcHmi.Errors.E_OUT_OF_RANGE],reason:this.__printExpression()+": Failed to write value. Start can not be smaller than 0.",domain:"TcHmi.System.SymbolHelper"}};if(void 0!==end&&end<0)return{error:TcHmi.Errors.E_OUT_OF_RANGE,details:{code:TcHmi.Errors.E_OUT_OF_RANGE,message:TcHmi.Errors[TcHmi.Errors.E_OUT_OF_RANGE],reason:this.__printExpression()+": Failed to write value. End can not be smaller than 0.",domain:"TcHmi.System.SymbolHelper"}};if(void 0!==start&&void 0!==end&&end<start)return{error:TcHmi.Errors.E_OUT_OF_RANGE,details:{code:TcHmi.Errors.E_OUT_OF_RANGE,message:TcHmi.Errors[TcHmi.Errors.E_OUT_OF_RANGE],reason:this.__printExpression()+": Failed to write value. End can not be smaller than Start.",domain:"TcHmi.System.SymbolHelper"}};if(void 0!==end&&end>array.length-1)return{error:TcHmi.Errors.E_OUT_OF_RANGE,details:{code:TcHmi.Errors.E_OUT_OF_RANGE,message:TcHmi.Errors[TcHmi.Errors.E_OUT_OF_RANGE],reason:this.__printExpression()+": Failed to write value. End can not be bigger than current array length.",domain:"TcHmi.System.SymbolHelper"}};for(let i=0;i<array.length;i++)void 0!==start&&void 0!==end?i>=start&&i<=end&&(array[i]=slice[i-start]):void 0!==start&&void 0===end?i>=start&&(array[i]=slice[i-start]):void 0===start&&void 0!==end&&i<=end&&(array[i]=slice[i]);return{error:TcHmi.Errors.NONE}}resolveSanitizedPath(tokens){let res="";for(let i=0,ii=tokens.length;i<ii;i++){let token=tokens[i];token.startsWith("[")?res+=token:res+="::"+token}return res}resolveSchema(expression,callback){let mappingSymbol,mappingSymbolDestroyResolveSchema,destroyOnControlInitialized=null,isDestroyed=!1,destroy=()=>{isDestroyed||(isDestroyed=!0,this.__destroyResolveSchema=null,destroyOnControlInitialized?.(),destroyOnControlInitialized=null,mappingSymbolDestroyResolveSchema?.(),mappingSymbolDestroyResolveSchema=null,mappingSymbol?.destroy?.())};if(this.__destroyResolveSchema=destroy,this.__expressionResolved!==expression&&(this.__expressionResolved=expression,this.__schema=null),null!==this.__schema)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema:this.__schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy}),destroy;switch(expression.getType()){case TcHmi.SymbolType.Server:{const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;let schema,resolveError,resolveErrorDetails,resolve=()=>{let version=expression.getOptions().Version,options=null;version&&(options={version}),Server.resolveSymbolSchemaEx(name,options,data=>{data.error===TcHmi.Errors.NONE&&data.schema?schema=data.schema:(resolveError=data.error,resolveErrorDetails=data.details)})},finish=()=>schema?(this.__schema=schema,this.__destroyTypeDefinitionChanged&&(this.__destroyTypeDefinitionChanged(),this.__destroyTypeDefinitionChanged=null),this.__schema.id&&(this.__destroyTypeDefinitionChanged=TcHmi.EventProvider.register("System.onTypeDefinitionChanged<"+this.__schema.id+">",this.__createTypeDefinitionChangedHandler(expression))),void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy})):void 0!==resolveError&&resolveError!==TcHmi.Errors.NONE?(this.__destroyTypeDefinitionChanged&&(this.__destroyTypeDefinitionChanged(),this.__destroyTypeDefinitionChanged=null),void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:resolveError,details:resolveErrorDetails,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})):(this.__destroyTypeDefinitionChanged&&(this.__destroyTypeDefinitionChanged(),this.__destroyTypeDefinitionChanged=null),void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SCHEMA_UNKNOWN_DEFINITION,details:{code:TcHmi.Errors.E_SCHEMA_UNKNOWN_DEFINITION,message:TcHmi.Errors[TcHmi.Errors.E_SCHEMA_UNKNOWN_DEFINITION],reason:this.__printExpression(expression)+": Unknown schema definition. Either the symbol or a parent is not mapped or there is no schema defined for the symbol.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}));resolve(),schema?finish():serverManager.resolveServerSymbolMetaData(data=>{resolve(),finish()});break}case TcHmi.SymbolType.Internal:{const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;let pathTokens=expression.getPathTokens();internalSymbolManager.getType(name,data=>{if(data.error===TcHmi.Errors.NONE&&data.type){let rootSchemaType=data.type,rootSchemaResult=typeManager.getSchemaEx(rootSchemaType);if(rootSchemaResult.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,details:{code:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,reason:this.__printExpression(expression)+": Failed to resolve root schema: "+rootSchemaType,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return rootSchemaResult.details&&res.details&&(res.details.errors=[rootSchemaResult.details]),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}let rootSchema=rootSchemaResult.schema;return rootSchema?void TypeHelper.__resolveSubSchema(rootSchema,pathTokens,data=>{if(data.error===TcHmi.Errors.NONE){let schema=tchmi_clone_object(data.schema);return schema?(this.__schema=schema,this.__destroyTypeDefinitionChanged&&(this.__destroyTypeDefinitionChanged(),this.__destroyTypeDefinitionChanged=null),this.__destroyTypeDefinitionChanged=TcHmi.EventProvider.register("System.onTypeDefinitionChanged<"+rootSchemaType+">",this.__createTypeDefinitionChangedHandler(expression)),void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema:this.__schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy})):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:{code:data.error,message:TcHmi.Errors[data.error],reason:this.__printExpression(expression)+": Error resolving type",domain:"TcHmi.System.SymbolHelper",errors:data.details?[data.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})});break}case TcHmi.SymbolType.LocalizedText:{let schemaResult=typeManager.getSchemaEx("tchmi:general#/definitions/String");if(schemaResult.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,details:{code:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,reason:this.__printExpression(expression)+': Failed to resolve schema: "tchmi:general#/definitions/String".',domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression};return schemaResult.details&&res.details&&(res.details.errors=[schemaResult.details]),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}let schema=schemaResult.schema;return schema?(this.__schema=schema,TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema:this.__schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy}),destroy):(TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy)}case TcHmi.SymbolType.Function:{let schemaResult=typeManager.getSchemaEx("tchmi:general#/definitions/Any");if(schemaResult.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,details:{code:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,reason:this.__printExpression(expression)+': Failed to resolve schema: "tchmi:general#/definitions/Any".',domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return schemaResult.details&&res.details&&(res.details.errors=[schemaResult.details]),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}let schema=schemaResult.schema;return schema?(this.__schema=schema,TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema:this.__schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy}),destroy):(TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy)}case TcHmi.SymbolType.Control:{const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;let pathTokens=expression.getPathTokens();if(!(pathTokens&&pathTokens.length>0)){let schemaResult=typeManager.getSchemaEx("tchmi:framework#/definitions/Control");if(schemaResult.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,details:{code:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,reason:this.__printExpression(expression)+': Failed to resolve schema: "tchmi:framework#/definitions/Control".',domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return schemaResult.details&&res.details&&(res.details.errors=[schemaResult.details]),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}let schema=schemaResult.schema;if(!schema){let res={error:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,details:{code:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,reason:this.__printExpression(expression)+': Failed to resolve schema: "tchmi:framework#/definitions/Control".',domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}return this.__schema=schema,TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema:this.__schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy}),destroy}{let waitForControl=expression.getOptions().WaitForControl??!0,waitForControlTimeout=expression.getOptions().Timeout??1e3,timeoutId=0,control=TcHmi.Controls.get(name),proc=()=>{if(!control)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control instance with id: "+name,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy});let propertyName=null,pathTokensPrepared=tchmi_clone_object(pathTokens);propertyName=pathTokensPrepared.shift();const attr=controlManager.getAttributeByPropertyName(control,propertyName);if(attr){let rootSchemaResult=typeManager.getSchemaEx(attr.type);if(rootSchemaResult.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,details:{code:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,reason:this.__printExpression(expression)+": Failed to resolve root schema: "+attr.type,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return rootSchemaResult.details&&res.details&&(res.details.errors=[rootSchemaResult.details]),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}let rootSchema=rootSchemaResult.schema;return rootSchema?void TypeHelper.__resolveSubSchema(rootSchema,pathTokensPrepared,data=>{if(data.error===TcHmi.Errors.NONE){let schema=tchmi_clone_object(data.schema);return schema?(this.__schema=schema,this.__destroyTypeDefinitionChanged&&(this.__destroyTypeDefinitionChanged(),this.__destroyTypeDefinitionChanged=null),this.__destroyTypeDefinitionChanged=TcHmi.EventProvider.register("System.onTypeDefinitionChanged<"+attr.type+">",this.__createTypeDefinitionChangedHandler(expression)),void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema:this.__schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy})):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Resolving subschema failed",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND],reason:this.__printExpression(expression)+": Resolving schema for expression failed. Control attribute was not found.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})};control||!waitForControl?proc():!control&&waitForControl&&(destroyOnControlInitialized=TcHmi.EventProvider.register(name+".onInitialized",(e,data)=>{timeoutId>0&&(clearTimeout(timeoutId),timeoutId=0),control=data,e.destroy(),destroyOnControlInitialized=null,proc()}),timeoutId=setTimeout(()=>{timeoutId=0,proc()},waitForControlTimeout))}break}case TcHmi.SymbolType.PartialParam:{const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;let propertyName,designerParam,pathTokens=tchmi_clone_object(expression.getPathTokens()),searchAttr=null;if(!pathTokens)return"TCHMI_TARGET_DESIGNER_PARTIALPARAM"!==name?TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+" is not a valid PartialParameter. Expected: UserControlHost::Parameter",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}):TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:this.__printExpression(expression)+" is not a valid PartialParameter. Expected: TCHMI_TARGET_DESIGNER_PARTIALPARAM::Parameter",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;if(propertyName=pathTokens.shift(),"TCHMI_TARGET_DESIGNER_PARTIALPARAM"!==name){let control=TcHmi.Controls.get(name);if(!control)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INSTANCE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find control instance with id: "+name,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;searchAttr=controlManager.getAttributeByPropertyName(control,propertyName)}else{if(designerParam=propertyName?userControlParameterManager?.get(propertyName):void 0,!designerParam)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:this.__printExpression(expression)+": Unknown template parameter "+propertyName,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;searchAttr=designerParam.descr}if(!searchAttr)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,details:{code:TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_ATTRIBUTE_NOT_FOUND],reason:this.__printExpression(expression)+": Can not find property: "+propertyName+".",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;const attr=searchAttr;let rootSchemaResult=typeManager.getSchemaEx(attr.type);if(rootSchemaResult.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,details:{code:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,reason:this.__printExpression(expression)+": Failed to resolve root schema: "+attr.type,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return rootSchemaResult.details&&res.details&&(res.details.errors=[rootSchemaResult.details]),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}let rootSchema=rootSchemaResult.schema;return rootSchema?(TypeHelper.__resolveSubSchema(rootSchema,pathTokens,data=>{if(data.error===TcHmi.Errors.NONE){let schema=tchmi_clone_object(data.schema);return schema?(this.__schema=schema,this.__destroyTypeDefinitionChanged&&(this.__destroyTypeDefinitionChanged(),this.__destroyTypeDefinitionChanged=null),this.__destroyTypeDefinitionChanged=TcHmi.EventProvider.register("System.onTypeDefinitionChanged<"+attr.type+">",this.__createTypeDefinitionChangedHandler(expression)),void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema:this.__schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy})):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}),destroy):(TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy)}case TcHmi.SymbolType.TemplateParam:{const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;const pathTokens=expression.getPathTokens(),entry=templateParamSymbolManager.get(name);if(!entry||!entry.type)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:this.__printExpression(expression)+": Unknown template parameter "+name,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;let rootSchemaResult=typeManager.getSchemaEx(entry.type);if(rootSchemaResult.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,details:{code:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,reason:this.__printExpression(expression)+": Failed to resolve root schema: "+entry.type,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return rootSchemaResult.details&&res.details&&(res.details.errors=[rootSchemaResult.details]),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}let rootSchema=rootSchemaResult.schema;return rootSchema?(TypeHelper.__resolveSubSchema(rootSchema,pathTokens,data=>{if(data.error===TcHmi.Errors.NONE){let schema=tchmi_clone_object(data.schema);return schema?(this.__schema=schema,this.__destroyTypeDefinitionChanged&&(this.__destroyTypeDefinitionChanged(),this.__destroyTypeDefinitionChanged=null),this.__destroyTypeDefinitionChanged=TcHmi.EventProvider.register("System.onTypeDefinitionChanged<"+entry.type+">",this.__createTypeDefinitionChangedHandler(expression)),void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema:this.__schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy})):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}),destroy):(TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression()+": Unknown symbol type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy)}case TcHmi.SymbolType.Context:{let schemaResult=typeManager.getSchemaEx("tchmi:general#/definitions/Any");if(schemaResult.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,details:{code:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,reason:this.__printExpression(expression)+': Failed to resolve schema: "tchmi:general#/definitions/Any".',domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return schemaResult.details&&res.details&&(res.details.errors=[schemaResult.details]),TcHmi.Callback.callSafeEx(callback,this.__symbol,res),destroy}let schema=schemaResult.schema;return schema?(this.__schema=schema,TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema:this.__schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy}),destroy):(TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy)}case TcHmi.SymbolType.ThemedResource:{let name,pathTokens=tchmi_clone_object(expression.getPathTokens()),namespaceTokens=["Application"];if(pathTokens&&0!==pathTokens.length){let namespaceToken=expression.getName();if(!namespaceToken)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;if(namespaceTokens[0]=namespaceToken,namespaceTokens[0].startsWith("Application")){if(!pathTokens.length)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": 'Application' themed symbol expressions must be in the form: 'Application::[Key]' (Legacy), 'Application;[Key] (New)' or 'Key'.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;name=pathTokens.shift()}else{if(!namespaceTokens[0].startsWith("Control"))return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": Path tokens are allowed only if the themed resource symbol expression starts with the following token: 'Control'.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;if(pathTokens.length<2)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+": 'Control' themed symbol expressions must be in the form: 'Control::[Control-Type]::[Key]' (Legacy) or 'Control:[Control-Type];[Key]' (New).",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;namespaceTokens[1]=pathTokens.shift(),name=pathTokens.shift()}}else name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name and namespace of the symbol.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;themeManager.getThemedResourceType(name,namespaceTokens,data=>{if(data.error===TcHmi.Errors.NONE&&data.type){let rootSchemaType=data.type,rootSchemaResult=typeManager.getSchemaEx(rootSchemaType);if(rootSchemaResult.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,details:{code:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,reason:this.__printExpression(expression)+": Failed to resolve root schema: '"+rootSchemaType+"'.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return rootSchemaResult.details&&res.details&&(res.details.errors=[rootSchemaResult.details]),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}let rootSchema=rootSchemaResult.schema;return rootSchema?void TypeHelper.__resolveSubSchema(rootSchema,pathTokens,data=>{if(data.error===TcHmi.Errors.NONE){let schema=tchmi_clone_object(data.schema);return schema?(this.__schema=schema,this.__destroyTypeDefinitionChanged&&(this.__destroyTypeDefinitionChanged(),this.__destroyTypeDefinitionChanged=null),this.__destroyTypeDefinitionChanged=TcHmi.EventProvider.register("System.onTypeDefinitionChanged<"+rootSchemaType+">",this.__createTypeDefinitionChangedHandler(expression)),void TcHmi.Callback.callSafe(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema:this.__schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy})):void TcHmi.Callback.callSafe(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__symbol.getExpression().toString(),domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}TcHmi.Callback.callSafe(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:{code:data.error,message:TcHmi.Errors[data.error],reason:this.__printExpression(expression)+": Error resolving type",domain:"TcHmi.System.SymbolHelper",errors:data.details?[data.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})});break}case TcHmi.SymbolType.Timer:{const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;let pathTokens=expression.getPathTokens();timerSymbolManager.getType(name,data=>{if(data.error===TcHmi.Errors.NONE&&data.type){let rootSchemaType=data.type,rootSchemaResult=typeManager.getSchemaEx(rootSchemaType);if(rootSchemaResult.error!==TcHmi.Errors.NONE){let res={error:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,details:{code:TcHmi.Errors.E_SCHEMA_NOT_RESOLVED,reason:this.__printExpression(expression)+": Failed to resolve root schema: "+rootSchemaType,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};return rootSchemaResult.details&&res.details&&(res.details.errors=[rootSchemaResult.details]),void TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}let rootSchema=rootSchemaResult.schema;return rootSchema?void TypeHelper.__resolveSubSchema(rootSchema,pathTokens,data=>{if(data.error===TcHmi.Errors.NONE){let schema=tchmi_clone_object(data.schema);return schema?(this.__schema=schema,this.__destroyTypeDefinitionChanged&&(this.__destroyTypeDefinitionChanged(),this.__destroyTypeDefinitionChanged=null),this.__destroyTypeDefinitionChanged=TcHmi.EventProvider.register("System.onTypeDefinitionChanged<"+rootSchemaType+">",this.__createTypeDefinitionChangedHandler(expression)),void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,schema:this.__schema,expressionResolved:expression,expression:this.__symbol.getExpression(),destroy})):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:data.details,expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}):void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_UNKNOWN_TYPE,details:{code:TcHmi.Errors.E_UNKNOWN_TYPE,message:TcHmi.Errors[TcHmi.Errors.E_UNKNOWN_TYPE],reason:this.__printExpression(expression)+": Unknown type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})}TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:data.error,details:{code:data.error,message:TcHmi.Errors[data.error],reason:this.__printExpression(expression)+": Error resolving type",domain:"TcHmi.System.SymbolHelper",errors:data.details?[data.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy})});break}case TcHmi.SymbolType.Package:{const name=expression.getName();if(!name)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;const mapping=packageSymbolManager.get(name);if(!mapping)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": No mapping was found.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;if(!mapping.symbol)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Mapping symobl is not defined.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;if(!TcHmi.Symbol.isSymbolExpression(mapping.symbol))return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Mapping symobl is not a valid symbol expression.",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;try{let mappingSymbolExpression=new TcHmi.SymbolExpression(mapping.symbol),mappingSymbolExpressionPrepared=SymbolTypePackage.ResolveMappingSymbolExpression(expression,mappingSymbolExpression);mappingSymbol=new SystemSymbol(mappingSymbolExpressionPrepared),mappingSymbolDestroyResolveSchema=mappingSymbol.resolveSchema(data=>{mappingSymbol?.destroy(),TcHmi.Callback.callSafeEx(callback,this.__symbol,{...data,destroy:()=>{data.destroy?.(),mappingSymbolDestroyResolveSchema=null,destroy()}})})}catch(e){return mappingSymbol?.destroy(),TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+": An exception occured while trying to parse the mapping symbol '"+mapping.symbol+"'.",exception:e,domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy}break}default:return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_NOT_SUPPORTED,details:{code:TcHmi.Errors.E_NOT_SUPPORTED,message:TcHmi.Errors[TcHmi.Errors.E_NOT_SUPPORTED],reason:this.__printExpression(expression)+": Unknown symbol type",domain:"TcHmi.System.SymbolHelper"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy}return destroy}getSchema(){return this.__schema}}})();export{SymbolHelper};
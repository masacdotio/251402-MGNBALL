import{dialogManager}from"./DialogManager.js";import{frameworkLocalization}from"./Locale.js";import{config,isInitialized,isUnloaded,serverSidePathAndQuery}from"./System.js";import*as Server from"../API/Server.js";import*as DialogManager from"../API/DialogManager.js";import{Log}from"../API/Log.js";import{viewManager}from"./ViewManager.js";import{localizationManager}from"./LocalizationManager.js";import{__rebuildLocalizationCache}from"../API/Localization.js";import{autoLogoffToMilliseconds}from"./SystemFunctions.js";import{controlManager}from"./ControlManager.js";let AccessManager=(()=>{var _a,_b,_c,_d,_e;let ___onServerNotReady_decorators,___onServerReady_decorators,___clearControlAccessCache_decorators,___updateLastUserinteraction_decorators,___logoutIfNoInteraction_decorators,_instanceExtraInitializers=[];return class{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___onServerNotReady_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___onServerReady_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___clearControlAccessCache_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],___updateLastUserinteraction_decorators=[(_d=TcHmi).CallbackMethod.bind(_d)],___logoutIfNoInteraction_decorators=[(_e=TcHmi).CallbackMethod.bind(_e)],__esDecorate(this,null,___onServerNotReady_decorators,{kind:"method",name:"__onServerNotReady",static:!1,private:!1,access:{has:obj=>"__onServerNotReady"in obj,get:obj=>obj.__onServerNotReady},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onServerReady_decorators,{kind:"method",name:"__onServerReady",static:!1,private:!1,access:{has:obj=>"__onServerReady"in obj,get:obj=>obj.__onServerReady},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___clearControlAccessCache_decorators,{kind:"method",name:"__clearControlAccessCache",static:!1,private:!1,access:{has:obj=>"__clearControlAccessCache"in obj,get:obj=>obj.__clearControlAccessCache},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___updateLastUserinteraction_decorators,{kind:"method",name:"__updateLastUserinteraction",static:!1,private:!1,access:{has:obj=>"__updateLastUserinteraction"in obj,get:obj=>obj.__updateLastUserinteraction},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___logoutIfNoInteraction_decorators,{kind:"method",name:"__logoutIfNoInteraction",static:!1,private:!1,access:{has:obj=>"__logoutIfNoInteraction"in obj,get:obj=>obj.__logoutIfNoInteraction},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){this.__userConfigOnServer={state:0,userIsInGroups:[],name:null,domain:null,locale:void 0,configLocale:"client",timeFormatLocale:void 0,configTimeFormatLocale:"client",timeZone:void 0,configTimeZone:void 0,timeZoneOffset:0,autoLogOffMilliSeconds:null,session:null,clientCertificate:null,clientIp:"",errorMessage:"",defaultAuthExtension:"TcHmiUserManagement",defaultUserGroup:"__SystemUsers"},TcHmi.EventProvider.register("onServerReady",this.__onServerReady),TcHmi.EventProvider.register("onServerNotReady",this.__onServerNotReady),TcHmi.EventProvider.register("System.AccessConfigChanged",this.__clearControlAccessCache),TcHmi.EventProvider.register("System.ParentChanged",this.__clearControlAccessCache)}setControlRightOverride(control,accessrightToOverride,forcedRight){let controlForcedRights=this.__overrideRightStorage.get(control);controlForcedRights||(controlForcedRights=new Set,this.__overrideRightStorage.set(control,controlForcedRights)),null===forcedRight?(controlForcedRights.delete(accessrightToOverride),controlForcedRights.size||this.__overrideRightStorage.delete(control)):"Deny"===forcedRight&&controlForcedRights.add(accessrightToOverride),this.__accessCache=new WeakMap,control.__processAccessConfig()}getControlRightOverrides(control){return this.__overrideRightStorage.get(control)??new Set}__overrideRightStorage=(__runInitializers(this,_instanceExtraInitializers),new WeakMap);__isReady=!1;__lastUserInteraction=Date.now();__lastUserInteractionSentToServer=this.__lastUserInteraction;__autoLogoffTimeoutID=0;__userConfigOnServer;__oldName=null;__subscriptionId=null;__reload=!0;__accessCache=new WeakMap;__onServerNotReady(_event){this.unsubscribe(),this.__oldName=this.__userConfigOnServer.name,this.__userConfigOnServer={state:1,userIsInGroups:[],name:null,domain:null,locale:void 0,configLocale:"client",timeFormatLocale:void 0,configTimeFormatLocale:"client",timeZone:void 0,configTimeZone:void 0,timeZoneOffset:0,autoLogOffMilliSeconds:null,session:null,clientCertificate:null,clientIp:"",errorMessage:"",defaultAuthExtension:"TcHmiUserManagement",defaultUserGroup:"__SystemUsers"}}__onServerReady(_event){Server.readSymbol(["DefaultAuthExtension","DefaultUserGroup"],Server.handleResponse({completed:data=>{if(data.error!==TcHmi.Errors.NONE){const details=data.details;Log.errorEx("[Source=Framework, Module=TcHmi.System.AccessManager] Internal Error. Failed to load DefaultAuthExtension and DefaultUserGroup. Using default TcHmiUserManagement and __SystemUsers: "+Log.buildMessage(details))}else if(data.results)for(const res of data.results)"DefaultAuthExtension"===res.symbol&&res.value&&res.value!==this.__userConfigOnServer.defaultAuthExtension?this.__userConfigOnServer.defaultAuthExtension=res.value:"DefaultUserGroup"===res.symbol&&res.value&&res.value!==this.__userConfigOnServer.defaultUserGroup&&(this.__userConfigOnServer.defaultUserGroup=res.value);this.subscribe()}}))}getCurrentUserConfig(){return this.__userConfigOnServer}enableReload(value){this.__reload=value}isReady(){return this.__isReady}unsubscribe(callback){if(null!==this.__subscriptionId){const oldId=this.__subscriptionId;this.__subscriptionId=null,Server.unsubscribe(oldId,data=>{TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})})}else TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})}subscribe(callback){if(null===this.__subscriptionId){let callbackOnce=callback;this.__subscriptionId=Server.subscribeEx([{symbol:"IsAuthRequired"},{symbol:"GetCurrentUser"}],1e3,{timeout:config.tcHmiServer.websocketSystemTimeout},data=>{this.__handleServerResponse(data),isInitialized||Log.performanceLog("[Source=Framework, Module=TcHmi.INIT] INIT_STATE.LOCALIZATION_LOADING"),data.error===TcHmi.Errors.NONE?localizationManager.processLocale(this.__userConfigOnServer.locale,{level:TcHmi.Locale.Level.Application},data=>{let raiseReadyEvent=!this.__isReady;this.__isReady=!0,TcHmi.Callback.callSafeEx(callbackOnce,this,{error:TcHmi.Errors.NONE}),callbackOnce=void 0,raiseReadyEvent&&TcHmi.EventProvider.raise("System.onAccessManagerReady")}):TcHmi.Callback.callSafeEx(callback,this,{error:data.error,details:data.details})})}else TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE})}__handleServerResponse(data){let userDataChanged=!1,userChanged=!1,userInGroupChanged=!1,websocketClosed=!1;const userConfigOnServer=this.__userConfigOnServer;if(data.error===TcHmi.Errors.E_WEBSOCKET_CLOSED)userConfigOnServer.state=1,userConfigOnServer.errorMessage="Websocket was closed.",websocketClosed=!0,userChanged=!0,userDataChanged=!0,userInGroupChanged=!0;else if(data.error===TcHmi.Errors.E_WEBSOCKET_NOT_READY)userConfigOnServer.state=1,userConfigOnServer.errorMessage="Communication not ready.",userChanged=!0,userDataChanged=!0,userInGroupChanged=!0;else{if(data.response?.error?.code===Server.Error.HMI_E_PASSWORD_CHANGE_REQUIRED)return void window.location.reload();if(data.error===TcHmi.Errors.NONE&&data.response&&void 0!==data.response.error)userConfigOnServer.state=1,userConfigOnServer.errorMessage="Unknown Server error: "+data.response.error.message,userChanged=!0,userDataChanged=!0,userInGroupChanged=!0,data.response.error.code===Server.Error.HMI_E_MISSING_LICENSE_HANDSHAKE&&(TCHMI_ENGINEERING?userConfigOnServer.errorMessage="Server is not licensed. Please try in a few seconds again.":userConfigOnServer.errorMessage="Server is not licensed.");else if(data.error===TcHmi.Errors.NONE&&data.response){let hasReturnedFromError=!1;1===userConfigOnServer.state&&(hasReturnedFromError=!0),0===userConfigOnServer.state&&(userConfigOnServer.state=1),userConfigOnServer.errorMessage="Got no valid answer.";let responseCommands=data.response.commands;void 0===responseCommands&&(responseCommands=[]);for(let i=0,ii=responseCommands.length;i<ii;i++){const commandGeneric=responseCommands[i];if("GetCurrentUser"===commandGeneric.symbol){__rebuildLocalizationCache();let command=commandGeneric;if(void 0!==command.error){userConfigOnServer.errorMessage="Got no valid answer for "+command.symbol+". Error code: "+command.error.code,userChanged=!0,userDataChanged=!0,userInGroupChanged=!0;break}if(void 0===command.readValue){userConfigOnServer.errorMessage="Got no valid answer for "+command.symbol+".",userChanged=!0,userDataChanged=!0,userInGroupChanged=!0;break}if(userConfigOnServer.errorMessage="",void 0!==command.readValue.name&&null!==command.readValue.name&&userConfigOnServer.name!==command.readValue.name){if(4===userConfigOnServer.state&&void 0!==userConfigOnServer.name&&null!==userConfigOnServer.name&&"__SystemGuest"===command.readValue.name&&this.__reload)return void window.location.reload();if(this.__reload||(this.__reload=!0),"ReadWrite"===data.response.requestType&&null!==this.__oldName&&this.__oldName!==command.readValue.name)return userConfigOnServer.state=1,dialogManager.showDialog(null,!1),dialogManager.updateTextEx("__AccessManager",frameworkLocalization.getText("Connection_Recovered_Auth_Invalid",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+' <input type="submit" value="'+frameworkLocalization.getText("Reload",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+'" style="padding:10px;" onclick="window.location = \'/Logout?Location='+serverSidePathAndQuery+"&Name="+encodeURIComponent(accessManager.__oldName||"")+"'\">",{severity:DialogManager.DialogSeverity.Error,buttonReload:!1}),void dialogManager.showDialog("__AccessManager",!0,DialogManager.DialogType.Overlay);userChanged=!0,userDataChanged=!0,userConfigOnServer.name=command.readValue.name}if(command.readValue.autoLogoff){let newTime=autoLogoffToMilliseconds(command.readValue.autoLogoff);userConfigOnServer.autoLogOffMilliSeconds!==newTime&&(userConfigOnServer.autoLogOffMilliSeconds=newTime,userDataChanged=!0,accessManager.__rearmAutoLogoffTimer())}(hasReturnedFromError||void 0!==command.readValue.groups&&!tchmi_equal(userConfigOnServer.userIsInGroups.sort(),command.readValue.groups.sort()))&&(userDataChanged=!0,userInGroupChanged=!0,userConfigOnServer.userIsInGroups=command.readValue.groups??[]),void 0!==command.readValue.domain&&userConfigOnServer.domain!==command.readValue.domain&&(userDataChanged=!0,userConfigOnServer.domain=command.readValue.domain),void 0!==command.readValue.session&&userConfigOnServer.session!==command.readValue.session&&(userDataChanged=!0,userConfigOnServer.session=command.readValue.session),void 0!==command.readValue.clientCertificate&&userConfigOnServer.clientCertificate!==command.readValue.clientCertificate&&(userDataChanged=!0,userConfigOnServer.clientCertificate=command.readValue.clientCertificate),void 0!==command.readValue.clientIp&&userConfigOnServer.clientIp!==command.readValue.clientIp&&(userDataChanged=!0,userConfigOnServer.clientIp=command.readValue.clientIp);let serverLocale=command.readValue.locale;serverLocale&&"client"!==serverLocale||(serverLocale=void 0),userConfigOnServer.locale!==serverLocale&&(userDataChanged=!0,userConfigOnServer.locale=serverLocale),userConfigOnServer.configLocale!==command.readValue.configLocale&&(userDataChanged=!0,userConfigOnServer.configLocale=command.readValue.configLocale);let serverTimeFormatLocale=command.readValue.timeFormatLocale;serverTimeFormatLocale&&"client"!==serverTimeFormatLocale||(serverTimeFormatLocale=void 0),userConfigOnServer.timeFormatLocale!==serverTimeFormatLocale&&(userDataChanged=!0,userConfigOnServer.timeFormatLocale=serverTimeFormatLocale),userConfigOnServer.configTimeFormatLocale!==command.readValue.configTimeFormatLocale&&(userDataChanged=!0,userConfigOnServer.configTimeFormatLocale=command.readValue.configTimeFormatLocale);let serverTimezone=command.readValue.timeZone;serverTimezone&&"client"!==serverTimezone||(serverTimezone=void 0),userConfigOnServer.timeZone!==serverTimezone&&(userDataChanged=!0,userConfigOnServer.timeZone=serverTimezone);const date=new Date,datePartsInTimezone=TcHmi.Localization.parseDate(date,{timeZone:serverTimezone}),newOffset=Date.UTC(datePartsInTimezone.year,datePartsInTimezone.month-1,datePartsInTimezone.day,datePartsInTimezone.hour,datePartsInTimezone.minute,datePartsInTimezone.second,datePartsInTimezone.millisecond)-date.valueOf();userConfigOnServer.timeZoneOffset=newOffset,userConfigOnServer.configTimeZone!==command.readValue.configTimeZone&&(userDataChanged=!0,userConfigOnServer.configTimeZone=command.readValue.configTimeZone)}else if("IsAuthRequired"===commandGeneric.symbol){let command=commandGeneric;if(void 0!==command.error){userConfigOnServer.errorMessage="Got no valid answer for "+command.symbol+". Error code: "+command.error.code;break}if(!0===command.readValue)4!==userConfigOnServer.state&&(userConfigOnServer.state=4,userConfigOnServer.errorMessage="",userDataChanged=!0);else{if(!1!==command.readValue){userConfigOnServer.state=1,userConfigOnServer.errorMessage="Got no valid answer for "+command.symbol+".",userDataChanged=!0;break}2!==userConfigOnServer.state&&(userConfigOnServer.state=2,userConfigOnServer.errorMessage="",userDataChanged=!0)}}}4===userConfigOnServer.state&&(userConfigOnServer.name?0===userConfigOnServer.userIsInGroups.length&&(userDataChanged=!0,userConfigOnServer.state=1,userConfigOnServer.errorMessage="Got no group membership but should have one."):(userDataChanged=!0,userConfigOnServer.state=1,userConfigOnServer.errorMessage="Got no user login but should have one."))}}userDataChanged&&!isUnloaded&&this.__handleConfigChanged({user:userChanged,group:userInGroupChanged},websocketClosed)}__clearControlAccessCache(_event,_data){this.__accessCache=new WeakMap}__handleConfigChanged(changed,websocketClosed){if(this.__accessCache=new WeakMap,1===this.__userConfigOnServer.state){const oldDialogOwner=dialogManager.getDialogOwner();"__TcHmiMain"!==oldDialogOwner&&"__TcHmiViewAccess"!==oldDialogOwner||dialogManager.showDialog(oldDialogOwner,!1),!0!==websocketClosed&&(dialogManager.updateTextEx("__AccessManager",frameworkLocalization.getText("Loading_User_Config_Failed",{level:TcHmi.Locale.Level.Engineering})+(this.__userConfigOnServer.errorMessage?": "+this.__userConfigOnServer.errorMessage:".")+' <input type="submit" value="'+frameworkLocalization.getText("Reload",{level:TcHmi.Locale.Level.Engineering,preventHtml:!0})+'" style="padding:10px;" onclick="window.location = \'/Logout?Location='+serverSidePathAndQuery+"'\">",{severity:DialogManager.DialogSeverity.Error,buttonReload:!1}),dialogManager.showDialog("__AccessManager",!0,DialogManager.DialogType.Overlay)),Log.error("[Source=Framework, Module=TcHmi.System.AccessManager] Internal Error. Loading User Login Config from Server failed"+(this.__userConfigOnServer.errorMessage?": "+this.__userConfigOnServer.errorMessage:"."))}if(changed.group){2!==this.__userConfigOnServer.state&&4!==this.__userConfigOnServer.state||TcHmi.EventProvider.raise("onUserInGroupChanged",tchmi_clone_object(this.__userConfigOnServer.userIsInGroups));const currentView=viewManager.getView();null!==currentView&&currentView.__processAccessConfig()}changed.user&&TcHmi.EventProvider.raise("onUserChanged",this.__userConfigOnServer.name),TcHmi.EventProvider.raise("onUserDataChanged",tchmi_clone_object(this.__userConfigOnServer))}checkAccess(control,requestedAccessright){if(TCHMI_DESIGNER||TCHMI_SINGLECONTROL)return!0;if(2===this.__userConfigOnServer.state)return!0;if(this.__userConfigOnServer.userIsInGroups.includes("__SystemAdministrators"))return!0;if(1===this.__userConfigOnServer.state)return!1;if(0===this.__userConfigOnServer.state)return null;let accessCacheControlEntry=this.__accessCache.get(control);if(accessCacheControlEntry){const accessCacheAccessrightEntry=accessCacheControlEntry.get(requestedAccessright);if(void 0!==accessCacheAccessrightEntry)return accessCacheAccessrightEntry}else accessCacheControlEntry=new Map,this.__accessCache.set(control,accessCacheControlEntry);if(this.getControlRightOverrides(control).has(requestedAccessright))return accessCacheControlEntry.set(requestedAccessright,!1),!1;let defaultValueInternal=null,mappedAccessRight=requestedAccessright,recursiveControl=control;do{let foundDeny=!1;const recursiveControlType=recursiveControl.getType();let recursiveAccessDefinition=controlManager.getDescriptionAccessByName(recursiveControlType,mappedAccessRight);if(recursiveAccessDefinition?.dependsOn?.length)for(const dependingRight of recursiveAccessDefinition.dependsOn)if(dependingRight&&"string"==typeof dependingRight){const dependingResult=this.checkAccess(recursiveControl,dependingRight);if(!1===dependingResult)return accessCacheControlEntry.set(requestedAccessright,!1),!1;if(null===dependingResult)return dependingResult}const recursiveCtrlAccessConfig=recursiveControl.getAccessConfig();for(const AccessRightsEntry of recursiveCtrlAccessConfig)if(AccessRightsEntry.accessright===mappedAccessRight&&this.__userConfigOnServer.userIsInGroups.includes(AccessRightsEntry.group)){if("Allow"===AccessRightsEntry.permission)return accessCacheControlEntry.set(requestedAccessright,!0),!0;if("Deny"===AccessRightsEntry.permission)foundDeny=!0;else if("Inherit"!==AccessRightsEntry.permission)return Log.error("[Source=Framework, Module=TcHmi.System.AccessManager] Access check failed on control "+control.getId()+": Invalid config found! Access rejected!"),!1}if(foundDeny)return accessCacheControlEntry.set(requestedAccessright,!1),!1;null===recursiveAccessDefinition&&"function"==typeof recursiveControl.getDescriptionAccessByName&&(recursiveAccessDefinition=recursiveControl.getDescriptionAccessByName(mappedAccessRight)),"boolean"==typeof recursiveAccessDefinition?.defaultValueInternal&&(defaultValueInternal=recursiveAccessDefinition.defaultValueInternal);const parentCtrl=recursiveControl.getParent();if(!parentCtrl){if("TcHmi.Controls.System.TcHmiView"===recursiveControlType){recursiveControl=null;break}if(recursiveControl.getElement()?.[0].classList.contains("tchmi-in-topmostlayer")||recursiveControl.getElement()?.[0].classList.contains("tchmi-in-specialviewport")){if(recursiveControl=null,null===defaultValueInternal){const viewAccessDefinition=controlManager.getDescriptionAccessByName("TcHmi.Controls.System.TcHmiView",mappedAccessRight);"boolean"==typeof viewAccessDefinition?.defaultValueInternal&&(defaultValueInternal=viewAccessDefinition.defaultValueInternal)}break}return null}{let virtualControlRightMapping=recursiveControl.getVirtualControlRightMappings();if(!Array.isArray(virtualControlRightMapping)||!Array.isArray(recursiveCtrlAccessConfig))return!1;for(let virtualControlRightMap of virtualControlRightMapping)if(virtualControlRightMap.controlRight===mappedAccessRight){mappedAccessRight=virtualControlRightMap.virtualControlRight;break}recursiveControl=parentCtrl}}while(null!==recursiveControl);return accessCacheControlEntry.set(requestedAccessright,defaultValueInternal),defaultValueInternal}__updateLastUserinteraction(_event){this.__sendHeartbeat(),this.__lastUserInteraction=Date.now()}__sendHeartbeat(force){const dateNow=Date.now();(this.__userConfigOnServer.autoLogOffMilliSeconds&&dateNow-this.__lastUserInteractionSentToServer>this.__userConfigOnServer.autoLogOffMilliSeconds/2||force)&&(this.__lastUserInteractionSentToServer=dateNow,Server.requestEx({requestType:"ReadWrite",commands:[{commandOptions:["SendErrorMessage"],symbol:"Heartbeat"}]},{timeout:config.tcHmiServer.websocketSystemTimeout}))}__rearmAutoLogoffTimer(){if(4!==this.__userConfigOnServer.state||null===this.__userConfigOnServer.autoLogOffMilliSeconds||0===this.__userConfigOnServer.autoLogOffMilliSeconds)return;window.clearTimeout(this.__autoLogoffTimeoutID);const passiveEventOptions={passive:!0,capture:!0};document.removeEventListener("keydown",this.__updateLastUserinteraction,passiveEventOptions),document.removeEventListener("mousemove",this.__updateLastUserinteraction,passiveEventOptions),document.removeEventListener("mousedown",this.__updateLastUserinteraction,passiveEventOptions),document.removeEventListener("touchstart",this.__updateLastUserinteraction,passiveEventOptions),document.removeEventListener("visibilitychange",this.__updateLastUserinteraction,passiveEventOptions),document.addEventListener("keydown",this.__updateLastUserinteraction,passiveEventOptions),document.addEventListener("mousemove",this.__updateLastUserinteraction,passiveEventOptions),document.addEventListener("mousedown",this.__updateLastUserinteraction,passiveEventOptions),document.addEventListener("touchstart",this.__updateLastUserinteraction,passiveEventOptions),document.addEventListener("visibilitychange",this.__updateLastUserinteraction,passiveEventOptions);let newDelay=this.__lastUserInteraction+this.__userConfigOnServer.autoLogOffMilliSeconds-Date.now();newDelay<0?this.__logoutIfNoInteraction():(newDelay>2147483647&&(newDelay=2147483647),this.__autoLogoffTimeoutID=window.setTimeout(this.__logoutIfNoInteraction,newDelay))}__logoutSent=!1;__logoutIfNoInteraction(){if(!this.__logoutSent)return this.__userConfigOnServer.autoLogOffMilliSeconds&&Date.now()-this.__lastUserInteraction>this.__userConfigOnServer.autoLogOffMilliSeconds?(this.__logoutSent=!0,void Server.logoutEx2(!0,null)):void this.__rearmAutoLogoffTimer()}}})();export{AccessManager};export const accessManager=new AccessManager;
import{FunctionExpression}from"../System/FunctionExpression.js";import{Data}from"../System/System.js";import{typeManager}from"../System/Type.TypeManager.js";import{SymbolExpression}from"./SymbolExpression.js";import*as ValueConverter from"./ValueConverter.js";
/**
 * Used to execute functions based on a static JSON description.
 * @template R Type of the result of the function
 * @preserve (Part of the public API)
 */export class Function extends TcHmi.Destroyable{constructor(functionCallDescription){super(),this.__f=functionCallDescription;let module=Data.Modules.functions.map.get(functionCallDescription.fn);module&&(this.__module=module,this.__module.error===TcHmi.Errors.NONE&&(this.__fn=this.__module.reg?.func,this.__fnDescr=this.__module.description))}__module;__f;__fn;__fnDescr;__processedWaitMode;__lastExecuteId=0;__pendingExecutes=new Map;__isDestroying=!1;__execute(ctx,requiredArgs){if(this.__isDestroyed)return ctx.error(TcHmi.Errors.E_FUNCTION_DESTROYED,{code:TcHmi.Errors.E_FUNCTION_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_DESTROYED],reason:"Function was already destroyed",domain:"TcHmi.Function"}),()=>{};if(!this.__f)return ctx.error(TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_REFERENCE,{code:TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_REFERENCE],reason:"Function reference missing.",domain:"TcHmi.Function"}),()=>{};if(!this.__module)return ctx.error(TcHmi.Errors.E_MODULE_MISSING,{code:TcHmi.Errors.E_MODULE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_MODULE_MISSING],reason:this.__f.fn,domain:"TcHmi.Function"}),()=>{};if(this.__module.error!==TcHmi.Errors.NONE)return ctx.error(TcHmi.Errors.E_MODULE_ERROR,{code:TcHmi.Errors.E_MODULE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_MODULE_ERROR],reason:this.__f.fn,domain:"TcHmi.Function",errors:this.__module.errorDetails?[this.__module.errorDetails]:void 0}),()=>{};if(!this.__fn)return ctx.error(TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_REFERENCE,{code:TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_REFERENCE],reason:this.__f.fn,domain:"TcHmi.Function",errors:this.__module.errorDetails?[this.__module.errorDetails]:void 0}),()=>{};if(!this.__fnDescr)return ctx.error(TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_DESCRIPTION,{code:TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_DESCRIPTION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_MISSING_FUNCTION_DESCRIPTION],reason:this.__f.fn,domain:"TcHmi.Function",errors:this.__module.errorDetails?[this.__module.errorDetails]:void 0}),()=>{};let results=[],fnParams=this.__f.fnParams;Array.isArray(fnParams)||(fnParams=[]);let fnDescr=this.__fnDescr,fnArgDescriptions=fnDescr.function.arguments,done=!1,argoffset=0;!0===fnDescr.function.injectContextObject&&argoffset++,this.__lastExecuteId++;let executeId=this.__lastExecuteId,finish=(error,details)=>{if(!done){if(done=!0,!this.__isDestroying&&this.__pendingExecutes.has(executeId)&&this.__pendingExecutes.delete(executeId),error!==TcHmi.Errors.NONE)return ctx.error(error,details),void destroy();{let res;!0===fnDescr.function.injectContextObject&&(fnDescr.function&&"Asynchronous"===fnDescr.function.waitMode?results.unshift(ctx):results.unshift(ctx&&ctx.args?{args:ctx.args}:{}));try{res=this.__fn.call(this,...results)}catch(e){return ctx.error(TcHmi.Errors.E_FUNCTION_EXCEPTION,{code:TcHmi.Errors.E_FUNCTION_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_EXCEPTION],reason:`${fnDescr.function.name} threw an Exception`,domain:"TcHmi.Function",exception:e instanceof Error?e:void 0}),void destroy()}if(fnDescr.function&&(!fnDescr.function.waitMode||"Synchronous"===fnDescr.function.waitMode))return ctx.success(res),void destroy()}}};if(fnDescr.function&&"Asynchronous"===fnDescr.function.waitMode&&!1===fnDescr.function.injectContextObject)return finish(TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION,{code:TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION],reason:`${fnDescr.function.name}, Setting waitMode "Asynchronous" and injectContextObject "${fnDescr.function.injectContextObject}" is an invalid function configuration. Please enable context object injection and provide a context object parameter in the function to be able to use waitMode "Asynchronous".`,domain:"TcHmi.Function"}),()=>{};let pending=requiredArgs.length+fnParams.length,underlyingSymbols=[],underlyingDestroyFunctions=[],isDestroyed=!1,destroy=()=>{if(!isDestroyed){for(let i=0,ii=underlyingDestroyFunctions.length;i<ii;i++){let destroy=underlyingDestroyFunctions[i];destroy&&destroy()}underlyingDestroyFunctions=[];for(let i=0,ii=underlyingSymbols.length;i<ii;i++){let symbol=underlyingSymbols[i];symbol&&symbol.destroy()}underlyingSymbols=[],done||finish(TcHmi.Errors.E_FUNCTION_CALL_ABORTED,{code:TcHmi.Errors.E_FUNCTION_CALL_ABORTED,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_CALL_ABORTED],reason:fnDescr.function.name+", Function call was aborted.",domain:"TcHmi.Function"}),isDestroyed=!0}};this.__pendingExecutes.set(executeId,destroy);let addArgumentResult=(i,descr,value)=>{if(descr){let typeSchema=typeManager.getSchema(descr.type);typeSchema&&"TcHmi.Symbol"===typeSchema.frameworkInstanceOf?value instanceof TcHmi.Symbol?results[i]=value:results[i]=null:results[i]=ValueConverter.toSchemaType(value,typeSchema)}else results[i]=value;pending--,0===pending&&finish(TcHmi.Errors.NONE)},resolveSymbolValue=(i,descr,s)=>{let destroy=s.readEx(function(data){data.error===TcHmi.Errors.NONE?addArgumentResult(i,descr,data.value):finish(TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED,{code:TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED],reason:`${fnDescr.function.name}, Resolving symbol: "${s.getExpression().toString()}" for parameter: ${i} failed.`,domain:"TcHmi.Function",errors:data.details?[data.details]:void 0})});underlyingDestroyFunctions.push(destroy)},resolveFunctionExpressionValue=(i,descr,functionExpression)=>{let func;try{func=new FunctionExpression(functionExpression),func.execute({success:function(result){addArgumentResult(i,descr,result),func?.destroy()},error:function(_error,details){finish(TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED,{code:TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED],reason:`${fnDescr.function.name}, Resolving function expression: "${functionExpression}" for parameter: ${i} failed.`,domain:"TcHmi.Function",errors:details?[details]:void 0}),func?.destroy()},args:ctx.args})}catch(e){finish(TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED,{code:TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_RESOLVING_PARAMETER_FAILED],reason:`${fnDescr.function.name}, Resolving function expression: "${functionExpression}" for parameter: ${i}  failed with exception.`,domain:"TcHmi.Function",errors:[{code:TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_EXPRESSION_EXCEPTION],exception:e,reason:"An uncaught exception occurred while parsing a function parameter",domain:"TcHmi.System.FunctionExpression"}]}),func?.destroy()}};if(done)return destroy;if(0===pending)return finish(TcHmi.Errors.NONE),destroy;for(let i=0,ii=requiredArgs.length;i<ii;i++){let descr,arg=requiredArgs[i];i<fnArgDescriptions.length-argoffset?descr=fnArgDescriptions[i+argoffset]:(descr=fnArgDescriptions[fnArgDescriptions.length-1],descr&&!descr.restParameter&&(descr=null)),addArgumentResult(i,descr,arg)}for(let i=0,ii=fnParams.length;i<ii;i++){if(done)return destroy;let descr,fnParam=fnParams[i];if(i<fnArgDescriptions.length-requiredArgs.length-argoffset?descr=fnArgDescriptions[i+requiredArgs.length+argoffset]:(descr=fnArgDescriptions[fnArgDescriptions.length-1],descr&&!descr.restParameter&&(descr=null)),!descr)return finish(TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION,{code:TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION,message:TcHmi.Errors[TcHmi.Errors.E_FUNCTION_INVALID_CONFIGURATION],reason:`${fnDescr.function.name}, Unable to find description for additional parameter "${i}" in fnParams.`,domain:"TcHmi.Function"}),destroy;if(TcHmi.IFunction.isStaticValue(fnParam))addArgumentResult(i+requiredArgs.length,descr,fnParam.value);else if(TcHmi.IFunction.isSymbol(fnParam)){let s=new TcHmi.Symbol({expression:fnParam.symbolExpression,ctx}),typeSchema=typeManager.getSchema(descr.type);typeSchema&&"TcHmi.Symbol"===typeSchema.frameworkInstanceOf?(s.claimDestroyPrivilege(),s.resolveReference(data=>{if(data.error!==TcHmi.Errors.NONE)return data.details?finish(TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE],reason:`${fnDescr.function.name}, Failed to resolve symbol reference for symbol expression ${fnParam.symbolExpression} for parameter ${i}.`,domain:"TcHmi.Function",errors:[data.details]}):finish(TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_REFERENCE],reason:`${fnDescr.function.name}, Failed to resolve symbol reference for symbol expression ${fnParam.symbolExpression} for parameter ${i}.`,domain:"TcHmi.Function"}),s.destroy(),void data.destroy();data.ref&&data.ref.claimDestroyPrivilege(),addArgumentResult(i+requiredArgs.length,descr,data.ref),s.destroy(),data.destroy()})):s.resolveSchema(data=>{if(data.error!==TcHmi.Errors.NONE)return data.details?finish(TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:`${fnDescr.function.name}, Failed to resolve schema for symbol expression ${fnParam.symbolExpression} for parameter ${i}.`,domain:"TcHmi.Function",errors:[data.details]}):finish(TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:`${fnDescr.function.name}, Failed to resolve schema for symbol expression ${fnParam.symbolExpression} for parameter ${i}.`,domain:"TcHmi.Function"}),void s.destroy();let symbolSchema=data.schema;if(!symbolSchema)return finish(TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:`${fnDescr.function.name}, Failed to resolve schema for symbol expression ${fnParam.symbolExpression} for parameter ${i}.`,domain:"TcHmi.Function"}),void s.destroy();if("TcHmi.Symbol"===symbolSchema.frameworkInstanceOf){let options=s.getExpression().getOptions();options&&"Value"===options.ReferenceResolution?s.readEx(data=>data.error!==TcHmi.Errors.NONE?(data.details?finish(TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:`${fnDescr.function.name}, Failed to read symbol with expression ${fnParam.symbolExpression} for parameter ${i}.`,domain:"TcHmi.Function",errors:[data.details]}):finish(TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:`${fnDescr.function.name}, Failed read symbol with symbol expression ${fnParam.symbolExpression} for parameter ${i}.`,domain:"TcHmi.Function"}),void s.destroy()):data.value instanceof TcHmi.Symbol?(data.value.claimDestroyPrivilege(),resolveSymbolValue(i+requiredArgs.length,descr,data.value),void s.destroy()):(finish(TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,{code:TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_RESOLVE_SCHEMA],reason:`${fnDescr.function.name}, Failed read symbol with symbol expression ${fnParam.symbolExpression} for parameter ${i}. Value is not an instance of type 'TcHmi.Symbol''.`,domain:"TcHmi.Function"}),void s.destroy())):(resolveSymbolValue(i+requiredArgs.length,descr,s),s.destroy())}else resolveSymbolValue(i+requiredArgs.length,descr,s)}),underlyingSymbols.push(s)}else TcHmi.IFunction.isFunctionExpression(fnParam)?resolveFunctionExpressionValue(i+requiredArgs.length,descr,fnParam.functionExpression):finish(TcHmi.Errors.E_PARAMETER_INVALID,{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:fnDescr.function.name,domain:"TcHmi.Function"})}return destroy}
/**
     * Will raise the function defined in constructor argument f: IFunction.
     * @param requiredArgs Optional required arguments. Will be injected before arguments defined in IFunction and after context object dummy if context object is required.
     * @preserve (Part of the public API)
     */execute(requiredArgs=[]){let res=null,bContextLock=!1,destroy=this.__execute({success:function(result){bContextLock||(bContextLock=!0,res=result)},error:function(_error){bContextLock||(bContextLock=!0,res=null)}},requiredArgs);return destroy&&destroy(),res}
/**
     * Will raise the function defined in constructor argument f: IFunction and raises a callback afterwards.
     * @param requiredArgs Optional required arguments. Will be injected before arguments defined in IFunction and after context object dummy if context object is required.
     * @param callback Callback which will be called with the result
     * @preserve (Part of the public API)
     */executeEx(requiredArgs=[],callback){requiredArgs||(requiredArgs=[]);let bContextLock=!1;return this.__execute({success:result=>{bContextLock||(bContextLock=!0,TcHmi.Callback.callSafeEx(callback,this,{error:TcHmi.Errors.NONE,result}))},error:(error,details)=>{bContextLock||(bContextLock=!0,TcHmi.Callback.callSafeEx(callback,this,{error,details}))}},requiredArgs)}
/**
     * Will raise the function defined in constructor argument f: IFunction and forward the context object defined in ctx: TcHmi.Context if the function supports this.
     * @param ctx Context object.
     * @param requiredArgs Optional required arguments. Will be injected before arguments defined in IFunction and after context object dummy if context object is required.
     * @preserve (Part of the public API)
     */executeEx2(ctx,requiredArgs=[]){if(!ctx)throw new TypeError("Parameter 'ctx' must be defined.");if(!ctx.success||!ctx.error)throw new TypeError("Parameter 'ctx' must be defined properly. Either 'success' or 'error' or both are missing.");if("function"!=typeof ctx.success||"function"!=typeof ctx.error)throw new TypeError("Parameter 'ctx' must be defined properly. Either 'success' or 'error' or both are not of type 'function'.");return requiredArgs||(requiredArgs=[]),this.__execute(ctx,requiredArgs)}__resolveProcessedWaitMode(){let res="Synchronous";if(this.__processedWaitMode)return res=this.__processedWaitMode,res;if(this.__isDestroyed)throw new Error("Object was already destroyed.");if(!this.__f)throw new Error("Function call description is missing.");if(!this.__fnDescr)throw new Error(`Function description of "${this.__f.fn}" is missing.`);if("Synchronous"===res&&(this.__fnDescr.function&&this.__fnDescr.function.waitMode&&(res=this.__fnDescr.function.waitMode),this.__f&&this.__f.fnParams))for(let i=0,ii=this.__f.fnParams.length;i<ii;i++){let fnParam=this.__f.fnParams[i];if(fnParam)if(TcHmi.IFunction.isSymbol(fnParam)){let expr=new SymbolExpression(fnParam.symbolExpression),type=expr.getType();if(type===TcHmi.SymbolType.Server){res="Asynchronous";break}if(type===TcHmi.SymbolType.Function){const content=expr.getContent();if(!content)continue;let func=new FunctionExpression(content);if(func.isProcessedAsync()){res="Asynchronous",func.destroy();break}func.destroy()}}else if(TcHmi.IFunction.isFunctionExpression(fnParam)){let func=new FunctionExpression(fnParam.functionExpression);if(func.isProcessedAsync()){res="Asynchronous",func.destroy();break}func.destroy()}}return this.__processedWaitMode=res,res}isProcessedAsync(){return"Asynchronous"===this.__resolveProcessedWaitMode()}
/**
     * Releases all resources of the function
     * @preserve (Part of the public API)
     */destroy(){this.isDestroyed()||(this.__releaseDestroyPrivilege(),this.isDestroyable()&&(this.__isDestroying=!0,this.__pendingExecutes.forEach(destroy=>{destroy()}),this.__pendingExecutes.clear(),this.__module=void 0,this.__f=void 0,this.__fn=void 0,this.__fnDescr=void 0,this.__isDestroying=!1,this.__isDestroyed=!0))}
/**
     * Get the description of the function.
     * @preserve (Part of the public API)
     */getDescription(){return this.__fnDescr}}TcHmi.Function=Function;
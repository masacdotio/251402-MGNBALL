import{serverEventManager}from"../System/ServerEventManager.js";import{isParameterTypeInvalid}from"../System/SystemFunctions.js";import*as Server from"./Server.js";import*as Callback from"./Callback.js";import*as TypeApi from"./Type.js";import{Filter as SystemFilter}from"../System/Filter.js";let __consumers=[],__consumersToAdd=[],__registerTimeoutId=0,__unregisterTimeoutId=0,__subscriptionId=-1,__destroyers=[];export function confirmAlarm(alarm,callback){let rawAlarm={name:alarm.name,domain:alarm.sourceDomain,severity:alarm.severity,timeRaised:alarm.timeRaised.toISOString(),params:alarm.params,id:alarm.id,timeCleared:alarm.timeCleared?.toISOString()??null,timeConfirmed:alarm.timeConfirmed?.toISOString()??null,alarmState:alarm.alarmState,confirmationState:alarm.confirmationState};serverEventManager.confirmAlarm(rawAlarm,callback)}export function exportEvents(exportOptions,callback){const commandObject={commandOptions:["SendErrorMessage"],symbol:"ListEvents",filter:exportOptions.filter??void 0};Server.requestEx({requestType:"ReadWrite",commands:[commandObject]},null,Server.handleResponse({error:data=>{if(data.error===TcHmi.Errors.NONE&&data.results){let res=data.results[0];TcHmi.Callback.callSafeEx(callback,null,{error:res.error,details:res.details})}else Callback.callSafeEx(callback,null,{error:data.error,details:data.details})},success:data=>{const readValue=data.results[0].value,jsonStr=JSON.stringify(readValue,null,2),blob=new Blob([jsonStr],{type:"application/json"}),url=URL.createObjectURL(blob),a=document.createElement("a");a.href=url,exportOptions.filename?a.download=exportOptions.filename.includes(".")?exportOptions.filename:exportOptions.filename+".json":a.download="Events-"+(new Date).toISOString().replace(/[:.]/g,"_")+".json",a.click(),URL.revokeObjectURL(url),TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE})}}))}export function registerConsumer(filter,callbacks,doneCallback){let parsedFilter;try{parsedFilter=SystemFilter.parse(filter,TypeApi.getSchema("tchmi:server#/definitions/eventFilter"))}catch(e){const error={error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:"An uncaught exception occurred while parsing the filter",exception:e,domain:"TcHmi.Server.Events"}};return TcHmi.Callback.callSafeEx(callbacks.list,null,error),TcHmi.Callback.callSafeEx(callbacks.subscription,null,error),TcHmi.Callback.callSafeEx(doneCallback,null,error),()=>{}}let consumer={filter:parsedFilter,rawFilter:filter,activeAlarmIds:[],listCallback:callbacks.list,subscriptionCallback:callbacks.subscription,registration:{listPending:void 0!==callbacks.list,subscriptionPending:void 0!==callbacks.subscription,callback:doneCallback}};return __consumersToAdd.push(consumer),__registerTimeoutId&&(window.clearTimeout(__registerTimeoutId),__registerTimeoutId=0),__registerTimeoutId=window.setTimeout(()=>{__registerTimeoutId=0,__addConsumers()},200),()=>{const indexToAdd=__consumersToAdd.indexOf(consumer),indexAdded=__consumers.indexOf(consumer);if(-1!==indexToAdd&&__consumersToAdd.splice(indexToAdd,1),-1!==indexAdded&&(__consumers.splice(indexAdded,1),consumer.subscriptionCallback&&(__unregisterTimeoutId&&window.clearTimeout(__unregisterTimeoutId),__unregisterTimeoutId=window.setTimeout(()=>{__unregisterTimeoutId=0,__updateSubscription()},500))),0===__consumers.length&&0===__consumersToAdd.length){for(const destroy of __destroyers)destroy();__destroyers=[]}}}export function flushRegistrations(){__registerTimeoutId&&(window.clearTimeout(__registerTimeoutId),__registerTimeoutId=0,__addConsumers())}function __addConsumers(){__listEvents(__consumersToAdd),__consumers.push(...__consumersToAdd),__consumersToAdd=[],__updateSubscription(data=>{for(const consumer of Array.from(__consumers))consumer.registration.subscriptionPending&&(consumer.registration.subscriptionPending=!1,!consumer.registration.listPending&&consumer.registration.callback&&TcHmi.Callback.callSafeEx(consumer.registration.callback,null,data))}),0===__destroyers.length&&__destroyers.push(TcHmi.EventProvider.register("onLocaleChanged",__onLocaleChanged),TcHmi.EventProvider.register("onWebSocketOpened",__onWebsocketOpened))}function __listEvents(consumers){const filter=__accumulateFilters(consumers,!1);void 0!==filter&&serverEventManager.listEvents(filter,data=>{if(data.error===TcHmi.Errors.NONE&&data.events)!function(consumers,events){for(const consumer of Array.from(consumers)){if(!consumer.listCallback)continue;consumer.activeAlarmIds=[];let eventsForConsumer=[];for(let j=0,jj=events.length;j<jj;j++){let parsedEvent=parseServerEvent(events[j]);consumer.filter.test(parsedEvent)&&(eventsForConsumer.push(parsedEvent),isAlarm(parsedEvent)&&parsedEvent.id>-1&&!consumer.activeAlarmIds.includes(parsedEvent.id)&&consumer.activeAlarmIds.push(parsedEvent.id))}TcHmi.Callback.callSafeEx(consumer.listCallback,null,{error:TcHmi.Errors.NONE,events:eventsForConsumer}),consumer.registration.listPending&&(consumer.registration.listPending=!1,!consumer.registration.subscriptionPending&&consumer.registration.callback&&TcHmi.Callback.callSafeEx(consumer.registration.callback,null,{error:TcHmi.Errors.NONE}))}}(consumers,data.events);else for(const consumer of Array.from(consumers))Callback.callSafeEx(consumer.listCallback,null,{error:data.error,details:data.details}),consumer.registration.listPending&&(consumer.registration.listPending=!1,!consumer.registration.subscriptionPending&&consumer.registration.callback&&Callback.callSafeEx(consumer.registration.callback,null,{error:data.error,details:data.details}))})}function __updateSubscription(callback){const filter=__accumulateFilters(__consumers,!0);if(void 0!==filter)if(-1===__subscriptionId){let subscriptionId=serverEventManager.subscribe(filter,__onEventReceived,callback);subscriptionId?__subscriptionId=subscriptionId:TcHmi.Log.error("[Source=Framework, Module=TcHmi.Server] Reached maxium of parallel requests.")}else serverEventManager.updateSubscription(__subscriptionId,filter,callback);else-1!==__subscriptionId&&(serverEventManager.unsubscribe(__subscriptionId,callback),__subscriptionId=-1)}function __onEventReceived(data){data.error===TcHmi.Errors.NONE&&data.event?function(event){for(const consumer of Array.from(__consumers)){if(!consumer.subscriptionCallback)continue;let parsedEvent=parseServerEvent(event);if(consumer.filter.test(parsedEvent))isAlarm(parsedEvent)&&parsedEvent.id>-1&&!consumer.activeAlarmIds.includes(parsedEvent.id)&&consumer.activeAlarmIds.push(parsedEvent.id),consumer.subscriptionCallback({error:TcHmi.Errors.NONE,event:parsedEvent,changeType:__toServerEventChangeType(event.changeType),removedByFilter:!1});else if(isAlarm(parsedEvent)&&parsedEvent.id>-1){let alarmIndex=consumer.activeAlarmIds.indexOf(parsedEvent.id);-1!==alarmIndex&&(consumer.activeAlarmIds.splice(alarmIndex,1),TcHmi.Callback.callSafeEx(consumer.subscriptionCallback,null,{error:TcHmi.Errors.NONE,event:parsedEvent,changeType:__toServerEventChangeType(event.changeType),removedByFilter:!0}))}}}(data.event):__consumers.forEach(consumer=>Callback.callSafeEx(consumer.subscriptionCallback,null,{error:data.error}))}function __onLocaleChanged(){__listEvents(__consumers)}function __onWebsocketOpened(){__consumersToAdd.push(...__consumers),__consumers=[],__subscriptionId=-1,__addConsumers()}function __accumulateFilters(consumers,forSubscription){let filter;if(1===consumers.length)filter=forSubscription&&consumers[0].subscriptionCallback||!forSubscription&&consumers[0].listCallback?consumers[0].rawFilter:void 0;else{filter=[];for(let i=0,ii=consumers.length;i<ii;i++){if(forSubscription&&!consumers[i].subscriptionCallback||!forSubscription&&!consumers[i].listCallback)continue;const rawFilter=consumers[i].rawFilter;if(null===rawFilter||0===rawFilter.length){filter=null;break}filter.push(1===rawFilter.length?rawFilter[0]:rawFilter),i+1!==ii&&filter.push({logic:"OR"})}null!==filter&&0===filter.length&&(filter=void 0)}return filter}export function parseServerEvent(rawEvent){switch(rawEvent.payloadType??Type.Payload){case Type.Message:let rawMessage=rawEvent.payload,message={type:Type.Message,domain:rawEvent.domain,sourceDomain:rawMessage.domain,name:rawMessage.name,severity:rawMessage.severity,text:rawEvent.localizedString,timeRaised:new Date(rawMessage.timeRaised),timeReceived:new Date(rawEvent.timeReceived),params:rawMessage.params};return void 0!==rawEvent.sessionId&&(message.sessionId=rawEvent.sessionId),message;case Type.Alarm:let rawAlarm=rawEvent.payload,alarm={type:Type.Alarm,domain:rawEvent.domain,sourceDomain:rawAlarm.domain,name:rawAlarm.name,severity:rawAlarm.severity,id:rawAlarm.id,text:rawEvent.localizedString,timeRaised:new Date(rawAlarm.timeRaised),timeCleared:rawAlarm.timeCleared?new Date(rawAlarm.timeCleared):null,timeConfirmed:rawAlarm.timeConfirmed?new Date(rawAlarm.timeConfirmed):null,timeReceived:new Date(rawEvent.timeReceived),alarmState:rawAlarm.alarmState,confirmationState:rawAlarm.confirmationState,params:rawAlarm.params};return void 0!==rawEvent.sessionId&&(alarm.sessionId=rawEvent.sessionId),alarm;case Type.Payload:let payloadEvent={type:Type.Payload,domain:rawEvent.domain,name:rawEvent.name,timeReceived:new Date(rawEvent.timeReceived)};return void 0!==rawEvent.payload&&(payloadEvent.payload=rawEvent.payload),void 0!==rawEvent.sessionId&&(payloadEvent.sessionId=rawEvent.sessionId),payloadEvent}}function __toServerEventChangeType(alarmChangeType){if(void 0===alarmChangeType)return ChangeType.MessageSent;switch(alarmChangeType){case ServerAlarmChangeType.Raise:return ChangeType.AlarmRaised;case ServerAlarmChangeType.Change:return ChangeType.AlarmChanged;case ServerAlarmChangeType.Dispose:return ChangeType.AlarmDisposed}}export function createEvent(event,callback){if(isParameterTypeInvalid(event,"event",{type:"object",required:"valueNeeded",expectArray:!1},"TcHmi.Server.Events",callback))return;if(isParameterTypeInvalid(event.type,"event.type",{type:"number",required:"valueNeeded"},"TcHmi.Server.Events",callback))return;if(isParameterTypeInvalid(event.domain,"event.domain",{type:"string",required:"valueNeeded",minStringLength:1},"TcHmi.Server.Events",callback))return;if(isParameterTypeInvalid(event.name,"event.name",{type:"string",required:"valueNeeded",minStringLength:1},"TcHmi.Server.Events",callback))return;if(isParameterTypeInvalid(event.timeReceived,"event.timeReceived",{type:"date",required:"valueNeeded"},"TcHmi.Server.Events",callback))return;const rawEvent={domain:event.domain,name:event.name,timeReceived:event.timeReceived.toISOString()};switch(event.sessionId&&(rawEvent.sessionId=event.sessionId),event.type){case Type.Message:const rawMessage={name:event.name,domain:event.domain,severity:event.severity,timeRaised:event.timeRaised.toISOString(),params:event.params};rawEvent.payloadType=Type.Message,rawEvent.payload=rawMessage,event.text&&(rawEvent.localizedString=event.text);break;case Type.Payload:event.payload&&(rawEvent.payloadType=Type.Payload,rawEvent.payload=event.payload)}Server.writeSymbol("CreateEvent",rawEvent,Server.handleResponse({error:data=>{if(data.error===TcHmi.Errors.NONE&&data.results){let res=data.results[0];TcHmi.Callback.callSafeEx(callback,null,{error:res.error,details:res.details})}else Callback.callSafeEx(callback,null,{error:data.error,details:data.details})},success:()=>{Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE})}}))}export var Type;!function(Type){Type[Type.Message=0]="Message",Type[Type.Alarm=1]="Alarm",Type[Type.Payload=2]="Payload"}(Type||(Type={}));export var Severity;!function(Severity){Severity[Severity.Verbose=0]="Verbose",Severity[Severity.Info=1]="Info",Severity[Severity.Warning=2]="Warning",Severity[Severity.Error=3]="Error",Severity[Severity.Critical=4]="Critical"}(Severity||(Severity={}));export var AlarmState;!function(AlarmState){AlarmState[AlarmState.Raised=0]="Raised",AlarmState[AlarmState.Confirmed=1]="Confirmed",AlarmState[AlarmState.Cleared=2]="Cleared",AlarmState[AlarmState.ClearedAndConfirmed=3]="ClearedAndConfirmed",AlarmState[AlarmState.Invalid=4]="Invalid"}(AlarmState||(AlarmState={}));export var ConfirmationState;!function(ConfirmationState){ConfirmationState[ConfirmationState.NotSupported=0]="NotSupported",ConfirmationState[ConfirmationState.NotRequired=1]="NotRequired",ConfirmationState[ConfirmationState.WaitForConfirmation=2]="WaitForConfirmation",ConfirmationState[ConfirmationState.Confirmed=3]="Confirmed",ConfirmationState[ConfirmationState.Reset=4]="Reset"}(ConfirmationState||(ConfirmationState={}));export var ChangeType;!function(ChangeType){ChangeType[ChangeType.AlarmRaised=0]="AlarmRaised",ChangeType[ChangeType.AlarmChanged=1]="AlarmChanged",ChangeType[ChangeType.AlarmDisposed=2]="AlarmDisposed",ChangeType[ChangeType.MessageSent=3]="MessageSent"}(ChangeType||(ChangeType={}));export var ServerAlarmChangeType;!function(ServerAlarmChangeType){ServerAlarmChangeType[ServerAlarmChangeType.Raise=0]="Raise",ServerAlarmChangeType[ServerAlarmChangeType.Change=1]="Change",ServerAlarmChangeType[ServerAlarmChangeType.Dispose=2]="Dispose"}(ServerAlarmChangeType||(ServerAlarmChangeType={}));export function isAlarm(value){return value.type===Type.Alarm}export function isMessage(value){return value.type===Type.Message}export function isPayload(value){return value.type===Type.Payload}TcHmi.Server??={},TcHmi.Server.Events={confirmAlarm,exportEvents,registerConsumer,flushRegistrations,parseServerEvent,createEvent,isAlarm,isMessage,isPayload,AlarmState,ChangeType,ConfirmationState,Severity,Type,ServerAlarmChangeType};
import{Filter as SystemFilter}from"../System/Filter.js";export var Strategy;!function(Strategy){Strategy[Strategy.DepthFirst=0]="DepthFirst",Strategy[Strategy.BreadthFirst=1]="BreadthFirst"}(Strategy||(Strategy={}));export class FilterInstance{__filter;__schema=null;__parsedFilter=null;__wrapInBrackets=!1;constructor(dataSchemaOrPath,schemaOrComparator,value,schema){if("string"==typeof dataSchemaOrPath&&"string"==typeof schemaOrComparator&&void 0!==value)value instanceof Date&&(value=new Date(value.getTime())),this.__filter=[{path:dataSchemaOrPath,comparator:schemaOrComparator,value}],schema&&(this.__schema=schema);else if("object"==typeof schemaOrComparator&&(this.__schema=schemaOrComparator),dataSchemaOrPath instanceof FilterInstance)this.__filter=tchmi_clone_object(dataSchemaOrPath.getFilter()),this.__schema||(this.__schema=dataSchemaOrPath.getSchema());else{if(Array.isArray(dataSchemaOrPath))return void(this.__filter=tchmi_clone_object(dataSchemaOrPath,{cloneDates:!0}));"object"==typeof dataSchemaOrPath?TcHmi.isComparison(dataSchemaOrPath)?this.__filter=[tchmi_clone_object(dataSchemaOrPath,{cloneDates:!0})]:(this.__filter=[],this.__schema=dataSchemaOrPath):this.__filter=[]}}getFilter(){return this.__filter}getSchema(){return this.__schema}and(dataOrPath,comparator,value){if(dataOrPath instanceof FilterInstance&&(dataOrPath=dataOrPath.getFilter()),Array.isArray(dataOrPath)&&0===dataOrPath.length)return this;if("string"==typeof dataOrPath){if(void 0===comparator||void 0===value)return this;dataOrPath={path:dataOrPath,comparator,value}}return this.__append("AND",dataOrPath),this}or(dataOrPath,comparator,value){if(dataOrPath instanceof FilterInstance&&(dataOrPath=dataOrPath.getFilter()),Array.isArray(dataOrPath)&&0===dataOrPath.length)return this.__parsedFilter=null,this.__filter=[],this.__wrapInBrackets=!1,this;if("string"==typeof dataOrPath){if(void 0===comparator||void 0===value)return this;dataOrPath={path:dataOrPath,comparator,value}}return this.__append("OR",dataOrPath),this}__append(logic,filter){this.__parsedFilter=null,this.__filter.length>0&&(this.__wrapInBrackets&&(this.__filter=[this.__filter]),this.__filter.push({logic})),this.__filter.length>0||!Array.isArray(filter)?this.__filter.push(tchmi_clone_object(filter,{cloneDates:!0})):this.__filter=tchmi_clone_object(filter),this.__wrapInBrackets=!1}wrapInBrackets(){return this.__filter.length>=3&&(this.__wrapInBrackets=!0),this}compile(){try{this.__parsedFilter=SystemFilter.parse(this.__filter,this.__schema)}catch(ex){return{error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],domain:"Tchmi.Filter",reason:"The provided filter or schema is invalid",exception:ex}}}return{error:TcHmi.Errors.NONE}}test(candidate,key=""){return this.__parsedFilter||(this.__parsedFilter=SystemFilter.parse(this.__filter,this.__schema)),this.__parsedFilter.test(candidate,key)}filter(collection){if(this.__parsedFilter||(this.__parsedFilter=SystemFilter.parse(this.__filter,this.__schema)),Array.isArray(collection)){const parsedFilter=this.__parsedFilter;return collection.filter((item,index)=>parsedFilter.test(item,index))}if(collection instanceof Map){const data=new Map;for(const[key,item]of collection)this.__parsedFilter.test(item,key)&&data.set(key,item);return data}if(collection instanceof Set){const data=new Set;for(const item of collection)this.__parsedFilter.test(item)&&data.add(item);return data}const data={};for(const[key,item]of Object.entries(collection))this.__parsedFilter.test(item,key)&&(data[key]=item);return data}filterWithMap(array){this.__parsedFilter||(this.__parsedFilter=SystemFilter.parse(this.__filter,this.__schema));const data=[],map=[];for(const[index,item]of array.entries())this.__parsedFilter.test(item)&&(data.push(item),map.push(index));return{data,map}}filterTree(tree,childrenProperty,strategy=Strategy.DepthFirst){switch(this.__parsedFilter||(this.__parsedFilter=SystemFilter.parse(this.__filter,this.__schema)),strategy){case Strategy.DepthFirst:return this.__depthFirst(tree,childrenProperty,this.__parsedFilter).data;case Strategy.BreadthFirst:return this.__breadthFirst(tree,childrenProperty,this.__parsedFilter).data}}filterTreeWithMap(tree,childrenProperty,strategy=Strategy.DepthFirst){switch(this.__parsedFilter||(this.__parsedFilter=SystemFilter.parse(this.__filter,this.__schema)),strategy){case Strategy.DepthFirst:return this.__depthFirst(tree,childrenProperty,this.__parsedFilter,[]);case Strategy.BreadthFirst:return this.__breadthFirst(tree,childrenProperty,this.__parsedFilter,[])}}__depthFirst(tree,childrenProperty,parsedFilter,path){const data=[],map=path?[]:void 0;for(const[index,item]of tree.entries()){const itemCopy={...item},mapEntry=path?{index:[...path,index]}:void 0;if(itemCopy[childrenProperty]){const result=this.__depthFirst(itemCopy[childrenProperty],childrenProperty,parsedFilter,mapEntry?.index);itemCopy[childrenProperty]=result.data,mapEntry&&(mapEntry.children=result.map)}((itemCopy[childrenProperty]?.length??0)>0||parsedFilter.test(itemCopy,index))&&(data.push(itemCopy),map?.push(mapEntry))}return{data,map}}__breadthFirst(tree,childrenProperty,parsedFilter,path){const data=[],map=path?[]:void 0;for(const[index,item]of tree.entries()){if(!parsedFilter.test(item,index))continue;const itemCopy={...item},mapEntry=path?{index:[...path,index]}:void 0;if(itemCopy[childrenProperty]){const result=this.__breadthFirst(itemCopy[childrenProperty],childrenProperty,parsedFilter,mapEntry?.index);itemCopy[childrenProperty]=result.data,mapEntry&&(mapEntry.children=result.map)}data.push(itemCopy),map?.push(mapEntry)}return{data,map}}static Strategy=Strategy}TcHmi.FilterInstance=FilterInstance;
import{createTask}from"../System/Callback.js";import*as Symbol from"./Symbol.js";import*as Type from"./Type.js";import*as ValueConverter from"./ValueConverter.js";import*as TypeHelper from"../System/Type.Schema.Helper.js";
/**
 * @preserve (Part of the public API)
 */export class ObjectResolver{constructor(obj,optionsOrParentControl){this.__obj=obj,null!=optionsOrParentControl&&"object"==typeof optionsOrParentControl&&(optionsOrParentControl instanceof TcHmi.Controls.System.baseTcHmiControl?this.__parentControl=optionsOrParentControl:(this.__parentControl=optionsOrParentControl.parentControl??null,optionsOrParentControl.schema?this.__schema=optionsOrParentControl.schema:(this.__schema=null,optionsOrParentControl.type&&(this.__schema=Type.getSchema(optionsOrParentControl.type)??null))))}__obj;__clone;__schema;__parentControl;__watchLastObj;__watchSymbolInfoByRef=new Map;__watchSymbolInfoByExpression=new Map;__watchErrorsBySymbolInfo=new Map;__watchPending=0;__watchLoopActive=!1;__watcher=new Set;__writeActiveCount=0;__resolve(obj,callback){const clone=tchmi_clone_object(obj);let details,error=TcHmi.Errors.NONE;const symbolInfoByExpression=new Map;let loopActive=!1,pending=0,destroyOnInitialized=null;const process=()=>{pending>0||(error===TcHmi.Errors.NONE?TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(clone)}):TcHmi.Callback.callSafeEx(callback,null,{error,details}))},processError=e=>{if(error=TcHmi.Errors.ERROR,details||(details={code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.ObjectResolver"}),e){details.errors||(details.errors=[]);let exists=!1;for(let i=0,ii=details.errors.length;i<ii;i++)if(tchmi_equal(details.errors[i],e)){exists=!0;break}exists||details.errors.push(e)}},read=symbolInfo=>{if(symbolInfo.initialized)return;pending++;let hasToRead=!1;for(const[obj,refs]of symbolInfo.refs)for(const ref of refs)if(obj&&null!=ref){let schema;if(this.__schema&&ref.path){let pathTokens=new TcHmi.ObjectPath(ref.path).toPathTokens();TypeHelper.__resolveSubSchema(this.__schema,pathTokens,function(data){data&&data.schema&&(schema=data.schema)})}schema&&"TcHmi.Symbol"===schema.frameworkInstanceOf?symbolInfo.obj.resolveReference(data=>{data.destroy(),data.error===TcHmi.Errors.NONE?obj[ref.key]=data.ref:data.details?processError(data.details):processError({code:data.error,message:TcHmi.Errors[data.error]})}):hasToRead=!0}if(!hasToRead)return pending>0&&pending--,loopActive||process(),void(symbolInfo.initialized=!0);symbolInfo.obj.readEx(data=>{if(data.error===TcHmi.Errors.NONE){symbolInfo.value=data.value,symbolInfo.initialized=!0;for(const[obj,refs]of symbolInfo.refs)for(const ref of refs)if(obj&&null!=ref){let schema;if(this.__schema&&ref.path){let pathTokens=new TcHmi.ObjectPath(ref.path).toPathTokens();TypeHelper.__resolveSubSchema(this.__schema,pathTokens,function(data){data&&data.schema&&(schema=data.schema)})}schema&&"TcHmi.Symbol"===schema.frameworkInstanceOf?symbolInfo.obj.resolveReference(data=>{data.destroy(),data.error===TcHmi.Errors.NONE?obj[ref.key]=data.ref:data.details?processError(data.details):processError({code:data.error,message:TcHmi.Errors[data.error]})}):schema?(obj[ref.key]=ValueConverter.toSchemaType(symbolInfo.value,schema),resolveSymbolInfo(obj,ref.key,obj[ref.key],ref.path)):(obj[ref.key]=symbolInfo.value,resolveSymbolInfo(obj,ref.key,obj[ref.key],ref.path))}if(!loopActive)for(const symbolInfo of symbolInfoByExpression.values())loopActive=!0,read(symbolInfo),loopActive=!1;pending>0&&pending--,loopActive||process()}else data.details?processError(data.details):processError({code:data.error,message:TcHmi.Errors[data.error]}),pending>0&&pending--,loopActive||process()})},resolveSymbolInfo=(o,k,value,path)=>{if(value)if("object"==typeof value){if(__tchmi_is_instanced_object(value))return;if(Array.isArray(value))for(let i=0,ii=value.length;i<ii;i++)resolveSymbolInfo(value,i,value[i],`${path??""}[${i}]`);else{if(value&&value.objectType&&"Symbol"===value.objectType)return;for(let key in value)resolveSymbolInfo(value,key,value[key],`${path??""}::${key}`)}}else if("string"==typeof value){if(!o)return;if(null==k)return;let isSymbolExpression=Symbol.isSymbolExpression(value),isSymbolExpressionEscaped=Symbol.isSymbolExpressionEscaped(value);if(isSymbolExpression&&!isSymbolExpressionEscaped){let symbolInfoNew=null,symbolInfo=symbolInfoByExpression.get(value);if(symbolInfo){symbolInfo.initialized&&(o[k]=symbolInfo.value);let ref=symbolInfo.refs.get(o);ref?ref.push({key:k,path}):symbolInfo.refs.set(o,[{key:k,path}])}else{let symbol=new Symbol.Symbol(value),refs=new Map;refs.set(o,[{key:k,path}]),symbolInfoNew={obj:symbol,refs,initialized:!1},symbolInfoByExpression.set(value,symbolInfoNew)}}else isSymbolExpressionEscaped&&(o[k]=Symbol.escapeSymbolExpression(value))}},run=()=>{if(symbolInfoByExpression.size>0){let oneIsUnInitialized=!1;for(const symbolInfo of symbolInfoByExpression.values())loopActive=!0,read(symbolInfo),loopActive=!1,oneIsUnInitialized||=!symbolInfo.initialized;oneIsUnInitialized||process()}else process()};if(resolveSymbolInfo(null,null,clone,null),this.__parentControl&&symbolInfoByExpression.size>0){let partial=null,parent=this.__parentControl;for(;null!==parent;){let parentType=parent.getType();if(("TcHmi.Controls.System.TcHmiView"===parentType||"TcHmi.Controls.System.TcHmiContent"===parentType||"TcHmi.Controls.System.TcHmiUserControl"===parentType)&&!partial){partial=parent;break}parent=parent.getParent()}partial&&!partial.getIsInitialized()?destroyOnInitialized=TcHmi.EventProvider.register(partial.getId()+".onInitialized",e=>{e?.destroy?.(),destroyOnInitialized=null,run()}):this.__parentControl&&!this.__parentControl.getIsInitialized()?destroyOnInitialized=TcHmi.EventProvider.register(this.__parentControl.getId()+".onInitialized",e=>{e?.destroy?.(),destroyOnInitialized=null,run()}):run()}else run();return function(){destroyOnInitialized&&(destroyOnInitialized(),destroyOnInitialized=null);for(const symbolInfo of symbolInfoByExpression.values())symbolInfo.obj.destroy();symbolInfoByExpression.clear()}}
/**
     * Resolves all symbol expression refs in the current object.
     * @param callback Callback will be called after success or failure
     * @preserve (Part of the public API)
     */resolve(callback){return"object"==typeof this.__obj&&null!==this.__obj?this.__clone?(TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(this.__clone),destroy:()=>{}}),()=>{}):this.__resolve(this.__obj,callback):(TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE,value:this.__obj}),function(){})}__watchProcessCallbacks(callstackLinker){if(this.__watchPending>0||this.__writeActiveCount>0)return;let details,error=TcHmi.Errors.NONE;for(const errorDetails of this.__watchErrorsBySymbolInfo.values())if(error=TcHmi.Errors.ERROR,details||(details={code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.ObjectResolver"}),errorDetails){details.errors||(details.errors=[]);let exists=!1;for(let i=0,ii=details.errors.length;i<ii;i++)if(tchmi_equal(details.errors[i],errorDetails)){exists=!0;break}exists||details.errors.push(errorDetails)}if(error===TcHmi.Errors.NONE){if(tchmi_equal(this.__watchLastObj,this.__clone))return;this.__watchLastObj=tchmi_clone_object(this.__clone),callstackLinker.run(()=>{for(let watcher of this.__watcher)TcHmi.Callback.callSafeEx(watcher.callback,null,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(this.__clone),destroy:watcher.destroy})})}else callstackLinker.run(()=>{for(let watcher of this.__watcher)TcHmi.Callback.callSafeEx(watcher.callback,null,{error,details,destroy:watcher.destroy})})}__watchSymbolInfoUpdate(symbolInfo,value,callstackLinker){if(symbolInfo.obj&&(this.__watchErrorsBySymbolInfo.has(symbolInfo.obj)&&this.__watchErrorsBySymbolInfo.delete(symbolInfo.obj),symbolInfo.refs)){let removeableSymbolInfo=null,removeableExpressions=[],removeableRefs=[],resolveableRefs=[];symbolInfo.value=value;for(const[obj,refs]of symbolInfo.refs)for(let i=0,ii=refs.length;i<ii;i++){let ref=refs[i];if(null!=ref&&obj){let schema,oref=obj[ref.key];if(this.__schema&&ref.path){let pathTokens=new TcHmi.ObjectPath(ref.path).toPathTokens();TypeHelper.__resolveSubSchema(this.__schema,pathTokens,function(data){data&&data.schema&&(schema=data.schema)})}if((!schema||schema&&"TcHmi.Symbol"!==schema.frameworkInstanceOf)&&(obj[ref.key]=symbolInfo.value),"object"==typeof oref&&null!=oref){let symbolInfos2=this.__watchSymbolInfoByRef.get(oref);if(symbolInfos2)for(let i=0,ii=symbolInfos2.length;i<ii;i++){let symbolInfo2=symbolInfos2[i];if(symbolInfo2&&symbolInfo2.refs&&symbolInfo2.obj&&(symbolInfo2.refs.delete(oref),0===symbolInfo2.refs.size)){removeableExpressions.push(symbolInfo2.obj.getExpression().toString()),removeableRefs.push(oref),removeableSymbolInfo=symbolInfo2;break}}}resolveableRefs.push({o:obj,k:ref.key,ref:obj[ref.key],path:ref.path})}}const symbolInfoByExpressionChanged=removeableExpressions.length>0;for(const removeabelExpression of removeableExpressions)this.__watchSymbolInfoByExpression.delete(removeabelExpression);removeableExpressions=[];for(const removeableRef of removeableRefs)this.__watchSymbolInfoByRef.delete(removeableRef);removeableRefs=[],removeableSymbolInfo&&(removeableSymbolInfo.unwatch?.(),removeableSymbolInfo.unwatch=void 0,removeableSymbolInfo.obj?.destroy());for(const resolveableRef of resolveableRefs)this.__watchResolveSymbolInfo(resolveableRef.o,resolveableRef.k,resolveableRef.ref,resolveableRef.path);if(resolveableRefs=[],!this.__watchLoopActive&&!symbolInfoByExpressionChanged)for(const symbolInfo of this.__watchSymbolInfoByExpression.values())this.__watchLoopActive=!0,this.__watchSymbolInfo(symbolInfo,callstackLinker),this.__watchLoopActive=!1;symbolInfo.initialized=!0,this.__watchLoopActive||0!==this.__watchPending||0!==this.__writeActiveCount||this.__watchProcessCallbacks(callstackLinker)}}__watchSymbolInfo(symbolInfo,callstackLinker){if(!symbolInfo.obj)return;if(symbolInfo.active)return;symbolInfo.active=!0,this.__watchPending++;let hasToWatch=!1;for(const[obj,refs]of symbolInfo.refs)for(const ref of refs)if(obj&&null!=ref){let schema;if(this.__schema&&ref.path){let pathTokens=new TcHmi.ObjectPath(ref.path).toPathTokens();TypeHelper.__resolveSubSchema(this.__schema,pathTokens,function(data){data&&data.schema&&(schema=data.schema)})}schema&&"TcHmi.Symbol"===schema.frameworkInstanceOf?(ref.destroySymbolReferenceWatch&&(ref.destroySymbolReferenceWatch(),ref.destroySymbolReferenceWatch=void 0),ref.destroySymbolReferenceWatch=symbolInfo.obj.watchReference(data=>{if(data.error===TcHmi.Errors.NONE)obj[ref.key]=data.ref,this.__watchProcessCallbacks(callstackLinker);else{if(!symbolInfo.obj)return;this.__watchErrorsBySymbolInfo.set(symbolInfo.obj,{code:data.error,message:TcHmi.Errors[data.error],reason:`An error occurred while watching references for ${symbolInfo.obj.getExpression().toString()}`,domain:"TcHmi.ObjectResolver"})}})):hasToWatch=!0}if(!hasToWatch)return this.__watchPending>0&&!symbolInfo.initialized&&this.__watchPending--,void(symbolInfo.initialized=!0);symbolInfo.unwatch=symbolInfo.obj.watchEx(null,data=>{symbolInfo.unwatch??=data.destroy,symbolInfo.obj&&(this.__watchPending>0&&!symbolInfo.initialized&&this.__watchPending--,symbolInfo.initialized=!0,data.error===TcHmi.Errors.NONE?this.__watchSymbolInfoUpdate(symbolInfo,data.value,callstackLinker):(data.details?this.__watchErrorsBySymbolInfo.set(symbolInfo.obj,data.details):this.__watchErrorsBySymbolInfo.set(symbolInfo.obj,{code:data.error,message:TcHmi.Errors[data.error],reason:`An error occurred while watching references for ${symbolInfo.obj.getExpression().toString()}`,domain:"TcHmi.ObjectResolver"}),this.__watchLoopActive||this.__watchProcessCallbacks(callstackLinker)))})}__watchResolveSymbolInfo(o,k,value,path){if(value)if("object"==typeof value){if(__tchmi_is_instanced_object(value))return;if(Array.isArray(value))for(let i=0,ii=value.length;i<ii;i++)this.__watchResolveSymbolInfo(value,i,value[i],`${path??""}[${i}]`);else{if(value&&value.objectType&&"Symbol"===value.objectType)return;for(let key in value)this.__watchResolveSymbolInfo(value,key,value[key],`${path?path+"::":""}${key}`)}}else if("string"==typeof value){if(!o)return;if(null==k)return;let isSymbolExpression=Symbol.isSymbolExpression(value),isSymbolExpressionEscaped=Symbol.isSymbolExpressionEscaped(value);if(isSymbolExpression&&!isSymbolExpressionEscaped){let symbolInfo=this.__watchSymbolInfoByExpression.get(value);if(symbolInfo){void 0!==symbolInfo.value&&(o[k]=symbolInfo.value);let ref=symbolInfo.refs.get(o);if(ref)ref.push({key:k,path});else{symbolInfo.refs.set(o,[{key:k,path}]);let symbolInfoRefArr=this.__watchSymbolInfoByRef.get(o);symbolInfoRefArr?symbolInfoRefArr.push(symbolInfo):this.__watchSymbolInfoByRef.set(o,[symbolInfo])}}else{let symbol=new Symbol.Symbol(value),refs=new Map;refs.set(o,[{key:k,path}]);const symbolInfoNew={obj:symbol,refs,active:!1,initialized:!1};this.__watchSymbolInfoByExpression.set(value,symbolInfoNew);const symbolInfoRefArr=this.__watchSymbolInfoByRef.get(o);symbolInfoRefArr?symbolInfoRefArr.push(symbolInfoNew):this.__watchSymbolInfoByRef.set(o,[symbolInfoNew])}}else isSymbolExpressionEscaped&&(o[k]=Symbol.escapeSymbolExpression(value))}}__watch(callback){if(!callback)return()=>{};let destroyOnInitialized,watcher={callback,destroy:()=>{if(this.__watcher.delete(watcher),!(this.__watcher.size>0)){destroyOnInitialized&&(destroyOnInitialized(),destroyOnInitialized=null);for(const symbolInfo of this.__watchSymbolInfoByExpression.values())symbolInfo.unwatch&&(symbolInfo.unwatch(),symbolInfo.unwatch=void 0),symbolInfo.obj&&(symbolInfo.obj.destroy(),symbolInfo.obj=void 0);this.__watchSymbolInfoByExpression.clear(),this.__watchSymbolInfoByRef.clear(),this.__watchLastObj=void 0,this.__clone=void 0}}};if(this.__watcher.size>0)return this.__watcher.add(watcher),this.__clone&&0===this.__watchPending&&TcHmi.Callback.callSafeEx(watcher.callback,null,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(this.__clone),destroy:watcher.destroy}),watcher.destroy;this.__watcher.add(watcher);const callstackLinker=createTask("ObjectResolver.watch>"+(this.__parentControl?.getId()??"UnknownCtrl"));this.__clone=tchmi_clone_object(this.__obj);const run=()=>{if(this.__watchSymbolInfoByExpression.size>0){let oneIsUnInitialized=!1;for(const symbolInfo of this.__watchSymbolInfoByExpression.values())this.__watchLoopActive=!0,this.__watchSymbolInfo(symbolInfo,callstackLinker),this.__watchLoopActive=!1,oneIsUnInitialized||=!symbolInfo.initialized;oneIsUnInitialized||this.__watchProcessCallbacks(callstackLinker)}else this.__watchProcessCallbacks(callstackLinker)};if(this.__watchResolveSymbolInfo(null,null,this.__clone,null),this.__parentControl&&this.__watchSymbolInfoByExpression.size>0){let partial=null,parent=this.__parentControl;for(;null!==parent;){let parentType=parent.getType();if(("TcHmi.Controls.System.TcHmiView"===parentType||"TcHmi.Controls.System.TcHmiContent"===parentType||"TcHmi.Controls.System.TcHmiUserControl"===parentType)&&!partial){partial=parent;break}parent=parent.getParent()}partial&&!partial.getIsInitialized()?destroyOnInitialized=TcHmi.EventProvider.register(partial.getId()+".onInitialized",e=>{e?.destroy?.(),destroyOnInitialized=null,run()}):this.__parentControl&&!this.__parentControl.getIsInitialized()?destroyOnInitialized=TcHmi.EventProvider.register(this.__parentControl.getId()+".onInitialized",e=>{e?.destroy?.(),destroyOnInitialized=null,run()}):run()}else run();return watcher.destroy}
/**
     * Watches for changes of symbol expressions in the current object und returns the object with updated values.
     * Returns a destroy function to remove the watch.
     * @param callback Callback will be called after success or failure
     * @preserve (Part of the public API)
     */watch(callback){return"object"==typeof this.__obj&&null!==this.__obj?this.__watch(callback):(TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE,value:this.__obj}),function(){})}write(obj,dirtyPaths,callback){if(!obj)return;if(!this.__obj)return;if(!this.__clone)return;let pending=0,errors=[];const process=()=>{if(!tchmi_equal(this.__watchLastObj,this.__clone)&&(this.__watchLastObj=tchmi_clone_object(this.__clone),this.__watcher.size>0))for(let watcher of this.__watcher)TcHmi.Callback.callSafeEx(watcher.callback,null,{error:TcHmi.Errors.NONE,value:tchmi_clone_object(this.__clone),destroy:watcher.destroy});0!==errors.length?errors.push({code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Writing to at least one underlying symbol has failed. See 'errors' for further details.",domain:"TcHmi.ObjectResolver",errors}):TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE})},done=()=>{pending>0||(this.__writeActiveCount--,0===this.__writeActiveCount&&process())};if(this.__writeActiveCount++,!dirtyPaths){let dirtyPathsNew=tchmi_compare_object(this.__clone,obj);dirtyPathsNew&&(dirtyPaths=dirtyPathsNew)}let toWrite=[];if(dirtyPaths&&dirtyPaths.length>0)for(const dirtyPath of dirtyPaths){const op=new TcHmi.ObjectPath(dirtyPath),pathAccessors=op.toPropertyAccessors();let symbolInfo,symbolInfoRef,ref=this.__clone;for(const pathAccessor of pathAccessors){const refSymbolInfos=this.__watchSymbolInfoByRef.get(ref);if(refSymbolInfos)for(const refSymbolInfo of refSymbolInfos){const siRefs=refSymbolInfo.refs.get(ref);if(siRefs)for(let siRef of siRefs)if(siRef.key===pathAccessor){symbolInfo=refSymbolInfo,symbolInfoRef=siRef;break}}if(ref=ref?.[pathAccessor],!ref)break}const valueNew=op.readFrom(obj);if(op.writeTo(this.__clone,valueNew),!symbolInfo?.obj)continue;if(!symbolInfoRef)continue;const expressionOptions=symbolInfo.obj.getExpression().getOptions();if("TwoWay"===expressionOptions?.BindingMode&&symbolInfoRef.path){const valueNew=new TcHmi.ObjectPath(symbolInfoRef.path).readFrom(obj);toWrite.push({symbolInfo,value:valueNew})}}if(pending=toWrite.length,0!==pending)for(let write of toWrite)write.symbolInfo.obj.write(write.value,data=>{pending--,data.error!==TcHmi.Errors.NONE&&data.details?errors.push({code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Writing to '"+write.symbolInfo.obj.getExpression().toString()+"' has failed. See errors for further details.",domain:"TcHmi.ObjectResolver",errors:[data.details]}):data.error!==TcHmi.Errors.NONE&&errors.push({code:data.error,message:TcHmi.Errors[data.error],reason:"Writing to '"+write.symbolInfo.obj.getExpression().toString()+"' has failed. See errors for further details.",domain:"TcHmi.ObjectResolver",errors:[{code:data.error,message:TcHmi.Errors[data.error]}]}),done()});else done()}
/**
     * Destroys the current object.
     * @preserve (Part of the public API)
     */destroy(){this.__obj=null}}
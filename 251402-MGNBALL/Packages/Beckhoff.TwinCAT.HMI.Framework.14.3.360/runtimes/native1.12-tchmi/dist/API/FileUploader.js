import{isParameterTypeInvalid}from"../System/SystemFunctions.js";import{Exception}from"./Exception.js";import{Log}from"./Log.js";import*as Server from"./Server.js";import{EventProvider}from"./EventProvider.js";export var FileStatus;!function(FileStatus){FileStatus[FileStatus.Pending=0]="Pending",FileStatus[FileStatus.Uploading=1]="Uploading",FileStatus[FileStatus.Finished=2]="Finished",FileStatus[FileStatus.Canceled=3]="Canceled"}(FileStatus||(FileStatus={}));export var ChunkType;!function(ChunkType){ChunkType[ChunkType.Disabled=0]="Disabled",ChunkType[ChunkType.First=1]="First",ChunkType[ChunkType.Intermediate=2]="Intermediate",ChunkType[ChunkType.Last=3]="Last"}(ChunkType||(ChunkType={}));export class FileUploader{static __queue=[];static __current=null;static __working=!1;static __preparedChunks=null;static __chunkSize=null;static __subscribedToChunkSize=!1;static __chunkSizeSubscriptionError=null;__queueTimeoutId=0;__options;constructor(options){let parameterInvalid=isParameterTypeInvalid(options?.domain,"options.domain",{type:"string",required:"undefinedOk",minStringLength:1},"TcHmi.FileUploader");if(parameterInvalid)throw new Exception(parameterInvalid);if(parameterInvalid=isParameterTypeInvalid(options?.symbol,"options.symbol",{type:"string",required:"undefinedOk",minStringLength:1},"TcHmi.FileUploader"),parameterInvalid)throw new Exception(parameterInvalid);if(parameterInvalid=isParameterTypeInvalid(options?.chunkSize,"options.chunkSize",{type:"number",required:"undefinedOk",minValue:1},"TcHmi.FileUploader"),parameterInvalid)throw new Exception(parameterInvalid);this.__options={...options,symbol:options?.symbol??"Upload"},FileUploader.__subscribedToChunkSize||FileUploader.__subscribeChunkSize()}queue(path,file,options){return new Promise((resolve,reject)=>{let parameterInvalid=isParameterTypeInvalid(options?.progressCallback,"options.progressCallback",{type:"function",required:"undefinedOk"},"TcHmi.FileUploader");if(parameterInvalid)return void reject(new Exception(parameterInvalid));if(parameterInvalid=isParameterTypeInvalid(options?.additionalProperties,"options.additionalProperties",{type:"object",required:"undefinedOk"},"TcHmi.FileUploader"),parameterInvalid)return void reject(new Exception(parameterInvalid));const queued={file,path,domainAndSymbol:(this.__options.domain?this.__options.domain+".":"")+this.__options.symbol,additionalProperties:options?.additionalProperties,chunkSize:this.__options.chunkSize,offset:0,status:FileStatus.Pending,progressCallback:progress=>{TcHmi.Callback.callSafeEx(options?.progressCallback,null,progress),progress.error!==TcHmi.Errors.NONE?reject(new Exception(progress.details)):progress.status!==FileStatus.Finished&&progress.status!==FileStatus.Canceled||resolve(progress)}};this.cancel(path),FileUploader.__queue.push(queued),clearTimeout(this.__queueTimeoutId),FileUploader.__working||(this.__queueTimeoutId=setTimeout(()=>FileUploader.__workQueue(),50))})}async cancel(path){const index=FileUploader.__queue.findIndex(queuedFile=>queuedFile.path===path);if(-1===index){let found=!1;if(FileUploader.__current?.path===path&&(FileUploader.__current.status=FileStatus.Canceled,found=!0),FileUploader.__preparedChunks){const chunks=await FileUploader.__preparedChunks,chunk=chunks?.get(path);chunk&&(chunk.data="",chunk.type=ChunkType.Last,found=!0)}return found}return FileUploader.__queue[index].progressCallback({error:TcHmi.Errors.NONE,uploadedBytes:0,totalBytes:FileUploader.__queue[index].file.size,status:FileStatus.Canceled}),FileUploader.__queue.splice(index,1),!0}set domain(value){let parameterInvalid=isParameterTypeInvalid(value,"value",{type:"string",required:"undefinedOk",minStringLength:1},"TcHmi.FileUploader");if(parameterInvalid)throw new Exception(parameterInvalid);value?this.__options.domain=value:delete this.__options.domain}get domain(){return this.__options.domain}set symbol(value){let parameterInvalid=isParameterTypeInvalid(value,"value",{type:"string",required:"undefinedOk",minStringLength:1},"TcHmi.FileUploader");if(parameterInvalid)throw new Exception(parameterInvalid);this.__options.symbol=value||"Upload"}get symbol(){return this.__options.symbol}set chunkSize(value){let parameterInvalid=isParameterTypeInvalid(value,"value",{type:"number",required:"undefinedOk",minValue:1},"TcHmi.FileUploader");if(parameterInvalid)throw new Exception(parameterInvalid);value?this.__options.chunkSize=value:delete this.__options.chunkSize}get chunkSize(){return this.__options.chunkSize}static readFileAsBase64(file,offset,limit){return new Promise((resolve,reject)=>{const reader=new FileReader;if(reader.addEventListener("load",_event=>{"string"==typeof reader.result?resolve(reader.result.replace(/data:(?:.*,|$)/,"")):reject(new Exception(TcHmi.Errors.E_TYPE_INVALID,`The read operation resulted in ${reader.result?"an ArrayBuffer":"null"}, instead of a string.`,"TcHmi.FileUploader"))}),reader.addEventListener("abort",_event=>{reject(new Exception(TcHmi.Errors.ERROR,"The read operation was aborted, possibly by the user.","TcHmi.FileUploader"))}),reader.addEventListener("error",_event=>{reject(new Exception(TcHmi.Errors.E_EXCEPTION,"An error occured while reading the file.","TcHmi.FileUploader",reader.error??new Error("An unspecified error occured while reading the file.")))}),void 0!==offset){const end=void 0!==limit?Math.min(offset+limit,file.size):file.size;reader.readAsDataURL(file.slice(offset,end))}else reader.readAsDataURL(file)})}static openFileDialog(options){return new Promise(resolve=>{const inputElement=document.createElement("input");inputElement.type="file",inputElement.multiple=options?.multiple??!1,inputElement.accept=options?.acceptedFileTypes?.join(",")??"";const destroyChange=EventProvider.registerDomEvent(inputElement,"change",()=>{resolve(inputElement.files??new FileList),destroyChange(),destroyCancel(),inputElement.remove()}),destroyCancel=EventProvider.registerDomEvent(inputElement,"cancel",()=>{resolve(null),destroyChange(),destroyCancel(),inputElement.remove()});inputElement.click()})}static async __workQueue(){const chunks=await(this.__preparedChunks??this.__createChunks());chunks?(this.__preparedChunks=this.__createChunks(),chunks.size>0?this.__upload(chunks):this.__workQueue()):this.__preparedChunks=null}static async __createChunks(){if(this.__chunkSizeSubscriptionError){for(const file of this.__queue)file.progressCallback(this.__chunkSizeSubscriptionError);return this.__queue=[],this.__working=!1,null}if(null===this.__chunkSize)return this.__working=!0,null;if(0===this.__chunkSize){for(const file of this.__queue)file.progressCallback({error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:"The chunk size that is set in the server config must be greater than 0.",domain:"TcHmi.FileUploader"}});return this.__queue=[],this.__working=!1,null}if(!this.__current&&0===this.__queue.length)return this.__working=!1,null;this.__working=!0;let available=this.__chunkSize;const chunks=new Map,fileReadPromises=[];for(;available>0&&(this.__current||0!==this.__queue.length);){if(this.__current?.status===FileStatus.Canceled){const current=this.__current;this.__preparedChunks?.then(chunks=>{chunks?.has(current.path)||current.progressCallback({error:TcHmi.Errors.NONE,uploadedBytes:current.offset,totalBytes:current.file.size,status:current.status})}),this.__current=null}if(this.__current||0===this.__queue.length||(this.__current=this.__queue.shift(),this.__current.status=FileStatus.Uploading,this.__current.progressCallback({error:TcHmi.Errors.NONE,uploadedBytes:0,totalBytes:this.__current.file.size,status:this.__current.status})),!this.__current)break;if(chunks.has(this.__current.path))break;const current=this.__current,remainingFileSize=current.file.size-current.offset;let chunkSize=this.__chunkSize;current.chunkSize&&current.chunkSize<this.__chunkSize&&(chunkSize=current.chunkSize);const firstChunk=0===current.offset,lastChunk=remainingFileSize<=chunkSize,chunk={file:current,data:"",type:firstChunk&&lastChunk?ChunkType.Disabled:firstChunk?ChunkType.First:lastChunk?ChunkType.Last:ChunkType.Intermediate};chunks.set(current.path,chunk),fileReadPromises.push(this.readFileAsBase64(current.file,current.offset,chunkSize).then(data=>{chunk.data=data}).catch(ex=>{const error={error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:ex.message??"An error occured while reading the file.",domain:"TcHmi.FileUploader",exception:ex}};chunks.delete(current.path),current.progressCallback(error),this.__current===current&&(this.__current=null)}));const readBytes=Math.min(remainingFileSize,chunkSize);current.offset+=readBytes,available-=readBytes,lastChunk&&(this.__current=null)}return await Promise.all(fileReadPromises),0===chunks.size?this.__createChunks():chunks}static __upload(chunks){const request={requestType:"ReadWrite",commands:Array.from(chunks.values()).map(chunk=>({symbol:chunk.file.domainAndSymbol,commandOptions:["SendErrorMessage"],writeValue:{...chunk.file.additionalProperties,fileName:chunk.file.path,data:chunk.data,chunkType:chunk.type},customerData:chunk.file.path}))};Server.requestEx(request,null,data=>{if(data.error!==TcHmi.Errors.NONE){for(const chunk of chunks.values())chunk.file.progressCallback({error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:`Error while uploading '${chunk.file.path}' to symbol ${chunk.file.domainAndSymbol}.`,domain:"TcHmi.FileUploader",errors:data.details?[data.details]:void 0}}),this.__current===chunk.file&&(this.__current=null);return void this.__workQueue()}if(!data.response){for(const chunk of chunks.values())chunk.file.progressCallback({error:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,details:{code:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_MISSING],reason:`Missing response from server while uploading '${chunk.file.path}' to symbol ${chunk.file.domainAndSymbol}.`,domain:"TcHmi.FileUploader"}}),this.__current===chunk.file&&(this.__current=null);return void this.__workQueue()}if(data.response.error){for(const chunk of chunks.values())chunk.file.progressCallback({error:TcHmi.Errors.E_SERVER_RESPONSE_ERROR,details:{code:TcHmi.Errors.E_SERVER_RESPONSE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_ERROR],reason:`Error in response from server while uploading '${chunk.file.path}' to symbol ${chunk.file.domainAndSymbol}.`,domain:"TcHmi.FileUploader",errors:[data.response.error]}}),this.__current===chunk.file&&(this.__current=null),this.__preparedChunks?.then(chunks=>{chunks?.delete(chunk.file.path)});return void this.__workQueue()}const otherErrors={error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"One or more errors occured that cannot be attributed to a specific file.",domain:"TcHmi.FileUploader",errors:[]}};if(data.response.commands&&data.response.commands.length===chunks.size||otherErrors.details.errors.push({code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:`Missing commands in response from server with id: '${data.response.id}'.`,domain:"TcHmi.FileUploader"}),data.response.commands)for(const command of data.response.commands){if(!command.customerData){const details={code:TcHmi.Errors.E_SERVER_RESPONSE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_ERROR],reason:`Missing customerData in response from server with id: '${data.response.id}'.`,domain:"TcHmi.FileUploader",errors:command.error?[command.error]:void 0};otherErrors.details.errors.push(details);continue}const chunk=chunks.get(command.customerData);chunk&&(command.error?(chunk.file.progressCallback({error:TcHmi.Errors.E_SERVER_COMMAND_ERROR,details:{code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMAND_ERROR],reason:`Error in command from server while uploading '${chunk.file.path}' to symbol ${command.symbol}.`,domain:"TcHmi.FileUploader",errors:[command.error]}}),this.__current===chunk.file&&(this.__current=null,this.__preparedChunks?.then(chunks=>{chunks?.delete(chunk.file.path)}))):chunk.file.progressCallback({error:TcHmi.Errors.NONE,uploadedBytes:chunk.file.offset,totalBytes:chunk.file.file.size,status:""===chunk.data?FileStatus.Canceled:chunk.type===ChunkType.Last||chunk.type===ChunkType.Disabled?FileStatus.Finished:FileStatus.Uploading}),chunks.delete(command.customerData))}if(otherErrors.details.errors.length>0)for(const chunk of chunks.values())chunk.file.progressCallback(otherErrors),this.__current===chunk.file&&(this.__current=null),this.__preparedChunks?.then(chunks=>{chunks?.delete(chunk.file.path)});this.__workQueue()})}static __subscribeChunkSize(){this.__subscribedToChunkSize=!0,Server.subscribeEx([{symbol:"TcHmiSrv.Config::CHUNKSIZE",commandOptions:["SendWriteValue","SendErrorMessage"]}],TcHmi.Config.get().tcHmiServer.websocketIntervalTime,null,data=>{if(data.error!==TcHmi.Errors.NONE)return this.__chunkSizeSubscriptionError={error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"Error in response from server while subscribing to symbol TcHmiSrv.Config::CHUNKSIZE",domain:"TcHmi.FileUploader",errors:data.details?[data.details]:void 0}},Log.errorEx("[Source=Framework, Module=TcHmi.FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+Log.buildMessage(this.__chunkSizeSubscriptionError.details)),void this.__workQueue();if(!data.response)return this.__chunkSizeSubscriptionError={error:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,details:{code:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_MISSING],reason:"Missing response from server while subscribing to symbol TcHmiSrv.Config::CHUNKSIZE.",domain:"TcHmi.FileUploader"}},Log.errorEx("[Source=Framework, Module=TcHmi.FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+Log.buildMessage(this.__chunkSizeSubscriptionError.details)),void this.__workQueue();if(data.response.error)return this.__chunkSizeSubscriptionError={error:TcHmi.Errors.E_SERVER_RESPONSE_ERROR,details:{code:TcHmi.Errors.E_SERVER_RESPONSE_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_ERROR],reason:"Error in response from server while subscribing to symbol TcHmiSrv.Config::CHUNKSIZE.",domain:"TcHmi.FileUploader",errors:[data.response.error]}},Log.errorEx("[Source=Framework, Module=TcHmi.FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+Log.buildMessage(this.__chunkSizeSubscriptionError.details)),void this.__workQueue();if(!data.response.commands||!data.response.commands[0])return this.__chunkSizeSubscriptionError={error:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,details:{code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:`Missing commands in response from server with id: '${data.response.id}' while subscribing to symbol TcHmiSrv.Config::CHUNKSIZE.`,domain:"TcHmi.FileUploader"}},Log.errorEx("[Source=Framework, Module=TcHmi.FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+Log.buildMessage(this.__chunkSizeSubscriptionError.details)),void this.__workQueue();if(data.response.commands[0].error)return this.__chunkSizeSubscriptionError={error:TcHmi.Errors.E_SERVER_COMMAND_ERROR,details:{code:TcHmi.Errors.E_SERVER_COMMAND_ERROR,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMAND_ERROR],reason:`Error in command from server with id: '${data.response.id}' while subscribing to symbol TcHmiSrv.Config::CHUNKSIZE.`,domain:"TcHmi.FileUploader",errors:[data.response.commands[0].error]}},Log.errorEx("[Source=Framework, Module=TcHmi.FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+Log.buildMessage(this.__chunkSizeSubscriptionError.details)),void this.__workQueue();const readValue=data.response.commands[0].readValue;void 0===readValue?(this.__chunkSizeSubscriptionError={error:TcHmi.Errors.E_SERVER_READVALUE_MISSING,details:{code:TcHmi.Errors.E_SERVER_READVALUE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_READVALUE_MISSING],reason:`Missing readValue in response from server with id: '${data.response.id}' while subscribing to symbol TcHmiSrv.Config::CHUNKSIZE.`,domain:"TcHmi.FileUploader"}},Log.errorEx("[Source=Framework, Module=TcHmi.FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+Log.buildMessage(this.__chunkSizeSubscriptionError.details))):this.__chunkSize=readValue,this.__workQueue()})}static FileStatus=FileStatus;static ChunkType=ChunkType}export const openFileDialog=FileUploader.openFileDialog;TcHmi.FileUploader=FileUploader;